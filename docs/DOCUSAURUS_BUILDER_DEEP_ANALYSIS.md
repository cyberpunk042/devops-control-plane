# Docusaurus Builder â€” Deep Analysis & Implementation Plan

> **Created**: 2026-02-11  
> **Status**: ANALYSIS COMPLETE â€” Implementation pending  
> **Scope**: Complete overhaul of `docusaurus.py`, new template system, build intelligence, and UI  
> **Reference**: `/home/jfortin/system-course/scripts/` (1,187-line build orchestrator + template tree)

---

## Part I: What We Have (Current State Audit)

### 1.1 File Inventory

| File | Lines | Role |
|------|-------|------|
| `pages_builders/docusaurus.py` | 650 | Builder implementation |
| `pages_builders/base.py` | 326 | Abstract base + pipeline runner |
| `routes_pages_api.py` (SSE section) | ~140 | SSE streaming endpoint |
| `_integrations.html` (Pages section) | ~600 | UI: cards, modals, SSE consumer |

**Total Docusaurus-specific code: ~650 lines.**

### 1.2 What docusaurus.py Actually Does Today

#### Stage 1: Source (`_stage_source`, L83-121) â€” 39 lines
- Copies files from `segment.source` into `workspace/docs/`
- Excludes hidden dirs (`.xxx`) and `__pycache__`
- Uses `shutil.copy2` in a Python loop (not rsync)
- **No**: encrypted file handling, `.large` restoration, symlinks, differential copy

#### Stage 2: Transform (`_stage_transform`, L125-161) â€” 37 lines
- Renames `.md` â†’ `.mdx`
- Applies 3 transforms: admonitions, frontmatter enrichment, link rewriting
- **Admonitions** (`_convert_admonitions`, L568-599): MkDocs `!!!` â†’ Docusaurus `:::`
- **Frontmatter** (`_enrich_frontmatter`, L601-636): Adds title from filename, sidebar_position from numeric prefix
- **Links** (`_rewrite_links`, L638-649): `.md` â†’ `.mdx` in relative links
- **No**: Custom remark plugin support (tabs, system-viewer), directory-based sidebar categories, `_category_.json` generation

#### Stage 3: Scaffold (`_stage_scaffold`, L165-221) â€” 57 lines
Generates 4 files via **string concatenation**:
1. `docusaurus.config.js` (L295-371) â€” CJS, not TypeScript
2. `sidebars.js` (L373-384) â€” Single autogenerated sidebar
3. `src/css/custom.css` (L386-417) â€” Indigo theme, ~30 lines
4. `package.json` (L419-459) â€” Conditional deps

**Feature toggles** read from `segment.config.features`:
- `mermaid` â†’ theme + markdown config
- `gfm` â†’ remark-gfm plugin
- `math` â†’ remark-math + rehype-katex + katex CSS
- `dark_mode` â†’ colorMode default
- `github` â†’ navbar link (auto-detected from git)

**What's MISSING from scaffold**:
- TypeScript config (we generate `.js`, ref uses `.ts`)
- `experimental_faster` (Rspack/SWC/Lightning CSS acceleration)
- Local search plugin (`@easyops-cn/docusaurus-search-local`)
- PWA support (`@docusaurus/plugin-pwa`)
- Prism language configuration (ref has 12 additional languages)
- Prism theme selection (ref uses `github`/`dracula` from `prism-react-renderer`)
- `future.v4` compatibility flags
- Build hash injection system
- Theme directory (`src/theme/Root.tsx`)
- Theme hooks infrastructure
- Custom remark/rehype plugins directory (`src/plugins/`)
- Static assets directory (`static/`)
- Multiple sidebar support
- Custom `sidebarItemsGenerator` logic
- `onBrokenMarkdownLinks` configuration
- `headTags` support
- Node engine requirements in package.json
- `devDependencies` section (TypeScript, `@docusaurus/faster`, etc.)

#### Stage 4: Install (`_stage_install`, L463-502) â€” 40 lines
- Hashes `package.json` â†’ skip npm install if unchanged
- `npm install --no-audit --no-fund --prefer-offline --loglevel info`
- Line-buffered output (`bufsize=1`)
- **No**: `NODE_OPTIONS` for increased memory, npm cache warming, lockfile caching

#### Stage 5: Build (`_stage_build`, L506-535) â€” 30 lines
- `npx docusaurus build --out-dir build`
- Sets `FORCE_COLOR=0`, `CI=true`
- **No**: Content hash comparison to skip rebuild
- **No**: `--no-minify` option
- **No**: Rspack segfault detection + retry (exit code 139)
- **No**: `.docusaurus` cache clearing on theme/CSS changes
- **No**: `NODE_OPTIONS` for increased heap size
- **No**: Build timing breakdown

### 1.3 What the UI Does Today

#### Configure Modal (`configureSegment`, L856-1030)
- Builder selection dropdown
- Site title input
- 5 checkboxes (mermaid, GFM, math, dark mode, GitHub link)
- Custom CSS textarea
- Save / Save & Build buttons

#### Build Modal (`buildSegmentStream`, L1106-1383)
- SSE-connected pipeline visualization
- Per-stage cards with: icon, label, timer, log area, line count
- Collapsible log areas for each stage
- Pipeline-level elapsed timer
- Final status with View Site button

**What's MISSING from UI**:
- Search toggle
- PWA toggle
- Faster builds toggle (`experimental_faster`)
- Prism language selection
- Build mode options (optimize, no-minify)
- Content hash skip indicator
- Theme/component configuration
- Static assets management
- Multiple sidebar configuration

---

## Part II: What the Reference Has (Capability Map)

### 2.1 Template Repository Structure

```
scripts/templates/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ docusaurus.config.ts      â† TypeScript, 206 lines, with placeholders
â”‚   â”œâ”€â”€ package.json              â† Pinned versions, devDeps, engine req
â”‚   â””â”€â”€ sidebars.ts               â† TypeScript, multiple sidebars
â”œâ”€â”€ css/
â”‚   â””â”€â”€ custom.css                â† 185KB of production CSS
â”œâ”€â”€ theme/
â”‚   â”œâ”€â”€ Root.tsx                  â† Main layout wrapper with __BUILD_HASH__
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ index.ts
â”‚   â”‚   â”œâ”€â”€ useBuildHashCheck.ts  â† Cache invalidation on deploy
â”‚   â”‚   â”œâ”€â”€ useTableCopy.ts       â† Copy tables as markdown
â”‚   â”‚   â”œâ”€â”€ useProtectHashLinks.ts
â”‚   â”‚   â”œâ”€â”€ useTranslationSystem.ts
â”‚   â”‚   â””â”€â”€ ... (12 hooks total)
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ domObserver.ts
â”‚   â”‚   â”œâ”€â”€ htmlToMarkdown.ts
â”‚   â”‚   â””â”€â”€ worksheetStorage.ts
â”‚   â”œâ”€â”€ DocRoot/Layout/           â† Swizzled layout
â”‚   â””â”€â”€ NavbarItem/               â† Swizzled navbar
â”œâ”€â”€ plugins/
â”‚   â”œâ”€â”€ remark-tabs.js            â† Custom :::tabs/::tab directive
â”‚   â””â”€â”€ remark-system-viewer.js   â† Custom component embedding
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ AskAIBubble.tsx
â”‚   â”œâ”€â”€ LanguageSelector.tsx
â”‚   â”œâ”€â”€ DataManager.tsx
â”‚   â””â”€â”€ SystemViewer/             â† Complex React component
â”œâ”€â”€ static/
â”‚   â”œâ”€â”€ img/                      â† Favicon, logos
â”‚   â””â”€â”€ manifest.json             â† PWA manifest
â””â”€â”€ docs/
    â”œâ”€â”€ preface.md                â† Template docs
    â””â”€â”€ feedback.md
```

### 2.2 Build Script Capabilities (build_site.sh, 1,187 lines)

| Capability | Lines | Our Status |
|-----------|-------|------------|
| Argument parsing (dev/serve/clean/optimize) | ~60 | âŒ None |
| Template sync with `sync_if_changed()` | ~30 | âŒ We regenerate every time |
| Differential dir sync via `rsync --checksum` | ~20 | âŒ We use `shutil.copy2` |
| CSS change detection â†’ cache clear | ~15 | âŒ No cache management |
| Theme change detection â†’ cache clear | ~15 | âŒ No theme system |
| Build hash injection into Root.tsx | ~5 | âŒ No theme at all |
| Package.json hash â†’ skip npm install | ~15 | âœ… We have this |
| Content hash â†’ skip Docusaurus build | ~20 | âŒ Always rebuilds |
| Rspack segfault detection + retry | ~15 | âŒ No retry logic |
| `--no-minify` build mode | ~5 | âŒ No build modes |
| `NODE_OPTIONS` env | ~5 | âŒ Not set |
| Interactive file watcher (`inotifywait`) | ~100 | âŒ (out of scope) |
| Timing breakdown per stage | ~40 | âš ï¸ SSE has per-stage timing |
| Dev server management | ~50 | âš ï¸ Preview works |

### 2.3 Docusaurus Config Features

| Feature | Reference | Our Builder |
|---------|-----------|-------------|
| TypeScript config (`.ts`) | âœ… | âŒ `.js` via string concat |
| `experimental_faster: true` | âœ… | âŒ |
| `future.v4` flags | âœ… | âŒ |
| Mermaid | âœ… | âœ… toggle |
| Local search | âœ… `@easyops-cn/docusaurus-search-local` | âŒ |
| PWA | âœ… `@docusaurus/plugin-pwa` (conditional) | âŒ |
| Custom remark plugins | âœ… `remark-tabs`, `remark-system-viewer` | âŒ (only npm plugins) |
| Prism additional languages (12) | âœ… | âŒ |
| Prism themes (github/dracula) | âœ… | âŒ |
| Multiple sidebars | âœ… (3 sidebars) | âŒ (1 sidebar) |
| `sidebarItemsGenerator` | âœ… custom filter | âŒ |
| GFM | via remark-gfm | âœ… toggle |
| Math/KaTeX | via remark-math/rehype-katex | âœ… toggle |
| `headTags` | âœ… | âŒ |
| Navbar: multiple doc links | âœ… | âŒ (just "Docs" + GitHub) |
| `routeBasePath: '/'` | âœ… | âœ… |

### 2.4 Package.json Differences

| Aspect | Reference | Our Builder |
|--------|-----------|-------------|
| Docusaurus version | `3.9.2` (pinned) | `^3.7.0` (range) |
| `@docusaurus/faster` | âœ… (devDep) | âŒ |
| `@docusaurus/types` | âœ… (devDep) | âŒ |
| `@docusaurus/module-type-aliases` | âœ… (devDep) | âŒ |
| `@easyops-cn/docusaurus-search-local` | âœ… | âŒ |
| `@docusaurus/plugin-pwa` | âœ… | âŒ |
| TypeScript | âœ… (devDep) | âŒ |
| Node engine requirement | `>=20.0` | âŒ |
| `devDependencies` section | âœ… | âŒ |

---

## Part III: Gap Quantification

### 3.1 Numerical Assessment

| Dimension | Reference Capability | Our Capability | Gap % |
|-----------|---------------------|----------------|-------|
| Config generation | TypeScript template with placeholders, 206 lines | JS string concat, 80 lines | ~85% missing |
| Template system | 88-file template tree across 8 dirs | 0 files, 0 dirs | 100% missing |
| Build intelligence | Content hash, cache clear, retry, modes | Package.json hash only | ~80% missing |
| Theme architecture | Root.tsx + 12 hooks + utils + swizzled components | Nothing | 100% missing |
| Search | Full local search with config | Nothing | 100% missing |
| PWA | Conditional plugin with manifest | Nothing | 100% missing |
| CSS | 185KB production CSS | 30-line minimal CSS | ~95% missing |
| Prism languages | 12 additional languages + theme selection | None | 100% missing |
| Sync engine | `sync_if_changed`, `rsync --checksum`, change detection | Full regeneration every build | 100% missing |
| UI configuration | (reference has CLI args) | 5 toggles + CSS textarea | ~60% missing |

**Overall estimated capability: ~5%** (matching your assessment)

### 3.2 What Matters Most (Priority Ranking)

1. **Template system** â€” Everything else depends on this. Without templates, every scaffold rebuild is destructive and doesn't support customization.
2. **Build intelligence** â€” Content hash skip + Rspack retry + cache management. Without this, builds are slow and flaky.
3. **Config upgrade** â€” TypeScript, `experimental_faster`, Prism languages, search, PWA. These are the features users expect.
4. **Theme architecture** â€” Root.tsx with hooks enables cache invalidation, build hash tracking, and extensibility.
5. **Sync engine** â€” Differential sync prevents unnecessary rebuilds and preserves user customizations.
6. **UI configuration** â€” The modal needs to expose the new features.

---

## Part IV: Implementation Plan

### Phase 1: Template Repository (Foundation)

**Goal**: Replace string concatenation with a file-based template system.

#### 1A: Create Template Tree

**New directory**: `src/ui/web/pages_builders/templates/docusaurus/`

```
templates/docusaurus/
â”œâ”€â”€ config/
â”‚   â”œâ”€â”€ docusaurus.config.ts.tmpl   â† TypeScript template with placeholders
â”‚   â”œâ”€â”€ package.json.tmpl           â† JSON with conditional sections
â”‚   â”œâ”€â”€ sidebars.ts.tmpl            â† TypeScript sidebar template
â”‚   â””â”€â”€ tsconfig.json               â† TypeScript configuration
â”œâ”€â”€ css/
â”‚   â””â”€â”€ custom.css.tmpl             â† Base theme CSS (generous, production-quality)
â”œâ”€â”€ theme/
â”‚   â”œâ”€â”€ Root.tsx.tmpl               â† Minimal Root with __BUILD_HASH__ placeholder
â”‚   â””â”€â”€ hooks/
â”‚       â”œâ”€â”€ index.ts                â† Re-export barrel
â”‚       â””â”€â”€ useBuildHashCheck.ts    â† Cache invalidation hook
â”œâ”€â”€ plugins/
â”‚   â””â”€â”€ .gitkeep                    â† Placeholder for custom remark plugins
â”œâ”€â”€ static/
â”‚   â””â”€â”€ .gitkeep                    â† Placeholder for static assets
â””â”€â”€ TEMPLATE_MANIFEST.json          â† Metadata: ownership, sync policy per file
```

**Why not copy all 88 files from reference?** Because the reference includes domain-specific components (SystemViewer, AskAIBubble, LanguageSelector, DataManager) that are NOT generic. Our templates should be a **foundation**, not a clone. The user adds their own components.

#### 1B: Template Manifest

```json
{
  "version": "1.0.0",
  "docusaurus_version": "3.9.2",
  "files": {
    "config/docusaurus.config.ts.tmpl": {
      "output": "docusaurus.config.ts",
      "ownership": "managed",
      "sync_policy": "always",
      "placeholders": ["__SITE_TITLE__", "__BASE_URL__", "__SITE_URL__"]
    },
    "config/package.json.tmpl": {
      "output": "package.json",
      "ownership": "managed",
      "sync_policy": "always"
    },
    "config/sidebars.ts.tmpl": {
      "output": "sidebars.ts",
      "ownership": "managed",
      "sync_policy": "always"
    },
    "css/custom.css.tmpl": {
      "output": "src/css/custom.css",
      "ownership": "managed_extendable",
      "sync_policy": "if_unchanged",
      "note": "Base theme + user appended CSS"
    },
    "theme/Root.tsx.tmpl": {
      "output": "src/theme/Root.tsx",
      "ownership": "user_owned",
      "sync_policy": "if_missing",
      "placeholders": ["__BUILD_HASH__"]
    },
    "theme/hooks/useBuildHashCheck.ts": {
      "output": "src/theme/hooks/useBuildHashCheck.ts",
      "ownership": "user_owned",
      "sync_policy": "if_missing"
    }
  },
  "ownership_policies": {
    "managed": "Regenerated every build. User changes will be overwritten.",
    "managed_extendable": "Base template preserved, user additions appended after marker.",
    "user_owned": "Generated once on first scaffold. User takes ownership.",
    "ephemeral": "Caches, generated files. Can be deleted anytime."
  }
}
```

#### 1C: docusaurus.config.ts Template

This is the most critical template. It must be a **real TypeScript file** with conditional blocks managed by the Python scaffold, not string concatenation.

**Approach**: The Python scaffold reads the template, processes conditional sections marked with `// __IF_FEATURE_xxx__` / `// __ENDIF__` comments, and substitutes placeholders.

```typescript
// docusaurus.config.ts.tmpl
import { themes as prismThemes } from 'prism-react-renderer';
import type { Config } from '@docusaurus/types';
import type * as Preset from '@docusaurus/preset-classic';

const config: Config = {
  title: '__SITE_TITLE__',
  tagline: '__SITE_TAGLINE__',
  favicon: 'img/favicon.ico',
  url: '__SITE_URL__',
  baseUrl: '__BASE_URL__',
  onBrokenLinks: 'warn',
  onBrokenMarkdownLinks: 'warn',

// __IF_FEATURE_faster__
  future: {
    experimental_faster: true,
    v4: {
      removeLegacyPostBuildHeadAttribute: true,
    },
  },
// __ENDIF__

// __IF_FEATURE_mermaid__
  markdown: {
    mermaid: true,
  },
// __ENDIF__

  themes: [
// __IF_FEATURE_mermaid__
    '@docusaurus/theme-mermaid',
// __ENDIF__
// __IF_FEATURE_search__
    [
      require.resolve('@easyops-cn/docusaurus-search-local'),
      {
        hashed: true,
        indexDocs: true,
        indexBlog: false,
        docsRouteBasePath: '/',
        language: ['en'],
        highlightSearchTermsOnTargetPage: true,
        searchResultLimits: 8,
      },
    ],
// __ENDIF__
  ],

  // ... (rest of template)
};

export default config;
```

#### 1D: package.json Template

Similar conditional approach:

```json
{
  "name": "__PKG_NAME__",
  "version": "0.0.0",
  "private": true,
  "scripts": {
    "docusaurus": "docusaurus",
    "start": "docusaurus start",
    "build": "docusaurus build",
    "serve": "docusaurus serve",
    "clear": "docusaurus clear"
  },
  "dependencies": {
    "@docusaurus/core": "3.9.2",
    "@docusaurus/preset-classic": "3.9.2",
    "@mdx-js/react": "^3.0.0",
    "clsx": "^2.0.0",
    "prism-react-renderer": "^2.3.0",
    "react": "^18.2.0",
    "react-dom": "^18.2.0"
  },
  "devDependencies": {
    "@docusaurus/module-type-aliases": "3.9.2",
    "@docusaurus/types": "3.9.2",
    "typescript": "^5.0.0"
  },
  "engines": {
    "node": ">=20.0"
  }
}
```

Conditional deps added by Python:
- `feat_mermaid` â†’ `@docusaurus/theme-mermaid: 3.9.2`
- `feat_gfm` â†’ `remark-gfm: ^4.0.0`
- `feat_math` â†’ `remark-math`, `rehype-katex`, `katex`
- `feat_search` â†’ `@easyops-cn/docusaurus-search-local: 0.52.2`
- `feat_pwa` â†’ `@docusaurus/plugin-pwa: 3.9.2`
- `feat_faster` â†’ `@docusaurus/faster: 3.9.2` (in devDeps)

---

### Phase 2: Sync Engine

**Goal**: Replace "delete everything and regenerate" with intelligent differential sync.

#### 2A: Core Sync Functions

New file: `src/ui/web/pages_builders/sync.py` (~120 lines)

```python
class SyncPolicy(Enum):
    ALWAYS = "always"           # Regenerate every build (config files)
    IF_MISSING = "if_missing"   # Only create if doesn't exist (user-owned)
    IF_UNCHANGED = "if_unchanged" # Update if user hasn't modified
    MERGE = "merge"             # Template base + user additions

@dataclass
class SyncResult:
    path: str
    action: str  # "created", "updated", "skipped", "unchanged"
    reason: str

def sync_file(
    src: Path, dest: Path, 
    policy: SyncPolicy,
    placeholders: dict[str, str] | None = None,
) -> SyncResult:
    """Sync a single template file to the workspace."""
    ...

def sync_dir(src: Path, dest: Path, policy: SyncPolicy) -> list[SyncResult]:
    """Sync a directory with rsync --checksum semantics."""
    ...

def compute_file_hash(path: Path) -> str:
    """SHA256 hash of file content."""
    ...
```

#### 2B: Integration with Scaffold Stage

The new scaffold stage becomes:
1. Load template manifest
2. For each template file, apply sync policy
3. Process placeholders based on segment config
4. Process conditional blocks based on features
5. Log sync results (created/updated/skipped)

---

### Phase 3: Build Intelligence

**Goal**: Make builds fast and reliable.

#### 3A: Content Hash Skip

Before running `npx docusaurus build`:
1. Compute composite hash of `docs/**/*.mdx`, `src/**/*.{ts,tsx,css}`, `*.json`
2. Compare with stored `.content_hash`
3. If match AND `build/` exists â†’ skip build entirely
4. If building, save new hash after success

**Estimated savings**: 30-120 seconds per rebuild when only CSS/config changed

#### 3B: Cache Management

Track changes to key files:
- `src/css/custom.css` changed â†’ clear `.docusaurus/` cache
- `src/theme/Root.tsx` changed â†’ clear `.docusaurus/` cache
- `package.json` changed â†’ clear `node_modules/.cache/`

#### 3C: Rspack Segfault Recovery

When `experimental_faster: true` is enabled:
- If build exits with code 139 (SIGSEGV): 
  1. Clear `node_modules/.cache/` and `.docusaurus/`
  2. Retry build once
  3. If retry fails, fall back without `experimental_faster`

#### 3D: Build Modes

Support via `segment.config`:
- `build_mode: "standard"` â€” Default
- `build_mode: "optimize"` â€” Content hash skip, differential sync
- `build_mode: "no-minify"` â€” Faster dev builds
- `node_options: "--max-old-space-size=4096"` â€” Memory control

#### 3E: NODE_OPTIONS

Set environment for all npm/npx commands:
```python
env = {
    **os.environ,
    "FORCE_COLOR": "0",
    "CI": "true",
    "NODE_OPTIONS": segment.config.get("node_options", "--max-old-space-size=4096"),
}
```

---

### Phase 4: Theme Architecture

**Goal**: Generate a minimal but extensible theme layer.

#### 4A: Root.tsx Generation

On first scaffold (sync policy: `if_missing`), generate:

```typescript
// src/theme/Root.tsx
import React from 'react';
import { useBuildHashCheck } from './hooks/useBuildHashCheck';

const BUILD_HASH = '__BUILD_HASH__';

export default function Root({ children }: { children: React.ReactNode }) {
    useBuildHashCheck(BUILD_HASH);
    return <>{children}</>;
}
```

#### 4B: Build Hash Hook

```typescript
// src/theme/hooks/useBuildHashCheck.ts
import { useEffect } from 'react';

export function useBuildHashCheck(currentHash: string) {
    useEffect(() => {
        const stored = localStorage.getItem('build_hash');
        if (stored && stored !== currentHash) {
            console.log('[Build] New version detected, clearing cache...');
            localStorage.clear();
            sessionStorage.clear();
            if ('caches' in window) {
                caches.keys().then(keys => keys.forEach(k => caches.delete(k)));
            }
        }
        localStorage.setItem('build_hash', currentHash);
    }, [currentHash]);
}
```

#### 4C: Build Hash Injection

During scaffold, compute hash of `Root.tsx` template content, replace `__BUILD_HASH__` placeholder:
```python
build_hash = hashlib.md5(root_tsx_content.encode()).hexdigest()[:12]
content = content.replace('__BUILD_HASH__', build_hash)
```

---

### Phase 5: Feature Configuration

**Goal**: Map UI features to concrete template/dependency changes.

#### 5A: Feature Registry

```python
DOCUSAURUS_FEATURES = {
    "mermaid": {
        "label": "ğŸ§œ Mermaid Diagrams",
        "description": "Render flowcharts and sequence diagrams",
        "default": True,
        "deps": {"@docusaurus/theme-mermaid": "3.9.2"},
        "config_blocks": ["mermaid"],
        "category": "content",
    },
    "gfm": {
        "label": "ğŸ“Š GFM Support",
        "description": "GitHub Flavored Markdown tables and strikethrough",
        "default": True,
        "deps": {"remark-gfm": "^4.0.0"},
        "config_blocks": ["gfm"],
        "category": "content",
    },
    "math": {
        "label": "ğŸ”¢ Math / KaTeX",
        "description": "LaTeX math equations",
        "default": True,
        "deps": {"remark-math": "^6.0.0", "rehype-katex": "^7.0.0", "katex": "^0.16.0"},
        "config_blocks": ["math"],
        "category": "content",
    },
    "search": {
        "label": "ğŸ” Local Search",
        "description": "Full-text search without external service",
        "default": False,
        "deps": {"@easyops-cn/docusaurus-search-local": "0.52.2"},
        "config_blocks": ["search"],
        "category": "features",
    },
    "pwa": {
        "label": "ğŸ“± PWA Support",
        "description": "Installable progressive web app with offline support",
        "default": False,
        "deps": {"@docusaurus/plugin-pwa": "3.9.2"},
        "config_blocks": ["pwa"],
        "category": "features",
    },
    "faster": {
        "label": "âš¡ Faster Builds",
        "description": "Rust-based bundler (Rspack) â€” 2-5x faster builds",
        "default": True,
        "deps_dev": {"@docusaurus/faster": "3.9.2"},
        "config_blocks": ["faster"],
        "category": "build",
    },
    "dark_mode": {
        "label": "ğŸŒ™ Dark Mode Default",
        "description": "Start in dark mode (users can toggle)",
        "default": True,
        "deps": {},
        "config_blocks": ["dark_mode"],
        "category": "appearance",
    },
    "github": {
        "label": "ğŸ”— GitHub Link",
        "description": "Show repository link in navbar",
        "default": True,
        "deps": {},
        "config_blocks": ["github"],
        "category": "identity",
    },
    "prism_extra": {
        "label": "ğŸ“ Extended Languages",
        "description": "Syntax highlighting for Java, Rust, Go, PHP, Ruby, SQL, and more",
        "default": True,
        "deps": {},
        "config_blocks": ["prism_extra"],
        "category": "content",
    },
}
```

#### 5B: Template Processor

```python
def process_template(content: str, features: dict, placeholders: dict) -> str:
    """Process a template file with conditional blocks and placeholders.
    
    Conditional blocks:
        // __IF_FEATURE_xxx__
        ... content only included if feature 'xxx' is enabled ...
        // __ENDIF__
    
    Placeholders:
        __SITE_TITLE__ â†’ replaced with value from placeholders dict
    """
    # 1. Process conditional blocks
    for feature_key, enabled in features.items():
        pattern = rf'// __IF_FEATURE_{feature_key}__\n(.*?)// __ENDIF__\n'
        if enabled:
            content = re.sub(pattern, r'\1', content, flags=re.DOTALL)
        else:
            content = re.sub(pattern, '', content, flags=re.DOTALL)
    
    # 2. Process placeholders
    for key, value in placeholders.items():
        content = content.replace(key, value)
    
    return content
```

---

### Phase 6: UI Configuration Modal Overhaul

**Goal**: Present meaningful features organized by category.

#### 6A: New Modal Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš™ï¸ Configure: docs                                   â”‚
â”‚                                                       â”‚
â”‚ â”Œâ”€ Identity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ Site Title: [My Documentation          ]           â”‚â”‚
â”‚ â”‚ Builder:    [Docusaurus â–¾]                         â”‚â”‚
â”‚ â”‚ â˜‘ GitHub Link (auto-detected)                      â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                       â”‚
â”‚ â”Œâ”€ Content Features â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ â˜‘ ğŸ§œ Mermaid Diagrams                              â”‚â”‚
â”‚ â”‚ â˜‘ ğŸ“Š GFM Support                                    â”‚â”‚
â”‚ â”‚ â˜‘ ğŸ”¢ Math / KaTeX                                   â”‚â”‚
â”‚ â”‚ â˜‘ ğŸ“ Extended Languages (Java, Rust, Go...)         â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                       â”‚
â”‚ â”Œâ”€ Site Features â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ â˜ ğŸ” Local Search (full-text, no external service)  â”‚â”‚
â”‚ â”‚ â˜ ğŸ“± PWA Support (installable, offline)             â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                       â”‚
â”‚ â”Œâ”€ Build Options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ â˜‘ âš¡ Faster Builds (Rspack â€” 2-5x faster)          â”‚â”‚
â”‚ â”‚ â˜‘ ğŸŒ™ Dark Mode Default                              â”‚â”‚
â”‚ â”‚ Build Mode: [Standard â–¾]                            â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                       â”‚
â”‚ â”Œâ”€ Custom CSS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ â”‚ [                                                   â”‚â”‚
â”‚ â”‚   :root { --ifm-color-primary: #yourcolor; }       â”‚â”‚
â”‚ â”‚ ]                                                   â”‚â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                       â”‚
â”‚                            [Cancel] [Save] [Save & Build]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Part V: Implementation Sequence

### Work Order (Dependency-Driven)

```
Phase 1A  Create template tree          â†’  Foundation for everything
Phase 1B  Template manifest             â†’  Metadata for sync engine
Phase 1C  docusaurus.config.ts template â†’  Core config template
Phase 1D  package.json template         â†’  Core deps template
    â†“
Phase 2A  sync.py module                â†’  File sync engine
Phase 2B  Integrate sync into scaffold  â†’  Replace string concat
    â†“
Phase 3A  Content hash skip             â†’  Build intelligence
Phase 3B  Cache management              â†’  Faster rebuilds
Phase 3C  Rspack retry                  â†’  Build reliability
Phase 3D  Build modes                   â†’  User control
Phase 3E  NODE_OPTIONS                  â†’  Memory management
    â†“
Phase 4A  Root.tsx template             â†’  Theme foundation
Phase 4B  Build hash hook               â†’  Cache invalidation
Phase 4C  Build hash injection          â†’  Hash â†’ Root.tsx
    â†“
Phase 5A  Feature registry              â†’  Structured feature map
Phase 5B  Template processor            â†’  Conditional block engine
    â†“
Phase 6A  UI modal overhaul             â†’  Expose new features
```

### Estimated Effort (by Phase)

| Phase | Description | New/Modified Files | Estimated Lines |
|-------|-------------|--------------------|-----------------|
| 1 | Template Repository | ~10 new template files | ~500 |
| 2 | Sync Engine | 1 new module + scaffold refactor | ~200 |
| 3 | Build Intelligence | Modify `_stage_build`, `_stage_install` | ~150 |
| 4 | Theme Architecture | 2 template files + scaffold updates | ~100 |
| 5 | Feature Configuration | Modify scaffold + new registry dict | ~100 |
| 6 | UI Modal Overhaul | Modify `_integrations.html` | ~100 |
| **Total** | | **~15 files** | **~1,150 lines** |

---

## Part VI: Design Decisions & Rationale

### D1: Why Templates Over String Concatenation?

**String concat** (current): Every change to docusaurus.config requires editing Python string literals inside f-strings. No syntax highlighting, no editor support, easy to break JS syntax inside Python strings. Adding a feature means editing 5+ locations in the Python file.

**Templates** (proposed): Real TypeScript/CSS/JSON files that editors understand. Conditional blocks are clearly marked. Adding a feature means: add a block to the template, add deps to package.json template, add entry to feature registry. Three clear locations.

### D2: Why Not Copy All 88 Reference Files?

The reference project's templates include domain-specific components (SystemViewer with 50+ files, translation system, worksheet enhancements, AI chatbot). These are NOT generic Docusaurus features â€” they're application-specific code.

Our template should include:
- **Infrastructure** that every Docusaurus site needs: config, CSS, package.json, sidebars
- **Extension points** that make customization easy: Root.tsx, hooks directory, plugins directory
- **Not** domain-specific components

### D3: Why TypeScript Over JavaScript Config?

The Docusaurus team recommends TypeScript config. It provides:
- Type checking for config options
- Editor autocompletion
- `satisfies` for type safety without casting
- Future-proofing (Docusaurus v4 will require TS)

### D4: Why Pinned Versions (3.9.2) Over Ranges (^3.7.0)?

Ranges cause npm to resolve different versions on different machines. Pinned versions ensure:
- Reproducible builds
- No surprise breaking changes from minor updates
- Consistent behavior between local and CI builds

### D5: Why Sync Engine Instead of "Just Regenerate"?

Regenerating every build:
- Destroys user customizations to CSS, theme components, etc.
- Triggers unnecessary npm installs when package.json didn't actually change
- Forces full Docusaurus rebuilds when only config format changed
- Makes it impossible for users to customize their site

Sync engine:
- Respects file ownership ("this file belongs to the user now")
- Only updates files that actually changed
- Detects user modifications and skips managed files the user has customized
- Enables additive workflows (user adds hooks, we don't delete them)

---

## Part VII: Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Template processing breaks TypeScript syntax | Build fails | Unit test template processing with known inputs |
| Rspack retry masks real errors | Silent failures | Only retry on exit code 139 (SIGSEGV) |
| User modifies "managed" file, we overwrite | Data loss | Sync engine warns in logs; `if_unchanged` policy detects modifications |
| Search plugin adds ~20s to build | Slow builds | Default off; user opts in |
| PWA plugin adds ~5s to build | Slow builds | Default off; env var skip for dev |
| `experimental_faster` causes segfaults | Build flakiness | Retry logic + fallback |
| Template tree increases package size | Larger source | Template files are small text; ~50KB total |

---

## Part VIII: Success Criteria

After full implementation:

1. **`npx docusaurus build` succeeds** with all features enabled (mermaid, search, math, faster, prism)
2. **Second build of identical content takes <2s** (content hash skip)
3. **User can modify `src/css/custom.css`** and it survives re-scaffolding
4. **User can add hooks to `src/theme/hooks/`** and they survive re-scaffolding
5. **Configure modal exposes all features** with clear descriptions
6. **Rspack segfault triggers automatic retry** with cache clear
7. **Build modal shows per-stage timing** with cache skip notifications
8. **Generated TypeScript config** passes `tsc --noEmit`
9. **Template conditional blocks** correctly include/exclude features

---

## Appendix A: Current vs Target docusaurus.config Comparison

### Current (generated, 76 lines, .js)
```javascript
const config = {
  title: 'Docs',
  url: 'https://example.com',
  baseUrl: '/pages/site/docs/',
  onBrokenLinks: 'warn',
  // ... basic config ...
  themes: ['@docusaurus/theme-mermaid'],  // if mermaid enabled
  // No search, no PWA, no faster, no prism langs
};
module.exports = config;
```

### Target (generated from template, ~180 lines, .ts)
```typescript
import { themes as prismThemes } from 'prism-react-renderer';
import type { Config } from '@docusaurus/types';
import type * as Preset from '@docusaurus/preset-classic';

const config: Config = {
  title: 'Docs',
  url: 'https://example.com',
  baseUrl: '/pages/site/docs/',
  onBrokenLinks: 'warn',
  onBrokenMarkdownLinks: 'warn',
  
  future: {
    experimental_faster: true,
    v4: { removeLegacyPostBuildHeadAttribute: true },
  },
  
  markdown: { mermaid: true },
  
  themes: [
    '@docusaurus/theme-mermaid',
    [require.resolve('@easyops-cn/docusaurus-search-local'), {
      hashed: true, indexDocs: true, docsRouteBasePath: '/',
      highlightSearchTermsOnTargetPage: true,
    }],
  ],
  
  presets: [['classic', {
    docs: {
      routeBasePath: '/',
      sidebarPath: './sidebars.ts',
      remarkPlugins: [
        [require('remark-gfm'), {}],
        [require('remark-math'), {}],
      ],
      rehypePlugins: [
        [require('rehype-katex'), { strict: false }],
      ],
    },
    blog: false,
    theme: { customCss: './src/css/custom.css' },
  } satisfies Preset.Options]],
  
  themeConfig: {
    navbar: { title: 'Docs', items: [...] },
    colorMode: { defaultMode: 'dark', respectPrefersColorScheme: true },
    prism: {
      theme: prismThemes.github,
      darkTheme: prismThemes.dracula,
      additionalLanguages: [
        'java', 'csharp', 'ruby', 'php', 'rust', 'go',
        'bash', 'sql', 'yaml', 'json', 'protobuf',
      ],
    },
    footer: { style: 'dark', copyright: 'Built with Docusaurus' },
  } satisfies Preset.ThemeConfig,
};

export default config;
```
