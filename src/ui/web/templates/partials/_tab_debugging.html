<!-- Debugging Tab -->
<div id="tab-debugging" class="tab-content">
    <header class="tab-header">
        <h1>üêõ Debugging</h1>
        <p class="subtitle">Diagnostics, logs, and system inspection</p>
    </header>

    <div class="debug-modes">
        <button class="content-mode active" onclick="debugSwitchMode('audit')">üìã Audit Log</button>
        <button class="content-mode" onclick="debugSwitchMode('state')">üì¶ State</button>
        <button class="content-mode" onclick="debugSwitchMode('health')">‚ù§Ô∏è Health</button>
        <button class="content-mode" onclick="debugSwitchMode('config')">‚öôÔ∏è Config</button>
        <button class="content-mode" onclick="debugSwitchMode('commands')">‚ö° Commands</button>
        <button class="content-mode" onclick="debugSwitchMode('traces')">üìù Traces</button>
    </div>

    <div class="grid">
        <!-- Audit log viewer -->
        <div class="card full-width" id="debug-audit">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-sm);flex-wrap:wrap;gap:8px">
                <div style="display:flex;align-items:center;gap:8px">
                    <h2 class="card-title" style="margin:0">Audit Log</h2>
                    <span id="debug-audit-count" style="font-size:0.64rem;padding:2px 7px;border-radius:10px;background:var(--accent);color:#fff;font-weight:600;min-width:18px;text-align:center" title="Total entries"></span>
                </div>
                <div style="display:flex;gap:0.4rem">
                    <button class="btn btn-sm btn-ghost debug-audit-toggle active" data-mode="scans" onclick="debugAuditToggle('scans')" style="font-size:0.7rem" title="Scan activity from Audit & DevOps tabs">üî¨ Scan Activity</button>
                    <button class="btn btn-sm btn-ghost debug-audit-toggle" data-mode="ops" onclick="debugAuditToggle('ops')" style="font-size:0.7rem" title="CLI operation log from audit.ndjson">‚ö° CLI Operations</button>
                </div>
            </div>
            <!-- Search & Filter bar -->
            <div id="debug-audit-toolbar" style="display:flex;align-items:center;gap:8px;margin-bottom:var(--space-sm);flex-wrap:wrap">
                <div style="position:relative;flex:1;min-width:180px;max-width:360px">
                    <input id="debug-audit-search" type="text" placeholder="Search label, summary, target‚Ä¶" style="width:100%;padding:5px 10px 5px 30px;border-radius:var(--radius-sm);border:1px solid var(--border-subtle);background:var(--bg-primary);color:var(--text-primary);font-size:0.72rem;outline:none" oninput="_auditSearchDebounce()">
                    <span style="position:absolute;left:9px;top:50%;transform:translateY(-50%);font-size:0.72rem;opacity:0.5">üîç</span>
                </div>
                <select id="debug-audit-card-filter" onchange="loadDebugAuditScans()" style="padding:5px 8px;border-radius:var(--radius-sm);border:1px solid var(--border-subtle);background:var(--bg-primary);color:var(--text-primary);font-size:0.72rem;outline:none;min-width:100px">
                    <option value="">All types</option>
                </select>
                <span id="debug-audit-filtered-count" style="font-size:0.62rem;color:var(--text-muted);white-space:nowrap"></span>
            </div>
            <div id="debug-audit-scans" class="activity-list" style="max-height:600px;overflow-y:auto">
                <div class="activity-item" style="color:var(--text-muted)">
                    <span class="spinner"></span>&nbsp; Loading scan activity...
                </div>
            </div>
            <div id="debug-audit-scans-more" style="display:none;text-align:center;padding:8px">
                <button class="btn btn-sm btn-ghost" onclick="_auditLoadMore()" style="font-size:0.72rem">‚¨á Load more</button>
            </div>
            <div id="debug-audit-ops" class="activity-list" style="display:none;max-height:600px;overflow-y:auto">
                <div class="activity-item" style="color:var(--text-muted)">
                    <span class="spinner"></span>&nbsp; Loading CLI operations...
                </div>
            </div>
        </div>

        <!-- State inspector -->
        <div class="card full-width" id="debug-state" style="display:none">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                <h2 class="card-title" style="margin:0">State Inspector</h2>
                <div style="display:flex;gap:0.4rem">
                    <button class="btn btn-sm btn-ghost debug-view-toggle active" data-panel="state" data-mode="preview" onclick="debugToggleView('state','preview')" style="font-size:0.7rem" title="Structured preview">üìä Preview</button>
                    <button class="btn btn-sm btn-ghost debug-view-toggle" data-panel="state" data-mode="source" onclick="debugToggleView('state','source')" style="font-size:0.7rem" title="View JSON source in editor">{ } Source</button>
                </div>
            </div>
            <div id="debug-state-preview"></div>
            <div id="debug-state-editor" style="display:none;height:500px;border-radius:var(--radius-md);overflow:hidden;border:1px solid var(--border)"></div>
        </div>

        <!-- Health details -->
        <div class="card full-width" id="debug-health" style="display:none">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                <h2 class="card-title" style="margin:0">Health Details</h2>
                <div style="display:flex;gap:0.4rem">
                    <button class="btn btn-sm btn-ghost debug-view-toggle active" data-panel="health" data-mode="preview" onclick="debugToggleView('health','preview')" style="font-size:0.7rem" title="Structured preview">üìä Preview</button>
                    <button class="btn btn-sm btn-ghost debug-view-toggle" data-panel="health" data-mode="source" onclick="debugToggleView('health','source')" style="font-size:0.7rem" title="View JSON source in editor">{ } Source</button>
                </div>
            </div>
            <div id="debug-health-preview"></div>
            <div id="debug-health-editor" style="display:none;height:500px;border-radius:var(--radius-md);overflow:hidden;border:1px solid var(--border)"></div>
        </div>

        <!-- Config dump -->
        <div class="card full-width" id="debug-config" style="display:none">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                <h2 class="card-title" style="margin:0">Configuration</h2>
                <div style="display:flex;gap:0.4rem">
                    <button class="btn btn-sm btn-ghost debug-view-toggle active" data-panel="config" data-mode="preview" onclick="debugToggleView('config','preview')" style="font-size:0.7rem" title="Structured preview">üìä Preview</button>
                    <button class="btn btn-sm btn-ghost debug-view-toggle" data-panel="config" data-mode="source" onclick="debugToggleView('config','source')" style="font-size:0.7rem" title="View JSON source in editor">{ } Source</button>
                </div>
            </div>
            <div id="debug-config-preview"></div>
            <div id="debug-config-editor" style="display:none;height:500px;border-radius:var(--radius-md);overflow:hidden;border:1px solid var(--border)"></div>
        </div>

        <!-- Commands -->
        <div class="card full-width" id="debug-commands" style="display:none">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                <h2 class="card-title" style="margin:0">Commands</h2>
            </div>
            <p class="panel-description">
                Run a DevOps command across your project modules.
                Pick what to do, choose which module(s) to target, then execute.
                <span class="mock-notice">üõ°Ô∏è <strong>Mock mode</strong> ‚Äî commands are simulated, nothing actually runs
                    on your system.</span>
            </p>
            <form class="run-form" id="run-form" onsubmit="return executeRun(event)">
                <div class="form-group" style="flex:1.5;min-width:200px">
                    <label for="run-capability">1. What to do</label>
                    <select id="run-capability" name="capability" onchange="onCapabilityChange()">
                        <option value="">Loading capabilities...</option>
                    </select>
                </div>
                <div class="form-group" style="flex:1;min-width:160px">
                    <label for="run-module">2. Target module</label>
                    <select id="run-module" name="module" onchange="onSelectionChange()">
                        <option value="">All modules</option>
                    </select>
                </div>
                <div class="form-group" style="flex:0.7;min-width:120px">
                    <label for="run-env">3. Environment</label>
                    <select id="run-env" name="environment">
                        <option value="dev">dev</option>
                    </select>
                </div>
                <div class="form-buttons">
                    <button type="submit" class="btn btn-primary" id="run-btn" disabled>
                        ‚ö° Execute
                    </button>
                    <button type="button" class="btn btn-secondary" id="preview-btn" onclick="executeDryRun()">
                        üëÅ Preview
                    </button>
                </div>
            </form>

            <!-- Context panel ‚Äî shows what will happen -->
            <div class="context-panel" id="context-panel">
                <div class="context-empty" id="context-empty">
                    ‚Üë Select a capability to see what will happen
                </div>
                <div class="context-detail" id="context-detail" style="display:none"></div>
            </div>

            <!-- Results Panel -->
            <div id="results-section" style="display:none;margin-top:var(--space-xl);">
                <div class="section-header">
                    <h2 class="section-title">üìã Results</h2>
                    <button class="btn btn-secondary btn-sm" onclick="clearResults()">‚úï Dismiss</button>
                </div>
                <div class="results-panel" id="results-panel" translate="no"></div>
            </div>
        </div>

        <!-- Session Traces -->
        <div class="card full-width" id="debug-traces" style="display:none">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-sm);flex-wrap:wrap;gap:8px">
                <div style="display:flex;align-items:center;gap:8px">
                    <h2 class="card-title" style="margin:0">Session Traces</h2>
                    <span id="debug-trace-count" style="font-size:0.64rem;padding:2px 7px;border-radius:10px;background:var(--accent);color:#fff;font-weight:600;min-width:18px;text-align:center" title="Saved traces"></span>
                    <span id="debug-trace-recording-indicator" style="display:none;font-size:0.64rem;padding:2px 8px;border-radius:10px;background:var(--error);color:#fff;font-weight:600;animation:pulse 1.5s infinite">‚è∫ Recording</span>
                </div>
                <div style="display:flex;gap:0.4rem;align-items:center">
                    <select id="debug-trace-classification" style="padding:4px 8px;border-radius:var(--radius-sm);border:1px solid var(--border-subtle);background:var(--bg-primary);color:var(--text-primary);font-size:0.72rem;outline:none">
                        <option value="">General</option>
                        <option value="deployment">üöÄ Deployment</option>
                        <option value="debugging">üêõ Debugging</option>
                        <option value="config">‚öôÔ∏è Configuration</option>
                        <option value="exploration">üîç Exploration</option>
                        <option value="setup">üßô Setup</option>
                    </select>
                    <input id="debug-trace-name" type="text" placeholder="Recording name (optional)" style="padding:4px 8px;border-radius:var(--radius-sm);border:1px solid var(--border-subtle);background:var(--bg-primary);color:var(--text-primary);font-size:0.72rem;outline:none;width:180px">
                    <button id="debug-trace-start-btn" class="btn btn-sm btn-primary" onclick="debugTraceToggle()" style="font-size:0.72rem">‚è∫ Start Recording</button>
                </div>
            </div>
            <div id="debug-trace-list" class="activity-list" style="max-height:600px;overflow-y:auto">
                <div class="activity-item" style="color:var(--text-muted)">
                    <span class="spinner"></span>&nbsp; Loading traces...
                </div>
            </div>
        </div>
    </div>

    <!-- Share trace modal ‚Äî thread picker -->
    <div id="trace-share-modal" class="chat-modal-overlay" style="display:none">
        <div class="chat-modal" style="max-width:400px">
            <h3>üì§ Share Trace to Chat</h3>
            <p style="font-size:0.78rem;color:var(--text-secondary);margin:0 0 0.75rem">Choose a thread to post the trace to:</p>
            <div id="trace-share-thread-list" style="max-height:240px;overflow-y:auto;display:flex;flex-direction:column;gap:2px;margin-bottom:0.75rem;border:1px solid var(--border-subtle);border-radius:var(--radius-sm);padding:6px">
            </div>
            <div style="margin-bottom:0.75rem">
                <button class="btn btn-secondary btn-sm" onclick="_traceShareToggleNew()" style="font-size:0.72rem">+ New Thread</button>
                <div id="trace-share-new-row" style="display:none;align-items:center;gap:8px;margin-top:6px;padding:6px 10px;border-radius:var(--radius-sm);background:rgba(99,102,241,0.06)">
                    <input type="radio" name="trace-share-thread" value="__new__" id="trace-share-new-radio">
                    <input type="text" id="trace-share-new-name" placeholder="Thread name..." style="flex:1;padding:4px 8px;border-radius:var(--radius-sm);border:1px solid var(--border-subtle);background:var(--bg-primary);color:var(--text-primary);font-size:0.75rem">
                </div>
            </div>
            <div class="chat-modal-actions">
                <button class="btn btn-secondary btn-sm" onclick="_traceShareClose()">Cancel</button>
                <button class="btn btn-primary btn-sm" onclick="_traceShareConfirm()">Share</button>
            </div>
        </div>
    </div>
</div>