/* Wizard JS â€” Integration Sub-Wizards
     Integration card rendering, sub-wizard toggle, per-integration forms
     (Docker, K8s, Terraform, CI/CD config generation UI).
     Depends on: _wizard_helpers.html (helpers), _wizard_init.html (state)
*/

/** Map wizard integration keys to openSetupWizard dispatcher keys. */
function _wizKeyToSetupKey(key) {
    const map = {
        'int:git': 'git', 'int:docker': 'docker', 'int:ci': 'cicd',
        'int:github': 'github', 'int:pages': 'pages',
        'k8s': 'k8s', 'terraform': 'terraform', 'dns': 'dns',
    };
    return map[key] || key;
}

function _wizRenderIntegrations() {
    const d = _wizIntDetection;
    const el = document.getElementById('wiz-int-body');
    if (!el || !d) return;

    const savedPrefs = (_wizardConfig && _wizardConfig._integrationPrefs) || d.current_prefs || {};

    // â”€â”€ Scan info bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const scanAge = wizAge('detect');
    const scanAgeStr = scanAge != null ? _formatAge(scanAge) : 'unknown';
    const isStale = storeIsStale('wiz:detect');
    const wasCached = d._cache?.fresh !== false;

    let scanBarHtml = `
            <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:var(--space-md);
                        padding:0.4rem 0.75rem;border-radius:var(--radius-sm);
                        background:var(--bg-inset);border:1px solid var(--border-subtle);font-size:0.72rem">
                <span style="color:var(--text-muted)">ğŸ” Last scanned: <strong>${esc(scanAgeStr)}</strong></span>`;

    if (isStale) {
        scanBarHtml += `
                <span style="display:inline-flex;align-items:center;gap:0.25rem;padding:0.1rem 0.4rem;
                             border-radius:4px;font-size:0.65rem;font-weight:600;
                             background:color-mix(in srgb, var(--warning) 12%, transparent);
                             color:var(--warning);border:1px solid color-mix(in srgb, var(--warning) 30%, transparent)">
                    âš¡ Files changed â€” rescan recommended
                </span>`;
    } else if (wasCached && scanAge != null && scanAge < 30) {
        scanBarHtml += `
                <span style="font-size:0.65rem;color:var(--success)">âœ“ fresh</span>`;
    }

    scanBarHtml += `
                <button class="btn btn-sm btn-secondary" onclick="_wizRedetect()"
                    style="margin-left:auto;font-size:0.65rem;padding:1px 8px">
                    ğŸ”„ Re-scan
                </button>
            </div>`;

    // â”€â”€ Tools section (compact) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const toolEntries = Object.entries(d.tools);
    const avail = toolEntries.filter(([, v]) => v).length;
    const missing = toolEntries.filter(([, v]) => !v);

    let toolsHtml = `
            <div style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.4rem">
                ğŸ”§ System Tools (${avail}/${toolEntries.length} available)
            </div>`;

    if (missing.length > 0) {
        toolsHtml += `<div style="background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;overflow:hidden;margin-bottom:var(--space-md)">`;
        for (const [tool] of missing) {
            toolsHtml += `
                    <div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.6rem;border-bottom:1px solid var(--border-subtle)" id="wiz-int-tool-${tool}">
                        <span style="width:1.3rem;text-align:center;color:var(--error);font-size:0.8rem">âœ—</span>
                        <code style="flex:1;font-size:0.82rem">${esc(tool)}</code>
                        <button class="btn btn-sm btn-secondary" style="font-size:0.72rem;padding:0.15rem 0.5rem"
                            onclick="_wizInstallTool('${esc(tool)}', this)">ğŸ“¦ Install</button>
                    </div>`;
        }
        toolsHtml += `</div>`;
    } else {
        toolsHtml += `<div style="font-size:0.82rem;color:var(--success);margin-bottom:var(--space-sm);padding:0.3rem 0">âœ… All tools installed</div>`;
    }

    // Installed pills
    const installed = toolEntries.filter(([, v]) => v);
    if (installed.length > 0) {
        toolsHtml += `<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:var(--space-md)">`;
        for (const [tool] of installed) {
            toolsHtml += `<span style="font-size:0.65rem;padding:0.1rem 0.35rem;border-radius:4px;background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)">âœ“ ${esc(tool)}</span>`;
        }
        toolsHtml += `</div>`;
    }

    // â”€â”€ Project files (compact) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const fileEntries = Object.entries(d.files);
    toolsHtml += `
            <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:var(--space-md)">
                ${fileEntries.map(([k, v]) => `<span style="font-size:0.68rem;padding:0.1rem 0.4rem;border-radius:4px;border:1px solid ${v ? 'var(--accent)' : 'var(--border-subtle)'};color:${v ? 'var(--accent)' : 'var(--text-muted)'};background:${v ? 'color-mix(in srgb, var(--accent) 8%, transparent)' : 'var(--bg-inset)'}">${v ? 'â—' : 'â—‹'} ${esc(k.replace(/_/g, ' '))}</span>`).join('')}
            </div>`;

    // â”€â”€ Card detail enrichment from embedded data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _cardDetails = _wizCardDetails(d);

    // â”€â”€ Integration order: Git â†’ GitHub â†’ Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const integrationOrder = ['int:git', 'int:github', 'int:pages'];

    let cardsHtml = `
            <div style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.4rem">
                ğŸ”Œ Integrations
            </div>
            <div style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:var(--space-md)">`;

    for (const key of integrationOrder) {
        const info = d.integrations[key];
        if (!info) continue;
        const bareKey = key.replace(/^int:/, '');
        if (d.devops_cards[bareKey]) continue;
        const enabled = (savedPrefs[key] || info.suggest) !== 'hidden';
        cardsHtml += _wizIntCard(key, info, enabled, _cardDetails[key] || '');
    }
    cardsHtml += `</div>`;

    // â”€â”€ DevOps Extensions: Docker â†’ K8s â†’ Terraform â†’ DNS â”€â”€â”€â”€
    const devopsIntegrationKeys = ['int:docker'];
    const devopsCardOrder = ['k8s', 'terraform', 'dns'];

    cardsHtml += `
            <div style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.4rem">
                âš™ï¸ DevOps Extensions
            </div>
            <div style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:var(--space-md)">`;

    // Docker (from integrations dict)
    for (const key of devopsIntegrationKeys) {
        const info = d.integrations[key];
        if (!info) continue;
        const enabled = (savedPrefs[key] || info.suggest) !== 'hidden';
        cardsHtml += _wizIntCard(key, info, enabled, _cardDetails[key] || '');
    }

    // K8s, Terraform, DNS (from devops_cards dict)
    for (const key of devopsCardOrder) {
        const info = d.devops_cards[key];
        if (!info) continue;
        if (!info.tools_needed && info.detected === true) continue;
        const enabled = (savedPrefs[key] || info.suggest) !== 'hidden';
        cardsHtml += _wizIntCard(key, info, enabled, _cardDetails[key] || '');
    }

    // Remaining devops_cards not in our explicit order (security, testing, quality, etc.)
    for (const [key, info] of Object.entries(d.devops_cards)) {
        if (devopsCardOrder.includes(key)) continue;
        if (!info.tools_needed && info.detected === true) continue;
        const enabled = (savedPrefs[key] || info.suggest) !== 'hidden';
        cardsHtml += _wizIntCard(key, info, enabled, _cardDetails[key] || '');
    }
    cardsHtml += `</div>`;

    // â”€â”€ CI/CD â€” its own section, last â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const ciInfo = d.integrations['int:ci'];
    if (ciInfo) {
        const ciEnabled = (savedPrefs['int:ci'] || ciInfo.suggest) !== 'hidden';
        cardsHtml += `
            <div style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.4rem">
                ğŸ”„ Continuous Integration & Deployment
            </div>
            <div style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:var(--space-md)">
                ${_wizIntCard('int:ci', ciInfo, ciEnabled, _cardDetails['int:ci'] || '')}
            </div>`;
    }

    // â”€â”€ Remaining integrations not in any explicit order â”€â”€â”€â”€â”€â”€â”€
    const renderedKeys = new Set([...integrationOrder, ...devopsIntegrationKeys, 'int:ci']);
    const remainingIntKeys = Object.keys(d.integrations).filter(k => !renderedKeys.has(k));
    if (remainingIntKeys.length > 0) {
        for (const key of remainingIntKeys) {
            const info = d.integrations[key];
            const bareKey = key.replace(/^int:/, '');
            if (d.devops_cards[bareKey]) continue;
            const enabled = (savedPrefs[key] || info.suggest) !== 'hidden';
            cardsHtml += _wizIntCard(key, info, enabled, _cardDetails[key] || '');
        }
    }

    el.style.display = 'block';
    el.innerHTML = scanBarHtml + toolsHtml + cardsHtml + `
            <p style="color:var(--text-muted);font-size:0.75rem;margin-top:0.5rem">
                ğŸ’¡ Click <strong>âš™ï¸ Setup</strong> on any card to configure it.
                Uncheck to hide from UI.
            </p>`;
}

// â”€â”€ Card detail text â€” enriched from embedded detection data â”€â”€â”€
function _wizCardDetails(d) {
    const ciSt = d.ci_status || {};
    const ghCli = d.gh_cli_status || {};
    const ghUser = d.gh_user || {};
    const ghRepo = d.gh_repo_info || {};
    const ghEnvs = d.gh_environments || {};
    const dockerSt = d.docker_status || {};
    const gitRemotes = d.git_remotes || {};
    const envSt = d.env_status || {};
    const stacks = d.detected_stacks || [];
    const sd = d.stack_defaults || {};
    const probes = d.status_probes || {};
    const gitProbe = probes.git || {};
    const ghProbe = probes.github || {};
    const giAnalysis = d.gitignore_analysis || {};

    const remotes = (gitRemotes.remotes || []);
    const originRemote = remotes.find(r => r.name === 'origin');
    const ciProviders = ciSt.providers || [];
    const ciWorkflows = ciSt.total_workflows || 0;
    const ghEnvList = ghEnvs.environments || [];

    // â”€â”€ Git card detail â€” branch, remote, .gitignore, hooks â”€â”€
    let gitDesc = '';
    if (gitProbe.initialized) {
        const parts = [];
        if (gitProbe.branch) parts.push(gitProbe.branch);
        if (originRemote) {
            const shortUrl = (originRemote.fetch || originRemote.push || '').replace(/^https?:\/\//, '').replace(/\.git$/, '');
            parts.push(shortUrl || 'origin');
        } else if (remotes.length > 0) {
            parts.push(remotes.length + ' remote(s)');
        }
        if (gitProbe.has_gitignore) {
            const cov = Math.round((giAnalysis.coverage || 0) * 100);
            parts.push('.gitignore ' + cov + '%');
        } else {
            parts.push('no .gitignore');
        }
        if (gitProbe.hook_count > 0) parts.push(gitProbe.hook_count + ' hook(s)');
        gitDesc = parts.join(' Â· ');
    } else {
        gitDesc = 'No repository â€” click Setup to initialize.';
    }

    // â”€â”€ GitHub card detail â€” auth, repo, envs, secrets, CODEOWNERS â”€â”€
    let ghDesc = '';
    if (ghCli.authenticated) {
        const parts = [];
        if (ghUser.login) parts.push('@' + ghUser.login);
        if (ghRepo.slug) parts.push(ghRepo.slug);
        if (ghRepo.visibility) parts.push(ghRepo.visibility.toLowerCase());
        if (ghEnvList.length > 0) parts.push(ghEnvList.length + ' env(s)');
        if (ghProbe.has_codeowners) parts.push('CODEOWNERS âœ“');
        if (ghProbe.workflow_count > 0) parts.push(ghProbe.workflow_count + ' workflow(s)');
        ghDesc = parts.join(' Â· ');
    } else if (ghCli.available) {
        ghDesc = 'gh CLI installed but not authenticated.';
    } else {
        ghDesc = 'GitHub CLI access â€” PRs, issues, environments.';
    }

    return {
        'int:git': gitDesc,

        'int:github': ghDesc,

        'int:ci': ciWorkflows > 0
            ? `${ciProviders.length > 0 ? ciProviders[0].name + ': ' : ''}${ciWorkflows} workflow${ciWorkflows !== 1 ? 's' : ''}${sd.primary_stack ? ' Â· ' + (sd.icon || '') + ' ' + sd.primary_stack : ''}`
            : `No workflows detected.${sd.primary_stack ? ' Stack: ' + (sd.icon || '') + ' ' + sd.primary_stack : ''}`,

        'int:docker': dockerSt.available
            ? `Docker ${dockerSt.daemon_running ? 'âœ“ running' : 'âš  daemon offline'}${dockerSt.compose_available ? ' Â· compose âœ“' : ''}${d.integrations?.['int:docker']?.has_dockerfile ? ' Â· Dockerfile âœ“' : ''}${d.integrations?.['int:docker']?.has_compose ? ' Â· compose.yml âœ“' : ''}`
            : 'Docker containerization â€” build, run, compose.',

        'int:pages': (() => {
            const ps = d.pages_status || {};
            const pp = (d.status_probes || {}).pages || {};
            const segs = ps.segments || [];
            const cfs = ps.content_folders || [];
            if (segs.length > 0) {
                const builders = [...new Set(segs.map(s => s.builder))].join(', ');
                return `${segs.length} segment${segs.length !== 1 ? 's' : ''} Â· ${builders}${ps.meta?.deploy_branch ? ' Â· ğŸŒ¿ ' + ps.meta.deploy_branch : ''}`;
            }
            if (cfs.length > 0) {
                return `${cfs.length} content folder${cfs.length !== 1 ? 's' : ''} detected â€” auto-init available`;
            }
            return 'Static site builder with multi-section support.';
        })(),

        'k8s': (() => {
            const k8sSt = d.k8s_status || {};
            const kctl = k8sSt.kubectl || {};
            if (!kctl.available) return 'kubectl not found';
            const parts = [];
            if (kctl.version) parts.push('kubectl ' + (kctl.version + '').split(',')[0]);
            if (k8sSt.total_resources > 0) parts.push(k8sSt.total_resources + ' resource' + (k8sSt.total_resources !== 1 ? 's' : ''));
            else parts.push('no manifests');
            const hc = (k8sSt.helm_charts || []).length;
            if (hc > 0) parts.push(hc + ' Helm chart' + (hc !== 1 ? 's' : ''));
            if (k8sSt.kustomize && k8sSt.kustomize.exists) {
                const oc = k8sSt.kustomize.overlay_count || 0;
                parts.push('Kustomize' + (oc > 0 ? ' (' + oc + ' overlay' + (oc !== 1 ? 's' : '') + ')' : ''));
            }
            if (k8sSt.deployment_readiness) parts.push(k8sSt.deployment_readiness.replace(/_/g, ' '));
            return parts.join(' Â· ') || 'Kubernetes deployment â€” pods, services, ingress.';
        })(),
        'terraform': (() => {
            const tfSt = d.terraform_status || {};
            const cli = tfSt.cli || {};
            if (!cli.available) return 'terraform not found';
            const parts = [];
            if (cli.version) parts.push('terraform ' + (cli.version + '').split('\n')[0]);
            const rc = tfSt.resource_count || 0;
            if (rc > 0) parts.push(rc + ' resource' + (rc !== 1 ? 's' : ''));
            else parts.push('no resources');
            const prov = tfSt.providers || [];
            if (prov.length > 0) parts.push(prov.slice(0, 3).map(p => typeof p === 'string' ? p.split('/').pop() : p).join(', '));
            const mods = tfSt.modules || [];
            if (mods.length > 0) parts.push(mods.length + ' module' + (mods.length !== 1 ? 's' : ''));
            if (tfSt.backend) parts.push(tfSt.backend.type + ' backend');
            if (tfSt.initialized) parts.push('initialized');
            return parts.join(' Â· ') || 'Infrastructure as Code â€” provision cloud resources.';
        })(),
        'dns': (() => {
            const dnsSt = d.dns_status || {};
            const parts = [];
            const cdnProvs = dnsSt.cdn_providers || [];
            if (cdnProvs.length > 0) parts.push(cdnProvs.map(p => p.name).join(', '));
            const doms = dnsSt.domains || [];
            if (doms.length > 0) parts.push(doms.length + ' domain' + (doms.length !== 1 ? 's' : ''));
            const dnsFiles = dnsSt.dns_files || [];
            if (dnsFiles.length > 0) parts.push(dnsFiles.length + ' DNS file' + (dnsFiles.length !== 1 ? 's' : ''));
            const certs = dnsSt.ssl_certs || [];
            if (certs.length > 0) parts.push(certs.length + ' cert' + (certs.length !== 1 ? 's' : ''));
            return parts.join(' \u00b7 ') || 'DNS resolution and CDN checks.';
        })(),
    };
}

// â”€â”€ Integration card with inline sub-wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function _wizIntCard(key, info, enabled, desc) {
    const safeId = key.replace(':', '-');
    const status = info.status || (info.detected ? 'ready' : 'not_installed');
    const sc = {
        ready: { bg: 'var(--success)', text: 'âœ… ready' },
        installed: { bg: 'var(--warning)', text: 'âš ï¸ not configured' },
        available: { bg: 'var(--text-muted)', text: 'â—‹ not set up' },
        not_installed: { bg: 'var(--text-muted)', text: 'âœ— not installed' },
        not_available: { bg: 'var(--text-muted)', text: 'â€” n/a' },
    }[status] || { bg: 'var(--text-muted)', text: status };
    const badge = `<span style="font-size:0.65rem;padding:0.08rem 0.3rem;border-radius:4px;background:color-mix(in srgb, ${sc.bg} 12%, transparent);color:${sc.bg};border:1px solid color-mix(in srgb, ${sc.bg} 30%, transparent)">${sc.text}</span>`;

    let details = '';
    if ((info.tools_needed || []).length > 0)
        details += `<div style="font-size:0.7rem;color:var(--warning);margin-top:0.15rem">âš  needs: <code>${info.tools_needed.join(', ')}</code></div>`;
    if (info.daemon_ok === false && status === 'installed')
        details += `<div style="font-size:0.7rem;color:var(--error);margin-top:0.15rem">âœ— Docker daemon not reachable</div>`;
    if (info.daemon_ok === true)
        details += `<div style="font-size:0.7rem;color:var(--success);margin-top:0.1rem">âœ“ daemon connected</div>`;
    if (info.cluster_ok === false && status === 'installed')
        details += `<div style="font-size:0.7rem;color:var(--error);margin-top:0.15rem">âœ— no cluster connected</div>`;
    if (info.has_dockerfile) details += `<div style="font-size:0.7rem;color:var(--success);margin-top:0.1rem">âœ“ Dockerfile</div>`;
    if (info.has_compose) details += `<div style="font-size:0.7rem;color:var(--success);margin-top:0.1rem">âœ“ docker-compose.yml</div>`;

    return `
            <div style="background:var(--bg-inset);border:1px solid ${enabled ? 'var(--accent)' : 'var(--border-subtle)'};border-radius:8px;overflow:hidden;transition:border-color 0.15s" id="wiz-int-wrap-${safeId}">
                <div style="display:flex;align-items:flex-start;gap:0.5rem;padding:0.5rem 0.65rem">
                    <input type="checkbox" ${enabled ? 'checked' : ''}
                        id="wiz-int-${safeId}"
                        onchange="_wizToggleBorder('${safeId}', this.checked)"
                        style="width:15px;height:15px;accent-color:var(--accent);cursor:pointer;margin-top:0.1rem">
                    <div style="flex:1;min-width:0">
                        <div style="display:flex;align-items:center;gap:0.35rem;flex-wrap:wrap">
                            <span style="font-weight:600;font-size:0.82rem">${info.label}</span>
                            ${badge}
                        </div>
                        ${desc ? `<div style="font-size:0.72rem;color:var(--text-muted);margin-top:0.1rem;line-height:1.35">${esc(desc)}</div>` : ''}
                        ${details}
                    </div>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.15rem 0.45rem;white-space:nowrap"
                        onclick="_wizToggleSetup('${esc(key)}')">âš™ï¸ Setup</button>
                    <button class="btn btn-sm btn-ghost" style="font-size:0.62rem;padding:0.1rem 0.35rem;white-space:nowrap;color:var(--accent)"
                        onclick="openSetupWizard('${esc(_wizKeyToSetupKey(key))}')" title="Open full setup wizard">ğŸš€ Full Setup â†’</button>
                </div>
                <div id="wiz-int-setup-${safeId}" style="display:none"></div>
            </div>`;
}

function _wizToggleBorder(safeId, checked) {
    const wrap = document.getElementById('wiz-int-wrap-' + safeId);
    if (wrap) wrap.style.borderColor = checked ? 'var(--accent)' : 'var(--border-subtle)';
}

// â”€â”€ Sub-wizard toggle & form renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function _wizToggleSetup(key) {
    const safeId = key.replace(':', '-');
    const panel = document.getElementById('wiz-int-setup-' + safeId);
    if (!panel) return;

    if (panel.style.display !== 'none') {
        panel.style.display = 'none';
        panel.innerHTML = '';
        return;
    }

    const d = _wizIntDetection;
    const info = d.integrations[key] || d.devops_cards[key] || {};
    const projectName = (_wizardConfig && _wizardConfig.name) || 'app';

    const formFn = _wizSubForms[key];
    if (formFn) {
        panel.innerHTML = formFn(info, projectName, d);
    } else {
        panel.innerHTML = `<p style="font-size:0.78rem;color:var(--text-muted);padding:0.5rem">No setup form for this integration yet.</p>`;
    }
    panel.style.display = 'block';
    panel.style.borderTop = '1px solid var(--border-subtle)';
    panel.style.padding = '0.6rem 0.65rem';
    panel.style.background = 'var(--bg-card)';
}

/** Reusable form field */
function _wizField(id, label, value, opts = {}) {
    const type = opts.type || 'text';
    const help = opts.help ? `<div style="font-size:0.65rem;color:var(--text-muted);margin-top:0.1rem">${opts.help}</div>` : '';
    if (type === 'checkbox') {
        return `<div style="margin-bottom:0.4rem;display:flex;align-items:center;gap:0.4rem">
                <input type="checkbox" id="${id}" ${value ? 'checked' : ''} style="accent-color:var(--accent)">
                <label for="${id}" style="font-size:0.75rem;color:var(--text-secondary);cursor:pointer">${label}</label>
                ${help}
            </div>`;
    }
    if (type === 'select') {
        return `<div style="margin-bottom:0.5rem">
                <label style="font-size:0.72rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:0.15rem">${label}</label>
                <select id="${id}" style="width:100%;font-size:0.78rem;padding:0.3rem 0.5rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-inset);color:var(--text-primary)">
                    ${(opts.options || []).map(o => `<option value="${esc(o)}" ${o === value ? 'selected' : ''}>${esc(o)}</option>`).join('')}
                </select>${help}
            </div>`;
    }
    return `<div style="margin-bottom:0.5rem">
            <label style="font-size:0.72rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:0.15rem">${label}</label>
            <input type="${type}" id="${id}" value="${esc(value || '')}"
                ${opts.placeholder ? `placeholder="${esc(opts.placeholder)}"` : ''}
                style="width:100%;font-size:0.78rem;padding:0.3rem 0.5rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-inset);color:var(--text-primary)">
            ${help}
        </div>`;
}

function _wizApplyBtn(key) {
    return `<div style="display:flex;gap:0.4rem;margin-top:0.6rem">
            <button class="btn btn-sm btn-primary" style="font-size:0.75rem"
                onclick="_wizApplySetup('${esc(key)}', this)">âœ… Apply</button>
            <button class="btn btn-sm btn-secondary" style="font-size:0.75rem"
                onclick="_wizToggleSetup('${esc(key)}')">Cancel</button>
        </div>`;
}


// â”€â”€ Per-integration sub-wizard forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Each form is a full operational panel: status, config, actions, delete

const _wizSubForms = {

    'int:docker': (info, name, d) => {
        const sd = (d.stack_defaults || {}).docker || {};
        const stackName = (d.stack_defaults || {}).primary_stack || '';
        const stackIcon = (d.stack_defaults || {}).icon || '';
        const domain = (d.stack_defaults || {}).domain || 'service';
        const baseImage = sd.base_image || ('python:' + (d._python_version || '3.12') + '-slim');
        const installCmd = sd.install_cmd || 'pip install -e .';
        const entryCmd = sd.entry_cmd || 'python -m src';
        const defaultPort = sd.port || '8080';
        const isLibrary = domain === 'library';
        const hasDockerfile = info.has_dockerfile;
        const hasCompose = info.has_compose;
        const daemonOk = info.daemon_ok;

        // â”€â”€ Rich docker_status data (from backend docker_detect) â”€â”€
        const dockerSt = d.docker_status || {};
        const dockerVersion = (dockerSt.version || '').replace('Docker version ', '').split(',')[0];
        const composeVersion = dockerSt.compose_version || '';
        const dockerfiles = dockerSt.dockerfiles || [];
        const dockerfileDetails = dockerSt.dockerfile_details || [];
        const composeSvcDetails = dockerSt.compose_service_details || [];
        const composeWarnings = dockerSt.compose_warnings || [];
        const hasDockerignore = dockerSt.has_dockerignore || false;
        const dockerignorePatterns = dockerSt.dockerignore_patterns || [];

        // Cross-integration detection (for warning on basic gen)
        const modules = ((d.config_data || {}).modules || []);
        const hasMultipleModules = modules.filter(m => {
            const dom = (m.domain || '').toLowerCase();
            return dom !== 'library' && dom !== 'docs';
        }).length > 1;

        const _pill = (ok, label) => `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;${ok ? 'background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)' : 'background:color-mix(in srgb, var(--text-muted) 8%, transparent);color:var(--text-muted);border:1px solid color-mix(in srgb, var(--text-muted) 20%, transparent)'}">${label}</span>`;

        // â”€â”€ Header with stack badge â”€â”€
        let html = `<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem">
            <span style="font-weight:600;font-size:0.85rem">ğŸ³ Docker</span>
            ${stackName ? `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;background:color-mix(in srgb, var(--accent) 10%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 25%, transparent)">${stackIcon} ${esc(stackName)}</span>` : ''}
        </div>`;

        // â”€â”€ Enriched status strip â”€â”€
        html += `<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.5rem">
            ${_pill(daemonOk, daemonOk ? 'âœ“ daemon' + (dockerVersion ? ' Â· ' + dockerVersion : '') : 'âœ— daemon')}
            ${_pill(dockerSt.compose_available, dockerSt.compose_available ? 'âœ“ compose' + (composeVersion ? ' ' + composeVersion : '') : 'â—‹ no compose CLI')}
            ${_pill(hasDockerfile, hasDockerfile ? 'âœ“ ' + dockerfiles.length + ' Dockerfile' + (dockerfiles.length !== 1 ? 's' : '') : 'â—‹ no Dockerfile')}
            ${_pill(hasCompose, hasCompose ? 'âœ“ ' + (dockerSt.compose_file || 'compose') + ' Â· ' + (dockerSt.services_count || 0) + ' svc' + ((dockerSt.services_count || 0) !== 1 ? 's' : '') : 'â—‹ no compose file')}
            ${_pill(hasDockerignore, hasDockerignore ? 'âœ“ .dockerignore Â· ' + dockerignorePatterns.length + ' rules' : 'â—‹ no .dockerignore')}
        </div>`;

        // â”€â”€ Existing Dockerfile details â”€â”€
        if (dockerfileDetails.length > 0) {
            html += `<details style="margin-bottom:0.5rem" open>
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    ğŸ“„ Dockerfiles (${dockerfileDetails.length})
                </summary>
                <div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden">`;

            for (const df of dockerfileDetails) {
                const bases = (df.base_images || []).slice(0, 3);
                const stages = df.stages || [];
                const ports = df.ports || [];
                const warnings = df.warnings || [];
                html += `<div style="padding:0.3rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.72rem">
                    <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.15rem">
                        <code style="font-weight:600;font-size:0.7rem">${esc(df.path)}</code>
                        ${df.stage_count > 1 ? `<span style="font-size:0.6rem;color:var(--accent)">${df.stage_count}-stage</span>` : ''}
                        ${ports.length > 0 ? `<span style="font-size:0.6rem;color:var(--text-muted)">EXPOSE ${ports.join(', ')}</span>` : ''}
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:0.15rem">
                        ${bases.map(b => `<span style="font-size:0.6rem;padding:0.05rem 0.25rem;border-radius:3px;background:color-mix(in srgb, var(--accent) 8%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 15%, transparent)">${esc(b)}</span>`).join('')}
                        ${stages.map(s => `<span style="font-size:0.6rem;padding:0.05rem 0.25rem;border-radius:3px;background:color-mix(in srgb, var(--text-muted) 8%, transparent);color:var(--text-muted)">AS ${esc(s)}</span>`).join('')}
                    </div>
                    ${warnings.length > 0 ? `<div style="margin-top:0.15rem">${warnings.map(w => `<div style="font-size:0.62rem;color:var(--warning)">âš ï¸ ${esc(w)}</div>`).join('')}</div>` : ''}
                </div>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Existing compose service details â”€â”€
        if (composeSvcDetails.length > 0) {
            html += `<details style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    ğŸ“‹ Compose Services (${composeSvcDetails.length})
                </summary>
                <div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden">`;

            for (const svc of composeSvcDetails) {
                const svcPorts = (svc.ports || []).map(p => p.host + ':' + p.container).join(', ');
                const svcVols = (svc.volumes || []).length;
                const svcDeps = (svc.depends_on || []).length;
                const svcImage = svc.image || (svc.build ? '(build)' : '?');
                html += `<div style="display:flex;align-items:center;gap:0.4rem;padding:0.25rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.72rem">
                    <strong style="min-width:70px;font-size:0.7rem">${esc(svc.name)}</strong>
                    <code style="font-size:0.62rem;color:var(--text-secondary);background:var(--bg-primary);padding:1px 4px;border-radius:3px">${esc(svcImage)}</code>
                    ${svcPorts ? `<span style="font-size:0.6rem;color:var(--text-muted)">:${svcPorts}</span>` : ''}
                    <span style="flex:1"></span>
                    ${svcVols > 0 ? `<span style="font-size:0.58rem;color:var(--text-muted)">${svcVols} vol</span>` : ''}
                    ${svcDeps > 0 ? `<span style="font-size:0.58rem;color:var(--text-muted)">${svcDeps} dep</span>` : ''}
                    ${svc.restart ? `<span style="font-size:0.58rem;color:var(--text-muted)">${esc(svc.restart)}</span>` : ''}
                </div>`;
            }
            html += `</div>`;
            // Compose warnings
            if (composeWarnings.length > 0) {
                html += `<div style="margin-top:0.3rem">${composeWarnings.map(w => `<div style="font-size:0.65rem;color:var(--warning)">âš ï¸ ${esc(w)}</div>`).join('')}</div>`;
            }
            html += `</details>`;
        }

        // â”€â”€ Containers / Images live panel â”€â”€
        if (daemonOk) {
            html += `<div id="wiz-docker-live" style="margin-bottom:0.6rem">
                <div style="display:flex;gap:0.3rem;margin-bottom:0.3rem">
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizDockerLive('containers')">ğŸ“¦ Containers</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizDockerLive('images')">ğŸ–¼ Images</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizDockerLive('compose')">ğŸ“‹ Compose</button>
                </div>
                <div id="wiz-docker-live-panel" style="display:none;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.4rem 0.5rem;font-size:0.72rem;max-height:180px;overflow:auto;font-family:var(--font-mono,monospace)"></div>
            </div>`;
        }

        // â”€â”€ Operational buttons (require compose) â”€â”€
        if (hasCompose && daemonOk) {
            html += `<div style="margin-bottom:0.6rem">
                <div style="font-size:0.72rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;margin-bottom:0.25rem">Operations</div>
                <div style="display:flex;flex-wrap:wrap;gap:0.25rem">
                    <button class="btn btn-sm btn-primary" style="font-size:0.68rem;padding:0.15rem 0.45rem"
                        onclick="_wizDockerAction('up', this)">â–¶ Start</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.15rem 0.45rem"
                        onclick="_wizDockerAction('down', this)">â¹ Stop</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.15rem 0.45rem"
                        onclick="_wizDockerAction('restart', this)">ğŸ”„ Restart</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.15rem 0.45rem"
                        onclick="_wizDockerAction('build', this)">ğŸ”¨ Build</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.15rem 0.45rem"
                        onclick="_wizDockerAction('build-nc', this)">ğŸ”¨ Build (no-cache)</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.15rem 0.45rem"
                        onclick="_wizDockerAction('prune', this)">ğŸ§¹ Prune</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.15rem 0.45rem"
                        onclick="_wizDockerAction('logs', this)">ğŸ“œ Logs</button>
                </div>
                <div id="wiz-docker-action-output" style="display:none;margin-top:0.4rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.4rem 0.5rem;font-size:0.7rem;max-height:200px;overflow:auto;font-family:var(--font-mono,monospace);white-space:pre-wrap"></div>
            </div>`;
        } else if (daemonOk && !hasCompose) {
            html += `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.5rem">
                â„¹ Generate docker-compose.yml to unlock Start/Stop/Build controls.
            </div>`;
        }

        // â”€â”€ Basic config generation form (with warning like CI/CD) â”€â”€
        html += `<details style="margin-bottom:0.5rem" ${!hasDockerfile ? 'open' : ''}>
            <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ${hasDockerfile ? 'ğŸ“ Regenerate Basic Config' : 'ğŸ“ Generate Basic Config'}
            </summary>
            <div style="padding-top:0.3rem">
                ${hasDockerfile && (hasMultipleModules || composeSvcDetails.length > 1) ? `<div style="font-size:0.72rem;color:var(--warning);line-height:1.4;margin-bottom:0.5rem;padding:0.35rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--warning) 6%, transparent);border:1px solid color-mix(in srgb, var(--warning) 18%, transparent)">
                    âš ï¸ <strong>Basic generation</strong> creates a single-template Dockerfile for one service only.
                    If your project has multiple modules, infra services, environment variables from vault, or custom port/volume mappings, they will not be included.
                    Use <strong>ğŸš€ Full Docker Setup</strong> below for per-module configuration with env vars, ports, volumes, and infrastructure services.
                </div>` : ''}
                ${_wizField('wiz-docker-base', 'Base Image', baseImage, { help: 'e.g. python:3.12-slim, golang:1.22-alpine, node:20-alpine' })}
                ${_wizField('wiz-docker-workdir', 'Working Directory', sd.workdir || '/app')}
                ${_wizField('wiz-docker-install', 'Install Command', installCmd, { help: 'Run during build to install dependencies' })}
                ${isLibrary ? '' : _wizField('wiz-docker-port', 'Expose Port', defaultPort, { help: 'Port the service listens on' })}
                ${isLibrary ? '' : _wizField('wiz-docker-cmd', 'Entry Command', entryCmd, { help: 'CMD when container starts' })}
                ${_wizField('wiz-docker-compose', 'Also generate docker-compose.yml', !hasCompose, { type: 'checkbox' })}
                ${hasDockerfile ? _wizField('wiz-docker-overwrite', 'Overwrite existing Dockerfile', false, { type: 'checkbox' }) : ''}
                ${_wizApplyBtn('int:docker')}
            </div>
        </details>`;

        // â”€â”€ Full Docker Setup escalation (like CI/CD's "Compose Full Pipeline") â”€â”€
        html += `<details style="margin-bottom:0.5rem">
            <summary style="font-size:0.72rem;font-weight:600;color:var(--accent);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ğŸš€ Full Docker Setup
            </summary>
            <div style="padding-top:0.3rem">
                <div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.5;margin-bottom:0.6rem">
                    Open the full multi-step Docker wizard for <strong>comprehensive</strong> container configuration.
                    This includes per-module Dockerfiles, infrastructure services (databases, caches, queues),
                    vault-aware environment variables, port and volume mappings, health checks, and live preview with editing.
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.6rem">
                    ${_pill(modules.length > 0, modules.length > 0 ? 'âœ“ ' + modules.length + ' module' + (modules.length !== 1 ? 's' : '') + ' detected' : 'â—‹ no modules')}
                    ${_pill(hasDockerfile, hasDockerfile ? 'âœ“ Dockerfile exists' : 'â—‹ will create')}
                    ${_pill(hasCompose, hasCompose ? 'âœ“ compose exists' : 'â—‹ will create')}
                    ${_pill(hasDockerignore, hasDockerignore ? 'âœ“ .dockerignore' : 'â—‹ will create')}
                </div>
                <div style="display:flex;gap:0.4rem;margin-top:0.4rem">
                    <button class="btn btn-sm btn-primary" style="font-size:0.75rem"
                        onclick="openSetupWizard('docker')">ğŸš€ Open Full Setup</button>
                </div>
            </div>
        </details>`;

        // â”€â”€ Delete config â”€â”€
        if (hasDockerfile || hasCompose) {
            html += `<div style="border-top:1px solid var(--border-subtle);padding-top:0.5rem;margin-top:0.3rem">
                <button class="btn btn-sm" style="font-size:0.68rem;padding:0.12rem 0.4rem;color:var(--error);border:1px solid color-mix(in srgb, var(--error) 30%, transparent)"
                    onclick="_wizDeleteConfig('docker', this)">ğŸ—‘ Delete Docker Config</button>
            </div>`;
        }

        return html;
    },

    'k8s': (info, name, d) => {
        const safeName = name.replace(/[^a-z0-9-]/gi, '-').toLowerCase();
        const clusterOk = info.cluster_ok;
        const hasManifests = d.files.k8s_manifests;

        // â”€â”€ Rich K8s status data (from backend k8s_detect) â”€â”€
        const k8sSt = d.k8s_status || {};
        const kctl = k8sSt.kubectl || {};
        const helmCharts = k8sSt.helm_charts || [];
        const kustomize = k8sSt.kustomize || {};
        const resSummary = k8sSt.resource_summary || {};
        const totalRes = k8sSt.total_resources || 0;
        const manifestDirs = k8sSt.manifest_dirs || [];
        const manifests = k8sSt.manifests || [];
        const strategy = k8sSt.deployment_strategy || 'none';
        const readiness = k8sSt.deployment_readiness || 'not_configured';
        const secretSafety = k8sSt.secret_safety || {};
        const infraSvcs = k8sSt.infra_services || [];
        const toolAvail = k8sSt.tool_availability || {};
        const envs = k8sSt.environments || [];
        const missingTools = k8sSt.missing_tools || [];

        // Stack context
        const sd = (d.stack_defaults || {});
        const stackName = sd.primary_stack || '';
        const stackIcon = sd.icon || '';
        const dockerSd = sd.docker || {};
        const defaultPort = dockerSd.port || '8080';

        // Cross-integration detection
        const dockerDetected = d.integrations?.['int:docker']?.detected;
        const modules = ((d.config_data || {}).modules || []);
        const hasMultipleModules = modules.filter(m => {
            const dom = (m.domain || '').toLowerCase();
            return dom !== 'library' && dom !== 'docs';
        }).length > 1;

        const _pill = (ok, label) => `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;${ok ? 'background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)' : 'background:color-mix(in srgb, var(--text-muted) 8%, transparent);color:var(--text-muted);border:1px solid color-mix(in srgb, var(--text-muted) 20%, transparent)'}">${label}</span>`;

        // â”€â”€ Header with stack badge â”€â”€
        let html = `<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem">
            <span style="font-weight:600;font-size:0.85rem">â˜¸ï¸ Kubernetes</span>
            ${stackName ? `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;background:color-mix(in srgb, var(--accent) 10%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 25%, transparent)">${stackIcon} ${esc(stackName)}</span>` : ''}
        </div>`;

        // â”€â”€ Enriched status strip (7 pills) â”€â”€
        const kctlVer = (kctl.version || '').split(',')[0];
        html += `<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.5rem">
            ${_pill(kctl.available, kctl.available ? 'âœ“ kubectl' + (kctlVer ? ' ' + kctlVer : '') : 'âœ— no kubectl')}
            ${_pill(totalRes > 0, totalRes > 0 ? 'âœ“ ' + totalRes + ' resource' + (totalRes !== 1 ? 's' : '') : 'â—‹ no manifests')}
            ${_pill(helmCharts.length > 0, helmCharts.length > 0 ? 'âœ“ ' + helmCharts.length + ' Helm chart' + (helmCharts.length !== 1 ? 's' : '') : 'â—‹ no Helm')}
            ${_pill(kustomize.exists, kustomize.exists ? 'âœ“ Kustomize' + (kustomize.overlay_count > 0 ? ' (' + kustomize.overlay_count + ' overlay' + (kustomize.overlay_count !== 1 ? 's' : '') + ')' : '') : 'â—‹ no Kustomize')}
            ${strategy !== 'none' ? _pill(true, strategy === 'mixed' ? 'âš¡ mixed strategy' : 'âœ“ ' + strategy) : ''}
            ${_pill(readiness === 'ready', readiness === 'ready' ? 'âœ“ ready' : readiness === 'needs_config' ? 'âš  needs config' : readiness === 'needs_tools' ? 'âš  needs tools' : 'â—‹ not configured')}
            ${_pill(clusterOk, clusterOk ? 'âœ“ cluster' : 'â—‹ no cluster')}
        </div>`;

        // â”€â”€ Missing tools (installable) â”€â”€
        if (missingTools.length > 0) {
            html += `<div style="font-size:0.72rem;color:var(--warning);line-height:1.4;margin-bottom:0.5rem;padding:0.35rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--warning) 6%, transparent);border:1px solid color-mix(in srgb, var(--warning) 18%, transparent)">
                âš ï¸ Missing tools: <strong>${esc(missingTools.map(t => t.label || t.id || t).join(', '))}</strong>
            </div>`;
        }

        // â”€â”€ Manifest details (collapsible) â”€â”€
        if (manifests.length > 0) {
            html += `<details style="margin-bottom:0.5rem" open>
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    ğŸ“„ Manifests (${manifests.length} file${manifests.length !== 1 ? 's' : ''} Â· ${totalRes} resource${totalRes !== 1 ? 's' : ''})
                </summary>
                <div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden">`;

            // Resource summary chips
            const resKinds = Object.entries(resSummary).sort((a, b) => b[1] - a[1]);
            if (resKinds.length > 0) {
                html += `<div style="display:flex;flex-wrap:wrap;gap:0.15rem;padding:0.3rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent)">`;
                for (const [kind, count] of resKinds) {
                    html += `<span style="font-size:0.6rem;padding:0.05rem 0.25rem;border-radius:3px;background:color-mix(in srgb, var(--accent) 8%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 15%, transparent)">${esc(kind)}: ${count}</span>`;
                }
                html += `</div>`;
            }

            // Per-file manifest listing (max 8)
            for (const mf of manifests.slice(0, 8)) {
                const kinds = (mf.resources || []).map(r => r.kind).join(', ');
                html += `<div style="display:flex;align-items:center;gap:0.4rem;padding:0.25rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.72rem">
                    <code style="font-weight:600;font-size:0.7rem;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis">${esc(mf.path)}</code>
                    <span style="font-size:0.6rem;color:var(--text-muted);white-space:nowrap">${mf.count} Â· ${esc(kinds)}</span>
                </div>`;
            }
            if (manifests.length > 8) {
                html += `<div style="padding:0.2rem 0.5rem;font-size:0.62rem;color:var(--text-muted)">â€¦ and ${manifests.length - 8} more file(s)</div>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Helm Charts (collapsible, conditional) â”€â”€
        if (helmCharts.length > 0) {
            html += `<details style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    âˆ Helm Charts (${helmCharts.length})
                </summary>
                <div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden">`;

            for (const chart of helmCharts) {
                const envFiles = (chart.env_values_files || []).length;
                html += `<div style="padding:0.3rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.72rem">
                    <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.1rem">
                        <strong style="font-size:0.72rem">${esc(chart.name || 'unknown')}</strong>
                        ${chart.version ? `<code style="font-size:0.6rem;color:var(--text-muted)">${esc(chart.version)}</code>` : ''}
                        ${chart.type === 'library' ? `<span style="font-size:0.58rem;color:var(--text-muted)">library</span>` : ''}
                    </div>
                    <div style="display:flex;flex-wrap:wrap;gap:0.15rem">
                        ${chart.has_values ? `<span style="font-size:0.58rem;color:var(--text-muted)">values.yaml</span>` : ''}
                        ${chart.has_templates ? `<span style="font-size:0.58rem;color:var(--text-muted)">templates/</span>` : ''}
                        ${chart.has_subcharts ? `<span style="font-size:0.58rem;color:var(--text-muted)">subcharts</span>` : ''}
                        ${envFiles > 0 ? `<span style="font-size:0.58rem;color:var(--accent)">${envFiles} env values</span>` : ''}
                    </div>
                    <div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.1rem">${esc(chart.path || '')}</div>
                </div>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Kustomize (collapsible, conditional) â”€â”€
        if (kustomize.exists) {
            const overlays = kustomize.overlays || [];
            html += `<details style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    ğŸ—‚ Kustomize (${kustomize.mode || 'single'}${overlays.length > 0 ? ' Â· ' + overlays.length + ' overlay' + (overlays.length !== 1 ? 's' : '') : ''})
                </summary>
                <div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;padding:0.3rem 0.5rem;font-size:0.72rem">
                    <div style="display:flex;flex-wrap:wrap;gap:0.15rem;margin-bottom:0.2rem">
                        ${_pill(kustomize.has_bases, kustomize.has_bases ? 'âœ“ base/' : 'â—‹ no base')}
                        ${_pill(kustomize.has_patches, kustomize.has_patches ? 'âœ“ patches' : 'â—‹ no patches')}
                        ${_pill(kustomize.has_config_map_generator, kustomize.has_config_map_generator ? 'âœ“ configMapGen (' + (kustomize.config_map_generator_count || 0) + ')' : 'â—‹ no configMapGen')}
                        ${_pill(kustomize.has_image_overrides, kustomize.has_image_overrides ? 'âœ“ ' + (kustomize.image_override_count || 0) + ' image override(s)' : 'â—‹ no image overrides')}
                    </div>`;

            if (overlays.length > 0) {
                const overlayDetails = kustomize.overlay_details || [];
                html += `<div style="margin-top:0.2rem">`;
                for (const ov of overlayDetails) {
                    html += `<div style="display:flex;gap:0.4rem;padding:0.1rem 0;font-size:0.7rem">
                        <code style="font-weight:600">${esc(ov.name)}</code>
                        ${ov.patch_count > 0 ? `<span style="font-size:0.58rem;color:var(--text-muted)">${ov.patch_count} patch${ov.patch_count !== 1 ? 'es' : ''}</span>` : ''}
                    </div>`;
                }
                html += `</div>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Environments (from kustomize/helm overlays) â”€â”€
        if (envs.length > 0) {
            html += `<div style="display:flex;flex-wrap:wrap;gap:0.15rem;margin-bottom:0.5rem">`;
            for (const env of envs) {
                html += `<span style="font-size:0.6rem;padding:0.05rem 0.25rem;border-radius:3px;background:color-mix(in srgb, var(--accent) 8%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 15%, transparent)">${esc(env.name)} <span style="font-size:0.5rem;color:var(--text-muted)">(${esc(env.source || '').replace(/_/g, ' ')})</span></span>`;
            }
            html += `</div>`;
        }

        // â”€â”€ Secret safety warnings â”€â”€
        if (secretSafety.has_raw_secrets) {
            html += `<div style="font-size:0.72rem;color:var(--warning);line-height:1.4;margin-bottom:0.4rem;padding:0.3rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--warning) 6%, transparent);border:1px solid color-mix(in srgb, var(--warning) 18%, transparent)">
                âš ï¸ <strong>Raw Secret manifests detected</strong> â€” consider using <code>secretGenerator</code> or external-secrets.
            </div>`;
        }
        if (secretSafety.has_envsubst_vars && (secretSafety.envsubst_vars || []).length > 0) {
            html += `<div style="font-size:0.72rem;color:var(--warning);line-height:1.4;margin-bottom:0.4rem;padding:0.3rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--warning) 6%, transparent);border:1px solid color-mix(in srgb, var(--warning) 18%, transparent)">
                âš ï¸ envsubst variables: <code>${esc(secretSafety.envsubst_vars.slice(0, 8).join(', '))}${secretSafety.envsubst_vars.length > 8 ? 'â€¦' : ''}</code> â€” ensure these are set before apply.
            </div>`;
        }

        // â”€â”€ Infrastructure service dependencies â”€â”€
        if (infraSvcs.length > 0) {
            html += `<div style="margin-bottom:0.5rem;padding:0.3rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--accent) 4%, transparent);border:1px solid color-mix(in srgb, var(--accent) 12%, transparent)">
                <div style="font-size:0.65rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:0.15rem">ğŸ— Infra Dependencies</div>`;
            for (const svc of infraSvcs) {
                html += `<div style="font-size:0.7rem;color:var(--text-secondary);padding:0.05rem 0">
                    <strong>${esc(svc.name)}</strong>
                    <span style="font-size:0.58rem;color:var(--text-muted)">(${esc((svc.detected_via || '').replace(/_/g, ' '))})</span>
                </div>`;
            }
            html += `</div>`;
        }

        // â”€â”€ Docker dependency hint â”€â”€
        if (!dockerDetected && totalRes > 0) {
            html += `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.5rem;padding:0.3rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--text-muted) 4%, transparent);border:1px solid color-mix(in srgb, var(--text-muted) 12%, transparent)">
                â„¹ K8s deployments reference container images â€” consider setting up <strong>Docker</strong> to build them.
            </div>`;
        }

        // â”€â”€ Live cluster panel â”€â”€
        if (clusterOk) {
            html += `<div style="margin-bottom:0.6rem">
                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.3rem">
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizK8sLive('pods')">ğŸ“¦ Pods</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizK8sLive('services')">ğŸŒ Services</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizK8sLive('deployments')">ğŸš€ Deployments</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizK8sLive('validate')">âœ… Validate</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizK8sLive('cluster')">ğŸ–¥ Cluster</button>
                </div>
                <div id="wiz-k8s-live-panel" style="display:none;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.4rem 0.5rem;font-size:0.72rem;max-height:180px;overflow:auto;font-family:var(--font-mono,monospace)"></div>
            </div>`;
        }

        // â”€â”€ Config generation form (stack-aware) â”€â”€
        const hasHelm = helmCharts.length > 0;
        const hasKustomize = kustomize.exists;
        html += `<details style="margin-bottom:0.5rem" ${!hasManifests ? 'open' : ''}>
            <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ${hasManifests ? 'ğŸ“ Regenerate Manifests' : 'ğŸ“ Generate Manifests'}
            </summary>
            <div style="padding-top:0.3rem">
                ${hasManifests && (hasHelm || hasKustomize || hasMultipleModules) ? `<div style="font-size:0.72rem;color:var(--warning);line-height:1.4;margin-bottom:0.5rem;padding:0.35rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--warning) 6%, transparent);border:1px solid color-mix(in srgb, var(--warning) 18%, transparent)">
                    âš ï¸ <strong>Basic generation</strong> creates simple Deployment + Service manifests.
                    ${hasHelm ? 'Your project uses <strong>Helm charts</strong>. ' : ''}${hasKustomize ? 'Your project uses <strong>Kustomize</strong>. ' : ''}${hasMultipleModules ? 'Your project has <strong>multiple modules</strong>. ' : ''}
                    Use <strong>ğŸš€ Full K8s Setup</strong> below for comprehensive per-service configuration.
                </div>` : ''}
                ${_wizField('wiz-k8s-name', 'App Name', safeName)}
                ${_wizField('wiz-k8s-image', 'Container Image', safeName + ':latest', { help: 'Docker image to deploy' })}
                ${_wizField('wiz-k8s-port', 'Container Port', defaultPort, { help: 'Port the service listens on' })}
                ${_wizField('wiz-k8s-replicas', 'Replicas', '1')}
                ${_wizField('wiz-k8s-namespace', 'Namespace', 'default')}
                ${_wizField('wiz-k8s-service-type', 'Service Type', 'ClusterIP', { type: 'select', options: ['ClusterIP', 'NodePort', 'LoadBalancer'] })}
                ${hasManifests ? _wizField('wiz-k8s-overwrite', 'Overwrite existing manifests', false, { type: 'checkbox' }) : ''}
                ${_wizApplyBtn('k8s')}
            </div>
        </details>`;

        // â”€â”€ Full K8s Setup escalation (like Docker's) â”€â”€
        html += `<details style="margin-bottom:0.5rem">
            <summary style="font-size:0.72rem;font-weight:600;color:var(--accent);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ğŸš€ Full K8s Setup
            </summary>
            <div style="padding-top:0.3rem">
                <div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.5;margin-bottom:0.6rem">
                    Open the full multi-step Kubernetes wizard for <strong>comprehensive</strong> manifest generation.
                    This includes per-service Deployments, env vars from vault, Helm chart generation,
                    Skaffold configuration, volume and probe configuration, HPA autoscaling, and live preview with editing.
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.6rem">
                    ${_pill(totalRes > 0, totalRes > 0 ? 'âœ“ ' + totalRes + ' resource(s) detected' : 'â—‹ will create')}
                    ${_pill(kctl.available, kctl.available ? 'âœ“ kubectl' : 'â—‹ no kubectl')}
                    ${_pill(helmCharts.length > 0, helmCharts.length > 0 ? 'âœ“ ' + helmCharts.length + ' Helm chart(s)' : 'â—‹ no Helm')}
                    ${_pill(kustomize.exists, kustomize.exists ? 'âœ“ Kustomize' : 'â—‹ no Kustomize')}
                    ${_pill(dockerDetected, dockerDetected ? 'âœ“ Docker ready' : 'â—‹ no Docker')}
                </div>
                <div style="display:flex;gap:0.4rem;margin-top:0.4rem">
                    <button class="btn btn-sm btn-primary" style="font-size:0.75rem"
                        onclick="openSetupWizard('k8s')">ğŸš€ Open Full Setup</button>
                </div>
            </div>
        </details>`;

        // â”€â”€ Delete config â”€â”€
        if (hasManifests) {
            html += `<div style="border-top:1px solid var(--border-subtle);padding-top:0.5rem;margin-top:0.3rem">
                <button class="btn btn-sm" style="font-size:0.68rem;padding:0.12rem 0.4rem;color:var(--error);border:1px solid color-mix(in srgb, var(--error) 30%, transparent)"
                    onclick="_wizDeleteConfig('k8s', this)">ğŸ—‘ Delete K8s Manifests</button>
            </div>`;
        }

        return html;
    },

    'int:ci': (info, name, d) => {
        // â”€â”€ Stack-aware defaults â”€â”€
        const sd = (d.stack_defaults || {}).ci || {};
        const stackName = (d.stack_defaults || {}).primary_stack || '';
        const stackIcon = (d.stack_defaults || {}).icon || '';
        const langLabel = sd.language_label || 'Python Version';
        const langVersion = sd.language_version || d._python_version || '3.12';
        const installCmd = sd.install_cmd || 'pip install -e ".[dev]" || pip install -e .';
        const testCmd = sd.test_cmd || 'python -m pytest tests/ -v --tb=short';
        const lintCmd = sd.lint_cmd || 'ruff check src/';
        const detected = info.detected;

        // â”€â”€ CI status from embedded data â”€â”€
        const ciSt = d.ci_status || {};
        const ciProviders = ciSt.providers || [];
        const ciWorkflowCount = ciSt.total_workflows || 0;
        const ciHas = ciSt.has_ci || false;
        const ciProviderName = ciProviders.length > 0 ? ciProviders[0].name : '';

        // â”€â”€ Cross-integration detection â”€â”€
        const hasDocker = d.integrations['int:docker']?.detected || d.files.dockerfile;
        const hasK8s = d.devops_cards?.k8s?.detected || d.files.k8s_manifests;
        const hasTerraform = d.devops_cards?.terraform?.detected || d.files.terraform;
        const hasGit = d.integrations['int:git']?.detected || false;
        const hasGitHub = d.integrations['int:github']?.detected || false;
        const hasPages = d.integrations['int:pages']?.detected || false;
        const envs = (_wizardConfig?.environments || []);
        const projectName = (_wizardConfig?.name || name || 'app');

        // â”€â”€ GitHub context from embedded data â”€â”€
        const ghCli = d.gh_cli_status || {};
        const ghUser = d.gh_user || {};
        const ghRepo = d.gh_repo_info || {};
        const ghEnvs = d.gh_environments || {};
        const ghEnvList = ghEnvs.environments || [];
        const ghAuthenticated = ghCli.authenticated || false;

        // â”€â”€ Environment / secrets context â”€â”€
        const envSt = d.env_status || {};
        const envFileCount = (envSt.files || []).filter(f => f.exists).length;
        const envVarCount = envSt.total_vars || 0;

        // â”€â”€ Detected stacks â”€â”€
        const stacks = d.detected_stacks || [];

        // â”€â”€ Header with stack badge â”€â”€
        let html = `<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem">
            <span style="font-weight:600;font-size:0.85rem">ğŸ”„ CI/CD</span>
            ${ciProviderName ? `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;background:color-mix(in srgb, var(--text-muted) 8%, transparent);color:var(--text-secondary);border:1px solid color-mix(in srgb, var(--text-muted) 20%, transparent)">${esc(ciProviderName)}</span>` : ''}
            ${stackName ? `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;background:color-mix(in srgb, var(--accent) 10%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 25%, transparent)">${stackIcon} ${esc(stackName)}</span>` : ''}
        </div>`;

        // â”€â”€ Status strip â€” enriched with ci_status â”€â”€
        html += `<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.5rem">
            <span style="font-size:0.65rem;padding:0.1rem 0.35rem;border-radius:4px;${ciHas ? 'background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)' : 'background:color-mix(in srgb, var(--text-muted) 10%, transparent);color:var(--text-muted);border:1px solid color-mix(in srgb, var(--text-muted) 25%, transparent)'}">
                ${ciHas ? 'âœ“ ' + ciWorkflowCount + ' workflow' + (ciWorkflowCount !== 1 ? 's' : '') : 'â—‹ no workflows'}
            </span>
            <span style="font-size:0.65rem;padding:0.1rem 0.35rem;border-radius:4px;${ghAuthenticated ? 'background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)' : 'background:color-mix(in srgb, var(--warning) 10%, transparent);color:var(--warning);border:1px solid color-mix(in srgb, var(--warning) 25%, transparent)'}">
                ${ghAuthenticated ? 'âœ“ gh auth' + (ghUser.login ? ' Â· ' + esc(ghUser.login) : '') : 'âš  gh not auth'}
            </span>
            ${ghRepo.slug ? `<span style="font-size:0.65rem;padding:0.1rem 0.35rem;border-radius:4px;background:color-mix(in srgb, var(--accent) 8%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 20%, transparent)">${esc(ghRepo.slug)}</span>` : ''}
        </div>`;

        // â”€â”€ Pipeline Connections â€” integration surface dashboard â”€â”€
        const _pill = (ok, label) => `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;${ok ? 'background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)' : 'background:color-mix(in srgb, var(--text-muted) 8%, transparent);color:var(--text-muted);border:1px solid color-mix(in srgb, var(--text-muted) 20%, transparent)'}">${label}</span>`;
        const _connRow = (icon, label, pills, role) => `<div style="display:grid;grid-template-columns:1.4fr 2.5fr 2fr;gap:0.3rem;align-items:center;padding:0.2rem 0;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent)">
            <span style="font-size:0.68rem;font-weight:600;color:var(--text-secondary)">${icon} ${label}</span>
            <div style="display:flex;flex-wrap:wrap;gap:0.15rem">${pills}</div>
            <span style="font-size:0.62rem;color:var(--text-muted);font-style:italic">${role}</span>
        </div>`;

        html += `<details style="margin-bottom:0.5rem" open>
            <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ğŸ”Œ Pipeline Connections
            </summary>
            <div style="padding:0.3rem 0.2rem;background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;padding:0.3rem 0.5rem">
                ${_connRow('ğŸ”€', 'Git',
                    _pill(hasGit, hasGit ? 'âœ“ repo' : 'â—‹ no git'),
                    'Trigger events Â· branch filter'
                )}
                ${_connRow('ğŸ™', 'GitHub',
                    _pill(ghAuthenticated, ghAuthenticated ? 'âœ“ auth' : 'â—‹ no auth')
                    + (ghEnvList.length > 0 ? ' ' + _pill(true, ghEnvList.length + ' env' + (ghEnvList.length !== 1 ? 's' : '')) : '')
                    + (ghRepo.is_private ? ' ' + _pill(true, 'private') : (ghRepo.available ? ' ' + _pill(true, 'public') : '')),
                    'Actions platform Â· secrets Â· envs'
                )}
                ${_connRow('ğŸ“¦', 'Stacks',
                    stacks.length > 0
                        ? stacks.slice(0, 3).map(s => _pill(true, esc(s))).join(' ') + (stacks.length > 3 ? ' ' + _pill(true, '+' + (stacks.length - 3)) : '')
                        : _pill(false, 'â—‹ none'),
                    'Test Â· lint Â· build commands'
                )}
                ${_connRow('ğŸ³', 'Docker',
                    _pill(hasDocker, hasDocker ? 'âœ“ detected' : 'â—‹ not found'),
                    'Image build Â· registry push'
                )}
                ${_connRow('â˜¸ï¸', 'Kubernetes',
                    _pill(hasK8s, hasK8s ? 'âœ“ detected' : 'â—‹ not found'),
                    'Deploy Â· manifests Â· namespaces'
                )}
                ${_connRow('ğŸ—ï¸', 'Terraform',
                    _pill(hasTerraform, hasTerraform ? 'âœ“ detected' : 'â—‹ not found'),
                    'Infra provisioning step'
                )}
                ${_connRow('âš™ï¸', 'Environments',
                    _pill(envs.length > 0, envs.length > 0 ? 'âœ“ ' + envs.length + ' env' + (envs.length !== 1 ? 's' : '') : 'â—‹ single')
                    + (envFileCount > 0 ? ' ' + _pill(true, envVarCount + ' vars') : ''),
                    'Multi-env deploy Â· approvals'
                )}
                ${_connRow('ğŸ“„', 'Pages',
                    _pill(hasPages, hasPages ? 'âœ“ detected' : 'â—‹ not found'),
                    'Site build Â· deploy step'
                )}
            </div>
        </details>`;

        // â”€â”€ Basic config generation form â€” stack-aware â”€â”€
        const _hasConnectedIntegrations = hasDocker || hasK8s || hasTerraform || hasPages || envs.length > 1;
        html += `<details style="margin-bottom:0.5rem" ${!detected ? 'open' : ''}>
            <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ${detected ? 'ğŸ“ Regenerate Basic Workflow' : 'ğŸ“ Generate Basic Workflow'}
            </summary>
            <div style="padding-top:0.3rem">
                ${detected && _hasConnectedIntegrations ? `<div style="font-size:0.72rem;color:var(--warning);line-height:1.4;margin-bottom:0.5rem;padding:0.35rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--warning) 6%, transparent);border:1px solid color-mix(in srgb, var(--warning) 18%, transparent)">
                    âš ï¸ <strong>Basic workflow</strong> generates a single test + lint job only.
                    If your current workflow includes Docker build, K8s deploy, or other integration steps, they will be lost.
                    Use <strong>ğŸš€ Compose Full Pipeline</strong> below to preserve connected integrations.
                </div>` : ''}
                ${_wizField('wiz-ci-branches', 'Trigger Branches', 'main, master', { help: 'Comma-separated' })}
                ${_wizField('wiz-ci-langver', langLabel, langVersion, { help: 'Version for CI matrix' })}
                ${_wizField('wiz-ci-install', 'Install Command', installCmd, { help: 'Install dependencies' })}
                ${_wizField('wiz-ci-test', 'Test Command', testCmd, { help: 'Run test suite' })}
                ${_wizField('wiz-ci-lint', 'Also run linting', true, { type: 'checkbox' })}
                ${_wizField('wiz-ci-lint-cmd', 'Lint Command', lintCmd)}
                ${detected ? _wizField('wiz-ci-overwrite', 'Overwrite existing workflow', false, { type: 'checkbox' }) : ''}
                ${_wizApplyBtn('int:ci')}
            </div>
        </details>`;

        // â”€â”€ Compose Full CI/CD Pipeline â€” cross-integration aware â”€â”€
        html += `<details style="margin-bottom:0.5rem">
            <summary style="font-size:0.72rem;font-weight:600;color:var(--accent);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ğŸš€ Compose Full CI/CD Pipeline
            </summary>
            <div style="padding-top:0.3rem">
                <div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.5;margin-bottom:0.6rem">
                    Generate a complete CI/CD pipeline based on <strong>all</strong> your detected integrations and project state.
                    This considers every connection shown above â€” Docker, K8s, Terraform, environments â€” and combines them
                    into coordinated GitHub Actions workflow(s).
                </div>

                <div style="font-size:0.72rem;color:var(--text-muted);font-weight:600;text-transform:uppercase;margin-bottom:0.3rem">
                    Pipeline Jobs (from connections)
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.6rem">
                    ${_pill(stacks.length > 0, stacks.length > 0 ? 'âœ“ Test (' + esc(stacks[0]) + ')' : 'â—‹ Test')}
                    ${_pill(stacks.length > 0, stacks.length > 0 ? 'âœ“ Lint' : 'â—‹ Lint')}
                    ${_pill(hasDocker, hasDocker ? 'âœ“ Docker Build' : 'â—‹ Docker Build')}
                    ${_pill(hasK8s, hasK8s ? 'âœ“ K8s Deploy' : 'â—‹ K8s Deploy')}
                    ${_pill(hasTerraform, hasTerraform ? 'âœ“ Terraform' : 'â—‹ Terraform')}
                    ${_pill(envs.length > 1, envs.length > 1 ? 'âœ“ Multi-env' : 'â—‹ Single env')}
                    ${_pill(hasPages, hasPages ? 'âœ“ Pages Deploy' : 'â—‹ Pages')}
                </div>

                ${_wizField('wiz-ci-compose-strategy', 'Workflow Strategy', 'unified', {
                    type: 'select', options: ['unified', 'split'],
                    help: 'Unified: single ci-cd.yml. Split: separate files linked with workflow_run.'
                })}

                ${hasK8s ? _wizField('wiz-ci-compose-deploy', 'Deploy Method', 'kubectl', {
                    type: 'select', options: ['kubectl', 'helm', 'skaffold'],
                    help: 'How to deploy to K8s.'
                }) : ''}

                ${hasDocker ? _wizField('wiz-ci-compose-registry', 'Docker Registry', 'ghcr.io', {
                    help: 'Registry for pushing built images (e.g. ghcr.io/org, docker.io/org).'
                }) : ''}

                <div style="display:flex;gap:0.4rem;margin-top:0.6rem">
                    <button class="btn btn-sm btn-primary" style="font-size:0.75rem"
                        onclick="_wizComposeCi(this)">ğŸš€ Generate Pipeline</button>
                </div>

                <div id="wiz-ci-compose-output" style="display:none;margin-top:0.6rem"></div>
            </div>
        </details>`;

        // â”€â”€ Delete config â”€â”€
        if (detected) {
            html += `<div style="border-top:1px solid var(--border-subtle);padding-top:0.5rem;margin-top:0.3rem">
                <button class="btn btn-sm" style="font-size:0.68rem;padding:0.12rem 0.4rem;color:var(--error);border:1px solid color-mix(in srgb, var(--error) 30%, transparent)"
                    onclick="_wizDeleteConfig('ci', this)">ğŸ—‘ Delete Workflow</button>
            </div>`;
        }

        return html;
    },

    'terraform': (info, name, d) => {
        const safeName = name.replace(/[^a-z0-9-]/gi, '-').toLowerCase();
        const detected = info.detected;
        const hasTerraform = !((info.tools_needed || []).includes('terraform'));

        // â”€â”€ Rich Terraform status data (from backend terraform_status) â”€â”€
        const tfSt = d.terraform_status || {};
        const cli = tfSt.cli || {};
        const tfFiles = tfSt.files || [];
        const providers = tfSt.providers || [];
        const modules = tfSt.modules || [];
        const resources = tfSt.resources || [];
        const resCount = tfSt.resource_count || 0;
        const backend = tfSt.backend || null;
        const initialized = tfSt.initialized || false;
        const tfRoot = tfSt.root || null;
        const missingTools = tfSt.missing_tools || [];

        // Stack context
        const sd = (d.stack_defaults || {});
        const stackName = sd.primary_stack || '';
        const stackIcon = sd.icon || '';

        // Cross-integration detection
        const k8sDetected = d.devops_cards?.k8s?.detected;

        const _pill = (ok, label) => `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;${ok ? 'background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)' : 'background:color-mix(in srgb, var(--text-muted) 8%, transparent);color:var(--text-muted);border:1px solid color-mix(in srgb, var(--text-muted) 20%, transparent)'}">${label}</span>`;

        // â”€â”€ Header with stack badge â”€â”€
        let html = `<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem">
            <span style="font-weight:600;font-size:0.85rem">ğŸ—ï¸ Terraform</span>
            ${stackName ? `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;background:color-mix(in srgb, var(--accent) 10%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 25%, transparent)">${stackIcon} ${esc(stackName)}</span>` : ''}
        </div>`;

        // â”€â”€ Enriched status strip (7 pills) â”€â”€
        const cliVer = (cli.version || '').split('\n')[0];
        html += `<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.5rem">
            ${_pill(cli.available, cli.available ? 'âœ“ terraform' + (cliVer ? ' ' + cliVer : '') : 'âœ— no terraform')}
            ${_pill(resCount > 0, resCount > 0 ? 'âœ“ ' + resCount + ' resource' + (resCount !== 1 ? 's' : '') : 'â—‹ no resources')}
            ${_pill(providers.length > 0, providers.length > 0 ? 'âœ“ ' + providers.length + ' provider' + (providers.length !== 1 ? 's' : '') : 'â—‹ no providers')}
            ${_pill(modules.length > 0, modules.length > 0 ? 'âœ“ ' + modules.length + ' module' + (modules.length !== 1 ? 's' : '') : 'â—‹ no modules')}
            ${_pill(backend != null, backend ? 'âœ“ ' + backend.type + ' backend' : 'â—‹ no backend')}
            ${_pill(initialized, initialized ? 'âœ“ initialized' : 'â—‹ not initialized')}
            ${_pill(detected, detected ? 'âœ“ config found' : 'â—‹ no config')}
        </div>`;

        // â”€â”€ Missing tools banner â”€â”€
        if (missingTools.length > 0) {
            html += `<div style="font-size:0.72rem;color:var(--warning);line-height:1.4;margin-bottom:0.5rem;padding:0.35rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--warning) 6%, transparent);border:1px solid color-mix(in srgb, var(--warning) 18%, transparent)">
                âš ï¸ Missing tools: <strong>${esc(missingTools.map(t => t.label || t.id || t).join(', '))}</strong>
            </div>`;
        }

        // â”€â”€ TF file details (collapsible) â”€â”€
        if (tfFiles.length > 0) {
            // Group by type
            const typeMap = {};
            for (const f of tfFiles) {
                const t = f.type || 'other';
                typeMap[t] = (typeMap[t] || 0) + 1;
            }

            html += `<details style="margin-bottom:0.5rem" open>
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    ğŸ“„ Files (${tfFiles.length} .tf file${tfFiles.length !== 1 ? 's' : ''}${tfRoot ? ' in ' + esc(tfRoot) : ''})
                </summary>
                <div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden">`;

            // Type chips
            const typeEntries = Object.entries(typeMap).sort((a, b) => b[1] - a[1]);
            if (typeEntries.length > 0) {
                html += `<div style="display:flex;flex-wrap:wrap;gap:0.15rem;padding:0.3rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent)">`;
                for (const [type, count] of typeEntries) {
                    html += `<span style="font-size:0.6rem;padding:0.05rem 0.25rem;border-radius:3px;background:color-mix(in srgb, var(--accent) 8%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 15%, transparent)">${esc(type)}: ${count}</span>`;
                }
                html += `</div>`;
            }

            // Per-file listing (max 10)
            for (const f of tfFiles.slice(0, 10)) {
                html += `<div style="display:flex;align-items:center;gap:0.4rem;padding:0.25rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.72rem">
                    <code style="font-weight:600;font-size:0.7rem;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis">${esc(f.path)}</code>
                    <span style="font-size:0.6rem;color:var(--text-muted);white-space:nowrap">${esc(f.type || '')}</span>
                </div>`;
            }
            if (tfFiles.length > 10) {
                html += `<div style="padding:0.2rem 0.5rem;font-size:0.62rem;color:var(--text-muted)">â€¦ and ${tfFiles.length - 10} more file(s)</div>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Providers (collapsible, conditional) â”€â”€
        if (providers.length > 0) {
            html += `<details style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    â˜ Providers (${providers.length})
                </summary>
                <div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden">`;

            for (const prov of providers) {
                const provName = typeof prov === 'string' ? prov : (prov.name || prov);
                html += `<div style="padding:0.25rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.72rem">
                    <code style="font-weight:600">${esc(provName)}</code>
                </div>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Modules (collapsible, conditional) â”€â”€
        if (modules.length > 0) {
            html += `<details style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    ğŸ“¦ Modules (${modules.length})
                </summary>
                <div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden">`;

            for (const mod of modules) {
                html += `<div style="padding:0.25rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.72rem">
                    <div style="display:flex;align-items:center;gap:0.4rem">
                        <strong style="font-size:0.72rem">${esc(mod.name || 'unnamed')}</strong>
                        <code style="font-size:0.6rem;color:var(--text-muted)">${esc(mod.source || '')}</code>
                    </div>
                </div>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Resources summary (collapsible, condensed) â”€â”€
        if (resources.length > 0) {
            // Group by type
            const resTypeMap = {};
            for (const r of resources) {
                const t = r.type || 'unknown';
                resTypeMap[t] = (resTypeMap[t] || 0) + 1;
            }

            html += `<details style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    ğŸ“¦ Resources (${resCount})
                </summary>
                <div style="display:flex;flex-wrap:wrap;gap:0.15rem;padding:0.3rem 0">`;

            for (const [type, count] of Object.entries(resTypeMap).sort((a, b) => b[1] - a[1])) {
                html += `<span style="font-size:0.6rem;padding:0.05rem 0.25rem;border-radius:3px;background:color-mix(in srgb, var(--accent) 8%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 15%, transparent)">${esc(type)}: ${count}</span>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Backend info â”€â”€
        if (backend) {
            html += `<div style="margin-bottom:0.5rem;padding:0.3rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--accent) 4%, transparent);border:1px solid color-mix(in srgb, var(--accent) 12%, transparent)">
                <div style="font-size:0.65rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;margin-bottom:0.1rem">ğŸ’¾ State Backend</div>
                <div style="font-size:0.72rem;color:var(--text-secondary)">
                    <strong>${esc(backend.type)}</strong>
                    ${backend.file ? `<span style="font-size:0.6rem;color:var(--text-muted)"> in ${esc(backend.file)}</span>` : ''}
                </div>
            </div>`;
        }

        // â”€â”€ K8s cross-integration hint â”€â”€
        if (k8sDetected && resCount > 0) {
            const hasK8sRes = resources.some(r => (r.type || '').includes('kubernetes') || (r.type || '').includes('k8s'));
            if (hasK8sRes) {
                html += `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.5rem;padding:0.3rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--text-muted) 4%, transparent);border:1px solid color-mix(in srgb, var(--text-muted) 12%, transparent)">
                    â„¹ Terraform provisions K8s resources â€” your <strong>Kubernetes</strong> integration can manage the deployed workloads.
                </div>`;
            }
        }

        // â”€â”€ Live panel (state, workspaces, validate, plan) â”€â”€
        if (detected && cli.available) {
            html += `<div style="margin-bottom:0.6rem">
                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.3rem">
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizTfLive('state')">ğŸ“‹ State</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizTfLive('workspaces')">ğŸ—ƒï¸ Workspaces</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizTfLive('validate')">âœ… Validate</button>
                    <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                        onclick="_wizTfLive('outputs')">ğŸ“§ Outputs</button>
                </div>
                <div id="wiz-tf-live-panel" style="display:none;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.4rem 0.5rem;font-size:0.72rem;max-height:180px;overflow:auto;font-family:var(--font-mono,monospace)"></div>
            </div>`;
        }

        // â”€â”€ Config generation form â”€â”€
        html += `<details style="margin-bottom:0.5rem" ${!detected ? 'open' : ''}>
            <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ${detected ? 'ğŸ“ Regenerate Config' : 'ğŸ“ Generate Config'}
            </summary>
            <div style="padding-top:0.3rem">
                ${detected && (modules.length > 0 || providers.length > 1) ? `<div style="font-size:0.72rem;color:var(--warning);line-height:1.4;margin-bottom:0.5rem;padding:0.35rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--warning) 6%, transparent);border:1px solid color-mix(in srgb, var(--warning) 18%, transparent)">
                    âš ï¸ <strong>Basic generation</strong> creates starter main.tf + variables.tf + outputs.tf.
                    ${modules.length > 0 ? 'Your project uses <strong>' + modules.length + ' module(s)</strong>. ' : ''}${providers.length > 1 ? 'Your project uses <strong>multiple providers</strong>. ' : ''}
                    Use <strong>ğŸš€ Full Terraform Setup</strong> below for comprehensive resource and environment configuration.
                </div>` : ''}
                ${_wizField('wiz-tf-provider', 'Provider', providers.length > 0 ? providers[0].split('/').pop() : 'aws', { type: 'select', options: ['aws', 'google', 'azurerm', 'digitalocean', 'other'] })}
                ${_wizField('wiz-tf-region', 'Region', 'us-east-1')}
                ${_wizField('wiz-tf-project', 'Project Name', safeName)}
                ${_wizField('wiz-tf-backend', 'State Backend', backend ? backend.type : 'local', { type: 'select', options: ['local', 's3', 'gcs', 'azurerm'] })}
                ${detected ? _wizField('wiz-tf-overwrite', 'Overwrite existing config', false, { type: 'checkbox' }) : ''}
                ${_wizApplyBtn('terraform')}
            </div>
        </details>`;

        // â”€â”€ Full Terraform Setup escalation â”€â”€
        html += `<details style="margin-bottom:0.5rem">
            <summary style="font-size:0.72rem;font-weight:600;color:var(--accent);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ğŸš€ Full Terraform Setup
            </summary>
            <div style="padding-top:0.3rem">
                <div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.5;margin-bottom:0.6rem">
                    Open the full multi-step Terraform wizard for <strong>comprehensive</strong> IaC configuration.
                    This includes provider selection, backend configuration, resource definitions,
                    environment management, variable files, and live preview with HCL editing.
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.6rem">
                    ${_pill(cli.available, cli.available ? 'âœ“ terraform' : 'â—‹ no terraform')}
                    ${_pill(resCount > 0, resCount > 0 ? 'âœ“ ' + resCount + ' resource(s)' : 'â—‹ will create')}
                    ${_pill(providers.length > 0, providers.length > 0 ? 'âœ“ ' + providers.map(p => typeof p === 'string' ? p.split('/').pop() : p).join(', ') : 'â—‹ no providers')}
                    ${_pill(initialized, initialized ? 'âœ“ initialized' : 'â—‹ not initialized')}
                    ${_pill(backend != null, backend ? 'âœ“ ' + backend.type : 'â—‹ no backend')}
                </div>
                <div style="display:flex;gap:0.4rem;margin-top:0.4rem">
                    <button class="btn btn-sm btn-primary" style="font-size:0.75rem"
                        onclick="openSetupWizard('terraform')">ğŸš€ Open Full Setup</button>
                </div>
            </div>
        </details>`;

        // â”€â”€ Delete config â”€â”€
        if (detected) {
            html += `<div style="border-top:1px solid var(--border-subtle);padding-top:0.5rem;margin-top:0.3rem">
                <button class="btn btn-sm" style="font-size:0.68rem;padding:0.12rem 0.4rem;color:var(--error);border:1px solid color-mix(in srgb, var(--error) 30%, transparent)"
                    onclick="_wizDeleteConfig('terraform', this)">ğŸ—‘ Delete Terraform Config</button>
            </div>`;
        }

        return html;
    },

    'dns': (info, name, d) => {
        const safeName = name.replace(/[^a-z0-9-]/gi, '-').toLowerCase();
        const detected = info.detected;

        // â”€â”€ Rich DNS/CDN status data (from backend dns_cdn_status) â”€â”€
        const dnsSt = d.dns_status || {};
        const cdnProviders = dnsSt.cdn_providers || [];
        const domains = dnsSt.domains || [];
        const dnsFiles = dnsSt.dns_files || [];
        const sslCerts = dnsSt.ssl_certs || [];
        const hasCdn = dnsSt.has_cdn || false;
        const hasDns = dnsSt.has_dns || false;
        const missingTools = dnsSt.missing_tools || [];

        // Stack & cross-integration context
        const sd = (d.stack_defaults || {});
        const stackName = sd.primary_stack || '';
        const stackIcon = sd.icon || '';
        const tfDetected = d.devops_cards?.terraform?.detected;
        const pagesDetected = d.integrations?.['int:pages']?.detected;
        const hasCname = info.has_cname;

        const _pill = (ok, label) => `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;${ok ? 'background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)' : 'background:color-mix(in srgb, var(--text-muted) 8%, transparent);color:var(--text-muted);border:1px solid color-mix(in srgb, var(--text-muted) 20%, transparent)'}">${label}</span>`;

        // â”€â”€ Header with stack badge â”€â”€
        let html = `<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem">
            <span style="font-weight:600;font-size:0.85rem">\ud83c\udf10 DNS & CDN</span>
            ${stackName ? `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;background:color-mix(in srgb, var(--accent) 10%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 25%, transparent)">${stackIcon} ${esc(stackName)}</span>` : ''}
        </div>`;

        // â”€â”€ Status strip (6 pills) â”€â”€
        html += `<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.5rem">
            ${_pill(hasDns, hasDns ? '\u2713 DNS configured' : '\u25cb no DNS')}
            ${_pill(hasCdn, hasCdn ? '\u2713 CDN detected' : '\u25cb no CDN')}
            ${_pill(domains.length > 0, domains.length > 0 ? '\u2713 ' + domains.length + ' domain' + (domains.length !== 1 ? 's' : '') : '\u25cb no domains')}
            ${_pill(dnsFiles.length > 0, dnsFiles.length > 0 ? '\u2713 ' + dnsFiles.length + ' file' + (dnsFiles.length !== 1 ? 's' : '') : '\u25cb no files')}
            ${_pill(sslCerts.length > 0, sslCerts.length > 0 ? '\u2713 ' + sslCerts.length + ' cert' + (sslCerts.length !== 1 ? 's' : '') : '\u25cb no certs')}
            ${_pill(detected, detected ? '\u2713 config found' : '\u25cb no config')}
        </div>`;

        // â”€â”€ Missing tools banner â”€â”€
        if (missingTools.length > 0) {
            html += `<div style="font-size:0.72rem;color:var(--warning);line-height:1.4;margin-bottom:0.5rem;padding:0.35rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--warning) 6%, transparent);border:1px solid color-mix(in srgb, var(--warning) 18%, transparent)">
                \u26a0\ufe0f Missing tools: <strong>${esc(missingTools.map(t => t.label || t.id || t).join(', '))}</strong>
                <span style="font-size:0.62rem;color:var(--text-muted)">(DNS lookup and SSL checks need dig/openssl)</span>
            </div>`;
        }

        // â”€â”€ CDN Providers (collapsible, conditional) â”€â”€
        if (cdnProviders.length > 0) {
            html += `<details style="margin-bottom:0.5rem" open>
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    \u26a1 CDN Providers (${cdnProviders.length})
                </summary>
                <div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden">`;

            for (const prov of cdnProviders) {
                const detBy = (prov.detected_by || []).join(', ');
                html += `<div style="display:flex;align-items:center;gap:0.4rem;padding:0.25rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.72rem">
                    <strong style="flex:1">${esc(prov.name || prov.id || 'unknown')}</strong>
                    ${prov.cli_available ? `<span style="font-size:0.6rem;color:var(--success)">\u2713 ${esc(prov.cli || 'CLI')}</span>` : ''}
                    <span style="font-size:0.6rem;color:var(--text-muted)">${esc(detBy)}</span>
                </div>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Domains (collapsible, conditional) â”€â”€
        if (domains.length > 0) {
            html += `<details style="margin-bottom:0.5rem" open>
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    \ud83c\udf10 Domains (${domains.length})
                </summary>
                <div style="display:flex;flex-wrap:wrap;gap:0.15rem;padding:0.3rem 0">`;

            for (const dom of domains) {
                html += `<span style="font-size:0.65rem;padding:0.08rem 0.35rem;border-radius:4px;background:color-mix(in srgb, var(--accent) 8%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 15%, transparent)"><code>${esc(dom)}</code></span>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ DNS Files (collapsible, conditional) â”€â”€
        if (dnsFiles.length > 0) {
            html += `<details style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    \ud83d\udcc4 DNS Files (${dnsFiles.length})
                </summary>
                <div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden">`;

            for (const f of dnsFiles) {
                html += `<div style="padding:0.25rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.72rem">
                    <code style="font-weight:600;font-size:0.7rem">${esc(f)}</code>
                </div>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ SSL Certificates (collapsible, conditional) â”€â”€
        if (sslCerts.length > 0) {
            html += `<details style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    \ud83d\udd12 SSL Certificates (${sslCerts.length})
                </summary>
                <div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden">`;

            for (const cert of sslCerts) {
                const icon = cert.type === 'private_key' ? '\ud83d\udd11' : '\ud83d\udcc4';
                html += `<div style="display:flex;align-items:center;gap:0.4rem;padding:0.25rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.72rem">
                    <span>${icon}</span>
                    <code style="font-weight:600;font-size:0.7rem;flex:1">${esc(cert.path)}</code>
                    <span style="font-size:0.6rem;color:var(--text-muted)">${esc(cert.type)}</span>
                </div>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Cross-integration hints â”€â”€
        if (tfDetected) {
            html += `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.5rem;padding:0.3rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--text-muted) 4%, transparent);border:1px solid color-mix(in srgb, var(--text-muted) 12%, transparent)">
                \u2139 <strong>Terraform</strong> detected \u2014 DNS records can be managed as Terraform resources via the Full Setup wizard.
            </div>`;
        }
        if (pagesDetected && hasCname) {
            html += `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.5rem;padding:0.3rem 0.5rem;border-radius:6px;background:color-mix(in srgb, var(--text-muted) 4%, transparent);border:1px solid color-mix(in srgb, var(--text-muted) 12%, transparent)">
                \u2139 <strong>GitHub Pages</strong> CNAME detected \u2014 domain is configured for Pages hosting.
            </div>`;
        }

        // â”€â”€ Live panel (DNS lookup, SSL check) â”€â”€
        html += `<div style="margin-bottom:0.6rem">
            <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.3rem">
                <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                    onclick="_wizDnsLive('lookup')">\ud83d\udd0d DNS Lookup</button>
                <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem"
                    onclick="_wizDnsLive('ssl')">\ud83d\udd12 SSL Check</button>
            </div>
            <div id="wiz-dns-live-panel" style="display:none;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.4rem 0.5rem;font-size:0.72rem;max-height:220px;overflow:auto"></div>
        </div>`;

        // â”€â”€ Config generation form â”€â”€
        const defaultDomain = domains.length > 0 ? domains[0] : 'example.com';
        html += `<details style="margin-bottom:0.5rem" ${!detected ? 'open' : ''}>
            <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ${detected ? '\ud83d\udcdd Regenerate Config' : '\ud83d\udcdd Generate DNS Config'}
            </summary>
            <div style="padding-top:0.3rem">
                ${_wizField('wiz-dns-domain', 'Domain', defaultDomain, { help: 'Primary domain (e.g. example.com)' })}
                ${_wizField('wiz-dns-mail', 'Mail Provider', 'none', { type: 'select', options: ['none', 'google', 'protonmail', 'fastmail', 'zoho'] })}
                ${_wizField('wiz-dns-spf', 'Include SPF record', true, { type: 'checkbox' })}
                ${_wizField('wiz-dns-dmarc', 'Include DMARC record', true, { type: 'checkbox' })}
                ${detected ? _wizField('wiz-dns-overwrite', 'Overwrite existing config', false, { type: 'checkbox' }) : ''}
                ${_wizApplyBtn('dns')}
            </div>
        </details>`;

        // â”€â”€ Full DNS Setup escalation â”€â”€
        html += `<details style="margin-bottom:0.5rem">
            <summary style="font-size:0.72rem;font-weight:600;color:var(--accent);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                \ud83d\ude80 Full DNS & CDN Setup
            </summary>
            <div style="padding-top:0.3rem">
                <div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.5;margin-bottom:0.6rem">
                    Open the full multi-step DNS & CDN wizard for <strong>comprehensive</strong> configuration.
                    This includes domain management, CDN provider selection, SSL certificates,
                    traffic routing, K8s ingress, proxy configs, and Terraform DNS resource generation.
                </div>
                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.6rem">
                    ${_pill(hasDns, hasDns ? '\u2713 DNS configured' : '\u25cb will create')}
                    ${_pill(hasCdn, hasCdn ? '\u2713 CDN: ' + cdnProviders.map(p => p.name).join(', ') : '\u25cb no CDN')}
                    ${_pill(domains.length > 0, domains.length > 0 ? '\u2713 ' + domains.length + ' domain(s)' : '\u25cb no domains')}
                    ${_pill(sslCerts.length > 0, sslCerts.length > 0 ? '\u2713 SSL certs' : '\u25cb no certs')}
                </div>
                <div style="display:flex;gap:0.4rem;margin-top:0.4rem">
                    <button class="btn btn-sm btn-primary" style="font-size:0.75rem"
                        onclick="openSetupWizard('dns')">\ud83d\ude80 Open Full Setup</button>
                </div>
            </div>
        </details>`;

        // â”€â”€ Delete config â”€â”€
        if (detected) {
            html += `<div style="border-top:1px solid var(--border-subtle);padding-top:0.5rem;margin-top:0.3rem">
                <button class="btn btn-sm" style="font-size:0.68rem;padding:0.12rem 0.4rem;color:var(--error);border:1px solid color-mix(in srgb, var(--error) 30%, transparent)"
                    onclick="_wizDeleteConfig('dns', this)">\ud83d\uddd1 Delete DNS Config</button>
            </div>`;
        }

        return html;
    },

    'int:git': (info, safeName, d) => {
        // â”€â”€ Pull all embedded data â”€â”€
        const probes = d.status_probes || {};
        const git = probes.git || {};
        const giAnalysis = d.gitignore_analysis || {};
        const gitRemotesData = d.git_remotes || {};
        const remotes = gitRemotesData.remotes || [];
        const ghCli = d.gh_cli_status || {};
        const sd = d.stack_defaults || {};
        const caps = sd.capabilities || {};

        const _pill = (ok, label) => `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;${ok ? 'background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)' : 'background:color-mix(in srgb, var(--text-muted) 8%, transparent);color:var(--text-muted);border:1px solid color-mix(in srgb, var(--text-muted) 20%, transparent)'}">${label}</span>`;

        // â”€â”€ Header â”€â”€
        let html = `<div style="font-weight:600;font-size:0.85rem;margin-bottom:0.5rem">ğŸ”€ Git</div>`;

        // â”€â”€ Enriched status strip â”€â”€
        const gitVer = git.git_version ? 'v' + git.git_version : '';
        const giCov = Math.round((giAnalysis.coverage || 0) * 100);
        const giCovOk = giCov >= 90;
        html += `<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.5rem">
            ${_pill(d.tools?.git, d.tools?.git ? 'âœ“ git' + (gitVer ? ' ' + gitVer : '') : 'âœ— git missing')}
            ${_pill(git.initialized, git.initialized ? 'âœ“ repo Â· ' + (git.branch || '?') : 'â—‹ no repo')}
            ${_pill(remotes.length > 0, remotes.length > 0 ? 'âœ“ ' + remotes.length + ' remote(s)' : 'â—‹ no remotes')}
            ${_pill(git.has_gitignore, git.has_gitignore ? 'âœ“ .gitignore ' + giCov + '%' : 'â—‹ no .gitignore')}
            ${_pill(git.hook_count > 0, git.hook_count > 0 ? 'âœ“ ' + git.hook_count + ' hook(s)' : 'â—‹ no hooks')}
        </div>`;

        // â”€â”€ Remotes section â”€â”€
        html += `<details style="margin-bottom:0.5rem" ${remotes.length === 0 ? 'open' : ''}>
            <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ğŸŒ Remotes (${remotes.length})
            </summary>
            <div style="padding-top:0.3rem">`;

        if (remotes.length > 0) {
            html += `<div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden;margin-bottom:0.4rem">`;
            for (const r of remotes) {
                const url = r.fetch || r.push || '';
                const shortUrl = url.replace(/^https?:\/\//, '').replace(/\.git$/, '');
                html += `<div style="display:flex;align-items:center;gap:0.4rem;padding:0.25rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.75rem">
                    <code style="font-weight:600;min-width:55px;font-size:0.72rem">${esc(r.name)}</code>
                    <span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text-secondary);font-size:0.7rem">${esc(shortUrl)}</span>
                    <button class="btn btn-sm btn-ghost" style="font-size:0.6rem;padding:1px 4px;color:var(--error)"
                        onclick="if(!this.dataset.c){this.textContent='Sure?';this.dataset.c='1';setTimeout(()=>{this.textContent='âœ—';delete this.dataset.c},2500);return}
                        (async()=>{try{await apiPost('/git/remote/remove',{name:'${esc(r.name)}'});toast('âœ… Remote removed','success');_wizRedetect();}catch(e){toast('âŒ '+e.message,'error')}})()">âœ—</button>
                </div>`;
            }
            html += `</div>`;
        }

        // Add remote form
        const suggestOrigin = remotes.length === 0;
        const ghSlug = ghCli.repo || '';
        const suggestUrl = suggestOrigin && ghSlug ? 'https://github.com/' + ghSlug + '.git' : '';
        html += `<div style="display:flex;gap:0.3rem;align-items:center">
                <input type="text" id="wiz-git-remote-name" placeholder="${suggestOrigin ? 'origin' : 'upstream'}" value=""
                    style="width:70px;font-size:0.72rem;padding:0.2rem 0.4rem;border:1px solid var(--border-subtle);border-radius:4px;background:var(--bg-inset);color:var(--text-primary)">
                <input type="text" id="wiz-git-remote-url" placeholder="https://github.com/user/repo.git" value="${esc(suggestUrl)}"
                    style="flex:1;font-size:0.72rem;padding:0.2rem 0.4rem;border:1px solid var(--border-subtle);border-radius:4px;background:var(--bg-inset);color:var(--text-primary)">
                <button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.35rem;white-space:nowrap" id="wiz-git-add-remote-btn"
                    onclick="(async()=>{
                        const btn=document.getElementById('wiz-git-add-remote-btn');
                        const name=document.getElementById('wiz-git-remote-name').value.trim()||'${suggestOrigin ? 'origin' : 'upstream'}';
                        const url=document.getElementById('wiz-git-remote-url').value.trim();
                        if(!url){toast('Enter a remote URL','warn');return}
                        btn.disabled=true;btn.textContent='Addingâ€¦';
                        try{await apiPost('/git/remote/add',{name,url});toast('âœ… Remote \\'' +name+ '\\' added','success');_wizRedetect()}
                        catch(e){toast('âŒ '+e.message,'error');btn.disabled=false;btn.textContent='ï¼‹ Add'}
                    })()">ï¼‹ Add</button>
            </div>
            ${suggestUrl ? `<div style="font-size:0.65rem;color:var(--text-muted);margin-top:2px">ğŸ™ Pre-filled from GitHub CLI: ${esc(ghSlug)}</div>` : ''}
            </div>
        </details>`;

        // â”€â”€ .gitignore section â”€â”€
        const giExists = git.has_gitignore;
        const giMissing = giAnalysis.missing_count || 0;
        html += `<details style="margin-bottom:0.5rem" ${!giExists ? 'open' : ''}>
            <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ğŸ“„ .gitignore ${giExists ? '(' + giCov + '% coverage)' : '(missing)'}
            </summary>
            <div style="padding-top:0.3rem">`;

        if (giExists && giMissing === 0) {
            html += `<div style="font-size:0.75rem;color:var(--success);padding:0.2rem 0">âœ… .gitignore is complete â€” ${giAnalysis.current_patterns || '?'} patterns, ${giCov}% coverage.</div>`;
        } else if (giExists && giMissing > 0) {
            html += `<div style="font-size:0.72rem;color:var(--warning);padding:0.2rem 0;margin-bottom:0.3rem">âš ï¸ Missing ${giMissing} recommended pattern(s).</div>`;
            const missing = (giAnalysis.missing_patterns || []).slice(0, 5);
            if (missing.length > 0) {
                html += `<div style="display:flex;flex-wrap:wrap;gap:0.2rem;margin-bottom:0.3rem">`;
                for (const p of missing) {
                    html += `<span style="font-size:0.62rem;padding:0.05rem 0.25rem;border-radius:3px;background:color-mix(in srgb, var(--warning) 8%, transparent);color:var(--warning);border:1px solid color-mix(in srgb, var(--warning) 15%, transparent)">âŒ ${esc(p.pattern || p)}</span>`;
                }
                if (giMissing > 5) html += `<span style="font-size:0.62rem;color:var(--text-muted)">+${giMissing - 5} more</span>`;
                html += `</div>`;
            }
            html += `${_wizField('wiz-git-regen-gi', 'Regenerate .gitignore (stack-aware)', true, { type: 'checkbox' })}`;
        } else {
            html += `<div style="font-size:0.72rem;color:var(--text-muted);padding:0.2rem 0;margin-bottom:0.3rem">No .gitignore found. We can generate one based on your detected stacks.</div>`;
            html += `${_wizField('wiz-git-create-gi', 'Create .gitignore', true, { type: 'checkbox' })}`;
        }
        html += `</div></details>`;

        // â”€â”€ Pre-commit hooks section â”€â”€
        const lintCmd = caps.lint || '';
        const formatCmd = caps.format || '';
        const testCmd = caps.test || '';
        const hasLintTools = lintCmd || formatCmd;
        if (hasLintTools && git.hook_count === 0) {
            html += `<details style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    ğŸª Pre-commit Hook
                </summary>
                <div style="padding-top:0.3rem">
                    <div style="font-size:0.72rem;color:var(--text-secondary);margin-bottom:0.3rem">Run checks automatically before each commit:</div>
                    <div style="display:flex;flex-wrap:wrap;gap:0.2rem;margin-bottom:0.3rem">
                        ${lintCmd ? _pill(true, 'âœ“ ' + lintCmd) : ''}
                        ${formatCmd ? _pill(true, 'âœ“ ' + formatCmd) : ''}
                    </div>
                    ${_wizField('wiz-git-setup-hooks', 'Install pre-commit hook', false, { type: 'checkbox' })}
                </div>
            </details>`;
        }

        // â”€â”€ Initial commit (if no commits yet) â”€â”€
        if (!git.initialized || git.commit_count === 0) {
            html += `<details style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    ğŸ’¾ Initial Commit
                </summary>
                <div style="padding-top:0.3rem">
                    ${_wizField('wiz-git-init-commit', 'Create initial commit after setup', false, { type: 'checkbox' })}
                    ${_wizField('wiz-git-commit-msg', 'Commit Message', 'Initial commit', { placeholder: 'Initial commit' })}
                </div>
            </details>`;
        }

        // â”€â”€ Default branch â”€â”€
        html += `${_wizField('wiz-git-branch', 'Default Branch', git.branch || 'main', { help: git.branch ? 'Current: ' + git.branch : 'Will be set on init' })}`;

        // â”€â”€ Apply button â”€â”€
        html += _wizApplyBtn('int:git');

        return html;
    },

    'int:github': (info, safeName, d) => {
        // â”€â”€ Pull all embedded data â”€â”€
        const ghCli = d.gh_cli_status || {};
        const ghUser = d.gh_user || {};
        const ghRepo = d.gh_repo_info || {};
        const ghEnvs = d.gh_environments || {};
        const probes = d.status_probes || {};
        const ghProbe = probes.github || {};
        const configData = d.config_data || {};
        const localEnvs = configData.environments || [];
        const ghEnvList = ghEnvs.environments || [];
        const remoteEnvNames = ghEnvList.map(e => (typeof e === 'string' ? e : e.name || String(e)).toLowerCase());
        const codeownersContent = d.codeowners_content || '';

        const _pill = (ok, label) => `<span style="font-size:0.62rem;padding:0.08rem 0.3rem;border-radius:4px;${ok ? 'background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)' : 'background:color-mix(in srgb, var(--text-muted) 8%, transparent);color:var(--text-muted);border:1px solid color-mix(in srgb, var(--text-muted) 20%, transparent)'}">${label}</span>`;

        let html = `<div style="font-weight:600;font-size:0.85rem;margin-bottom:0.5rem">ğŸ™ GitHub</div>`;

        // â”€â”€ Not installed / Not authenticated â”€â”€
        if (!ghCli.available) {
            html += `<div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.5;margin-bottom:0.5rem">
                The <code>gh</code> CLI is not installed. Install it to manage GitHub integration.
            </div>
            <div style="display:flex;gap:0.3rem;flex-wrap:wrap">
                <button class="btn btn-sm btn-secondary" style="font-size:0.72rem"
                    onclick="_wizInstallTool('gh', this)">ğŸ“¦ Install gh</button>
                <button class="btn btn-sm btn-secondary" style="font-size:0.72rem"
                    onclick="_wizRedetect()">ğŸ”„ Re-detect</button>
            </div>`;
            return html;
        }

        if (!ghCli.authenticated) {
            html += `<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.5rem">
                ${_pill(true, 'âœ“ gh installed')}
                ${_pill(false, 'â—‹ not authenticated')}
            </div>`;
            html += `<div style="font-size:0.75rem;color:var(--text-secondary);line-height:1.5;margin-bottom:0.5rem">
                Authenticate your GitHub account to manage repositories, environments, secrets, and CODEOWNERS.
            </div>
            <div style="display:flex;gap:0.3rem;flex-wrap:wrap">
                <button class="btn btn-sm btn-primary" style="font-size:0.72rem"
                    onclick="_showGhAuthModal(() => _wizRedetect())">ğŸ”‘ Authenticate</button>
                <button class="btn btn-sm btn-secondary" style="font-size:0.72rem"
                    onclick="_wizRedetect()">ğŸ”„ Re-detect</button>
            </div>`;
            return html;
        }

        // â”€â”€ Authenticated â€” enriched status strip â”€â”€
        const vis = (ghRepo.visibility || '').toLowerCase();
        const isPrivate = ghRepo.is_private;
        const matchCount = localEnvs.filter(e => remoteEnvNames.includes(e.name.toLowerCase())).length;
        const hasCo = ghProbe.has_codeowners;

        html += `<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.5rem">
            ${_pill(true, 'âœ“ authenticated')}
            ${ghUser.login ? _pill(true, '@' + esc(ghUser.login)) : ''}
            ${ghRepo.slug ? _pill(true, esc(ghRepo.slug)) : _pill(false, 'â—‹ no repo linked')}
            ${vis ? _pill(true, vis === 'private' ? 'ğŸ”’ private' : 'ğŸŒ public') : ''}
            ${ghRepo.default_branch ? _pill(true, 'ğŸŒ¿ ' + esc(ghRepo.default_branch)) : ''}
            ${ghEnvList.length > 0 ? _pill(true, ghEnvList.length + ' env(s)') : ''}
            ${localEnvs.length > 0 && matchCount < localEnvs.length ? _pill(false, (localEnvs.length - matchCount) + ' env(s) missing on GH') : ''}
            ${hasCo ? _pill(true, 'CODEOWNERS âœ“') : _pill(false, 'â—‹ no CODEOWNERS')}
            ${ghProbe.workflow_count > 0 ? _pill(true, ghProbe.workflow_count + ' workflow(s)') : ''}
        </div>`;

        // â”€â”€ User card â”€â”€
        const avatar = ghUser.avatar_url || '';
        html += `<div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.5rem;background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;margin-bottom:0.5rem">
            ${avatar ? `<img src="${esc(avatar)}" style="width:24px;height:24px;border-radius:50%;border:1.5px solid var(--accent)" alt="">` : '<span style="font-size:1rem">ğŸ‘¤</span>'}
            <div style="flex:1;min-width:0">
                <span style="font-size:0.78rem;font-weight:600">${esc(ghUser.login || '?')}</span>
                ${ghUser.name ? `<span style="font-size:0.68rem;color:var(--text-muted)"> Â· ${esc(ghUser.name)}</span>` : ''}
            </div>
            <button class="btn btn-sm btn-ghost" style="font-size:0.6rem;padding:1px 6px;color:var(--error)"
                onclick="(async()=>{if(!confirm('Log out from GitHub CLI?'))return;await apiPost('/gh/auth/logout',{});toast('Logged out â€” Re-scan to refresh','info');_wizRedetect()})()">ğŸ”“ Logout</button>
        </div>`;

        // â”€â”€ Repository info â”€â”€
        if (ghRepo.slug) {
            html += `<details style="margin-bottom:0.5rem" open>
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    ğŸ“¦ Repository
                </summary>
                <div style="padding:0.3rem 0.4rem;background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px">
                    <div style="display:flex;align-items:center;gap:0.4rem;font-size:0.78rem;margin-bottom:0.15rem">
                        <code style="font-weight:600">${esc(ghRepo.slug)}</code>
                        <span style="font-size:0.62rem;padding:0.05rem 0.2rem;border-radius:3px;background:color-mix(in srgb, ${isPrivate ? 'var(--warning)' : 'var(--success)'} 10%, transparent);color:${isPrivate ? 'var(--warning)' : 'var(--success)'};border:1px solid color-mix(in srgb, ${isPrivate ? 'var(--warning)' : 'var(--success)'} 20%, transparent)">${isPrivate ? 'ğŸ”’ private' : 'ğŸŒ public'}</span>
                        <span style="flex:1"></span>
                        <a href="https://github.com/${esc(ghRepo.slug)}" target="_blank" style="font-size:0.65rem;color:var(--accent);text-decoration:none">Open â†—</a>
                    </div>
                    ${ghRepo.description ? `<div style="font-size:0.68rem;color:var(--text-muted);margin-bottom:0.1rem">${esc(ghRepo.description)}</div>` : ''}
                    <div style="font-size:0.65rem;color:var(--text-muted)">
                        Branch: <strong>${esc(ghRepo.default_branch || '?')}</strong>
                        ${ghRepo.is_fork ? ' Â· ğŸ´ fork' : ''}
                        ${ghRepo.homepage_url ? ' Â· ğŸŒ ' + esc(ghRepo.homepage_url) : ''}
                    </div>
                </div>
            </details>`;
        }

        // â”€â”€ Environment alignment â”€â”€
        if (localEnvs.length > 0) {
            const missingEnvs = localEnvs.filter(e => !remoteEnvNames.includes(e.name.toLowerCase()));
            html += `<details style="margin-bottom:0.5rem" ${missingEnvs.length > 0 ? 'open' : ''}>
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                    âš™ï¸ Environments (${matchCount}/${localEnvs.length} aligned)
                </summary>
                <div style="padding-top:0.3rem">`;

            html += `<div style="background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden;margin-bottom:0.3rem">`;
            for (const env of localEnvs) {
                const aligned = remoteEnvNames.includes(env.name.toLowerCase());
                html += `<div style="display:flex;align-items:center;gap:0.4rem;padding:0.2rem 0.5rem;border-bottom:1px solid color-mix(in srgb, var(--border-subtle) 40%, transparent);font-size:0.72rem">
                    <span style="width:18px;text-align:center">${aligned ? 'âœ…' : 'â¬œ'}</span>
                    <code style="flex:1;font-size:0.7rem;font-weight:500">${esc(env.name)}</code>
                    ${env.default ? '<span style="font-size:0.58rem;color:var(--warning)">â­ default</span>' : ''}
                    <span style="font-size:0.62rem;color:${aligned ? 'var(--success)' : 'var(--text-muted)'}">${aligned ? 'âœ“ on GitHub' : 'âœ— missing'}</span>
                    ${!aligned ? `<input type="checkbox" class="wiz-gh-env-create" data-env="${esc(env.name)}" checked style="width:12px;height:12px;accent-color:var(--accent)">` : ''}
                </div>`;
            }
            html += `</div>`;

            if (missingEnvs.length > 0) {
                html += `<button class="btn btn-sm btn-secondary" style="font-size:0.68rem;padding:0.12rem 0.4rem" id="wiz-gh-create-envs-btn"
                    onclick="(async()=>{
                        const btn=document.getElementById('wiz-gh-create-envs-btn');
                        const envs=Array.from(document.querySelectorAll('.wiz-gh-env-create:checked')).map(cb=>cb.dataset.env);
                        if(envs.length===0){toast('No environments selected','info');return}
                        btn.disabled=true;btn.textContent='Creatingâ€¦';
                        try{
                            const r=await apiPost('/wizard/setup',{action:'setup_github',create_environments:envs});
                            const created=(r.results||{}).environments_created||[];
                            const failed=(r.results||{}).environments_failed||[];
                            if(created.length>0) toast('âœ… Created: '+created.join(', '),'success');
                            if(failed.length>0) toast('âŒ Failed: '+failed.map(f=>f.name).join(', '),'error');
                            _wizRedetect();
                        }catch(e){toast('âŒ '+e.message,'error');btn.disabled=false;btn.textContent='Create Environments'}
                    })()">ğŸ†• Create ${missingEnvs.length} Environment(s)</button>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ CODEOWNERS â”€â”€
        html += `<details style="margin-bottom:0.5rem">
            <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ğŸ“‹ CODEOWNERS ${hasCo ? '(exists)' : '(missing)'}
            </summary>
            <div style="padding-top:0.3rem">`;

        if (hasCo && codeownersContent) {
            html += `<div style="max-height:80px;overflow-y:auto;padding:0.3rem 0.4rem;background:color-mix(in srgb, var(--bg-inset) 50%, transparent);border:1px solid var(--border-subtle);border-radius:6px;margin-bottom:0.3rem">
                <pre style="margin:0;white-space:pre-wrap;font-family:var(--font-mono);font-size:0.65rem;line-height:1.35;color:var(--text-secondary)">${esc(codeownersContent)}</pre>
            </div>`;
        } else if (!hasCo) {
            const owner = ghRepo.owner || (ghRepo.slug || '').split('/')[0] || '';
            html += `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.3rem">No CODEOWNERS file. Define reviewers who are auto-assigned to PRs.</div>`;
            html += `<div style="margin-bottom:0.4rem;display:flex;align-items:center;gap:0.4rem">
                <input type="checkbox" id="wiz-gh-write-co" style="accent-color:var(--accent)"
                    onchange="document.getElementById('wiz-gh-co-editor').style.display=this.checked?'block':'none'">
                <label for="wiz-gh-write-co" style="font-size:0.75rem;color:var(--text-secondary);cursor:pointer">Create CODEOWNERS</label>
            </div>`;
            html += `<div id="wiz-gh-co-editor" style="display:none">
                <textarea id="wiz-gh-co-content" style="width:100%;min-height:60px;font-family:var(--font-mono);font-size:0.68rem;padding:0.3rem;border:1px solid var(--border-subtle);border-radius:4px;background:var(--bg-inset);color:var(--text-primary)"># CODEOWNERS\n* @${esc(owner)}\n</textarea>
            </div>`;
        }
        html += `</div></details>`;

        // â”€â”€ Secrets overview â”€â”€
        html += `<details style="margin-bottom:0.5rem">
            <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">
                ğŸ”’ Secrets
            </summary>
            <div style="padding-top:0.3rem">
                <div style="font-size:0.72rem;color:var(--text-secondary);margin-bottom:0.3rem">Secrets and variables synced to GitHub for CI/CD.</div>
                ${_wizField('wiz-gh-push-secrets', 'Push vault secrets to GitHub now', false, { type: 'checkbox' })}
                <div style="font-size:0.65rem;color:var(--text-muted)">Use the ğŸ” Secrets tab or ğŸš€ Full Setup for granular per-key management.</div>
            </div>
        </details>`;

        // â”€â”€ Apply button â”€â”€
        html += _wizApplyBtn('int:github');

        return html;
    },

    'int:pages': (info, projectName, d) => {
        const ps = d.pages_status || {};
        const pp = (d.status_probes || {}).pages || {};
        const segs = ps.segments || [];
        const cfs = ps.content_folders || [];
        const meta = ps.meta || {};
        const builders = ps.builders_available || [];

        let html = `<div style="font-weight:600;font-size:0.85rem;margin-bottom:0.5rem">ğŸ“„ Pages</div>`;

        // â”€â”€ Status strip â”€â”€
        const pills = [];
        if (pp.status === 'ready') pills.push('âœ… ready');
        else if (pp.status === 'partial') pills.push('âš ï¸ partial');
        else pills.push('â—‹ not configured');

        if (segs.length > 0) pills.push(`ğŸ“‘ ${segs.length} segment${segs.length !== 1 ? 's' : ''}`);
        if (pp.has_pages_dir) pills.push('ğŸ“ .pages/');
        if (meta.deploy_branch) pills.push(`ğŸŒ¿ ${meta.deploy_branch}`);
        if (cfs.length > 0 && segs.length === 0) pills.push(`ğŸ“‚ ${cfs.length} content folder${cfs.length !== 1 ? 's' : ''}`);

        html += `<div style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-bottom:0.6rem">
            ${pills.map(p => `<span style="font-size:0.68rem;padding:0.15rem 0.45rem;border-radius:999px;background:var(--bg-inset);border:1px solid var(--border-subtle);color:var(--text-secondary)">${p}</span>`).join('')}
        </div>`;

        // â”€â”€ Existing segments â”€â”€
        if (segs.length > 0) {
            html += `<details open style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">ğŸ“‘ Segments (${segs.length})</summary>
                <div style="border:1px solid var(--border-subtle);border-radius:6px;overflow:hidden">`;
            for (const seg of segs) {
                const previewUrl = '/pages/site/' + encodeURIComponent(seg.name) + '/';
                html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:0.35rem 0.5rem;border-bottom:1px solid var(--border-subtle);font-size:0.72rem">
                    <div>
                        <span style="font-weight:600;color:var(--text-primary)">${esc(seg.name)}</span>
                        <span style="color:var(--text-muted);margin-left:0.4rem">${esc(seg.builder)}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <span style="font-size:0.65rem;color:var(--text-muted)">${esc(seg.source)} â†’ ${esc(seg.path)}</span>
                        <a href="${previewUrl}" target="_blank" style="font-size:0.65rem;color:var(--accent);text-decoration:none" title="Open local preview">ğŸ”—</a>
                    </div>
                </div>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Content folders (with auto-init) â”€â”€
        if (cfs.length > 0) {
            const uninit = cfs.filter(cf => !cf.has_segment);
            html += `<details ${segs.length === 0 ? 'open' : ''} style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">ğŸ“‚ Content Folders (${cfs.length})</summary>`;

            for (const cf of cfs) {
                const statusIcon = cf.has_segment ? 'âœ…' : 'â¬œ';
                const statusText = cf.has_segment ? 'segment exists' : 'no segment';
                html += `<div style="display:flex;align-items:center;justify-content:space-between;padding:0.3rem 0.5rem;border-bottom:1px solid var(--border-subtle);font-size:0.72rem">
                    <div>
                        <span>${statusIcon}</span>
                        <span style="font-weight:600;color:var(--text-primary);margin-left:0.3rem">${esc(cf.name)}/</span>
                        <span style="color:var(--text-muted);margin-left:0.3rem">${cf.file_count} file${cf.file_count !== 1 ? 's' : ''}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.4rem">
                        <span style="font-size:0.65rem;padding:0.1rem 0.35rem;border-radius:4px;background:var(--bg-inset);color:var(--text-secondary)">${esc(cf.best_builder)}</span>
                        <span style="font-size:0.6rem;color:var(--text-muted)">${esc(statusText)}</span>
                    </div>
                </div>`;
                if (cf.suggestion && !cf.has_segment) {
                    html += `<div style="font-size:0.6rem;color:var(--warning);padding:0.15rem 0.5rem">ğŸ’¡ ${esc(cf.suggestion)}</div>`;
                }
            }

            if (uninit.length > 0) {
                html += `<div style="margin-top:0.4rem;padding:0.3rem 0.5rem">
                    <div style="margin-bottom:0.4rem;display:flex;align-items:center;gap:0.4rem">
                        <input type="checkbox" id="wiz-pages-auto-init" checked style="accent-color:var(--accent)">
                        <label for="wiz-pages-auto-init" style="font-size:0.75rem;color:var(--text-secondary);cursor:pointer">
                            Auto-initialize ${uninit.length} segment${uninit.length !== 1 ? 's' : ''} from content folders
                        </label>
                    </div>
                    <div style="font-size:0.6rem;color:var(--text-muted)">
                        Each folder will get a segment using the best available builder (${uninit.map(u => u.name + ' â†’ ' + u.best_builder).join(', ')}).
                    </div>
                </div>`;
            }

            html += `</details>`;
        }

        // â”€â”€ Available builders â”€â”€
        if (builders.length > 0) {
            html += `<details style="margin-bottom:0.5rem">
                <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;cursor:pointer;user-select:none;margin-bottom:0.3rem">ğŸ”¨ Available Builders (${builders.filter(b => b.available).length}/${builders.length})</summary>
                <div style="display:flex;flex-wrap:wrap;gap:0.3rem;padding:0.2rem 0">`;
            for (const b of builders) {
                const color = b.available ? 'var(--success)' : 'var(--text-muted)';
                const icon = b.available ? 'âœ…' : 'â—‹';
                html += `<span style="font-size:0.68rem;padding:0.15rem 0.45rem;border-radius:999px;background:var(--bg-inset);border:1px solid var(--border-subtle);color:${color}">${icon} ${esc(b.label)}</span>`;
            }
            html += `</div></details>`;
        }

        // â”€â”€ Deploy info â”€â”€
        if (meta.deploy_branch || meta.base_url) {
            html += `<div style="font-size:0.68rem;color:var(--text-muted);margin-bottom:0.4rem">`;
            if (meta.deploy_branch) html += `Deploy branch: <strong>${esc(meta.deploy_branch)}</strong>`;
            if (meta.deploy_branch && meta.base_url) html += ` Â· `;
            if (meta.base_url) html += `Base URL: <strong>${esc(meta.base_url)}</strong>`;
            html += `</div>`;
        }

        // â”€â”€ No content folders message â”€â”€
        if (cfs.length === 0 && segs.length === 0) {
            html += `<div style="font-size:0.72rem;color:var(--text-muted);padding:0.5rem 0">
                No content folders detected (docs/, content/, etc.) and no Pages segments configured.<br>
                Add content to your project or configure segments in the <strong>Pages tab</strong>.
            </div>`;
        }

        // â”€â”€ Apply button (only if there's something to auto-init) â”€â”€
        if (ps.can_auto_init) {
            html += _wizApplyBtn('int:pages');
        }

        // â”€â”€ Escalation â”€â”€
        html += `<div style="font-size:0.68rem;color:var(--text-muted);margin-top:0.5rem">
            Full segment management (add, edit, build, deploy) is available in the <strong>Pages tab</strong>.
        </div>`;

        return html;
    },
};

// â”€â”€ Docker live panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
