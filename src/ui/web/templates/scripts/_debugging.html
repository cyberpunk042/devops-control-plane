<script>
    // â”€â”€ Debugging tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let debugCurrentMode = 'audit';
    let _debugEditors = {};   // panel â†’ monaco editor instance
    let _debugData = {};      // panel â†’ raw JSON data
    let _debugViewMode = {};  // panel â†’ 'preview' | 'source'
    let _debugAuditMode = 'scans'; // 'scans' or 'ops'

    function debugSwitchMode(mode) {
        debugCurrentMode = mode;
        document.querySelectorAll('#tab-debugging .debug-modes > .content-mode').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');

        // Dispose any active Monaco editors when switching away
        for (const [key, ed] of Object.entries(_debugEditors)) {
            if (key !== mode && ed) {
                try { ed.dispose(); } catch {}
                _debugEditors[key] = null;
            }
        }

        // Show/hide panels
        ['audit', 'state', 'health', 'config'].forEach(m => {
            const el = document.getElementById(`debug-${m}`);
            if (el) el.style.display = m === mode ? '' : 'none';
        });

        if (mode === 'state') loadDebugState();
        if (mode === 'health') loadDebugHealth();
        if (mode === 'config') loadDebugConfig();
    }

    function debugAuditToggle(mode) {
        _debugAuditMode = mode;
        document.querySelectorAll('.debug-audit-toggle').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        document.getElementById('debug-audit-scans').style.display = mode === 'scans' ? '' : 'none';
        document.getElementById('debug-audit-ops').style.display = mode === 'ops' ? '' : 'none';

        if (mode === 'ops') loadDebugAuditOps();
        if (mode === 'scans') loadDebugAuditScans();
    }

    function debugToggleView(panel, mode) {
        _debugViewMode[panel] = mode;

        // Update toggle buttons
        document.querySelectorAll(`.debug-view-toggle[data-panel="${panel}"]`).forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });

        const previewEl = document.getElementById(`debug-${panel}-preview`);
        const editorEl = document.getElementById(`debug-${panel}-editor`);

        if (mode === 'source') {
            previewEl.style.display = 'none';
            editorEl.style.display = '';

            // Create Monaco editor if not already
            if (!_debugEditors[panel] && _debugData[panel]) {
                const json = JSON.stringify(_debugData[panel], null, 2);
                monacoReady(function(monaco) {
                    _debugEditors[panel] = monaco.editor.create(editorEl, {
                        value: json,
                        language: 'json',
                        theme: 'admin-dark',
                        readOnly: true,
                        automaticLayout: true,
                        minimap: { enabled: json.split('\n').length > 80 },
                        scrollBeyondLastLine: false,
                        fontSize: 13,
                        lineNumbers: 'on',
                        renderLineHighlight: 'none',
                        wordWrap: 'on',
                        padding: { top: 8 },
                        folding: true,
                        glyphMargin: false,
                        overviewRulerLanes: 0,
                        hideCursorInOverviewRuler: true,
                        scrollbar: {
                            verticalScrollbarSize: 8,
                            horizontalScrollbarSize: 8,
                        },
                    });
                });
            } else if (!_debugData[panel]) {
                editorEl.innerHTML = '<div style="padding:1rem;color:var(--text-muted);font-size:0.8rem">No data loaded yet. Switch to Preview first to load the data.</div>';
            }
        } else {
            previewEl.style.display = '';
            editorEl.style.display = 'none';
        }
    }

    async function loadDebugTab() {
        loadDebugAuditScans();
    }

    // â”€â”€ Audit Scan Activity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadDebugAuditScans() {
        const container = document.getElementById('debug-audit-scans');
        try {
            const data = await api('/audit/activity?n=100');

            if (!data.entries || !data.entries.length) {
                container.innerHTML = `<div class="activity-item" style="color:var(--text-muted)">
                    No scan activity yet. Load the <strong>Audit</strong> or <strong>DevOps</strong> tab to trigger scans.
                </div>`;
                return;
            }

            container.innerHTML = data.entries.slice().reverse().map((entry, idx) => {
                const statusIcon = entry.status === 'ok' ? 'âœ…' : 'âŒ';
                const statusColor = entry.status === 'ok' ? 'var(--success)' : 'var(--danger)';
                const time = new Date(entry.iso || entry.ts * 1000).toLocaleString();
                const duration = entry.duration_s != null ? `${entry.duration_s.toFixed(1)}s` : '';
                const bust = entry.bust ? '<span style="font-size:0.6rem;color:var(--warning);background:rgba(245,158,11,0.1);padding:1px 4px;border-radius:3px" title="Cache was force-busted">ğŸ’¥ bust</span>' : '';

                // Card type badge
                const isDismissal = entry.card === 'dismissal';
                const isAudit = entry.card && entry.card.startsWith('audit:');
                let typeBadge;
                if (isDismissal) {
                    typeBadge = '<span style="font-size:0.6rem;padding:1px 5px;border-radius:3px;background:rgba(52,211,153,0.1);color:var(--success)">Dismiss</span>';
                } else if (isAudit) {
                    typeBadge = '<span style="font-size:0.6rem;padding:1px 5px;border-radius:3px;background:rgba(139,92,246,0.1);color:#a78bfa">Audit</span>';
                } else {
                    typeBadge = '<span style="font-size:0.6rem;padding:1px 5px;border-radius:3px;background:rgba(59,130,246,0.1);color:#60a5fa">DevOps</span>';
                }

                // â”€â”€ Enriched audit fields â”€â”€
                // Action badge goes inline in the header; the rest is collapsible detail
                let actionBadgeHtml = '';
                let auditDetailHtml = '';
                const hasEnriched = entry.action || entry.target || entry.before || entry.after;

                if (hasEnriched) {
                    // Action badge + target for inline header
                    const actionColors = {
                        created: '#34d399', modified: '#60a5fa', deleted: '#f87171',
                        renamed: '#fbbf24', moved: '#a78bfa', encrypted: '#818cf8',
                        decrypted: '#38bdf8', configured: '#94a3b8', locked: '#f87171',
                        unlocked: '#34d399', restored: '#60a5fa', imported: '#a78bfa',
                        exported: '#fbbf24', generated: '#94a3b8', started: '#34d399',
                        stopped: '#f87171', restarted: '#fbbf24', built: '#60a5fa',
                        pulled: '#38bdf8', pushed: '#a78bfa', executed: '#94a3b8',
                        removed: '#f87171', pruned: '#818cf8', set: '#60a5fa',
                        switched: '#fbbf24', planned: '#a78bfa', applied: '#34d399',
                        destroyed: '#f87171', formatted: '#94a3b8', initialized: '#60a5fa',
                        dismissed: '#f87171', undismissed: '#34d399', uploaded: '#a78bfa',
                        marked: '#818cf8', unmarked: '#94a3b8', wiped: '#f87171',
                        cleaned: '#fbbf24', seeded: '#34d399', registered: '#60a5fa',
                        saved: '#60a5fa',
                    };
                    if (entry.action) {
                        const ac = entry.action;
                        const acColor = actionColors[ac] || '#94a3b8';
                        actionBadgeHtml = `<span style="display:inline-block;font-size:0.58rem;padding:1px 5px;border-radius:3px;background:${acColor}22;color:${acColor};font-weight:600;text-transform:uppercase;letter-spacing:0.5px">${esc(ac)}</span>`;
                    }

                    // Collapsible detail section
                    auditDetailHtml += `<div id="audit-log-detail-${idx}" style="display:none;padding:6px 10px;margin-top:4px;border-radius:var(--radius-sm);background:var(--bg-primary);border:1px solid var(--border-subtle);font-size:0.72rem">`;

                    // Target
                    if (entry.target) {
                        auditDetailHtml += `<div style="margin-bottom:4px"><span style="font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px">Target:</span> <span style="font-family:var(--font-mono);font-size:0.7rem;color:var(--text-secondary)">${esc(entry.target)}</span></div>`;
                    }

                    // Before â†’ After comparison
                    if (entry.before || entry.after) {
                        auditDetailHtml += `<div style="display:flex;gap:12px;margin-top:4px;flex-wrap:wrap">`;

                        if (entry.before && Object.keys(entry.before).length) {
                            auditDetailHtml += `<div style="flex:1;min-width:120px;padding:4px 8px;border-radius:var(--radius-sm);background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.12)">`;
                            auditDetailHtml += `<div style="font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px">Before</div>`;
                            for (const [k, v] of Object.entries(entry.before)) {
                                const displayVal = typeof v === 'number' && k.includes('size') ? v.toLocaleString() + ' B' : String(v);
                                auditDetailHtml += `<div style="font-size:0.66rem;color:var(--text-secondary)"><span style="color:var(--text-muted)">${esc(k)}:</span> ${esc(displayVal)}</div>`;
                            }
                            auditDetailHtml += `</div>`;
                        }

                        if (entry.after && Object.keys(entry.after).length) {
                            auditDetailHtml += `<div style="flex:1;min-width:120px;padding:4px 8px;border-radius:var(--radius-sm);background:rgba(52,211,153,0.06);border:1px solid rgba(52,211,153,0.12)">`;
                            auditDetailHtml += `<div style="font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px">After</div>`;
                            for (const [k, v] of Object.entries(entry.after)) {
                                const displayVal = typeof v === 'number' && k.includes('size') ? v.toLocaleString() + ' B' : String(v);
                                auditDetailHtml += `<div style="font-size:0.66rem;color:var(--text-secondary)"><span style="color:var(--text-muted)">${esc(k)}:</span> ${esc(displayVal)}</div>`;
                            }
                            auditDetailHtml += `</div>`;
                        }

                        auditDetailHtml += `</div>`;
                    }

                    // Inline diff (for file modifications)
                    const diffText = entry.detail && entry.detail.diff;
                    if (diffText) {
                        auditDetailHtml += `<div style="margin-top:6px;padding:6px 8px;border-radius:var(--radius-sm);background:#0d1117;border:1px solid var(--border-subtle);font-family:var(--font-mono);font-size:0.64rem;line-height:1.5;overflow-x:auto;max-height:200px;overflow-y:auto;white-space:pre">`;
                        for (const line of diffText.split('\n')) {
                            let color = 'var(--text-muted)';
                            let bg = 'transparent';
                            if (line.startsWith('+++') || line.startsWith('---')) {
                                color = '#8b949e';
                            } else if (line.startsWith('+')) {
                                color = '#3fb950'; bg = 'rgba(63,185,80,0.1)';
                            } else if (line.startsWith('-')) {
                                color = '#f85149'; bg = 'rgba(248,81,73,0.1)';
                            } else if (line.startsWith('@@')) {
                                color = '#a78bfa'; bg = 'rgba(167,139,250,0.06)';
                            }
                            auditDetailHtml += `<div style="color:${color};background:${bg};padding:0 4px">${esc(line)}</div>`;
                        }
                        auditDetailHtml += `</div>`;
                    }

                    // File list (for restore, import, wipe, create, etc.)
                    const fileList = entry.detail && Array.isArray(entry.detail.files) ? entry.detail.files : null;
                    const overriddenSet = new Set(entry.detail && Array.isArray(entry.detail.overridden) ? entry.detail.overridden : []);
                    const newSet = new Set(entry.detail && Array.isArray(entry.detail.new) ? entry.detail.new : []);
                    if (fileList && fileList.length) {
                        const overrideCount = overriddenSet.size;
                        const newCount = newSet.size;
                        let headerParts = [`${fileList.length} total`];
                        if (overrideCount) headerParts.push(`<span style="color:#f87171">${overrideCount} overridden</span>`);
                        if (newCount) headerParts.push(`<span style="color:#34d399">${newCount} new</span>`);
                        auditDetailHtml += `<div style="margin-top:6px">`;
                        auditDetailHtml += `<div style="font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:3px">Files â€” ${headerParts.join(' Â· ')}</div>`;
                        auditDetailHtml += `<div style="padding:4px 8px;border-radius:var(--radius-sm);background:var(--bg-tertiary, rgba(255,255,255,0.03));border:1px solid var(--border-subtle);font-family:var(--font-mono);font-size:0.64rem;line-height:1.6;max-height:180px;overflow-y:auto">`;
                        for (const f of fileList) {
                            if (overriddenSet.has(f)) {
                                auditDetailHtml += `<div style="color:#f87171"><span style="font-size:0.58rem;padding:0 3px;border-radius:2px;background:rgba(248,113,113,0.12);margin-right:4px">âš  OVERRIDE</span>${esc(f)}</div>`;
                            } else if (newSet.has(f)) {
                                auditDetailHtml += `<div style="color:#34d399"><span style="font-size:0.58rem;padding:0 3px;border-radius:2px;background:rgba(52,211,153,0.12);margin-right:4px">âœš NEW</span>${esc(f)}</div>`;
                            } else {
                                auditDetailHtml += `<div style="color:var(--text-secondary)">${esc(f)}</div>`;
                            }
                        }
                        auditDetailHtml += `</div></div>`;
                    }

                    // Generic detail keys (excluding files/diff which have dedicated renderers)
                    if (entry.detail) {
                        const extraKeys = Object.keys(entry.detail).filter(k => k !== 'files' && k !== 'diff' && k !== 'overridden' && k !== 'new');
                        if (extraKeys.length) {
                            auditDetailHtml += `<div style="margin-top:6px;padding:4px 8px;border-radius:var(--radius-sm);background:rgba(99,102,241,0.04);border:1px solid rgba(99,102,241,0.1)">`;
                            auditDetailHtml += `<div style="font-size:0.6rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:2px">Detail</div>`;
                            for (const k of extraKeys) {
                                const v = entry.detail[k];
                                const displayVal = typeof v === 'object' ? JSON.stringify(v) : String(v);
                                auditDetailHtml += `<div style="font-size:0.66rem;color:var(--text-secondary)"><span style="color:var(--text-muted)">${esc(k)}:</span> ${esc(displayVal)}</div>`;
                            }
                            auditDetailHtml += `</div>`;
                        }
                    }

                    auditDetailHtml += `</div>`;
                } else {
                    // No enriched data â€” fall back to raw JSON detail (for legacy/error entries)
                    const detailObj = entry.detail || entry;
                    auditDetailHtml = `<div id="audit-log-detail-${idx}" style="display:none;margin-top:8px;padding:8px 10px;border-radius:var(--radius-sm);background:var(--bg-primary);font-size:0.68rem;font-family:var(--font-mono);white-space:pre-wrap;word-break:break-all;max-height:200px;overflow-y:auto;border:1px solid var(--border-subtle)">${esc(JSON.stringify(detailObj, null, 2))}</div>`;
                }

                return `<div style="padding:10px 14px;margin-bottom:5px;border-radius:var(--radius-sm);background:var(--bg-secondary);border-left:3px solid ${statusColor};display:flex;flex-direction:column;gap:3px;cursor:pointer" onclick="const d=document.getElementById('audit-log-detail-${idx}');if(d)d.style.display=d.style.display==='none'?'':'none'">
                    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                        <span style="font-size:0.88rem">${statusIcon}</span>
                        <strong style="font-size:0.8rem">${esc(entry.label || entry.card)}</strong>
                        ${actionBadgeHtml}
                        ${typeBadge}
                        ${bust}
                        ${duration && !isDismissal ? `<span style="font-size:0.66rem;color:var(--text-muted)">â± ${duration}</span>` : ''}
                        <span style="font-size:0.64rem;color:var(--text-muted);margin-left:auto">${time}</span>
                    </div>
                    ${entry.summary ? `<div style="font-size:0.72rem;color:var(--text-secondary);padding-left:26px">${esc(entry.summary)}</div>` : ''}
                    ${auditDetailHtml}
                </div>`;
            }).join('');
        } catch (e) {
            container.innerHTML = `<div class="activity-item" style="color:var(--error)">
                Failed to load scan activity: ${esc(e.message)}
            </div>`;
        }
    }

    // â”€â”€ CLI Operations (audit.ndjson) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadDebugAuditOps() {
        const container = document.getElementById('debug-audit-ops');
        try {
            const data = await api('/audit?n=50');

            if (!data.entries || !data.entries.length) {
                container.innerHTML = `<div class="activity-item" style="color:var(--text-muted)">
                    No CLI operation entries yet. Run a command from the <strong>Commands</strong> tab or CLI.
                </div>`;
                return;
            }

            container.innerHTML = data.entries.reverse().map(entry => {
                const statusClass = entry.status === 'ok' ? 'ok' : entry.status === 'failed' ? 'failed' : 'partial';
                const statusIcon = entry.status === 'ok' ? 'âœ…' : entry.status === 'failed' ? 'âŒ' : 'âš ï¸';
                const time = new Date(entry.timestamp).toLocaleString();
                const modules = (entry.modules_affected || []);
                const duration = entry.duration_ms ? `${(entry.duration_ms / 1000).toFixed(1)}s` : '';
                const opType = entry.operation_type ? `<span style="font-size:0.66rem;color:var(--accent);background:rgba(99,102,241,0.08);padding:1px 5px;border-radius:3px">${esc(entry.operation_type)}</span>` : '';

                // Errors section
                let errorHtml = '';
                if (entry.errors && entry.errors.length) {
                    errorHtml = `<div style="margin-top:4px;padding:4px 8px;border-radius:var(--radius-sm);background:rgba(239,68,68,0.08);border-left:2px solid var(--danger);font-size:0.7rem;color:var(--danger)">
                        ${entry.errors.map(e => esc(e)).join('<br>')}
                    </div>`;
                }

                // Module pills
                let modulePills = '';
                if (modules.length) {
                    modulePills = modules.map(m =>
                        `<span style="font-size:0.66rem;padding:1px 5px;border-radius:3px;background:var(--bg-secondary);color:var(--text-secondary)">${esc(m)}</span>`
                    ).join(' ');
                }

                return `<div style="padding:10px 14px;margin-bottom:6px;border-radius:var(--radius-sm);background:var(--bg-secondary);border-left:3px solid ${entry.status === 'ok' ? 'var(--success)' : entry.status === 'failed' ? 'var(--danger)' : 'var(--warning)'}">
                    <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
                        <span style="font-size:0.9rem">${statusIcon}</span>
                        <strong style="font-size:0.82rem">${esc(entry.automation || entry.operation_type || '(unknown)')}</strong>
                        ${opType}
                        <span class="status-badge ${statusClass}" style="font-size:0.66rem;padding:1px 6px">
                            <span class="status-dot"></span>${esc(entry.status)}
                        </span>
                        ${duration ? `<span style="font-size:0.66rem;color:var(--text-muted)">â± ${duration}</span>` : ''}
                        <span style="font-size:0.66rem;color:var(--text-muted);margin-left:auto">${time}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;margin-top:4px;flex-wrap:wrap">
                        <span style="font-size:0.72rem;color:var(--text-muted)">${entry.actions_succeeded}/${entry.actions_total} actions succeeded</span>
                        ${modulePills}
                    </div>
                    ${errorHtml}
                    ${entry.operation_id ? `<div style="font-size:0.62rem;color:var(--text-muted);margin-top:4px;font-family:var(--font-mono)">ID: ${esc(entry.operation_id)}</div>` : ''}
                </div>`;
            }).join('');
        } catch (e) {
            container.innerHTML = `<div class="activity-item" style="color:var(--error)">
                Failed to load audit log: ${esc(e.message)}
            </div>`;
        }
    }

    // â”€â”€ State Inspector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadDebugState() {
        const previewEl = document.getElementById('debug-state-preview');
        previewEl.innerHTML = '<span class="spinner"></span> Loading stateâ€¦';
        try {
            const data = await api('/status');
            const state = data.state || {};
            _debugData.state = state;

            let html = '';

            // Project info
            html += `<div style="padding:12px 16px;border-radius:var(--radius-md);background:var(--bg-secondary);margin-bottom:var(--space-md)">
                <div style="font-size:0.82rem;font-weight:700">${esc(state.project_name || data.project?.name || '(unknown)')}</div>
                <div style="font-size:0.72rem;color:var(--text-muted);margin-top:2px">
                    Environment: <strong>${esc(state.current_environment || 'â€”')}</strong>
                    Â· Schema v${state.schema_version || '?'}
                </div>
                <div style="font-size:0.66rem;color:var(--text-muted);margin-top:4px">
                    Created: ${state.created_at ? new Date(state.created_at).toLocaleString() : 'â€”'}
                    Â· Updated: ${state.updated_at ? new Date(state.updated_at).toLocaleString() : 'â€”'}
                </div>
            </div>`;

            // Last operation
            if (state.last_operation && state.last_operation.operation_id) {
                const op = state.last_operation;
                const opColor = op.status === 'ok' ? 'var(--success)' : op.status === 'failed' ? 'var(--danger)' : 'var(--warning)';
                html += `<div style="padding:10px 14px;border-radius:var(--radius-sm);background:var(--bg-secondary);border-left:3px solid ${opColor};margin-bottom:var(--space-md)">
                    <div style="font-size:0.78rem;font-weight:600">Last Operation</div>
                    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:4px;font-size:0.74rem">
                        <span>ğŸ”§ <strong>${esc(op.automation || 'â€”')}</strong></span>
                        <span style="color:${opColor}">${esc(op.status)}</span>
                        <span>${op.actions_succeeded}/${op.actions_total} succeeded</span>
                    </div>
                    <div style="font-size:0.62rem;color:var(--text-muted);margin-top:4px;font-family:var(--font-mono)">ID: ${esc(op.operation_id)}</div>
                </div>`;
            }

            // Modules
            const modules = state.modules || {};
            const moduleNames = Object.keys(modules);
            if (moduleNames.length) {
                html += `<div style="font-size:0.78rem;font-weight:600;margin-bottom:8px">ğŸ“¦ Modules (${moduleNames.length})</div>`;
                for (const name of moduleNames) {
                    const m = modules[name];
                    const detected = m.detected ? 'âœ…' : 'âŒ';
                    const statusColor = m.last_action_status === 'ok' ? 'var(--success)' : m.last_action_status === 'failed' ? 'var(--danger)' : 'var(--text-muted)';
                    html += `<div style="padding:6px 10px;margin-bottom:3px;border-radius:var(--radius-sm);background:var(--bg-secondary);font-size:0.74rem;display:flex;align-items:center;gap:8px">
                        <span>${detected}</span>
                        <strong>${esc(name)}</strong>
                        ${m.stack ? `<span style="font-size:0.66rem;color:var(--accent);background:rgba(99,102,241,0.08);padding:1px 5px;border-radius:3px">${esc(m.stack)}</span>` : ''}
                        ${m.version ? `<span style="font-size:0.66rem;color:var(--text-muted)">v${esc(m.version)}</span>` : ''}
                        ${m.last_action_status ? `<span style="font-size:0.66rem;color:${statusColor};margin-left:auto">${esc(m.last_action_status)}</span>` : ''}
                    </div>`;
                }
            } else {
                html += `<div style="font-size:0.74rem;color:var(--text-muted);padding:8px">No modules in state yet. Run <code>detect</code> first.</div>`;
            }

            // Adapters
            const adapters = state.adapters || {};
            const adapterNames = Object.keys(adapters);
            if (adapterNames.length) {
                html += `<div style="font-size:0.78rem;font-weight:600;margin:12px 0 8px">ğŸ”Œ Adapters (${adapterNames.length})</div>`;
                for (const name of adapterNames) {
                    const a = adapters[name];
                    const avail = a.available ? 'ğŸŸ¢' : 'ğŸ”´';
                    html += `<div style="padding:6px 10px;margin-bottom:3px;border-radius:var(--radius-sm);background:var(--bg-secondary);font-size:0.74rem;display:flex;align-items:center;gap:8px">
                        <span>${avail}</span>
                        <strong>${esc(name)}</strong>
                        ${a.version ? `<span style="font-size:0.66rem;color:var(--text-muted)">v${esc(a.version)}</span>` : ''}
                        <span style="font-size:0.66rem;color:var(--text-muted);margin-left:auto">circuit: ${esc(a.circuit_state || 'closed')}</span>
                    </div>`;
                }
            }

            previewEl.innerHTML = html;
            _debugViewMode.state = 'preview';
            _updateDebugToggles('state', 'preview');
        } catch (e) {
            previewEl.innerHTML = `<div style="color:var(--danger);font-size:0.82rem">Error: ${esc(e.message)}</div>`;
        }
    }

    // â”€â”€ Health Details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadDebugHealth() {
        const previewEl = document.getElementById('debug-health-preview');
        previewEl.innerHTML = '<span class="spinner"></span> Loading healthâ€¦';
        try {
            const data = await api('/health');
            _debugData.health = data;

            const statusIcons = { healthy: 'ğŸ’š', degraded: 'ğŸŸ¡', unhealthy: 'ğŸ”´', unknown: 'â”' };
            const statusColors = { healthy: 'var(--success)', degraded: 'var(--warning)', unhealthy: 'var(--danger)', unknown: 'var(--text-muted)' };

            let html = '';

            // Overall status banner
            html += `<div style="padding:14px 18px;border-radius:var(--radius-md);background:var(--bg-secondary);border-left:4px solid ${statusColors[data.status] || 'var(--text-muted)'};margin-bottom:var(--space-md)">
                <div style="font-size:1rem;font-weight:700;display:flex;align-items:center;gap:8px">
                    ${statusIcons[data.status] || 'â”'} System: ${esc((data.status || 'unknown').toUpperCase())}
                </div>
                <div style="font-size:0.72rem;color:var(--text-muted);margin-top:4px">${data.timestamp ? new Date(data.timestamp).toLocaleString() : 'â€”'}</div>
            </div>`;

            // Components
            const components = data.components || [];
            if (components.length) {
                html += `<div style="font-size:0.78rem;font-weight:600;margin-bottom:8px">ğŸ§© Components (${components.length})</div>`;
                for (const c of components) {
                    const cIcon = statusIcons[c.status] || 'â”';
                    const cColor = statusColors[c.status] || 'var(--text-muted)';
                    html += `<div style="padding:10px 14px;margin-bottom:6px;border-radius:var(--radius-sm);background:var(--bg-secondary);border-left:3px solid ${cColor}">
                        <div style="display:flex;align-items:center;gap:8px">
                            <span>${cIcon}</span>
                            <strong style="font-size:0.78rem">${esc(c.name)}</strong>
                            <span style="font-size:0.66rem;color:${cColor};margin-left:auto">${esc(c.status)}</span>
                        </div>
                        <div style="font-size:0.72rem;color:var(--text-muted);margin-top:4px">${esc(c.message || 'â€”')}</div>`;

                    // Component details
                    if (c.details && Object.keys(c.details).length) {
                        const detailEntries = Object.entries(c.details).filter(([k]) => k !== 'items');
                        if (detailEntries.length) {
                            html += `<div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:6px;font-size:0.68rem;color:var(--text-muted)">`;
                            for (const [key, val] of detailEntries) {
                                html += `<span><strong>${esc(key)}:</strong> ${esc(String(val))}</span>`;
                            }
                            html += `</div>`;
                        }

                        // Items (retry queue items, etc.)
                        if (c.details.items && c.details.items.length) {
                            html += `<div style="margin-top:6px;padding:6px 8px;border-radius:var(--radius-sm);background:var(--bg-primary);font-size:0.68rem;max-height:120px;overflow-y:auto">`;
                            for (const item of c.details.items) {
                                html += `<div style="margin-bottom:2px;font-family:var(--font-mono)">${esc(typeof item === 'string' ? item : JSON.stringify(item))}</div>`;
                            }
                            html += `</div>`;
                        }
                    }

                    html += `</div>`;
                }
            }

            previewEl.innerHTML = html;
            _debugViewMode.health = 'preview';
            _updateDebugToggles('health', 'preview');
        } catch (e) {
            previewEl.innerHTML = `<div style="color:var(--danger);font-size:0.82rem">Error: ${esc(e.message)}</div>`;
        }
    }

    // â”€â”€ Configuration â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadDebugConfig() {
        const previewEl = document.getElementById('debug-config-preview');
        previewEl.innerHTML = '<span class="spinner"></span> Loading configâ€¦';
        try {
            const [statusData, stacksData, vaultData] = await Promise.all([
                api('/status'),
                api('/stacks'),
                api('/vault/status').catch(() => null),
            ]);

            const config = {
                project: statusData.project,
                modules: statusData.modules,
                environments: statusData.environments,
                stacks: Object.keys(stacksData),
                vault: vaultData,
            };
            _debugData.config = config;

            let html = '';

            // Project
            const p = config.project || {};
            html += `<div style="padding:12px 16px;border-radius:var(--radius-md);background:var(--bg-secondary);margin-bottom:var(--space-md)">
                <div style="font-size:0.82rem;font-weight:700">${esc(p.name || '(unknown)')}</div>
                ${p.description ? `<div style="font-size:0.72rem;color:var(--text-muted);margin-top:2px">${esc(p.description)}</div>` : ''}
                ${p.repository ? `<div style="font-size:0.72rem;color:var(--accent);margin-top:2px">ğŸ“¦ ${esc(p.repository)}</div>` : ''}
            </div>`;

            // Modules
            const modules = config.modules || statusData.modules || [];
            if (modules.length) {
                html += `<div style="font-size:0.78rem;font-weight:600;margin-bottom:8px">ğŸ“¦ Modules (${modules.length})</div>`;
                for (const m of modules) {
                    html += `<div style="padding:6px 10px;margin-bottom:3px;border-radius:var(--radius-sm);background:var(--bg-secondary);font-size:0.74rem;display:flex;align-items:center;gap:8px">
                        <strong>${esc(m.name || 'â€”')}</strong>
                        ${m.stack ? `<span style="font-size:0.66rem;color:var(--accent);background:rgba(99,102,241,0.08);padding:1px 5px;border-radius:3px">${esc(m.stack)}</span>` : ''}
                        ${m.domain ? `<span style="font-size:0.66rem;color:var(--text-muted)">(${esc(m.domain)})</span>` : ''}
                        <span style="font-size:0.66rem;color:var(--text-muted);margin-left:auto;font-family:var(--font-mono)">${esc(m.path || '')}</span>
                    </div>`;
                }
            }

            // Environments
            const envs = config.environments || [];
            if (envs.length) {
                html += `<div style="font-size:0.78rem;font-weight:600;margin:12px 0 8px">ğŸŒ Environments (${envs.length})</div>`;
                for (const e of envs) {
                    html += `<div style="padding:6px 10px;margin-bottom:3px;border-radius:var(--radius-sm);background:var(--bg-secondary);font-size:0.74rem;display:flex;align-items:center;gap:8px">
                        <strong>${esc(e.name || 'â€”')}</strong>
                        ${e.default ? `<span style="font-size:0.62rem;color:var(--success);background:rgba(52,211,153,0.1);padding:1px 5px;border-radius:3px">default</span>` : ''}
                    </div>`;
                }
            }

            // Stacks
            const stacks = config.stacks || [];
            if (stacks.length) {
                html += `<div style="font-size:0.78rem;font-weight:600;margin:12px 0 8px">ğŸ“š Stacks (${stacks.length})</div>`;
                html += `<div style="display:flex;flex-wrap:wrap;gap:6px">`;
                for (const s of stacks) {
                    html += `<span style="font-size:0.72rem;padding:3px 8px;border-radius:var(--radius-sm);background:var(--bg-secondary);border:1px solid var(--border-subtle)">${esc(s)}</span>`;
                }
                html += `</div>`;
            }

            // Vault
            if (config.vault) {
                html += `<div style="font-size:0.78rem;font-weight:600;margin:12px 0 8px">ğŸ” Vault</div>`;
                const v = config.vault;
                html += `<div style="padding:8px 12px;border-radius:var(--radius-sm);background:var(--bg-secondary);font-size:0.74rem">
                    Status: <strong style="color:${v.locked ? 'var(--danger)' : 'var(--success)'}">${v.locked ? 'ğŸ”’ Locked' : 'ğŸ”“ Unlocked'}</strong>
                    ${v.secrets_count !== undefined ? ` Â· ${v.secrets_count} secrets` : ''}
                </div>`;
            }

            previewEl.innerHTML = html;
            _debugViewMode.config = 'preview';
            _updateDebugToggles('config', 'preview');
        } catch (e) {
            previewEl.innerHTML = `<div style="color:var(--danger);font-size:0.82rem">Error: ${esc(e.message)}</div>`;
        }
    }

    // â”€â”€ View toggle helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function _updateDebugToggles(panel, mode) {
        document.querySelectorAll(`.debug-view-toggle[data-panel="${panel}"]`).forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
    }
</script>