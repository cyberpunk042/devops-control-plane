<script>
    // â”€â”€ Dashboard tab logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let moduleList = [];
    let environmentList = [];
    let capabilityData = {};

    async function loadStatus() {
        try {
            showRefreshBar();
            const cached = cardCached('dash-status');
            const data = cached || await api('/status');
            if (!cached) cardStore('dash-status', data);

            document.getElementById('project-name').textContent = data.project.name || 'â€”';
            document.getElementById('project-desc').textContent = data.project.description || '';
            if (data.project.repository) updateGhMenu(data.project.repository);

            moduleList = data.modules || [];
            document.getElementById('module-count').textContent = moduleList.length;
            const domains = [...new Set(moduleList.map(m => m.domain))];
            document.getElementById('module-summary').textContent = domains.join(', ');

            const op = data.state?.last_operation || {};
            if (op.automation) {
                document.getElementById('last-op-name').textContent = op.automation;
                const badge = op.status === 'ok' ? 'âœ“' : op.status === 'failed' ? 'âœ—' : 'âŠ˜';
                document.getElementById('last-op-detail').textContent =
                    `${badge} ${op.actions_succeeded}/${op.actions_total} succeeded`;
            } else {
                document.getElementById('last-op-name').textContent = 'â€”';
                document.getElementById('last-op-detail').textContent = 'No operations yet';
            }

            environmentList = data.environments || [];
            document.getElementById('env-count').textContent = environmentList.length;
            document.getElementById('env-list').textContent = environmentList.map(e => e.name).join(', ');

            populateEnvSelect(environmentList);
            renderModules(moduleList, data.state?.modules || {});

        } catch (e) {
            console.error('Failed to load status:', e);
        } finally {
            hideRefreshBar();
        }
    }

    function populateEnvSelect(envs) {
        const sel = document.getElementById('run-env');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '';
        envs.forEach(e => {
            sel.innerHTML += `<option value="${esc(e.name)}"${e.default ? ' selected' : ''}>${esc(e.name)}</option>`;
        });
        if (current) sel.value = current;
    }

    function renderModules(modules, moduleStates) {
        const container = document.getElementById('module-list');
        if (!modules.length) {
            container.innerHTML = `<div class="module-item" style="justify-content:center;color:var(--text-muted)">
            No modules found â€” click <strong>Re-Detect</strong> above to scan your project.
        </div>`;
            return;
        }

        // Stack icons from the data layer (defined in stacks/*/stack.yml)
        const _dcpStacks = (window._dcp && window._dcp.stacks) || [];
        function _stackIcon(name) {
            var s = _dcpStacks.find(function(s) { return s.name === name; });
            return s && s.icon ? s.icon : 'ğŸ“';
        }

        // Find which capabilities each module supports
        const moduleCaps = {};
        for (const [capName, capInfo] of Object.entries(capabilityData)) {
            for (const m of capInfo.modules) {
                if (!moduleCaps[m.module]) moduleCaps[m.module] = [];
                moduleCaps[m.module].push(capName);
            }
        }

        container.innerHTML = modules.map(m => {
            const icon = _stackIcon(m.stack);
            const state = moduleStates[m.name] || {};
            const lastStatus = state.last_action_status || '';
            const statusClass = lastStatus === 'ok' ? 'ok' : lastStatus === 'failed' ? 'failed' : '';
            const statusBadge = statusClass
                ? `<span class="status-badge ${statusClass}" style="font-size:0.7rem;padding:2px 8px;"><span class="status-dot"></span>${esc(lastStatus)}</span>`
                : '';

            const caps = moduleCaps[m.name] || [];
            const capsHtml = caps.length > 0
                ? `<div class="module-caps">${caps.map(c => `<span class="module-cap-tag">${esc(c)}</span>`).join('')}</div>`
                : `<div class="module-caps"><span class="module-cap-tag" style="opacity:0.4">no capabilities</span></div>`;

            return `<div class="module-item">
            <div class="module-icon">${icon}</div>
            <div class="module-info">
                <div class="module-name">${esc(m.name)} ${statusBadge}</div>
                <div class="module-meta">
                    <span title="Stack">${esc(m.stack)}</span>
                    <span title="Domain">${esc(m.domain)}</span>
                    <span title="Path">${esc(m.path)}</span>
                </div>
                ${capsHtml}
            </div>
        </div>`;
        }).join('');
    }

    async function loadHealth() {
        try {
            const cached = cardCached('dash-health');
            const data = cached || await api('/health');            
            if (!cached) cardStore('dash-health', data);
            const badge = document.getElementById('health-badge');
            const statusMap = {
                'healthy': ['ok', 'Healthy'],
                'degraded': ['degraded', 'Degraded'],
                'unhealthy': ['unhealthy', 'Unhealthy'],
            };
            const [cls, label] = statusMap[data.status] || ['', data.status];
            badge.className = `status-badge ${cls}`;
            badge.innerHTML = `<span class="status-dot"></span><span>${label}</span>`;
        } catch (e) {
            console.error('Failed to load health:', e);
        }
    }

    async function loadAudit() {
        try {
            const cached = cardCached('dash-audit');
            const data = cached || await api('/audit?n=10');
            if (!cached) cardStore('dash-audit', data);
            const container = document.getElementById('activity-list');

            if (!data.entries || !data.entries.length) {
                container.innerHTML = `<div class="activity-item" style="color:var(--text-muted)">
                No activity yet. Run a command from the <strong>Commands</strong> tab to see results here.
            </div>`;
                return;
            }

            container.innerHTML = data.entries.reverse().map(entry => {
                const statusClass = entry.status === 'ok' ? 'ok' : entry.status === 'failed' ? 'failed' : 'partial';
                const time = new Date(entry.timestamp).toLocaleString();
                const modules = (entry.modules_affected || []).join(', ');

                return `<div class="activity-item">
                <span class="activity-time">${time}</span>
                <span class="activity-action">
                    <span class="status-badge ${statusClass}" style="font-size:0.7rem;padding:2px 8px;">
                        <span class="status-dot"></span>${esc(entry.status)}
                    </span>
                </span>
                <span class="activity-detail">
                    <strong>${esc(entry.automation)}</strong> â†’ ${esc(modules || 'all modules')} Â· ${entry.actions_succeeded}/${entry.actions_total} succeeded
                </span>
            </div>`;
            }).join('');

        } catch (e) {
            console.error('Failed to load audit:', e);
        }
    }

    async function runDetect() {
        try {
            toast('Scanning for modules...', 'success');
            await api('/detect', { method: 'POST' });
            toast('Module detection complete!', 'success');
            await loadStatus();
        } catch (e) {
            toast(e.message, 'error');
        }
    }

    // â”€â”€ Project Health Score Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadHealthScore() {
        const badge = document.getElementById('health-score-badge');
        const detail = document.getElementById('health-score-detail');
        const cached = cardCached('health-score');
        const data = cached || await api('/metrics/health').catch(e => ({ _err: e }));
        if (data._err) {
            badge.className = 'status-badge failed';
            badge.innerHTML = '<span class="status-dot"></span>Error';
            detail.innerHTML = `<p class="empty-state-sm" style="color:var(--error)">${esc(data._err.message)}</p>`;
            return;
        }
        if (!cached) cardStore('health-score', data);

        const score = data.score || 0;
        const grade = data.grade || '?';
        const probes = data.probes || {};
        const recs = data.recommendations || [];

        // Grade color
        const gradeColors = { A: '#22c55e', B: '#84cc16', C: '#eab308', D: '#f97316', F: '#ef4444' };
        const gradeColor = gradeColors[grade] || 'var(--text-muted)';

        // Badge
        badge.className = 'status-badge ' + (score >= 75 ? 'ok' : score >= 50 ? 'degraded' : 'failed');
        badge.innerHTML = `<span class="status-dot"></span>${grade} (${score})`;

        // Probe labels
        const probeLabels = {
            git: 'ğŸŒ¿ Git',
            docker: 'ğŸ³ Docker',
            ci: 'ğŸ”„ CI/CD',
            packages: 'ğŸ“¦ Packages',
            env: 'âš™ï¸ Environment',
            quality: 'ğŸ”§ Quality',
            structure: 'ğŸ—ï¸ Structure',
        };

        let html = `<div style="display:flex;gap:var(--space-xl);flex-wrap:wrap;align-items:flex-start">`;

        // â”€â”€ Score circle â”€â”€
        const circumference = 2 * Math.PI * 54;
        const offset = circumference - (score / 100) * circumference;
        html += `<div style="flex-shrink:0;text-align:center">
            <svg width="130" height="130" viewBox="0 0 120 120">
                <circle cx="60" cy="60" r="54" fill="none" stroke="var(--border-subtle)" stroke-width="8"></circle>
                <circle cx="60" cy="60" r="54" fill="none" stroke="${gradeColor}" stroke-width="8"
                    stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                    stroke-linecap="round" transform="rotate(-90 60 60)"
                    style="transition:stroke-dashoffset 0.8s ease"></circle>
                <text x="60" y="52" text-anchor="middle" fill="${gradeColor}" font-size="32" font-weight="800">${grade}</text>
                <text x="60" y="72" text-anchor="middle" fill="var(--text-secondary)" font-size="13">${score}/100</text>
            </svg>
        </div>`;

        // â”€â”€ Probe bars â”€â”€
        html += `<div style="flex:1;min-width:220px">`;
        html += `<div style="font-size:0.82rem;font-weight:600;color:var(--text-primary);margin-bottom:var(--space-sm)">Domain Scores</div>`;

        const probeOrder = ['git', 'docker', 'ci', 'packages', 'env', 'quality', 'structure'];
        probeOrder.forEach(key => {
            const probe = probes[key];
            if (!probe) return;
            const pScore = probe.score || 0;
            const pColor = pScore >= 75 ? '#22c55e' : pScore >= 50 ? '#eab308' : '#ef4444';
            const label = probeLabels[key] || key;
            html += `<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.35rem;font-size:0.72rem">
                <span style="min-width:90px;color:var(--text-secondary)">${label}</span>
                <div style="flex:1;height:6px;background:var(--border-subtle);border-radius:3px;overflow:hidden">
                    <div style="width:${pScore}%;height:100%;background:${pColor};border-radius:3px;transition:width 0.6s ease"></div>
                </div>
                <span style="min-width:28px;text-align:right;font-family:var(--font-mono);font-weight:600;color:${pColor}">${pScore}</span>
            </div>`;
        });
        html += `</div>`;

        html += `</div>`; // close flex row

        // â”€â”€ Recommendations â”€â”€
        if (recs.length) {
            html += `<div style="margin-top:var(--space-md);border-top:1px solid var(--border-subtle);padding-top:var(--space-md)">
                <div style="font-size:0.78rem;font-weight:600;color:var(--text-primary);margin-bottom:var(--space-xs)">ğŸ’¡ Recommendations</div>`;
            recs.slice(0, 5).forEach((r, i) => {
                html += `<div style="font-size:0.72rem;color:var(--text-secondary);padding:0.2rem 0;display:flex;gap:0.4rem">
                    <span style="color:var(--accent);font-weight:600">${i + 1}.</span>
                    <span>${esc(r)}</span>
                </div>`;
            });
            if (recs.length > 5) {
                html += `<div style="font-size:0.68rem;color:var(--text-muted);margin-top:0.2rem">â€¦and ${recs.length - 5} more</div>`;
            }
            html += `</div>`;
        }

        detail.innerHTML = html;
    }

    // â”€â”€ Setup Progress Widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadSetupProgress() {
        const badge = document.getElementById('setup-progress-badge');
        const content = document.getElementById('setup-progress-content');
        if (!badge || !content) return;

        try {
            const cached = cardCached('project-status');
            const data = cached || await api('/project/status');
            if (!cached) cardStore('project-status', data);
            const { integrations, suggested_next } = data;

            // Use in-memory cached prefs (no API call if already fetched)
            let prefs = {};
            try { prefs = await _fetchDevopsPrefs(); } catch (_) {}

            // Integration items
            const integrationMeta = {
                git:       { icon: 'ğŸ”€', label: 'Git Repository', wizKey: 'git' },
                docker:    { icon: 'ğŸ³', label: 'Docker',         wizKey: 'docker' },
                github:    { icon: 'ğŸ™', label: 'GitHub',         wizKey: 'github' },
                cicd:      { icon: 'âš¡', label: 'CI/CD Pipeline', wizKey: 'cicd' },
                k8s:       { icon: 'â˜¸ï¸', label: 'Kubernetes',      wizKey: 'k8s' },
                terraform: { icon: 'ğŸ—ï¸', label: 'Terraform',      wizKey: 'terraform' },
                pages:     { icon: 'ğŸ“„', label: 'Pages',          wizKey: 'pages' },
                dns:       { icon: 'ğŸŒ', label: 'DNS / Domain',   wizKey: 'dns' },
            };

            const statusIcons = { ready: 'âœ…', partial: 'ğŸ”¶', missing: 'â¬œ' };
            const statusLabels = { ready: 'Ready', partial: 'Partial', missing: 'Not set up' };
            const statusColors = { ready: 'var(--success)', partial: 'var(--warning)', missing: 'var(--text-muted)' };

            // Filter to visible integrations only
            const order = ['git', 'docker', 'github', 'cicd', 'k8s', 'terraform', 'pages', 'dns'];
            const visible = order.filter(k => prefs[k] !== 'hidden' && prefs['int:' + k] !== 'hidden');

            // Recalculate progress from visible integrations
            const visibleComplete = visible.filter(k => (integrations[k] || {}).status === 'ready').length;
            const visibleTotal = visible.length;
            const pct = visibleTotal > 0 ? Math.round((visibleComplete / visibleTotal) * 100) : 100;

            // Pick suggestion: backend's if visible, else first visible incomplete
            let suggestion = suggested_next;
            if (suggestion && (prefs[suggestion] === 'hidden' || prefs['int:' + suggestion] === 'hidden')) {
                suggestion = visible.find(k => (integrations[k] || {}).status !== 'ready') || null;
            }

            // Progress badge
            if (pct >= 100) {
                badge.className = 'status-badge ok';
                badge.innerHTML = '<span class="status-dot"></span>Complete';
            } else {
                badge.className = 'status-badge degraded';
                badge.innerHTML = `<span class="status-dot"></span>${visibleComplete}/${visibleTotal}`;
            }

            let html = '';

            // Progress bar
            const barColor = pct >= 80 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--accent)';
            html += `<div style="margin-bottom:var(--space-lg)">
                <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted);margin-bottom:4px">
                    <span>Setup progress</span>
                    <span>${pct}%</span>
                </div>
                <div style="height:6px;background:var(--border-subtle);border-radius:3px;overflow:hidden">
                    <div style="width:${pct}%;height:100%;background:${barColor};border-radius:3px;transition:width 0.6s ease"></div>
                </div>
            </div>`;

            // Integration list (visible only)
            html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px">';

            for (const key of visible) {
                const meta = integrationMeta[key];
                const info = integrations[key] || {};
                const st = info.status || 'missing';
                const isSuggested = key === suggestion;

                html += `<div style="
                    display:flex;align-items:center;gap:0.6rem;
                    padding:0.5rem 0.75rem;border-radius:var(--radius-sm);
                    border:1px solid ${isSuggested ? 'var(--accent)' : 'var(--border-subtle)'};
                    background:${isSuggested ? 'var(--accent-glow)' : 'transparent'};
                    transition:all 0.15s ease;
                ">
                    <span style="font-size:1rem;width:24px;text-align:center">${statusIcons[st]}</span>
                    <span style="font-size:1rem">${meta.icon}</span>
                    <span style="flex:1;font-size:0.82rem;font-weight:500;color:var(--text-primary)">${esc(meta.label)}</span>
                    <span style="font-size:0.68rem;font-weight:600;color:${statusColors[st]}">${statusLabels[st]}</span>
                    ${st !== 'ready' && meta.wizKey
                        ? `<button class="btn btn-sm ${isSuggested ? 'btn-primary' : 'btn-secondary'}"
                            onclick="openSetupWizard('${meta.wizKey}')"
                            style="font-size:0.68rem;padding:2px 8px"
                            >${isSuggested ? 'Set up â†’' : 'Setup'}</button>`
                        : ''
                    }
                </div>`;
            }

            html += '</div>';

            // Suggested next hint
            if (suggestion && integrationMeta[suggestion]) {
                const next = integrationMeta[suggestion];
                html += `<div style="
                    margin-top:var(--space-md);padding:var(--space-sm) var(--space-md);
                    background:var(--accent-glow);border:1px solid var(--accent);border-radius:var(--radius-sm);
                    font-size:0.78rem;color:var(--accent);display:flex;align-items:center;gap:0.5rem;
                ">
                    <span>ğŸ’¡</span>
                    <span>Suggested next: <strong>${esc(next.label)}</strong></span>
                    ${next.wizKey
                        ? `<button class="btn btn-sm btn-primary" onclick="openSetupWizard('${next.wizKey}')" style="margin-left:auto;font-size:0.68rem">Set up ${esc(next.label)} â†’</button>`
                        : ''
                    }
                </div>`;
            }

            // All complete message
            if (pct >= 100) {
                html += `<div style="
                    margin-top:var(--space-md);padding:var(--space-md);
                    background:var(--success-bg);border:1px solid var(--success);border-radius:var(--radius-sm);
                    font-size:0.82rem;color:var(--success);text-align:center;
                ">
                    ğŸ‰ All integrations configured! Your DevOps pipeline is ready.
                </div>`;
            }

            content.innerHTML = html;

        } catch (e) {
            console.warn('Setup progress load failed:', e);
            content.innerHTML = `<p style="color:var(--text-muted);font-size:0.82rem">Could not load setup status.</p>`;
        }
    }

</script>