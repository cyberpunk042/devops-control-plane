<script>
    // ‚îÄ‚îÄ Dashboard tab logic ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    let moduleList = [];
    let environmentList = [];
    let capabilityData = {};

    async function loadStatus() {
        try {
            showRefreshBar();
            const data = await api('/status');

            document.getElementById('project-name').textContent = data.project.name || '‚Äî';
            document.getElementById('project-desc').textContent = data.project.description || '';

            moduleList = data.modules || [];
            document.getElementById('module-count').textContent = moduleList.length;
            const domains = [...new Set(moduleList.map(m => m.domain))];
            document.getElementById('module-summary').textContent = domains.join(', ');

            const op = data.state?.last_operation || {};
            if (op.automation) {
                document.getElementById('last-op-name').textContent = op.automation;
                const badge = op.status === 'ok' ? '‚úì' : op.status === 'failed' ? '‚úó' : '‚äò';
                document.getElementById('last-op-detail').textContent =
                    `${badge} ${op.actions_succeeded}/${op.actions_total} succeeded`;
            } else {
                document.getElementById('last-op-name').textContent = '‚Äî';
                document.getElementById('last-op-detail').textContent = 'No operations yet';
            }

            environmentList = data.environments || [];
            document.getElementById('env-count').textContent = environmentList.length;
            document.getElementById('env-list').textContent = environmentList.map(e => e.name).join(', ');

            populateEnvSelect(environmentList);
            renderModules(moduleList, data.state?.modules || {});

        } catch (e) {
            console.error('Failed to load status:', e);
        } finally {
            hideRefreshBar();
        }
    }

    function populateEnvSelect(envs) {
        const sel = document.getElementById('run-env');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '';
        envs.forEach(e => {
            sel.innerHTML += `<option value="${esc(e.name)}"${e.default ? ' selected' : ''}>${esc(e.name)}</option>`;
        });
        if (current) sel.value = current;
    }

    function renderModules(modules, moduleStates) {
        const container = document.getElementById('module-list');
        if (!modules.length) {
            container.innerHTML = `<div class="module-item" style="justify-content:center;color:var(--text-muted)">
            No modules found ‚Äî click <strong>Re-Detect</strong> above to scan your project.
        </div>`;
            return;
        }

        const stackIcons = {
            'python': 'üêç', 'python-lib': 'üêç', 'python-cli': 'üêç', 'python-flask': 'üêç',
            'node': 'üì¶', 'docker-compose': 'üê≥', 'markdown': 'üìù',
        };

        // Find which capabilities each module supports
        const moduleCaps = {};
        for (const [capName, capInfo] of Object.entries(capabilityData)) {
            for (const m of capInfo.modules) {
                if (!moduleCaps[m.module]) moduleCaps[m.module] = [];
                moduleCaps[m.module].push(capName);
            }
        }

        container.innerHTML = modules.map(m => {
            const icon = stackIcons[m.stack] || 'üìÅ';
            const state = moduleStates[m.name] || {};
            const lastStatus = state.last_action_status || '';
            const statusClass = lastStatus === 'ok' ? 'ok' : lastStatus === 'failed' ? 'failed' : '';
            const statusBadge = statusClass
                ? `<span class="status-badge ${statusClass}" style="font-size:0.7rem;padding:2px 8px;"><span class="status-dot"></span>${esc(lastStatus)}</span>`
                : '';

            const caps = moduleCaps[m.name] || [];
            const capsHtml = caps.length > 0
                ? `<div class="module-caps">${caps.map(c => `<span class="module-cap-tag">${esc(c)}</span>`).join('')}</div>`
                : `<div class="module-caps"><span class="module-cap-tag" style="opacity:0.4">no capabilities</span></div>`;

            return `<div class="module-item">
            <div class="module-icon">${icon}</div>
            <div class="module-info">
                <div class="module-name">${esc(m.name)} ${statusBadge}</div>
                <div class="module-meta">
                    <span title="Stack">${esc(m.stack)}</span>
                    <span title="Domain">${esc(m.domain)}</span>
                    <span title="Path">${esc(m.path)}</span>
                </div>
                ${capsHtml}
            </div>
        </div>`;
        }).join('');
    }

    async function loadHealth() {
        try {
            const data = await api('/health');
            const badge = document.getElementById('health-badge');
            const statusMap = {
                'healthy': ['ok', 'Healthy'],
                'degraded': ['degraded', 'Degraded'],
                'unhealthy': ['unhealthy', 'Unhealthy'],
            };
            const [cls, label] = statusMap[data.status] || ['', data.status];
            badge.className = `status-badge ${cls}`;
            badge.innerHTML = `<span class="status-dot"></span><span>${label}</span>`;
        } catch (e) {
            console.error('Failed to load health:', e);
        }
    }

    async function loadAudit() {
        try {
            const data = await api('/audit?n=10');
            const container = document.getElementById('activity-list');

            if (!data.entries || !data.entries.length) {
                container.innerHTML = `<div class="activity-item" style="color:var(--text-muted)">
                No activity yet. Run a command from the <strong>Commands</strong> tab to see results here.
            </div>`;
                return;
            }

            container.innerHTML = data.entries.reverse().map(entry => {
                const statusClass = entry.status === 'ok' ? 'ok' : entry.status === 'failed' ? 'failed' : 'partial';
                const time = new Date(entry.timestamp).toLocaleString();
                const modules = (entry.modules_affected || []).join(', ');

                return `<div class="activity-item">
                <span class="activity-time">${time}</span>
                <span class="activity-action">
                    <span class="status-badge ${statusClass}" style="font-size:0.7rem;padding:2px 8px;">
                        <span class="status-dot"></span>${esc(entry.status)}
                    </span>
                </span>
                <span class="activity-detail">
                    <strong>${esc(entry.automation)}</strong> ‚Üí ${esc(modules || 'all modules')} ¬∑ ${entry.actions_succeeded}/${entry.actions_total} succeeded
                </span>
            </div>`;
            }).join('');

        } catch (e) {
            console.error('Failed to load audit:', e);
        }
    }

    async function runDetect() {
        try {
            toast('Scanning for modules...', 'success');
            await api('/detect', { method: 'POST' });
            toast('Module detection complete!', 'success');
            await loadStatus();
        } catch (e) {
            toast(e.message, 'error');
        }
    }
</script>