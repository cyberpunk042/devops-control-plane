<script>
    // â”€â”€ Dashboard tab logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let moduleList = [];
    let environmentList = [];
    let capabilityData = {};

    // â”€â”€ 1. Project Pulse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadProjectPulse() {
        const el = document.getElementById('project-pulse');
        if (!el) return;

        try {
            // Fetch status + health in parallel
            const [statusData, healthData] = await Promise.all([
                (async () => {
                    const c = cardCached('dash-status');
                    if (c) return c;
                    const d = await api('/status');
                    cardStore('dash-status', d);
                    return d;
                })(),
                (async () => {
                    const c = cardCached('dash-health');
                    if (c) return c;
                    try {
                        const d = await api('/health');
                        cardStore('dash-health', d);
                        return d;
                    } catch (_) { return { status: 'unknown' }; }
                })(),
            ]);

            // Populate shared data (used by Commands tab)
            if (statusData.project?.repository) updateGhMenu(statusData.project.repository);
            moduleList = statusData.modules || [];
            environmentList = statusData.environments || [];
            populateEnvSelect(environmentList);

            const projectName = statusData.project?.name || 'â€”';
            const moduleCount = moduleList.length;
            const envCount = environmentList.length;
            const healthStatus = healthData.status || 'unknown';

            const healthColors = {
                healthy: 'var(--success)', degraded: 'var(--warning)',
                unhealthy: 'var(--error)', unknown: 'var(--text-muted)',
            };
            const healthLabels = {
                healthy: 'â— Healthy', degraded: 'â— Degraded',
                unhealthy: 'â— Unhealthy', unknown: 'â— Unknown',
            };

            // Last operation
            const op = statusData.state?.last_operation || {};
            let lastOpHtml = '';
            if (op.automation) {
                const opIcon = op.status === 'ok' ? 'âœ“' : op.status === 'failed' ? 'âœ—' : 'âŠ˜';
                const opColor = op.status === 'ok' ? 'var(--success)' : op.status === 'failed' ? 'var(--error)' : 'var(--text-muted)';
                lastOpHtml = `
                    <span style="width:1px;height:16px;background:var(--border-subtle)"></span>
                    <span style="color:${opColor};font-size:0.78rem">${opIcon} ${esc(op.automation)} ${op.actions_succeeded}/${op.actions_total}</span>`;
            }

            // Repo link
            let repoHtml = '';
            if (statusData.project?.repository) {
                const repoUrl = statusData.project.repository.startsWith('http')
                    ? statusData.project.repository
                    : `https://${statusData.project.repository}`;
                repoHtml = `<a href="${repoUrl}" target="_blank" rel="noopener" style="color:var(--text-muted);font-size:0.72rem;text-decoration:none;opacity:0.7" title="${esc(statusData.project.repository)}">â†—</a>`;
            }

            el.innerHTML = `
                <div style="font-size:1.05rem;font-weight:700;letter-spacing:-0.02em">${esc(projectName)}</div>
                ${repoHtml}
                <span style="width:1px;height:16px;background:var(--border-subtle)"></span>
                <span style="font-size:0.78rem;color:var(--text-secondary)">ğŸ“¦ ${moduleCount} modules</span>
                <span style="font-size:0.78rem;color:var(--text-secondary)">ğŸŒ ${envCount} envs</span>
                ${lastOpHtml}
                <span style="margin-left:auto;font-weight:600;font-size:0.82rem;color:${healthColors[healthStatus]}">${healthLabels[healthStatus]}</span>
            `;
        } catch (e) {
            console.error('Failed to load project pulse:', e);
            el.innerHTML = '<span style="color:var(--text-muted);font-size:0.82rem">Could not load project info</span>';
        }
    }

    /**
     * Lightweight status fetch â€” populates moduleList/environmentList
     * for the Commands tab. No DOM rendering.
     */
    async function loadStatus() {
        try {
            const cached = cardCached('dash-status');
            const data = cached || await api('/status');
            if (!cached) cardStore('dash-status', data);
            if (data.project?.repository) updateGhMenu(data.project.repository);
            moduleList = data.modules || [];
            environmentList = data.environments || [];
            populateEnvSelect(environmentList);
        } catch (e) {
            console.error('Failed to load status:', e);
        }
    }

    function populateEnvSelect(envs) {
        const sel = document.getElementById('run-env');
        if (!sel) return;
        const current = sel.value;
        sel.innerHTML = '';
        envs.forEach(e => {
            sel.innerHTML += `<option value="${esc(e.name)}"${e.default ? ' selected' : ''}>${esc(e.name)}</option>`;
        });
        if (current) sel.value = current;
    }

    // â”€â”€ 2. Toolchain Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadToolsStatus() {
        const badge = document.getElementById('tools-status-badge');
        const content = document.getElementById('tools-status-content');
        if (!badge || !content) return;

        try {
            const cached = cardCached('tools-status');
            const data = cached || await api('/tools/status');
            if (!cached) cardStore('tools-status', data);

            // â”€â”€ D2.5: Apply dev tool overrides â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Clone tool array so the cached pristine data is never mutated
            let tools = (data.tools || []).map(t => Object.assign({}, t));
            let available = data.available || 0;
            let total = data.total || 0;
            let missingCount = data.missing_count || 0;

            const devOv = (typeof _getDevOverrides === 'function') ? _getDevOverrides() : null;
            if (devOv && devOv.tool_overrides) {
                for (const t of tools) {
                    const ov = devOv.tool_overrides[t.id];
                    if (ov === 'missing') {
                        t.available = false;
                        t._dev_override = 'forced_missing';
                    } else if (ov === 'installed') {
                        t.available = true;
                        t._dev_override = 'forced_installed';
                    }
                }
                // Recompute counts from the cloned array
                available = tools.filter(t => t.available).length;
                missingCount = tools.length - available;
            }

            // Badge
            if (missingCount === 0) {
                badge.className = 'status-badge ok';
                badge.innerHTML = '<span class="status-dot"></span>All found';
            } else {
                badge.className = 'status-badge degraded';
                badge.innerHTML = `<span class="status-dot"></span>${missingCount} missing`;
            }

            // Group by category
            const categoryOrder = ['runtime', 'vcs', 'container', 'infra', 'quality', 'security', 'network', 'system'];
            const categoryLabels = {
                runtime:   'âš¡ Runtimes',
                vcs:       'ğŸ”€ Version Control',
                container: 'ğŸ³ Containers & Orchestration',
                infra:     'ğŸ—ï¸ Infrastructure',
                quality:   'ğŸ”§ Quality & Testing',
                security:  'ğŸ›¡ï¸ Security',
                network:   'ğŸŒ Network & DNS',
                system:    'âš™ï¸ System Utilities',
            };

            const grouped = {};
            for (const t of tools) {
                const cat = t.category || 'system';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(t);
            }

            let html = `<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:var(--space-md)">${available}/${total} tools detected on this system</div>`;

            for (const cat of categoryOrder) {
                const items = grouped[cat];
                if (!items || items.length === 0) continue;

                const catLabel = categoryLabels[cat] || cat;
                const catAvailable = items.filter(t => t.available).length;
                const catTotal = items.length;
                const allGood = catAvailable === catTotal;

                if (allGood) {
                    // Collapsed â€” all present, expandable to see list
                    html += `<details style="margin-bottom:4px;border-radius:var(--radius-sm);border:1px solid var(--border-subtle)">
                        <summary style="display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0.6rem;cursor:pointer;list-style:none">
                            <span style="font-size:0.82rem">âœ…</span>
                            <span style="font-size:0.78rem;font-weight:500;color:var(--text-primary);flex:1">${catLabel}</span>
                            <span style="font-size:0.68rem;color:var(--success);font-weight:600">${catAvailable}/${catTotal}</span>
                            <span class="tool-cat-chevron" style="font-size:0.6rem;color:var(--text-muted);transition:transform 0.15s ease">â–¸</span>
                        </summary>
                        <div style="padding:0.35rem 0.6rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:4px;border-top:1px solid var(--border-subtle)">
                            ${items.map(t => `<div data-tool-id="${esc(t.id)}" style="display:flex;align-items:center;gap:0.4rem;font-size:0.75rem">
                                <span style="width:18px;text-align:center">âœ…</span>
                                <span style="color:var(--text-secondary);font-weight:500">${esc(t.label)}</span>
                                <span style="font-family:var(--font-mono);font-size:0.62rem;color:var(--text-muted)">${esc(t.cli)}</span>
                            </div>`).join('')}
                        </div>
                    </details>`;
                } else {
                    // Expanded â€” show details for categories with missing tools
                    html += `<div style="margin-bottom:var(--space-sm);border:1px solid hsla(38,92%,55%,0.15);border-radius:var(--radius-sm);overflow:hidden">`;
                    html += `<div style="display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0.6rem;background:var(--warning-bg)">
                        <span style="font-size:0.82rem">âš ï¸</span>
                        <span style="font-size:0.78rem;font-weight:500;color:var(--text-primary);flex:1">${catLabel}</span>
                        <span style="font-size:0.68rem;color:var(--warning);font-weight:600">${catAvailable}/${catTotal}</span>
                    </div>`;
                    html += `<div style="padding:0.35rem 0.6rem;display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:4px">`;
                    for (const t of items) {
                        const icon = t.available ? 'âœ…' : 'âŒ';
                        const nameColor = t.available ? 'var(--text-secondary)' : 'var(--text-primary)';

                        let actionHtml = '';
                        if (!t.available) {
                            actionHtml = `<button class="btn btn-sm btn-secondary" onclick="installTool('${esc(t.id)}','${esc(t.cli)}')" style="font-size:0.62rem;padding:1px 6px;margin-left:auto">Install</button>`;
                        }
                        if (t._dev_override) {
                            actionHtml += `<span style="font-size:0.55rem;color:hsl(280,70%,60%)" title="Dev override: ${esc(t._dev_override)}">ğŸ”§</span>`;
                        }

                        html += `<div data-tool-id="${esc(t.id)}" style="display:flex;align-items:center;gap:0.4rem;font-size:0.75rem">
                            <span style="width:18px;text-align:center">${icon}</span>
                            <span style="color:${nameColor};font-weight:500">${esc(t.label)}</span>
                            <span style="font-family:var(--font-mono);font-size:0.62rem;color:var(--text-muted)">${esc(t.cli)}</span>
                            ${actionHtml}
                        </div>`;
                    }
                    html += `</div></div>`;
                }
            }

            content.innerHTML = html;

        } catch (e) {
            console.warn('Tools status load failed:', e);
            badge.className = 'status-badge failed';
            badge.innerHTML = '<span class="status-dot"></span>Error';
            content.innerHTML = '<p style="color:var(--text-muted);font-size:0.82rem">Could not load tool status.</p>';
        }
    }

    async function installTool(toolId, cli) {
        const cached = cardCached('tools-status');
        const tool = cached ? (cached.tools || []).find(t => t.id === toolId) : null;
        const toolLabel = (tool && tool.label) || toolId;

        installWithPlan(toolId, toolLabel, {
            onComplete: function() {
                cardStore('tools-status', null);
                loadToolsStatus();
            },
        });
    }


    // â”€â”€ 3. Integration Progress (Setup Progress â€” unchanged) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadSetupProgress() {
        const badge = document.getElementById('setup-progress-badge');
        const content = document.getElementById('setup-progress-content');
        if (!badge || !content) return;

        try {
            const cached = cardCached('project-status');
            const data = cached || await api('/project/status');
            if (!cached) cardStore('project-status', data);
            const { integrations, suggested_next } = data;

            let prefs = {};
            try { prefs = await _fetchDevopsPrefs(); } catch (_) {}

            const integrationMeta = {
                git:       { icon: 'ğŸ”€', label: 'Git Repository', wizKey: 'git' },
                docker:    { icon: 'ğŸ³', label: 'Docker',         wizKey: 'docker' },
                github:    { icon: 'ğŸ™', label: 'GitHub',         wizKey: 'github' },
                cicd:      { icon: 'âš¡', label: 'CI/CD Pipeline', wizKey: 'cicd' },
                k8s:       { icon: 'â˜¸ï¸', label: 'Kubernetes',      wizKey: 'k8s' },
                terraform: { icon: 'ğŸ—ï¸', label: 'Terraform',      wizKey: 'terraform' },
                pages:     { icon: 'ğŸ“„', label: 'Pages',          wizKey: 'pages' },
                dns:       { icon: 'ğŸŒ', label: 'DNS / Domain',   wizKey: 'dns' },
            };

            const statusIcons = { ready: 'âœ…', partial: 'ğŸ”¶', missing: 'â¬œ' };
            const statusLabels = { ready: 'Ready', partial: 'Partial', missing: 'Not set up' };
            const statusColors = { ready: 'var(--success)', partial: 'var(--warning)', missing: 'var(--text-muted)' };

            const order = ['git', 'docker', 'github', 'cicd', 'k8s', 'terraform', 'pages', 'dns'];
            const visible = order.filter(k => prefs[k] !== 'hidden' && prefs['int:' + k] !== 'hidden');

            const visibleComplete = visible.filter(k => (integrations[k] || {}).status === 'ready').length;
            const visibleTotal = visible.length;
            const pct = visibleTotal > 0 ? Math.round((visibleComplete / visibleTotal) * 100) : 100;

            let suggestion = suggested_next;
            if (suggestion && (prefs[suggestion] === 'hidden' || prefs['int:' + suggestion] === 'hidden')) {
                suggestion = visible.find(k => (integrations[k] || {}).status !== 'ready') || null;
            }

            if (pct >= 100) {
                badge.className = 'status-badge ok';
                badge.innerHTML = '<span class="status-dot"></span>Complete';
            } else {
                badge.className = 'status-badge degraded';
                badge.innerHTML = `<span class="status-dot"></span>${visibleComplete}/${visibleTotal}`;
            }

            let html = '';

            const barColor = pct >= 80 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--accent)';
            html += `<div style="margin-bottom:var(--space-lg)">
                <div style="display:flex;justify-content:space-between;font-size:0.72rem;color:var(--text-muted);margin-bottom:4px">
                    <span>Integration progress</span>
                    <span>${pct}%</span>
                </div>
                <div style="height:6px;background:var(--border-subtle);border-radius:3px;overflow:hidden">
                    <div style="width:${pct}%;height:100%;background:${barColor};border-radius:3px;transition:width 0.6s ease"></div>
                </div>
            </div>`;

            html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:8px">';
            for (const key of visible) {
                const meta = integrationMeta[key];
                const info = integrations[key] || {};
                const st = info.status || 'missing';
                const isSuggested = key === suggestion;

                html += `<div data-int-id="${key}" style="
                    display:flex;align-items:center;gap:0.6rem;
                    padding:0.5rem 0.75rem;border-radius:var(--radius-sm);
                    border:1px solid ${isSuggested ? 'var(--accent)' : 'var(--border-subtle)'};
                    background:${isSuggested ? 'var(--accent-glow)' : 'transparent'};
                    transition:all 0.15s ease;
                ">
                    <span style="font-size:1rem;width:24px;text-align:center">${statusIcons[st]}</span>
                    <span style="font-size:1rem">${meta.icon}</span>
                    <span style="flex:1;font-size:0.82rem;font-weight:500;color:var(--text-primary)">${esc(meta.label)}</span>
                    <span style="font-size:0.68rem;font-weight:600;color:${statusColors[st]}">${statusLabels[st]}</span>
                    ${st !== 'ready' && meta.wizKey
                        ? `<button class="btn btn-sm ${isSuggested ? 'btn-primary' : 'btn-secondary'}"
                            onclick="openSetupWizard('${meta.wizKey}')"
                            style="font-size:0.68rem;padding:2px 8px"
                            >${isSuggested ? 'Set up â†’' : 'Setup'}</button>`
                        : ''
                    }
                </div>`;
            }
            html += '</div>';

            if (suggestion && integrationMeta[suggestion]) {
                const next = integrationMeta[suggestion];
                html += `<div style="
                    margin-top:var(--space-md);padding:var(--space-sm) var(--space-md);
                    background:var(--accent-glow);border:1px solid var(--accent);border-radius:var(--radius-sm);
                    font-size:0.78rem;color:var(--accent);display:flex;align-items:center;gap:0.5rem;
                ">
                    <span>ğŸ’¡</span>
                    <span>Suggested next: <strong>${esc(next.label)}</strong></span>
                    ${next.wizKey
                        ? `<button class="btn btn-sm btn-primary" onclick="openSetupWizard('${next.wizKey}')" style="margin-left:auto;font-size:0.68rem">Set up ${esc(next.label)} â†’</button>`
                        : ''
                    }
                </div>`;
            }

            if (pct >= 100) {
                html += `<div style="
                    margin-top:var(--space-md);padding:var(--space-md);
                    background:var(--success-bg);border:1px solid var(--success);border-radius:var(--radius-sm);
                    font-size:0.82rem;color:var(--success);text-align:center;
                ">
                    ğŸ‰ All integrations configured! Your DevOps pipeline is ready.
                </div>`;
            }

            content.innerHTML = html;

        } catch (e) {
            console.warn('Setup progress load failed:', e);
            content.innerHTML = `<p style="color:var(--text-muted);font-size:0.82rem">Could not load integration status.</p>`;
        }
    }

    // â”€â”€ 4. Project Grade (simplified health) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadProjectGrade() {
        const badge = document.getElementById('project-grade-badge');
        const content = document.getElementById('project-grade-content');
        if (!badge || !content) return;

        try {
            const cached = cardCached('health-score');
            const data = cached || await api('/metrics/health').catch(e => ({ _err: e }));
            if (data._err) {
                badge.className = 'status-badge failed';
                badge.innerHTML = '<span class="status-dot"></span>Error';
                content.innerHTML = `<p style="color:var(--error);font-size:0.82rem">${esc(data._err.message)}</p>`;
                return;
            }
            if (!cached) cardStore('health-score', data);

            const score = data.score || 0;
            const grade = data.grade || '?';
            const probes = data.probes || {};
            const probeCount = Object.keys(probes).length;

            const gradeColors = { A: '#22c55e', B: '#84cc16', C: '#eab308', D: '#f97316', F: '#ef4444' };
            const gradeColor = gradeColors[grade] || 'var(--text-muted)';

            badge.className = 'status-badge ' + (score >= 75 ? 'ok' : score >= 50 ? 'degraded' : 'failed');
            badge.innerHTML = `<span class="status-dot"></span>${grade} (${score})`;

            const circumference = 2 * Math.PI * 54;
            const offset = circumference - (score / 100) * circumference;

            const headline = score >= 75 ? 'Your project looks healthy'
                           : score >= 50 ? 'Room for improvement'
                           : 'Needs attention';

            content.innerHTML = `<div style="display:flex;align-items:center;gap:var(--space-xl)">
                <div style="flex-shrink:0;text-align:center">
                    <svg width="100" height="100" viewBox="0 0 120 120">
                        <circle cx="60" cy="60" r="54" fill="none" stroke="var(--border-subtle)" stroke-width="8"></circle>
                        <circle cx="60" cy="60" r="54" fill="none" stroke="${gradeColor}" stroke-width="8"
                            stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"
                            stroke-linecap="round" transform="rotate(-90 60 60)"
                            style="transition:stroke-dashoffset 0.8s ease"></circle>
                        <text x="60" y="52" text-anchor="middle" fill="${gradeColor}" font-size="32" font-weight="800">${grade}</text>
                        <text x="60" y="72" text-anchor="middle" fill="var(--text-secondary)" font-size="13">${score}/100</text>
                    </svg>
                </div>
                <div style="flex:1">
                    <div style="font-size:0.88rem;font-weight:600;color:var(--text-primary);margin-bottom:var(--space-xs)">
                        ${headline}
                    </div>
                    <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:var(--space-md)">
                        Score based on ${probeCount} domain probes â€” git, docker, CI, packages, environment, quality, and structure.
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="switchTab('audit')" style="font-size:0.72rem">
                        View full report in Audit â†’
                    </button>
                </div>
            </div>`;

        } catch (e) {
            console.warn('Project grade load failed:', e);
            badge.className = 'status-badge';
            badge.innerHTML = 'â€”';
            content.innerHTML = '<p style="color:var(--text-muted);font-size:0.82rem">Could not load project health.</p>';
        }
    }

    // â”€â”€ 5. Attention Required â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadAttentionItems() {
        const badge = document.getElementById('attention-badge');
        const content = document.getElementById('attention-content');
        if (!badge || !content) return;

        const items = [];

        // a) Missing tools with install recipes
        const toolsData = cardCached('tools-status');
        if (toolsData) {
            const installable = (toolsData.tools || []).filter(t => !t.available && t.has_recipe);
            if (installable.length > 0) {
                items.push({
                    icon: 'ğŸ”§',
                    text: `${installable.length} tool${installable.length > 1 ? 's' : ''} can be auto-installed`,
                    detail: installable.map(t => t.label).slice(0, 4).join(', ') + (installable.length > 4 ? 'â€¦' : ''),
                    cta: "document.getElementById('tools-status-section').scrollIntoView({behavior:'smooth'})",
                    ctaLabel: 'See above â†‘',
                });
            }
        }

        // b) Incomplete integrations
        const projectData = cardCached('project-status');
        if (projectData) {
            let prefs = {};
            try { prefs = await _fetchDevopsPrefs(); } catch (_) {}
            const integrations = projectData.integrations || {};
            const order = ['git', 'docker', 'github', 'cicd', 'k8s', 'terraform', 'pages', 'dns'];
            const incomplete = order.filter(k =>
                prefs[k] !== 'hidden' && prefs['int:' + k] !== 'hidden' &&
                (integrations[k] || {}).status !== 'ready'
            );
            if (incomplete.length > 0) {
                items.push({
                    icon: 'ğŸš€',
                    text: `${incomplete.length} integration${incomplete.length > 1 ? 's' : ''} not yet configured`,
                    detail: incomplete.slice(0, 4).join(', ') + (incomplete.length > 4 ? 'â€¦' : ''),
                    cta: "switchTab('wizard')",
                    ctaLabel: 'Setup Wizard â†’',
                });
            }
        }

        // c) Last operation failed
        const statusData = cardCached('dash-status');
        if (statusData) {
            const op = statusData.state?.last_operation || {};
            if (op.automation && op.status === 'failed') {
                items.push({
                    icon: 'ğŸ’¥',
                    text: `Last operation "${op.automation}" failed`,
                    detail: `${op.actions_failed} of ${op.actions_total} actions failed`,
                    cta: "switchTab('debugging/audit')",
                    ctaLabel: 'View in Debugging â†’',
                });
            }
        }

        // d) Pending audit snapshots
        try {
            const pendingData = await api('/audits/pending');
            const pending = pendingData.pending || [];
            if (pending.length > 0) {
                items.push({
                    icon: 'ğŸ“‹',
                    text: `${pending.length} audit snapshot${pending.length > 1 ? 's' : ''} pending review`,
                    detail: 'Unsaved analysis results',
                    cta: "switchTab('audit')",
                    ctaLabel: 'Review in Audit â†’',
                });
            }
        } catch (_) {}

        // Render
        if (items.length === 0) {
            badge.className = 'status-badge ok';
            badge.innerHTML = '<span class="status-dot"></span>All clear';
            content.innerHTML = `<div style="text-align:center;padding:var(--space-md);color:var(--success);font-size:0.82rem">
                âœ… Nothing needs your attention right now.
            </div>`;
            return;
        }

        badge.className = 'status-badge degraded';
        badge.innerHTML = `<span class="status-dot"></span>${items.length} item${items.length > 1 ? 's' : ''}`;

        let html = '';
        for (const item of items) {
            html += `<div style="
                display:flex;align-items:center;gap:0.6rem;
                padding:0.5rem 0.75rem;margin-bottom:6px;border-radius:var(--radius-sm);
                border:1px solid var(--border-subtle);
                transition:all 0.15s ease;
            ">
                <span style="font-size:1rem;width:24px;text-align:center">${item.icon}</span>
                <div style="flex:1;min-width:0">
                    <div style="font-size:0.82rem;font-weight:500;color:var(--text-primary)">${esc(item.text)}</div>
                    <div style="font-size:0.68rem;color:var(--text-muted)">${esc(item.detail)}</div>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="${item.cta}" style="font-size:0.68rem;padding:2px 8px;flex-shrink:0">${esc(item.ctaLabel)}</button>
            </div>`;
        }

        content.innerHTML = html;
    }

    // â”€â”€ Assistant Panel Activation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function activateDashboardAssistant() {
        if (!window._assistant) return;
        const container = document.querySelector('.dash-main');
        const panel = document.getElementById('dash-assistant-panel');
        if (!container || !panel) return;
        window._assistant.activate('dashboard', container, panel);
    }

</script>