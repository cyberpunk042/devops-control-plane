/* Audit Tab JS — Init & Helpers
     Shared data store for modal drill-downs, file link helpers, modal open helpers.
     Depends on: _globals.html (api, esc, toast, modalOpen)
*/
// ═══════════════════════════════════════════════════════════════
//  Audit Tab — L0/L1/L2 analysis display
// ═══════════════════════════════════════════════════════════════

let _auditLoaded = false;

// ── Shared data store for modal drill-downs ────────────────────
window._auditData = {};



// ── Helpers: file links & modal ────────────────────────────────

function _auditFileLink(filePath, line) {
    if (!filePath) return '';
    const label = filePath + (line ? `:${line}` : '');
    const lineParam = line ? `:${line}` : '';
    const escapedPath = filePath.replace(/'/g, "\\'");
    return `<a href="#content/docs/${encodeURIComponent(filePath)}@preview${lineParam}" class="audit-file-link" onclick="_auditNavToFile('${escapedPath}',${line||0});return false" title="Open in Content Vault" style="font-family:var(--font-mono);font-size:0.72rem;color:var(--accent);text-decoration:none;cursor:pointer;word-break:break-all">${esc(label)}</a>`;
}

function _auditNavToFile(path, line) {
    // Close audit modal first (if open)
    const modal = document.getElementById('audit-modal-overlay');
    if (modal) modal.remove();
    openFileInEditor(path, 'preview', line || 0);
}

function _auditModal(title, bodyHtml, width) {
    const old = document.getElementById('audit-modal-overlay');
    if (old) old.remove();

    const overlay = document.createElement('div');
    overlay.id = 'audit-modal-overlay';
    overlay.className = 'vault-modal-overlay';
    overlay.onclick = e => { if (e.target === overlay) overlay.remove(); };
    overlay.innerHTML = `
        <div class="vault-modal" style="max-width:${width||600}px;max-height:80vh;overflow-y:auto;overflow-x:hidden">
            <div style="display:flex;align-items:center;margin-bottom:var(--space-md)">
                <strong style="font-size:1rem;flex:1">${title}</strong>
                <button onclick="document.getElementById('audit-modal-overlay').remove()" style="background:none;border:none;color:var(--text-muted);font-size:1.2rem;cursor:pointer;padding:4px 8px">✕</button>
            </div>
            <div id="audit-modal-body">${bodyHtml}</div>
        </div>
    `;
    document.body.appendChild(overlay);
    const escHandler = e => { if (e.key === 'Escape') { overlay.remove(); document.removeEventListener('keydown', escHandler); } };
    document.addEventListener('keydown', escHandler);
}

// Audit card metadata — same pattern as _INT_CARDS / _DEVOPS_CARDS
const _AUDIT_CARDS = {
    'audit:scores':    { loadFn: () => loadAuditScores(),       badgeId: 'audit-scores-badge',    detailId: 'audit-scores-detail' },
    'audit:system':    { loadFn: () => loadAuditSystemCard(),   badgeId: 'audit-system-badge',    detailId: 'audit-system-detail' },
    'audit:deps':      { loadFn: () => loadAuditDepsCard(),     badgeId: 'audit-deps-badge',      detailId: 'audit-deps-detail' },
    'audit:structure': { loadFn: () => loadAuditStructureCard(), badgeId: 'audit-structure-badge', detailId: 'audit-structure-detail' },
    'audit:clients':   { loadFn: () => loadAuditClientsCard(),  badgeId: 'audit-clients-badge',   detailId: 'audit-clients-detail' },
};

async function loadAuditTab(force) {
    if (force) {
        _auditLoaded = false;

        // Bust client + server caches, show spinners — same as cardRefresh()
        for (const [key, meta] of Object.entries(_AUDIT_CARDS)) {
            cardInvalidate(key);
            const badge = document.getElementById(meta.badgeId);
            const detail = document.getElementById(meta.detailId);
            if (badge) { badge.className = 'status-badge'; badge.textContent = '—'; }
            if (detail) detail.innerHTML = '<span class="spinner"></span>';
        }
        // Bust server-side cache — single scoped bust + bg recompute
        // MUST await: server starts bg recompute thread first
        await api('/devops/cache/bust', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ card: 'audit' }),
        }).catch(() => {});
    }
    if (_auditLoaded) return;

    // Load all cards in parallel
    await Promise.all(Object.values(_AUDIT_CARDS).map(meta => meta.loadFn()));

    // Auto-load L2 cards that are already cached
    _autoLoadL2Cards();

    _auditLoaded = true;
}


async function _autoLoadL2Cards() {
    // Check if any L2 cards have cached data and load them silently
    for (const [key, fn] of [
        ['audit:l2:quality', loadAuditHealthCard],
        ['audit:l2:repo', loadAuditRepoCard],
        ['audit:l2:risks', loadAuditRisksCard],
        ['audit:l2:structure', loadAuditL2StructureCard],
    ]) {
        if (cardCached(key)) {
            fn();
        }
    }
}


