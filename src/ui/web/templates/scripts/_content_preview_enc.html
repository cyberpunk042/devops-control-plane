    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //  _content_preview_enc.html
    //  Content Vault â€” Encrypted file preview + file modal handlers
    //  Encrypted file preview/edit/save, key entry, rename file modal,
    //  move file modal, close preview, helper bridges
    //  Included by: _content.html (Jinja2 include)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€ Encrypted file preview â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let encPreviewKey = '';  // key used for this preview session
    let encPreviewContent = '';  // decrypted text content (for edit)

    async function contentPreviewEncrypted(path, name, overrideKey) {
        previewCurrentPath = path;
        previewCurrentName = name;
        if (overrideKey) encPreviewKey = overrideKey;
        contentUpdateHash();

        const browser = document.getElementById('content-browser');

        browser.innerHTML = `
            <div class="content-preview-panel">
                <div class="content-preview-header">
                    <button class="btn btn-secondary btn-sm" onclick="contentClosePreview()">â† Back</button>
                    <span class="content-preview-title" id="content-preview-filename" translate="no">ğŸ” ${esc(name)}</span>
                    <button class="btn btn-secondary btn-sm" onclick="contentRenameFile()" title="Rename" style="font-size:0.7rem;padding:0.15rem 0.4rem">âœï¸</button>
                    <div id="content-preview-toggle" style="display:none;gap:4px"></div>
                    <div style="flex:1"></div>
                    <div id="content-preview-actions" style="display:flex;gap:4px">
                        <button class="btn btn-secondary btn-sm" onclick="contentDecryptFile('${esc(path)}')" title="Decrypt to disk">ğŸ”“ Decrypt</button>
                        <button class="btn btn-secondary btn-sm" onclick="contentMoveFile()" title="Move toâ€¦">ğŸ“‚ Move</button>
                        <button class="btn btn-secondary btn-sm" onclick="contentDeleteFromPreview()" title="Delete" style="color:var(--error)">ğŸ—‘ï¸ Delete</button>
                    </div>
                </div>
                <div id="content-preview-body" class="content-preview-body" translate="no">
                    <p class="empty-state"><span class="spinner"></span> Decrypting for previewâ€¦</p>
                </div>
                <div id="content-preview-edit-bar" style="display:none;padding-top:var(--space-sm);border-top:1px solid var(--border-subtle);gap:0.5rem;justify-content:flex-end">
                </div>
            </div>`;

        try {
            const payload = { path };
            const keyToUse = overrideKey || encPreviewKey || '';
            if (keyToUse) payload.key = keyToUse;

            const resp = await fetch('/api/content/preview-encrypted', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const data = await resp.json();

            const body = document.getElementById('content-preview-body');
            const toggle = document.getElementById('content-preview-toggle');
            const editBar = document.getElementById('content-preview-edit-bar');

            if (!resp.ok) {
                if (data.wrong_key || data.needs_key) {
                    body.innerHTML = `
                        <div style="padding:2rem;text-align:center">
                            <span style="font-size:2rem;display:block;margin-bottom:1rem">ğŸ”‘</span>
                            <p style="color:var(--text-secondary);margin-bottom:1rem">
                                ${data.needs_key
                            ? 'No encryption key configured.'
                            : 'The configured key does not match this file.'}
                            </p>
                            <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1.5rem">
                                Enter the key that was used to encrypt this file:
                            </p>
                            <div style="display:flex;gap:0.5rem;justify-content:center;max-width:500px;margin:0 auto">
                                <input type="password" id="enc-preview-key" placeholder="Decryption keyâ€¦"
                                       style="flex:1;font-family:monospace"
                                       onkeydown="if(event.key==='Enter')contentTryEncPreviewKey('${esc(path)}','${esc(name)}')">
                                <button class="btn btn-primary btn-sm"
                                        onclick="contentTryEncPreviewKey('${esc(path)}','${esc(name)}')">
                                    ğŸ”“ Unlock
                                </button>
                            </div>
                        </div>`;
                    return;
                }
                throw new Error(data.error || 'Preview failed');
            }

            // Successfully decrypted
            const originalLabel = data.original_name ? ` (${esc(data.original_name)})` : '';
            previewIsText = (data.type === 'text' || data.type === 'markdown');

            if (data.type === 'image') {
                body.innerHTML = `<div style="text-align:center;padding:1rem">
                    <p style="color:var(--text-muted);font-size:0.8rem;margin-bottom:0.5rem">ğŸ”“ Decrypted preview${originalLabel}</p>
                    <img src="${data.url}" alt="${esc(name)}" style="max-width:100%;max-height:70vh;border-radius:var(--radius-sm)">
                </div>`;

            } else if (data.type === 'video') {
                body.innerHTML = `
                    <div style="text-align:center;padding:1rem">
                        <p style="color:var(--text-muted);font-size:0.8rem;margin-bottom:0.5rem">ğŸ”“ Decrypted preview${originalLabel} Â· ${formatFileSize(data.size)}</p>
                        <video id="content-video-player" controls
                            style="max-width:100%;max-height:65vh;border-radius:var(--radius-sm);background:#000">
                            <source src="${data.url}">
                        </video>
                    </div>`;

            } else if (data.type === 'audio') {
                body.innerHTML = `
                    <div style="text-align:center;width:100%;padding:2rem">
                        <div style="font-size:3rem;margin-bottom:1rem;opacity:0.4">ğŸµ</div>
                        <p style="color:var(--text-muted);font-size:0.8rem;margin-bottom:0.5rem">ğŸ”“ Decrypted preview${originalLabel}</p>
                        <p style="font-size:0.9rem;color:var(--text-secondary);margin-bottom:1rem">${esc(name)}</p>
                        <audio controls style="width:100%;max-width:450px">
                            <source src="${data.url}" type="${data.mime}">
                        </audio>
                    </div>`;

            } else if (data.type === 'markdown' || data.type === 'text') {
                encPreviewContent = data.content;

                // Show toggles
                toggle.style.display = 'flex';
                let toggleHtml = '';
                if (data.type === 'markdown') {
                    toggleHtml += `
                        <button class="btn btn-sm ${previewRawMode && !previewEditMode ? 'btn-primary' : 'btn-secondary'}" onclick="contentSetEncPreviewMode('raw')">Raw</button>
                        <button class="btn btn-sm ${!previewRawMode && !previewEditMode ? 'btn-primary' : 'btn-secondary'}" onclick="contentSetEncPreviewMode('preview')">Preview</button>`;
                }
                toggleHtml += `<button class="btn btn-sm ${previewEditMode ? 'btn-primary' : 'btn-secondary'}" onclick="contentSetEncPreviewMode('edit')">âœï¸ Edit</button>`;
                toggle.innerHTML = toggleHtml;

                if (previewEditMode) {
                    body.innerHTML = `<textarea id="content-editor" class="content-editor" spellcheck="false">${esc(data.content)}</textarea>`;
                    editBar.style.display = 'flex';
                    editBar.innerHTML = `
                        <button class="btn btn-secondary btn-sm" onclick="contentDiscardEncEdit()">â†©ï¸ Discard</button>
                        <button class="btn btn-primary btn-sm" onclick="contentSaveEncEdit()">ğŸ’¾ Save</button>`;
                } else if (data.type === 'markdown' && !previewRawMode) {
                    body.innerHTML = `
                        <p style="color:var(--text-muted);font-size:0.8rem;padding:0.5rem 1rem;border-bottom:1px solid var(--border-subtle)">
                            ğŸ”“ Decrypted${originalLabel} Â· ${formatFileSize(data.size)} Â· ${data.line_count} lines
                        </p>
                        <div class="content-preview-rendered notranslate" translate="no"><div style="display:flex;justify-content:flex-end;margin-bottom:0.5rem"><button class="btn btn-secondary btn-sm" style="font-size:0.7rem;padding:0.15rem 0.5rem" onclick="contentToggleTranslate(this)">ğŸŒ Translate</button></div>${renderMarkdown(data.content)}</div>`;
                    _attachPreviewLinkHandlers(body);
                    editBar.style.display = 'none';
                } else {
                    body.innerHTML = `
                        <p style="color:var(--text-muted);font-size:0.8rem;padding:0.5rem 1rem;border-bottom:1px solid var(--border-subtle)">
                            ğŸ”“ Decrypted${originalLabel} Â· ${formatFileSize(data.size)} Â· ${data.line_count} lines
                        </p>
                        <pre class="content-preview-code notranslate" translate="no"><code>${esc(data.content)}</code></pre>`;
                    editBar.style.display = 'none';
                }

                if (data.truncated) {
                    body.innerHTML += `<p style="color:var(--warning);font-size:0.8rem;padding:0.5rem">âš ï¸ Truncated (first 512 KB of ${formatFileSize(data.size)})</p>`;
                }

            } else if (data.type === 'binary') {
                body.innerHTML = `<div class="empty-state" style="padding:2rem">
                    <span style="font-size:2rem">ğŸ“¦</span>
                    <p>ğŸ”“ Decrypted${originalLabel}</p>
                    <p style="font-size:0.8rem;color:var(--text-muted)">${data.mime || 'unknown type'} Â· ${formatFileSize(data.size)}</p>
                    <p style="font-size:0.8rem;color:var(--text-muted)">Binary content â€” use Decrypt to write to disk</p>
                </div>`;
            }

        } catch (e) {
            const body = document.getElementById('content-preview-body');
            if (body) body.innerHTML = `<p class="empty-state" style="color:var(--error)">âŒ ${esc(e.message)}</p>`;
        }
    }

    function contentSetEncPreviewMode(mode) {
        if (mode === 'edit') {
            previewEditMode = true;
        } else {
            previewEditMode = false;
            previewRawMode = (mode === 'raw');
        }
        contentPreviewEncrypted(previewCurrentPath, previewCurrentName);
    }

    function contentDiscardEncEdit() {
        previewEditMode = false;
        contentPreviewEncrypted(previewCurrentPath, previewCurrentName);
    }

    async function contentSaveEncEdit() {
        const editor = document.getElementById('content-editor');
        if (!editor) return;

        try {
            await api('/content/save-encrypted', {
                method: 'POST',
                body: JSON.stringify({
                    path: previewCurrentPath,
                    content: editor.value,
                    key: encPreviewKey || undefined,
                }),
            });
            toast('File saved and re-encrypted!', 'success');
            previewEditMode = false;
            contentPreviewEncrypted(previewCurrentPath, previewCurrentName);
        } catch (e) {
            toast(`Save failed: ${e.message}`, 'error');
        }
    }

    function contentTryEncPreviewKey(path, name) {
        const input = document.getElementById('enc-preview-key');
        const key = input ? input.value.trim() : '';
        if (!key) { toast('Enter a key.', 'warning'); return; }
        encPreviewKey = key;
        contentPreviewEncrypted(path, name, key);
    }

    async function contentSaveEdit() {
        const editor = document.getElementById('content-editor');
        if (!editor) return;

        try {
            await api('/content/save', {
                method: 'POST',
                body: JSON.stringify({ path: previewCurrentPath, content: editor.value }),
            });
            toast('File saved!', 'success');
            previewOrigContent = editor.value;
            previewEditMode = false;
            contentPreviewFile(previewCurrentPath, previewCurrentName);
        } catch (e) {
            toast(`Save failed: ${e.message}`, 'error');
        }
    }

    function contentDiscardEdit() {
        previewEditMode = false;
        contentPreviewFile(previewCurrentPath, previewCurrentName);
    }

    let _ctRenamePath = '';
    let _ctRenameName = '';
    let _ctRenameFromPreview = false;

    function contentRenameFile(path, name, hasRelease) {
        _ctRenamePath = path || previewCurrentPath;
        _ctRenameName = name || previewCurrentName;
        _ctRenameFromPreview = (!path);  // if no path passed, we're in preview mode

        const modal = document.getElementById('ct-rename-modal');
        const info = document.getElementById('ct-rename-modal-info');
        const input = document.getElementById('ct-rename-input');
        const status = document.getElementById('ct-rename-modal-status');
        const confirmBtn = document.getElementById('ct-rename-confirm-btn');
        const releaseInfo = document.getElementById('ct-rename-modal-release-info');

        const showRelease = hasRelease !== undefined ? hasRelease : previewCurrentHasRelease;
        info.innerHTML = `Current name: <code style="font-size:0.82rem">${esc(_ctRenameName)}</code>`;
        input.value = _ctRenameName;
        status.style.display = 'none';
        if (releaseInfo) releaseInfo.style.display = showRelease ? 'block' : 'none';
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'âœï¸ Rename';
        modal.style.display = 'flex';
        setTimeout(() => { input.focus(); input.select(); }, 100);
    }

    async function contentDoRenameConfirm() {
        const modal = document.getElementById('ct-rename-modal');
        const input = document.getElementById('ct-rename-input');
        const status = document.getElementById('ct-rename-modal-status');
        const confirmBtn = document.getElementById('ct-rename-confirm-btn');
        const newName = input.value.trim();
        const releaseInfo = document.getElementById('ct-rename-modal-release-info');
        const releaseCheckbox = document.getElementById('ct-rename-update-release');
        const updateRelease = releaseInfo && releaseInfo.style.display !== 'none'
            && releaseCheckbox && releaseCheckbox.checked;

        if (!newName || newName === _ctRenameName) {
            modal.style.display = 'none';
            return;
        }

        confirmBtn.disabled = true;
        confirmBtn.textContent = 'â³ Renamingâ€¦';
        status.style.display = 'block';
        status.innerHTML = '<span class="spinner"></span> Renamingâ€¦';

        try {
            const result = await api('/content/rename', {
                method: 'POST',
                body: JSON.stringify({ path: _ctRenamePath, new_name: newName }),
            });

            if (updateRelease) {
                // Delete old artifact (sidecar has old_asset_name)
                status.innerHTML = '<span class="spinner"></span> Removing old release artifactâ€¦';
                try {
                    await api('/backup/delete-release', {
                        method: 'POST',
                        body: JSON.stringify({ path: result.new_path }),
                    });
                } catch (e) { /* old artifact may already be gone */ }

                // Upload with new name
                status.innerHTML = '<span class="spinner"></span> Uploading with new nameâ€¦';
                await api('/backup/upload-release', {
                    method: 'POST',
                    body: JSON.stringify({ path: result.new_path }),
                });
            }

            modal.style.display = 'none';
            toast(`Renamed â†’ ${result.new_name}`, 'success');

            if (_ctRenameFromPreview) {
                // Update preview state
                previewCurrentPath = result.new_path;
                previewCurrentName = result.new_name;
                const titleEl = document.getElementById('content-preview-filename');
                if (titleEl) titleEl.textContent = result.new_name;
            } else {
                // Refresh the file list
                contentLoadFolder(contentCurrentPath);
            }
        } catch (e) {
            status.innerHTML = `<span style="color:var(--error)">âŒ ${esc(e.message)}</span>`;
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'âœï¸ Rename';
        }
    }

    let _ctMovePath = '';
    let _ctMoveName = '';
    let _ctMoveFromPreview = false;

    async function contentMoveFile(path, name) {
        _ctMovePath = path || previewCurrentPath;
        _ctMoveName = name || previewCurrentName;
        _ctMoveFromPreview = (!path);

        const modal = document.getElementById('ct-move-modal');
        const info = document.getElementById('ct-move-modal-info');
        const folderList = document.getElementById('ct-move-folder-list');
        const subArea = document.getElementById('ct-move-subfolder-area');
        const input = document.getElementById('ct-move-input');
        const status = document.getElementById('ct-move-modal-status');
        const confirmBtn = document.getElementById('ct-move-confirm-btn');

        // Determine current file's parent folder path
        const pathParts = _ctMovePath.split('/');
        pathParts.pop(); // remove filename
        const currentParent = pathParts.join('/'); // e.g. "docs/examples" or "docs"
        const currentRoot = pathParts[0] || ''; // e.g. "docs"

        info.innerHTML = `Move <code style="font-size:0.82rem">${esc(_ctMoveName)}</code>
            <div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.2rem">from <code>${esc(currentParent || '/')}</code></div>`;

        // Show modal immediately with loading state
        folderList.innerHTML = '<span class="spinner" style="width:14px;height:14px"></span> <span style="font-size:0.8rem;color:var(--text-muted)">Loading foldersâ€¦</span>';
        subArea.innerHTML = '';
        input.value = currentParent || '';
        status.style.display = 'none';
        confirmBtn.disabled = false;
        confirmBtn.textContent = 'ğŸ“‚ Move';
        modal.style.display = 'flex';

        // Fetch ALL project directories
        try {
            const data = await api('/content/all-folders');
            const allFolders = data.folders || [];

            if (!allFolders.length) {
                folderList.innerHTML = '<span style="font-size:0.8rem;color:var(--text-muted)">No folders found</span>';
                return;
            }

            let pillsHtml = '';
            for (const folder of allFolders) {
                const isCurrent = folder.name === currentRoot;
                const style = isCurrent
                    ? 'background:var(--bg-secondary);color:var(--text-primary);border:2px solid var(--accent-primary)'
                    : 'background:var(--accent-primary);color:#fff;border:none';
                pillsHtml += `<button class="btn btn-sm" style="${style};padding:0.2rem 0.6rem;font-size:0.8rem;border-radius:12px;cursor:pointer" onclick="_ctMoveSelectFolder('${esc(folder.name)}')" title="${esc(folder.name)}">ğŸ“ ${esc(folder.name)}</button>`;
            }
            folderList.innerHTML = pillsHtml;

            // Auto-drill-down to current folder context
            if (currentParent) {
                // Walk the path hierarchy to expand subfolders
                for (let i = 1; i <= pathParts.length; i++) {
                    const partialPath = pathParts.slice(0, i).join('/');
                    await _ctMoveSelectFolder(partialPath);
                }
            }
        } catch (e) {
            folderList.innerHTML = `<span style="color:var(--error);font-size:0.8rem">âŒ ${esc(e.message)}</span>`;
        }
        setTimeout(() => input.focus(), 100);
    }

    async function _ctMoveSelectFolder(folderPath) {
        const input = document.getElementById('ct-move-input');
        const subArea = document.getElementById('ct-move-subfolder-area');
        input.value = folderPath;

        // Remove any subfolder rows deeper than this level
        const depth = folderPath.split('/').length;
        const rows = subArea.querySelectorAll('[data-depth]');
        rows.forEach(r => {
            if (parseInt(r.dataset.depth) >= depth) r.remove();
        });

        // Fetch subdirectories
        try {
            const result = await api(`/content/list?path=${encodeURIComponent(folderPath)}`);
            const dirs = (result.files || []).filter(f => f.is_dir);
            if (dirs.length === 0) return; // no subdirectories

            const row = document.createElement('div');
            row.dataset.depth = depth;
            row.style.cssText = 'display:flex;flex-wrap:wrap;gap:0.35rem;margin-top:0.5rem;padding:0.4rem 0.5rem;background:var(--bg-tertiary);border-radius:8px;align-items:center';
            row.innerHTML = `<span style="font-size:0.72rem;color:var(--text-muted);margin-right:0.2rem">${'â€º'.repeat(depth)}</span>`;
            for (const d of dirs) {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm';
                btn.style.cssText = 'background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border-subtle);padding:0.15rem 0.5rem;font-size:0.78rem;border-radius:10px;cursor:pointer';
                btn.textContent = `ğŸ“‚ ${d.name}`;
                btn.title = d.path;
                btn.onclick = () => _ctMoveSelectFolder(d.path);
                row.appendChild(btn);
            }
            subArea.appendChild(row);
            subArea.scrollTop = subArea.scrollHeight;
        } catch (e) {
            // silently ignore â€” folder may not exist yet
        }
    }

    async function contentDoMoveConfirm() {
        const modal = document.getElementById('ct-move-modal');
        const input = document.getElementById('ct-move-input');
        const status = document.getElementById('ct-move-modal-status');
        const confirmBtn = document.getElementById('ct-move-confirm-btn');
        const dest = input.value.trim();

        if (!dest) { toast('Enter a destination folder', 'error'); return; }

        confirmBtn.disabled = true;
        confirmBtn.textContent = 'â³ Movingâ€¦';
        status.style.display = 'block';
        status.innerHTML = '<span class="spinner"></span> Movingâ€¦';

        try {
            const result = await api('/content/move', {
                method: 'POST',
                body: JSON.stringify({ path: _ctMovePath, destination: dest }),
            });
            modal.style.display = 'none';
            toast(`Moved â†’ ${result.new_path}`, 'success');
            contentLoaded = false; // refresh folder list

            if (_ctMoveFromPreview) {
                contentClosePreview();
            } else {
                contentLoadFolder(contentCurrentPath);
            }
        } catch (e) {
            status.innerHTML = `<span style="color:var(--error)">âŒ ${esc(e.message)}</span>`;
            confirmBtn.disabled = false;
            confirmBtn.textContent = 'ğŸ“‚ Move';
        }
    }

    function contentDeleteFromPreview() {
        contentDeleteFile(previewCurrentPath, previewCurrentName, true, previewCurrentHasRelease);
    }

    function contentEncryptFromPreview() {
        contentEncryptFile(previewCurrentPath, previewCurrentHasRelease);
    }

    function contentClosePreview() {
        previewEditMode = false;
        previewCurrentPath = '';
        previewCurrentName = '';
        if (contentCurrentPath) {
            contentLoadFolder(contentCurrentPath);
        }
    }
