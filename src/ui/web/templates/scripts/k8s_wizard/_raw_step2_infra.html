                        // ‚îÄ‚îÄ Infra card HTML generator ‚îÄ‚îÄ
                        // Generates a complete infra service card from a service data object.
                        // Used by both initial render and dynamic add.
                        // Defined before Section B so it's available during html string construction.
                        window._k8sInfraCardHtml = (svc, savedInfra) => {
                            const svcName = svc.name;
                            const infraId = 'infra-' + svcName;
                            const imgShort = (svc.image || '').split('/').pop().split(':')[0] || svcName;
                            const portStr = (svc.ports || []).map(p => ':' + p.container).join(' ');
                            const volCount = (svc.volumes || []).length;
                            const infraEnvKeys = Object.keys(svc.environment || {});
                            const infraEnvVals = svc.environment || {};
                            const eName = esc(svcName);
                            // Saved kind overrides detection default
                            const infraKindDefault = savedInfra?.kind || _classifyWorkloadKind(svc);
                            const infraKindHintText = _kindHint(infraKindDefault, svc);

                            let h = '<div data-infra-name="' + eName + '" style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);padding:0.5rem 0.6rem">'
                                + '<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;margin-bottom:0.3rem">'
                                + '<span style="font-size:1rem" id="k8s-infra-icon-' + eName + '">' + _kindIcon(infraKindDefault) + '</span>'
                                + '<strong>' + eName + '</strong>'
                                + '<code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">' + esc(imgShort) + '</code>'
                                + (portStr ? '<code style="font-size:0.68rem;color:var(--text-muted)">' + esc(portStr) + '</code>' : '')
                                + (volCount > 0 ? '<span style="font-size:0.66rem;color:var(--text-muted)" title="' + volCount + ' volumes">üíæ' + volCount + '</span>' : '')
                                + '<span style="flex:1"></span>'
                                + '<button type="button" onclick="window._k8sRemoveInfra(\'' + eName + '\')"'
                                + ' style="background:none;border:none;cursor:pointer;font-size:0.88rem;color:var(--text-muted);padding:0 4px;line-height:1"'
                                + ' title="Remove ' + eName + '">‚úï</button>'
                                + '</div>'
                                + '<div style="display:flex;align-items:center;gap:0.4rem;font-size:0.74rem;margin-bottom:0.15rem">'
                                + '<select id="k8s-infra-kind-' + eName + '" class="modal-form-select"'
                                + ' style="font-size:0.68rem;padding:0.1rem 0.3rem;min-width:130px;color:var(--success);font-weight:600"'
                                + ' onchange="'
                                +   'var ic=document.getElementById(\'k8s-infra-icon-' + eName + '\');'
                                +   'var hn=document.getElementById(\'k8s-infra-kind-hint-' + eName + '\');'
                                +   'var cfg=document.getElementById(\'k8s-infra-cfg-' + eName + '\');'
                                +   'var sb=document.getElementById(\'k8s-infra-skip-banner-' + eName + '\');'
                                +   'var mi=document.getElementById(\'k8s-infra-managed-info-' + eName + '\');'
                                +   'var el=document.getElementById(\'k8s-infra-envlabel-' + eName + '\');'
                                +   'var vs=document.getElementById(\'k8s-infra-vol-section-' + eName + '\');'
                                +   'var kv=this.value;'
                                +   'if(ic)ic.textContent=({"Deployment":"üöÄ","StatefulSet":"üóÑÔ∏è","DaemonSet":"üåê","Managed":"‚òÅÔ∏è","Skip":"‚è≠Ô∏è"})[kv]||"üì¶";'
                                +   'if(hn)hn.textContent=\'\';'
                                +   'if(cfg)cfg.style.display=(kv===\'Skip\'?\'none\':\'block\');'
                                +   'if(sb)sb.style.display=(kv===\'Skip\'?\'block\':\'none\');'
                                +   'if(mi)mi.style.display=(kv===\'Managed\'?\'block\':\'none\');'
                                +   'if(vs)vs.style.display=(kv===\'Managed\'||kv===\'Skip\'?\'none\':\'block\');'
                                +   'if(el)el.textContent=(kv===\'Managed\'?\'Connection Environment Variables\':\'Environment Variables\');'
                                +   'if(kv!==\'Skip\')window._k8sInfraEnvTrigger(\'' + eName + '\');'
                                + '">'
                                + '<option value="StatefulSet"' + (infraKindDefault === 'StatefulSet' ? ' selected' : '') + '>StatefulSet</option>'
                                + '<option value="Deployment"' + (infraKindDefault === 'Deployment' ? ' selected' : '') + '>Deployment</option>'
                                + '<option value="DaemonSet"' + (infraKindDefault === 'DaemonSet' ? ' selected' : '') + '>DaemonSet</option>'
                                + '<option value="Managed"' + (infraKindDefault === 'Managed' ? ' selected' : '') + '>Managed (external)</option>'
                                + '<option value="Skip"' + (infraKindDefault === 'Skip' ? ' selected' : '') + '>Skip (exclude)</option>'
                                + '</select>'
                                + '<span id="k8s-infra-kind-hint-' + eName + '" style="font-size:0.6rem;color:var(--text-muted);font-style:italic">' + (infraKindHintText || '') + '</span>'
                                + '</div>';

                            // Infra config panel (env vars) ‚Äî shown when kind is NOT Skip
                            const infraCfgDisplay = infraKindDefault === 'Skip' ? 'none' : 'block';
                            const isInfraManaged = infraKindDefault === 'Managed';

                            // Skip banner for infra services
                            h += '<div id="k8s-infra-skip-banner-' + eName + '" style="display:' + (infraKindDefault === 'Skip' ? 'block' : 'none') + ';padding:0.6rem;margin-top:0.35rem;background:var(--bg-primary);border-radius:6px;border:1px dashed var(--border-subtle);text-align:center">'
                                + '<div style="font-size:0.9rem;margin-bottom:0.15rem">‚è≠Ô∏è</div>'
                                + '<div style="font-size:0.72rem;color:var(--text-muted);font-weight:600">Excluded</div>'
                                + '<div style="font-size:0.66rem;color:var(--text-muted);font-style:italic">This service will not be deployed to Kubernetes.</div>'
                                + '</div>';

                            h += '<div id="k8s-infra-cfg-' + eName + '" style="display:' + infraCfgDisplay + ';margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">';

                            // Managed-specific info banner + provider notes
                            h += '<div id="k8s-infra-managed-info-' + eName + '" style="display:' + (isInfraManaged ? 'block' : 'none') + ';margin-bottom:0.4rem">'
                                + '<div style="padding:0.35rem 0.5rem;background:var(--bg-inset);border-radius:4px;border-left:3px solid var(--accent);margin-bottom:0.3rem">'
                                + '<div style="font-size:0.72rem;color:var(--accent)">‚ÑπÔ∏è This service will be managed <strong>outside</strong> Kubernetes.</div>'
                                + '<div style="font-size:0.64rem;color:var(--text-muted)">No K8s resources will be generated. Connection vars below will be injected into dependent services as Secrets.</div>'
                                + '</div>'
                                + '<div style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem">'
                                + '<span style="font-size:0.68rem;color:var(--text-muted);font-weight:600">Provider / Notes</span>'
                                + '</div>'
                                + '<input type="text" id="k8s-infra-provider-' + eName + '" class="modal-form-input"'
                                + ' style="font-size:0.72rem;padding:0.2rem 0.4rem;width:100%"'
                                + ' placeholder="e.g. AWS RDS PostgreSQL, GCP Cloud SQL, etc.">'
                                + '</div>';

                            h += '<div style="font-size:0.72rem;color:var(--accent);font-weight:600;margin-bottom:0.25rem">‚ñ∏ '
                                + '<span id="k8s-infra-envlabel-' + eName + '">' + (isInfraManaged ? 'Connection Environment Variables' : 'Environment Variables') + '</span>'
                                + '</div>';
                            if (infraEnvKeys.length > 0) {
                                h += '<div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;margin-bottom:0.2rem;padding:0 0.25rem">'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Key</span>'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Value</span>'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Var / Secret</span>'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Injection</span>'
                                    + '<span></span>'
                                    + '</div>';
                            }
                            h += '<div id="k8s-svc-env-list-' + infraId + '" style="display:flex;flex-direction:column;gap:0.2rem">';
                            if (savedInfra?.envVars) {
                                savedInfra.envVars.forEach((ev, j) => {
                                    h += _envRowHtml(infraId, j, ev.key, ev.value || '', ev.type || 'hardcoded', ev.varName || '', infraId);
                                });
                            } else {
                                Object.entries(infraEnvVals).forEach(([k, v], j) => {
                                    const injType = _isSecretKey(k) ? 'secret' : 'variable';
                                    h += _envRowHtml(infraId, j, k, v || '', injType, '${' + k + '}', infraId);
                                });
                            }
                            h += '</div>';
                            h += '<button type="button" onclick="_addEnvVar(\'' + infraId + '\')"'
                                + ' style="margin-top:0.3rem;font-size:0.66rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.2rem 0.5rem;cursor:pointer;width:100%">'
                                + '+ Add variable'
                                + '</button>';

                            // ‚îÄ‚îÄ Persistent Storage section (hidden for Managed) ‚îÄ‚îÄ
                            const infraVols = svc.volumes || [];
                            // Use saved volumes when available for infra
                            const classifiedVols = savedInfra?.volumes
                                ? savedInfra.volumes.map(vol => window._savedVolToClassification(vol))
                                : infraVols.map(v => window._classifyVolume(v)).filter(cl => cl.classification === 'named' || cl.classification === 'data-bind');
                            const showVolSec = infraKindDefault !== 'Managed' ? 'block' : 'none';

                            h += '<div id="k8s-infra-vol-section-' + eName + '" style="display:' + showVolSec + ';margin-top:0.5rem;padding-top:0.4rem;border-top:1px solid var(--border-subtle)">';
                            h += '<details' + (classifiedVols.length > 0 ? ' open' : '') + '>';
                            h += '<summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);font-weight:600;user-select:none;display:flex;align-items:center;gap:0.3rem">'
                                + '‚ñ∏ Persistent Storage'
                                + (classifiedVols.length > 0 ? ' <span style="font-size:0.6rem;background:var(--bg-secondary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">' + classifiedVols.length + ' from Compose</span>' : '')
                                + '<span id="k8s-svc-vol-summary-' + infraId + '" style="margin-left:auto;font-size:0.6rem;color:var(--text-muted);font-weight:400"></span>'
                                + '</summary>';
                            h += '<div style="margin-top:0.25rem;padding:0.3rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">';
                            h += '<div id="k8s-svc-vol-list-' + infraId + '" style="display:flex;flex-direction:column;gap:0.3rem">';
                            if (classifiedVols.length > 0) {
                                classifiedVols.forEach((cl, j) => {
                                    h += window._volRowHtml(infraId, j, cl);
                                });
                            } else {
                                h += '<div style="font-size:0.68rem;color:var(--text-muted);font-style:italic">No named volumes detected ‚Äî click "+ Add volume" below</div>';
                            }
                            h += '</div>';
                            h += '<button type="button" onclick="window._addVolRow(\'' + infraId + '\')"'
                                + ' style="margin-top:0.3rem;font-size:0.66rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.2rem 0.5rem;cursor:pointer;width:100%">'
                                + '+ Add volume'
                                + '</button>';
                            h += '</div>';
                            h += '</details>';
                            h += '</div>';

                            h += '</div>'; // close cfg panel
                            h += '</div>'; // close outer card
                            return h;
                        };

                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        // ‚îÄ‚îÄ Section B: Infrastructure Services ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                        html += wizSection('Infrastructure Services',
                            infraSvcs.length > 0
                                ? `${infraSvcs.length} infrastructure service${infraSvcs.length !== 1 ? 's' : ''} detected. Choose how to handle each in K8s.`
                                : 'No infrastructure services detected from Docker. Add services below if needed.');

                        html += `<div style="display:flex;flex-direction:column;gap:0.4rem" id="k8s-infra-list">`;
                        for (let i = 0; i < infraSvcs.length; i++) {
                            html += window._k8sInfraCardHtml(infraSvcs[i], _savedInfra(infraSvcs[i].name));
                        }
                        html += `</div>`;
                        html += `<div style="margin-top:0.4rem;display:flex;gap:0.4rem;align-items:center">`;
                        html += `<select id="k8s-infra-add-select" class="modal-form-select"
                            style="font-size:0.74rem;padding:0.3rem 0.5rem;flex:1;max-width:320px"
                            onchange="if(this.value)window._k8sAddInfra(this.value);this.value=''">
                            <option value="">+ Add infrastructure service‚Ä¶</option>
                        </select>`;
                        html += `</div>`;

                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        // ‚îÄ‚îÄ Section C: Cluster Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                        html += wizSection('Cluster Settings', 'Common settings for all K8s resources.');
                        html += wizFormGrid([
                            { name: 'k8s-namespace', label: 'Namespace', value: _savedState?.namespace || data.namespace || defaultNamespace, hint: 'Target K8s namespace for all resources' },
                            { name: 'k8s-output-dir', label: 'Output Directory', value: _savedState?.output_dir || 'k8s/', hint: 'Where manifest files will be written' },
                        ]);
                        html += wizFormGrid([
                            { name: 'k8s-ingress', label: 'Generate Ingress manifest', type: 'checkbox', value: _savedState?.ingress ?? false, fullWidth: true },
                            // ConfigMap checkbox removed ‚Äî ConfigMaps/Secrets auto-generated per service from envVars
                        ]);

                        // ‚îÄ‚îÄ Skaffold pipeline toggle + config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        const _skfSaved = _savedState?.skaffold_config || {};
                        const _skfChecked = (_savedState?.skaffold ?? true);
                        const _helmEnabled = (_savedState?.helm_chart ?? false);
                        html += `
                        <div id="k8s-skaffold-panel" style="margin-top:0.6rem;padding:0.7rem 0.8rem;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset)">
                            <div style="display:flex;align-items:flex-start;gap:0.5rem">
                                <input type="checkbox" id="k8s-skaffold-toggle"${_skfChecked ? ' checked' : ''}
                                       style="margin-top:3px;accent-color:var(--accent);cursor:pointer"
                                       onchange="document.getElementById('k8s-skaffold-cfg').style.display=this.checked?'block':'none'">
                                <div style="flex:1">
                                    <label for="k8s-skaffold-toggle" style="font-weight:600;font-size:0.82rem;cursor:pointer;display:block;margin-bottom:2px">
                                        üõ§ Generate Skaffold pipeline (<code>skaffold.yaml</code>)
                                    </label>
                                    <div style="font-size:0.72rem;color:var(--text-muted);line-height:1.45">
                                        <a href="https://skaffold.dev" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">Skaffold</a>
                                        automates <strong>build ‚Üí push ‚Üí deploy</strong> for K8s.
                                        Run <code>skaffold dev</code> for live-reload or <code>skaffold run</code> for one-shot deploys.
                                    </div>
                                </div>
                            </div>
                            <div id="k8s-skaffold-status" style="margin-top:0.5rem;font-size:0.74rem">
                                <span class="spinner" style="width:12px;height:12px;display:inline-block;vertical-align:middle"></span>
                                <span style="color:var(--text-muted);margin-left:4px">Checking Skaffold CLI‚Ä¶</span>
                            </div>
                            <div id="k8s-skaffold-cfg" style="display:${_skfChecked ? 'block' : 'none'};margin-top:0.5rem;padding:0.5rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">

                                <!-- Row 1: Deploy Method + Tag Policy -->
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem">
                                    <div>
                                        <label style="font-size:0.72rem;font-weight:600;color:var(--text-muted);display:block;margin-bottom:2px">Deploy Method</label>
                                        <select id="k8s-skaffold-deploy" class="modal-form-select" style="font-size:0.74rem;padding:0.25rem 0.4rem;width:100%">
                                            <option value="kustomize"${(_skfSaved.deploy_method||'kustomize')==='kustomize'?' selected':''}>kustomize (overlays)</option>
                                            <option value="kubectl"${_skfSaved.deploy_method==='kubectl'?' selected':''}>kubectl (raw manifests)</option>
                                            <option value="helm" id="k8s-skaffold-deploy-helm"${_skfSaved.deploy_method==='helm'?' selected':''}${!_helmEnabled?' disabled':''}>helm (chart)${!_helmEnabled?' ‚Äî enable Helm below':''}</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label style="font-size:0.72rem;font-weight:600;color:var(--text-muted);display:block;margin-bottom:2px">Tag Policy</label>
                                        <select id="k8s-skaffold-tag" class="modal-form-select" style="font-size:0.74rem;padding:0.25rem 0.4rem;width:100%">
                                            <option value="gitCommit"${(_skfSaved.tag_policy||'gitCommit')==='gitCommit'?' selected':''}>gitCommit (SHA/tag)</option>
                                            <option value="sha256"${_skfSaved.tag_policy==='sha256'?' selected':''}>sha256 (content hash)</option>
                                            <option value="dateTime"${_skfSaved.tag_policy==='dateTime'?' selected':''}>dateTime (timestamp)</option>
                                            <option value="inputDigest"${_skfSaved.tag_policy==='inputDigest'?' selected':''}>inputDigest (build inputs)</option>
                                            <option value="envTemplate"${_skfSaved.tag_policy==='envTemplate'?' selected':''}>envTemplate (custom)</option>
                                        </select>
                                    </div>
                                </div>

                                <!-- Row 2: Profiles ‚Äî per-profile config cards -->
                                <div style="margin-top:0.5rem">
                                    <label style="font-size:0.72rem;font-weight:600;color:var(--text-muted);display:block;margin-bottom:4px">Profiles</label>
                                    <div id="k8s-skaffold-profiles" style="display:flex;flex-direction:column;gap:0.3rem">
                                    </div>
                                    <div style="display:flex;gap:0.3rem;margin-top:0.35rem">
                                        <input id="k8s-skaffold-profile-input" class="modal-form-input" type="text"
                                            style="font-size:0.72rem;padding:0.2rem 0.4rem;flex:1;max-width:180px"
                                            placeholder="profile name" onkeydown="if(event.key==='Enter'){event.preventDefault();window._skfAddProfile();}">
                                        <button type="button" onclick="window._skfAddProfile()"
                                            style="font-size:0.66rem;padding:0.2rem 0.5rem;border:1px dashed var(--border-subtle);border-radius:4px;background:none;color:var(--accent);cursor:pointer">
                                            + Add profile
                                        </button>
                                    </div>
                                </div>

                                <!-- Row 3: Global toggles -->
                                <div style="margin-top:0.4rem;display:flex;flex-wrap:wrap;gap:0.6rem 1rem">
                                    <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.74rem;cursor:pointer">
                                        <input type="checkbox" id="k8s-skaffold-portfwd"${(_skfSaved.port_forward ?? true) ? ' checked' : ''}
                                            style="accent-color:var(--accent)"> Port forwarding
                                    </label>
                                    <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.74rem;cursor:pointer">
                                        <input type="checkbox" id="k8s-skaffold-sync"${(_skfSaved.file_sync ?? false) ? ' checked' : ''}
                                            style="accent-color:var(--accent)"> File sync (hot reload)
                                    </label>
                                    <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.74rem;cursor:pointer">
                                        <input type="checkbox" id="k8s-skaffold-ssa"${(_skfSaved.server_side_apply ?? false) ? ' checked' : ''}
                                            style="accent-color:var(--accent)"> Server-side apply
                                    </label>
                                    <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.74rem;cursor:pointer">
                                        <input type="checkbox" id="k8s-skaffold-verify"${(_skfSaved.post_deploy_verify ?? true) ? ' checked' : ''}
                                            style="accent-color:var(--accent)"> Post-deploy verify
                                    </label>
                                </div>

                                <!-- Row 4: Lifecycle hooks (collapsible) -->
                                <details style="margin-top:0.4rem">
                                    <summary style="font-size:0.72rem;font-weight:600;color:var(--text-muted);cursor:pointer;user-select:none">
                                        ‚ñ∏ Lifecycle hooks
                                    </summary>
                                    <div style="margin-top:0.25rem;display:grid;grid-template-columns:1fr 1fr;gap:0.4rem">
                                        <div>
                                            <label style="font-size:0.68rem;color:var(--text-muted);display:block;margin-bottom:2px">Pre-deploy commands (one per line)</label>
                                            <textarea id="k8s-skaffold-pre-deploy" class="modal-form-input" rows="2"
                                                style="font-size:0.72rem;padding:0.2rem 0.3rem;font-family:var(--font-mono,monospace);resize:vertical;min-height:32px"
                                                placeholder="e.g. make migrate">${esc((_skfSaved.pre_deploy || []).join('\\n'))}</textarea>
                                        </div>
                                        <div>
                                            <label style="font-size:0.68rem;color:var(--text-muted);display:block;margin-bottom:2px">Post-deploy commands (one per line)</label>
                                            <textarea id="k8s-skaffold-post-deploy" class="modal-form-input" rows="2"
                                                style="font-size:0.72rem;padding:0.2rem 0.3rem;font-family:var(--font-mono,monospace);resize:vertical;min-height:32px"
                                                placeholder="e.g. curl http://localhost/healthz">${esc((_skfSaved.post_deploy || []).join('\\n'))}</textarea>
                                        </div>
                                    </div>
                                </details>

                            </div>
                        </div>

                        <div id="k8s-helm-chart-panel" style="margin-top:0.5rem;padding:0.7rem 0.8rem;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset)">
                            <div style="display:flex;align-items:flex-start;gap:0.5rem">
                                <input type="checkbox" id="k8s-helm-chart-toggle"${(_savedState?.helm_chart ?? false) ? ' checked' : ''}
                                       style="margin-top:3px;accent-color:var(--accent);cursor:pointer"
                                       onchange="document.getElementById('k8s-helm-cfg').style.display=this.checked?'block':'none';var ho=document.getElementById('k8s-skaffold-deploy-helm');if(ho){ho.disabled=!this.checked;ho.textContent=this.checked?'helm (chart)':'helm (chart) ‚Äî enable Helm below';var ds=document.getElementById('k8s-skaffold-deploy');if(!this.checked&&ds&&ds.value==='helm')ds.value='kubectl';}">
                                <div style="flex:1">
                                    <label for="k8s-helm-chart-toggle" style="font-weight:600;font-size:0.82rem;cursor:pointer;display:block;margin-bottom:2px">
                                        ‚éà Generate Helm chart (<code>charts/</code>)
                                    </label>
                                    <div style="font-size:0.72rem;color:var(--text-muted);line-height:1.45">
                                        <a href="https://helm.sh" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">Helm</a>
                                        packages your K8s manifests into a versioned, parameterised chart with
                                        <code>values.yaml</code> for per-environment overrides.
                                    </div>
                                </div>
                            </div>
                            <div id="k8s-helm-status" style="margin-top:0.5rem;font-size:0.72rem;color:var(--text-muted)">
                                üí° Helm CLI is only needed at deploy time ‚Äî chart generation works without it.
                            </div>
                            <div id="k8s-helm-cfg" style="display:${(_savedState?.helm_chart ?? false) ? 'block' : 'none'};margin-top:0.5rem;padding:0.5rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem">
                                    <div>
                                        <label style="font-size:0.72rem;font-weight:600;color:var(--text-muted);display:block;margin-bottom:2px">Chart Name</label>
                                        <input id="k8s-helm-chart-name" class="modal-form-input" type="text"
                                            style="font-size:0.74rem;padding:0.25rem 0.4rem;width:100%"
                                            value="${esc(_savedState?.helm_config?.chart_name || '')}" placeholder="my-app">
                                    </div>
                                    <div>
                                        <label style="font-size:0.72rem;font-weight:600;color:var(--text-muted);display:block;margin-bottom:2px">Chart Directory</label>
                                        <input id="k8s-helm-chart-dir" class="modal-form-input" type="text"
                                            style="font-size:0.74rem;padding:0.25rem 0.4rem;width:100%"
                                            value="${esc(_savedState?.helm_config?.chart_dir || 'charts/')}" placeholder="charts/">
                                    </div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr 2fr;gap:0.4rem;margin-top:0.4rem">
                                    <div>
                                        <label style="font-size:0.72rem;font-weight:600;color:var(--text-muted);display:block;margin-bottom:2px">Chart Version</label>
                                        <input id="k8s-helm-chart-version" class="modal-form-input" type="text"
                                            style="font-size:0.74rem;padding:0.25rem 0.4rem;width:100%"
                                            value="${esc(_savedState?.helm_config?.chart_version || '0.1.0')}" placeholder="0.1.0">
                                    </div>
                                    <div>
                                        <label style="font-size:0.72rem;font-weight:600;color:var(--text-muted);display:block;margin-bottom:2px">App Version</label>
                                        <input id="k8s-helm-app-version" class="modal-form-input" type="text"
                                            style="font-size:0.74rem;padding:0.25rem 0.4rem;width:100%"
                                            value="${esc(_savedState?.helm_config?.app_version || '1.0.0')}" placeholder="1.0.0">
                                    </div>
                                    <div>
                                        <label style="font-size:0.72rem;font-weight:600;color:var(--text-muted);display:block;margin-bottom:2px">Description</label>
                                        <input id="k8s-helm-chart-desc" class="modal-form-input" type="text"
                                            style="font-size:0.74rem;padding:0.25rem 0.4rem;width:100%"
                                            value="${esc(_savedState?.helm_config?.description || '')}" placeholder="A Helm chart for my application">
                                    </div>
                                </div>
                                <div style="margin-top:0.4rem;display:flex;gap:1rem">
                                    <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.74rem;cursor:pointer">
                                        <input type="checkbox" id="k8s-helm-env-values"${(_savedState?.helm_config?.env_values ?? true) ? ' checked' : ''}
                                            style="accent-color:var(--accent)"> Per-env values files
                                    </label>
                                    <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.74rem;cursor:pointer">
                                        <input type="checkbox" id="k8s-helm-helmignore"${(_savedState?.helm_config?.helmignore ?? true) ? ' checked' : ''}
                                            style="accent-color:var(--accent)"> Generate .helmignore
                                    </label>
                                </div>
                            </div>
                        </div>`;

                        // Store source list sizes for collect()
                        data._appSvcCount = hasCompose ? appSvcs.length : deployableModules.length;
                        data._infraSvcCount = infraSvcs.length;
                        data._configMode = hasCompose ? 'compose' : (deployableModules.length > 0 ? 'modules' : 'manual');

                        el.innerHTML = html;

