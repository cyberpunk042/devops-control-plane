                // â”€â”€ Step 1: Detect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // â”€â”€ Serve from cache if available â”€â”€
                        const _CK = 'k8s:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // â”€â”€ Fresh scan â”€â”€
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Analyzing project for Kubernetes deploymentâ€¦</p>';
                        try {
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;

                            // â”€â”€ Extract all data sources â”€â”€
                            const probes = wizDetect.status_probes || {};
                            const k8s = probes.k8s || {};
                            const docker = probes.docker || {};
                            const dockerStatus = wizDetect.docker_status || {};
                            const configData = wizDetect.config_data || {};
                            const modules = configData.modules || [];
                            const envs = configData.environments || [];
                            const ghRepo = wizDetect.gh_repo_info || {};
                            const composeDetails = dockerStatus.compose_service_details || [];

                            // â”€â”€ Classify modules â”€â”€
                            const classifiedModules = modules.map(m => ({
                                ...m,
                                _class: _k8sModClass(m),
                            }));
                            const deployableModules = classifiedModules.filter(m => m._class === 'deployable');
                            const moduleNames = modules.map(m => m.name);

                            // â”€â”€ Classify compose services â”€â”€
                            const classifiedServices = composeDetails.map(svc => ({
                                ...svc,
                                _class: _k8sSvcClass(svc, moduleNames),
                                _image: _k8sImageName(svc, ghRepo),
                                _port: _k8sPrimaryPort(svc),
                            }));
                            const appServices = classifiedServices.filter(s => s._class === 'application');
                            const infraServices = classifiedServices.filter(s => s._class === 'infrastructure');

                            // â”€â”€ Store all data for subsequent steps â”€â”€
                            data._k8s = k8s;
                            data._docker = docker;
                            data._dockerStatus = dockerStatus;
                            data._modules = modules;
                            data._classifiedModules = classifiedModules;
                            data._composeServices = classifiedServices;
                            data._appServices = appServices;
                            data._infraServices = infraServices;
                            data._ghRepo = ghRepo;
                            data._envs = envs;

                            // Fetch vault keys (secrets + config vars)
                            try {
                                const vaultData = await api('/vault/keys');
                                data._vaultKeys = (vaultData && vaultData.keys) || [];
                            } catch(e) { data._vaultKeys = []; }


                            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            // â”€â”€ BUILD DETECT HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                            // â”€â”€ Read-only scan banner â”€â”€
                            let html = `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;margin-bottom:var(--space-sm);font-size:0.82rem;background:color-mix(in srgb, var(--accent) 10%, var(--bg-inset));border:1px solid color-mix(in srgb, var(--accent) 30%, transparent);border-radius:8px">
                                <span style="font-size:1.1rem">ğŸ”</span>
                                <span style="flex:1;color:var(--text-secondary)">This is a <strong>read-only scan</strong>. To configure K8s resources, proceed to Configure.</span>
                                <button type="button" class="btn btn-xs" style="background:var(--accent);color:white;border:none;padding:4px 12px;border-radius:6px;font-size:0.78rem;white-space:nowrap;cursor:pointer"
                                    onclick="document.getElementById('wiz-btn-next')?.click()">Configure â†’</button>
                            </div>`;

                            // â”€â”€ Section 1: Kubernetes Environment â”€â”€
                            html += wizSection('Kubernetes Environment', 'Current K8s tooling and cluster status.', 'k8s-detect-env');
                            html += `<div class="wiz-status-grid">
                                ${wizStatusRow('â˜¸ï¸', 'kubectl', k8s.has_kubectl ? 'Available' : 'Not found', k8s.has_kubectl ? 'ok' : 'error', false, 'k8s-detect-kubectl')}
                                ${wizStatusRow('âˆ', 'Helm', k8s.has_helm ? 'Available' : 'Not found', k8s.has_helm ? 'ok' : 'muted', false, 'k8s-detect-helm')}
                                ${wizStatusRow('ğŸ”—', 'Cluster', k8s.cluster_connected ? 'Connected' : 'Not connected', k8s.cluster_connected ? 'ok' : 'warn', false, 'k8s-detect-cluster')}
                                ${wizStatusRow('ğŸ“„', 'Manifests', k8s.manifest_count > 0 ? `${k8s.manifest_count} found` : 'None', k8s.manifest_count > 0 ? 'ok' : 'muted', false, 'k8s-detect-manifests')}
                                ${wizStatusRow('ğŸ“¦', 'Helm Chart', k8s.has_chart ? 'Present' : 'None', k8s.has_chart ? 'ok' : 'muted', false, 'k8s-detect-chart')}
                            </div>`;

                            // â”€â”€ Section 2: Docker Context â”€â”€
                            html += wizSection('Docker Context', 'Container infrastructure feeding K8s deployments.', 'k8s-detect-docker');
                            html += `<div class="wiz-status-grid">
                                ${wizStatusRow('ğŸ³', 'Docker', dockerStatus.available ? 'Available' : 'Not installed', dockerStatus.available ? 'ok' : 'error', false, 'k8s-detect-docker-cli')}
                                ${wizStatusRow('ğŸ“‹', 'Compose file', docker.has_compose ? (dockerStatus.compose_file || 'Present') : 'Missing', docker.has_compose ? 'ok' : 'warn', false, 'k8s-detect-compose-file')}
                                ${wizStatusRow('ğŸ“„', 'Dockerfiles', docker.has_dockerfile ? `${(dockerStatus.dockerfiles || []).length} found` : 'Missing', docker.has_dockerfile ? 'ok' : 'warn', false, 'k8s-detect-dockerfiles')}
                            </div>`;

                            if (!docker.has_dockerfile && !docker.has_compose) {
                                html += `<div id="k8s-detect-docker-warn" class="wiz-step-warn-panel" style="margin-top:0.5rem">
                                    <span>ğŸ’¡</span>
                                    <span style="flex:1">Set up Docker first â€” K8s deployments need container images.</span>
                                    <button class="btn btn-sm btn-secondary" style="flex-shrink:0" onclick="wizardModalClose(); setTimeout(openDockerSetupWizard, 200)">Setup Docker â†’</button>
                                </div>`;
                            }

                            // â”€â”€ Section 3: Compose Services (the key intelligence) â”€â”€
                            if (composeDetails.length > 0) {
                                html += wizSection(
                                    'Compose Services',
                                    `${composeDetails.length} service${composeDetails.length !== 1 ? 's' : ''} detected â€” ${appServices.length} application, ${infraServices.length} infrastructure.`,
                                    'k8s-detect-compose'
                                );
                                html += `<div id="k8s-detect-svc-list" style="display:flex;flex-direction:column;gap:0.25rem">`;
                                for (const svc of classifiedServices) {
                                    const isApp = svc._class === 'application';
                                    const badgeColor = isApp ? 'var(--success)' : 'var(--text-muted)';
                                    const badgeIcon = isApp ? 'ğŸš€' : 'ğŸ—„ï¸';
                                    const badgeLabel = isApp ? 'application' : 'infrastructure';
                                    const portStr = svc.ports.length > 0
                                        ? svc.ports.map(p => `:${p.container}`).join(' ')
                                        : '';
                                    const imgStr = svc.image
                                        ? svc.image.split('/').pop().split(':')[0]
                                        : (svc.build ? 'builds locally' : 'â€”');

                                    html += `<div class="k8s-detect-svc-row" style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.3rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                        <span style="width:18px;text-align:center">${badgeIcon}</span>
                                        <strong style="min-width:80px">${esc(svc.name)}</strong>
                                        <code class="wiz-badge">${esc(imgStr)}</code>
                                        ${portStr ? `<code class="wiz-note">${esc(portStr)}</code>` : ''}
                                        <span style="flex:1"></span>
                                        ${Object.keys(svc.environment || {}).length > 0 ? `<span class="wiz-note" title="${Object.keys(svc.environment).length} env vars">ğŸ”§${Object.keys(svc.environment).length}</span>` : ''}
                                        ${svc.volumes.length > 0 ? `<span class="wiz-note" title="${svc.volumes.length} volumes">ğŸ’¾${svc.volumes.length}</span>` : ''}
                                        ${svc.healthcheck ? '<span class="wiz-note" title="Has healthcheck">â¤ï¸</span>' : ''}
                                        <span style="font-size:0.68rem;color:${badgeColor}">${badgeLabel}</span>
                                    </div>`;
                                }
                                html += `</div>`;

                                if (appServices.length > 0) {
                                    html += `<div style="margin-top:0.5rem;font-size:0.78rem;color:var(--text-secondary)">
                                        ğŸ’¡ <strong>${appServices.length}</strong> application service${appServices.length !== 1 ? 's' : ''} will become K8s Deployments.
                                        ${infraServices.length > 0 ? `<strong>${infraServices.length}</strong> infrastructure service${infraServices.length !== 1 ? 's' : ''} â€” choose StatefulSet, managed, or skip.` : ''}
                                    </div>`;
                                }
                            } else if (deployableModules.length > 0) {
                                // No compose but we have modules
                                html += wizSection('Project Modules', `${deployableModules.length} deployable module${deployableModules.length !== 1 ? 's' : ''} detected.`, 'k8s-detect-modules');
                                html += `<div id="k8s-detect-mod-list" style="display:flex;flex-direction:column;gap:0.25rem">`;
                                for (const m of classifiedModules) {
                                    const isDep = m._class === 'deployable';
                                    const badgeColor = isDep ? 'var(--success)' : 'var(--text-muted)';
                                    const badgeIcon = isDep ? 'ğŸŸ¢' : m._class === 'library' ? 'ğŸ“š' : m._class === 'docs' ? 'ğŸ“' : 'âš™ï¸';
                                    html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.3rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                        <span style="width:18px;text-align:center">${badgeIcon}</span>
                                        <strong style="min-width:80px">${esc(m.name)}</strong>
                                        <code class="wiz-badge">${esc(m.stack || '?')}</code>
                                        <span style="flex:1;color:var(--text-muted);font-size:0.72rem">${esc(m.path || '')}</span>
                                        <span style="font-size:0.68rem;color:${badgeColor}">${m._class}</span>
                                    </div>`;
                                }
                                html += `</div>`;
                            }

                            // â”€â”€ Section 4: Image Registry Context â”€â”€
                            if (ghRepo.owner) {
                                html += wizSection('Registry Context', 'Container image naming from GitHub.', 'k8s-detect-registry');
                                html += `<div class="wiz-status-grid">
                                    ${wizStatusRow('ğŸ™', 'Repository', `${ghRepo.owner}/${ghRepo.name}`, 'ok', false, 'k8s-detect-repo')}
                                    ${wizStatusRow('ğŸ“¦', 'Registry', `ghcr.io/${ghRepo.owner}/${ghRepo.name}`, 'ok', false, 'k8s-detect-registry-url')}
                                </div>`;
                            }

                            // â”€â”€ Section 5: Environments â”€â”€
                            if (envs.length > 0) {
                                html += wizSection('Environments', `${envs.length} deployment environment${envs.length !== 1 ? 's' : ''} configured.`, 'k8s-detect-envs');
                                html += `<div id="k8s-detect-env-list" style="display:flex;flex-wrap:wrap;gap:0.3rem">`;
                                for (const env of envs) {
                                    html += `<span style="display:inline-flex;align-items:center;gap:0.25rem;font-size:0.78rem;padding:0.2rem 0.5rem;border-radius:4px;background:var(--bg-inset);border:1px solid var(--border-subtle)">
                                        ${env.default ? 'â­' : 'ğŸ·ï¸'} ${esc(env.name)}
                                    </span>`;
                                }
                                html += `</div>`;
                            }

                            // â”€â”€ Cache and set HTML â”€â”€
                            const cacheData = {
                                _k8s: data._k8s,
                                _docker: data._docker,
                                _dockerStatus: data._dockerStatus,
                                _modules: data._modules,
                                _classifiedModules: data._classifiedModules,
                                _composeServices: data._composeServices,
                                _appServices: data._appServices,
                                _infraServices: data._infraServices,
                                _ghRepo: data._ghRepo,
                                _envs: data._envs,
                            };
                            wizStore(_CK, { h: html, d: cacheData }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>âš ï¸</span><span>${esc(e.message)}</span></div>`;
                        }
                    },
                },

