<!-- Integrations â€” Kubernetes Setup Wizard
     Depends on: _integrations_setup_shared.html
-->
<script>

    // â”€â”€ Kubernetes Setup Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function openK8sSetupWizard() {

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        /** Classify a module for K8s (same logic as Docker wizard). */
        function _k8sModClass(mod) {
            const dom = (mod.domain || '').toLowerCase();
            const st  = (mod.stack  || '').toLowerCase();
            if (dom === 'library')  return 'library';
            if (dom === 'docs' || st === 'markdown') return 'docs';
            if (['kubernetes', 'helm', 'terraform', 'docker-compose'].includes(st)) return 'ops-tool';
            return 'deployable';
        }

        /**
         * Classify a compose service as 'application' or 'infrastructure'.
         * Infrastructure = well-known DB/cache/broker images with no build context.
         * Application = has build context, or image matches project/module name.
         */
        function _k8sSvcClass(svc, moduleNames) {
            // Has build config â†’ definitely an application
            if (svc.build) return 'application';
            // Image matches a project module name â†’ application
            if (svc.image && moduleNames.some(n => svc.image.includes(n))) return 'application';
            // Well-known infrastructure image prefixes
            const infraImages = [
                'postgres', 'mysql', 'mariadb', 'mongo', 'redis', 'valkey', 'memcached',
                'rabbitmq', 'kafka', 'nats', 'mosquitto', 'elasticsearch', 'opensearch',
                'nginx', 'traefik', 'haproxy', 'envoy', 'caddy',
                'grafana', 'prometheus', 'jaeger', 'zipkin', 'loki',
                'minio', 'vault', 'consul', 'etcd', 'zookeeper',
                'mailpit', 'adminer', 'pgadmin', 'neo4j', 'cassandra',
                'cockroachdb', 'couchdb', 'influxdb', 'clickhouse', 'timescale',
                'redpanda', 'activemq', 'pulsar', 'celery',
                'gitea', 'portainer', 'seq', 'vector', 'fluentd', 'logstash',
                'keycloak', 'dex', 'hydra',
                'localstack', 'dynamodb-local', 'azurite',
                'dragonfly', 'keydb', 'arangodb', 'surrealdb',
            ];
            const imgLower = (svc.image || '').toLowerCase();
            if (infraImages.some(prefix => imgLower.includes(prefix))) return 'infrastructure';
            // No build + no known infra image â†’ treat as application (external image)
            return 'application';
        }

        /**
         * Classify what K8s workload kind a compose service should default to.
         * Returns: 'Deployment' | 'StatefulSet' | 'DaemonSet' | 'Job' | 'CronJob'
         */
        function _classifyWorkloadKind(svc) {
            const img = (svc.image || '').split(':')[0].split('/').pop().toLowerCase();
            const name = (svc.name || '').toLowerCase();

            // 1. Well-known stateful databases / brokers â†’ StatefulSet
            const statefulImages = new Set([
                'postgres', 'mysql', 'mariadb', 'mongo', 'mongodb', 'redis', 'valkey',
                'cassandra', 'cockroachdb', 'couchdb', 'neo4j', 'influxdb', 'clickhouse',
                'timescaledb', 'surrealdb', 'arangodb', 'dragonfly', 'keydb',
                'elasticsearch', 'opensearch', 'kafka', 'rabbitmq', 'nats',
                'redpanda', 'activemq', 'pulsar', 'zookeeper', 'etcd', 'consul',
                'minio', 'vault',
            ]);
            if (statefulImages.has(img)) return 'StatefulSet';

            // 2. Well-known node-level agents â†’ DaemonSet
            const daemonImages = new Set([
                'fluentd', 'fluent-bit', 'fluentbit', 'logstash', 'vector',
                'filebeat', 'metricbeat', 'node-exporter', 'promtail',
                'datadog-agent', 'newrelic-infra', 'falco',
            ]);
            if (daemonImages.has(img)) return 'DaemonSet';

            // 3. Compose deploy.mode: global â†’ DaemonSet
            if (svc.deploy && svc.deploy.mode === 'global') return 'DaemonSet';

            // 4. No ports + one-shot signals â†’ Job
            const noPorts = !svc.ports || svc.ports.length === 0;
            const isOneShot = svc.restart === 'no' || svc.restart === 'on-failure';
            const jobNamePatterns = ['migrate', 'migration', 'seed', 'init-db', 'setup', 'import'];
            const nameIsJob = jobNamePatterns.some(p => name.includes(p));
            if (noPorts && (isOneShot || nameIsJob)) return 'Job';

            // 5. Default â†’ Deployment
            return 'Deployment';
        }

        /** Map workload kind â†’ icon for display. */
        function _kindIcon(kind) {
            const icons = {
                'Deployment': 'ğŸš€', 'StatefulSet': 'ğŸ—„ï¸', 'DaemonSet': 'ğŸŒ',
                'Job': 'âš¡', 'CronJob': 'â°', 'Managed': 'â˜ï¸', 'Skip': 'â­ï¸',
            };
            return icons[kind] || 'ğŸ“¦';
        }

        /** Map workload kind â†’ hint text explaining the heuristic. */
        function _kindHint(kind, svc) {
            const img = (svc.image || '').split(':')[0].split('/').pop().toLowerCase();
            switch (kind) {
                case 'StatefulSet': return 'ğŸ’¡ Database/stateful image detected â†’ stable identity + per-pod storage';
                case 'DaemonSet':
                    if (svc.deploy && svc.deploy.mode === 'global') return 'ğŸ’¡ Compose deploy.mode: global â†’ one pod per node';
                    return 'ğŸ’¡ Node-level agent detected â†’ one pod per node';
                case 'Job': return 'ğŸ’¡ No ports + one-shot restart â†’ run-to-completion task';
                case 'Deployment': return '';
                default: return '';
            }
        }

        /** Resolve best image name for a service in K8s context. */
        function _k8sImageName(svc, ghRepo) {
            // 1. If compose has explicit image â†’ use it
            if (svc.image) return svc.image;
            // 2. If we have a GitHub repo â†’ construct from registry
            if (ghRepo && ghRepo.owner && ghRepo.name) {
                return `ghcr.io/${ghRepo.owner}/${ghRepo.name}-${svc.name}:latest`;
            }
            // 3. Fallback
            return `${svc.name}:latest`;
        }

        /** Get the primary container port from a compose service. */
        function _k8sPrimaryPort(svc) {
            if (svc.ports && svc.ports.length > 0) return svc.ports[0].container;
            return 8080;
        }

        wizardModalOpen({
            title: 'â˜¸ï¸ Kubernetes Setup',
            size: 'wide',
            steps: [
                // â”€â”€ Step 1: Detect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // â”€â”€ Serve from cache if available â”€â”€
                        const _CK = 'k8s:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // â”€â”€ Fresh scan â”€â”€
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Analyzing project for Kubernetes deploymentâ€¦</p>';
                        try {
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;

                            // â”€â”€ Extract all data sources â”€â”€
                            const probes = wizDetect.status_probes || {};
                            const k8s = probes.k8s || {};
                            const docker = probes.docker || {};
                            const dockerStatus = wizDetect.docker_status || {};
                            const configData = wizDetect.config_data || {};
                            const modules = configData.modules || [];
                            const envs = configData.environments || [];
                            const ghRepo = wizDetect.gh_repo_info || {};
                            const composeDetails = dockerStatus.compose_service_details || [];

                            // â”€â”€ Classify modules â”€â”€
                            const classifiedModules = modules.map(m => ({
                                ...m,
                                _class: _k8sModClass(m),
                            }));
                            const deployableModules = classifiedModules.filter(m => m._class === 'deployable');
                            const moduleNames = modules.map(m => m.name);

                            // â”€â”€ Classify compose services â”€â”€
                            const classifiedServices = composeDetails.map(svc => ({
                                ...svc,
                                _class: _k8sSvcClass(svc, moduleNames),
                                _image: _k8sImageName(svc, ghRepo),
                                _port: _k8sPrimaryPort(svc),
                            }));
                            const appServices = classifiedServices.filter(s => s._class === 'application');
                            const infraServices = classifiedServices.filter(s => s._class === 'infrastructure');

                            // â”€â”€ Store all data for subsequent steps â”€â”€
                            data._k8s = k8s;
                            data._docker = docker;
                            data._dockerStatus = dockerStatus;
                            data._modules = modules;
                            data._classifiedModules = classifiedModules;
                            data._composeServices = classifiedServices;
                            data._appServices = appServices;
                            data._infraServices = infraServices;
                            data._ghRepo = ghRepo;
                            data._envs = envs;

                            // Fetch vault keys (secrets + config vars)
                            try {
                                const vaultData = await api('/vault/keys');
                                data._vaultKeys = (vaultData && vaultData.keys) || [];
                            } catch(e) { data._vaultKeys = []; }


                            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            // â”€â”€ BUILD DETECT HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                            // â”€â”€ Read-only scan banner â”€â”€
                            let html = `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;margin-bottom:var(--space-sm);font-size:0.82rem;background:color-mix(in srgb, var(--accent) 10%, var(--bg-inset));border:1px solid color-mix(in srgb, var(--accent) 30%, transparent);border-radius:8px">
                                <span style="font-size:1.1rem">ğŸ”</span>
                                <span style="flex:1;color:var(--text-secondary)">This is a <strong>read-only scan</strong>. To configure K8s resources, proceed to Configure.</span>
                                <button type="button" class="btn btn-xs" style="background:var(--accent);color:white;border:none;padding:4px 12px;border-radius:6px;font-size:0.78rem;white-space:nowrap;cursor:pointer"
                                    onclick="document.getElementById('wiz-btn-next')?.click()">Configure â†’</button>
                            </div>`;

                            // â”€â”€ Section 1: Kubernetes Environment â”€â”€
                            html += wizSection('Kubernetes Environment', 'Current K8s tooling and cluster status.');
                            html += `<div class="wiz-status-grid">
                                ${wizStatusRow('â˜¸ï¸', 'kubectl', k8s.has_kubectl ? 'Available' : 'Not found', k8s.has_kubectl ? 'ok' : 'error')}
                                ${wizStatusRow('âˆ', 'Helm', k8s.has_helm ? 'Available' : 'Not found', k8s.has_helm ? 'ok' : 'muted')}
                                ${wizStatusRow('ğŸ”—', 'Cluster', k8s.cluster_connected ? 'Connected' : 'Not connected', k8s.cluster_connected ? 'ok' : 'warn')}
                                ${wizStatusRow('ğŸ“„', 'Manifests', k8s.manifest_count > 0 ? `${k8s.manifest_count} found` : 'None', k8s.manifest_count > 0 ? 'ok' : 'muted')}
                                ${wizStatusRow('ğŸ“¦', 'Helm Chart', k8s.has_chart ? 'Present' : 'None', k8s.has_chart ? 'ok' : 'muted')}
                            </div>`;

                            // â”€â”€ Section 2: Docker Context â”€â”€
                            html += wizSection('Docker Context', 'Container infrastructure feeding K8s deployments.');
                            html += `<div class="wiz-status-grid">
                                ${wizStatusRow('ğŸ³', 'Docker', dockerStatus.available ? 'Available' : 'Not installed', dockerStatus.available ? 'ok' : 'error')}
                                ${wizStatusRow('ğŸ“‹', 'Compose file', docker.has_compose ? (dockerStatus.compose_file || 'Present') : 'Missing', docker.has_compose ? 'ok' : 'warn')}
                                ${wizStatusRow('ğŸ“„', 'Dockerfiles', docker.has_dockerfile ? `${(dockerStatus.dockerfiles || []).length} found` : 'Missing', docker.has_dockerfile ? 'ok' : 'warn')}
                            </div>`;

                            if (!docker.has_dockerfile && !docker.has_compose) {
                                html += `<div class="wiz-step-warn-panel" style="margin-top:0.5rem">
                                    <span>ğŸ’¡</span>
                                    <span style="flex:1">Set up Docker first â€” K8s deployments need container images.</span>
                                    <button class="btn btn-sm btn-secondary" style="flex-shrink:0" onclick="wizardModalClose(); setTimeout(openDockerSetupWizard, 200)">Setup Docker â†’</button>
                                </div>`;
                            }

                            // â”€â”€ Section 3: Compose Services (the key intelligence) â”€â”€
                            if (composeDetails.length > 0) {
                                html += wizSection(
                                    'Compose Services',
                                    `${composeDetails.length} service${composeDetails.length !== 1 ? 's' : ''} detected â€” ${appServices.length} application, ${infraServices.length} infrastructure.`
                                );
                                html += `<div style="display:flex;flex-direction:column;gap:0.25rem">`;
                                for (const svc of classifiedServices) {
                                    const isApp = svc._class === 'application';
                                    const badgeColor = isApp ? 'var(--success)' : 'var(--text-muted)';
                                    const badgeIcon = isApp ? 'ğŸš€' : 'ğŸ—„ï¸';
                                    const badgeLabel = isApp ? 'application' : 'infrastructure';
                                    const portStr = svc.ports.length > 0
                                        ? svc.ports.map(p => `:${p.container}`).join(' ')
                                        : '';
                                    const imgStr = svc.image
                                        ? svc.image.split('/').pop().split(':')[0]
                                        : (svc.build ? 'builds locally' : 'â€”');

                                    html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.3rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                        <span style="width:18px;text-align:center">${badgeIcon}</span>
                                        <strong style="min-width:80px">${esc(svc.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(imgStr)}</code>
                                        ${portStr ? `<code style="font-size:0.68rem;color:var(--text-muted)">${esc(portStr)}</code>` : ''}
                                        <span style="flex:1"></span>
                                        ${Object.keys(svc.environment || {}).length > 0 ? `<span style="font-size:0.66rem;color:var(--text-muted)" title="${Object.keys(svc.environment).length} env vars">ğŸ”§${Object.keys(svc.environment).length}</span>` : ''}
                                        ${svc.volumes.length > 0 ? `<span style="font-size:0.66rem;color:var(--text-muted)" title="${svc.volumes.length} volumes">ğŸ’¾${svc.volumes.length}</span>` : ''}
                                        ${svc.healthcheck ? '<span style="font-size:0.66rem;color:var(--text-muted)" title="Has healthcheck">â¤ï¸</span>' : ''}
                                        <span style="font-size:0.68rem;color:${badgeColor}">${badgeLabel}</span>
                                    </div>`;
                                }
                                html += `</div>`;

                                if (appServices.length > 0) {
                                    html += `<div style="margin-top:0.5rem;font-size:0.78rem;color:var(--text-secondary)">
                                        ğŸ’¡ <strong>${appServices.length}</strong> application service${appServices.length !== 1 ? 's' : ''} will become K8s Deployments.
                                        ${infraServices.length > 0 ? `<strong>${infraServices.length}</strong> infrastructure service${infraServices.length !== 1 ? 's' : ''} â€” choose StatefulSet, managed, or skip.` : ''}
                                    </div>`;
                                }
                            } else if (deployableModules.length > 0) {
                                // No compose but we have modules
                                html += wizSection('Project Modules', `${deployableModules.length} deployable module${deployableModules.length !== 1 ? 's' : ''} detected.`);
                                html += `<div style="display:flex;flex-direction:column;gap:0.25rem">`;
                                for (const m of classifiedModules) {
                                    const isDep = m._class === 'deployable';
                                    const badgeColor = isDep ? 'var(--success)' : 'var(--text-muted)';
                                    const badgeIcon = isDep ? 'ğŸŸ¢' : m._class === 'library' ? 'ğŸ“š' : m._class === 'docs' ? 'ğŸ“' : 'âš™ï¸';
                                    html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.3rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                        <span style="width:18px;text-align:center">${badgeIcon}</span>
                                        <strong style="min-width:80px">${esc(m.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(m.stack || '?')}</code>
                                        <span style="flex:1;color:var(--text-muted);font-size:0.72rem">${esc(m.path || '')}</span>
                                        <span style="font-size:0.68rem;color:${badgeColor}">${m._class}</span>
                                    </div>`;
                                }
                                html += `</div>`;
                            }

                            // â”€â”€ Section 4: Image Registry Context â”€â”€
                            if (ghRepo.owner) {
                                html += wizSection('Registry Context', 'Container image naming from GitHub.');
                                html += `<div class="wiz-status-grid">
                                    ${wizStatusRow('ğŸ™', 'Repository', `${ghRepo.owner}/${ghRepo.name}`, 'ok')}
                                    ${wizStatusRow('ğŸ“¦', 'Registry', `ghcr.io/${ghRepo.owner}/${ghRepo.name}`, 'ok')}
                                </div>`;
                            }

                            // â”€â”€ Section 5: Environments â”€â”€
                            if (envs.length > 0) {
                                html += wizSection('Environments', `${envs.length} deployment environment${envs.length !== 1 ? 's' : ''} configured.`);
                                html += `<div style="display:flex;flex-wrap:wrap;gap:0.3rem">`;
                                for (const env of envs) {
                                    html += `<span style="display:inline-flex;align-items:center;gap:0.25rem;font-size:0.78rem;padding:0.2rem 0.5rem;border-radius:4px;background:var(--bg-inset);border:1px solid var(--border-subtle)">
                                        ${env.default ? 'â­' : 'ğŸ·ï¸'} ${esc(env.name)}
                                    </span>`;
                                }
                                html += `</div>`;
                            }

                            // â”€â”€ Cache and set HTML â”€â”€
                            const cacheData = {
                                _k8s: data._k8s,
                                _docker: data._docker,
                                _dockerStatus: data._dockerStatus,
                                _modules: data._modules,
                                _classifiedModules: data._classifiedModules,
                                _composeServices: data._composeServices,
                                _appServices: data._appServices,
                                _infraServices: data._infraServices,
                                _ghRepo: data._ghRepo,
                                _envs: data._envs,
                            };
                            wizStore(_CK, { h: html, d: cacheData }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>âš ï¸</span><span>${esc(e.message)}</span></div>`;
                        }
                    },
                },

                // â”€â”€ Step 2: Configure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'config', title: 'Configure',
                    render: async (data, el) => {
                        // â”€â”€ Load saved wizard state (if any) â”€â”€
                        try {
                            const stRes = await api('/k8s/wizard-state');
                            if (stRes?.ok) {
                                data._wizardState = stRes;
                            }
                        } catch (_) { /* no saved state â€” use detection defaults */ }

                        const projectName = (_wizardConfig && _wizardConfig.name) || 'app';
                        const appName = projectName.replace(/[^a-z0-9-]/gi, '-').toLowerCase();
                        const ghRepo = data._ghRepo || {};
                        const appSvcs = data._appServices || [];
                        const infraSvcs = data._infraServices || [];
                        const envs = data._envs || [];
                        const deployableModules = (data._classifiedModules || []).filter(m => m._class === 'deployable');
                        const hasCompose = appSvcs.length > 0 || infraSvcs.length > 0;

                        // â”€â”€ Saved wizard state (if previously persisted) â”€â”€
                        const _savedState = data._wizardState || null;
                        const _savedSvc = (name) =>
                            _savedState?._services?.find(s => s.name === name) || null;
                        const _savedInfra = (name) =>
                            _savedState?._infraDecisions?.find(d => d.name === name) || null;

                        // Smart namespace default
                        const defaultNamespace = envs.find(e => e.default)
                            ? `${appName}-${envs.find(e => e.default).name}`
                            : 'default';

                        // â”€â”€ Mini label/input helpers (same pattern as Docker wizard) â”€â”€
                        const _lbl = (txt, sub) => `<label style="display:block;font-size:0.7rem;color:var(--text-muted);margin-bottom:2px">${txt}${sub ? ` <span style="font-size:0.62rem;opacity:0.7">(${sub})</span>` : ''}</label>`;
                        const _inp = (id, val, ph) => `<input type="text" id="${id}" class="modal-form-input" value="${esc(val || '')}" placeholder="${ph || ''}" style="font-size:0.76rem;padding:0.2rem 0.3rem">`;
                        const _num = (id, val) => `<input type="number" id="${id}" class="modal-form-input" value="${val}" style="font-size:0.76rem;padding:0.2rem 0.3rem;width:80px">`;
                        const _sel = (id, opts, selected) => `<select id="${id}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem">${opts.map(o => `<option value="${o.v}"${o.v === selected ? ' selected' : ''}>${o.l}</option>`).join('')}</select>`;
                        const _ta = (id, val, ph, rows) => `<textarea id="${id}" class="modal-form-input" rows="${rows || 2}" placeholder="${ph || ''}" style="font-size:0.72rem;padding:0.2rem 0.3rem;font-family:var(--font-mono,monospace);resize:vertical;min-height:38px">${esc(val || '')}</textarea>`;

                        // â”€â”€ Resource quantity validation helper â”€â”€
                        // K8s CPU: 100m, 0.5, 1, 1500m    Memory: 128Mi, 1Gi, 256M
                        const _isValidResQty = (v) => !v || /^\d+(\.\d+)?(m|Mi|Gi|Ki|Ti|M|G|K|T)?$/.test(v.trim());

                        // â”€â”€ QoS class helper â€” what K8s assigns based on resource config â”€â”€
                        // Guaranteed: every container has limits==requests for both CPU and memory
                        // Burstable:  at least one container has a request or limit set
                        // BestEffort: no limits or requests at all
                        const _qosHint = (cpuReq, cpuLim, memReq, memLim) => {
                            const hasAny = cpuReq || cpuLim || memReq || memLim;
                            if (!hasAny) return `<span style="color:var(--warning);font-size:0.64rem" title="No resource constraints â€” pod may be evicted first under pressure">âš ï¸ BestEffort</span>`;
                            const allSet = cpuReq && cpuLim && memReq && memLim;
                            const reqEqLim = allSet && cpuReq.trim() === cpuLim.trim() && memReq.trim() === memLim.trim();
                            if (reqEqLim) return `<span style="color:var(--success);font-size:0.64rem" title="Requests equal limits â€” highest priority, never throttled">âœ… Guaranteed</span>`;
                            return `<span style="color:var(--accent);font-size:0.64rem" title="Some constraints set â€” can burst above requests up to limits">âš¡ Burstable</span>`;
                        };

                        // â”€â”€ Compose duration parser: "30s" â†’ 30, "1m" â†’ 60 â”€â”€
                        const _parseDur = (s) => {
                            if (!s) return null;
                            const m = String(s).match(/^(\d+)(s|m|h)?$/);
                            if (!m) return null;
                            const v = parseInt(m[1]);
                            return m[2] === 'm' ? v * 60 : m[2] === 'h' ? v * 3600 : v;
                        };

                        // â”€â”€ Compose healthcheck â†’ K8s probe type/fields parser â”€â”€
                        // Detects: curl/wget â†’ HTTP, nc -z â†’ TCP, pg_isready/redis-cli/mysqladmin â†’ Exec
                        const _parseComposeProbe = (hc, svcPort) => {
                            if (!hc || !hc.test) return { type: 'http', path: '/health', port: svcPort, command: '' };
                            const test = typeof hc.test === 'string' ? hc.test
                                : Array.isArray(hc.test) ? hc.test.slice(1).join(' ') : String(hc.test);
                            // curl -f http://localhost:8080/health
                            const curlM = test.match(/curl\s+[^]*?https?:\/\/[^:/]+(:(\d+))?(\/\S*)?/i);
                            if (curlM) return { type: 'http', path: curlM[3] || '/health', port: parseInt(curlM[2]) || svcPort, command: '' };
                            // wget --spider http://localhost:3000/healthz
                            const wgetM = test.match(/wget\s+[^]*?https?:\/\/[^:/]+(:(\d+))?(\/\S*)?/i);
                            if (wgetM) return { type: 'http', path: wgetM[3] || '/health', port: parseInt(wgetM[2]) || svcPort, command: '' };
                            // nc -z localhost 5432
                            const ncM = test.match(/nc\s+-z\s+\S+\s+(\d+)/);
                            if (ncM) return { type: 'tcp', path: '', port: parseInt(ncM[1]) || svcPort, command: '' };
                            // DB/cache exec patterns
                            if (/pg_isready|mysqladmin\s+ping|redis-cli\s+ping|mongo.*--eval/.test(test))
                                return { type: 'exec', path: '', port: svcPort, command: test };
                            // Fallback: exec with raw command
                            return { type: 'exec', path: '', port: svcPort, command: test };
                        };

                        // â”€â”€ Probe HTML block generator â”€â”€
                        // Generates complete probe config UI with type-dependent field visibility
                        const _probeBlock = (prefix, label, probeType, path, port, command, delay, period, extra, extraLabel) => {
                            // onchange for type select: toggle path/port/command visibility
                            const typeOnchange = `var t=this.value;`
                                + `var p=document.getElementById('${prefix}-path-w');`
                                + `var pt=document.getElementById('${prefix}-port-w');`
                                + `var c=document.getElementById('${prefix}-cmd-w');`
                                + `if(p)p.style.display=t==='http'?'block':'none';`
                                + `if(pt)pt.style.display=t!=='exec'?'block':'none';`
                                + `if(c)c.style.display=t==='exec'?'block':'none'`;
                            // onchange for enable checkbox: toggle entire probe config
                            const enableOnchange = `var c=document.getElementById('${prefix}-cfg');if(c)c.style.display=this.checked?'block':'none'`;

                            return `<div style="padding:0.3rem 0">
                                <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.25rem">
                                    <label style="display:inline-flex;align-items:center;gap:0.25rem;cursor:pointer">
                                        <input type="checkbox" id="${prefix}-enable" checked style="accent-color:var(--accent);width:13px;height:13px"
                                            onchange="${enableOnchange}">
                                        <span style="font-weight:600;font-size:0.72rem;color:var(--text-primary)">${label}</span>
                                    </label>
                                    <select id="${prefix}-type" class="modal-form-select" style="font-size:0.72rem;padding:0.15rem 0.25rem"
                                        onchange="${typeOnchange}">
                                        <option value="http"${probeType === 'http' ? ' selected' : ''}>HTTP GET</option>
                                        <option value="tcp"${probeType === 'tcp' ? ' selected' : ''}>TCP Socket</option>
                                        <option value="exec"${probeType === 'exec' ? ' selected' : ''}>Exec</option>
                                    </select>
                                </div>
                                <div id="${prefix}-cfg">
                                    <div style="display:flex;gap:0.35rem;margin-bottom:0.2rem;flex-wrap:wrap">
                                        <div id="${prefix}-path-w" style="display:${probeType === 'http' ? 'block' : 'none'};min-width:130px;flex:2">
                                            ${_lbl('Path')}${_inp(`${prefix}-path`, path, '/health')}
                                        </div>
                                        <div id="${prefix}-port-w" style="display:${probeType !== 'exec' ? 'block' : 'none'};min-width:65px;flex:1">
                                            ${_lbl('Port')}${_num(`${prefix}-port`, port)}
                                        </div>
                                        <div id="${prefix}-cmd-w" style="display:${probeType === 'exec' ? 'block' : 'none'};flex:1;min-width:180px">
                                            ${_lbl('Command')}${_inp(`${prefix}-cmd`, command, 'pg_isready -U postgres')}
                                        </div>
                                    </div>
                                    <div style="display:flex;gap:0.35rem;flex-wrap:wrap">
                                        <div style="min-width:55px">
                                            ${_lbl('Delay', 's')}${_num(`${prefix}-delay`, delay)}
                                        </div>
                                        <div style="min-width:55px">
                                            ${_lbl('Period', 's')}${_num(`${prefix}-period`, period)}
                                        </div>
                                        <div style="min-width:55px">
                                            ${_lbl(extraLabel)}${_num(`${prefix}-extra`, extra)}
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        };

                        // â”€â”€ Secret key detection â€” loaded from DataRegistry â”€â”€
                        const _SECRET_PATTERNS = window._dcp.secretPatterns;
                        const _isSecretKey = (key) => {
                            const lower = key.toLowerCase();
                            return _SECRET_PATTERNS.some(p => lower.includes(p));
                        };

                        // â”€â”€ Env var injection â€” multi-env awareness â”€â”€
                        const isMultiEnv = envs.length > 1;
                        const _ENV_DEPENDENT_KEYS = new Set([
                            'node_env', 'app_env', 'environment', 'env',
                            'log_level', 'debug', 'stage', 'deploy_env',
                        ]);
                        const _defaultInjType = (key) => {
                            if (_isSecretKey(key)) return 'secret';
                            if (isMultiEnv && _ENV_DEPENDENT_KEYS.has(key.toLowerCase())) return 'variable';
                            return 'hardcoded';
                        };

                        // â”€â”€ Build available vars/secrets from VAULT â”€â”€
                        const _vaultKeys = data._vaultKeys || [];
                        const _allEnvKeys = new Set();
                        const _availableVars = [];   // vault config keys
                        const _availableSecrets = []; // vault secret keys
                        _vaultKeys.forEach(vk => {
                            const k = vk.key;
                            if (_allEnvKeys.has(k)) return;
                            _allEnvKeys.add(k);
                            if (vk.kind === 'secret') _availableSecrets.push(k);
                            else _availableVars.push(k);
                        });
                        _availableVars.sort();
                        _availableSecrets.sort();

                        // â”€â”€ Build per-infra env map (infra name â†’ env keys) â”€â”€
                        const _infraEnvMap = {};
                        infraSvcs.forEach(svc => {
                            _infraEnvMap[svc.name] = Object.keys(svc.environment || {});
                        });

                        // â”€â”€ Infrastructure service catalog â€” reuse Docker's complete list â”€â”€
                        // _infraOptions and _infraCategories are top-level constants (shared by all wizards).
                        // Build a quick lookup map by key for add/re-add operations.
                        const _INFRA_CATALOG = {};
                        _infraOptions.forEach(opt => {
                            _INFRA_CATALOG[opt.key] = opt;
                        });
                        window._INFRA_CATALOG = _INFRA_CATALOG;

                        // â”€â”€ Build <option> HTML for the var/secret select â”€â”€
                        const _varSelectOpts = (injType, currentKey, currentVarName, svcIdx) => {
                            // Build suggested keys based on checked deps for this service
                            const suggestedSet = new Set();
                            const infraKey = typeof svcIdx === 'string' && svcIdx.startsWith('infra-')
                                ? svcIdx.replace(/^infra-/, '') : null;
                            if (infraKey && _infraEnvMap[infraKey]) {
                                // Infra service: suggest its own env fields
                                _infraEnvMap[infraKey].forEach(k => suggestedSet.add(k));
                            } else if (svcIdx !== undefined && svcIdx !== null) {
                                // App service: suggest from checked deps
                                const depCbs = document.querySelectorAll('.k8s-dep-' + svcIdx + ':checked');
                                if (depCbs.length > 0) {
                                    depCbs.forEach(cb => {
                                        const depName = cb.value;
                                        (_infraEnvMap[depName] || []).forEach(k => suggestedSet.add(k));
                                    });
                                } else if (document.querySelectorAll('.k8s-dep-' + svcIdx).length === 0) {
                                    // DOM not ready â€” fallback to all
                                    Object.values(_infraEnvMap).forEach(keys => keys.forEach(k => suggestedSet.add(k)));
                                }
                            } else {
                                // No svcIdx â€” show all
                                Object.values(_infraEnvMap).forEach(keys => keys.forEach(k => suggestedSet.add(k)));
                            }
                            const _suggestedKeys = [...suggestedSet].sort();
                            const dlr = '$';
                            const match = currentVarName || (dlr + '{' + currentKey + '}');
                            const shown = new Set();
                            let opts = '';
                            // Default: self-reference (always first)
                            if (currentKey) {
                                const selfVal = dlr + '{' + currentKey + '}';
                                opts += '<option value="' + esc(selfVal) + '"' + (match === selfVal ? ' selected' : '') + '>' + dlr + '{' + esc(currentKey) + '}</option>';
                                shown.add(currentKey);
                            }
                            // Suggested (from compose detection)
                            const suggested = _suggestedKeys.filter(k => !shown.has(k));
                            if (suggested.length > 0) {
                                opts += '<optgroup label="Suggested">';
                                suggested.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            // Vault Secrets
                            const secrets = _availableSecrets.filter(k => !shown.has(k));
                            if (secrets.length > 0) {
                                opts += '<optgroup label="Secrets">';
                                secrets.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            // Vault Variables
                            const vars = _availableVars.filter(k => !shown.has(k));
                            if (vars.length > 0) {
                                opts += '<optgroup label="Variables">';
                                vars.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            // Custom option
                            const stripped = match ? match.replace(/^\$\{|\}$/g, '') : '';
                            const isCustom = stripped && stripped !== currentKey && !_allEnvKeys.has(stripped);
                            opts += '<option value="__custom__"' + (isCustom ? ' selected' : '') + '>Custom...</option>';
                            return opts;
                        };

                        // â”€â”€ Per-variable row HTML builder â”€â”€
                        const _envRowHtml = (i, j, key, value, injType, varName, svcIdx) => {
                            const isSubst = injType !== 'hardcoded';
                            const isSec = injType === 'secret';
                            const dlr = '$';
                            const varN = varName || (isSubst ? dlr + '{' + key + '}' : '');
                            const isCustomVar = varN && key && varN !== (dlr + '{' + key + '}') && !_allEnvKeys.has(varN.replace(/^\$\{|\}$/g, ''));
                            const selKey = isSubst ? (varN.replace(/^\$\{/, '').replace(/\}$/, '') || key) : key;
                            const varMissing = isSubst && selKey && !_allEnvKeys.has(selKey);
                            return '<div class="k8s-env-row" style="margin-bottom:0.15rem">'
                                // â”€â”€ Grid row â”€â”€
                                + '<div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;align-items:center">'
                                + '<input type="text" id="k8s-svc-env-key-' + i + '-' + j + '" class="modal-form-input"'
                                + ' value="' + esc(key) + '" placeholder="KEY_NAME"'
                                + ' oninput="if(!this.dataset.envTs)this.dataset.envTs=Date.now();window._wizValidation.recheck(\'k8s\')"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)">'
                                + '<input type="' + (isSec ? 'password' : 'text') + '" id="k8s-svc-env-val-' + i + '-' + j + '" class="modal-form-input"'
                                + ' value="' + esc(value) + '" placeholder="' + (isSec ? 'â€¢â€¢â€¢â€¢â€¢â€¢' : 'value') + '"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)"' + (isSubst ? ' hidden' : '') + '>'
                                + '<div id="k8s-svc-env-varbox-' + i + '-' + j + '"' + (isSubst ? '' : ' hidden') + '>'
                                +   '<select id="k8s-svc-env-var-' + i + '-' + j + '" class="modal-form-select" data-i="' + i + '" data-j="' + j + '"'
                                +   ' style="font-size:0.82rem;padding:0.25rem 0.35rem;color:var(--accent)"'
                                +   ' onchange="window._onVarSelect(this)">'
                                +   (isSubst ? _varSelectOpts(injType, key, varN, svcIdx !== undefined ? svcIdx : i) : '<option>--</option>')
                                +   '</select>'
                                +   '<input type="text" id="k8s-svc-env-varcustom-' + i + '-' + j + '" class="modal-form-input"'
                                +   ' value="' + (isCustomVar ? esc(varN) : '') + '" placeholder="' + dlr + '{MY_VAR}"'
                                +   ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace);color:var(--accent);margin-top:2px;display:' + (isCustomVar ? '' : 'none') + '">'
                                + '</div>'
                                + '<select id="k8s-svc-env-type-' + i + '-' + j + '" class="modal-form-select" data-i="' + i + '" data-j="' + j + '"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem"'
                                + ' onchange="((sel)=>{'
                                +   'var si=sel.dataset.i,sj=sel.dataset.j;'
                                +   'var vb=document.getElementById(\'k8s-svc-env-varbox-\'+si+\'-\'+sj);'
                                +   'var ve=document.getElementById(\'k8s-svc-env-val-\'+si+\'-\'+sj);'
                                +   'var vs=document.getElementById(\'k8s-svc-env-var-\'+si+\'-\'+sj);'
                                +   'var isSub=sel.value!==\'hardcoded\';'
                                +   'if(vb)vb.hidden=!isSub;'
                                +   'if(ve)ve.hidden=isSub;'
                                +   'if(!isSub){var nt=document.getElementById(\'k8s-svc-env-notice-\'+si+\'-\'+sj);if(nt)nt.hidden=true;}'
                                +   'if(vs&&isSub){vs.innerHTML=window._varSelectOpts(sel.value,document.getElementById(\'k8s-svc-env-key-\'+si+\'-\'+sj).value,\'\',si);window._onVarSelect(vs);}'
                                +   'if(typeof _updateEnvSummary===\'function\')_updateEnvSummary(si);'
                                +   'window._wizValidation.recheck(\'k8s\');'
                                + '})(this)">'
                                + '<option value="hardcoded"' + (injType === 'hardcoded' ? ' selected' : '') + '>ğŸ“‹ Hardcoded</option>'
                                + '<option value="variable"' + (injType === 'variable' ? ' selected' : '') + '>ğŸ”„ Variable</option>'
                                + '<option value="secret"' + (injType === 'secret' ? ' selected' : '') + '>ğŸ”’ Secret</option>'
                                + '</select>'
                                + '<button type="button" onclick="this.closest(\'.k8s-env-row\').remove();if(typeof _updateEnvSummary===\'function\')_updateEnvSummary(\'' + i + '\');window._wizValidation.recheck(\'k8s\')"'
                                + ' style="background:none;border:none;cursor:pointer;font-size:0.82rem;color:var(--text-muted);padding:0 2px"'
                                + ' title="Remove variable">âœ•</button>'
                                + '</div>'
                                // â”€â”€ Notice (below the grid, outside it) â”€â”€
                                + '<div id="k8s-svc-env-notice-' + i + '-' + j + '"' + (varMissing ? '' : ' hidden')
                                + ' style="font-size:0.78rem;color:var(--warning,#e8a820);margin:2px 0 4px;padding:4px 6px;border-radius:4px;background:rgba(232,168,32,0.06);border:1px solid rgba(232,168,32,0.15)">'
                                +   '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">'
                                +     '<span>\u26a0\ufe0f <strong id="k8s-svc-env-notice-name-' + i + '-' + j + '">' + esc(selKey) + '</strong> does not exist yet</span>'
                                +     '<label style="display:flex;align-items:center;gap:3px;cursor:pointer">'
                                +       '<input type="checkbox" id="k8s-svc-env-create-' + i + '-' + j + '" checked style="margin:0">'
                                +       '<span>Create on execution</span>'
                                +     '</label>'
                                +   '</div>'
                                +   '<div id="k8s-svc-env-valbox-' + i + '-' + j + '" style="display:flex;align-items:center;gap:4px;margin-top:3px">'
                                +     '<input type="text" id="k8s-svc-env-newval-' + i + '-' + j + '" class="modal-form-input"'
                                +     ' placeholder="value (leave empty or generate)" style="flex:1;font-size:0.78rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)">'
                                +     '<button type="button" onclick="window._generateVarValue(this)" data-i="' + i + '" data-j="' + j + '"'
                                +     ' style="font-size:0.78rem;padding:0.25rem 0.5rem;border:1px solid var(--border-subtle);border-radius:3px;background:var(--bg-card);cursor:pointer;white-space:nowrap"'
                                +     ' title="Generate a random value">ğŸ² Generate</button>'
                                +   '</div>'
                                +   '<div id="k8s-svc-env-elsewhere-' + i + '-' + j + '" hidden style="font-size:0.76rem;color:var(--text-muted);font-style:italic;margin-top:3px">'
                                +     '\u2139\ufe0f Value already being created by <strong id="k8s-svc-env-elsewhere-src-' + i + '-' + j + '"></strong>'
                                +   '</div>'
                                + '</div>'
                                + '<div id="k8s-svc-env-dupe-' + i + '-' + j + '" hidden'
                                + ' style="font-size:0.76rem;margin:1px 0 3px;padding:3px 6px;border-radius:4px">'
                                + '</div>'
                                + '</div>';
                        };

                        // Expose for dynamic onchange use
                        window._varSelectOpts = _varSelectOpts;
                        window._allEnvKeysSet = _allEnvKeys;

                        // â”€â”€ Var select onchange: check existence, show notice â”€â”€
                        window._onVarSelect = (sel) => {
                            const ci = sel.dataset.i, cj = sel.dataset.j;
                            const tb = document.getElementById('k8s-svc-env-varcustom-' + ci + '-' + cj);
                            const nt = document.getElementById('k8s-svc-env-notice-' + ci + '-' + cj);
                            if (sel.value === '__custom__') {
                                if (tb) tb.style.display = '';
                                if (nt) nt.hidden = true;
                            } else {
                                if (tb) tb.style.display = 'none';
                                if (nt) {
                                    const varKey = sel.value.replace(/^\$\{/, '').replace(/\}$/, '');
                                    // Smart key sync: update key if empty or still matches prev var
                                    const keyInput = document.getElementById('k8s-svc-env-key-' + ci + '-' + cj);
                                    if (keyInput) {
                                        const curKey = keyInput.value.trim().toUpperCase();
                                        const prevVar = (keyInput.dataset.lastVar || '').toUpperCase();
                                        if (!curKey || curKey === prevVar) {
                                            keyInput.value = varKey;
                                            keyInput.dataset.envTs = Date.now();
                                        }
                                        keyInput.dataset.lastVar = varKey;
                                    }
                                    const exists = _allEnvKeys.has(varKey);
                                    nt.hidden = exists;
                                    const nameEl = document.getElementById('k8s-svc-env-notice-name-' + ci + '-' + cj);
                                    if (nameEl) nameEl.textContent = varKey;
                                    const valbox = document.getElementById('k8s-svc-env-valbox-' + ci + '-' + cj);
                                    const elsewhere = document.getElementById('k8s-svc-env-elsewhere-' + ci + '-' + cj);
                                    if (!exists && varKey) {
                                        if (valbox) valbox.style.display = 'flex';
                                        if (elsewhere) elsewhere.hidden = true;
                                    } else {
                                        if (valbox) valbox.style.display = 'flex';
                                        if (elsewhere) elsewhere.hidden = true;
                                    }
                                }
                            }
                            // Shared symmetric collision check
                            window._wizValidation.recheck('k8s');
                        };
                        // â”€â”€ Refresh env selects when deps change â”€â”€
                        window._refreshEnvSelects = (svcIdx) => {
                            const list = document.getElementById('k8s-svc-env-list-' + svcIdx);
                            if (!list) return;
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (!keyEl) return;
                                const j = keyEl.id.split('-').pop();
                                const typeSel = document.getElementById('k8s-svc-env-type-' + svcIdx + '-' + j);
                                const varSel = document.getElementById('k8s-svc-env-var-' + svcIdx + '-' + j);
                                if (!typeSel || !varSel || typeSel.value === 'hardcoded') return;
                                const keySel = document.getElementById('k8s-svc-env-key-' + svcIdx + '-' + j);
                                const currentKey = keySel ? keySel.value : '';
                                const currentVar = varSel.value;
                                varSel.innerHTML = window._varSelectOpts(typeSel.value, currentKey, currentVar, svcIdx);
                                window._onVarSelect(varSel);
                            });
                        };

                        // â”€â”€ Generate random value for the notice input â”€â”€
                        window._generateVarValue = (btn) => {
                            const ci = btn.dataset.i, cj = btn.dataset.j;
                            const inp = document.getElementById('k8s-svc-env-newval-' + ci + '-' + cj);
                            if (!inp) return;
                            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#%&*';
                            let val = '';
                            for (let n = 0; n < 32; n++) val += chars[Math.floor(Math.random() * chars.length)];
                            inp.value = val;
                        };

                        // Band-aid _recheckAllEnvCollisions removed â€” replaced by shared
                        // window._wizValidation.recheck('k8s') via the registry system.

                        // â”€â”€ Add variable button handler â”€â”€
                        window._addEnvVar = (i) => {
                            const list = document.getElementById('k8s-svc-env-list-' + i);
                            if (!list) return;
                            // Find max existing j to avoid ID collisions after row deletions
                            let maxJ = -1;
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                const keyInput = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (keyInput) {
                                    const parts = keyInput.id.split('-');
                                    const jVal = parseInt(parts[parts.length - 1]);
                                    if (!isNaN(jVal) && jVal > maxJ) maxJ = jVal;
                                }
                            });
                            const j = maxJ + 1;
                            const row = document.createElement('div');
                            row.innerHTML = _envRowHtml(i, j, '', '', 'hardcoded', '', i);
                            list.appendChild(row.firstElementChild);
                            _updateEnvSummary(i);
                            window._wizValidation.recheck('k8s');
                        };

                        // â”€â”€ Live summary updater â”€â”€
                        window._updateEnvSummary = (i) => {
                            const sumEl = document.getElementById('k8s-svc-env-summary-' + i);
                            if (!sumEl) return;
                            const list = document.getElementById('k8s-svc-env-list-' + i);
                            if (!list) return;
                            let hc = 0, vr = 0, sc = 0;
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                // Extract actual j from key input ID (k8s-svc-env-key-{i}-{j})
                                const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (!keyEl) return;
                                const parts = keyEl.id.split('-');
                                const j = parts[parts.length - 1];
                                const sel = document.getElementById('k8s-svc-env-type-' + i + '-' + j);
                                const key = document.getElementById('k8s-svc-env-key-' + i + '-' + j);
                                if (!sel || !key || !key.value.trim()) return;
                                if (sel.value === 'secret') sc++;
                                else if (sel.value === 'variable') vr++;
                                else hc++;
                            });
                            const dlr = '$';
                            const parts = [];
                            if (hc + vr > 0) parts.push('ğŸ“‹ ConfigMap: ' + hc + ' hardcoded' + (vr > 0 ? ', ' + vr + ' ' + dlr + '{VAR}' : ''));
                            if (sc > 0) parts.push('ğŸ”’ Secret: ' + sc + ' key' + (sc !== 1 ? 's' : '') + ' (' + dlr + '{VAR} at deploy)');
                            if (parts.length === 0) parts.push('No environment variables configured');
                            sumEl.innerHTML = parts.join(' &nbsp;\u00b7&nbsp; ');
                        };

                        // â”€â”€ Collect env vars from per-variable rows â”€â”€
                        window._collectEnvVars = (i) => {
                            const list = document.getElementById('k8s-svc-env-list-' + i);
                            if (!list) return [];
                            const vars = [];
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                // Extract actual j from key input ID (k8s-svc-env-key-{i}-{j})
                                const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (!keyEl) return;
                                const parts = keyEl.id.split('-');
                                const j = parts[parts.length - 1];
                                const key = (document.getElementById('k8s-svc-env-key-' + i + '-' + j) || {}).value || '';
                                if (!key.trim()) return;
                                const type = (document.getElementById('k8s-svc-env-type-' + i + '-' + j) || {}).value || 'hardcoded';
                                const value = (document.getElementById('k8s-svc-env-val-' + i + '-' + j) || {}).value || '';
                                const varSel = document.getElementById('k8s-svc-env-var-' + i + '-' + j);
                                const varCustom = document.getElementById('k8s-svc-env-varcustom-' + i + '-' + j);
                                let varName = null;
                                if (type !== 'hardcoded') {
                                    if (varSel && varSel.value === '__custom__' && varCustom && varCustom.value.trim()) {
                                        varName = varCustom.value.trim();
                                    } else if (varSel && varSel.value && varSel.value !== '__custom__') {
                                        varName = varSel.value;
                                    } else {
                                        varName = '${' + key.trim() + '}';
                                    }
                                }
                                // Check if "Create on execution" is checked + new value
                                const createChk = document.getElementById('k8s-svc-env-create-' + i + '-' + j);
                                const newValInp = document.getElementById('k8s-svc-env-newval-' + i + '-' + j);
                                const notice = document.getElementById('k8s-svc-env-notice-' + i + '-' + j);
                                const createInVault = notice && !notice.hidden && createChk && createChk.checked;
                                const newValue = createInVault && newValInp ? newValInp.value.trim() : '';
                                vars.push({ key: key.trim(), type, value: value.trim(), varName, createInVault: !!createInVault, newValue });
                            });
                            return vars;
                        };
                        const _collectEnvVars = window._collectEnvVars;

                        // â”€â”€ StorageClass catalog â€” loaded from DataRegistry â”€â”€
                        // Deep-clone because the K8s wizard mutates items (adds _detected flags)
                        const _SC_CATALOG = JSON.parse(JSON.stringify(window._dcp.storageClasses));
                        // Build a flat lookup for Longhorn-like detection
                        const _SC_FLAT = {};
                        _SC_CATALOG.forEach(g => g.items.forEach(sc => { _SC_FLAT[sc.name] = sc; }));

                        // Build StorageClass <select> options from catalog
                        const _scSelectHtml = () => {
                            let h = '<option value="">(cluster default â€” no StorageClass in PVC)</option>';
                            _SC_CATALOG.forEach(g => {
                                h += '<optgroup label="' + esc(g.group) + '">';
                                g.items.forEach(sc => {
                                    const detected = sc._detected ? ' âœ“' : '';
                                    h += '<option value="' + esc(sc.name) + '" title="' + esc(sc.provisioner) + '">' + esc(sc.name) + ' â€” ' + esc(sc.hint) + detected + '</option>';
                                });
                                h += '</optgroup>';
                            });
                            h += '<optgroup label="Other">';
                            h += '<option value="_custom">âœï¸ Custom (type name)â€¦</option>';
                            h += '</optgroup>';
                            return h;
                        };

                        // â”€â”€ Volume classification from compose string â”€â”€
                        window._classifyVolume = (volStr) => {
                            const parts = (volStr || '').split(':');
                            const source = parts[0] || '';
                            const target = parts[1] || source;
                            const flags = parts[2] || '';
                            const readOnly = flags.includes('ro');

                            // Named volume (no path separator in source)
                            if (!source.includes('/') && !source.startsWith('.')) {
                                return { type: 'pvc-dynamic', name: source, mountPath: target, readOnly, source, defaultSize: '10Gi', classification: 'named' };
                            }
                            // Dev bind mount â€” source code directories (skip by default)
                            if (/^\.\/(src|app|lib|pkg|cmd|internal|components|pages|public|assets|frontend|backend|server|client|api)/.test(source)) {
                                return { type: 'skip', name: source.replace(/^\.\//, '').replace(/\//g, '-'), mountPath: target, readOnly, source, classification: 'dev-bind', skipReason: 'Source code is baked into the container image at build time' };
                            }
                            // Data bind mount â€” persistent data
                            if (/^\.\/(data|db|storage|uploads|logs|backup|config|certs|ssl|tls)/.test(source) || /^\//.test(source)) {
                                return { type: 'pvc-dynamic', name: source.replace(/^\.\//, '').replace(/\//g, '-'), mountPath: target, readOnly, source, defaultSize: '5Gi', classification: 'data-bind' };
                            }
                            // Unknown bind mount â€” skip by default
                            return { type: 'skip', name: source.replace(/^\.\//, '').replace(/\//g, '-'), mountPath: target, readOnly, source, classification: 'unknown-bind', skipReason: 'Bind mount â€” may not be needed in K8s (override if needed)' };
                        };

                        // â”€â”€ Convert saved-state volume to classification shape â”€â”€
                        // Maps the collector's output fields into the classification
                        // object that _volRowHtml consumes.  Extra type-specific
                        // saved values are carried as _saved* for post-render restore.
                        window._savedVolToClassification = (vol) => ({
                            type:           vol.type || 'pvc-dynamic',
                            name:           vol.name || vol.configMapName || vol.secretName || vol.hostPath || '',
                            mountPath:      vol.mountPath || '',
                            readOnly:       vol.readOnly || false,
                            source:         vol.hostPath || '',
                            defaultSize:    vol.size || '10Gi',
                            classification: 'saved',
                            skipReason:     null,
                            // Carry-through for post-render restore
                            _savedAccessMode:       vol.accessMode,
                            _savedStorageClass:     vol.storageClass,
                            _savedLonghorn:         vol.longhornConfig,
                            _savedPvName:           vol.pvName,
                            _savedMedium:           vol.medium,
                            _savedSizeLimit:        vol.sizeLimit,
                            _savedCmKey:            vol.key,         // configMap key
                            _savedSecKey:           vol.key,         // secret key
                            _savedHostType:         vol.hostType,
                        });

                        // â”€â”€ Post-render: restore type-specific fields on volume rows â”€â”€
                        // Called after HTML is in the DOM.  Sets select/input values
                        // that _volRowHtml hardcodes (accessMode, storageClass, etc).
                        window._restoreVolFields = (i, j, cl) => {
                            if (cl.classification !== 'saved') return;
                            const _set = (id, val) => { const el = document.getElementById(id); if (el && val) el.value = val; };
                            const t = cl.type || 'pvc-dynamic';
                            if (t === 'pvc-dynamic' || t === 'pvc-static') {
                                _set('k8s-svc-vol-access-' + i + '-' + j, cl._savedAccessMode);
                                _set('k8s-svc-vol-sc-' + i + '-' + j, cl._savedStorageClass);
                                if (t === 'pvc-static') _set('k8s-svc-vol-pvname-' + i + '-' + j, cl._savedPvName);
                                if (cl._savedLonghorn) {
                                    _set('k8s-vol-lh-replicas-' + i + '-' + j, cl._savedLonghorn.replicas);
                                    _set('k8s-vol-lh-locality-' + i + '-' + j, cl._savedLonghorn.dataLocality);
                                    // Show longhorn panel if storageClass matches
                                    const lhPanel = document.getElementById('k8s-vol-lh-' + i + '-' + j);
                                    if (lhPanel) lhPanel.style.display = 'block';
                                }
                            } else if (t === 'emptyDir') {
                                _set('k8s-svc-vol-medium-' + i + '-' + j, cl._savedMedium);
                                _set('k8s-svc-vol-sizelimit-' + i + '-' + j, cl._savedSizeLimit);
                            } else if (t === 'configMap') {
                                _set('k8s-svc-vol-cmkey-' + i + '-' + j, cl._savedCmKey);
                            } else if (t === 'secret') {
                                _set('k8s-svc-vol-seckey-' + i + '-' + j, cl._savedSecKey);
                            } else if (t === 'hostPath') {
                                _set('k8s-svc-vol-hosttype-' + i + '-' + j, cl._savedHostType);
                            }
                        };

                        // â”€â”€ Volume row HTML generator â”€â”€
                        window._volRowHtml = (i, j, cl) => {
                            const isSkip = cl.type === 'skip';
                            const checked = !isSkip ? ' checked' : '';
                            const defType = isSkip ? 'emptyDir' : (cl.type || 'pvc-dynamic');
                            const typeOpts = [
                                { v: 'pvc-dynamic', l: 'ğŸ’¾ PVC (dynamic)' },
                                { v: 'pvc-static',  l: 'ğŸ’¾ PVC (static â€” advanced)' },
                                { v: 'emptyDir',    l: 'ğŸ“‚ emptyDir (ephemeral)' },
                                { v: 'configMap',   l: 'ğŸ“„ ConfigMap (file mount)' },
                                { v: 'secret',      l: 'ğŸ” Secret (file mount)' },
                                { v: 'hostPath',    l: 'âš ï¸ hostPath (not recommended)' },
                            ];
                            const typeSelectHtml = '<select id="k8s-svc-vol-type-' + i + '-' + j + '" class="modal-form-select" data-i="' + i + '" data-j="' + j + '" style="font-size:0.72rem;padding:0.15rem 0.2rem;flex:1" onchange="window._k8sVolTypeChange(\'' + i + '\',' + j + ')">'
                                + typeOpts.map(o => '<option value="' + o.v + '"' + (o.v === defType ? ' selected' : '') + '>' + o.l + '</option>').join('')
                                + '</select>';
                            const nameVal = (cl.name || '').replace(/[^a-z0-9-]/gi, '-').toLowerCase();
                            const showPvc = (defType === 'pvc-dynamic' || defType === 'pvc-static') ? '' : 'display:none';
                            const showStatic = defType === 'pvc-static' ? '' : 'display:none';
                            const showEmpty = defType === 'emptyDir' ? '' : 'display:none';
                            const showCm = defType === 'configMap' ? '' : 'display:none';
                            const showSec = defType === 'secret' ? '' : 'display:none';
                            const showHost = defType === 'hostPath' ? '' : 'display:none';

                            // Determine the initial source label + value based on type
                            const _srcLabelMap = { 'pvc-dynamic': 'PVC Name', 'pvc-static': 'PVC Name', 'configMap': 'ConfigMap', 'secret': 'Secret', 'hostPath': 'Host Path' };
                            const srcLabel = _srcLabelMap[defType] || 'Volume Source';
                            const srcVal = defType === 'configMap' ? '' : defType === 'secret' ? '' : defType === 'hostPath' ? esc(cl.source || '') : esc(nameVal);
                            const srcPlaceholder = defType === 'configMap' ? 'my-config' : defType === 'secret' ? 'my-tls-cert' : defType === 'hostPath' ? '/host/path' : 'my-data';
                            const showSrcRow = defType !== 'emptyDir' ? '' : 'display:none';

                            return '<div class="k8s-vol-row" style="border:1px solid var(--border-subtle);border-radius:6px;padding:0.35rem 0.4rem;background:var(--bg-inset)' + (isSkip ? ';opacity:0.5' : '') + '">'
                                // Row 1: checkbox + type select + skip warning + remove button
                                + '<div style="display:flex;align-items:center;gap:0.4rem;flex-wrap:wrap">'
                                +   '<input type="checkbox" id="k8s-svc-vol-chk-' + i + '-' + j + '"' + checked + ' style="accent-color:var(--accent);cursor:pointer" onchange="window._updateVolSummary(\'' + i + '\')">'
                                +   typeSelectHtml
                                +   (isSkip ? '<span style="font-size:0.6rem;color:var(--warning);font-weight:600">âš ï¸ ' + esc(cl.skipReason || 'dev-only') + '</span>' : '')
                                +   '<button type="button" onclick="this.closest(\'.k8s-vol-row\').remove();window._updateVolSummary(\'' + i + '\')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.8rem;padding:0 4px" title="Remove">âœ•</button>'
                                + '</div>'
                                // Row 2: Volume Source â†’ Mount Path (the two-way mapping)
                                + '<div id="k8s-vol-mapping-' + i + '-' + j + '" style="display:grid;grid-template-columns:1fr auto 1fr;gap:0.3rem;margin-top:0.25rem;align-items:end;' + showSrcRow + '">'
                                +   '<div>'
                                +     '<label id="k8s-vol-src-label-' + i + '-' + j + '" style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">' + srcLabel + '</label>'
                                +     '<input type="text" id="k8s-svc-vol-name-' + i + '-' + j + '" class="modal-form-input" value="' + srcVal + '" placeholder="' + srcPlaceholder + '" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +   '</div>'
                                +   '<div style="font-size:0.82rem;color:var(--text-muted);padding-bottom:0.15rem;font-weight:600">â†’</div>'
                                +   '<div>'
                                +     '<label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Mount Path</label>'
                                +     '<input type="text" id="k8s-svc-vol-mount-' + i + '-' + j + '" class="modal-form-input" value="' + esc(cl.mountPath) + '" placeholder="/var/lib/data" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +   '</div>'
                                + '</div>'
                                // emptyDir-only mount path (no source side)
                                + '<div id="k8s-vol-mount-only-' + i + '-' + j + '" style="' + (defType === 'emptyDir' ? '' : 'display:none') + ';margin-top:0.25rem">'
                                +   '<label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Mount Path</label>'
                                +   '<input type="text" id="k8s-svc-vol-mount-empty-' + i + '-' + j + '" class="modal-form-input" value="' + esc(cl.mountPath) + '" placeholder="/tmp/data" style="font-size:0.72rem;padding:0.15rem 0.25rem"'
                                +   ' oninput="var m=document.getElementById(\'k8s-svc-vol-mount-' + i + '-' + j + '\');if(m)m.value=this.value">'
                                + '</div>'
                                // PVC extra fields (Size, Access Mode, StorageClass)
                                + '<div id="k8s-vol-pvc-fields-' + i + '-' + j + '" style="' + showPvc + ';margin-top:0.2rem">'
                                +   '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.3rem;align-items:start">'
                                +     '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Size</label>'
                                +       '<input type="text" id="k8s-svc-vol-size-' + i + '-' + j + '" class="modal-form-input" value="' + (cl.defaultSize || '10Gi') + '" placeholder="10Gi" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +     '</div>'
                                +     '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Access Mode</label>'
                                +       '<select id="k8s-svc-vol-access-' + i + '-' + j + '" class="modal-form-select" style="font-size:0.72rem;padding:0.15rem 0.2rem">'
                                +         '<option value="ReadWriteOnce" selected>ReadWriteOnce</option>'
                                +         '<option value="ReadWriteMany">ReadWriteMany</option>'
                                +         '<option value="ReadOnlyMany">ReadOnlyMany</option>'
                                +       '</select>'
                                +     '</div>'
                                +   '</div>'
                                +   '<div style="margin-top:0.25rem">'
                                +     '<label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Storage Class</label>'
                                +     '<div style="display:flex;gap:0.3rem;align-items:center">'
                                +       '<select id="k8s-svc-vol-sc-' + i + '-' + j + '" class="modal-form-select k8s-vol-sc-select" style="font-size:0.72rem;padding:0.15rem 0.2rem;flex:1;max-width:320px" onchange="window._k8sVolScChange(\'' + i + '\',' + j + ')">'
                                +         _scSelectHtml()
                                +       '</select>'
                                +       '<input type="text" id="k8s-svc-vol-sc-custom-' + i + '-' + j + '" class="modal-form-input" placeholder="custom-class" style="font-size:0.72rem;padding:0.15rem 0.2rem;flex:1;max-width:180px;display:none">'
                                +     '</div>'
                                +   '</div>'
                                +   '<div id="k8s-vol-lh-' + i + '-' + j + '" style="display:none;margin-top:0.2rem;padding:0.25rem 0.35rem;border-radius:4px;background:rgba(99,102,241,0.04);border:1px solid rgba(99,102,241,0.12)">'
                                +     '<div style="font-size:0.64rem;color:var(--accent);font-weight:600;margin-bottom:0.15rem">ğŸ‚ Longhorn</div>'
                                +     '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.25rem">'
                                +       '<div><label style="display:block;font-size:0.62rem;color:var(--text-muted);margin-bottom:1px">Replicas</label>'
                                +         '<input type="number" id="k8s-vol-lh-replicas-' + i + '-' + j + '" class="modal-form-input" value="3" min="1" max="5" style="font-size:0.72rem;padding:0.15rem 0.2rem;width:60px">'
                                +       '</div>'
                                +       '<div><label style="display:block;font-size:0.62rem;color:var(--text-muted);margin-bottom:1px">Data Locality</label>'
                                +         '<select id="k8s-vol-lh-locality-' + i + '-' + j + '" class="modal-form-select" style="font-size:0.72rem;padding:0.15rem 0.2rem">'
                                +           '<option value="best-effort" selected>Best-effort</option>'
                                +           '<option value="strict">Strict</option>'
                                +           '<option value="disabled">Disabled</option>'
                                +         '</select>'
                                +       '</div>'
                                +     '</div>'
                                +   '</div>'
                                + '</div>'
                                // PVC static extra fields
                                + '<div id="k8s-vol-static-fields-' + i + '-' + j + '" style="' + showStatic + ';margin-top:0.2rem">'
                                +   '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">PV Name (bind to existing)</label>'
                                +     '<input type="text" id="k8s-svc-vol-pvname-' + i + '-' + j + '" class="modal-form-input" placeholder="pre-existing-pv-name" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +   '</div>'
                                +   '<div style="font-size:0.6rem;color:var(--text-muted);margin-top:2px">Requires a pre-existing PersistentVolume in the cluster</div>'
                                + '</div>'
                                // emptyDir fields
                                + '<div id="k8s-vol-empty-fields-' + i + '-' + j + '" style="' + showEmpty + ';margin-top:0.2rem">'
                                +   '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.3rem">'
                                +     '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Medium</label>'
                                +       '<select id="k8s-svc-vol-medium-' + i + '-' + j + '" class="modal-form-select" style="font-size:0.72rem;padding:0.15rem 0.2rem">'
                                +         '<option value="" selected>Disk (default)</option>'
                                +         '<option value="Memory">Memory (tmpfs â€” faster, uses RAM)</option>'
                                +       '</select>'
                                +     '</div>'
                                +     '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Size Limit (optional)</label>'
                                +       '<input type="text" id="k8s-svc-vol-sizelimit-' + i + '-' + j + '" class="modal-form-input" placeholder="e.g. 1Gi" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +     '</div>'
                                +   '</div>'
                                +   '<div style="font-size:0.6rem;color:var(--warning);margin-top:2px">âš ï¸ Data is lost when pod is restarted or rescheduled</div>'
                                + '</div>'
                                // ConfigMap mount extra fields (key only â€” name is in the source input)
                                + '<div id="k8s-vol-cm-fields-' + i + '-' + j + '" style="' + showCm + ';margin-top:0.2rem">'
                                +   '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Key (optional, single file)</label>'
                                +     '<input type="text" id="k8s-svc-vol-cmkey-' + i + '-' + j + '" class="modal-form-input" placeholder="e.g. nginx.conf" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +   '</div>'
                                +   '<div style="font-size:0.6rem;color:var(--text-muted);margin-top:2px">Mounts ConfigMap data as files in the container</div>'
                                + '</div>'
                                // Secret mount extra fields (key only â€” name is in the source input)
                                + '<div id="k8s-vol-sec-fields-' + i + '-' + j + '" style="' + showSec + ';margin-top:0.2rem">'
                                +   '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Key (optional, single file)</label>'
                                +     '<input type="text" id="k8s-svc-vol-seckey-' + i + '-' + j + '" class="modal-form-input" placeholder="e.g. tls.crt" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +   '</div>'
                                +   '<div style="font-size:0.6rem;color:var(--text-muted);margin-top:2px">Mounts Secret data as files (e.g. TLS certs, SSH keys)</div>'
                                + '</div>'
                                // hostPath extra fields (type only â€” path is in the source input)
                                + '<div id="k8s-vol-host-fields-' + i + '-' + j + '" style="' + showHost + ';margin-top:0.2rem">'
                                +   '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Path Type</label>'
                                +     '<select id="k8s-svc-vol-hosttype-' + i + '-' + j + '" class="modal-form-select" style="font-size:0.72rem;padding:0.15rem 0.2rem">'
                                +       '<option value="DirectoryOrCreate" selected>DirectoryOrCreate</option>'
                                +       '<option value="Directory">Directory</option>'
                                +       '<option value="FileOrCreate">FileOrCreate</option>'
                                +       '<option value="File">File</option>'
                                +     '</select>'
                                +   '</div>'
                                +   '<div style="font-size:0.6rem;color:var(--warning);margin-top:2px">âš ï¸ Not portable. Ties pod to specific node. Security risk.</div>'
                                + '</div>'
                                + '</div>';
                        };

                        // â”€â”€ Volume type change handler â”€â”€
                        window._k8sVolTypeChange = (i, j) => {
                            const sel = document.getElementById('k8s-svc-vol-type-' + i + '-' + j);
                            if (!sel) return;
                            const t = sel.value;

                            // Update source label + placeholder based on type
                            const srcLabelEl = document.getElementById('k8s-vol-src-label-' + i + '-' + j);
                            const srcInput = document.getElementById('k8s-svc-vol-name-' + i + '-' + j);
                            const mappingRow = document.getElementById('k8s-vol-mapping-' + i + '-' + j);
                            const mountOnly = document.getElementById('k8s-vol-mount-only-' + i + '-' + j);
                            const _srcLabels = { 'pvc-dynamic': 'PVC Name', 'pvc-static': 'PVC Name', 'configMap': 'ConfigMap', 'secret': 'Secret', 'hostPath': 'Host Path' };
                            const _srcPlaceholders = { 'pvc-dynamic': 'my-data', 'pvc-static': 'my-data', 'configMap': 'my-config', 'secret': 'my-tls-cert', 'hostPath': '/host/path' };
                            if (srcLabelEl) srcLabelEl.textContent = _srcLabels[t] || 'Volume Source';
                            if (srcInput) srcInput.placeholder = _srcPlaceholders[t] || 'volume-name';
                            // Toggle mapping row vs emptyDir mount-only
                            const isEmptyDir = t === 'emptyDir';
                            if (mappingRow) mappingRow.style.display = isEmptyDir ? 'none' : '';
                            if (mountOnly) mountOnly.style.display = isEmptyDir ? '' : 'none';
                            // Sync mount path from emptyDir input when switching back
                            if (!isEmptyDir && mountOnly) {
                                const emptyMount = document.getElementById('k8s-svc-vol-mount-empty-' + i + '-' + j);
                                const mainMount = document.getElementById('k8s-svc-vol-mount-' + i + '-' + j);
                                if (emptyMount && mainMount && emptyMount.value) mainMount.value = emptyMount.value;
                            }

                            const ids = {
                                pvc:    'k8s-vol-pvc-fields-' + i + '-' + j,
                                static: 'k8s-vol-static-fields-' + i + '-' + j,
                                empty:  'k8s-vol-empty-fields-' + i + '-' + j,
                                cm:     'k8s-vol-cm-fields-' + i + '-' + j,
                                sec:    'k8s-vol-sec-fields-' + i + '-' + j,
                                host:   'k8s-vol-host-fields-' + i + '-' + j,
                            };
                            const el = (k) => document.getElementById(ids[k]);
                            if (el('pvc'))    el('pvc').style.display    = (t === 'pvc-dynamic' || t === 'pvc-static') ? '' : 'none';
                            if (el('static')) el('static').style.display = (t === 'pvc-static') ? '' : 'none';
                            if (el('empty'))  el('empty').style.display  = (t === 'emptyDir') ? '' : 'none';
                            if (el('cm'))     el('cm').style.display     = (t === 'configMap') ? '' : 'none';
                            if (el('sec'))    el('sec').style.display    = (t === 'secret') ? '' : 'none';
                            if (el('host'))   el('host').style.display   = (t === 'hostPath') ? '' : 'none';
                            window._updateVolSummary(i);
                        };

                        // â”€â”€ StorageClass change handler (per-volume) â”€â”€
                        window._k8sVolScChange = (i, j) => {
                            const sel = document.getElementById('k8s-svc-vol-sc-' + i + '-' + j);
                            const custom = document.getElementById('k8s-svc-vol-sc-custom-' + i + '-' + j);
                            const lhPanel = document.getElementById('k8s-vol-lh-' + i + '-' + j);
                            if (!sel) return;
                            // Show/hide custom input
                            if (custom) custom.style.display = (sel.value === '_custom') ? '' : 'none';
                            // Show/hide Longhorn panel â€” check both catalog entry and name pattern
                            const scVal = (sel.value === '_custom' && custom) ? custom.value : sel.value;
                            const scEntry = _SC_FLAT[scVal];
                            const isLonghorn = (scEntry && scEntry.hasExtra) || scVal.toLowerCase().includes('longhorn');
                            if (lhPanel) lhPanel.style.display = isLonghorn ? '' : 'none';
                        };

                        // â”€â”€ Add volume row â”€â”€
                        window._addVolRow = (i) => {
                            const list = document.getElementById('k8s-svc-vol-list-' + i);
                            if (!list) return;
                            // Remove "no volumes" placeholder if present
                            const placeholder = list.querySelector('div[style*="font-style:italic"]');
                            if (placeholder) placeholder.remove();
                            // Find max existing j
                            let maxJ = -1;
                            list.querySelectorAll('.k8s-vol-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vol-chk-"]');
                                if (chk) {
                                    const parts = chk.id.split('-');
                                    const jVal = parseInt(parts[parts.length - 1]);
                                    if (!isNaN(jVal) && jVal > maxJ) maxJ = jVal;
                                }
                            });
                            const j = maxJ + 1;
                            const cl = { type: 'pvc-dynamic', name: '', mountPath: '', source: '', defaultSize: '5Gi', classification: 'manual' };
                            const wrapper = document.createElement('div');
                            wrapper.innerHTML = window._volRowHtml(i, j, cl);
                            list.appendChild(wrapper.firstElementChild);
                            window._updateVolSummary(i);
                        };

                        // â”€â”€ Volume summary updater â”€â”€
                        window._updateVolSummary = (i) => {
                            const sumEl = document.getElementById('k8s-svc-vol-summary-' + i);
                            if (!sumEl) return;
                            const list = document.getElementById('k8s-svc-vol-list-' + i);
                            if (!list) { sumEl.textContent = ''; return; }
                            let pvcCount = 0, emptyCount = 0, otherCount = 0;
                            list.querySelectorAll('.k8s-vol-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vol-chk-"]');
                                if (!chk || !chk.checked) return;
                                const parts = chk.id.split('-');
                                const j = parts[parts.length - 1];
                                const typeSel = document.getElementById('k8s-svc-vol-type-' + i + '-' + j);
                                const t = typeSel ? typeSel.value : '';
                                if (t === 'pvc-dynamic' || t === 'pvc-static') pvcCount++;
                                else if (t === 'emptyDir') emptyCount++;
                                else otherCount++;
                            });
                            const parts = [];
                            if (pvcCount > 0) parts.push(pvcCount + ' PVC');
                            if (emptyCount > 0) parts.push(emptyCount + ' emptyDir');
                            if (otherCount > 0) parts.push(otherCount + ' other');
                            sumEl.textContent = parts.length > 0 ? 'â€” ' + parts.join(', ') : '';
                        };

                        // â”€â”€ Shared volume collector (works for any i: numeric, infraId, compId) â”€â”€
                        window._collectVolumes = (i) => {
                            const _v = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };
                            const vols = [];
                            const volList = document.getElementById('k8s-svc-vol-list-' + i);
                            if (!volList) return vols;
                            volList.querySelectorAll('.k8s-vol-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vol-chk-"]');
                                if (!chk || !chk.checked) return;
                                const ps = chk.id.split('-');
                                const j = ps[ps.length - 1];
                                const type = _v('k8s-svc-vol-type-' + i + '-' + j) || 'pvc-dynamic';
                                // For emptyDir, mount path may be in the dedicated emptyDir input
                                const mountPath = (type === 'emptyDir'
                                    ? (_v('k8s-svc-vol-mount-empty-' + i + '-' + j) || _v('k8s-svc-vol-mount-' + i + '-' + j))
                                    : _v('k8s-svc-vol-mount-' + i + '-' + j));
                                if (!mountPath) return;
                                const vol = { type, mountPath };
                                // The unified source input (k8s-svc-vol-name) holds the source for all types
                                const srcName = _v('k8s-svc-vol-name-' + i + '-' + j);
                                if (type === 'pvc-dynamic' || type === 'pvc-static') {
                                    vol.name = srcName || 'data-' + j;
                                    vol.size = _v('k8s-svc-vol-size-' + i + '-' + j) || '10Gi';
                                    vol.accessMode = _v('k8s-svc-vol-access-' + i + '-' + j) || 'ReadWriteOnce';
                                    if (type === 'pvc-static') vol.pvName = _v('k8s-svc-vol-pvname-' + i + '-' + j) || '';
                                    const scSel = document.getElementById('k8s-svc-vol-sc-' + i + '-' + j);
                                    if (scSel) {
                                        vol.storageClass = scSel.value === '_custom'
                                            ? (_v('k8s-svc-vol-sc-custom-' + i + '-' + j) || '')
                                            : (scSel.value || '');
                                        if (vol.storageClass.toLowerCase().includes('longhorn')) {
                                            vol.longhornConfig = {
                                                replicas: _v('k8s-vol-lh-replicas-' + i + '-' + j) || '3',
                                                dataLocality: _v('k8s-vol-lh-locality-' + i + '-' + j) || 'best-effort',
                                            };
                                        }
                                    }
                                } else if (type === 'emptyDir') {
                                    vol.medium = _v('k8s-svc-vol-medium-' + i + '-' + j) || '';
                                    vol.sizeLimit = _v('k8s-svc-vol-sizelimit-' + i + '-' + j) || '';
                                } else if (type === 'configMap') {
                                    vol.configMapName = srcName || '';
                                    vol.key = _v('k8s-svc-vol-cmkey-' + i + '-' + j) || '';
                                } else if (type === 'secret') {
                                    vol.secretName = srcName || '';
                                    vol.key = _v('k8s-svc-vol-seckey-' + i + '-' + j) || '';
                                } else if (type === 'hostPath') {
                                    vol.hostPath = srcName || '';
                                    vol.hostType = _v('k8s-svc-vol-hosttype-' + i + '-' + j) || 'DirectoryOrCreate';
                                }
                                vols.push(vol);
                            });
                            return vols;
                        };

                        // â”€â”€ Add VCT row (StatefulSet volumeClaimTemplate) â”€â”€
                        window._k8sAddVCT = (i) => {
                            const list = document.getElementById('k8s-svc-vct-list-' + i);
                            if (!list) return;
                            // Remove "no volumes" placeholder if present
                            const ph = list.querySelector('div[style*="font-style:italic"]');
                            if (ph && !list.querySelector('.k8s-vct-row')) { list.innerHTML = ''; }
                            let maxJ = -1;
                            list.querySelectorAll('.k8s-vct-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vct-chk-"]');
                                if (chk) {
                                    const parts = chk.id.split('-');
                                    const jVal = parseInt(parts[parts.length - 1]);
                                    if (!isNaN(jVal) && jVal > maxJ) maxJ = jVal;
                                }
                            });
                            const j = maxJ + 1;
                            const rowHtml = `<div class="k8s-vct-row" style="padding:0.3rem;border:1px solid var(--border-subtle);border-radius:4px;background:var(--bg-secondary)">
                                <div style="display:grid;grid-template-columns:auto 1fr 2fr 1fr 1fr 1fr;gap:0.3rem;align-items:center;font-size:0.72rem">
                                    <label><input type="checkbox" id="k8s-svc-vct-chk-${i}-${j}" checked style="accent-color:var(--accent)"></label>
                                    <div>${_lbl('Name')}${_inp(`k8s-svc-vct-name-${i}-${j}`, 'data-' + j, 'data')}</div>
                                    <div>${_lbl('Mount Path')}${_inp(`k8s-svc-vct-mount-${i}-${j}`, '/mnt/data', '/var/lib/data')}</div>
                                    <div>${_lbl('Size')}${_inp(`k8s-svc-vct-size-${i}-${j}`, '10Gi', '10Gi')}</div>
                                    <div>${_lbl('Access Mode')}${_sel(`k8s-svc-vct-access-${i}-${j}`, [
                                        {v:'ReadWriteOnce', l:'RWO'},
                                        {v:'ReadWriteMany', l:'RWX'},
                                        {v:'ReadOnlyMany', l:'ROX'},
                                    ], 'ReadWriteOnce')}</div>
                                    <div>${_lbl('StorageClass')}${_inp(`k8s-svc-vct-sc-${i}-${j}`, '', 'longhorn')}</div>
                                </div>
                            </div>`;
                            const wrapper = document.createElement('div');
                            wrapper.innerHTML = rowHtml;
                            list.appendChild(wrapper.firstElementChild);
                        };

                        // â”€â”€ Init Container helpers â”€â”€
                        window._k8sInitRowHtml = (i, j, name, image, command) => {
                            return `<div class="k8s-init-row" data-j="${j}" style="padding:0.35rem;border:1px solid var(--border-subtle);border-radius:4px;background:var(--bg-secondary)">
                                <div style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem">
                                    <span style="font-size:0.68rem;color:var(--accent);font-weight:600">â³ ${j + 1}.</span>
                                    <input type="text" id="k8s-svc-init-name-${i}-${j}" class="modal-form-input" value="${name}" placeholder="init-container" style="font-size:0.72rem;padding:0.15rem 0.3rem;flex:1">
                                    <button type="button" onclick="window._k8sRemoveInit(${i},this)" style="background:none;border:none;cursor:pointer;font-size:0.78rem;color:var(--text-muted);padding:0 4px" title="Remove">âœ•</button>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 2fr;gap:0.3rem;font-size:0.72rem">
                                    <div>
                                        ${_lbl('Image')}
                                        <input type="text" id="k8s-svc-init-img-${i}-${j}" class="modal-form-input" value="${image}" placeholder="busybox:1.36" style="font-size:0.72rem;padding:0.15rem 0.3rem">
                                    </div>
                                    <div>
                                        ${_lbl('Command')}
                                        <input type="text" id="k8s-svc-init-cmd-${i}-${j}" class="modal-form-input" value="${command}" placeholder="sh -c &quot;...&quot;" style="font-size:0.72rem;padding:0.15rem 0.3rem">
                                    </div>
                                </div>
                            </div>`;
                        };

                        window._k8sUpdateInitCount = (i) => {
                            const countEl = document.getElementById('k8s-svc-init-count-' + i);
                            if (!countEl) return;
                            const list = document.getElementById('k8s-svc-init-list-' + i);
                            const cnt = list ? list.querySelectorAll('.k8s-init-row').length : 0;
                            countEl.textContent = cnt;
                        };

                        window._k8sRemoveInit = (i, btn) => {
                            const row = btn.closest('.k8s-init-row');
                            if (row) row.remove();
                            window._k8sUpdateInitCount(i);
                        };

                        window._k8sAddInitPreset = (i, preset) => {
                            const list = document.getElementById('k8s-svc-init-list-' + i);
                            if (!list) return;
                            let maxJ = -1;
                            list.querySelectorAll('.k8s-init-row').forEach(row => {
                                const jVal = parseInt(row.dataset.j);
                                if (!isNaN(jVal) && jVal > maxJ) maxJ = jVal;
                            });
                            const j = maxJ + 1;

                            // Get main container image for 'migrations' preset
                            const mainImg = (document.getElementById('k8s-svc-img-' + i) || {}).value || '';

                            const presets = {
                                'wait-tcp': {
                                    name: 'wait-for-tcp',
                                    image: 'busybox:1.36',
                                    command: 'sh -c "until nc -z HOST PORT; do echo Waiting...; sleep 2; done"',
                                },
                                'wait-http': {
                                    name: 'wait-for-http',
                                    image: 'curlimages/curl:latest',
                                    command: 'sh -c "until curl -sf http://HOST:PORT/health; do sleep 2; done"',
                                },
                                'migrations': {
                                    name: 'run-migrations',
                                    image: mainImg || 'app:latest',
                                    command: '',
                                },
                                'fix-perms': {
                                    name: 'fix-permissions',
                                    image: 'busybox:1.36',
                                    command: 'sh -c "chown -R 1000:1000 /data"',
                                },
                                'custom': {
                                    name: 'init-' + j,
                                    image: '',
                                    command: '',
                                },
                            };

                            const p = presets[preset] || presets['custom'];
                            const wrapper = document.createElement('div');
                            wrapper.innerHTML = window._k8sInitRowHtml(i, j, p.name, p.image, p.command);
                            list.appendChild(wrapper.firstElementChild);
                            window._k8sUpdateInitCount(i);
                        };

                        // â”€â”€ Sidecar Container helpers â”€â”€
                        window._k8sSidecarRowHtml = (i, j, name, image, command, native, sharedVol, sharedMount) => {
                            const nativeChecked = native !== false ? ' checked' : '';
                            const hasShared = sharedVol ? true : false;
                            return `<div class="k8s-sc-row" data-j="${j}" style="padding:0.35rem;border:1px solid var(--border-subtle);border-radius:4px;background:var(--bg-secondary)">
                                <div style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem">
                                    <span style="font-size:0.68rem;color:var(--accent);font-weight:600">ğŸ“ ${j + 1}.</span>
                                    <input type="text" id="k8s-svc-sc-name-${i}-${j}" class="modal-form-input" value="${name}" placeholder="sidecar" style="font-size:0.72rem;padding:0.15rem 0.3rem;flex:1">
                                    <button type="button" onclick="window._k8sRemoveSidecar(${i},this)" style="background:none;border:none;cursor:pointer;font-size:0.78rem;color:var(--text-muted);padding:0 4px" title="Remove">âœ•</button>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 2fr;gap:0.3rem;font-size:0.72rem">
                                    <div>
                                        ${_lbl('Image')}
                                        <input type="text" id="k8s-svc-sc-img-${i}-${j}" class="modal-form-input" value="${image}" placeholder="image:tag" style="font-size:0.72rem;padding:0.15rem 0.3rem">
                                    </div>
                                    <div>
                                        ${_lbl('Command (optional)')}
                                        <input type="text" id="k8s-svc-sc-cmd-${i}-${j}" class="modal-form-input" value="${command || ''}" placeholder="" style="font-size:0.72rem;padding:0.15rem 0.3rem">
                                    </div>
                                </div>
                                <div style="display:flex;align-items:center;gap:0.6rem;margin-top:0.25rem;font-size:0.66rem">
                                    <label style="display:inline-flex;align-items:center;gap:0.2rem;cursor:pointer;color:var(--text-secondary)">
                                        <input type="checkbox" id="k8s-svc-sc-native-${i}-${j}"${nativeChecked} style="accent-color:var(--accent)"> Native sidecar
                                        <span style="font-size:0.58rem;color:var(--text-muted)">(K8s â‰¥ 1.28)</span>
                                    </label>
                                </div>
                                ${hasShared ? `<div style="display:flex;align-items:center;gap:0.3rem;margin-top:0.2rem;font-size:0.66rem;padding:0.2rem 0.3rem;background:var(--bg-inset);border-radius:3px">
                                    <span style="color:var(--text-muted);font-weight:600">Shared volume:</span>
                                    <input type="text" id="k8s-svc-sc-shvol-${i}-${j}" class="modal-form-input" value="${sharedVol}" style="font-size:0.66rem;padding:0.1rem 0.2rem;width:80px">
                                    <span style="color:var(--text-muted)">mount:</span>
                                    <input type="text" id="k8s-svc-sc-shmount-${i}-${j}" class="modal-form-input" value="${sharedMount || '/shared'}" style="font-size:0.66rem;padding:0.1rem 0.2rem;width:100px">
                                </div>` : ''}
                            </div>`;
                        };

                        window._k8sUpdateScCount = (i) => {
                            const countEl = document.getElementById('k8s-svc-sc-count-' + i);
                            if (!countEl) return;
                            const list = document.getElementById('k8s-svc-sc-list-' + i);
                            const cnt = list ? list.querySelectorAll('.k8s-sc-row').length : 0;
                            countEl.textContent = cnt;
                        };

                        window._k8sRemoveSidecar = (i, btn) => {
                            const row = btn.closest('.k8s-sc-row');
                            if (row) row.remove();
                            window._k8sUpdateScCount(i);
                        };

                        window._k8sAddSidecarPreset = (i, preset) => {
                            const list = document.getElementById('k8s-svc-sc-list-' + i);
                            if (!list) return;
                            let maxJ = -1;
                            list.querySelectorAll('.k8s-sc-row').forEach(row => {
                                const jVal = parseInt(row.dataset.j);
                                if (!isNaN(jVal) && jVal > maxJ) maxJ = jVal;
                            });
                            const j = maxJ + 1;

                            const presets = {
                                'log-fwd': {
                                    name: 'log-forwarder', image: 'fluent/fluent-bit:2.2', command: '',
                                    native: true, sharedVol: 'shared-logs', sharedMount: '/var/log/app',
                                },
                                'cfg-reload': {
                                    name: 'config-reloader', image: 'jimmidyson/configmap-reload:v0.13', command: '',
                                    native: true, sharedVol: '', sharedMount: '',
                                },
                                'metrics': {
                                    name: 'metrics-exporter', image: 'prom/statsd-exporter:v0.26', command: '',
                                    native: true, sharedVol: '', sharedMount: '',
                                },
                                'auth-proxy': {
                                    name: 'auth-proxy', image: 'oauth2-proxy/oauth2-proxy:v7', command: '',
                                    native: true, sharedVol: '', sharedMount: '',
                                },
                                'cloudsql': {
                                    name: 'cloud-sql-proxy', image: 'gcr.io/cloud-sql-connectors/cloud-sql-proxy:2', command: '',
                                    native: true, sharedVol: '', sharedMount: '',
                                },
                                'vault': {
                                    name: 'vault-agent', image: 'hashicorp/vault:1.15', command: '',
                                    native: true, sharedVol: 'vault-secrets', sharedMount: '/vault/secrets',
                                },
                                'custom': {
                                    name: 'sidecar-' + j, image: '', command: '',
                                    native: true, sharedVol: '', sharedMount: '',
                                },
                            };

                            const p = presets[preset] || presets['custom'];
                            const wrapper = document.createElement('div');
                            wrapper.innerHTML = window._k8sSidecarRowHtml(i, j, p.name, p.image, p.command, p.native, p.sharedVol, p.sharedMount);
                            list.appendChild(wrapper.firstElementChild);
                            window._k8sUpdateScCount(i);
                        };

                        // â”€â”€ Companion Container helpers â”€â”€

                        // Read env vars from source card DOM (before hiding)
                        window._k8sReadSourceEnv = (sourceIdx) => {
                            const list = document.getElementById('k8s-svc-env-list-' + sourceIdx);
                            if (!list) return [];
                            const vars = [];
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (!keyEl) return;
                                const parts = keyEl.id.split('-');
                                const j = parts[parts.length - 1];
                                const key = (document.getElementById('k8s-svc-env-key-' + sourceIdx + '-' + j) || {}).value || '';
                                if (!key.trim()) return;
                                const type = (document.getElementById('k8s-svc-env-type-' + sourceIdx + '-' + j) || {}).value || 'hardcoded';
                                const value = (document.getElementById('k8s-svc-env-val-' + sourceIdx + '-' + j) || {}).value || '';
                                vars.push({ key: key.trim(), type, value: value.trim() });
                            });
                            return vars;
                        };

                        // Read resource limits from source card DOM
                        window._k8sReadSourceResources = (sourceIdx) => {
                            const cpuReq = (document.getElementById('k8s-svc-cpu-req-' + sourceIdx) || {}).value || '';
                            const cpuLim = (document.getElementById('k8s-svc-cpu-lim-' + sourceIdx) || {}).value || '';
                            const memReq = (document.getElementById('k8s-svc-mem-req-' + sourceIdx) || {}).value || '';
                            const memLim = (document.getElementById('k8s-svc-mem-lim-' + sourceIdx) || {}).value || '';
                            if (!cpuReq && !cpuLim && !memReq && !memLim) return null;
                            return { cpuReq, cpuLim, memReq, memLim };
                        };

                        // Read volumes from source card DOM
                        window._k8sReadSourceVolumes = (sourceIdx) => {
                            const volList = document.getElementById('k8s-svc-vol-list-' + sourceIdx);
                            if (!volList) return [];
                            const vols = [];
                            volList.querySelectorAll('.k8s-vol-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vol-chk-"]');
                                if (!chk || !chk.checked) return;
                                const ps = chk.id.split('-');
                                const j = ps[ps.length - 1];
                                const mountPath = (document.getElementById('k8s-svc-vol-mount-' + sourceIdx + '-' + j) || {}).value || '';
                                const type = (document.getElementById('k8s-svc-vol-type-' + sourceIdx + '-' + j) || {}).value || 'pvc-dynamic';
                                const name = (document.getElementById('k8s-svc-vol-name-' + sourceIdx + '-' + j) || {}).value || '';
                                if (mountPath) vols.push({ name, type, mountPath });
                            });
                            return vols;
                        };

                        // â”€â”€ Companion env type change handler â”€â”€
                        window._k8sCompEnvTypeChange = (sel) => {
                            const row = sel.closest('.k8s-comp-env-row');
                            if (!row) return;
                            const valInp = row.querySelector('input[id*="-env-val-"]');
                            if (!valInp) return;
                            if (sel.value === 'secret') {
                                valInp.type = 'password';
                                valInp.placeholder = 'â€¢â€¢â€¢â€¢â€¢â€¢';
                            } else {
                                valInp.type = 'text';
                                valInp.placeholder = sel.value === 'variable' ? '${VAR_NAME}' : 'value';
                            }
                        };

                        // â”€â”€ Read host pod's current volumes live from DOM â”€â”€
                        window._k8sReadHostVolumes = (targetIdx) => {
                            const volList = document.getElementById('k8s-svc-vol-list-' + targetIdx);
                            if (!volList) return [];
                            const vols = [];
                            volList.querySelectorAll('.k8s-vol-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vol-chk-"]');
                                if (!chk || !chk.checked) return;
                                const ps = chk.id.split('-');
                                const j = ps[ps.length - 1];
                                const mountPath = (document.getElementById('k8s-svc-vol-mount-' + targetIdx + '-' + j) || {}).value || '';
                                const type = (document.getElementById('k8s-svc-vol-type-' + targetIdx + '-' + j) || {}).value || 'pvc-dynamic';
                                const name = (document.getElementById('k8s-svc-vol-name-' + targetIdx + '-' + j) || {}).value || '';
                                // Source label from the code element in row 1
                                const codeEl = row.querySelector('code');
                                const label = codeEl ? codeEl.textContent : (name || mountPath);
                                vols.push({ name, type, mountPath, label });
                            });
                            return vols;
                        };

                        // â”€â”€ Refresh companion's host-volume section (called on details toggle) â”€â”€
                        window._k8sRefreshCompHostVols = (targetIdx, sourceIdx) => {
                            const container = document.getElementById('k8s-comp-hostvols-' + targetIdx + '-' + sourceIdx);
                            if (!container) return;
                            const hostVols = window._k8sReadHostVolumes(targetIdx);
                            if (hostVols.length === 0) {
                                container.innerHTML = '<div style="font-size:0.72rem;color:var(--text-muted);font-style:italic">No volumes on host pod yet â€” add volumes to the main service first.</div>';
                                return;
                            }
                            let html = '<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.15rem">Check to mount in this companion:</div>';
                            hostVols.forEach((vol, j) => {
                                const id = 'k8s-comp-hostvol-' + targetIdx + '-' + sourceIdx + '-' + j;
                                html += '<div class="k8s-comp-hostvol-row" style="display:grid;grid-template-columns:auto 1fr 1fr;gap:0.25rem;align-items:center;margin-bottom:0.15rem">'
                                    + '<input type="checkbox" id="' + id + '-chk" style="accent-color:var(--accent)">'
                                    + '<code style="font-size:0.72rem;color:var(--text-secondary);font-family:var(--font-mono,monospace);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + esc(vol.label) + '">' + esc(vol.label) + '</code>'
                                    + '<input type="text" id="' + id + '-mount" class="modal-form-input" value="' + esc(vol.mountPath) + '" placeholder="/data" style="font-size:0.74rem;padding:0.12rem 0.2rem">'
                                    + '<input type="hidden" id="' + id + '-name" value="' + esc(vol.name) + '">'
                                    + '<input type="hidden" id="' + id + '-type" value="' + esc(vol.type) + '">'
                                    + '</div>';
                            });
                            container.innerHTML = html;
                        };

                        // â”€â”€ Build infra options list for dependency dropdown â”€â”€
                        window._k8sCompDepOptions = (targetIdx, sourceIdx) => {
                            let opts = '<option value="">â¸ None</option>';
                            (window._k8sActiveInfra || new Set()).forEach(name => {
                                const svcData = (window._k8sInfraData || new Map()).get(name) || {};
                                const port = svcData.ports && svcData.ports.length > 0 ? svcData.ports[0].container : '';
                                const val = port ? (name + ':' + port) : name;
                                opts += '<option value="' + esc(val) + '">ğŸ”§ ' + esc(name) + (port ? ' :' + port : '') + '</option>';
                            });
                            return opts;
                        };

                        // Render a rich companion card  (DOM IDs: k8s-comp-{tgt}-{src}-*)
                        window._k8sCompanionRowHtml = (targetIdx, comp) => {
                            const t = targetIdx;
                            const s = comp.sourceIndex;
                            const eName = esc(comp.svcName);
                            const eImg = esc(comp.image || '');
                            const imgShort = esc((comp.image || '').split('/').pop().split(':')[0] || comp.svcName);
                            const envVars = comp.envVars || [];
                            const resources = comp.resources;
                            const volumes = comp.volumes || [];

                            let h = '<div id="k8s-companion-row-' + s + '" style="border:1px solid var(--border-subtle);border-radius:6px;padding:0.45rem 0.5rem;background:var(--bg-secondary)">';

                            // â”€â”€ Header row â”€â”€
                            h += '<div style="display:flex;align-items:center;gap:0.4rem;font-size:0.78rem;margin-bottom:0.2rem">'
                                + '<span style="font-size:0.9rem">ğŸ“¦</span>'
                                + '<strong>' + eName + '</strong>'
                                + '<code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">' + imgShort + '</code>'
                                + (comp.port ? '<code style="font-size:0.72rem;color:var(--text-muted)">:' + esc(comp.port) + '</code>' : '')
                                + '<span style="flex:1"></span>'
                                + '<button type="button" onclick="window._k8sSplitBack(' + s + ',' + t + ')"'
                                + ' style="font-size:0.74rem;color:var(--accent);background:none;border:1px solid var(--border-subtle);border-radius:4px;padding:0.15rem 0.4rem;cursor:pointer"'
                                + '>â¤´ Split back</button>'
                                + '</div>';

                            // â”€â”€ Image & Port (editable) â”€â”€
                            h += '<div style="display:grid;grid-template-columns:2fr 1fr;gap:0.3rem;margin-bottom:0.3rem">'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">Image</label>'
                                + '<input type="text" id="k8s-comp-img-' + t + '-' + s + '" class="modal-form-input" value="' + eImg + '" style="font-size:0.78rem;padding:0.2rem 0.3rem"></div>'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">Port</label>'
                                + '<input type="text" id="k8s-comp-port-' + t + '-' + s + '" class="modal-form-input" value="' + esc(comp.port || '') + '" placeholder="optional" style="font-size:0.78rem;padding:0.2rem 0.3rem"></div>'
                                + '</div>';

                            // â”€â”€ Startup Dependency â”€â”€
                            h += '<div style="margin-bottom:0.3rem">'
                                + '<label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">â³ Startup dependency (wait-for init container)</label>'
                                + '<select id="k8s-comp-dep-' + t + '-' + s + '" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem">'
                                + window._k8sCompDepOptions(t, s)
                                + '</select>'
                                + '<div style="font-size:0.68rem;color:var(--text-muted);margin-top:2px">Generates a wait-for init container targeting the infra service via K8s DNS.</div>'
                                + '</div>';

                            // â”€â”€ Environment Variables (collapsible, reuses main _envRowHtml) â”€â”€
                            const compEnvId = 'comp-' + t + '-' + s;   // composite ID for _envRowHtml
                            h += '<details style="margin-top:0.15rem">'
                                + '<summary style="cursor:pointer;font-size:0.74rem;color:var(--accent);user-select:none;padding:0.1rem 0">'
                                + 'â–¸ Environment Variables <span id="k8s-svc-env-summary-' + compEnvId + '" style="font-size:0.68rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">' + envVars.length + '</span>'
                                + '</summary>'
                                + '<div style="margin-top:0.2rem;padding:0.3rem 0.4rem;background:var(--bg-primary);border-radius:4px;border:1px solid var(--border-subtle)">';

                            h += '<div id="k8s-svc-env-list-' + compEnvId + '" style="display:flex;flex-direction:column;gap:0.15rem">';
                            if (envVars.length > 0) {
                                envVars.forEach((ev, j) => {
                                    const injType = ev.type || 'hardcoded';
                                    const varN = ev.varName || (injType !== 'hardcoded' ? '${' + ev.key + '}' : '');
                                    h += _envRowHtml(compEnvId, j, ev.key, ev.value || '', injType, varN, compEnvId);
                                });
                            } else {
                                h += '<div style="font-size:0.72rem;color:var(--text-muted);font-style:italic">No environment variables</div>';
                            }
                            h += '</div>';
                            h += '<button type="button" onclick="window._addEnvVar(\'' + compEnvId + '\')"'
                                + ' style="margin-top:0.2rem;font-size:0.72rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.15rem 0.4rem;cursor:pointer;width:100%">'
                                + '+ Add variable</button>';
                            h += '</div></details>';

                            // â”€â”€ Resource Limits (collapsible) â”€â”€
                            const res = resources || {};
                            h += '<details style="margin-top:0.15rem">'
                                + '<summary style="cursor:pointer;font-size:0.74rem;color:var(--accent);user-select:none;padding:0.1rem 0">'
                                + 'â–¸ Resource Limits'
                                + '</summary>'
                                + '<div style="margin-top:0.2rem;padding:0.3rem 0.4rem;background:var(--bg-primary);border-radius:4px;border:1px solid var(--border-subtle)">'
                                + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.3rem;font-size:0.76rem">'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">CPU Req</label>'
                                + '<input type="text" id="k8s-comp-cpureq-' + t + '-' + s + '" class="modal-form-input" value="' + esc(res.cpuReq || '') + '" placeholder="100m" style="font-size:0.76rem;padding:0.15rem 0.25rem"></div>'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">CPU Lim</label>'
                                + '<input type="text" id="k8s-comp-cpulim-' + t + '-' + s + '" class="modal-form-input" value="' + esc(res.cpuLim || '') + '" placeholder="500m" style="font-size:0.76rem;padding:0.15rem 0.25rem"></div>'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">Mem Req</label>'
                                + '<input type="text" id="k8s-comp-memreq-' + t + '-' + s + '" class="modal-form-input" value="' + esc(res.memReq || '') + '" placeholder="128Mi" style="font-size:0.76rem;padding:0.15rem 0.25rem"></div>'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">Mem Lim</label>'
                                + '<input type="text" id="k8s-comp-memlim-' + t + '-' + s + '" class="modal-form-input" value="' + esc(res.memLim || '') + '" placeholder="256Mi" style="font-size:0.76rem;padding:0.15rem 0.25rem"></div>'
                                + '</div>'
                                + '</div></details>';

                            // â”€â”€ Volume Mounts (collapsible â€” live-reads host pod volumes on toggle) â”€â”€
                            h += '<details style="margin-top:0.15rem" ontoggle="if(this.open)window._k8sRefreshCompHostVols(' + t + ',' + s + ')">'
                                + '<summary style="cursor:pointer;font-size:0.74rem;color:var(--accent);user-select:none;padding:0.1rem 0">'
                                + 'â–¸ Volume Mounts'
                                + '</summary>'
                                + '<div style="margin-top:0.2rem;padding:0.3rem 0.4rem;background:var(--bg-primary);border-radius:4px;border:1px solid var(--border-subtle)">';

                            // Sub-section: Host pod volumes (live-populated)
                            h += '<div style="font-size:0.72rem;font-weight:600;color:var(--text-muted);margin-bottom:0.15rem">ğŸ“ Host pod volumes</div>'
                                + '<div id="k8s-comp-hostvols-' + t + '-' + s + '" style="margin-bottom:0.3rem">'
                                + '<div style="font-size:0.72rem;color:var(--text-muted);font-style:italic">Open this section to detect host volumesâ€¦</div>'
                                + '</div>';

                            // Sub-section: Companion's own volumes (from source + added)
                            h += '<div style="font-size:0.72rem;font-weight:600;color:var(--text-muted);margin-bottom:0.15rem">ğŸ“¦ Companion-own volumes</div>'
                                + '<div id="k8s-comp-vol-list-' + t + '-' + s + '" style="display:flex;flex-direction:column;gap:0.2rem">';

                            if (volumes.length > 0) {
                                volumes.forEach((vol, j) => {
                                    h += '<div class="k8s-comp-vol-row" style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:0.2rem;align-items:center">'
                                        + '<input type="text" id="k8s-comp-vol-name-' + t + '-' + s + '-' + j + '" class="modal-form-input" value="' + esc(vol.name || '') + '" placeholder="volume-name" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                        + '<input type="text" id="k8s-comp-vol-mount-' + t + '-' + s + '-' + j + '" class="modal-form-input" value="' + esc(vol.mountPath || '') + '" placeholder="/data" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                        + '<select id="k8s-comp-vol-type-' + t + '-' + s + '-' + j + '" class="modal-form-select" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                        + '<option value="pvc-dynamic"' + (vol.type === 'pvc-dynamic' ? ' selected' : '') + '>ğŸ’¾ PVC</option>'
                                        + '<option value="emptyDir"' + (vol.type === 'emptyDir' ? ' selected' : '') + '>ğŸ“‚ emptyDir</option>'
                                        + '<option value="configMap"' + (vol.type === 'configMap' ? ' selected' : '') + '>ğŸ“„ ConfigMap</option>'
                                        + '<option value="secret"' + (vol.type === 'secret' ? ' selected' : '') + '>ğŸ” Secret</option>'
                                        + '</select>'
                                        + '<button type="button" onclick="this.closest(\'.k8s-comp-vol-row\').remove()" style="background:none;border:none;cursor:pointer;font-size:0.78rem;color:var(--text-muted);padding:0 2px" title="Remove">âœ•</button>'
                                        + '</div>';
                                });
                            }
                            h += '</div>';
                            h += '<button type="button" onclick="window._k8sAddCompVol(' + t + ',' + s + ')"'
                                + ' style="margin-top:0.2rem;font-size:0.72rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.15rem 0.4rem;cursor:pointer;width:100%">'
                                + '+ Add companion volume</button>';
                            h += '</div></details>';

                            h += '</div>';
                            return h;
                        };

                        // Add env row to companion (with type change handler)
                        window._k8sAddCompEnv = (targetIdx, sourceIdx) => {
                            const list = document.getElementById('k8s-comp-env-list-' + targetIdx + '-' + sourceIdx);
                            if (!list) return;
                            // Remove "No environment variables" placeholder
                            const placeholder = list.querySelector('div[style*="font-style:italic"]');
                            if (placeholder) placeholder.remove();
                            const j = list.querySelectorAll('.k8s-comp-env-row').length;
                            const compId = targetIdx + '-' + sourceIdx;
                            const row = document.createElement('div');
                            row.className = 'k8s-comp-env-row';
                            row.style.cssText = 'margin-bottom:0.15rem';
                            row.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:0.2rem;align-items:center">'
                                + '<input type="text" id="k8s-comp-env-key-' + compId + '-' + j + '" class="modal-form-input" placeholder="KEY_NAME"'
                                + ' oninput="if(!this.dataset.envTs)this.dataset.envTs=Date.now();window._wizValidation.recheck(\'k8s\')"'
                                + ' style="font-size:0.76rem;padding:0.15rem 0.25rem;font-family:var(--font-mono,monospace)">'
                                + '<input type="text" id="k8s-comp-env-val-' + compId + '-' + j + '" class="modal-form-input" placeholder="value" style="font-size:0.76rem;padding:0.15rem 0.25rem;font-family:var(--font-mono,monospace)">'
                                + '<select id="k8s-comp-env-type-' + compId + '-' + j + '" class="modal-form-select" style="font-size:0.76rem;padding:0.15rem 0.25rem"'
                                + ' onchange="window._k8sCompEnvTypeChange(this)">'
                                + '<option value="hardcoded" selected>ğŸ“‹ Hardcoded</option>'
                                + '<option value="variable">ğŸ”„ Variable</option>'
                                + '<option value="secret">ğŸ”’ Secret</option>'
                                + '</select>'
                                + '<button type="button" onclick="this.closest(\'.k8s-comp-env-row\').remove();window._wizValidation.recheck(\'k8s\')" style="background:none;border:none;cursor:pointer;font-size:0.78rem;color:var(--text-muted);padding:0 2px" title="Remove">âœ•</button>'
                                + '</div>'
                                + '<div id="k8s-comp-env-dupe-' + compId + '-' + j + '" hidden'
                                + ' style="font-size:0.76rem;margin:1px 0 3px;padding:3px 6px;border-radius:4px">'
                                + '</div>';
                            list.appendChild(row);
                            window._wizValidation.recheck('k8s');
                        };

                        // Add volume mount to companion
                        window._k8sAddCompVol = (targetIdx, sourceIdx) => {
                            const list = document.getElementById('k8s-comp-vol-list-' + targetIdx + '-' + sourceIdx);
                            if (!list) return;
                            const j = list.querySelectorAll('.k8s-comp-vol-row').length;
                            const row = document.createElement('div');
                            row.className = 'k8s-comp-vol-row';
                            row.style.cssText = 'display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:0.2rem;align-items:center';
                            row.innerHTML = '<input type="text" id="k8s-comp-vol-name-' + targetIdx + '-' + sourceIdx + '-' + j + '" class="modal-form-input" placeholder="volume-name" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                + '<input type="text" id="k8s-comp-vol-mount-' + targetIdx + '-' + sourceIdx + '-' + j + '" class="modal-form-input" placeholder="/data" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                + '<select id="k8s-comp-vol-type-' + targetIdx + '-' + sourceIdx + '-' + j + '" class="modal-form-select" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                + '<option value="emptyDir" selected>ğŸ“‚ emptyDir</option>'
                                + '<option value="pvc-dynamic">ğŸ’¾ PVC</option>'
                                + '<option value="configMap">ğŸ“„ ConfigMap</option>'
                                + '<option value="secret">ğŸ” Secret</option>'
                                + '</select>'
                                + '<button type="button" onclick="this.closest(\'.k8s-comp-vol-row\').remove()" style="background:none;border:none;cursor:pointer;font-size:0.78rem;color:var(--text-muted);padding:0 2px" title="Remove">âœ•</button>';
                            list.appendChild(row);
                        };

                        let html = '';

                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // â”€â”€ Section A: Application Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                        if (hasCompose && appSvcs.length > 0) {
                            html += wizSection('Application Deployments',
                                `${appSvcs.length} service${appSvcs.length !== 1 ? 's' : ''} from Docker Compose. Select which to deploy and configure each.`);

                            html += `<div style="display:flex;flex-direction:column;gap:0.5rem" id="k8s-app-svc-list">`;
                            for (let i = 0; i < appSvcs.length; i++) {
                                const svc = appSvcs[i];
                                svc._kindDefault = _classifyWorkloadKind(svc);
                                svc._kindHint = _kindHint(svc._kindDefault, svc);
                                const imgStr = svc._image || `${svc.name}:latest`;
                                const portVal = svc._port || 8080;
                                const envKeys = Object.keys(svc.environment || {});
                                const envVals = svc.environment || {};
                                const volCount = (svc.volumes || []).length;
                                const hc = svc.healthcheck;
                                const dp = svc.deploy;  // {replicas, cpu_limit, memory_limit, cpu_request, memory_request} | null
                                const hasDeps = (svc.depends_on || []).length > 0;

                                // Detect named volumes (not bind mounts) â€” suggests Recreate strategy
                                // Named volumes: "vol-name:/path" (no slash/dot in source)
                                // Bind mounts: "./src:/app" or "/host/path:/container" (has path separator in source)
                                const hasNamedVols = (svc.volumes || []).some(v => {
                                    const src = v.split(':')[0];
                                    return src && !src.includes('/') && !src.startsWith('.');
                                });
                                const defaultStrategy = hasNamedVols ? 'Recreate' : 'RollingUpdate';

                                // Pre-compute compose-sourced resource defaults
                                const compCpuReq = (dp && dp.cpu_request) || '';
                                const compCpuLim = (dp && dp.cpu_limit) || '';
                                const compMemReq = (dp && dp.memory_request) || '';
                                const compMemLim = (dp && dp.memory_limit) || '';
                                const hasComposeRes = compCpuReq || compCpuLim || compMemReq || compMemLim;

                                // â”€â”€ Saved state lookup (per-service) â”€â”€
                                const saved = _savedSvc(svc.name);
                                // Effective values: saved state takes priority, detection as fallback
                                const effKind     = saved?.kind ?? svc._kindDefault;
                                const effImage    = saved?.image || imgStr;
                                const effPort     = saved?.port ?? portVal;
                                const effReplicas = saved?.replicas ?? (dp && dp.replicas ? dp.replicas : 2);
                                const effSvcType  = saved?.serviceType || 'ClusterIP';
                                const effStrategy = saved?.strategy || defaultStrategy;
                                const effMaxSurge = saved?.maxSurge || '1';
                                const effMaxUnavail = saved?.maxUnavailable || '1';
                                const effCpuReq   = saved?.resources?.cpu_request || compCpuReq;
                                const effCpuLim   = saved?.resources?.cpu_limit || compCpuLim;
                                const effMemReq   = saved?.resources?.memory_request || compMemReq;
                                const effMemLim   = saved?.resources?.memory_limit || compMemLim;

                                html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);overflow:hidden" id="k8s-svc-card-${i}">
                                    <label style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.6rem;cursor:pointer;font-size:0.82rem"
                                        onmouseover="this.parentElement.style.borderColor='var(--accent)'" onmouseout="this.parentElement.style.borderColor='var(--border-subtle)'">
                                        <input type="checkbox" id="k8s-svc-chk-${i}" checked style="accent-color:var(--accent)"
                                            onchange="document.getElementById('k8s-svc-cfg-${i}').style.display=this.checked?'block':'none'">
                                        <span style="font-size:1rem" id="k8s-svc-icon-${i}">${_kindIcon(effKind)}</span>
                                        <strong>${esc(svc.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(svc.image ? svc.image.split('/').pop().split(':')[0] : 'local build')}</code>
                                        <span style="flex:1"></span>
                                        ${portVal ? `<code style="font-size:0.68rem;color:var(--text-muted)">:${portVal}</code>` : ''}
                                        <select id="k8s-svc-kind-${i}" class="modal-form-select"
                                            style="font-size:0.68rem;padding:0.1rem 0.3rem;min-width:110px;color:var(--success);font-weight:600;border-color:transparent;background:transparent"
                                            onclick="event.stopPropagation()" onmousedown="event.stopPropagation()"
                                            onchange="var ic=document.getElementById('k8s-svc-icon-'+${i});var hn=document.getElementById('k8s-svc-kind-hint-'+${i});if(ic)ic.textContent={'Deployment':'ğŸš€','StatefulSet':'ğŸ—„ï¸','DaemonSet':'ğŸŒ','Job':'âš¡','CronJob':'â°','Skip':'â­ï¸'}[this.value]||'ğŸ“¦';if(hn)hn.textContent='';window._k8sToggleKindPanels(${i},this.value)">
                                            <option value="Deployment"${effKind === 'Deployment' ? ' selected' : ''}>Deployment</option>
                                            <option value="StatefulSet"${effKind === 'StatefulSet' ? ' selected' : ''}>StatefulSet</option>
                                            <option value="DaemonSet"${effKind === 'DaemonSet' ? ' selected' : ''}>DaemonSet</option>
                                            <option value="Job"${effKind === 'Job' ? ' selected' : ''}>Job</option>
                                            <option value="CronJob"${effKind === 'CronJob' ? ' selected' : ''}>CronJob</option>
                                            <option value="Skip"${effKind === 'Skip' ? ' selected' : ''}>Skip</option>
                                        </select>
                                    </label>
                                    ${(!saved && svc._kindHint) ? `<div id="k8s-svc-kind-hint-${i}" style="font-size:0.62rem;color:var(--text-muted);padding:0 0.6rem 0.2rem;font-style:italic">${svc._kindHint}</div>` : `<div id="k8s-svc-kind-hint-${i}" style="font-size:0.62rem;color:var(--text-muted);padding:0 0.6rem 0.2rem;font-style:italic"></div>`}
                                    <!-- Skip banner (hidden by default) -->
                                    <div id="k8s-svc-skip-banner-${i}" style="display:none;padding:0.6rem;margin:0 0.6rem 0.5rem;background:var(--bg-primary);border-radius:6px;border:1px dashed var(--border-subtle);text-align:center">
                                        <div style="font-size:0.9rem;margin-bottom:0.15rem">â­ï¸</div>
                                        <div style="font-size:0.72rem;color:var(--text-muted);font-weight:600">Excluded</div>
                                        <div style="font-size:0.66rem;color:var(--text-muted);font-style:italic">This service will not be deployed to Kubernetes.</div>
                                    </div>
                                    <div id="k8s-svc-cfg-${i}" style="padding:0 0.6rem 0.5rem;display:${effKind === 'Skip' ? 'none' : 'block'}">`;
                                html += `
                                        <!-- â”€â”€â”€ Primary settings row (shared: image always visible) â”€â”€â”€ -->
                                        <div style="display:grid;grid-template-columns:3fr 1fr 1fr 1fr;gap:0.4rem;align-items:start">
                                            <div><span class="k8s-field-img">${_lbl('Container Image')}${_inp(`k8s-svc-img-${i}`, effImage, 'ghcr.io/user/app:latest')}</span></div>
                                            <div id="k8s-svc-port-wrap-${i}">${_lbl('Port')}${_num(`k8s-svc-port-${i}`, effPort)}</div>
                                            <div id="k8s-svc-replicas-wrap-${i}">${_lbl('Replicas')}${_num(`k8s-svc-replicas-${i}`, effReplicas)}</div>
                                            <div id="k8s-svc-svctype-wrap-${i}">${_lbl('Service Type')}${_sel(`k8s-svc-type-${i}`, [
                                                {v:'ClusterIP', l:'ClusterIP'},
                                                {v:'NodePort', l:'NodePort'},
                                                {v:'LoadBalancer', l:'LoadBalancer'}
                                            ], effSvcType)}</div>
                                        </div>

                                        <!-- â”€â”€ Deployment/StatefulSet/DaemonSet-only sections â”€â”€ -->
                                        <div id="k8s-svc-deploy-sections-${i}">
                                        <!-- â”€â”€â”€ Update Strategy â”€â”€â”€ -->
                                        <div style="display:flex;align-items:end;gap:0.4rem;margin-top:0.35rem;flex-wrap:wrap">
                                            <div style="min-width:140px">
                                                ${_lbl('Update Strategy')}
                                                <select id="k8s-svc-strategy-${i}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem;width:100%"
                                                    onchange="var r=document.getElementById('k8s-svc-rolling-${i}');var h=document.getElementById('k8s-svc-strat-hint-${i}');if(r)r.style.display=this.value==='RollingUpdate'?'flex':'none';if(h)h.style.display=this.value==='Recreate'?'block':'none'">
                                                    <option value="RollingUpdate"${effStrategy === 'RollingUpdate' ? ' selected' : ''}>RollingUpdate</option>
                                                    <option value="Recreate"${effStrategy === 'Recreate' ? ' selected' : ''}>Recreate</option>
                                                </select>
                                            </div>
                                            <div id="k8s-svc-rolling-${i}" style="display:${effStrategy === 'RollingUpdate' ? 'flex' : 'none'};align-items:end;gap:0.4rem">
                                                <div style="min-width:80px">
                                                    ${_lbl('Max Surge')}
                                                    ${_inp(`k8s-svc-maxsurge-${i}`, effMaxSurge, '1')}
                                                </div>
                                                <div style="min-width:80px">
                                                    ${_lbl('Max Unavailable')}
                                                    ${_inp(`k8s-svc-maxunavail-${i}`, effMaxUnavail, '1')}
                                                </div>
                                            </div>
                                            <div id="k8s-svc-strat-hint-${i}" style="display:${defaultStrategy === 'Recreate' ? 'block' : 'none'};font-size:0.62rem;color:var(--text-muted);font-style:italic;padding-bottom:0.1rem">
                                                ${hasNamedVols
                                                    ? 'ğŸ’¡ Recreate recommended â€” named volumes with ReadWriteOnce PVCs prevent two pods mounting simultaneously during rollout'
                                                    : 'ğŸ’¡ Kills all pods before creating new ones â€” causes brief downtime but avoids version conflicts'
                                                }
                                            </div>
                                        </div>
                                        </div><!-- end deploy-sections -->

                                        <!-- â”€â”€ Job/CronJob-only sections (hidden by default) â”€â”€ -->
                                        <div id="k8s-svc-job-sections-${i}" style="display:none">
                                            <div style="margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.68rem;color:var(--accent);font-weight:600;margin-bottom:0.3rem">âš¡ Job Configuration</div>
                                                <div style="display:grid;grid-template-columns:3fr 2fr 1fr;gap:0.4rem;align-items:start">
                                                    <div>${_lbl('Command')}${_inp(`k8s-svc-job-cmd-${i}`, '', '/bin/sh -c "â€¦"')}</div>
                                                    <div>${_lbl('Args (optional)')}${_inp(`k8s-svc-job-args-${i}`, '', 'arg1 arg2 â€¦')}</div>
                                                    <div>${_lbl('Restart Policy')}${_sel(`k8s-svc-job-restart-${i}`, [
                                                        {v:'Never', l:'Never'},
                                                        {v:'OnFailure', l:'OnFailure'},
                                                    ], 'Never')}</div>
                                                </div>
                                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.4rem;margin-top:0.3rem;align-items:start">
                                                    <div>${_lbl('Backoff Limit')}${_num(`k8s-svc-job-backoff-${i}`, 3)}</div>
                                                    <div>${_lbl('Completions')}${_num(`k8s-svc-job-completions-${i}`, 1)}</div>
                                                    <div>${_lbl('Parallelism')}${_num(`k8s-svc-job-parallelism-${i}`, 1)}</div>
                                                    <div>${_lbl('Timeout (s)')}${_num(`k8s-svc-job-timeout-${i}`, 600)}</div>
                                                </div>
                                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-top:0.3rem;align-items:start">
                                                    <div>${_lbl('TTL After Finished (s)')}${_num(`k8s-svc-job-ttl-${i}`, 3600)}</div>
                                                    <div style="font-size:0.6rem;color:var(--text-muted);font-style:italic;padding-top:1.2rem">TTL = auto-cleanup delay after completion</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- â”€â”€ CronJob-only sections (hidden by default) â”€â”€ -->
                                        <div id="k8s-svc-cron-sections-${i}" style="display:none">
                                            <div style="margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.68rem;color:var(--accent);font-weight:600;margin-bottom:0.3rem">â° CronJob Schedule</div>
                                                <div style="display:grid;grid-template-columns:2fr 2fr 1fr;gap:0.4rem;align-items:start">
                                                    <div>
                                                        ${_lbl('Schedule (cron)')}${_inp(`k8s-svc-cron-schedule-${i}`, '*/5 * * * *', '*/5 * * * *')}
                                                        <div id="k8s-svc-cron-preview-${i}" style="font-size:0.58rem;color:var(--text-muted);margin-top:2px">Every 5 minutes</div>
                                                    </div>
                                                    <div>${_lbl('Concurrency Policy')}${_sel(`k8s-svc-cron-concurrency-${i}`, [
                                                        {v:'Allow', l:'Allow (overlap OK)'},
                                                        {v:'Forbid', l:'Forbid (skip if running)'},
                                                        {v:'Replace', l:'Replace (kill + restart)'},
                                                    ], 'Forbid')}</div>
                                                    <div>
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer;margin-top:1rem">
                                                            <input type="checkbox" id="k8s-svc-cron-suspend-${i}" style="accent-color:var(--accent)"> Suspend
                                                        </label>
                                                    </div>
                                                </div>
                                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem;margin-top:0.3rem;align-items:start">
                                                    <div>${_lbl('Keep Successful')}${_num(`k8s-svc-cron-success-${i}`, 3)}</div>
                                                    <div>${_lbl('Keep Failed')}${_num(`k8s-svc-cron-failed-${i}`, 1)}</div>
                                                    <div>${_lbl('Deadline (s)')}${_num(`k8s-svc-cron-deadline-${i}`, 300)}</div>
                                                </div>
                                                <div style="font-size:0.58rem;color:var(--text-muted);font-style:italic;margin-top:2px">Deadline = skip this run if missed by this many seconds</div>
                                            </div>
                                        </div>

                                        <!-- â”€â”€ DaemonSet-only sections (hidden by default) â”€â”€ -->
                                        <div id="k8s-svc-daemon-sections-${i}" style="display:none">
                                            <div style="margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.68rem;color:var(--accent);font-weight:600;margin-bottom:0.3rem">ğŸŒ DaemonSet Configuration</div>

                                                <!-- Update Strategy -->
                                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;align-items:start">
                                                    <div>
                                                        ${_lbl('Update Strategy')}
                                                        <select id="k8s-svc-ds-strategy-${i}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem;width:100%"
                                                            onchange="var w=document.getElementById('k8s-svc-ds-maxunavail-wrap-${i}');if(w)w.style.display=this.value==='RollingUpdate'?'block':'none'">
                                                            <option value="RollingUpdate" selected>RollingUpdate</option>
                                                            <option value="OnDelete">OnDelete</option>
                                                        </select>
                                                    </div>
                                                    <div id="k8s-svc-ds-maxunavail-wrap-${i}">
                                                        ${_lbl('Max Unavailable')}
                                                        ${_inp(`k8s-svc-ds-maxunavail-${i}`, '1', '1')}
                                                    </div>
                                                </div>
                                                <div style="font-size:0.58rem;color:var(--text-muted);font-style:italic;margin-top:2px">OnDelete = manual pod-by-pod control (delete pod to trigger update)</div>

                                                <!-- Node Selection -->
                                                <div style="margin-top:0.4rem">
                                                    <div style="font-size:0.68rem;color:var(--text-muted);font-weight:600;margin-bottom:0.2rem">ğŸ¯ Node Selection</div>
                                                    <div>${_lbl('Node Selector')}</div>
                                                    ${_inp(`k8s-svc-ds-nodeselector-${i}`, '', 'key=value, key=value')}
                                                    <div style="font-size:0.56rem;color:var(--text-muted);font-style:italic;margin-top:1px">Leave empty to run on all nodes</div>
                                                </div>

                                                <!-- Tolerations -->
                                                <div style="margin-top:0.35rem">
                                                    <div style="font-size:0.68rem;color:var(--text-muted);font-weight:600;margin-bottom:0.2rem">ğŸ”“ Tolerations</div>
                                                    <div style="display:flex;flex-direction:column;gap:0.2rem">
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ds-tol-cp-${i}" style="accent-color:var(--accent)"> Run on control-plane nodes
                                                        </label>
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ds-tol-nosched-${i}" style="accent-color:var(--accent)"> Run on nodes with NoSchedule taints
                                                        </label>
                                                    </div>
                                                </div>

                                                <!-- Host Access -->
                                                <div style="margin-top:0.35rem">
                                                    <div style="font-size:0.68rem;color:var(--text-muted);font-weight:600;margin-bottom:0.2rem">ğŸ”Œ Host Access</div>
                                                    <div style="display:flex;flex-wrap:wrap;gap:0.4rem 1rem">
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ds-hostnet-${i}" style="accent-color:var(--accent)"> Host Network
                                                        </label>
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ds-hostpid-${i}" style="accent-color:var(--accent)"> Host PID
                                                        </label>
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ds-hostipc-${i}" style="accent-color:var(--accent)"> Host IPC
                                                        </label>
                                                    </div>
                                                    <div style="font-size:0.56rem;color:var(--text-muted);font-style:italic;margin-top:2px">Host access = pod shares the node's namespace (common for monitoring agents)</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- â”€â”€ StatefulSet-only sections (hidden by default) â”€â”€ -->
                                        <div id="k8s-svc-statefulset-sections-${i}" style="display:none">
                                            <div style="margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.68rem;color:var(--accent);font-weight:600;margin-bottom:0.3rem">ğŸ—„ï¸ StatefulSet Configuration</div>

                                                <!-- Headless Service + ClusterIP -->
                                                <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:0.4rem;align-items:start">
                                                    <div>
                                                        ${_lbl('Headless Service Name')}
                                                        ${_inp(`k8s-svc-ss-headless-${i}`, `${svc.name}-headless`, `${svc.name}-headless`)}
                                                    </div>
                                                    <div>
                                                        ${_lbl('Pod Management')}
                                                        ${_sel(`k8s-svc-ss-podmgmt-${i}`, [
                                                            {v:'OrderedReady', l:'OrderedReady'},
                                                            {v:'Parallel', l:'Parallel'},
                                                        ], 'OrderedReady')}
                                                    </div>
                                                    <div style="padding-top:1rem">
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ss-clusterip-${i}" style="accent-color:var(--accent)"> Also create ClusterIP
                                                        </label>
                                                    </div>
                                                </div>
                                                <div style="font-size:0.56rem;color:var(--text-muted);font-style:italic;margin-top:1px">Headless Service enables stable DNS: <code>${svc.name}-0.${svc.name}-headless</code></div>

                                                <!-- Update Strategy -->
                                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-top:0.35rem;align-items:start">
                                                    <div>
                                                        ${_lbl('Update Strategy')}
                                                        <select id="k8s-svc-ss-strategy-${i}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem;width:100%"
                                                            onchange="var w=document.getElementById('k8s-svc-ss-partition-wrap-${i}');if(w)w.style.display=this.value==='RollingUpdate'?'block':'none'">
                                                            <option value="RollingUpdate" selected>RollingUpdate</option>
                                                            <option value="OnDelete">OnDelete</option>
                                                        </select>
                                                    </div>
                                                    <div id="k8s-svc-ss-partition-wrap-${i}">
                                                        ${_lbl('Partition')}
                                                        ${_num(`k8s-svc-ss-partition-${i}`, 0)}
                                                        <div style="font-size:0.54rem;color:var(--text-muted);font-style:italic">Ordinal â‰¥ partition gets updated; lower ordinals stay on old version</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- volumeClaimTemplates section -->
                                            <div style="margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.68rem;color:var(--accent);font-weight:600;margin-bottom:0.3rem;display:flex;align-items:center;gap:0.3rem">
                                                    ğŸ’¾ Persistent Storage (volumeClaimTemplates)
                                                    ${volCount > 0 ? `<span style="font-size:0.6rem;background:var(--bg-secondary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">${volCount} from Compose</span>` : ''}
                                                </div>
                                                <div style="font-size:0.56rem;color:var(--text-muted);font-style:italic;margin-bottom:0.3rem">Each pod gets its own PVC: <code>data-${svc.name}-0</code>, <code>data-${svc.name}-1</code>, â€¦</div>

                                                <div id="k8s-svc-vct-list-${i}" style="display:flex;flex-direction:column;gap:0.3rem">
                                                    ${(() => {
                                                        const vols = svc.volumes || [];
                                                        const namedVols = vols.map(v => window._classifyVolume(v)).filter(cl => cl.classification === 'named');
                                                        if (namedVols.length === 0) return '<div style="font-size:0.68rem;color:var(--text-muted);font-style:italic">No named volumes detected â€” click "+ Add volume claim template" below</div>';
                                                        return namedVols.map((cl, j) => {
                                                            return `<div class="k8s-vct-row" style="padding:0.3rem;border:1px solid var(--border-subtle);border-radius:4px;background:var(--bg-secondary)">
                                                                <div style="display:grid;grid-template-columns:auto 1fr 2fr 1fr 1fr 1fr;gap:0.3rem;align-items:center;font-size:0.72rem">
                                                                    <label><input type="checkbox" id="k8s-svc-vct-chk-${i}-${j}" checked style="accent-color:var(--accent)"></label>
                                                                    <div>${_lbl('Name')}${_inp(`k8s-svc-vct-name-${i}-${j}`, cl.name, 'data')}</div>
                                                                    <div>${_lbl('Mount Path')}${_inp(`k8s-svc-vct-mount-${i}-${j}`, cl.mountPath, '/var/lib/data')}</div>
                                                                    <div>${_lbl('Size')}${_inp(`k8s-svc-vct-size-${i}-${j}`, '10Gi', '10Gi')}</div>
                                                                    <div>${_lbl('Access Mode')}${_sel(`k8s-svc-vct-access-${i}-${j}`, [
                                                                        {v:'ReadWriteOnce', l:'RWO'},
                                                                        {v:'ReadWriteMany', l:'RWX'},
                                                                        {v:'ReadOnlyMany', l:'ROX'},
                                                                    ], 'ReadWriteOnce')}</div>
                                                                    <div>${_lbl('StorageClass')}${_inp(`k8s-svc-vct-sc-${i}-${j}`, '', 'longhorn')}</div>
                                                                </div>
                                                            </div>`;
                                                        }).join('');
                                                    })()}
                                                </div>
                                                <button type="button" style="margin-top:0.3rem;font-size:0.68rem;padding:0.15rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--accent)"
                                                    onclick="window._k8sAddVCT(${i})">+ Add volume claim template</button>
                                            </div>
                                        </div>

                                        <!-- â”€â”€â”€ 1. Resource Limits â”€â”€â”€ -->
                                        <details style="margin-top:0.4rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                â–¸ Resource Limits
                                                ${hasComposeRes ? '<span style="font-size:0.6rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">from Compose</span>' : ''}
                                                <span id="k8s-svc-qos-${i}" style="margin-left:auto">${_qosHint(compCpuReq, compCpuLim, compMemReq, compMemLim)}</span>
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="display:grid;grid-template-columns:auto 1fr 1fr;gap:0.3rem 0.5rem;align-items:center;font-size:0.74rem">
                                                    <!-- Header row -->
                                                    <div></div>
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.66rem;text-transform:uppercase;letter-spacing:0.04em">Request <span style="font-size:0.58rem;opacity:0.7">(guaranteed minimum)</span></div>
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.66rem;text-transform:uppercase;letter-spacing:0.04em">Limit <span style="font-size:0.58rem;opacity:0.7">(hard ceiling)</span></div>
                                                    <!-- CPU row -->
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.72rem">CPU</div>
                                                    <div>${_inp(`k8s-svc-cpu-req-${i}`, effCpuReq, '100m')}</div>
                                                    <div>${_inp(`k8s-svc-cpu-lim-${i}`, effCpuLim, '500m')}</div>
                                                    <!-- Memory row -->
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.72rem">Memory</div>
                                                    <div>${_inp(`k8s-svc-mem-req-${i}`, effMemReq, '128Mi')}</div>
                                                    <div>${_inp(`k8s-svc-mem-lim-${i}`, effMemLim, '256Mi')}</div>
                                                </div>
                                                <!-- Live QoS class + guidance -->
                                                <div style="display:flex;align-items:center;gap:0.5rem;margin-top:0.35rem;padding-top:0.3rem;border-top:1px solid var(--border-subtle)">
                                                    <span style="font-size:0.66rem;color:var(--text-muted)">QoS class â†’</span>
                                                    <span id="k8s-svc-qos-live-${i}">${_qosHint(effCpuReq, effCpuLim, effMemReq, effMemLim)}</span>
                                                    <span style="flex:1"></span>
                                                    <span style="font-size:0.6rem;color:var(--text-muted);font-style:italic">Empty = omit from manifest (K8s node defaults apply)</span>
                                                </div>
                                            </div>
                                        </details>

                                        <!-- â”€â”€â”€ 2. Health Checks (hidden for Job/CronJob) â”€â”€â”€ -->
                                        <div id="k8s-svc-probes-wrap-${i}">
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                â–¸ Health Checks
                                                ${hc ? '<span style="font-size:0.6rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">from Compose</span>' : ''}
                                                <span style="margin-left:auto;font-size:0.6rem;color:var(--text-muted)">recommended</span>
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                ${(() => {
                                                    const parsed = _parseComposeProbe(hc, portVal);
                                                    const prd = _parseDur(hc && hc.interval);
                                                    const pto = _parseDur(hc && hc.timeout);
                                                    const pret = hc && hc.retries ? parseInt(hc.retries) : null;
                                                    // Readiness defaults: fast startup, frequent checks
                                                    const rdy = _probeBlock(
                                                        `k8s-svc-rdy-${i}`, 'Readiness Probe',
                                                        parsed.type, parsed.path, parsed.port, parsed.command,
                                                        5, prd || 5, pto || 3, 'Timeout (s)'
                                                    );
                                                    // Liveness defaults: slower startup tolerance, less frequent
                                                    const liv = _probeBlock(
                                                        `k8s-svc-liv-${i}`, 'Liveness Probe',
                                                        parsed.type, parsed.path, parsed.port, parsed.command,
                                                        10, prd || 15, pret || 3, 'Failures'
                                                    );
                                                    return rdy + `<div style="border-top:1px solid var(--border-subtle);margin:0.15rem 0"></div>` + liv;
                                                })()}
                                                ${hc ? `<div style="font-size:0.62rem;color:var(--text-muted);border-top:1px solid var(--border-subtle);padding-top:0.25rem;margin-top:0.2rem">
                                                    ğŸ’¡ Parsed from: <code style="font-size:0.6rem;background:var(--bg-inset);padding:1px 4px;border-radius:3px">${esc(typeof hc.test === 'string' ? hc.test : Array.isArray(hc.test) ? hc.test.join(' ') : String(hc.test))}</code>
                                                </div>` : `<div style="font-size:0.62rem;color:var(--text-muted);font-style:italic;margin-top:0.15rem">
                                                    ğŸ’¡ No compose healthcheck â€” defaults pre-filled. Uncheck to omit probes.
                                                </div>`}
                                            </div>
                                        </details>
                                        </div>

                                        <!-- â”€â”€â”€ 3. Environment Variables â”€â”€â”€ -->
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                â–¸ Environment Variables
                                                ${envKeys.length > 0 ? `<span style="font-size:0.72rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">${envKeys.length} from Compose</span>` : ''}
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                ${isMultiEnv ? `<div style="font-size:0.78rem;color:var(--warning);background:color-mix(in srgb, var(--warning) 8%, transparent);padding:0.3rem 0.4rem;border-radius:4px;margin-bottom:0.35rem;display:flex;align-items:center;gap:0.3rem">
                                                    <span>ğŸ“Œ</span>
                                                    <span>Multi-env project: values shown are defaults. Use <strong>Variable | Secret</strong> for values that differ across environments.</span>
                                                </div>` : ''}
                                                ${envKeys.length > 0 ? `<div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;margin-bottom:0.2rem;padding:0 0.25rem">
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Key</span>
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Value</span>
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Var / Secret</span>
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Injection</span>
                                                    <span></span>
                                                </div>` : ''}
                                                <div id="k8s-svc-env-list-${i}" style="display:flex;flex-direction:column;gap:0.2rem">
                                                    ${(() => {
                                                        // Use saved env vars when available, otherwise compose detection
                                                        if (saved?.envVars) {
                                                            return saved.envVars.map((ev, j) => {
                                                                return _envRowHtml(i, j, ev.key, ev.value || '', ev.type || 'hardcoded', ev.varName || '', i);
                                                            }).join('');
                                                        }
                                                        return Object.entries(envVals).map(([k, v], j) => {
                                                            const injType = _defaultInjType(k);
                                                            return _envRowHtml(i, j, k, v || '', injType, injType !== 'hardcoded' ? '${' + k + '}' : '', i);
                                                        }).join('');
                                                    })()}
                                                </div>
                                                <button type="button" onclick="_addEnvVar(${i})"
                                                    style="margin-top:0.3rem;font-size:0.66rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.2rem 0.5rem;cursor:pointer;width:100%">
                                                    + Add variable
                                                </button>
                                                <div id="k8s-svc-env-summary-${i}" style="font-size:0.6rem;color:var(--text-muted);margin-top:0.25rem;padding-top:0.2rem;border-top:1px solid var(--border-subtle)">
                                                    ${(() => {
                                                        const envList = saved?.envVars || envKeys.map(k => ({key: k, type: _defaultInjType(k)}));
                                                        let hc = 0, vr = 0, sc = 0;
                                                        for (const ev of envList) {
                                                            const t = ev.type || 'hardcoded';
                                                            if (t === 'secret') sc++;
                                                            else if (t === 'variable') vr++;
                                                            else hc++;
                                                        }
                                                        const dlr = '$';
                                                        const parts = [];
                                                        if (hc + vr > 0) parts.push('ğŸ“‹ ConfigMap: ' + hc + ' hardcoded' + (vr > 0 ? ', ' + vr + ' ' + dlr + '{VAR}' : ''));
                                                        if (sc > 0) parts.push('ğŸ”’ Secret: ' + sc + ' key' + (sc !== 1 ? 's' : '') + ' (' + dlr + '{VAR} at deploy)');
                                                        if (parts.length === 0) parts.push('No environment variables configured');
                                                        return parts.join(' &middot; ');
                                                    })()}
                                                </div>
                                            </div>
                                        </details>

                                        <!-- â”€â”€â”€ 4. Volume Mounts (hidden for Job/CronJob) â”€â”€â”€ -->
                                        <div id="k8s-svc-vols-wrap-${i}">
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                â–¸ Volume Mounts
                                                ${volCount > 0 ? `<span style="font-size:0.6rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">${volCount} from Compose</span>` : ''}
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.45rem 0.5rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">


                                                <div style="font-size:0.68rem;color:var(--text-muted);font-weight:600;margin-bottom:0.25rem;display:flex;align-items:center;gap:0.3rem">
                                                    Volumes
                                                    <span id="k8s-svc-vol-summary-${i}" style="font-size:0.6rem;font-weight:400;color:var(--text-muted)"></span>
                                                </div>
                                                <!-- Volume rows container -->
                                                <div id="k8s-svc-vol-list-${i}" style="display:flex;flex-direction:column;gap:0.35rem">
                                                    ${(() => {
                                                        // Use saved volumes when available, otherwise compose detection
                                                        if (saved?.volumes) {
                                                            if (saved.volumes.length === 0) return '<div style="font-size:0.68rem;color:var(--text-muted);font-style:italic">No volumes configured â€” click \'+ Add volume\' below</div>';
                                                            return saved.volumes.map((vol, j) => {
                                                                const cl = window._savedVolToClassification(vol);
                                                                return window._volRowHtml(i, j, cl);
                                                            }).join('');
                                                        }
                                                        const vols = svc.volumes || [];
                                                        if (vols.length === 0) return '<div style="font-size:0.68rem;color:var(--text-muted);font-style:italic">No volumes detected â€” click "+ Add volume" below</div>';
                                                        return vols.map((v, j) => {
                                                            const cl = window._classifyVolume(v);
                                                            return window._volRowHtml(i, j, cl);
                                                        }).join('');
                                                    })()}
                                                </div>
                                                <button type="button" onclick="window._addVolRow(${i})"
                                                    style="margin-top:0.35rem;font-size:0.68rem;color:var(--accent);background:none;border:1px dashed var(--border);border-radius:4px;padding:4px 10px;cursor:pointer;width:100%"
                                                    onmouseover="this.style.background='rgba(99,102,241,0.06)'" onmouseout="this.style.background='none'">
                                                    + Add volume
                                                </button>
                                            </div>
                                        </details>
                                        </div>

                                        <!-- â”€â”€â”€ 5. Dependencies (hidden for Job/CronJob) â”€â”€â”€ -->
                                        <div id="k8s-svc-deps-wrap-${i}">
                                        <div style="margin-top:0.3rem;padding:0.2rem 0">
                                            <span style="font-size:0.68rem;color:var(--text-muted);font-weight:600">Depends on</span>
                                            <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-top:0.15rem">
                                                ${infraSvcs.length > 0 ? infraSvcs.map(inf => {
                                                    const savedDeps = saved?.dependencies || svc.depends_on || [];
                                                    const checked = savedDeps.includes(inf.name) ? ' checked' : '';
                                                    return `<label style="display:inline-flex;align-items:center;gap:0.2rem;font-size:0.7rem;cursor:pointer">
                                                        <input type="checkbox" class="k8s-dep-${i}" value="${esc(inf.name)}" style="accent-color:var(--accent)"${checked} onchange="window._refreshEnvSelects(${i})"> ${esc(inf.name)}
                                                    </label>`;
                                                }).join('') : '<span style="font-size:0.7rem;color:var(--text-muted)">â€”</span>'}
                                            </div>
                                        </div>
                                        </div>

                                        <!-- â”€â”€â”€ 7. Init Containers (hidden for Job/CronJob) â”€â”€â”€ -->
                                        <div id="k8s-svc-init-wrap-${i}">
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                â–¸ Init Containers
                                                <span id="k8s-svc-init-count-${i}" style="font-size:0.68rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">0</span>
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.45rem 0.5rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.72rem;color:var(--text-muted);font-style:italic;margin-bottom:0.25rem">Init containers run to completion before the main container starts â€” useful for DB migrations, permission fixes, or waiting for dependencies.</div>

                                                <!-- Presets -->
                                                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.3rem">
                                                    <button type="button" class="k8s-init-preset" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddInitPreset(${i},'wait-tcp')">â³ Wait for TCP</button>
                                                    <button type="button" class="k8s-init-preset" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddInitPreset(${i},'wait-http')">ğŸŒ Wait for HTTP</button>
                                                    <button type="button" class="k8s-init-preset" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddInitPreset(${i},'migrations')">ğŸ”„ Run migrations</button>
                                                    <button type="button" class="k8s-init-preset" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddInitPreset(${i},'fix-perms')">ğŸ”§ Fix permissions</button>
                                                    <button type="button" class="k8s-init-preset" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddInitPreset(${i},'custom')">ğŸ“ Custom</button>
                                                </div>

                                                <!-- Init container rows -->
                                                <div id="k8s-svc-init-list-${i}" style="display:flex;flex-direction:column;gap:0.3rem"></div>
                                            </div>
                                        </details>
                                        </div>

                                        <!-- â”€â”€â”€ 8. Sidecar Containers â”€â”€â”€ -->
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                â–¸ Sidecar Containers
                                                <span id="k8s-svc-sc-count-${i}" style="font-size:0.68rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">0</span>
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.45rem 0.5rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.72rem;color:var(--text-muted);font-style:italic;margin-bottom:0.25rem">Sidecar containers run alongside the main container â€” for log forwarding, auth proxies, metrics exporters, etc.</div>

                                                <!-- Presets -->
                                                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.3rem">
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'log-fwd')">ğŸ“‹ Log forwarder</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'cfg-reload')">ğŸ”„ Config reloader</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'metrics')">ğŸ“Š Metrics exporter</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'auth-proxy')">ğŸ” Auth proxy</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'cloudsql')">â˜ï¸ Cloud SQL Proxy</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'vault')">ğŸ”’ Vault agent</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'custom')">ğŸ“ Custom</button>
                                                </div>

                                                <!-- Sidecar rows -->
                                                <div id="k8s-svc-sc-list-${i}" style="display:flex;flex-direction:column;gap:0.3rem"></div>
                                            </div>
                                        </details>

                                        <!-- â”€â”€â”€ 9. Service Mesh â”€â”€â”€ -->
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                â–¸ Service Mesh
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.45rem 0.5rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.3rem">
                                                    <label style="display:inline-flex;align-items:center;gap:0.25rem;cursor:pointer;font-size:0.78rem;color:var(--text-secondary)">
                                                        <input type="checkbox" id="k8s-svc-mesh-enable-${i}" style="accent-color:var(--accent)"
                                                            onchange="document.getElementById('k8s-svc-mesh-cfg-'+${i}).style.display=this.checked?'block':'none'"> Enable sidecar injection
                                                    </label>
                                                    <select id="k8s-svc-mesh-provider-${i}" class="modal-form-select"
                                                        style="font-size:0.74rem;padding:0.15rem 0.3rem;min-width:90px;color:var(--success);font-weight:600;border-color:transparent;background:transparent">
                                                        <option value="istio" selected>Istio</option>
                                                        <option value="linkerd">Linkerd</option>
                                                        <option value="consul">Consul</option>
                                                        <option value="kuma">Kuma</option>
                                                    </select>
                                                </div>

                                                <!-- Mesh config (shown when enabled) -->
                                                <div id="k8s-svc-mesh-cfg-${i}" style="display:none">
                                                    <div style="padding:0.3rem 0.5rem;background:var(--bg-inset);border-radius:4px;border-left:3px solid var(--accent);margin-bottom:0.3rem;font-size:0.74rem;color:var(--text-muted)">
                                                        â„¹ï¸ The mesh proxy is injected by the cluster, not defined in your manifest. Only annotations are added.
                                                    </div>

                                                    <!-- Job/CronJob warning -->
                                                    <div id="k8s-svc-mesh-warn-${i}" style="display:none;padding:0.3rem 0.5rem;background:color-mix(in srgb, var(--warning) 10%, transparent);border-radius:4px;margin-bottom:0.3rem;font-size:0.74rem;color:var(--warning)">
                                                        âš ï¸ Job/CronJob + service mesh requires K8s â‰¥ 1.28 native sidecars for the proxy to terminate with the job.
                                                    </div>

                                                    <div style="font-size:0.78rem;color:var(--text-muted);font-weight:600;margin-bottom:0.2rem">Proxy Resources</div>
                                                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.3rem;font-size:0.72rem">
                                                        <div>${_lbl('CPU Request')}<input type="text" id="k8s-svc-mesh-cpureq-${i}" class="modal-form-input" value="100m" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                        <div>${_lbl('CPU Limit')}<input type="text" id="k8s-svc-mesh-cpulim-${i}" class="modal-form-input" value="500m" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                        <div>${_lbl('Mem Request')}<input type="text" id="k8s-svc-mesh-memreq-${i}" class="modal-form-input" value="128Mi" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                        <div>${_lbl('Mem Limit')}<input type="text" id="k8s-svc-mesh-memlim-${i}" class="modal-form-input" value="256Mi" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                    </div>

                                                    <!-- Advanced -->
                                                    <details style="margin-top:0.25rem">
                                                        <summary style="cursor:pointer;font-size:0.74rem;color:var(--text-muted);user-select:none">â–¸ Advanced</summary>
                                                        <div style="margin-top:0.2rem;display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.3rem;font-size:0.72rem">
                                                            <div>${_lbl('Exclude inbound ports')}<input type="text" id="k8s-svc-mesh-exin-${i}" class="modal-form-input" placeholder="e.g. 8080,9090" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                            <div>${_lbl('Exclude outbound ports')}<input type="text" id="k8s-svc-mesh-exout-${i}" class="modal-form-input" placeholder="e.g. 3306" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                            <div>${_lbl('Log level')}<select id="k8s-svc-mesh-log-${i}" class="modal-form-select" style="font-size:0.78rem;padding:0.18rem 0.3rem">
                                                                <option value="warning" selected>warning</option>
                                                                <option value="info">info</option>
                                                                <option value="debug">debug</option>
                                                                <option value="error">error</option>
                                                            </select></div>
                                                        </div>
                                                    </details>
                                                </div>
                                            </div>
                                        </details>

                                        <!-- â”€â”€â”€ 6. Companion Containers (from "Move into pod") â”€â”€â”€ -->
                                        <div id="k8s-svc-companions-${i}" style="display:none;margin-top:0.35rem;padding:0.4rem;background:color-mix(in srgb, var(--accent) 4%, transparent);border-radius:6px;border:1px dashed var(--border-subtle)">
                                            <div style="font-size:0.74rem;color:var(--accent);font-weight:600;margin-bottom:0.2rem">ğŸ“¦ Companion Containers (same pod)</div>
                                            <div id="k8s-svc-companion-list-${i}" style="display:flex;flex-direction:column;gap:0.2rem"></div>
                                        </div>

                                        <!-- â”€â”€â”€ Move into pod action â”€â”€â”€ -->
                                        <div style="margin-top:0.25rem;text-align:right">
                                            <select id="k8s-svc-moveto-${i}" class="modal-form-select"
                                                style="font-size:0.76rem;padding:0.2rem 0.4rem;min-width:180px;color:var(--accent);border-color:var(--border-subtle)"
                                                onchange="if(this.value){window._k8sMoveIntoPod(${i},parseInt(this.value));this.value=''}"
                                            >
                                                <option value="">â¤µ Move into another podâ€¦</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>`;
                            }
                            html += `</div>`;

                        } else if (deployableModules.length > 0) {
                            // No Compose â€” show module-based cards
                            html += wizSection('Application Deployments',
                                `${deployableModules.length} module${deployableModules.length !== 1 ? 's' : ''} detected. Select which to deploy.`);

                            html += `<div style="display:flex;flex-direction:column;gap:0.5rem" id="k8s-app-svc-list">`;
                            for (let i = 0; i < deployableModules.length; i++) {
                                const m = deployableModules[i];
                                const imgStr = ghRepo.owner
                                    ? `ghcr.io/${ghRepo.owner}/${ghRepo.name}-${m.name}:latest`
                                    : `${m.name}:latest`;
                                html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);overflow:hidden" id="k8s-svc-card-${i}">
                                    <label style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.6rem;cursor:pointer;font-size:0.82rem"
                                        onmouseover="this.parentElement.style.borderColor='var(--accent)'" onmouseout="this.parentElement.style.borderColor='var(--border-subtle)'">
                                        <input type="checkbox" id="k8s-svc-chk-${i}" ${i === 0 ? 'checked' : ''} style="accent-color:var(--accent)"
                                            onchange="document.getElementById('k8s-svc-cfg-${i}').style.display=this.checked?'block':'none'">
                                        <span style="font-size:1rem" id="k8s-svc-icon-${i}">ğŸš€</span>
                                        <strong>${esc(m.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(m.stack || '?')}</code>
                                        <span style="flex:1;color:var(--text-muted);font-size:0.72rem">${esc(m.path || '')}</span>
                                        <select id="k8s-svc-kind-${i}" class="modal-form-select"
                                            style="font-size:0.68rem;padding:0.1rem 0.3rem;min-width:110px;color:var(--success);font-weight:600;border-color:transparent;background:transparent"
                                            onclick="event.stopPropagation()" onmousedown="event.stopPropagation()"
                                            onchange="var ic=document.getElementById('k8s-svc-icon-'+${i});if(ic)ic.textContent={'Deployment':'ğŸš€','StatefulSet':'ğŸ—„ï¸','DaemonSet':'ğŸŒ','Job':'âš¡','CronJob':'â°','Skip':'â­ï¸'}[this.value]||'ğŸ“¦';window._k8sToggleKindPanels(${i},this.value)">
                                            <option value="Deployment" selected>Deployment</option>
                                            <option value="StatefulSet">StatefulSet</option>
                                            <option value="DaemonSet">DaemonSet</option>
                                            <option value="Job">Job</option>
                                            <option value="CronJob">CronJob</option>
                                            <option value="Skip">Skip</option>
                                        </select>
                                    </label>
                                    <div id="k8s-svc-cfg-${i}" style="padding:0 0.6rem 0.5rem;display:${i === 0 ? 'block' : 'none'}">
                                        <div style="display:grid;grid-template-columns:3fr 1fr 1fr 1fr;gap:0.4rem;align-items:start">
                                            <div>${_lbl('Container Image')}${_inp(`k8s-svc-img-${i}`, imgStr, 'ghcr.io/user/app:latest')}</div>
                                            <div>${_lbl('Port')}${_num(`k8s-svc-port-${i}`, 8080)}</div>
                                            <div>${_lbl('Replicas')}${_num(`k8s-svc-replicas-${i}`, 2)}</div>
                                            <div>${_lbl('Service Type')}${_sel(`k8s-svc-type-${i}`, [
                                                {v:'ClusterIP', l:'ClusterIP'},
                                                {v:'NodePort', l:'NodePort'},
                                                {v:'LoadBalancer', l:'LoadBalancer'}
                                            ], 'ClusterIP')}</div>
                                        </div>

                                        <!-- â”€â”€â”€ Companion Containers â”€â”€â”€ -->
                                        <div id="k8s-svc-companions-${i}" style="display:none;margin-top:0.35rem;padding:0.4rem;background:color-mix(in srgb, var(--accent) 4%, transparent);border-radius:6px;border:1px dashed var(--border-subtle)">
                                            <div style="font-size:0.74rem;color:var(--accent);font-weight:600;margin-bottom:0.2rem">ğŸ“¦ Companion Containers (same pod)</div>
                                            <div id="k8s-svc-companion-list-${i}" style="display:flex;flex-direction:column;gap:0.2rem"></div>
                                        </div>

                                        <!-- â”€â”€â”€ Move into pod action â”€â”€â”€ -->
                                        <div style="margin-top:0.25rem;text-align:right">
                                            <select id="k8s-svc-moveto-${i}" class="modal-form-select"
                                                style="font-size:0.76rem;padding:0.2rem 0.4rem;min-width:180px;color:var(--accent);border-color:var(--border-subtle)"
                                                onchange="if(this.value){window._k8sMoveIntoPod(${i},parseInt(this.value));this.value=''}"
                                            >
                                                <option value="">â¤µ Move into another podâ€¦</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>`;
                            }
                            html += `</div>`;

                        } else {
                            // No compose, no modules â€” single manual app config
                            html += wizSection('Deployment Configuration', 'Configure your application for Kubernetes.');
                            html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);padding:0.6rem">
                                <div style="display:grid;grid-template-columns:1fr 3fr;gap:0.4rem;align-items:start">
                                    <div>${_lbl('App Name')}${_inp('k8s-svc-name-manual', appName, 'my-app')}</div>
                                    <div>${_lbl('Container Image')}${_inp('k8s-svc-img-manual', `${appName}:latest`, 'ghcr.io/user/app:latest')}</div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr 2fr;gap:0.4rem;margin-top:0.3rem;align-items:start">
                                    <div>${_lbl('Port')}${_num('k8s-svc-port-manual', 8080)}</div>
                                    <div>${_lbl('Replicas')}${_num('k8s-svc-replicas-manual', 2)}</div>
                                    <div>${_lbl('Service Type')}${_sel('k8s-svc-type-manual', [
                                        {v:'ClusterIP', l:'ClusterIP (internal)'},
                                        {v:'NodePort', l:'NodePort (node access)'},
                                        {v:'LoadBalancer', l:'LoadBalancer (external)'}
                                    ], 'ClusterIP')}</div>
                                </div>
                            </div>`;
                        }

                        // â”€â”€ Infra card HTML generator â”€â”€
                        // Generates a complete infra service card from a service data object.
                        // Used by both initial render and dynamic add.
                        // Defined before Section B so it's available during html string construction.
                        window._k8sInfraCardHtml = (svc, savedInfra) => {
                            const svcName = svc.name;
                            const infraId = 'infra-' + svcName;
                            const imgShort = (svc.image || '').split('/').pop().split(':')[0] || svcName;
                            const portStr = (svc.ports || []).map(p => ':' + p.container).join(' ');
                            const volCount = (svc.volumes || []).length;
                            const infraEnvKeys = Object.keys(svc.environment || {});
                            const infraEnvVals = svc.environment || {};
                            const eName = esc(svcName);
                            // Saved kind overrides detection default
                            const infraKindDefault = savedInfra?.kind || _classifyWorkloadKind(svc);
                            const infraKindHintText = _kindHint(infraKindDefault, svc);

                            let h = '<div data-infra-name="' + eName + '" style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);padding:0.5rem 0.6rem">'
                                + '<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;margin-bottom:0.3rem">'
                                + '<span style="font-size:1rem" id="k8s-infra-icon-' + eName + '">' + _kindIcon(infraKindDefault) + '</span>'
                                + '<strong>' + eName + '</strong>'
                                + '<code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">' + esc(imgShort) + '</code>'
                                + (portStr ? '<code style="font-size:0.68rem;color:var(--text-muted)">' + esc(portStr) + '</code>' : '')
                                + (volCount > 0 ? '<span style="font-size:0.66rem;color:var(--text-muted)" title="' + volCount + ' volumes">ğŸ’¾' + volCount + '</span>' : '')
                                + '<span style="flex:1"></span>'
                                + '<button type="button" onclick="window._k8sRemoveInfra(\'' + eName + '\')"'
                                + ' style="background:none;border:none;cursor:pointer;font-size:0.88rem;color:var(--text-muted);padding:0 4px;line-height:1"'
                                + ' title="Remove ' + eName + '">âœ•</button>'
                                + '</div>'
                                + '<div style="display:flex;align-items:center;gap:0.4rem;font-size:0.74rem;margin-bottom:0.15rem">'
                                + '<select id="k8s-infra-kind-' + eName + '" class="modal-form-select"'
                                + ' style="font-size:0.68rem;padding:0.1rem 0.3rem;min-width:130px;color:var(--success);font-weight:600"'
                                + ' onchange="'
                                +   'var ic=document.getElementById(\'k8s-infra-icon-' + eName + '\');'
                                +   'var hn=document.getElementById(\'k8s-infra-kind-hint-' + eName + '\');'
                                +   'var cfg=document.getElementById(\'k8s-infra-cfg-' + eName + '\');'
                                +   'var sb=document.getElementById(\'k8s-infra-skip-banner-' + eName + '\');'
                                +   'var mi=document.getElementById(\'k8s-infra-managed-info-' + eName + '\');'
                                +   'var el=document.getElementById(\'k8s-infra-envlabel-' + eName + '\');'
                                +   'var vs=document.getElementById(\'k8s-infra-vol-section-' + eName + '\');'
                                +   'var kv=this.value;'
                                +   'if(ic)ic.textContent=({"Deployment":"ğŸš€","StatefulSet":"ğŸ—„ï¸","DaemonSet":"ğŸŒ","Managed":"â˜ï¸","Skip":"â­ï¸"})[kv]||"ğŸ“¦";'
                                +   'if(hn)hn.textContent=\'\';'
                                +   'if(cfg)cfg.style.display=(kv===\'Skip\'?\'none\':\'block\');'
                                +   'if(sb)sb.style.display=(kv===\'Skip\'?\'block\':\'none\');'
                                +   'if(mi)mi.style.display=(kv===\'Managed\'?\'block\':\'none\');'
                                +   'if(vs)vs.style.display=(kv===\'Managed\'||kv===\'Skip\'?\'none\':\'block\');'
                                +   'if(el)el.textContent=(kv===\'Managed\'?\'Connection Environment Variables\':\'Environment Variables\');'
                                +   'if(kv!==\'Skip\')window._k8sInfraEnvTrigger(\'' + eName + '\');'
                                + '">'
                                + '<option value="StatefulSet"' + (infraKindDefault === 'StatefulSet' ? ' selected' : '') + '>StatefulSet</option>'
                                + '<option value="Deployment"' + (infraKindDefault === 'Deployment' ? ' selected' : '') + '>Deployment</option>'
                                + '<option value="DaemonSet"' + (infraKindDefault === 'DaemonSet' ? ' selected' : '') + '>DaemonSet</option>'
                                + '<option value="Managed"' + (infraKindDefault === 'Managed' ? ' selected' : '') + '>Managed (external)</option>'
                                + '<option value="Skip"' + (infraKindDefault === 'Skip' ? ' selected' : '') + '>Skip (exclude)</option>'
                                + '</select>'
                                + '<span id="k8s-infra-kind-hint-' + eName + '" style="font-size:0.6rem;color:var(--text-muted);font-style:italic">' + (infraKindHintText || '') + '</span>'
                                + '</div>';

                            // Infra config panel (env vars) â€” shown when kind is NOT Skip
                            const infraCfgDisplay = infraKindDefault === 'Skip' ? 'none' : 'block';
                            const isInfraManaged = infraKindDefault === 'Managed';

                            // Skip banner for infra services
                            h += '<div id="k8s-infra-skip-banner-' + eName + '" style="display:' + (infraKindDefault === 'Skip' ? 'block' : 'none') + ';padding:0.6rem;margin-top:0.35rem;background:var(--bg-primary);border-radius:6px;border:1px dashed var(--border-subtle);text-align:center">'
                                + '<div style="font-size:0.9rem;margin-bottom:0.15rem">â­ï¸</div>'
                                + '<div style="font-size:0.72rem;color:var(--text-muted);font-weight:600">Excluded</div>'
                                + '<div style="font-size:0.66rem;color:var(--text-muted);font-style:italic">This service will not be deployed to Kubernetes.</div>'
                                + '</div>';

                            h += '<div id="k8s-infra-cfg-' + eName + '" style="display:' + infraCfgDisplay + ';margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">';

                            // Managed-specific info banner + provider notes
                            h += '<div id="k8s-infra-managed-info-' + eName + '" style="display:' + (isInfraManaged ? 'block' : 'none') + ';margin-bottom:0.4rem">'
                                + '<div style="padding:0.35rem 0.5rem;background:var(--bg-inset);border-radius:4px;border-left:3px solid var(--accent);margin-bottom:0.3rem">'
                                + '<div style="font-size:0.72rem;color:var(--accent)">â„¹ï¸ This service will be managed <strong>outside</strong> Kubernetes.</div>'
                                + '<div style="font-size:0.64rem;color:var(--text-muted)">No K8s resources will be generated. Connection vars below will be injected into dependent services as Secrets.</div>'
                                + '</div>'
                                + '<div style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem">'
                                + '<span style="font-size:0.68rem;color:var(--text-muted);font-weight:600">Provider / Notes</span>'
                                + '</div>'
                                + '<input type="text" id="k8s-infra-provider-' + eName + '" class="modal-form-input"'
                                + ' style="font-size:0.72rem;padding:0.2rem 0.4rem;width:100%"'
                                + ' placeholder="e.g. AWS RDS PostgreSQL, GCP Cloud SQL, etc.">'
                                + '</div>';

                            h += '<div style="font-size:0.72rem;color:var(--accent);font-weight:600;margin-bottom:0.25rem">â–¸ '
                                + '<span id="k8s-infra-envlabel-' + eName + '">' + (isInfraManaged ? 'Connection Environment Variables' : 'Environment Variables') + '</span>'
                                + '</div>';
                            if (infraEnvKeys.length > 0) {
                                h += '<div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;margin-bottom:0.2rem;padding:0 0.25rem">'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Key</span>'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Value</span>'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Var / Secret</span>'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Injection</span>'
                                    + '<span></span>'
                                    + '</div>';
                            }
                            h += '<div id="k8s-svc-env-list-' + infraId + '" style="display:flex;flex-direction:column;gap:0.2rem">';
                            if (savedInfra?.envVars) {
                                savedInfra.envVars.forEach((ev, j) => {
                                    h += _envRowHtml(infraId, j, ev.key, ev.value || '', ev.type || 'hardcoded', ev.varName || '', infraId);
                                });
                            } else {
                                Object.entries(infraEnvVals).forEach(([k, v], j) => {
                                    const injType = _isSecretKey(k) ? 'secret' : 'variable';
                                    h += _envRowHtml(infraId, j, k, v || '', injType, '${' + k + '}', infraId);
                                });
                            }
                            h += '</div>';
                            h += '<button type="button" onclick="_addEnvVar(\'' + infraId + '\')"'
                                + ' style="margin-top:0.3rem;font-size:0.66rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.2rem 0.5rem;cursor:pointer;width:100%">'
                                + '+ Add variable'
                                + '</button>';

                            // â”€â”€ Persistent Storage section (hidden for Managed) â”€â”€
                            const infraVols = svc.volumes || [];
                            // Use saved volumes when available for infra
                            const classifiedVols = savedInfra?.volumes
                                ? savedInfra.volumes.map(vol => window._savedVolToClassification(vol))
                                : infraVols.map(v => window._classifyVolume(v)).filter(cl => cl.classification === 'named' || cl.classification === 'data-bind');
                            const showVolSec = infraKindDefault !== 'Managed' ? 'block' : 'none';

                            h += '<div id="k8s-infra-vol-section-' + eName + '" style="display:' + showVolSec + ';margin-top:0.5rem;padding-top:0.4rem;border-top:1px solid var(--border-subtle)">';
                            h += '<details' + (classifiedVols.length > 0 ? ' open' : '') + '>';
                            h += '<summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);font-weight:600;user-select:none;display:flex;align-items:center;gap:0.3rem">'
                                + 'â–¸ Persistent Storage'
                                + (classifiedVols.length > 0 ? ' <span style="font-size:0.6rem;background:var(--bg-secondary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">' + classifiedVols.length + ' from Compose</span>' : '')
                                + '<span id="k8s-svc-vol-summary-' + infraId + '" style="margin-left:auto;font-size:0.6rem;color:var(--text-muted);font-weight:400"></span>'
                                + '</summary>';
                            h += '<div style="margin-top:0.25rem;padding:0.3rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">';
                            h += '<div id="k8s-svc-vol-list-' + infraId + '" style="display:flex;flex-direction:column;gap:0.3rem">';
                            if (classifiedVols.length > 0) {
                                classifiedVols.forEach((cl, j) => {
                                    h += window._volRowHtml(infraId, j, cl);
                                });
                            } else {
                                h += '<div style="font-size:0.68rem;color:var(--text-muted);font-style:italic">No named volumes detected â€” click "+ Add volume" below</div>';
                            }
                            h += '</div>';
                            h += '<button type="button" onclick="window._addVolRow(\'' + infraId + '\')"'
                                + ' style="margin-top:0.3rem;font-size:0.66rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.2rem 0.5rem;cursor:pointer;width:100%">'
                                + '+ Add volume'
                                + '</button>';
                            h += '</div>';
                            h += '</details>';
                            h += '</div>';

                            h += '</div>'; // close cfg panel
                            h += '</div>'; // close outer card
                            return h;
                        };

                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // â”€â”€ Section B: Infrastructure Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                        html += wizSection('Infrastructure Services',
                            infraSvcs.length > 0
                                ? `${infraSvcs.length} infrastructure service${infraSvcs.length !== 1 ? 's' : ''} detected. Choose how to handle each in K8s.`
                                : 'No infrastructure services detected from Docker. Add services below if needed.');

                        html += `<div style="display:flex;flex-direction:column;gap:0.4rem" id="k8s-infra-list">`;
                        for (let i = 0; i < infraSvcs.length; i++) {
                            html += window._k8sInfraCardHtml(infraSvcs[i], _savedInfra(infraSvcs[i].name));
                        }
                        html += `</div>`;
                        html += `<div style="margin-top:0.4rem;display:flex;gap:0.4rem;align-items:center">`;
                        html += `<select id="k8s-infra-add-select" class="modal-form-select"
                            style="font-size:0.74rem;padding:0.3rem 0.5rem;flex:1;max-width:320px"
                            onchange="if(this.value)window._k8sAddInfra(this.value);this.value=''">
                            <option value="">+ Add infrastructure serviceâ€¦</option>
                        </select>`;
                        html += `</div>`;

                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // â”€â”€ Section C: Cluster Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                        html += wizSection('Cluster Settings', 'Common settings for all K8s resources.');
                        html += wizFormGrid([
                            { name: 'k8s-namespace', label: 'Namespace', value: _savedState?.namespace || data.namespace || defaultNamespace, hint: 'Target K8s namespace for all resources' },
                            { name: 'k8s-output-dir', label: 'Output Directory', value: _savedState?.output_dir || 'k8s/', hint: 'Where manifest files will be written' },
                        ]);
                        html += wizFormGrid([
                            { name: 'k8s-ingress', label: 'Generate Ingress manifest', type: 'checkbox', value: _savedState?.ingress ?? false, fullWidth: true },
                            // ConfigMap checkbox removed â€” ConfigMaps/Secrets auto-generated per service from envVars
                        ]);

                        // â”€â”€ Skaffold pipeline toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        html += `
                        <div id="k8s-skaffold-panel" style="margin-top:0.6rem;padding:0.7rem 0.8rem;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset)">
                            <div style="display:flex;align-items:flex-start;gap:0.5rem">
                                <input type="checkbox" id="k8s-skaffold-toggle"${(_savedState?.skaffold ?? true) ? ' checked' : ''}
                                       style="margin-top:3px;accent-color:var(--accent);cursor:pointer">
                                <div style="flex:1">
                                    <label for="k8s-skaffold-toggle" style="font-weight:600;font-size:0.82rem;cursor:pointer;display:block;margin-bottom:2px">
                                        ğŸ›¤ Generate Skaffold pipeline (<code>skaffold.yaml</code>)
                                    </label>
                                    <div style="font-size:0.72rem;color:var(--text-muted);line-height:1.45">
                                        <a href="https://skaffold.dev" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">Skaffold</a>
                                        is a command-line tool by Google that automates the <strong>build â†’ push â†’ deploy</strong> workflow
                                        for Kubernetes applications. It watches your source code, rebuilds container images on change,
                                        and redeploys to your cluster automatically â€” giving you a <strong>live-reload dev loop</strong>
                                        similar to hot-module replacement but for containers.<br>
                                        The generated <code>skaffold.yaml</code> ties your Dockerfiles and K8s manifests together
                                        so you can run <code>skaffold dev</code> for development or <code>skaffold run</code> for one-shot deploys.
                                    </div>
                                </div>
                            </div>
                            <div id="k8s-skaffold-status" style="margin-top:0.5rem;font-size:0.74rem">
                                <span class="spinner" style="width:12px;height:12px;display:inline-block;vertical-align:middle"></span>
                                <span style="color:var(--text-muted);margin-left:4px">Checking Skaffold CLIâ€¦</span>
                            </div>
                        </div>`;

                        // Store source list sizes for collect()
                        data._appSvcCount = hasCompose ? appSvcs.length : deployableModules.length;
                        data._infraSvcCount = infraSvcs.length;
                        data._configMode = hasCompose ? 'compose' : (deployableModules.length > 0 ? 'modules' : 'manual');

                        el.innerHTML = html;

                        // â”€â”€ Service name map for cross-row awareness â”€â”€
                        window._k8sSvcNames = {};
                        if (hasCompose) {
                            appSvcs.forEach((s, idx) => { window._k8sSvcNames[String(idx)] = s.name; });
                        } else {
                            deployableModules.forEach((m, idx) => { window._k8sSvcNames[String(idx)] = m.name; });
                        }
                        infraSvcs.forEach(s => { window._k8sSvcNames['infra-' + s.name] = s.name; });

                        // â”€â”€ Track active/removed infra for add/remove â”€â”€
                        window._k8sActiveInfra = new Set(infraSvcs.map(s => s.name));
                        // Map removed service name â†’ service data (for re-adding)
                        window._k8sRemovedInfra = new Map();
                        // Original compose data for detected services (for re-adding)
                        window._k8sInfraData = new Map();
                        infraSvcs.forEach(s => { window._k8sInfraData.set(s.name, s); });

                        // â”€â”€ Companion container tracking (pod grouping) â”€â”€
                        // Map: targetIndex â†’ [{sourceIndex, svcName, image, port}]
                        window._k8sCompanions = new Map();

                        // Populate "Move into pod" dropdown options for each app card
                        window._k8sRefreshMoveToDropdowns = () => {
                            const svcCount = hasCompose ? appSvcs.length : deployableModules.length;
                            for (let si = 0; si < svcCount; si++) {
                                const sel = document.getElementById('k8s-svc-moveto-' + si);
                                if (!sel) continue;
                                // Is this card hidden (already moved into another pod)?
                                const card = document.getElementById('k8s-svc-card-' + si);
                                if (card && card.style.display === 'none') continue;
                                // Rebuild options
                                sel.innerHTML = '<option value="">â¤µ Move into another podâ€¦</option>';
                                for (let ti = 0; ti < svcCount; ti++) {
                                    if (ti === si) continue;
                                    const tCard = document.getElementById('k8s-svc-card-' + ti);
                                    if (!tCard || tCard.style.display === 'none') continue;
                                    const tName = window._k8sSvcNames[String(ti)] || ('service-' + ti);
                                    sel.innerHTML += '<option value="' + ti + '">â†’ ' + esc(tName) + '</option>';
                                }
                            }
                        };

                        // Move service sourceIdx INTO targetIdx pod as a companion container
                        window._k8sMoveIntoPod = (sourceIdx, targetIdx) => {
                            const srcCard = document.getElementById('k8s-svc-card-' + sourceIdx);
                            if (!srcCard) return;

                            const svcName = window._k8sSvcNames[String(sourceIdx)] || ('service-' + sourceIdx);
                            const image = (document.getElementById('k8s-svc-img-' + sourceIdx) || {}).value || '';
                            const port = (document.getElementById('k8s-svc-port-' + sourceIdx) || {}).value || '';

                            // Extract full state BEFORE hiding the card
                            const envVars = window._collectEnvVars(sourceIdx);
                            const resources = window._k8sReadSourceResources(sourceIdx);
                            const volumes = window._k8sReadSourceVolumes(sourceIdx);

                            const companion = {
                                sourceIndex: sourceIdx,
                                svcName: svcName,
                                image: image,
                                port: port,
                                envVars: envVars,
                                resources: resources,
                                volumes: volumes,
                            };

                            // Track the companion
                            if (!window._k8sCompanions.has(targetIdx)) {
                                window._k8sCompanions.set(targetIdx, []);
                            }
                            window._k8sCompanions.get(targetIdx).push(companion);

                            // Hide the source card
                            srcCard.style.display = 'none';

                            // Show companion section in target and add rich row
                            const compSec = document.getElementById('k8s-svc-companions-' + targetIdx);
                            if (compSec) compSec.style.display = 'block';

                            const compList = document.getElementById('k8s-svc-companion-list-' + targetIdx);
                            if (compList) {
                                const wrapper = document.createElement('div');
                                wrapper.innerHTML = window._k8sCompanionRowHtml(targetIdx, companion);
                                compList.appendChild(wrapper.firstElementChild);
                            }

                            // Register companion in svcNames for collision detection messages
                            window._k8sSvcNames['comp-' + targetIdx + '-' + sourceIdx] = svcName + ' (companion)';

                            // Refresh all "Move into" dropdowns
                            window._k8sRefreshMoveToDropdowns();

                            // Re-evaluate env collisions (companion's env vars now visible)
                            window._wizValidation.recheck('k8s');
                        };

                        // Split a companion back to its own workload card
                        window._k8sSplitBack = (sourceIdx, targetIdx) => {
                            const compEnvId = 'comp-' + targetIdx + '-' + sourceIdx;

                            // â”€â”€ Capture companion state BEFORE removing its DOM â”€â”€
                            const compEnvVars = window._collectEnvVars(compEnvId);
                            const compImage = (document.getElementById('k8s-comp-img-' + targetIdx + '-' + sourceIdx) || {}).value || '';
                            const compPort = (document.getElementById('k8s-comp-port-' + targetIdx + '-' + sourceIdx) || {}).value || '';
                            const compCpuReq = (document.getElementById('k8s-comp-cpureq-' + targetIdx + '-' + sourceIdx) || {}).value || '';
                            const compCpuLim = (document.getElementById('k8s-comp-cpulim-' + targetIdx + '-' + sourceIdx) || {}).value || '';
                            const compMemReq = (document.getElementById('k8s-comp-memreq-' + targetIdx + '-' + sourceIdx) || {}).value || '';
                            const compMemLim = (document.getElementById('k8s-comp-memlim-' + targetIdx + '-' + sourceIdx) || {}).value || '';

                            // â”€â”€ Re-show the source card â”€â”€
                            const srcCard = document.getElementById('k8s-svc-card-' + sourceIdx);
                            if (srcCard) srcCard.style.display = '';

                            // â”€â”€ Write captured state back to source card â”€â”€
                            // Image & port
                            const imgEl = document.getElementById('k8s-svc-img-' + sourceIdx);
                            if (imgEl && compImage) imgEl.value = compImage;
                            const portEl = document.getElementById('k8s-svc-port-' + sourceIdx);
                            if (portEl && compPort) portEl.value = compPort;

                            // Resources
                            const cpuReqEl = document.getElementById('k8s-svc-cpu-req-' + sourceIdx);
                            if (cpuReqEl) cpuReqEl.value = compCpuReq;
                            const cpuLimEl = document.getElementById('k8s-svc-cpu-lim-' + sourceIdx);
                            if (cpuLimEl) cpuLimEl.value = compCpuLim;
                            const memReqEl = document.getElementById('k8s-svc-mem-req-' + sourceIdx);
                            if (memReqEl) memReqEl.value = compMemReq;
                            const memLimEl = document.getElementById('k8s-svc-mem-lim-' + sourceIdx);
                            if (memLimEl) memLimEl.value = compMemLim;

                            // Env vars: clear source list and re-render with companion's current state
                            const srcEnvList = document.getElementById('k8s-svc-env-list-' + sourceIdx);
                            if (srcEnvList && compEnvVars.length > 0) {
                                srcEnvList.innerHTML = '';
                                compEnvVars.forEach((ev, j) => {
                                    const injType = ev.type || 'hardcoded';
                                    const varN = ev.varName || (injType !== 'hardcoded' ? '${' + ev.key + '}' : '');
                                    const wrapper = document.createElement('div');
                                    wrapper.innerHTML = _envRowHtml(sourceIdx, j, ev.key, ev.value || '', injType, varN, sourceIdx);
                                    srcEnvList.appendChild(wrapper.firstElementChild);
                                });
                                if (typeof _updateEnvSummary === 'function') _updateEnvSummary(sourceIdx);
                            }

                            // â”€â”€ Remove from tracking â”€â”€
                            const companions = window._k8sCompanions.get(targetIdx) || [];
                            window._k8sCompanions.set(targetIdx,
                                companions.filter(c => c.sourceIndex !== sourceIdx));

                            // Remove the companion row
                            const row = document.getElementById('k8s-companion-row-' + sourceIdx);
                            if (row) row.remove();

                            // Hide companion section if empty
                            const remaining = window._k8sCompanions.get(targetIdx) || [];
                            if (remaining.length === 0) {
                                const compSec = document.getElementById('k8s-svc-companions-' + targetIdx);
                                if (compSec) compSec.style.display = 'none';
                            }

                            // Refresh all "Move into" dropdowns
                            delete (window._k8sSvcNames || {})['comp-' + targetIdx + '-' + sourceIdx];
                            window._k8sRefreshMoveToDropdowns();

                            // Re-evaluate env collisions (companion's env vars now removed/moved back)
                            window._wizValidation.recheck('k8s');
                        };

                        // Initial population of move-to dropdowns + kind panel sync (deferred to after DOM render)
                        setTimeout(() => {
                            window._k8sRefreshMoveToDropdowns();
                            // Sync kind panels for any service that defaults to a non-Deployment kind
                            const svcCount = hasCompose ? appSvcs.length : deployableModules.length;
                            for (let si = 0; si < svcCount; si++) {
                                const kindSel = document.getElementById('k8s-svc-kind-' + si);
                                if (kindSel && kindSel.value !== 'Deployment') {
                                    window._k8sToggleKindPanels(si, kindSel.value);
                                }
                            }

                            // â”€â”€ Saved state post-render restoration â”€â”€
                            if (_savedState) {
                                const _set = (id, val) => { const el = document.getElementById(id); if (el && val !== undefined && val !== null) el.value = String(val); };
                                const _chk = (id, v) => { const el = document.getElementById(id); if (el) { el.checked = !!v; el.dispatchEvent(new Event('change', {bubbles: true})); } };

                                for (let si = 0; si < svcCount; si++) {
                                    const sName = hasCompose ? appSvcs[si]?.name : deployableModules[si]?.name;
                                    const sv = _savedSvc(sName);
                                    if (!sv) continue;

                                    // 1. Volume sub-fields (accessMode, storageClass, etc.)
                                    if (sv.volumes) {
                                        sv.volumes.forEach((vol, j) => {
                                            const cl = window._savedVolToClassification(vol);
                                            window._restoreVolFields(si, j, cl);
                                        });
                                    }

                                    // 2. Probes (saved as readinessProbe / livenessProbe)
                                    const _restoreProbe = (pfx, probe) => {
                                        if (!probe) {
                                            // Probe was explicitly disabled (null in saved state)
                                            _chk(pfx + '-enable', false);
                                            return;
                                        }
                                        _chk(pfx + '-enable', true);
                                        if (probe.type) _set(pfx + '-type', probe.type);
                                        if (probe.path) _set(pfx + '-path', probe.path);
                                        if (probe.port) _set(pfx + '-port', probe.port);
                                        if (probe.command) _set(pfx + '-cmd', probe.command);
                                        if (probe.initialDelaySeconds != null) _set(pfx + '-delay', probe.initialDelaySeconds);
                                        if (probe.periodSeconds != null) _set(pfx + '-period', probe.periodSeconds);
                                        if (probe.extra != null) _set(pfx + '-extra', probe.extra);
                                    };
                                    if ('readinessProbe' in sv) {
                                        _restoreProbe('k8s-svc-rdy-' + si, sv.readinessProbe);
                                    }
                                    if ('livenessProbe' in sv) {
                                        _restoreProbe('k8s-svc-liv-' + si, sv.livenessProbe);
                                    }

                                    // 3. Mesh
                                    if (sv.mesh) {
                                        const m = sv.mesh;
                                        _chk('k8s-svc-mesh-enable-' + si, true);
                                        _set('k8s-svc-mesh-provider-' + si, m.provider);
                                        _set('k8s-svc-mesh-cpureq-' + si, m.proxyCpuRequest);
                                        _set('k8s-svc-mesh-cpulim-' + si, m.proxyCpuLimit);
                                        _set('k8s-svc-mesh-memreq-' + si, m.proxyMemRequest);
                                        _set('k8s-svc-mesh-memlim-' + si, m.proxyMemLimit);
                                        _set('k8s-svc-mesh-exin-' + si, m.excludeInbound);
                                        _set('k8s-svc-mesh-exout-' + si, m.excludeOutbound);
                                        _set('k8s-svc-mesh-log-' + si, m.logLevel);
                                    }

                                    // 4. CronJob schedule
                                    if (sv.schedule) _set('k8s-svc-schedule-' + si, sv.schedule);

                                     // 5. Update volume summaries
                                    if (window._updateVolSummary) window._updateVolSummary(si);

                                    // 6. Init containers
                                    if (sv.initContainers && sv.initContainers.length > 0) {
                                        const initList = document.getElementById('k8s-svc-init-list-' + si);
                                        if (initList) {
                                            sv.initContainers.forEach((ic, j) => {
                                                const wrapper = document.createElement('div');
                                                wrapper.innerHTML = window._k8sInitRowHtml(si, j, ic.name, ic.image, ic.command);
                                                initList.appendChild(wrapper.firstElementChild);
                                            });
                                            window._k8sUpdateInitCount(si);
                                        }
                                    }

                                    // 7. Sidecars
                                    if (sv.sidecars && sv.sidecars.length > 0) {
                                        const scList = document.getElementById('k8s-svc-sc-list-' + si);
                                        if (scList) {
                                            sv.sidecars.forEach((sc, j) => {
                                                const wrapper = document.createElement('div');
                                                wrapper.innerHTML = window._k8sSidecarRowHtml(
                                                    si, j, sc.name, sc.image, sc.command,
                                                    sc.nativeSidecar, sc.sharedVolume, sc.sharedMount
                                                );
                                                scList.appendChild(wrapper.firstElementChild);
                                            });
                                            window._k8sUpdateScCount(si);
                                        }
                                    }

                                    // 8. Dependency checkboxes
                                    if (sv.dependencies && sv.dependencies.length > 0) {
                                        sv.dependencies.forEach(depName => {
                                            const depChk = document.querySelector(
                                                '.k8s-dep-' + si + '[value="' + depName + '"]'
                                            );
                                            if (depChk) depChk.checked = true;
                                        });
                                        // Refresh env selects to reflect restored dependencies
                                        if (window._refreshEnvSelects) window._refreshEnvSelects(si);
                                    }
                                }

                                // â”€â”€ Infra services post-render restoration â”€â”€
                                if (_savedState?._infraDecisions) {
                                    for (const inf of _savedState._infraDecisions) {
                                        // Provider notes (for Managed decisions)
                                        if (inf.providerNotes) {
                                            _set('k8s-infra-provider-' + inf.name, inf.providerNotes);
                                        }
                                        // Volume sub-fields
                                        if (inf.volumes) {
                                            const infraId = 'infra-' + inf.name;
                                            inf.volumes.forEach((vol, j) => {
                                                const cl = window._savedVolToClassification(vol);
                                                window._restoreVolFields(infraId, j, cl);
                                            });
                                        }
                                    }
                                }
                            }
                        }, 0);

                        // â”€â”€ Kind-conditional panel toggle â”€â”€
                        // Shows/hides sections based on the selected workload kind
                        window._k8sToggleKindPanels = (i, kind) => {
                            const isJob = kind === 'Job' || kind === 'CronJob';
                            const isCron = kind === 'CronJob';
                            const isDaemon = kind === 'DaemonSet';
                            const isStateful = kind === 'StatefulSet';
                            const isSkip = kind === 'Skip';

                            const hide = (id) => { const el = document.getElementById(id); if (el) el.style.display = 'none'; };
                            const show = (id, d) => { const el = document.getElementById(id); if (el) el.style.display = d || 'block'; };

                            // Skip: hide entire config panel, show skip banner
                            if (isSkip) {
                                hide('k8s-svc-cfg-' + i);
                                show('k8s-svc-skip-banner-' + i);
                                return;
                            } else {
                                show('k8s-svc-cfg-' + i);
                                hide('k8s-svc-skip-banner-' + i);
                            }

                            // Port â€” hide for Job/CronJob, show for others
                            if (isJob) hide('k8s-svc-port-wrap-' + i);
                            else show('k8s-svc-port-wrap-' + i);

                            // Replicas â€” hide for Job/CronJob and DaemonSet (StatefulSet keeps it)
                            if (isJob || isDaemon) hide('k8s-svc-replicas-wrap-' + i);
                            else show('k8s-svc-replicas-wrap-' + i);

                            // Service Type â€” hide for Job/CronJob, DaemonSet, and StatefulSet (headless is mandatory)
                            if (isJob || isDaemon || isStateful) hide('k8s-svc-svctype-wrap-' + i);
                            else show('k8s-svc-svctype-wrap-' + i);

                            // Deploy sections (Deployment strategy) â€” only for Deployment
                            if (isJob || isDaemon || isStateful) hide('k8s-svc-deploy-sections-' + i);
                            else show('k8s-svc-deploy-sections-' + i);

                            // Job sections â€” show for Job/CronJob
                            if (isJob) show('k8s-svc-job-sections-' + i);
                            else hide('k8s-svc-job-sections-' + i);

                            // CronJob sections â€” show only for CronJob
                            if (isCron) show('k8s-svc-cron-sections-' + i);
                            else hide('k8s-svc-cron-sections-' + i);

                            // DaemonSet sections â€” show only for DaemonSet
                            if (isDaemon) show('k8s-svc-daemon-sections-' + i);
                            else hide('k8s-svc-daemon-sections-' + i);

                            // StatefulSet sections â€” show only for StatefulSet
                            if (isStateful) show('k8s-svc-statefulset-sections-' + i);
                            else hide('k8s-svc-statefulset-sections-' + i);

                            // Health Checks â€” hide for Job/CronJob, show for others
                            if (isJob) hide('k8s-svc-probes-wrap-' + i);
                            else show('k8s-svc-probes-wrap-' + i);

                            // Volumes (regular) â€” hide for Job/CronJob and StatefulSet (VCTs replace them)
                            if (isJob || isStateful) hide('k8s-svc-vols-wrap-' + i);
                            else show('k8s-svc-vols-wrap-' + i);

                            // Dependencies â€” hide for Job/CronJob, DaemonSet, and StatefulSet
                            if (isJob || isDaemon || isStateful) hide('k8s-svc-deps-wrap-' + i);
                            else show('k8s-svc-deps-wrap-' + i);

                            // Service Mesh warning â€” show for Job/CronJob
                            if (isJob) show('k8s-svc-mesh-warn-' + i);
                            else hide('k8s-svc-mesh-warn-' + i);
                        };

                        // â”€â”€ Remove infra card â”€â”€
                        window._k8sRemoveInfra = (name) => {
                            const list = document.getElementById('k8s-infra-list');
                            const card = list ? list.querySelector('[data-infra-name="' + name + '"]') : null;
                            if (!card) return;
                            // Store data before removing (compose-detected or catalog)
                            const svcData = window._k8sInfraData.get(name);
                            if (svcData) window._k8sRemovedInfra.set(name, svcData);
                            card.remove();
                            window._k8sActiveInfra.delete(name);
                            delete (window._k8sSvcNames || {})['infra-' + name];
                            window._k8sUpdateInfraAddSelect();
                            // Re-evaluate env collisions (infra env vars removed)
                            window._wizValidation.recheck('k8s');
                        };

                        // â”€â”€ Add infra card (from removed, catalog, or custom) â”€â”€
                        window._k8sAddInfra = (name) => {
                            if (name === '__custom__') {
                                // Prompt for custom name
                                const customName = prompt('Service name (lowercase, no spaces):');
                                if (!customName || !customName.trim()) return;
                                const cName = customName.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-');
                                if (window._k8sActiveInfra.has(cName)) return;
                                const customSvc = {
                                    name: cName,
                                    image: cName + ':latest',
                                    ports: [],
                                    volumes: [],
                                    environment: {},
                                };
                                window._k8sInfraData.set(cName, customSvc);
                                window._k8sDoAddInfra(customSvc);
                                return;
                            }
                            // Re-add removed service or add from catalog
                            let svcData = window._k8sRemovedInfra.get(name);
                            if (svcData) {
                                window._k8sRemovedInfra.delete(name);
                            } else if (_INFRA_CATALOG[name]) {
                                // Build service data from the Docker _infraOptions entry
                                const cat = _INFRA_CATALOG[name];
                                const env = {};
                                (cat.envFields || []).forEach(ef => { env[ef.key] = ef.default || ''; });
                                svcData = {
                                    name: cat.key,
                                    image: cat.images[0],
                                    ports: (cat.ports || []).map(p => ({ host: p.port, container: p.port, protocol: 'tcp' })),
                                    volumes: (cat.volumes || []).map(v => v.name + ':' + v.mount),
                                    environment: env,
                                };
                                window._k8sInfraData.set(name, svcData);
                            }
                            if (!svcData) return;
                            window._k8sDoAddInfra(svcData);
                        };

                        // â”€â”€ Internal: append card + update tracking â”€â”€
                        window._k8sDoAddInfra = (svc) => {
                            const list = document.getElementById('k8s-infra-list');
                            if (!list) return;
                            const wrapper = document.createElement('div');
                            wrapper.innerHTML = window._k8sInfraCardHtml(svc);
                            const card = wrapper.firstElementChild;
                            list.appendChild(card);
                            window._k8sActiveInfra.add(svc.name);
                            window._k8sSvcNames['infra-' + svc.name] = svc.name;
                            // Update env map for suggestion filtering
                            window._infraEnvMap = window._infraEnvMap || {};
                            window._infraEnvMap[svc.name] = Object.keys(svc.environment || {});
                            window._k8sUpdateInfraAddSelect();
                            // Re-evaluate env collisions (new infra env vars added)
                            window._wizValidation.recheck('k8s');
                        };

                        // â”€â”€ Rebuild the Add select options â”€â”€
                        window._k8sUpdateInfraAddSelect = () => {
                            const sel = document.getElementById('k8s-infra-add-select');
                            if (!sel) return;
                            let html = '<option value="">+ Add infrastructure serviceâ€¦</option>';
                            // Group 1: Previously removed (re-add)
                            const removedNames = Array.from(window._k8sRemovedInfra.keys());
                            if (removedNames.length > 0) {
                                html += '<optgroup label="â†© Removed (re-add)">';
                                removedNames.forEach(n => {
                                    const label = (_INFRA_CATALOG[n] && _INFRA_CATALOG[n].label) || n;
                                    html += '<option value="' + esc(n) + '">â†© ' + esc(label) + '</option>';
                                });
                                html += '</optgroup>';
                            }
                            // Group 2: Catalog grouped by category â€” same as Docker
                            const catOrder = ['db-rel','db-nosql','cache','mq','search','proxy','monitor','log','storage','devops'];
                            catOrder.forEach(cat => {
                                const items = _infraOptions.filter(o => o.cat === cat && !window._k8sActiveInfra.has(o.key));
                                if (items.length === 0) return;
                                const catLabel = (_infraCategories && _infraCategories[cat]) || cat;
                                html += '<optgroup label="' + esc(catLabel) + '">';
                                items.forEach(o => {
                                    html += '<option value="' + esc(o.key) + '">' + esc(o.label) + ' â€” ' + esc(o.images[0]) + '</option>';
                                });
                                html += '</optgroup>';
                            });
                            // Group 3: Custom
                            html += '<optgroup label="Other">';
                            html += '<option value="__custom__">âœï¸ Custom serviceâ€¦</option>';
                            html += '</optgroup>';
                            sel.innerHTML = html;
                        };
                        // Make _infraEnvMap available globally for dynamic adds
                        window._infraEnvMap = _infraEnvMap;

                        // Populate add-select on initial render
                        window._k8sUpdateInfraAddSelect();

                        // â”€â”€ Infra env trigger: re-evaluate cross-row when infra toggled on â”€â”€
                        window._k8sInfraEnvTrigger = (infraName) => {
                            const infraId = 'infra-' + infraName;
                            const list = document.getElementById('k8s-svc-env-list-' + infraId);
                            if (!list) return;
                            // Re-evaluate infra env rows (skip hardcoded â€” their var select is placeholder '--')
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (!keyEl) return;
                                const j = keyEl.id.split('-').pop();
                                const typeSel = document.getElementById('k8s-svc-env-type-' + infraId + '-' + j);
                                if (typeSel && typeSel.value === 'hardcoded') return;
                                const varSel = document.getElementById('k8s-svc-env-var-' + infraId + '-' + j);
                                if (varSel) window._onVarSelect(varSel);
                            });
                            // Also re-evaluate ALL app service env rows so they detect newly-visible infra rows
                            const svcCount = hasCompose ? appSvcs.length : deployableModules.length;
                            for (let si = 0; si < svcCount; si++) {
                                const appList = document.getElementById('k8s-svc-env-list-' + si);
                                if (!appList) continue;
                                appList.querySelectorAll('.k8s-env-row').forEach(row => {
                                    const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                    if (!keyEl) return;
                                    const sj = keyEl.id.split('-').pop();
                                    const typeSel = document.getElementById('k8s-svc-env-type-' + si + '-' + sj);
                                    if (typeSel && typeSel.value === 'hardcoded') return;
                                    const varSel = document.getElementById('k8s-svc-env-var-' + si + '-' + sj);
                                    if (varSel) window._onVarSelect(varSel);
                                });
                            }
                            // Run symmetric collision check after re-evaluating all rows
                            window._wizValidation.recheck('k8s');
                        };

                        // â”€â”€ Post-render: attach live QoS class updaters â”€â”€
                        // For each app service card, listen for input changes on resource fields
                        // and recalculate the QoS class indicator in real-time
                        const svcCount = hasCompose ? appSvcs.length : deployableModules.length;
                        for (let idx = 0; idx < svcCount; idx++) {
                            const ids = ['cpu-req', 'cpu-lim', 'mem-req', 'mem-lim'].map(f => `k8s-svc-${f}-${idx}`);
                            const els = ids.map(id => document.getElementById(id));
                            if (!els.some(Boolean)) continue;

                            const updateQoS = () => {
                                const cr = (els[0] && els[0].value.trim()) || '';
                                const cl = (els[1] && els[1].value.trim()) || '';
                                const mr = (els[2] && els[2].value.trim()) || '';
                                const ml = (els[3] && els[3].value.trim()) || '';
                                const hint = _qosHint(cr, cl, mr, ml);
                                // Update both the summary-bar QoS and the live QoS inside the panel
                                const qosSummary = document.getElementById(`k8s-svc-qos-${idx}`);
                                const qosLive = document.getElementById(`k8s-svc-qos-live-${idx}`);
                                if (qosSummary) qosSummary.innerHTML = hint;
                                if (qosLive) qosLive.innerHTML = hint;
                            };

                            els.forEach(el => { if (el) el.addEventListener('input', updateQoS); });
                        }

                        // â”€â”€ Initial env key collision check (covers compose/saved pre-populated env vars) â”€â”€
                        window._wizValidation.recheck('k8s');

                        // â”€â”€ Skaffold detection + install flow â”€â”€
                        (async () => {
                            const statusEl = document.getElementById('k8s-skaffold-status');
                            if (!statusEl) return;
                            try {
                                const res = await api('/k8s/skaffold/status');
                                if (res.available) {
                                    // CLI found â€” show green status
                                    statusEl.innerHTML = '<span style="color:var(--success)">âœ… Skaffold CLI detected</span>'
                                        + (res.version ? ' <code style="font-size:0.68rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px">' + esc(res.version) + '</code>' : '');
                                } else {
                                    // Not installed â€” show warning + install button
                                    const btnId = 'k8s-skaffold-install-btn';
                                    const logId = 'k8s-skaffold-install-log';
                                    const pwId  = 'k8s-skaffold-install-pw';
                                    statusEl.innerHTML = `
                                        <div style="padding:0.5rem 0.6rem;border-radius:6px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25);margin-top:0.3rem">
                                            <div style="font-size:0.76rem;color:var(--warning);font-weight:600;margin-bottom:0.3rem">
                                                âš ï¸ Skaffold CLI not found
                                            </div>
                                            <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:0.5rem">
                                                You can still generate <code>skaffold.yaml</code>, but you'll need to install the CLI
                                                to run <code>skaffold dev</code> or <code>skaffold run</code>.
                                            </div>
                                            <div style="margin-bottom:0.4rem">
                                                <label style="font-size:0.72rem;font-weight:600;display:block;margin-bottom:3px">ğŸ”‘ Sudo password:</label>
                                                <input id="${pwId}" type="password" placeholder="Enter your sudo password"
                                                       style="width:100%;max-width:300px;padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-primary);color:var(--text-primary);font-size:0.78rem;box-sizing:border-box"
                                                       onkeydown="if(event.key==='Enter'){document.getElementById('${btnId}').click()}" />
                                            </div>
                                            <button id="${btnId}" class="btn btn-sm" onclick="window._k8sInstallSkaffold()"
                                                    style="font-size:0.76rem;background:rgba(99,102,241,0.12);color:var(--accent);border:1px solid rgba(99,102,241,0.3);padding:6px 16px;cursor:pointer">
                                                â¬‡ï¸ Install Skaffold
                                            </button>
                                            <div id="${logId}" style="display:none;margin-top:0.4rem">
                                                <div style="font-size:0.68rem;font-weight:600;margin-bottom:3px">ğŸ“‹ Output:</div>
                                                <pre style="font-size:0.66rem;background:var(--bg-primary);padding:8px;border-radius:var(--radius-sm);max-height:150px;overflow:auto;white-space:pre-wrap;word-break:break-all"></pre>
                                            </div>
                                            <details style="margin-top:0.3rem">
                                                <summary style="cursor:pointer;font-size:0.68rem;color:var(--text-muted)">Or install manually:</summary>
                                                <pre style="font-size:0.68rem;background:var(--bg-primary);padding:6px;border-radius:var(--radius-sm);margin-top:3px;white-space:pre-wrap;word-break:break-all;cursor:text;user-select:all">curl -Lo /usr/local/bin/skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64 && sudo chmod +x /usr/local/bin/skaffold</pre>
                                            </details>
                                        </div>`;
                                    // Focus password field
                                    setTimeout(() => { const el = document.getElementById(pwId); if (el) el.focus(); }, 100);
                                }
                            } catch (e) {
                                statusEl.innerHTML = '<span style="color:var(--text-muted)">âš ï¸ Could not check Skaffold status</span>';
                            }
                        })();

                        // â”€â”€ StorageClass detection (bonus: merges into catalog) â”€â”€
                        (async () => {
                            try {
                                const res = await api('/k8s/storageclasses');
                                if (!res.ok || !res.storage_classes) {
                                    // No cluster â€” that's fine, catalog is always available
                                    return;
                                }
                                const classes = res.storage_classes;
                                const defClass = res.default_class || '';
                                // Mark detected classes in the catalog
                                classes.forEach(sc => {
                                    if (_SC_FLAT[sc.name]) {
                                        _SC_FLAT[sc.name]._detected = true;
                                    }
                                });
                                // Collect classes NOT in catalog (custom cluster classes)
                                const extras = classes.filter(sc => !_SC_FLAT[sc.name]);
                                // Build the enhanced option HTML once
                                let optHtml = '<option value="">(cluster default' + (defClass ? ' â€” ' + esc(defClass) : '') + ')</option>';
                                _SC_CATALOG.forEach(g => {
                                    optHtml += '<optgroup label="' + esc(g.group) + '">';
                                    g.items.forEach(sc => {
                                        const det = sc._detected ? ' âœ“ detected' : '';
                                        const defTag = classes.find(c => c.name === sc.name && c.is_default) ? ' â˜… default' : '';
                                        optHtml += '<option value="' + esc(sc.name) + '" title="' + esc(sc.provisioner) + '">' + esc(sc.name) + ' â€” ' + esc(sc.hint) + det + defTag + '</option>';
                                    });
                                    optHtml += '</optgroup>';
                                });
                                if (extras.length > 0) {
                                    optHtml += '<optgroup label="Detected on cluster">';
                                    extras.forEach(sc => {
                                        const defTag = sc.is_default ? ' â˜… default' : '';
                                        optHtml += '<option value="' + esc(sc.name) + '">' + esc(sc.name) + ' â€” ' + esc(sc.provisioner) + ' âœ“' + defTag + '</option>';
                                    });
                                    optHtml += '</optgroup>';
                                }
                                optHtml += '<optgroup label="Other"><option value="_custom">âœï¸ Custom (type name)â€¦</option></optgroup>';
                                // Rebuild ALL per-volume SC selects
                                document.querySelectorAll('.k8s-vol-sc-select').forEach(sel => {
                                    const prev = sel.value;
                                    sel.innerHTML = optHtml;
                                    if (prev && prev !== '_custom') { sel.value = prev; }
                                    // Extract i,j from id: k8s-svc-vol-sc-{i}-{j}
                                    const parts = sel.id.split('-');
                                    const j = parts.pop();
                                    const si = parts.pop();
                                    window._k8sVolScChange(parseInt(si), parseInt(j));
                                });
                            } catch (e) {
                                // Cluster not connected â€” catalog options are already loaded, nothing to do
                            }
                        })();

                        // â”€â”€ Post-render: initialize volume summaries â”€â”€
                        for (let idx = 0; idx < svcCount; idx++) {
                            window._updateVolSummary(idx);
                        }
                        // â”€â”€ Skaffold install handler â”€â”€
                        window._k8sInstallSkaffold = async () => {
                            const btn = document.getElementById('k8s-skaffold-install-btn');
                            const logBox = document.getElementById('k8s-skaffold-install-log');
                            const pwInput = document.getElementById('k8s-skaffold-install-pw');
                            if (!btn || !logBox) return;

                            const sudoPassword = pwInput ? pwInput.value : '';
                            if (!sudoPassword) {
                                if (pwInput) {
                                    pwInput.style.border = '1px solid var(--danger)';
                                    pwInput.focus();
                                    pwInput.placeholder = 'âš ï¸ Password required';
                                }
                                return;
                            }

                            const logPre = logBox.querySelector('pre');
                            btn.disabled = true;
                            btn.innerHTML = '<span class="spinner" style="width:12px;height:12px"></span> Installingâ€¦';
                            logBox.style.display = 'block';
                            logPre.textContent = 'Downloading Skaffold binaryâ€¦\n';
                            logPre.style.color = '';

                            try {
                                const result = await api('/audit/install-tool', {
                                    method: 'POST',
                                    body: JSON.stringify({ tool: 'skaffold', cli: 'skaffold', sudo_password: sudoPassword }),
                                });
                                if (result.ok) {
                                    btn.innerHTML = 'âœ… Installed';
                                    btn.className = 'btn btn-sm btn-ghost';
                                    logPre.textContent += '\n' + (result.stdout || result.message || 'Done') + '\n\nâœ… ' + result.message;
                                    // Refresh detection status
                                    setTimeout(async () => {
                                        const statusEl = document.getElementById('k8s-skaffold-status');
                                        if (statusEl) {
                                            statusEl.innerHTML = '<span style="color:var(--success)">âœ… Skaffold CLI installed and ready</span>';
                                        }
                                    }, 500);
                                } else if (result.needs_sudo) {
                                    btn.innerHTML = 'â¬‡ï¸ Install Skaffold';
                                    btn.disabled = false;
                                    if (pwInput) { pwInput.value = ''; pwInput.focus(); pwInput.placeholder = 'âš ï¸ ' + (result.error || 'Enter password'); }
                                    logPre.textContent += '\nğŸ”‘ ' + (result.error || 'Sudo password required');
                                    logPre.style.color = 'var(--warning)';
                                } else {
                                    btn.innerHTML = 'â¬‡ï¸ Retry Install';
                                    btn.disabled = false;
                                    let logText = 'âŒ ' + (result.error || 'Unknown error') + '\n';
                                    if (result.stderr) logText += '\n' + result.stderr;
                                    if (result.stdout) logText += '\n' + result.stdout;
                                    logPre.textContent += logText;
                                    logPre.style.color = 'var(--danger)';
                                }
                            } catch (e) {
                                btn.innerHTML = 'â¬‡ï¸ Retry Install';
                                btn.disabled = false;
                                logPre.textContent += '\nâŒ ' + e.message;
                                logPre.style.color = 'var(--danger)';
                            }
                        };
                    },
                    collect: (data) => {
                        const mode = data._configMode || 'manual';
                        const appCount = data._appSvcCount || 0;
                        const infraCount = data._infraSvcCount || 0;
                        const appSvcs = data._appServices || [];
                        const infraSvcs = data._infraServices || [];
                        const deployableModules = (data._classifiedModules || []).filter(m => m._class === 'deployable');

                        // â”€â”€ Collect application services â”€â”€
                        const services = [];
                        // â”€â”€ Helper: read element value safely â”€â”€
                        const _v = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };

                        // â”€â”€ Helper: collect full companion data from rich companion row DOM â”€â”€
                        const _collectCompanionData = (targetIdx) => {
                            return (window._k8sCompanions.get(targetIdx) || []).map(c => {
                                const t = targetIdx;
                                const s = c.sourceIndex;

                                // Read image/port from companion card (editable)
                                const image = _v('k8s-comp-img-' + t + '-' + s) || c.image || '';
                                const port = _v('k8s-comp-port-' + t + '-' + s) || c.port || '';

                                // Read env vars using shared system (same as main services)
                                const compEnvId = 'comp-' + t + '-' + s;
                                const envVars = window._collectEnvVars(compEnvId);

                                // Read resources from companion card
                                const cpuReq = _v('k8s-comp-cpureq-' + t + '-' + s);
                                const cpuLim = _v('k8s-comp-cpulim-' + t + '-' + s);
                                const memReq = _v('k8s-comp-memreq-' + t + '-' + s);
                                const memLim = _v('k8s-comp-memlim-' + t + '-' + s);
                                const hasRes = cpuReq || cpuLim || memReq || memLim;

                                // Read volumes from companion card
                                const volumes = [];
                                const volList = document.getElementById('k8s-comp-vol-list-' + t + '-' + s);
                                if (volList) {
                                    volList.querySelectorAll('.k8s-comp-vol-row').forEach(row => {
                                        const nameEl = row.querySelector('[id^="k8s-comp-vol-name-"]');
                                        if (!nameEl) return;
                                        const parts = nameEl.id.split('-');
                                        const j = parts[parts.length - 1];
                                        const volName = _v('k8s-comp-vol-name-' + t + '-' + s + '-' + j);
                                        const mountPath = _v('k8s-comp-vol-mount-' + t + '-' + s + '-' + j);
                                        const volType = _v('k8s-comp-vol-type-' + t + '-' + s + '-' + j) || 'emptyDir';
                                        if (mountPath) volumes.push({ name: volName, type: volType, mountPath });
                                    });
                                }
                                // Read checked host volumes (live-refreshed section)
                                const hostVolContainer = document.getElementById('k8s-comp-hostvols-' + t + '-' + s);
                                if (hostVolContainer) {
                                    hostVolContainer.querySelectorAll('.k8s-comp-hostvol-row').forEach(row => {
                                        const chk = row.querySelector('input[type="checkbox"]');
                                        if (!chk || !chk.checked) return;
                                        const mountEl = row.querySelector('input[id$="-mount"]');
                                        const nameEl = row.querySelector('input[id$="-name"]');
                                        const typeEl = row.querySelector('input[id$="-type"]');
                                        const mountPath = mountEl ? mountEl.value.trim() : '';
                                        const volName = nameEl ? nameEl.value.trim() : '';
                                        const volType = typeEl ? typeEl.value.trim() : 'emptyDir';
                                        if (mountPath) volumes.push({ name: volName, type: volType, mountPath });
                                    });
                                }

                                // Read startup dependency (value may be 'name:port' for infra)
                                const depRaw = _v('k8s-comp-dep-' + t + '-' + s) || '';
                                let dependsOn = null;
                                let dependsOnPort = null;
                                if (depRaw) {
                                    if (depRaw === '__main__') {
                                        dependsOn = '__main__';
                                    } else if (depRaw.includes(':')) {
                                        const [dName, dPort] = depRaw.split(':');
                                        dependsOn = dName;
                                        dependsOnPort = dPort;
                                    } else {
                                        dependsOn = depRaw;
                                    }
                                }

                                return {
                                    name: c.svcName,
                                    image,
                                    port,
                                    env: envVars,
                                    resources: hasRes ? {
                                        cpu_request: cpuReq || null,
                                        cpu_limit: cpuLim || null,
                                        memory_request: memReq || null,
                                        memory_limit: memLim || null,
                                    } : null,
                                    volumes,
                                    dependsOn,
                                    dependsOnPort,
                                };
                            });
                        };

                        if (mode === 'compose') {
                            for (let i = 0; i < appCount; i++) {
                                const chk = document.getElementById(`k8s-svc-chk-${i}`);
                                if (!chk || !chk.checked) continue;
                                // Skip services moved into another pod as companions
                                const srcCard = document.getElementById(`k8s-svc-card-${i}`);
                                if (srcCard && srcCard.style.display === 'none') continue;

                                // Resource limits â€” only include non-empty values
                                const cpuReq = _v(`k8s-svc-cpu-req-${i}`);
                                const cpuLim = _v(`k8s-svc-cpu-lim-${i}`);
                                const memReq = _v(`k8s-svc-mem-req-${i}`);
                                const memLim = _v(`k8s-svc-mem-lim-${i}`);
                                const hasResources = cpuReq || cpuLim || memReq || memLim;

                                // Strategy
                                const strategy = _v(`k8s-svc-strategy-${i}`) || 'RollingUpdate';

                                // Probe collection helper
                                const _collectProbe = (prefix) => {
                                    const enableEl = document.getElementById(`${prefix}-enable`);
                                    if (!enableEl || !enableEl.checked) return null;
                                    const probeType = _v(`${prefix}-type`) || 'http';
                                    const probe = {
                                        type: probeType,
                                        initialDelaySeconds: parseInt(_v(`${prefix}-delay`)) || 0,
                                        periodSeconds: parseInt(_v(`${prefix}-period`)) || 10,
                                    };
                                    if (probeType === 'http') {
                                        probe.path = _v(`${prefix}-path`) || '/health';
                                        probe.port = parseInt(_v(`${prefix}-port`)) || 8080;
                                    } else if (probeType === 'tcp') {
                                        probe.port = parseInt(_v(`${prefix}-port`)) || 8080;
                                    } else {
                                        probe.command = _v(`${prefix}-cmd`) || '';
                                    }
                                    probe.extra = parseInt(_v(`${prefix}-extra`)) || 3;
                                    return probe;
                                };

                                const selectedKind = _v(`k8s-svc-kind-${i}`) || 'Deployment';
                                if (selectedKind === 'Skip') continue;
                                const isJobKind = selectedKind === 'Job' || selectedKind === 'CronJob';

                                const svcObj = {
                                    name: appSvcs[i].name,
                                    kind: selectedKind,
                                    image: _v(`k8s-svc-img-${i}`) || `${appSvcs[i].name}:latest`,
                                    envVars: window._collectEnvVars(i),
                                    resources: hasResources ? {
                                        cpu_request: cpuReq || null,
                                        cpu_limit: cpuLim || null,
                                        memory_request: memReq || null,
                                        memory_limit: memLim || null,
                                    } : null,
                                    _compose: appSvcs[i],
                                    companions: _collectCompanionData(i),
                                    dependencies: (() => {
                                        const deps = [];
                                        document.querySelectorAll('.k8s-dep-' + i + ':checked')
                                            .forEach(el => deps.push(el.value));
                                        return deps;
                                    })(),
                                };

                                if (isJobKind) {
                                    // Job-specific fields
                                    svcObj.command = _v(`k8s-svc-job-cmd-${i}`) || '';
                                    svcObj.args = _v(`k8s-svc-job-args-${i}`) || '';
                                    svcObj.restartPolicy = _v(`k8s-svc-job-restart-${i}`) || 'Never';
                                    svcObj.backoffLimit = parseInt(_v(`k8s-svc-job-backoff-${i}`)) || 3;
                                    svcObj.completions = parseInt(_v(`k8s-svc-job-completions-${i}`)) || 1;
                                    svcObj.parallelism = parseInt(_v(`k8s-svc-job-parallelism-${i}`)) || 1;
                                    const timeout = _v(`k8s-svc-job-timeout-${i}`);
                                    if (timeout) svcObj.activeDeadlineSeconds = parseInt(timeout);
                                    svcObj.ttlSecondsAfterFinished = parseInt(_v(`k8s-svc-job-ttl-${i}`)) || 3600;

                                    if (selectedKind === 'CronJob') {
                                        svcObj.schedule = _v(`k8s-svc-cron-schedule-${i}`) || '*/5 * * * *';
                                        svcObj.concurrencyPolicy = _v(`k8s-svc-cron-concurrency-${i}`) || 'Forbid';
                                        const suspendEl = document.getElementById(`k8s-svc-cron-suspend-${i}`);
                                        svcObj.suspend = suspendEl ? suspendEl.checked : false;
                                        svcObj.successfulJobsHistoryLimit = parseInt(_v(`k8s-svc-cron-success-${i}`)) || 3;
                                        svcObj.failedJobsHistoryLimit = parseInt(_v(`k8s-svc-cron-failed-${i}`)) || 1;
                                        const deadline = _v(`k8s-svc-cron-deadline-${i}`);
                                        if (deadline) svcObj.startingDeadlineSeconds = parseInt(deadline);
                                    }
                                } else if (selectedKind === 'DaemonSet') {
                                    // DaemonSet-specific fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '';
                                    const dsStrategy = _v(`k8s-svc-ds-strategy-${i}`) || 'RollingUpdate';
                                    svcObj.strategy = dsStrategy;
                                    svcObj.maxUnavailable = dsStrategy === 'RollingUpdate' ? (_v(`k8s-svc-ds-maxunavail-${i}`) || '1') : null;
                                    svcObj.nodeSelector = _v(`k8s-svc-ds-nodeselector-${i}`) || '';
                                    // Tolerations
                                    const tols = [];
                                    const tolCpEl = document.getElementById(`k8s-svc-ds-tol-cp-${i}`);
                                    if (tolCpEl && tolCpEl.checked) tols.push({ key: 'node-role.kubernetes.io/control-plane', effect: 'NoSchedule', operator: 'Exists' });
                                    const tolNsEl = document.getElementById(`k8s-svc-ds-tol-nosched-${i}`);
                                    if (tolNsEl && tolNsEl.checked) tols.push({ key: '', operator: 'Exists', effect: 'NoSchedule' });
                                    svcObj.tolerations = tols;
                                    // Host access
                                    const hnEl = document.getElementById(`k8s-svc-ds-hostnet-${i}`);
                                    svcObj.hostNetwork = hnEl ? hnEl.checked : false;
                                    const hpEl = document.getElementById(`k8s-svc-ds-hostpid-${i}`);
                                    svcObj.hostPID = hpEl ? hpEl.checked : false;
                                    const hiEl = document.getElementById(`k8s-svc-ds-hostipc-${i}`);
                                    svcObj.hostIPC = hiEl ? hiEl.checked : false;
                                    // Health checks + volumes (shared with Deployment)
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    svcObj.volumes = window._collectVolumes(i);
                                } else if (selectedKind === 'StatefulSet') {
                                    // StatefulSet-specific fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '8080';
                                    svcObj.replicas = _v(`k8s-svc-replicas-${i}`) || '1';
                                    svcObj.headlessServiceName = _v(`k8s-svc-ss-headless-${i}`) || `${appSvcs[i].name}-headless`;
                                    svcObj.podManagementPolicy = _v(`k8s-svc-ss-podmgmt-${i}`) || 'OrderedReady';
                                    const ssClusterIpEl = document.getElementById(`k8s-svc-ss-clusterip-${i}`);
                                    svcObj.alsoCreateClusterIP = ssClusterIpEl ? ssClusterIpEl.checked : false;
                                    const ssStrategy = _v(`k8s-svc-ss-strategy-${i}`) || 'RollingUpdate';
                                    svcObj.strategy = ssStrategy;
                                    svcObj.partition = ssStrategy === 'RollingUpdate' ? (parseInt(_v(`k8s-svc-ss-partition-${i}`)) || 0) : null;
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    // Collect volumeClaimTemplates
                                    svcObj.volumeClaimTemplates = (() => {
                                        const vcts = [];
                                        const vctList = document.getElementById('k8s-svc-vct-list-' + i);
                                        if (!vctList) return vcts;
                                        vctList.querySelectorAll('.k8s-vct-row').forEach(row => {
                                            const chk = row.querySelector('[id^="k8s-svc-vct-chk-"]');
                                            if (!chk || !chk.checked) return;
                                            const ps = chk.id.split('-');
                                            const j = ps[ps.length - 1];
                                            const name = _v('k8s-svc-vct-name-' + i + '-' + j);
                                            const mountPath = _v('k8s-svc-vct-mount-' + i + '-' + j);
                                            if (!mountPath) return;
                                            vcts.push({
                                                name: name || 'data-' + j,
                                                mountPath,
                                                size: _v('k8s-svc-vct-size-' + i + '-' + j) || '10Gi',
                                                accessMode: _v('k8s-svc-vct-access-' + i + '-' + j) || 'ReadWriteOnce',
                                                storageClass: _v('k8s-svc-vct-sc-' + i + '-' + j) || '',
                                            });
                                        });
                                        return vcts;
                                    })();
                                } else {
                                    // Deployment fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '8080';
                                    svcObj.replicas = _v(`k8s-svc-replicas-${i}`) || '2';
                                    svcObj.serviceType = _v(`k8s-svc-type-${i}`) || 'ClusterIP';
                                    svcObj.strategy = strategy;
                                    svcObj.maxSurge = strategy === 'RollingUpdate' ? (_v(`k8s-svc-maxsurge-${i}`) || '1') : null;
                                    svcObj.maxUnavailable = strategy === 'RollingUpdate' ? (_v(`k8s-svc-maxunavail-${i}`) || '1') : null;
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    svcObj.volumes = window._collectVolumes(i);
                                }

                                // Collect init containers (shared across all non-Skip/Managed kinds)
                                svcObj.initContainers = (() => {
                                    const inits = [];
                                    const initList = document.getElementById('k8s-svc-init-list-' + i);
                                    if (!initList) return inits;
                                    initList.querySelectorAll('.k8s-init-row').forEach(row => {
                                        const j = row.dataset.j;
                                        const name = _v('k8s-svc-init-name-' + i + '-' + j);
                                        const image = _v('k8s-svc-init-img-' + i + '-' + j);
                                        const command = _v('k8s-svc-init-cmd-' + i + '-' + j);
                                        if (!name && !image) return;
                                        inits.push({ name: name || 'init-' + j, image: image || 'busybox:1.36', command: command || '' });
                                    });
                                    return inits;
                                })();

                                // Collect sidecar containers
                                svcObj.sidecars = (() => {
                                    const scs = [];
                                    const scList = document.getElementById('k8s-svc-sc-list-' + i);
                                    if (!scList) return scs;
                                    scList.querySelectorAll('.k8s-sc-row').forEach(row => {
                                        const j = row.dataset.j;
                                        const name = _v('k8s-svc-sc-name-' + i + '-' + j);
                                        const image = _v('k8s-svc-sc-img-' + i + '-' + j);
                                        const command = _v('k8s-svc-sc-cmd-' + i + '-' + j);
                                        if (!name && !image) return;
                                        const nativeEl = document.getElementById('k8s-svc-sc-native-' + i + '-' + j);
                                        const sc = {
                                            name: name || 'sidecar-' + j,
                                            image: image || '',
                                            command: command || '',
                                            nativeSidecar: nativeEl ? nativeEl.checked : true,
                                        };
                                        const sharedVol = _v('k8s-svc-sc-shvol-' + i + '-' + j);
                                        if (sharedVol) {
                                            sc.sharedVolume = sharedVol;
                                            sc.sharedMount = _v('k8s-svc-sc-shmount-' + i + '-' + j) || '/shared';
                                        }
                                        scs.push(sc);
                                    });
                                    return scs;
                                })();

                                // Collect service mesh config
                                const meshEl = document.getElementById('k8s-svc-mesh-enable-' + i);
                                if (meshEl && meshEl.checked) {
                                    const provSel = document.getElementById('k8s-svc-mesh-provider-' + i);
                                    svcObj.mesh = {
                                        provider: provSel ? provSel.value : 'istio',
                                        proxyCpuRequest: _v('k8s-svc-mesh-cpureq-' + i) || '100m',
                                        proxyCpuLimit: _v('k8s-svc-mesh-cpulim-' + i) || '500m',
                                        proxyMemRequest: _v('k8s-svc-mesh-memreq-' + i) || '128Mi',
                                        proxyMemLimit: _v('k8s-svc-mesh-memlim-' + i) || '256Mi',
                                        excludeInbound: _v('k8s-svc-mesh-exin-' + i) || '',
                                        excludeOutbound: _v('k8s-svc-mesh-exout-' + i) || '',
                                        logLevel: _v('k8s-svc-mesh-log-' + i) || 'warning',
                                    };
                                }

                                services.push(svcObj);
                            }
                        } else if (mode === 'modules') {
                            for (let i = 0; i < appCount; i++) {
                                const chk = document.getElementById(`k8s-svc-chk-${i}`);
                                if (!chk || !chk.checked) continue;
                                // Skip services moved into another pod as companions
                                const srcCard = document.getElementById(`k8s-svc-card-${i}`);
                                if (srcCard && srcCard.style.display === 'none') continue;

                                // Resource limits â€” only include non-empty values
                                const cpuReq = _v(`k8s-svc-cpu-req-${i}`);
                                const cpuLim = _v(`k8s-svc-cpu-lim-${i}`);
                                const memReq = _v(`k8s-svc-mem-req-${i}`);
                                const memLim = _v(`k8s-svc-mem-lim-${i}`);
                                const hasResources = cpuReq || cpuLim || memReq || memLim;

                                // Strategy
                                const strategy = _v(`k8s-svc-strategy-${i}`) || 'RollingUpdate';

                                // Probe collection helper
                                const _collectProbe = (prefix) => {
                                    const enableEl = document.getElementById(`${prefix}-enable`);
                                    if (!enableEl || !enableEl.checked) return null;
                                    const probeType = _v(`${prefix}-type`) || 'http';
                                    const probe = {
                                        type: probeType,
                                        initialDelaySeconds: parseInt(_v(`${prefix}-delay`)) || 0,
                                        periodSeconds: parseInt(_v(`${prefix}-period`)) || 10,
                                    };
                                    if (probeType === 'http') {
                                        probe.path = _v(`${prefix}-path`) || '/health';
                                        probe.port = parseInt(_v(`${prefix}-port`)) || 8080;
                                    } else if (probeType === 'tcp') {
                                        probe.port = parseInt(_v(`${prefix}-port`)) || 8080;
                                    } else {
                                        probe.command = _v(`${prefix}-cmd`) || '';
                                    }
                                    probe.extra = parseInt(_v(`${prefix}-extra`)) || 3;
                                    return probe;
                                };

                                const selectedKind = _v(`k8s-svc-kind-${i}`) || 'Deployment';
                                if (selectedKind === 'Skip') continue;
                                const isJobKind = selectedKind === 'Job' || selectedKind === 'CronJob';

                                const svcObj = {
                                    name: deployableModules[i].name,
                                    kind: selectedKind,
                                    image: _v(`k8s-svc-img-${i}`) || `${deployableModules[i].name}:latest`,
                                    envVars: window._collectEnvVars(i),
                                    resources: hasResources ? {
                                        cpu_request: cpuReq || null,
                                        cpu_limit: cpuLim || null,
                                        memory_request: memReq || null,
                                        memory_limit: memLim || null,
                                    } : null,
                                    companions: _collectCompanionData(i),
                                    dependencies: (() => {
                                        const deps = [];
                                        document.querySelectorAll('.k8s-dep-' + i + ':checked')
                                            .forEach(el => deps.push(el.value));
                                        return deps;
                                    })(),
                                };

                                if (isJobKind) {
                                    // Job-specific fields
                                    svcObj.command = _v(`k8s-svc-job-cmd-${i}`) || '';
                                    svcObj.args = _v(`k8s-svc-job-args-${i}`) || '';
                                    svcObj.restartPolicy = _v(`k8s-svc-job-restart-${i}`) || 'Never';
                                    svcObj.backoffLimit = parseInt(_v(`k8s-svc-job-backoff-${i}`)) || 3;
                                    svcObj.completions = parseInt(_v(`k8s-svc-job-completions-${i}`)) || 1;
                                    svcObj.parallelism = parseInt(_v(`k8s-svc-job-parallelism-${i}`)) || 1;
                                    const timeout = _v(`k8s-svc-job-timeout-${i}`);
                                    if (timeout) svcObj.activeDeadlineSeconds = parseInt(timeout);
                                    svcObj.ttlSecondsAfterFinished = parseInt(_v(`k8s-svc-job-ttl-${i}`)) || 3600;

                                    if (selectedKind === 'CronJob') {
                                        svcObj.schedule = _v(`k8s-svc-cron-schedule-${i}`) || '*/5 * * * *';
                                        svcObj.concurrencyPolicy = _v(`k8s-svc-cron-concurrency-${i}`) || 'Forbid';
                                        const suspendEl = document.getElementById(`k8s-svc-cron-suspend-${i}`);
                                        svcObj.suspend = suspendEl ? suspendEl.checked : false;
                                        svcObj.successfulJobsHistoryLimit = parseInt(_v(`k8s-svc-cron-success-${i}`)) || 3;
                                        svcObj.failedJobsHistoryLimit = parseInt(_v(`k8s-svc-cron-failed-${i}`)) || 1;
                                        const deadline = _v(`k8s-svc-cron-deadline-${i}`);
                                        if (deadline) svcObj.startingDeadlineSeconds = parseInt(deadline);
                                    }
                                } else if (selectedKind === 'DaemonSet') {
                                    // DaemonSet-specific fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '';
                                    const dsStrategy = _v(`k8s-svc-ds-strategy-${i}`) || 'RollingUpdate';
                                    svcObj.strategy = dsStrategy;
                                    svcObj.maxUnavailable = dsStrategy === 'RollingUpdate' ? (_v(`k8s-svc-ds-maxunavail-${i}`) || '1') : null;
                                    svcObj.nodeSelector = _v(`k8s-svc-ds-nodeselector-${i}`) || '';
                                    // Tolerations
                                    const tols = [];
                                    const tolCpEl = document.getElementById(`k8s-svc-ds-tol-cp-${i}`);
                                    if (tolCpEl && tolCpEl.checked) tols.push({ key: 'node-role.kubernetes.io/control-plane', effect: 'NoSchedule', operator: 'Exists' });
                                    const tolNsEl = document.getElementById(`k8s-svc-ds-tol-nosched-${i}`);
                                    if (tolNsEl && tolNsEl.checked) tols.push({ key: '', operator: 'Exists', effect: 'NoSchedule' });
                                    svcObj.tolerations = tols;
                                    // Host access
                                    const hnEl = document.getElementById(`k8s-svc-ds-hostnet-${i}`);
                                    svcObj.hostNetwork = hnEl ? hnEl.checked : false;
                                    const hpEl = document.getElementById(`k8s-svc-ds-hostpid-${i}`);
                                    svcObj.hostPID = hpEl ? hpEl.checked : false;
                                    const hiEl = document.getElementById(`k8s-svc-ds-hostipc-${i}`);
                                    svcObj.hostIPC = hiEl ? hiEl.checked : false;
                                    // Health checks + volumes (shared with Deployment)
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    svcObj.volumes = window._collectVolumes(i);
                                } else if (selectedKind === 'StatefulSet') {
                                    // StatefulSet-specific fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '8080';
                                    svcObj.replicas = _v(`k8s-svc-replicas-${i}`) || '1';
                                    svcObj.headlessServiceName = _v(`k8s-svc-ss-headless-${i}`) || `${deployableModules[i].name}-headless`;
                                    svcObj.podManagementPolicy = _v(`k8s-svc-ss-podmgmt-${i}`) || 'OrderedReady';
                                    const ssClusterIpEl = document.getElementById(`k8s-svc-ss-clusterip-${i}`);
                                    svcObj.alsoCreateClusterIP = ssClusterIpEl ? ssClusterIpEl.checked : false;
                                    const ssStrategy = _v(`k8s-svc-ss-strategy-${i}`) || 'RollingUpdate';
                                    svcObj.strategy = ssStrategy;
                                    svcObj.partition = ssStrategy === 'RollingUpdate' ? (parseInt(_v(`k8s-svc-ss-partition-${i}`)) || 0) : null;
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    // Collect volumeClaimTemplates
                                    svcObj.volumeClaimTemplates = (() => {
                                        const vcts = [];
                                        const vctList = document.getElementById('k8s-svc-vct-list-' + i);
                                        if (!vctList) return vcts;
                                        vctList.querySelectorAll('.k8s-vct-row').forEach(row => {
                                            const chk = row.querySelector('[id^="k8s-svc-vct-chk-"]');
                                            if (!chk || !chk.checked) return;
                                            const ps = chk.id.split('-');
                                            const j = ps[ps.length - 1];
                                            const name = _v('k8s-svc-vct-name-' + i + '-' + j);
                                            const mountPath = _v('k8s-svc-vct-mount-' + i + '-' + j);
                                            if (!mountPath) return;
                                            vcts.push({
                                                name: name || 'data-' + j,
                                                mountPath,
                                                size: _v('k8s-svc-vct-size-' + i + '-' + j) || '10Gi',
                                                accessMode: _v('k8s-svc-vct-access-' + i + '-' + j) || 'ReadWriteOnce',
                                                storageClass: _v('k8s-svc-vct-sc-' + i + '-' + j) || '',
                                            });
                                        });
                                        return vcts;
                                    })();
                                } else {
                                    // Deployment fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '8080';
                                    svcObj.replicas = _v(`k8s-svc-replicas-${i}`) || '2';
                                    svcObj.serviceType = _v(`k8s-svc-type-${i}`) || 'ClusterIP';
                                    svcObj.strategy = strategy;
                                    svcObj.maxSurge = strategy === 'RollingUpdate' ? (_v(`k8s-svc-maxsurge-${i}`) || '1') : null;
                                    svcObj.maxUnavailable = strategy === 'RollingUpdate' ? (_v(`k8s-svc-maxunavail-${i}`) || '1') : null;
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    svcObj.volumes = window._collectVolumes(i);
                                }

                                // Collect init containers (shared across all non-Skip/Managed kinds)
                                svcObj.initContainers = (() => {
                                    const inits = [];
                                    const initList = document.getElementById('k8s-svc-init-list-' + i);
                                    if (!initList) return inits;
                                    initList.querySelectorAll('.k8s-init-row').forEach(row => {
                                        const j = row.dataset.j;
                                        const name = _v('k8s-svc-init-name-' + i + '-' + j);
                                        const image = _v('k8s-svc-init-img-' + i + '-' + j);
                                        const command = _v('k8s-svc-init-cmd-' + i + '-' + j);
                                        if (!name && !image) return;
                                        inits.push({ name: name || 'init-' + j, image: image || 'busybox:1.36', command: command || '' });
                                    });
                                    return inits;
                                })();

                                // Collect sidecar containers
                                svcObj.sidecars = (() => {
                                    const scs = [];
                                    const scList = document.getElementById('k8s-svc-sc-list-' + i);
                                    if (!scList) return scs;
                                    scList.querySelectorAll('.k8s-sc-row').forEach(row => {
                                        const j = row.dataset.j;
                                        const name = _v('k8s-svc-sc-name-' + i + '-' + j);
                                        const image = _v('k8s-svc-sc-img-' + i + '-' + j);
                                        const command = _v('k8s-svc-sc-cmd-' + i + '-' + j);
                                        if (!name && !image) return;
                                        const nativeEl = document.getElementById('k8s-svc-sc-native-' + i + '-' + j);
                                        const sc = {
                                            name: name || 'sidecar-' + j,
                                            image: image || '',
                                            command: command || '',
                                            nativeSidecar: nativeEl ? nativeEl.checked : true,
                                        };
                                        const sharedVol = _v('k8s-svc-sc-shvol-' + i + '-' + j);
                                        if (sharedVol) {
                                            sc.sharedVolume = sharedVol;
                                            sc.sharedMount = _v('k8s-svc-sc-shmount-' + i + '-' + j) || '/shared';
                                        }
                                        scs.push(sc);
                                    });
                                    return scs;
                                })();

                                // Collect service mesh config
                                const meshEl = document.getElementById('k8s-svc-mesh-enable-' + i);
                                if (meshEl && meshEl.checked) {
                                    const provSel = document.getElementById('k8s-svc-mesh-provider-' + i);
                                    svcObj.mesh = {
                                        provider: provSel ? provSel.value : 'istio',
                                        proxyCpuRequest: _v('k8s-svc-mesh-cpureq-' + i) || '100m',
                                        proxyCpuLimit: _v('k8s-svc-mesh-cpulim-' + i) || '500m',
                                        proxyMemRequest: _v('k8s-svc-mesh-memreq-' + i) || '128Mi',
                                        proxyMemLimit: _v('k8s-svc-mesh-memlim-' + i) || '256Mi',
                                        excludeInbound: _v('k8s-svc-mesh-exin-' + i) || '',
                                        excludeOutbound: _v('k8s-svc-mesh-exout-' + i) || '',
                                        logLevel: _v('k8s-svc-mesh-log-' + i) || 'warning',
                                    };
                                }

                                services.push(svcObj);
                            }
                        } else {
                            // Manual
                            services.push({
                                name: _v('k8s-svc-name-manual') || 'app',
                                kind: 'Deployment',
                                image: _v('k8s-svc-img-manual') || 'app:latest',
                                port: _v('k8s-svc-port-manual') || '8080',
                                replicas: _v('k8s-svc-replicas-manual') || '2',
                                serviceType: _v('k8s-svc-type-manual') || 'ClusterIP',
                            });
                        }

                        // â”€â”€ Collect infrastructure services (dynamic â€” iterate DOM cards) â”€â”€
                        const infraDecisions = [];
                        const infraListEl = document.getElementById('k8s-infra-list');
                        if (infraListEl) {
                            infraListEl.querySelectorAll('[data-infra-name]').forEach(card => {
                                const svcName = card.dataset.infraName;
                                const kindSel = document.getElementById('k8s-infra-kind-' + svcName);
                                const decision = kindSel ? kindSel.value : 'Skip';
                                if (decision === 'Skip') return;
                                const infraId = 'infra-' + svcName;
                                const svcData = (window._k8sInfraData || new Map()).get(svcName) || {};
                                const infraObj = {
                                    name: svcName,
                                    kind: decision,
                                    image: svcData.image || svcName,
                                    port: svcData.ports && svcData.ports.length > 0 ? String(svcData.ports[0].container) : '',
                                    envVars: window._collectEnvVars(infraId),
                                    _compose: svcData,
                                };
                                if (decision !== 'Managed') {
                                    infraObj.volumes = window._collectVolumes(infraId);
                                }
                                if (decision === 'Managed') {
                                    infraObj.providerNotes = _v('k8s-infra-provider-' + svcName) || '';
                                }
                                infraDecisions.push(infraObj);
                            });
                        }

                        // â”€â”€ Store full multi-service config â”€â”€
                        data._services = services;
                        data._infraDecisions = infraDecisions;

                        // â”€â”€ Cluster settings â”€â”€
                        data.namespace = mfVal('k8s-namespace') || 'default';
                        data.output_dir = mfVal('k8s-output-dir') || 'k8s/';
                        data.ingress = mfVal('k8s-ingress');
                        const skaffoldChk = document.getElementById('k8s-skaffold-toggle');
                        data.skaffold = skaffoldChk ? skaffoldChk.checked : true;
                        // data.configmap removed â€” ConfigMaps auto-generated per service from envVars

                        // â”€â”€ Backward compat: flat fields from primary service â”€â”€
                        if (services.length > 0) {
                            data.app_name = services[0].name;
                            data.image = services[0].image;
                            data.port = services[0].port;
                            data.replicas = services[0].replicas;
                            data.service_type = services[0].serviceType;
                        }

                        // â”€â”€ Persist wizard state (fire-and-forget) â”€â”€
                        try {
                            const stateToSave = {
                                _services: data._services,
                                _infraDecisions: data._infraDecisions,
                                namespace: data.namespace,
                                output_dir: data.output_dir,
                                ingress: data.ingress,
                                skaffold: data.skaffold,
                            };
                            api('/k8s/wizard-state', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(stateToSave),
                            }).catch(() => {}); // silent â€” saving is best-effort
                        } catch (_) {}
                    },
                    validate: (data) => {
                        if (!data._services || data._services.length === 0) return 'At least one service must be selected';
                        for (const svc of data._services) {
                            if (!svc.image) return `Container image is required for ${svc.name}`;
                            // Kind-aware validation
                            if (svc.kind === 'CronJob' && !svc.schedule) {
                                return `Schedule is required for CronJob ${svc.name}`;
                            }
                            // Validate resource quantity formats
                            if (svc.resources) {
                                const r = svc.resources;
                                const qtyRx = /^\d+(\.\d+)?(m|Mi|Gi|Ki|Ti|M|G|K|T)?$/;
                                if (r.cpu_request && !qtyRx.test(r.cpu_request)) return `Invalid CPU request format for ${svc.name} â€” use e.g. 100m, 0.5, 1`;
                                if (r.cpu_limit && !qtyRx.test(r.cpu_limit)) return `Invalid CPU limit format for ${svc.name} â€” use e.g. 500m, 1, 2`;
                                if (r.memory_request && !qtyRx.test(r.memory_request)) return `Invalid memory request format for ${svc.name} â€” use e.g. 128Mi, 1Gi`;
                                if (r.memory_limit && !qtyRx.test(r.memory_limit)) return `Invalid memory limit format for ${svc.name} â€” use e.g. 256Mi, 1Gi`;
                            }
                        }
                        return null;
                    },
                },

                // â”€â”€ Step 3: Review & Apply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'review', title: 'Review & Apply',
                    render: (data, el) => {
                        const services = data._services || [];
                        const infraDecisions = data._infraDecisions || [];

                        // Build review items from all services
                        const items = [];

                        for (const svc of services) {
                            const isJobKind = svc.kind === 'Job' || svc.kind === 'CronJob';

                            if (isJobKind) {
                                // Job/CronJob review
                                const jobInfo = svc.command ? `cmd: ${svc.command}${svc.args ? ' ' + svc.args : ''}` : svc.image;
                                const cronStr = svc.kind === 'CronJob' ? ` Â· schedule: ${svc.schedule || '?'}` : '';
                                items.push({
                                    icon: _kindIcon(svc.kind),
                                    label: `${svc.kind}: ${svc.name}`,
                                    value: `${jobInfo}${cronStr}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                                // Job details sub-items
                                const jobDetails = [];
                                if (svc.backoffLimit) jobDetails.push(`backoff: ${svc.backoffLimit}`);
                                if (svc.completions > 1) jobDetails.push(`completions: ${svc.completions}`);
                                if (svc.parallelism > 1) jobDetails.push(`parallelism: ${svc.parallelism}`);
                                if (svc.activeDeadlineSeconds) jobDetails.push(`timeout: ${svc.activeDeadlineSeconds}s`);
                                if (svc.ttlSecondsAfterFinished) jobDetails.push(`TTL: ${svc.ttlSecondsAfterFinished}s`);
                                if (jobDetails.length > 0) {
                                    items.push({
                                        icon: 'âš™ï¸',
                                        label: `  â”” job settings`,
                                        value: jobDetails.join(' Â· '),
                                        badge: '',
                                        badgeCls: 'muted',
                                    });
                                }
                                if (svc.kind === 'CronJob') {
                                    const cronDetails = [];
                                    cronDetails.push(`concurrency: ${svc.concurrencyPolicy || 'Forbid'}`);
                                    if (svc.startingDeadlineSeconds) cronDetails.push(`deadline: ${svc.startingDeadlineSeconds}s`);
                                    if (svc.suspend) cronDetails.push('SUSPENDED');
                                    cronDetails.push(`keep: ${svc.successfulJobsHistoryLimit || 3}âœ“ / ${svc.failedJobsHistoryLimit || 1}âœ—`);
                                    items.push({
                                        icon: 'â°',
                                        label: `  â”” cron settings`,
                                        value: cronDetails.join(' Â· '),
                                        badge: '',
                                        badgeCls: 'muted',
                                    });
                                }
                            } else if (svc.kind === 'DaemonSet') {
                                // DaemonSet review
                                const dsStratStr = svc.strategy === 'OnDelete' ? ' Â· OnDelete' : ` Â· Rolling(â†“${svc.maxUnavailable || 1})`;
                                items.push({
                                    icon: _kindIcon(svc.kind),
                                    label: `${svc.kind}: ${svc.name}`,
                                    value: `one per node Â· ${svc.image}${dsStratStr}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                                // DaemonSet details sub-items
                                const dsDetails = [];
                                if (svc.nodeSelector) dsDetails.push(`nodes: ${svc.nodeSelector}`);
                                if (svc.tolerations && svc.tolerations.length > 0) dsDetails.push(`tolerations: ${svc.tolerations.length}`);
                                if (svc.hostNetwork) dsDetails.push('hostNet');
                                if (svc.hostPID) dsDetails.push('hostPID');
                                if (svc.hostIPC) dsDetails.push('hostIPC');
                                if (dsDetails.length > 0) {
                                    items.push({
                                        icon: 'ğŸ¯',
                                        label: `  â”” node config`,
                                        value: dsDetails.join(' Â· '),
                                        badge: '',
                                        badgeCls: 'muted',
                                    });
                                }
                                if (svc.port) {
                                    items.push({
                                        icon: 'ğŸŒ',
                                        label: `Service: ${svc.name}`,
                                        value: `ClusterIP â†’ port ${svc.port}`,
                                        badge: 'create',
                                        badgeCls: 'ready',
                                    });
                                }
                            } else if (svc.kind === 'StatefulSet') {
                                // StatefulSet review
                                const ssStratStr = svc.strategy === 'OnDelete' ? ' Â· OnDelete'
                                    : svc.partition > 0 ? ` Â· Rolling(partition=${svc.partition})`
                                    : ' Â· RollingUpdate';
                                items.push({
                                    icon: _kindIcon(svc.kind),
                                    label: `${svc.kind}: ${svc.name}`,
                                    value: `${svc.replicas || '?'} replica${svc.replicas !== '1' ? 's' : ''} of ${svc.image}${ssStratStr}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                                // Headless service
                                items.push({
                                    icon: 'ğŸŒ',
                                    label: `Headless: ${svc.headlessServiceName || svc.name + '-headless'}`,
                                    value: `ClusterIP: None â†’ port ${svc.port}${svc.alsoCreateClusterIP ? ' (+ClusterIP)' : ''}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                                // StatefulSet details
                                const ssDetails = [];
                                ssDetails.push(`pods: ${svc.podManagementPolicy || 'OrderedReady'}`);
                                if (svc.volumeClaimTemplates && svc.volumeClaimTemplates.length > 0) {
                                    ssDetails.push(`VCTs: ${svc.volumeClaimTemplates.length}`);
                                    const totalSize = svc.volumeClaimTemplates.map(v => v.size).join('+');
                                    ssDetails.push(`size: ${totalSize}`);
                                }
                                items.push({
                                    icon: 'ğŸ—„ï¸',
                                    label: `  â”” stateful config`,
                                    value: ssDetails.join(' Â· '),
                                    badge: '',
                                    badgeCls: 'muted',
                                });
                                // Individual VCT details
                                if (svc.volumeClaimTemplates && svc.volumeClaimTemplates.length > 0) {
                                    for (const vct of svc.volumeClaimTemplates) {
                                        const scLabel = vct.storageClass ? ` (${vct.storageClass})` : '';
                                        items.push({
                                            icon: 'ğŸ’¾',
                                            label: `  â”” VCT: ${vct.name}`,
                                            value: `${vct.size} ${vct.accessMode}${scLabel} â†’ ${vct.mountPath}`,
                                            badge: 'create',
                                            badgeCls: 'ready',
                                        });
                                    }
                                }
                            } else {
                                // Deployment review
                                const stratStr = svc.strategy === 'Recreate' ? ' Â· Recreate'
                                    : svc.maxSurge || svc.maxUnavailable ? ` Â· Rolling(â†‘${svc.maxSurge || 1}/â†“${svc.maxUnavailable || 1})`
                                    : '';
                                items.push({
                                    icon: _kindIcon(svc.kind),
                                    label: `${svc.kind}: ${svc.name}`,
                                    value: `${svc.replicas || '?'} replica${svc.replicas !== '1' ? 's' : ''} of ${svc.image}${stratStr}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                                items.push({
                                    icon: 'ğŸŒ',
                                    label: `Service: ${svc.name}`,
                                    value: `${svc.serviceType} â†’ port ${svc.port}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                            }
                            // Dependencies (wait-for init containers will be generated)
                            if (svc.dependencies && svc.dependencies.length > 0) {
                                items.push({
                                    icon: 'ğŸ”—',
                                    label: `  â”” dependencies`,
                                    value: svc.dependencies.join(', ') + ' (wait-for init containers)',
                                    badge: '',
                                    badgeCls: 'muted',
                                });
                            }
                            // Companion containers (same pod)
                            if (svc.companions && svc.companions.length > 0) {
                                for (const comp of svc.companions) {
                                    const extras = [];
                                    if (comp.env && comp.env.length > 0) extras.push(`${comp.env.length} env`);
                                    if (comp.resources) extras.push('resources');
                                    if (comp.volumes && comp.volumes.length > 0) extras.push(`${comp.volumes.length} vol`);
                                    if (comp.dependsOn) extras.push(`waits-for: ${comp.dependsOn}`);
                                    const extraStr = extras.length > 0 ? ` (${extras.join(', ')})` : '';
                                    items.push({
                                        icon: 'ğŸ“¦',
                                        label: `  â”” companion: ${comp.name}`,
                                        value: `${comp.image}${comp.port ? ' :' + comp.port : ''}${extraStr}`,
                                        badge: 'pod',
                                        badgeCls: 'muted',
                                    });
                                }
                            }
                            // Init containers
                            if (svc.initContainers && svc.initContainers.length > 0) {
                                for (const init of svc.initContainers) {
                                    items.push({
                                        icon: 'â³',
                                        label: `  â”” init: ${init.name}`,
                                        value: `${init.image}${init.command ? ' â†’ ' + init.command.substring(0, 50) + (init.command.length > 50 ? 'â€¦' : '') : ''}`,
                                        badge: 'init',
                                        badgeCls: 'muted',
                                    });
                                }
                            }
                            // Sidecar containers
                            if (svc.sidecars && svc.sidecars.length > 0) {
                                for (const sc of svc.sidecars) {
                                    items.push({
                                        icon: 'ğŸ“',
                                        label: `  â”” sidecar: ${sc.name}`,
                                        value: `${sc.image}${sc.nativeSidecar ? ' (native)' : ''}${sc.sharedVolume ? ' ğŸ“ ' + sc.sharedVolume : ''}`,
                                        badge: 'sidecar',
                                        badgeCls: 'muted',
                                    });
                                }
                            }
                            // Service mesh
                            if (svc.mesh) {
                                const m = svc.mesh;
                                const provName = { istio: 'Istio', linkerd: 'Linkerd', consul: 'Consul', kuma: 'Kuma' }[m.provider] || m.provider;
                                items.push({
                                    icon: 'ğŸ”·',
                                    label: `  â”” ${provName} mesh`,
                                    value: `proxy CPU ${m.proxyCpuRequest}â†’${m.proxyCpuLimit} / Mem ${m.proxyMemRequest}â†’${m.proxyMemLimit}`,
                                    badge: 'annotations',
                                    badgeCls: 'muted',
                                });
                            }
                            // Resource limits (if configured)
                            if (svc.resources) {
                                const r = svc.resources;
                                const cpuStr = (r.cpu_request || r.cpu_limit) ? `CPU ${r.cpu_request || 'â€”'}â†’${r.cpu_limit || 'â€”'}` : '';
                                const memStr = (r.memory_request || r.memory_limit) ? `Mem ${r.memory_request || 'â€”'}â†’${r.memory_limit || 'â€”'}` : '';
                                const resStr = [cpuStr, memStr].filter(Boolean).join(' / ');
                                if (resStr) {
                                    items.push({
                                        icon: 'ğŸ”§',
                                        label: `Resources: ${svc.name}`,
                                        value: resStr,
                                        badge: '',
                                        badgeCls: '',
                                    });
                                }
                            }
                            // Health probes (if configured)
                            const probeDesc = (p) => {
                                if (!p) return null;
                                if (p.type === 'http') return `HTTP ${p.path}:${p.port}`;
                                if (p.type === 'tcp') return `TCP :${p.port}`;
                                return `exec: ${(p.command || '').substring(0, 30)}${(p.command || '').length > 30 ? 'â€¦' : ''}`;
                            };
                            const rdyStr = probeDesc(svc.readinessProbe);
                            const livStr = probeDesc(svc.livenessProbe);
                            if (rdyStr || livStr) {
                                const parts = [];
                                if (rdyStr) parts.push(`Ready: ${rdyStr}`);
                                if (livStr) parts.push(`Live: ${livStr}`);
                                items.push({
                                    icon: 'ğŸ’“',
                                    label: `Probes: ${svc.name}`,
                                    value: parts.join(' / '),
                                    badge: '',
                                    badgeCls: '',
                                });
                            }
                            // Environment variables â€” ConfigMap + Secret summary
                            const ev = svc.envVars || [];
                            const evHc = ev.filter(e => e.type === 'hardcoded').length;
                            const evVr = ev.filter(e => e.type === 'variable').length;
                            const evSc = ev.filter(e => e.type === 'secret').length;
                            if (evHc + evVr > 0) {
                                items.push({
                                    icon: 'ğŸ“‹',
                                    label: `ConfigMap: ${svc.name}-config`,
                                    value: `${evHc} hardcoded${evVr > 0 ? `, ${evVr} \${VAR}` : ''}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                            }
                            if (evSc > 0) {
                                items.push({
                                    icon: 'ğŸ”’',
                                    label: `Secret: ${svc.name}-secrets`,
                                    value: `${evSc} key${evSc !== 1 ? 's' : ''} (\${VAR} at deploy)`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                            }
                            // Vault vars/secrets to be created on execution
                            const toCreate = ev.filter(e => e.createInVault);
                            toCreate.forEach(e => {
                                const vaultKey = (e.varName || '').replace(/^\$\{/, '').replace(/\}$/, '') || e.key;
                                items.push({
                                    icon: 'ğŸ—ï¸',
                                    label: `Vault: Create ${vaultKey}`,
                                    value: e.newValue ? 'with generated value' : 'empty (set later)',
                                    badge: 'vault create',
                                    badgeCls: 'ready',
                                });
                            });
                            // Volume mounts â€” PVCs and other mounts
                            const vols = svc.volumes || [];
                            vols.forEach(vol => {
                                if (vol.type === 'pvc-dynamic' || vol.type === 'pvc-static') {
                                    const scLabel = vol.storageClass ? ` (${vol.storageClass})` : '';
                                    items.push({
                                        icon: 'ğŸ’¾',
                                        label: `PVC: ${vol.name}`,
                                        value: `${vol.size} ${vol.accessMode}${scLabel} â†’ ${vol.mountPath}`,
                                        badge: 'create',
                                        badgeCls: 'ready',
                                    });
                                } else if (vol.type === 'emptyDir') {
                                    const medLabel = vol.medium === 'Memory' ? ' (RAM)' : '';
                                    items.push({
                                        icon: 'ğŸ“‚',
                                        label: `emptyDir: ${vol.mountPath}`,
                                        value: `ephemeral${medLabel}${vol.sizeLimit ? ' limit ' + vol.sizeLimit : ''}`,
                                        badge: 'inline',
                                        badgeCls: 'muted',
                                    });
                                } else if (vol.type === 'configMap') {
                                    items.push({
                                        icon: 'ğŸ“„',
                                        label: `CM mount: ${vol.configMapName}`,
                                        value: `â†’ ${vol.mountPath}${vol.key ? ' (' + vol.key + ')' : ''}`,
                                        badge: 'ref',
                                        badgeCls: 'muted',
                                    });
                                } else if (vol.type === 'secret') {
                                    items.push({
                                        icon: 'ğŸ”',
                                        label: `Secret mount: ${vol.secretName}`,
                                        value: `â†’ ${vol.mountPath}${vol.key ? ' (' + vol.key + ')' : ''}`,
                                        badge: 'ref',
                                        badgeCls: 'muted',
                                    });
                                } else if (vol.type === 'hostPath') {
                                    items.push({
                                        icon: 'âš ï¸',
                                        label: `hostPath: ${vol.hostPath}`,
                                        value: `â†’ ${vol.mountPath} (${vol.hostType})`,
                                        badge: 'inline',
                                        badgeCls: 'muted',
                                    });
                                }
                            });
                        }

                        for (const infra of infraDecisions) {
                            const isManaged = infra.kind === 'Managed';
                            items.push({
                                icon: _kindIcon(infra.kind),
                                label: `${infra.kind}: ${infra.name}`,
                                value: isManaged ? (infra.providerNotes || 'External provider') : infra.image,
                                badge: isManaged ? 'external' : 'create',
                                badgeCls: isManaged ? 'muted' : 'ready',
                            });
                            // Env var summary for infra services (managed = connection vars; self-hosted = regular)
                            if (infra.envVars && infra.envVars.length > 0) {
                                const iev = infra.envVars;
                                const iHc = iev.filter(e => e.type === 'hardcoded').length;
                                const iVr = iev.filter(e => e.type === 'variable').length;
                                const iSc = iev.filter(e => e.type === 'secret').length;
                                if (isManaged) {
                                    items.push({
                                        icon: 'ğŸ”—',
                                        label: `  â”” connection vars`,
                                        value: `${iev.length} var${iev.length !== 1 ? 's' : ''} â†’ injected into dependent services`,
                                        badge: '',
                                        badgeCls: 'muted',
                                    });
                                } else {
                                    if (iHc + iVr > 0) {
                                        items.push({
                                            icon: 'ğŸ“‹',
                                            label: `  â”” ConfigMap: ${infra.name}-config`,
                                            value: `${iHc} hardcoded${iVr > 0 ? `, ${iVr} \${VAR}` : ''}`,
                                            badge: 'create',
                                            badgeCls: 'ready',
                                        });
                                    }
                                    if (iSc > 0) {
                                        items.push({
                                            icon: 'ğŸ”’',
                                            label: `  â”” Secret: ${infra.name}-secrets`,
                                            value: `${iSc} key${iSc !== 1 ? 's' : ''}`,
                                            badge: 'create',
                                            badgeCls: 'ready',
                                        });
                                    }
                                }
                            }
                            // Volume review for infra services
                            if (!isManaged && infra.volumes && infra.volumes.length > 0) {
                                infra.volumes.forEach(vol => {
                                    if (vol.type === 'pvc-dynamic' || vol.type === 'pvc-static') {
                                        const scLabel = vol.storageClass ? ` (${vol.storageClass})` : '';
                                        items.push({
                                            icon: 'ğŸ’¾',
                                            label: `  â”” PVC: ${vol.name}`,
                                            value: `${vol.size} ${vol.accessMode}${scLabel} â†’ ${vol.mountPath}`,
                                            badge: 'create',
                                            badgeCls: 'ready',
                                        });
                                    } else if (vol.type === 'emptyDir') {
                                        items.push({
                                            icon: 'ğŸ“‚',
                                            label: `  â”” emptyDir: ${vol.mountPath}`,
                                            value: `ephemeral${vol.medium === 'Memory' ? ' (RAM)' : ''}`,
                                            badge: 'inline',
                                            badgeCls: 'muted',
                                        });
                                    }
                                });
                            }
                        }

                        if (data.ingress) {
                            items.push({ icon: 'ğŸ”€', label: 'Ingress', value: 'HTTP routing rules', badge: 'create', badgeCls: 'ready' });
                        }
                        // ConfigMap checkbox removed â€” ConfigMaps/Secrets auto-generated per service from envVars
                        items.push({ icon: 'ğŸ“', label: 'Output directory', value: data.output_dir || 'k8s/', badge: '', badgeCls: '' });
                        items.push({ icon: 'ğŸ·ï¸', label: 'Namespace', value: data.namespace || 'default', badge: '', badgeCls: '' });
                        if (data.skaffold) {
                            items.push({ icon: 'ğŸ›¤', label: 'Skaffold pipeline', value: 'skaffold.yaml â€” build â†’ push â†’ deploy', badge: 'create', badgeCls: 'ready' });
                        }

                        el.innerHTML = `
                            ${wizSection('Review', `${services.length + infraDecisions.length} resource${(services.length + infraDecisions.length) !== 1 ? 's' : ''} will be generated.`)}
                            ${items.map(item => `<div class="wiz-review-item">
                                <span class="wiz-review-icon">${item.icon}</span>
                                <div class="wiz-review-content">
                                    <div class="wiz-review-label">${esc(item.label)}</div>
                                    <div class="wiz-review-value">${esc(item.value)}</div>
                                </div>
                                ${item.badge ? `<span class="wiz-review-badge ${item.badgeCls}">${item.badge}</span>` : ''}
                            </div>`).join('')}



                            <div style="margin-top:var(--space-md);padding:var(--space-xs) var(--space-sm);border-left:3px solid var(--accent);background:color-mix(in srgb, var(--accent) 5%, transparent);border-radius:0 6px 6px 0">
                                <div style="font-size:0.78rem;color:var(--text-secondary)">
                                    ğŸ’¡ <strong>Next:</strong> Set up CI/CD to automate builds and deployments.
                                    <button class="btn btn-sm btn-ghost" style="font-size:0.72rem;padding:0.1rem 0.4rem;margin-left:4px;color:var(--accent)"
                                        onclick="wizardModalClose();setTimeout(openCICDSetupWizard,300)">Set up CI/CD â†’</button>
                                </div>
                            </div>
                        `;
                    },
                },
            ],
            onComplete: async (data) => {
                const payload = {
                    action: 'setup_k8s',
                    // Full wizard state â€” the backend translator handles everything
                    _services: data._services,
                    _infraDecisions: data._infraDecisions,
                    namespace: data.namespace,
                    output_dir: data.output_dir,
                    ingress: data.ingress,
                    skaffold: data.skaffold,
                };
                await apiPost('/wizard/setup', payload);
                _projectStatusTS = 0;
                cardInvalidate('k8s');
            },
            successMessage: 'Kubernetes manifests generated!',
        });
    }


</script>
