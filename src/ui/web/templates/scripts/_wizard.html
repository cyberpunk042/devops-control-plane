<script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //  _wizard.html
    //  Setup Wizard â€” multi-step project configuration
    //  Steps: Welcome â†’ Modules â†’ Secrets â†’ Content â†’ Review
    //  Included by: index.html (Jinja2 include)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let currentWizardStep = 0;
    let wizardDirty = false;
    let _wizardConfig = null; // loaded config
    let _wizardDetected = null; // detected modules cache

    const wizardSteps = [
        { id: 'welcome',  title: 'Welcome',  icon: 'ğŸ‘‹' },
        { id: 'modules',  title: 'Modules',  icon: 'ğŸ”' },
        { id: 'secrets',  title: 'Secrets',  icon: 'ğŸ”' },
        { id: 'content',  title: 'Content',  icon: 'ğŸ“' },
        { id: 'review',   title: 'Review',   icon: 'âœ…' },
    ];

    // â”€â”€ Load config from backend â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function wizardLoadConfig() {
        try {
            const data = await api('/config');
            _wizardConfig = data.config;
            // Initialize _contentFolders from saved content_folders
            if (_wizardConfig.content_folders && _wizardConfig.content_folders.length) {
                _wizardConfig._contentFolders = [..._wizardConfig.content_folders];
            }
            return _wizardConfig;
        } catch (e) {
            toast(`Failed to load config: ${e.message}`, 'error');
            return null;
        }
    }

    /** Is the wizard config in multi-env mode? */
    function _wizIsMultiEnv() {
        const envs = (_wizardConfig && _wizardConfig.environments) || [];
        return envs.length > 1;
    }

    /** Compute .env file name for a given wizard env. */
    function _wizEnvFile(envName) {
        if (!_wizIsMultiEnv()) return '.env';
        return `.env.${envName}`;
    }

    /** Compute ?env= query param for a given wizard env. */
    function _wizEnvQS(envName) {
        if (!_wizIsMultiEnv()) return '';
        return `?env=${encodeURIComponent(envName)}`;
    }

    /** Quick-create a .env file for a given environment from the wizard. */
    async function wizardCreateEnv(envName, btnEl) {
        const envParam = _wizEnvQS(envName);
        const envFile = _wizEnvFile(envName);

        if (btnEl) {
            btnEl.disabled = true;
            btnEl.innerHTML = '<span class="spinner" style="width:12px;height:12px"></span>';
        }

        try {
            await api(`/vault/create${envParam}`, {
                method: 'POST',
                body: JSON.stringify({ template_sections: ['content_vault'] }),
            });
            toast(`${envFile} created with Content Vault key`, 'success');

            // Refresh this row to show updated status
            const row = document.getElementById(`wiz-env-vault-${envName}`);
            if (row) {
                row.innerHTML = `
                    <span style="font-size:1rem">ğŸ”“</span>
                    <code style="min-width:120px;font-size:0.8rem;font-weight:500">${esc(envFile)}</code>
                    <span style="flex:1;color:var(--text-muted);font-size:0.78rem">${envName}</span>
                    <span style="font-size:0.78rem;color:var(--success);font-weight:500">unlocked</span>
                `;
                row.style.borderColor = 'var(--success)';
            }
        } catch (e) {
            toast(`Failed to create ${envFile}: ${e.message}`, 'error');
            if (btnEl) {
                btnEl.disabled = false;
                btnEl.textContent = '+ Create';
            }
        }
    }

    /** Create a GitHub deployment environment from the wizard. */
    async function wizardCreateGhEnv(envName, btnEl) {
        if (btnEl) {
            btnEl.disabled = true;
            btnEl.innerHTML = '<span class="spinner" style="width:12px;height:12px"></span>';
        }

        try {
            await api('/gh/environment/create', {
                method: 'POST',
                body: JSON.stringify({ name: envName }),
            });
            toast(`GitHub environment "${envName}" created`, 'success');

            // Update the row in-place
            const row = btnEl?.closest('div[style*="display:flex"]');
            if (row) {
                row.style.borderColor = 'var(--success)';
                const statusSpan = row.querySelector('span[style*="font-weight:500"]:last-of-type');
                if (statusSpan) {
                    statusSpan.textContent = 'exists';
                    statusSpan.style.color = 'var(--success)';
                }
                // Replace âš ï¸ with âœ…
                const iconSpan = row.querySelector('span:first-child');
                if (iconSpan) iconSpan.textContent = 'âœ…';
                // Remove button
                if (btnEl) btnEl.remove();
            }
        } catch (e) {
            toast(`Failed to create environment: ${e.message}`, 'error');
            if (btnEl) {
                btnEl.disabled = false;
                btnEl.innerHTML = 'ğŸš€ Create';
            }
        }
    }

    // â”€â”€ Render wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderWizard() {
        // Sync URL hash with current wizard step
        const stepId = wizardSteps[currentWizardStep].id;
        history.replaceState(null, '', `#wizard/${stepId}`);

        // Render step indicators
        const stepsEl = document.getElementById('wizard-steps');
        stepsEl.innerHTML = wizardSteps.map((step, i) => {
            const cls = i === currentWizardStep ? 'active' : i < currentWizardStep ? 'done' : '';
            return `<div class="wizard-step ${cls}" onclick="wizardGoTo(${i})">
            <span class="wizard-step-num">${i < currentWizardStep ? 'âœ“' : i + 1}</span>
            <span class="wizard-step-label">${step.title}</span>
        </div>`;
        }).join('');

        // Render body
        const body = document.getElementById('wizard-body');
        body.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span></p>';

        const renderFn = _wizardRenderers[wizardSteps[currentWizardStep].id];
        if (renderFn) renderFn(body);

        // Update nav buttons
        document.getElementById('wizard-prev').style.display = currentWizardStep > 0 ? '' : 'none';
        const isLast = currentWizardStep === wizardSteps.length - 1;
        document.getElementById('wizard-next').style.display = isLast ? 'none' : '';
        document.getElementById('wizard-finish').style.display = isLast ? '' : 'none';
    }

    // â”€â”€ Step renderers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    const _wizardRenderers = {

        // â”€â”€ Step 1: Welcome â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        welcome: async (body) => {
            const cfg = _wizardConfig || await wizardLoadConfig();
            if (!cfg) {
                body.innerHTML = '<p class="empty-state" style="color:var(--error)">âŒ Could not load config.</p>';
                return;
            }

            body.innerHTML = `
                <h2 style="margin-bottom:1rem">ğŸ‘‹ Project Configuration</h2>
                <p style="color:var(--text-secondary);line-height:1.6;margin-bottom:1.5rem">
                    Configure your project's identity. These settings are stored in <code>project.yml</code>.
                </p>

                <div style="display:flex;flex-direction:column;gap:1rem">
                    <div>
                        <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:0.3rem;color:var(--text-secondary)">
                            Project Name <span style="color:var(--error)">*</span>
                        </label>
                        <input type="text" id="wiz-name" value="${esc(cfg.name)}"
                            placeholder="my-awesome-project"
                            style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);color:var(--text-primary);font-size:0.9rem"
                            oninput="wizardDirty=true">
                    </div>

                    <div>
                        <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:0.3rem;color:var(--text-secondary)">
                            Description
                        </label>
                        <textarea id="wiz-desc" rows="2"
                            placeholder="A brief description of the project"
                            style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);color:var(--text-primary);font-size:0.9rem;resize:vertical"
                            oninput="wizardDirty=true">${esc(cfg.description)}</textarea>
                    </div>

                    <div>
                        <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:0.3rem;color:var(--text-secondary)">
                            Repository
                        </label>
                        <input type="text" id="wiz-repo" value="${esc(cfg.repository)}"
                            placeholder="github.com/user/project"
                            style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);color:var(--text-primary);font-size:0.9rem;font-family:var(--font-mono)"
                            oninput="wizardDirty=true">
                    </div>

                    <div>
                        <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:0.3rem;color:var(--text-secondary)">
                            Domains
                        </label>
                        <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.4rem">
                            Logical groupings for your modules (e.g. library, ops, docs).
                        </p>
                        <div id="wiz-domains" style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:0.5rem">
                            ${(cfg.domains || []).map(d => `
                                <span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.25rem 0.6rem;background:var(--accent-glow);border:1px solid var(--accent);border-radius:16px;font-size:0.8rem;color:var(--accent)">
                                    ${esc(d)}
                                    <span style="cursor:pointer;opacity:0.6;font-size:0.7rem" onclick="wizardRemoveDomain(this,'${esc(d)}')" title="Remove">âœ•</span>
                                </span>
                            `).join('')}
                        </div>
                        <div style="display:flex;gap:0.4rem">
                            <input type="text" id="wiz-new-domain" placeholder="Add domainâ€¦"
                                style="flex:1;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-inset);color:var(--text-primary);font-size:0.82rem"
                                onkeydown="if(event.key==='Enter'){event.preventDefault();wizardAddDomain()}">
                            <button class="btn btn-secondary btn-sm" onclick="wizardAddDomain()" style="font-size:0.78rem">+ Add</button>
                        </div>
                    </div>

                    <div>
                        <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:0.3rem;color:var(--text-secondary)">
                            Environments
                        </label>
                        <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.4rem">
                            Deployment contexts (dev, staging, production).
                        </p>
                        <div id="wiz-envs" style="display:flex;flex-direction:column;gap:0.4rem;margin-bottom:0.5rem">
                            ${(cfg.environments || []).map((e, i) => `
                                <div style="display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0.5rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.82rem">
                                    <span style="font-weight:600;min-width:80px">${esc(e.name)}</span>
                                    <span style="color:var(--text-muted);flex:1">${esc(e.description || '')}</span>
                                    ${e.default ? '<span style="font-size:0.7rem;background:var(--accent-glow);color:var(--accent);padding:0.1rem 0.4rem;border-radius:8px">default</span>' : ''}
                                    <span style="cursor:pointer;opacity:0.5;font-size:0.7rem" onclick="wizardRemoveEnv(${i})" title="Remove">âœ•</span>
                                </div>
                            `).join('')}
                        </div>
                        <div style="display:flex;gap:0.4rem">
                            <input type="text" id="wiz-new-env-name" placeholder="Name"
                                style="width:100px;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-inset);color:var(--text-primary);font-size:0.82rem"
                                onkeydown="if(event.key==='Enter'){event.preventDefault();wizardAddEnv()}">
                            <input type="text" id="wiz-new-env-desc" placeholder="Description"
                                style="flex:1;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-inset);color:var(--text-primary);font-size:0.82rem"
                                onkeydown="if(event.key==='Enter'){event.preventDefault();wizardAddEnv()}">
                            <button class="btn btn-secondary btn-sm" onclick="wizardAddEnv()" style="font-size:0.78rem">+ Add</button>
                        </div>
                    </div>
                </div>

                <p style="color:var(--text-muted);margin-top:1.5rem;font-size:0.82rem">
                    ğŸ’¡ Click <strong>Next</strong> to continue. Changes are saved when you finish.
                </p>
            `;
        },

        // â”€â”€ Step 2: Modules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        modules: async (body) => {
            const cfg = _wizardConfig;
            const modules = cfg ? (cfg.modules || []) : [];

            body.innerHTML = `
                <h2 style="margin-bottom:1rem">ğŸ” Modules</h2>
                <p style="color:var(--text-secondary);line-height:1.6;margin-bottom:0.75rem">
                    Modules are the building blocks of your project â€” directories with their own stack and purpose.
                    The control plane uses them to run automations, detect stacks, and organize your codebase.
                </p>

                <div style="padding:0.75rem 1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:1rem;font-size:0.82rem;color:var(--text-muted);line-height:1.5">
                    ğŸ’¡ <strong>Not sure what this means?</strong> You can safely skip this step â€”
                    the current configuration is already working. You can always come back later
                    or use <strong>Auto-Detect</strong> to scan your project.
                </div>

                <div style="display:flex;gap:0.5rem;margin-bottom:1rem">
                    <button class="btn btn-primary btn-sm" onclick="wizardDetect()">ğŸ” Auto-Detect Modules</button>
                </div>

                <div id="wizard-modules-list" style="display:flex;flex-direction:column;gap:0.4rem">
                    ${modules.length ? modules.map((m, i) => _wizardModuleRow(m, i)).join('') : `
                        <p class="empty-state" style="padding:1.5rem">
                            No modules configured yet.<br>
                            <span style="font-size:0.82rem;color:var(--text-muted)">Click "Auto-Detect" to scan your project, or add modules manually.</span>
                        </p>
                    `}
                </div>

                <div style="margin-top:1rem;padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                    <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">â• Add Module</div>
                    <div style="display:flex;gap:0.4rem;flex-wrap:wrap">
                        <input type="text" id="wiz-mod-name" placeholder="Name"
                            style="width:120px;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-card);color:var(--text-primary);font-size:0.82rem">
                        <input type="text" id="wiz-mod-path" placeholder="Path (e.g. src/core)"
                            style="flex:1;min-width:150px;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-card);color:var(--text-primary);font-size:0.82rem;font-family:var(--font-mono)">
                        <input type="text" id="wiz-mod-stack" placeholder="Stack"
                            style="width:100px;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-card);color:var(--text-primary);font-size:0.82rem">
                        <button class="btn btn-secondary btn-sm" onclick="wizardAddModule()" style="font-size:0.78rem">+ Add</button>
                    </div>
                </div>
            `;
        },

        // â”€â”€ Step 3: Secrets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        secrets: async (body) => {
            const cfg = _wizardConfig || {};
            const envs = cfg.environments || [{ name: 'dev', default: true }];

            body.innerHTML = `
                <h2 style="margin-bottom:1rem">ğŸ” Secrets & Encryption</h2>
                <p style="color:var(--text-secondary);line-height:1.6;margin-bottom:1.5rem">
                    Each environment has its own <code>.env</code> file encrypted by the <strong>Vault</strong>.
                    The <strong>Content Encryption Key</strong> protects files managed by the content vault.
                </p>

                <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">
                    ğŸŒ Environment Vault Status
                </div>
                <div id="wiz-env-vault-list" style="display:flex;flex-direction:column;gap:0.35rem;margin-bottom:1.25rem">
                    ${envs.map(e => `
                        <div id="wiz-env-vault-${esc(e.name)}"
                             style="display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.85rem">
                            <span class="spinner" style="width:14px;height:14px"></span>
                            <code style="min-width:120px;font-size:0.8rem">${esc(_wizEnvFile(e.name))}</code>
                            <span style="flex:1;color:var(--text-muted);font-size:0.78rem">${esc(e.description || e.name)}${e.default ? ' â­' : ''}</span>
                            <span data-env-status="${esc(e.name)}" style="font-size:0.78rem;color:var(--text-muted)">checkingâ€¦</span>
                        </div>
                    `).join('')}
                </div>

                <div id="wiz-gh-integration" style="margin-bottom:1.25rem"></div>
                <div id="wiz-enc-key-status" style="margin-bottom:1rem"></div>
                <div id="wiz-secrets-list"></div>
            `;

            // â”€â”€ GitHub Integration auto-detect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            try {
                const [ghAuto, envKeys] = await Promise.all([
                    api('/gh/auto').catch(() => ({ token: null, repo: null })),
                    api('/vault/keys').catch(() => ({ keys: [] })),
                ]);

                const ghIntEl = document.getElementById('wiz-gh-integration');
                if (!ghIntEl) return;

                const existingRepo = (envKeys.keys || []).find(k => k.key === 'GITHUB_REPOSITORY');
                const repoInEnv = existingRepo && existingRepo.value;
                const detectedRepo = ghAuto.repo;

                let html = `
                    <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">
                        ğŸ”— GitHub Integration
                    </div>`;

                if (repoInEnv) {
                    html += `
                        <div style="display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--success);border-radius:8px;font-size:0.85rem">
                            <span>âœ…</span>
                            <code style="font-size:0.8rem;font-weight:500">GITHUB_REPOSITORY</code>
                            <span style="flex:1;color:var(--text-muted);font-size:0.78rem">${esc(existingRepo.value)}</span>
                            <span style="font-size:0.78rem;color:var(--success);font-weight:500">configured</span>
                        </div>`;
                } else if (detectedRepo) {
                    html += `
                        <div id="wiz-gh-repo-row" style="display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--warning);border-radius:8px;font-size:0.85rem">
                            <span>âš ï¸</span>
                            <code style="font-size:0.8rem;font-weight:500">GITHUB_REPOSITORY</code>
                            <span style="flex:1;font-size:0.78rem;color:var(--text-muted)">detected: <strong>${esc(detectedRepo)}</strong> â€” not in .env yet</span>
                            <button class="btn btn-sm btn-primary" style="font-size:0.72rem;padding:0.15rem 0.5rem"
                                onclick="wizardSaveGhRepo('${esc(detectedRepo)}', this)">ğŸ’¾ Save to .env</button>
                        </div>`;
                } else {
                    html += `
                        <div style="display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.85rem">
                            <span>â“</span>
                            <code style="font-size:0.8rem;font-weight:500">GITHUB_REPOSITORY</code>
                            <span style="flex:1;font-size:0.78rem;color:var(--text-muted)">could not detect â€” set manually in .env as <code>owner/repo</code></span>
                        </div>`;
                }

                html += `
                    <p style="color:var(--text-muted);font-size:0.75rem;margin-top:0.35rem">
                        ğŸ’¡ This is stored locally in .env only â€” never pushed to GitHub secrets.
                    </p>`;

                ghIntEl.innerHTML = html;
            } catch (_) {
                // gh CLI not available, skip
            }

            // â”€â”€ Fetch status for each environment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            for (const env of envs) {
                const envParam = _wizEnvQS(env.name);
                const envFile = _wizEnvFile(env.name);
                try {
                    const status = await api(`/vault/status${envParam}`);
                    const state = status.empty ? 'missing' : status.locked ? 'locked' : 'unlocked';
                    const stateColor = state === 'unlocked' ? 'var(--success)' :
                                       state === 'locked' ? 'var(--warning)' : 'var(--text-muted)';
                    const stateIcon = state === 'unlocked' ? 'ğŸ”“' :
                                      state === 'locked' ? 'ğŸ”’' : 'ğŸ“­';

                    // Create button for missing envs
                    const createBtn = state === 'missing'
                        ? `<button class="btn btn-sm" style="font-size:0.72rem;padding:0.15rem 0.5rem;border-radius:6px;margin-left:0.25rem" onclick="wizardCreateEnv('${esc(env.name)}',this)">+ Create</button>`
                        : '';

                    const row = document.getElementById(`wiz-env-vault-${env.name}`);
                    if (row) {
                        row.innerHTML = `
                            <span style="font-size:1rem">${stateIcon}</span>
                            <code style="min-width:120px;font-size:0.8rem;font-weight:500">${esc(envFile)}</code>
                            <span style="flex:1;color:var(--text-muted);font-size:0.78rem">${esc(env.description || env.name)}${env.default ? ' â­' : ''}</span>
                            <span style="font-size:0.78rem;color:${stateColor};font-weight:500">${state}</span>
                            ${createBtn}
                        `;
                        row.style.borderColor = state === 'unlocked' ? 'var(--success)' :
                                                state === 'locked' ? 'var(--warning)' : 'var(--border-subtle)';
                    }
                } catch (e) {
                    const row = document.getElementById(`wiz-env-vault-${env.name}`);
                    if (row) {
                        const spinner = row.querySelector('.spinner');
                        if (spinner) spinner.remove();
                        const statusEl = row.querySelector(`[data-env-status="${env.name}"]`);
                        if (statusEl) {
                            statusEl.textContent = 'error';
                            statusEl.style.color = 'var(--error)';
                        }
                    }
                }
            }

            // â”€â”€ GitHub Environment status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Only relevant in multi-env mode (single-env uses repo-level)
            try {
                const ghEnvData = await api('/gh/environments');
                const ghEnvs = (ghEnvData.environments || []).map(e => e.toLowerCase());

                if (_wizIsMultiEnv()) {
                    const ghEnvEl = document.getElementById('wiz-enc-key-status');
                    if (ghEnvEl) {
                        let ghSection = `
                            <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">
                                ğŸŒ GitHub Deployment Environments
                            </div>
                            <div style="display:flex;flex-direction:column;gap:0.3rem;margin-bottom:1.25rem">`;

                        for (const env of envs) {
                            const exists = ghEnvs.includes(env.name.toLowerCase());
                            const icon = exists ? 'âœ…' : 'âš ï¸';
                            const label = exists ? 'exists' : 'not found';
                            const color = exists ? 'var(--success)' : 'var(--warning)';
                            const createBtn = !exists
                                ? `<button class="btn btn-sm" style="font-size:0.72rem;padding:0.15rem 0.5rem;border-radius:6px;margin-left:0.25rem"
                                    onclick="wizardCreateGhEnv('${esc(env.name)}',this)">ğŸš€ Create</button>`
                                : '';

                            ghSection += `
                                <div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;background:var(--bg-inset);border:1px solid ${exists ? 'var(--success)' : 'var(--warning)'};border-radius:8px;font-size:0.82rem">
                                    <span>${icon}</span>
                                    <code style="min-width:120px;font-size:0.8rem;font-weight:500">${esc(env.name)}</code>
                                    <span style="flex:1;color:var(--text-muted);font-size:0.78rem">${esc(env.description || env.name)}</span>
                                    <span style="font-size:0.78rem;color:${color};font-weight:500">${label}</span>
                                    ${createBtn}
                                </div>`;
                        }

                        ghSection += `</div>
                            <p style="color:var(--text-muted);font-size:0.75rem;margin-bottom:1rem">
                                ğŸ’¡ GitHub environments are needed to push environment-scoped secrets. Dev uses repo-level secrets.
                            </p>`;

                        ghEnvEl.insertAdjacentHTML('beforebegin', ghSection);
                    }
                }
            } catch (_) {
                // gh CLI not available or not authenticated â€” skip
            }

            // â”€â”€ Encryption Key status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            try {
                const keyStatus = await api('/content/enc-key-status');
                const el = document.getElementById('wiz-enc-key-status');
                if (!el) return;

                if (keyStatus.configured) {
                    el.innerHTML = `
                        <div style="display:flex;align-items:center;gap:0.75rem;padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                            <span style="font-size:1.5rem">ğŸ”‘</span>
                            <div style="flex:1">
                                <div style="font-weight:600;font-size:0.9rem">Content Encryption Key: <span style="color:var(--success)">configured</span></div>
                                <div style="font-size:0.78rem;color:var(--text-muted);margin-top:0.15rem">
                                    <code>${esc(keyStatus.key_name)}</code> is set in .env â€” content files can be encrypted
                                </div>
                            </div>
                            <span style="font-size:0.82rem;color:var(--success)">âœ“ Ready</span>
                        </div>
                    `;
                } else {
                    el.innerHTML = `
                        <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--warning);border-radius:10px">
                            <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem">
                                <span style="font-size:1.5rem">âš ï¸</span>
                                <div style="flex:1">
                                    <div style="font-weight:600;font-size:0.9rem">Content Encryption Key: <span style="color:var(--warning)">not set</span></div>
                                    <div style="font-size:0.78rem;color:var(--text-muted);margin-top:0.15rem">
                                        <code>${esc(keyStatus.key_name)}</code> is required to encrypt/decrypt content files
                                    </div>
                                </div>
                            </div>
                            <div style="display:flex;gap:0.5rem;align-items:flex-end;flex-wrap:wrap">
                                <div style="flex:1;min-width:200px">
                                    <label style="font-size:0.78rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:0.25rem">Encryption Key</label>
                                    <input type="text" id="wiz-enc-key-input" placeholder="Enter at least 8 characters or generateâ€¦"
                                        style="width:100%;padding:0.4rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-card);color:var(--text-primary);font-size:0.82rem;font-family:var(--font-mono)">
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="wizardGenerateEncKey()" style="font-size:0.78rem">ğŸ² Generate</button>
                                <button class="btn btn-primary btn-sm" onclick="wizardSaveEncKey()" style="font-size:0.78rem">ğŸ’¾ Save</button>
                            </div>
                            <p style="color:var(--text-muted);font-size:0.75rem;margin-top:0.5rem">
                                âš ï¸ This key is stored in <code>.env</code>. Losing it means losing access to encrypted content.
                            </p>
                        </div>
                    `;
                }
            } catch (e) {
                // enc-key-status might not be available
            }

            // â”€â”€ Detected secret files â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            try {
                const data = await api('/vault/secrets');
                const el = document.getElementById('wiz-secrets-list');
                if (!el) return;

                const files = data.files || [];
                if (files.length === 0) {
                    el.innerHTML = `<p style="color:var(--text-muted);font-size:0.85rem;padding:0.5rem 0">No secret files detected in the project.</p>`;
                } else {
                    el.innerHTML = `
                        <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">Detected Secret Files</div>
                        <div style="display:flex;flex-direction:column;gap:0.3rem">
                            ${files.map(f => {
                                const stIcon = f.locked ? 'ğŸ”’' : f.exists ? 'ğŸ”“' : 'âŒ';
                                const stLabel = f.locked ? 'Encrypted' : f.exists ? 'Plaintext' : 'Missing';
                                const stColor = f.locked ? 'var(--warning)' : f.exists ? 'var(--success)' : 'var(--error)';
                                return `
                                    <div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.6rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;font-size:0.82rem">
                                        <span>${stIcon}</span>
                                        <code style="flex:1;font-size:0.8rem">${esc(f.name)}</code>
                                        <span style="font-size:0.75rem;color:${stColor}">${stLabel}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <p style="color:var(--text-muted);font-size:0.78rem;margin-top:0.75rem">
                            ğŸ’¡ Use the <strong>ğŸ” Secrets</strong> tab for full vault management (lock, unlock, create, push to GitHub).
                        </p>
                    `;
                }
            } catch (e) {
                // Secrets detection might not be available
            }
        },

        // â”€â”€ Step 4: Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        content: async (body) => {
            body.innerHTML = `
                <h2 style="margin-bottom:1rem">ğŸ“ Content Folders</h2>
                <p style="color:var(--text-secondary);line-height:1.6;margin-bottom:1rem">
                    Select which project folders should be managed as content.
                    These folders will appear in the <strong>ğŸ“ Content</strong> tab where you can
                    browse, preview, upload, encrypt, and back up files.
                </p>
                <div id="wiz-content-folders">
                    <span class="spinner"></span> Scanning project foldersâ€¦
                </div>
            `;

            try {
                const data = await api('/config/content-folders');
                const el = document.getElementById('wiz-content-folders');
                if (!el) return;

                const folders = data.folders || [];
                // Check which are currently configured in content folders
                let configuredPaths = [];
                try {
                    const cfData = await api('/content/folders');
                    configuredPaths = (cfData.folders || []).map(f => f.path || f.name);
                } catch (_) {}

                // Initialize wizard content folders from current config
                if (!_wizardConfig._contentFolders) {
                    _wizardConfig._contentFolders = [...configuredPaths];
                }

                if (folders.length === 0) {
                    el.innerHTML = '<p class="empty-state">No project folders detected.</p>';
                    return;
                }

                el.innerHTML = `
                    <div style="display:flex;flex-direction:column;gap:0.35rem">
                        ${folders.map(f => {
                            const isActive = _wizardConfig._contentFolders.includes(f.name);
                            const badge = f.suggested ? '<span style="font-size:0.65rem;background:var(--accent-glow);color:var(--accent);padding:0.1rem 0.35rem;border-radius:6px;margin-left:0.3rem">suggested</span>' : '';
                            return `
                                <label style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;background:var(--bg-inset);border:1px solid ${isActive ? 'var(--accent)' : 'var(--border-subtle)'};border-radius:8px;font-size:0.85rem;transition:all 0.15s;cursor:pointer"
                                    onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor=${isActive ? "'var(--accent)'" : "'var(--border-subtle)'"}">
                                    <input type="checkbox" ${isActive ? 'checked' : ''}
                                        onchange="wizardToggleContentFolder('${esc(f.name)}', this.checked, this.closest('label'))"
                                        style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer">
                                    <div style="flex:1">
                                        <div style="font-weight:500">${esc(f.name)}${badge}</div>
                                        <div style="font-size:0.75rem;color:var(--text-muted)">${f.file_count} file${f.file_count !== 1 ? 's' : ''}</div>
                                    </div>
                                    <span style="font-size:0.78rem;color:${isActive ? 'var(--accent)' : 'var(--text-muted)'};font-weight:500" data-folder-status="${esc(f.name)}">
                                        ${isActive ? 'âœ… Active' : 'â€”'}
                                    </span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                    <p style="color:var(--text-muted);font-size:0.78rem;margin-top:0.75rem">
                        ğŸ’¡ Selected folders appear in the <strong>ğŸ“ Content</strong> tab.
                        You can also use the <strong>ğŸ—‚ Explore All</strong> option there to browse all project folders.
                    </p>
                `;
            } catch (e) {
                const el = document.getElementById('wiz-content-folders');
                if (el) el.innerHTML = `<p style="color:var(--error);font-size:0.85rem">âŒ ${esc(e.message)}</p>`;
            }
        },

        // â”€â”€ Step 5: Review â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        review: async (body) => {
            // Collect current state from the form fields
            _wizardCollectWelcome();

            const cfg = _wizardConfig;
            if (!cfg) {
                body.innerHTML = '<p class="empty-state">No configuration loaded.</p>';
                return;
            }

            const modules = cfg.modules || [];
            const envs = cfg.environments || [];
            const domains = cfg.domains || [];

            body.innerHTML = `
                <h2 style="margin-bottom:1rem">âœ… Review & Save</h2>
                <p style="color:var(--text-secondary);line-height:1.6;margin-bottom:1.5rem">
                    Review your configuration below. Click <strong>Finish</strong> to save to <code>project.yml</code>.
                </p>

                <div style="display:flex;flex-direction:column;gap:1rem">
                    <!-- Project Identity -->
                    <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                        <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">ğŸ“‹ Project</div>
                        <div style="display:grid;grid-template-columns:auto 1fr;gap:0.3rem 1rem;font-size:0.85rem">
                            <span style="color:var(--text-muted)">Name:</span>
                            <span style="font-weight:500">${esc(cfg.name || '(not set)')}</span>
                            <span style="color:var(--text-muted)">Description:</span>
                            <span>${esc(cfg.description || 'â€”')}</span>
                            <span style="color:var(--text-muted)">Repository:</span>
                            <span style="font-family:var(--font-mono);font-size:0.82rem">${esc(cfg.repository || 'â€”')}</span>
                        </div>
                    </div>

                    <!-- Domains -->
                    <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                        <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">ğŸ·ï¸ Domains</div>
                        <div style="display:flex;flex-wrap:wrap;gap:0.4rem">
                            ${domains.length ? domains.map(d => `
                                <span style="padding:0.2rem 0.6rem;background:var(--accent-glow);border:1px solid var(--accent);border-radius:12px;font-size:0.78rem;color:var(--accent)">${esc(d)}</span>
                            `).join('') : '<span style="color:var(--text-muted);font-size:0.85rem">None configured</span>'}
                        </div>
                    </div>

                    <!-- Environments -->
                    <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                        <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">ğŸŒ Environments (${envs.length})</div>
                        ${envs.length ? `<div style="display:flex;flex-wrap:wrap;gap:0.4rem">${envs.map(e => `
                            <span style="padding:0.2rem 0.6rem;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.78rem">
                                ${esc(e.name)}${e.default ? ' â­' : ''}
                            </span>
                        `).join('')}</div>` : '<span style="color:var(--text-muted);font-size:0.85rem">None configured</span>'}
                    </div>

                    <!-- Modules -->
                    <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                        <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">ğŸ“¦ Modules (${modules.length})</div>
                        ${modules.length ? `<div style="display:flex;flex-direction:column;gap:0.3rem">${modules.map(m => `
                            <div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem">
                                <span style="font-weight:600;min-width:90px">${esc(m.name)}</span>
                                <code style="color:var(--text-muted);font-size:0.78rem">${esc(m.path)}</code>
                                <span style="margin-left:auto;font-size:0.75rem;padding:0.1rem 0.4rem;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:6px">${esc(m.stack || 'â€”')}</span>
                            </div>
                        `).join('')}</div>` : '<span style="color:var(--text-muted);font-size:0.85rem">No modules configured</span>'}
                    </div>

                    <!-- Content Folders -->
                    <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                        <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">ğŸ“ Content Folders</div>
                        ${(cfg._contentFolders || []).length ? `<div style="display:flex;flex-wrap:wrap;gap:0.4rem">${(cfg._contentFolders || []).map(f => `
                            <span style="padding:0.2rem 0.6rem;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.78rem">
                                ğŸ“ ${esc(f)}
                            </span>
                        `).join('')}</div>` : '<span style="color:var(--text-muted);font-size:0.85rem">Using default detection</span>'}
                    </div>
                </div>

                ${wizardDirty ? `
                    <div style="margin-top:1rem;padding:0.75rem;background:var(--warning-bg);border:1px solid var(--warning);border-radius:8px;font-size:0.82rem;color:var(--warning);display:flex;align-items:center;gap:0.5rem">
                        <span>âš ï¸</span>
                        <span>You have unsaved changes. Click <strong>âœ… Finish</strong> to save to <code>project.yml</code>.</span>
                    </div>
                ` : `
                    <p style="color:var(--text-muted);font-size:0.82rem;margin-top:1rem">
                        âœ¨ Configuration looks good! Click <strong>âœ… Finish</strong> to save.
                    </p>
                `}
            `;
        },
    };

    // â”€â”€ Collect form state â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function _wizardCollectWelcome() {
        if (!_wizardConfig) return;
        const name = document.getElementById('wiz-name');
        const desc = document.getElementById('wiz-desc');
        const repo = document.getElementById('wiz-repo');
        if (name) _wizardConfig.name = name.value.trim();
        if (desc) _wizardConfig.description = desc.value.trim();
        if (repo) _wizardConfig.repository = repo.value.trim();
    }

    // â”€â”€ Module helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function _wizardModuleRow(m, i) {
        const stackIcons = {
            'python-lib': 'ğŸ', 'python-cli': 'ğŸ', 'python-flask': 'ğŸ',
            'node': 'ğŸ“¦', 'docker-compose': 'ğŸ³', 'markdown': 'ğŸ“',
        };
        const icon = stackIcons[m.stack] || 'ğŸ“';
        return `
            <div style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.85rem">
                <span style="font-size:1rem">${icon}</span>
                <div style="flex:1;min-width:0">
                    <div style="font-weight:600">${esc(m.name)}</div>
                    <div style="display:flex;gap:0.75rem;font-size:0.75rem;color:var(--text-muted)">
                        <span><code>${esc(m.path)}</code></span>
                        <span>Stack: ${esc(m.stack || 'â€”')}</span>
                        ${m.domain ? `<span>Domain: ${esc(m.domain)}</span>` : ''}
                    </div>
                    ${m.description ? `<div style="font-size:0.75rem;color:var(--text-muted);margin-top:0.15rem">${esc(m.description)}</div>` : ''}
                </div>
                <button class="btn btn-secondary btn-sm" onclick="wizardRemoveModule(${i})" title="Remove"
                    style="font-size:0.7rem;padding:0.15rem 0.4rem;color:var(--error);opacity:0.6">âœ•</button>
            </div>
        `;
    }

    function wizardAddModule() {
        if (!_wizardConfig) return;
        const name = document.getElementById('wiz-mod-name');
        const path = document.getElementById('wiz-mod-path');
        const stack = document.getElementById('wiz-mod-stack');

        const n = name ? name.value.trim() : '';
        const p = path ? path.value.trim() : '';
        if (!n || !p) { toast('Name and path are required.', 'warning'); return; }

        if (!_wizardConfig.modules) _wizardConfig.modules = [];
        _wizardConfig.modules.push({
            name: n,
            path: p,
            stack: stack ? stack.value.trim() : '',
            domain: _wizardConfig.domains?.[0] || 'service',
        });
        wizardDirty = true;
        renderWizard();
    }

    function wizardRemoveModule(i) {
        if (!_wizardConfig || !_wizardConfig.modules) return;
        _wizardConfig.modules.splice(i, 1);
        wizardDirty = true;
        renderWizard();
    }

    // â”€â”€ Domain helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function wizardAddDomain() {
        if (!_wizardConfig) return;
        const input = document.getElementById('wiz-new-domain');
        const val = input ? input.value.trim().toLowerCase() : '';
        if (!val) return;
        if (!_wizardConfig.domains) _wizardConfig.domains = [];
        if (_wizardConfig.domains.includes(val)) { toast('Domain already exists.', 'warning'); return; }
        _wizardConfig.domains.push(val);
        wizardDirty = true;
        renderWizard();
    }

    function wizardRemoveDomain(el, domain) {
        if (!_wizardConfig || !_wizardConfig.domains) return;
        _wizardConfig.domains = _wizardConfig.domains.filter(d => d !== domain);
        wizardDirty = true;
        renderWizard();
    }

    // â”€â”€ Environment helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function wizardAddEnv() {
        if (!_wizardConfig) return;
        const nameInput = document.getElementById('wiz-new-env-name');
        const descInput = document.getElementById('wiz-new-env-desc');
        const n = nameInput ? nameInput.value.trim() : '';
        if (!n) { toast('Environment name is required.', 'warning'); return; }
        if (!_wizardConfig.environments) _wizardConfig.environments = [];
        if (_wizardConfig.environments.some(e => e.name === n)) {
            toast('Environment already exists.', 'warning'); return;
        }
        _wizardConfig.environments.push({
            name: n,
            description: descInput ? descInput.value.trim() : '',
            default: _wizardConfig.environments.length === 0,
        });
        wizardDirty = true;
        renderWizard();
    }

    function wizardRemoveEnv(i) {
        if (!_wizardConfig || !_wizardConfig.environments) return;
        const env = _wizardConfig.environments[i];
        if (!env) return;

        // Show a confirmation modal with cleanup options
        const envName = env.name;
        const envFile = _wizEnvFile(envName);

        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'env-cleanup-modal';
        modal.innerHTML = `
            <div class="vault-modal" style="max-width:440px">
                <h3 style="margin-bottom:0.75rem">ğŸ—‘ï¸ Remove Environment: <code>${esc(envName)}</code></h3>
                <p style="color:var(--text-secondary);font-size:0.85rem;line-height:1.5;margin-bottom:1rem">
                    This will remove <strong>${esc(envName)}</strong> from <code>project.yml</code>.
                    You can also clean up associated files and the GitHub environment.
                </p>

                <div style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:1.25rem;padding:0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px">
                    <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.85rem;cursor:pointer">
                        <input type="checkbox" id="cleanup-files" checked>
                        <span>Delete local files (<code>.env.${esc(envName)}</code>, <code>.env.${esc(envName)}.vault</code>)</span>
                    </label>
                    <label style="display:flex;align-items:center;gap:0.5rem;font-size:0.85rem;cursor:pointer">
                        <input type="checkbox" id="cleanup-github" checked>
                        <span>Delete GitHub environment <code>${esc(envName)}</code></span>
                    </label>
                </div>

                <div style="display:flex;gap:0.5rem;justify-content:flex-end">
                    <button class="btn btn-secondary btn-sm" onclick="document.getElementById('env-cleanup-modal').remove()"
                        style="font-size:0.82rem">Cancel</button>
                    <button class="btn btn-sm" id="btn-confirm-cleanup"
                        style="font-size:0.82rem;background:var(--error);color:#fff;border:none"
                        onclick="wizardConfirmRemoveEnv(${i})">ğŸ—‘ï¸ Remove</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    async function wizardConfirmRemoveEnv(i) {
        if (!_wizardConfig || !_wizardConfig.environments) return;
        const env = _wizardConfig.environments[i];
        if (!env) return;

        const envName = env.name;
        const deleteFiles = document.getElementById('cleanup-files')?.checked ?? true;
        const deleteGithub = document.getElementById('cleanup-github')?.checked ?? false;

        // Disable button, show spinner
        const btn = document.getElementById('btn-confirm-cleanup');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner" style="width:12px;height:12px"></span> Cleaning upâ€¦';
        }

        // Run cleanup if any options selected
        const msgs = [];
        if (deleteFiles || deleteGithub) {
            try {
                const result = await api('/env/cleanup', {
                    method: 'POST',
                    body: JSON.stringify({
                        name: envName,
                        delete_files: deleteFiles,
                        delete_github: deleteGithub,
                    }),
                });

                if (result.files && result.files.length > 0) {
                    msgs.push(`Deleted: ${result.files.join(', ')}`);
                }
                if (result.github) {
                    if (result.github.success) {
                        msgs.push(`GitHub env "${envName}" deleted`);
                    } else if (result.github.error) {
                        msgs.push(`GitHub: ${result.github.error}`);
                    }
                }
            } catch (e) {
                toast(`Cleanup error: ${e.message}`, 'error');
            }
        }

        // Remove from config
        _wizardConfig.environments.splice(i, 1);
        wizardDirty = true;

        // Close modal
        document.getElementById('env-cleanup-modal')?.remove();

        // Show results
        const summary = msgs.length > 0 ? ` (${msgs.join('; ')})` : '';
        toast(`ğŸ—‘ï¸ Environment "${envName}" removed${summary}`, 'success');

        renderWizard();
    }

    // â”€â”€ Content folder helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function wizardToggleContentFolder(name, checked, labelEl) {
        if (!_wizardConfig) return;
        if (!_wizardConfig._contentFolders) _wizardConfig._contentFolders = [];

        if (checked) {
            if (!_wizardConfig._contentFolders.includes(name)) {
                _wizardConfig._contentFolders.push(name);
            }
        } else {
            _wizardConfig._contentFolders = _wizardConfig._contentFolders.filter(f => f !== name);
        }
        wizardDirty = true;

        // Live-update the UI without full re-render
        if (labelEl) {
            labelEl.style.borderColor = checked ? 'var(--accent)' : 'var(--border-subtle)';
            const statusSpan = labelEl.querySelector(`[data-folder-status="${name}"]`);
            if (statusSpan) {
                statusSpan.textContent = checked ? 'âœ… Active' : 'â€”';
                statusSpan.style.color = checked ? 'var(--accent)' : 'var(--text-muted)';
            }
            // Fix mouseleave handler
            labelEl.onmouseleave = function() {
                this.style.borderColor = checked ? 'var(--accent)' : 'var(--border-subtle)';
            };
        }
    }

    // â”€â”€ Encryption key helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function wizardGenerateEncKey() {
        try {
            const result = await api('/content/setup-enc-key', {
                method: 'POST',
                body: JSON.stringify({ generate: true }),
            });
            const input = document.getElementById('wiz-enc-key-input');
            if (input) input.value = result.key_value || '(generated)';
            toast('ğŸ”‘ Encryption key generated and saved!', 'success');
            // Refresh the secrets step to show the updated status
            setTimeout(() => renderWizard(), 500);
        } catch (e) {
            toast(`Failed: ${e.message}`, 'error');
        }
    }

    /** Save auto-detected GITHUB_REPOSITORY to .env (local only). */
    async function wizardSaveGhRepo(repoValue, btnEl) {
        if (btnEl) {
            btnEl.disabled = true;
            btnEl.innerHTML = '<span class="spinner" style="width:12px;height:12px"></span>';
        }
        try {
            await api('/secret/set', {
                method: 'POST',
                body: JSON.stringify({
                    name: 'GITHUB_REPOSITORY',
                    value: repoValue,
                    target: 'local',
                }),
            });
            toast(`GITHUB_REPOSITORY saved to .env`, 'success');

            // Update the row in-place
            const row = document.getElementById('wiz-gh-repo-row');
            if (row) {
                row.style.borderColor = 'var(--success)';
                row.innerHTML = `
                    <span>âœ…</span>
                    <code style="font-size:0.8rem;font-weight:500">GITHUB_REPOSITORY</code>
                    <span style="flex:1;color:var(--text-muted);font-size:0.78rem">${esc(repoValue)}</span>
                    <span style="font-size:0.78rem;color:var(--success);font-weight:500">configured</span>
                `;
            }
        } catch (e) {
            toast(`Failed: ${e.message}`, 'error');
            if (btnEl) {
                btnEl.disabled = false;
                btnEl.innerHTML = 'ğŸ’¾ Save to .env';
            }
        }
    }

    async function wizardSaveEncKey() {
        const input = document.getElementById('wiz-enc-key-input');
        const keyVal = input ? input.value.trim() : '';
        if (!keyVal || keyVal.length < 8) {
            toast('Key must be at least 8 characters.', 'warning');
            if (input) input.focus();
            return;
        }

        try {
            await api('/content/setup-enc-key', {
                method: 'POST',
                body: JSON.stringify({ key: keyVal }),
            });
            toast('ğŸ”‘ Encryption key saved!', 'success');
            setTimeout(() => renderWizard(), 500);
        } catch (e) {
            toast(`Failed: ${e.message}`, 'error');
        }
    }

    // â”€â”€ Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function wizardDetect() {
        const list = document.getElementById('wizard-modules-list');
        if (!list) return;
        list.innerHTML = '<div style="text-align:center;padding:1rem"><span class="spinner"></span> Scanning projectâ€¦</div>';

        try {
            await api('/detect', { method: 'POST' });
            const data = await api('/status');
            const modules = data.modules || [];

            if (!_wizardConfig) _wizardConfig = {};
            _wizardConfig.modules = modules.map(m => ({
                name: m.name,
                path: m.path,
                domain: m.domain || 'service',
                stack: m.stack || '',
                description: m.description || '',
            }));

            wizardDirty = true;
            list.innerHTML = _wizardConfig.modules.map((m, i) => _wizardModuleRow(m, i)).join('');

            if (modules.length === 0) {
                list.innerHTML = '<p style="color:var(--text-muted);padding:1rem;text-align:center">No modules detected. Add them manually below.</p>';
            } else {
                toast(`Found ${modules.length} module${modules.length > 1 ? 's' : ''}!`, 'success');
            }
        } catch (e) {
            list.innerHTML = `<p style="color:var(--error);padding:0.5rem">${esc(e.message)}</p>`;
        }
    }

    // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function wizardNext() {
        // Collect current state before advancing
        if (wizardSteps[currentWizardStep].id === 'welcome') {
            _wizardCollectWelcome();
            if (!_wizardConfig || !_wizardConfig.name) {
                toast('Project name is required.', 'warning');
                const nameInput = document.getElementById('wiz-name');
                if (nameInput) nameInput.focus();
                return;
            }
        }

        if (currentWizardStep < wizardSteps.length - 1) {
            currentWizardStep++;
            renderWizard();
        }
    }

    function wizardPrev() {
        // Collect state before going back
        if (wizardSteps[currentWizardStep].id === 'welcome') {
            _wizardCollectWelcome();
        }
        if (currentWizardStep > 0) {
            currentWizardStep--;
            renderWizard();
        }
    }

    function wizardGoTo(idx) {
        // Collect state from current step
        if (wizardSteps[currentWizardStep].id === 'welcome') {
            _wizardCollectWelcome();
        }
        if (idx >= 0 && idx < wizardSteps.length) {
            currentWizardStep = idx;
            renderWizard();
        }
    }

    async function wizardFinish() {
        // Collect any final state
        _wizardCollectWelcome();

        if (!_wizardConfig || !_wizardConfig.name) {
            toast('Project name is required. Go back to step 1.', 'warning');
            return;
        }

        try {
            await api('/config', {
                method: 'POST',
                body: JSON.stringify({ config: _wizardConfig }),
            });
            wizardDirty = false;

            // â”€â”€ Seed environment files if entering multi-env mode â”€â”€â”€â”€
            const envs = _wizardConfig.environments || [];
            if (envs.length > 1) {
                const defaultEnv = envs.find(e => e.default) || envs[0];
                try {
                    const seedResult = await api('/env/seed', {
                        method: 'POST',
                        body: JSON.stringify({
                            environments: envs.map(e => e.name),
                            default: defaultEnv.name,
                        }),
                    });
                    if (seedResult.seeded && seedResult.seeded.length > 0) {
                        toast(`ğŸ“ Seeded: ${seedResult.seeded.map(n => '.env.' + n).join(', ')}`, 'info');
                    }
                } catch (seedErr) {
                    console.warn('Env seed failed:', seedErr);
                }
            }

            // Invalidate cached environment state so other tabs re-fetch
            projectEnvironments = [];
            selectedEnv = '';
            secretsLoaded = false;

            toast('âœ… Configuration saved to project.yml!', 'success');
            switchTab('dashboard');
        } catch (e) {
            toast(`Save failed: ${e.message}`, 'error');
        }
    }
</script>