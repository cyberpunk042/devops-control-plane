/* ─────────────────────────────────────────────────────────────────
* _content_chat_refs.html
* Content Vault — Chat @-Reference Autocomplete + Embedding
* Included by: _content.html (Jinja2 include)
* ───────────────────────────────────────────────────────────────── */

let _chatRefPhase = 0;
let _chatRefType = '';
let _chatRefSuggestions = [];
let _chatRefSelectedIdx = -1;
let _chatRefDebounceTimer = null;
let _chatRefPrefix = '';
let _chatRefStartPos = -1;
let _chatRefDismissed = false;
let _chatRefDismissedAt = -1;

const _chatRefCategories = [
{ type: 'commit', icon: '&#x1F4DD;', label: 'Commit' },
{ type: 'branch', icon: '&#x1F500;', label: 'Branch' },
{ type: 'audit', icon: '&#x1F4CA;', label: 'Audit' },
{ type: 'thread', icon: '&#x1F4AC;', label: 'Thread' },
{ type: 'trace', icon: '&#x1F4CB;', label: 'Trace' },
{ type: 'user', icon: '&#x1F464;', label: 'User' },
{ type: 'code', icon: '&#x1F4BB;', label: 'Code' },
{ type: 'doc', icon: '&#x1F4C4;', label: 'Doc' },
{ type: 'media', icon: '&#x1F5BC;', label: 'Media' },
{ type: 'release', icon: '&#x1F4E6;', label: 'Release' },
{ type: 'file', icon: '&#x1F4C1;', label: 'File' },
{ type: 'run', icon: '&#x1F680;', label: 'Run' }
];


/* ── Item renderers ─────────────────────────────────────────── */

function _chatRefRenderCommit(item) {
const div = document.createElement('div');
div.className = 'chat-ref-item';
div.setAttribute('data-ref', item.ref);
const line1 = document.createElement('div');
line1.className = 'chat-ref-item-label';
const hashEl = document.createElement('span');
hashEl.className = 'chat-ref-hash';
hashEl.textContent = item.hash || '';
const msgEl = document.createElement('span');
msgEl.textContent = ' ' + (item.label || '');
line1.appendChild(document.createTextNode(item.icon + ' '));
line1.appendChild(hashEl);
line1.appendChild(msgEl);
const line2 = document.createElement('div');
line2.className = 'chat-ref-item-detail';
line2.textContent = item.detail || '';
div.appendChild(line1);
div.appendChild(line2);
return div;
}

function _chatRefRenderGeneric(item) {
if (typeof item === 'string') {
const div = document.createElement('div');
div.className = 'chat-ref-item';
div.setAttribute('data-ref', item);
const span = document.createElement('code');
span.textContent = item;
div.appendChild(span);
return div;
}
const div = document.createElement('div');
div.className = 'chat-ref-item';
div.setAttribute('data-ref', item.ref);
const line1 = document.createElement('div');
line1.className = 'chat-ref-item-label';
line1.textContent = (item.icon || '') + ' ' + (item.label || item.ref);
const line2 = document.createElement('div');
line2.className = 'chat-ref-item-detail';
line2.textContent = item.detail || '';
div.appendChild(line1);
if (item.detail) {
div.appendChild(line2);
}
return div;
}

const _chatRefRenderers = { 'commit': _chatRefRenderCommit };

function _chatRefRenderItem(item, type) {
const renderer = _chatRefRenderers[type] || _chatRefRenderGeneric;
return renderer(item);
}


/* ── Trigger detection ──────────────────────────────────────── */

function chatCheckRefTrigger(text, cursorPos) {
const beforeCursor = text.substring(0, cursorPos);
const atIdx = beforeCursor.lastIndexOf('@');

if (atIdx === -1) {
_chatRefHidePopup();
return;
}

if (atIdx > 0 && !/[\s\n]/.test(beforeCursor[atIdx - 1])) {
_chatRefHidePopup();
return;
}

/* if user dismissed with Escape at this same @ position, stay hidden */
if (_chatRefDismissed && _chatRefDismissedAt === atIdx) {
return;
}
/* new @ position clears dismissed state */
if (_chatRefDismissedAt !== atIdx) {
_chatRefDismissed = false;
}

const prefix = beforeCursor.substring(atIdx, cursorPos);
_chatRefStartPos = atIdx;
_chatRefPrefix = prefix;

if (prefix === '@') {
_chatRefShowCategories('');
return;
}

const colonIdx = prefix.indexOf(':');
if (colonIdx === -1) {
const typePart = prefix.substring(1);
_chatRefShowCategories(typePart);
return;
}

const refType = prefix.substring(1, colonIdx);
const partialId = prefix.substring(colonIdx + 1);
_chatRefType = refType;

if (_chatRefDebounceTimer) {
clearTimeout(_chatRefDebounceTimer);
}
_chatRefDebounceTimer = setTimeout(function() {
_chatRefFetchItems(refType, partialId);
}, 200);
}


/* ── Phase 1: category grid ─────────────────────────────────── */

function _chatRefShowCategories(filter) {
const popup = document.getElementById('chat-ref-popup');
if (!popup) return;

_chatRefPhase = 1;
_chatRefType = '';
_chatRefSuggestions = [];
_chatRefSelectedIdx = -1;

const filtered = [];
const filterLower = filter ? filter.toLowerCase() : '';
for (let i = 0; i < _chatRefCategories.length; i++) { const cat=_chatRefCategories[i]; if (!filterLower ||
    cat.type.indexOf(filterLower)===0) { filtered.push(cat); } } if (filtered.length===0) { popup.innerHTML=`<div
    class="chat-ref-empty">No matching types</div>`;
    popup.style.display = 'block';
    return;
    }

    let html = `<div class="chat-ref-categories">`;
        for (let j = 0; j < filtered.length; j++) { const c=filtered[j]; _chatRefSuggestions.push(c); html +=`<div
            class="chat-ref-category" data-idx="${j}" data-type="${c.type}">`;
            html += `<span class="chat-ref-category-icon">${c.icon}</span>`;
            html += `<span class="chat-ref-category-label">${c.label}</span>`;
            html += `</div>`;
    }
    html += `</div>`;

    popup.innerHTML = html;
    popup.style.display = 'block';

    /* auto-highlight first when only one match */
    if (filtered.length === 1) {
    _chatRefSelectedIdx = 0;
    _chatRefUpdateHighlight();
    }

    const tiles = popup.querySelectorAll('.chat-ref-category');
    for (let k = 0; k < tiles.length; k++) { (function(el) { el.addEventListener('click', function(e) {
        e.preventDefault(); e.stopPropagation(); _chatRefSelectCategory(el.dataset.type); }); })(tiles[k]); } } /* ──
        Category selection → phase 2 ───────────────────────────── */ function _chatRefSelectCategory(type) { const
        input=document.getElementById('chat-compose-input'); if (!input) return; const before=input.value.substring(0,
        _chatRefStartPos); const after=input.value.substring(input.selectionStart); input.value=before + '@' + type
        + ':' + after; const newPos=_chatRefStartPos + type.length + 2; input.selectionStart=newPos;
        input.selectionEnd=newPos; input.focus(); _chatRefPrefix='@' + type + ':' ; _chatRefType=type;
        _chatRefFetchItems(type, '' ); } /* ── Phase 2: fetch + render items ──────────────────────────── */ function
        _chatRefFetchItems(type, partialId) { const popup=document.getElementById('chat-ref-popup'); if (!popup) return;
        _chatRefPhase=2; _chatRefSuggestions=[]; _chatRefSelectedIdx=-1; let typeInfo=null; for (let i=0; i <
        _chatRefCategories.length; i++) { if (_chatRefCategories[i].type===type) { typeInfo=_chatRefCategories[i];
        break; } } const typeLabel=typeInfo ? (typeInfo.icon + ' ' + typeInfo.label) : type; popup.innerHTML=`<div
        class="chat-ref-phase2-header">
        <span class="chat-ref-phase2-title">${typeLabel}</span>
        <span class="chat-ref-phase2-back" title="Back to categories">&times;</span>
        </div>
        <div class="chat-ref-loading">Loading...</div>`;
        popup.style.display = 'block';

        const backBtn = popup.querySelector('.chat-ref-phase2-back');
        if (backBtn) {
        backBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        _chatRefGoBack();
        });
        }

        const prefix = '@' + type + ':' + (partialId || '');
        api('/chat/refs/autocomplete?prefix=' + encodeURIComponent(prefix)).then(function(data) {
        const suggestions = data.suggestions || [];
        if (suggestions.length === 0) {
        const loadEl = popup.querySelector('.chat-ref-loading');
        if (loadEl) {
        loadEl.className = 'chat-ref-empty';
        loadEl.textContent = 'No matches' + (partialId ? ' for "' + partialId + '"' : '');
        }
        return;
        }
        _chatRefSuggestions = suggestions;
        _chatRefSelectedIdx = -1;
        _chatRefRenderItems(popup, suggestions, type, typeLabel);
        }).catch(function() {
        const loadEl = popup.querySelector('.chat-ref-loading');
        if (loadEl) {
        loadEl.className = 'chat-ref-empty';
        loadEl.textContent = 'Error loading suggestions';
        }
        });
        }

        function _chatRefRenderItems(popup, suggestions, type, typeLabel) {
        popup.innerHTML = `<div class="chat-ref-phase2-header">
            <span class="chat-ref-phase2-title">${typeLabel}</span>
            <span class="chat-ref-phase2-back" title="Back to categories">&times;</span>
        </div>
        <div class="chat-ref-items"></div>`;

        const backBtn = popup.querySelector('.chat-ref-phase2-back');
        if (backBtn) {
        backBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        _chatRefGoBack();
        });
        }

        const container = popup.querySelector('.chat-ref-items');
        for (let i = 0; i < suggestions.length; i++) { const item=suggestions[i]; const el=_chatRefRenderItem(item,
            type); el.setAttribute('data-idx', String(i)); const refVal=(typeof item==='string' ) ? item : item.ref;
            el.setAttribute('data-ref', refVal); (function(refValue, idx) { el.addEventListener('click', function(e) {
            e.preventDefault(); e.stopPropagation(); chatInsertRef(refValue); }); el.addEventListener('mouseenter',
            function() { _chatRefSelectedIdx=idx; _chatRefUpdateHighlight(); }); })(refVal, i);
            container.appendChild(el); } } /* ── Go back to phase 1 ─────────────────────────────────────── */ function
            _chatRefGoBack() { const input=document.getElementById('chat-compose-input'); if (input && _chatRefStartPos>
            = 0) {
            const before = input.value.substring(0, _chatRefStartPos);
            const after = input.value.substring(input.selectionStart);
            input.value = before + '@' + after;
            const newPos = _chatRefStartPos + 1;
            input.selectionStart = newPos;
            input.selectionEnd = newPos;
            input.focus();
            _chatRefPrefix = '@';
            }
            _chatRefShowCategories('');
            }


            /* ── Keyboard navigation ────────────────────────────────────── */

            function chatRefKeydown(event) {
            const popup = document.getElementById('chat-ref-popup');
            if (!popup || popup.style.display === 'none') return;

            if (event.key === 'ArrowDown') {
            event.preventDefault();
            if (_chatRefSuggestions.length > 0) {
            _chatRefSelectedIdx = Math.min(_chatRefSelectedIdx + 1, _chatRefSuggestions.length - 1);
            _chatRefUpdateHighlight();
            }
            return;
            }

            if (event.key === 'ArrowUp') {
            event.preventDefault();
            if (_chatRefSuggestions.length > 0) {
            _chatRefSelectedIdx = Math.max(_chatRefSelectedIdx - 1, 0);
            _chatRefUpdateHighlight();
            }
            return;
            }

            if (event.key === 'Tab') {
            if (_chatRefSuggestions.length > 0) {
            event.preventDefault();
            if (_chatRefSelectedIdx < 0) { _chatRefSelectedIdx=0; } _chatRefPickSelected(); } return; } if
                (event.key==='Enter' && _chatRefSelectedIdx>= 0) {
                event.preventDefault();
                _chatRefPickSelected();
                return;
                }

                if (event.key === 'Escape') {
                event.preventDefault();
                if (_chatRefPhase === 2) {
                _chatRefGoBack();
                } else {
                _chatRefDismissed = true;
                _chatRefDismissedAt = _chatRefStartPos;
                _chatRefHidePopup();
                }
                return;
                }
                }

                function _chatRefPickSelected() {
                const selected = _chatRefSuggestions[_chatRefSelectedIdx];
                if (!selected) return;

                if (_chatRefPhase === 1) {
                /* phase 1: selected is a category object */
                if (selected.type) {
                _chatRefSelectCategory(selected.type);
                }
                } else {
                /* phase 2: selected is a suggestion dict or string */
                const refVal = (typeof selected === 'string') ? selected : selected.ref;
                if (refVal && refVal.endsWith('/')) {
                /* drill-down: update textarea and re-fetch */
                const input = document.getElementById('chat-compose-input');
                if (input) {
                const before = input.value.substring(0, _chatRefStartPos);
                const after = input.value.substring(input.selectionStart);
                input.value = before + refVal + after;
                const newPos = _chatRefStartPos + refVal.length;
                input.selectionStart = newPos;
                input.selectionEnd = newPos;
                input.focus();
                _chatRefPrefix = refVal;
                const colonIdx = refVal.indexOf(':');
                const refType = refVal.substring(1, colonIdx);
                const partialId = refVal.substring(colonIdx + 1);
                _chatRefType = refType;
                _chatRefFetchItems(refType, partialId);
                }
                } else {
                chatInsertRef(refVal);
                }
                }
                }


                /* ── Highlight management ───────────────────────────────────── */

                function _chatRefUpdateHighlight() {
                const popup = document.getElementById('chat-ref-popup');
                if (!popup) return;

                let items;
                if (_chatRefPhase === 1) {
                items = popup.querySelectorAll('.chat-ref-category');
                } else {
                items = popup.querySelectorAll('.chat-ref-item');
                }
                for (let i = 0; i < items.length; i++) { if (i===_chatRefSelectedIdx) {
                    items[i].classList.add('chat-ref-active'); } else { items[i].classList.remove('chat-ref-active'); }
                    } if (_chatRefSelectedIdx>= 0 && items[_chatRefSelectedIdx]) {
                    items[_chatRefSelectedIdx].scrollIntoView({ block: 'nearest' });
                    }
                    }


                    /* ── Insert ref + hide popup ────────────────────────────────── */

                    function chatInsertRef(ref) {
                    const input = document.getElementById('chat-compose-input');
                    if (!input || _chatRefStartPos < 0) return; /* drill-down: if ref ends with /, re-fetch instead of
                        closing */ if (ref && ref.endsWith('/')) { const before=input.value.substring(0,
                        _chatRefStartPos); const after=input.value.substring(input.selectionStart); input.value=before +
                        ref + after; const np=_chatRefStartPos + ref.length; input.selectionStart=np;
                        input.selectionEnd=np; input.focus(); _chatRefPrefix=ref; const ci=ref.indexOf(':'); const
                        rt=ref.substring(1, ci); const pi=ref.substring(ci + 1); _chatRefType=rt; _chatRefFetchItems(rt,
                        pi); return; } const before=input.value.substring(0, _chatRefStartPos); const
                        after=input.value.substring(input.selectionStart); input.value=before + ref + ' ' + after; const
                        newPos=_chatRefStartPos + ref.length + 1; input.selectionStart=newPos;
                        input.selectionEnd=newPos; input.focus(); _chatRefHidePopup(); } function _chatRefHidePopup() {
                        const popup=document.getElementById('chat-ref-popup'); if (popup) popup.style.display='none' ;
                        _chatRefPhase=0; _chatRefType='' ; _chatRefSuggestions=[]; _chatRefSelectedIdx=-1;
                        _chatRefPrefix='' ; _chatRefStartPos=-1; if (_chatRefDebounceTimer) {
                        clearTimeout(_chatRefDebounceTimer); _chatRefDebounceTimer=null; } } /*
                        ═════════════════════════════════════════════════════════════════ * Ref Embedding — inline chips
                        + media embeds * ═════════════════════════════════════════════════════════════════ */ const
                        _REF_CHIP_ICONS={ 'commit' : '&#x1F4DD;' , 'branch' : '&#x1F500;' , 'run' : '&#x1F680;'
                        , 'thread' : '&#x1F4AC;' , 'trace' : '&#x1F4CB;' , 'audit' : '&#x1F4CA;' , 'user' : '&#x1F464;'
                        , 'code' : '&#x1F4BB;' , 'doc' : '&#x1F4C4;' , 'media' : '&#x1F5BC;' , 'release' : '&#x1F4E6;'
                        , 'file' : '&#x1F4C1;' }; /** * Replace @type:value tokens in already-escaped HTML with
                        clickable chips. * Also returns media embed blocks to append below message text. */ function
                        _chatEmbedRefs(escapedText) { const
                        refPattern=/@(run|thread|trace|user|commit|branch|audit|code|doc|media|release|file):([A-Za-z0-9_\-\/.]+)/g;
                        let mediaEmbeds='' ; const html=escapedText.replace(refPattern, function(match, refType, refId)
                        { const icon=_REF_CHIP_ICONS[refType] || '&#x1F517;' ; const
                        shortLabel=_chatRefShortLabel(refType, refId); const safeRef=esc('@' + refType + ':' + refId);
                        const chipClass='chat-ref-chip chat-ref-chip-' + refType; /* media: also generate inline embed
                        */ if (refType==='media' ) { const ext=refId.split('.').pop().toLowerCase(); const
                        isImage=['jpg','jpeg','png','gif','webp','svg','bmp','ico'].indexOf(ext)>= 0;
                        const isVideo = ['mp4','webm','mov'].indexOf(ext) >= 0;
                        const isAudio = ['mp3','wav','ogg','flac','aac','m4a'].indexOf(ext) >= 0;
                        const downloadUrl = '/api/content/download?path=' + encodeURIComponent(refId);

                        if (isImage) {
                        mediaEmbeds += `<div class="chat-ref-media-embed"><img src="${downloadUrl}" alt="${esc(refId)}"
                                class="chat-ref-media-img" onclick="chatRefClickMedia('${esc(refId)}')"
                                title="Click to preview"></div>`;
                        } else if (isVideo) {
                        mediaEmbeds += `<div class="chat-ref-media-embed"><video controls class="chat-ref-media-video"
                                preload="metadata">
                                <source src="${downloadUrl}">
                            </video></div>`;
                        } else if (isAudio) {
                        mediaEmbeds += `<div class="chat-ref-media-embed"><audio controls class="chat-ref-media-audio"
                                preload="metadata">
                                <source src="${downloadUrl}">
                            </audio></div>`;
                        }
                        }

                        return `<span class="${chipClass}" onclick="chatRefClick('${refType}', '${esc(refId)}')"
                            title="${safeRef}"><span class="chat-ref-chip-icon">${icon}</span><span
                                class="chat-ref-chip-label">${esc(shortLabel)}</span></span>`;
                        });

                        return { html: html, mediaEmbeds: mediaEmbeds };
                        }

                        /** Short display label for a ref (filename, short hash, etc) */
                        function _chatRefShortLabel(refType, refId) {
                        if (refType === 'commit') {
                        return refId.length > 8 ? refId.substring(0, 8) : refId;
                        }
                        if (refType === 'code' || refType === 'doc' || refType === 'file' || refType === 'media') {
                        const parts = refId.split('/');
                        return parts[parts.length - 1];
                        }
                        if (refType === 'release' && refId.indexOf('/') >= 0) {
                        const rp = refId.split('/');
                        return rp[0] + '/' + rp.slice(1).join('/');
                        }
                        if (refType === 'user') {
                        return '@' + refId;
                        }
                        if (refType === 'thread' && refId.length > 16) {
                        return refId.substring(0, 16) + '&hellip;';
                        }
                        return refId;
                        }


                        /* ── Per-type click handlers ─────────────────────────────────── */

                        function chatRefClick(refType, refId) {
                        const ref = '@' + refType + ':' + refId;

                        /* thread: navigate directly */
                        if (refType === 'thread') {
                        if (typeof chatSelectThread === 'function') {
                        chatSelectThread(refId);
                        }
                        return;
                        }

                        /* code/doc/file: open content preview */
                        if (refType === 'code' || refType === 'doc' || refType === 'file') {
                        if (typeof contentPreviewFile === 'function') {
                        const fname = refId.split('/').pop();
                        contentPreviewFile(refId, fname);
                        } else if (typeof openFileInEditor === 'function') {
                        openFileInEditor(refId);
                        }
                        return;
                        }

                        /* media: open content preview */
                        if (refType === 'media') {
                        chatRefClickMedia(refId);
                        return;
                        }

                        /* everything else: resolve + render modal */
                        api('/chat/refs/resolve?ref=' + encodeURIComponent(ref)).then(function(data) {
                        if (data.error || !data.exists) {
                        modalOpen({
                        title: _REF_CHIP_ICONS[refType] + ' Reference Not Found',
                        body: `<div class="chat-ref-modal-empty">
                            <p>Could not resolve <code>${esc(ref)}</code></p>
                            ${data.error ? '<p class="chat-ref-modal-error">' + esc(data.error) + '</p>' : ''}
                        </div>`
                        });
                        return;
                        }
                        _chatRefOpenModal(refType, refId, data);
                        }).catch(function(e) {
                        modalOpen({
                        title: '&#x274C; Error',
                        body: `<p>Failed to resolve <code>${esc(ref)}</code>: ${esc(e.message)}</p>`
                        });
                        });
                        }

                        function chatRefClickMedia(refId) {
                        if (typeof contentPreviewFile === 'function') {
                        const fname = refId.split('/').pop();
                        contentPreviewFile(refId, fname);
                        }
                        }


                        /** Open a resolved-ref modal with type-adapted content */
                        function _chatRefOpenModal(refType, refId, data) {
                        let title = (_REF_CHIP_ICONS[refType] || '') + ' ';
                        let body = '';

                        if (refType === 'commit') {
                        title += 'Commit ' + (data.short_hash || refId);
                        body = `<div class="chat-ref-modal-detail">
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Hash</span>
                                <code class="chat-ref-modal-val">${esc(data.hash || refId)}</code>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Message</span>
                                <span class="chat-ref-modal-val">${esc(data.message || '')}</span>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Author</span>
                                <span class="chat-ref-modal-val">${esc(data.author || '')}</span>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Date</span>
                                <span class="chat-ref-modal-val">${esc(data.date || '')}</span>
                            </div>
                        </div>`;

                        } else if (refType === 'branch') {
                        title += 'Branch: ' + refId;
                        body = `<div class="chat-ref-modal-detail">
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Branch</span>
                                <span class="chat-ref-modal-val">${esc(refId)}</span>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">HEAD SHA</span>
                                <code class="chat-ref-modal-val">${esc(data.sha || '')}</code>
                            </div>
                        </div>`;

                        } else if (refType === 'trace') {
                        title += 'Trace: ' + (data.name || refId);
                        body = `<div class="chat-ref-modal-detail">
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Name</span>
                                <span class="chat-ref-modal-val">${esc(data.name || '')}</span>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Classification</span>
                                <span class="chat-ref-modal-val">${esc(data.classification || '')}</span>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Started</span>
                                <span class="chat-ref-modal-val">${esc(data.started_at || '')}</span>
                            </div>
                            ${data.auto_summary ? '<div class="chat-ref-modal-row"><span
                                    class="chat-ref-modal-key">Summary</span><span class="chat-ref-modal-val">' +
                                    esc(data.auto_summary) + '</span></div>' : ''}
                        </div>`;

                        } else if (refType === 'run') {
                        title += 'Run: ' + (data.run_type || refId);
                        body = `<div class="chat-ref-modal-detail">
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Type</span>
                                <span class="chat-ref-modal-val">${esc(data.run_type || '')}</span>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Summary</span>
                                <span class="chat-ref-modal-val">${esc(data.summary || '')}</span>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Status</span>
                                <span class="chat-ref-modal-val">${esc(data.status || '')}</span>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Started</span>
                                <span class="chat-ref-modal-val">${esc(data.started_at || '')}</span>
                            </div>
                        </div>`;

                        } else if (refType === 'audit') {
                        title += 'Audit: ' + (data.operation_type || refId);
                        body = `<div class="chat-ref-modal-detail">
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Operation</span>
                                <span class="chat-ref-modal-val">${esc(data.operation_type || '')}</span>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Status</span>
                                <span class="chat-ref-modal-val">${esc(data.status || '')}</span>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Automation</span>
                                <span class="chat-ref-modal-val">${esc(data.automation || '')}</span>
                            </div>
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Timestamp</span>
                                <span class="chat-ref-modal-val">${esc(data.timestamp || '')}</span>
                            </div>
                        </div>`;

                        } else if (refType === 'user') {
                        title += '@' + refId;
                        body = `<div class="chat-ref-modal-detail">
                            <div class="chat-ref-modal-row"><span class="chat-ref-modal-key">User</span>
                                <span class="chat-ref-modal-val">${esc(data.name || refId)}</span>
                            </div>
                        </div>`;

                        } else if (refType === 'release') {
                        title += 'Release: ' + refId;
                        body = '<div class="chat-ref-modal-detail">';
                            const keys = Object.keys(data);
                            for (let i = 0; i < keys.length; i++) { const key=keys[i]; if (key==='type' || key==='ref' )
                                continue; const val=data[key]; const display=(typeof val==='object' ) ?
                                JSON.stringify(val) : String(val); body +=`<div class="chat-ref-modal-row"><span
                                    class="chat-ref-modal-key">${esc(key)}</span>
                                <span class="chat-ref-modal-val">${esc(display)}</span></div>`;
                        }
                        body += '</div>';

                        } else {
                        /* generic fallback */
                        title += refType + ': ' + refId;
                        body = '<div class="chat-ref-modal-detail">';
                            const k2 = Object.keys(data);
                            for (let j = 0; j < k2.length; j++) { const k=k2[j]; if (k==='type' || k==='ref' ) continue;
                                const v=data[k]; const dv=(typeof v==='object' ) ? JSON.stringify(v) : String(v); body
                                +=`<div class="chat-ref-modal-row"><span class="chat-ref-modal-key">${esc(k)}</span>
                                <span class="chat-ref-modal-val">${esc(dv)}</span></div>`;
                        }
                        body += '</div>';
                        }

                        modalOpen({ title: title, body: body });
                        }