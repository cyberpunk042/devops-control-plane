    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //  _secrets_render.html
    //  Status bars, GitHub status alert, secret files list, main form rendering
    //  Included by: _secrets.html (Jinja2 include)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€




    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Status bars
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderVaultStatusBar(status) {
        const icon = document.getElementById('vault-status-icon');
        const text = document.getElementById('vault-status-text');
        const lockBtn = document.getElementById('vault-lock-btn');

        if (status.empty) {
            icon.textContent = 'ğŸ“­';
            text.textContent = 'No .env file found â€” create one to manage secrets';
            text.style.color = 'var(--text-secondary)';
            lockBtn.style.display = 'none';
            return;
        }

        if (status.locked) {
            icon.textContent = 'ğŸ”’';
            text.textContent = 'Vault is locked â€” secrets are encrypted at rest';
            text.style.color = 'var(--success)';
            lockBtn.textContent = 'ğŸ”“ Unlock';
            lockBtn.onclick = () => showVaultUnlockModal();
            lockBtn.style.display = '';
        } else {
            icon.textContent = 'ğŸ”“';
            if (status.has_passphrase) {
                text.textContent = `Vault is unlocked â€” auto-lock in ${status.auto_lock_minutes}min`;
            } else {
                text.textContent = 'Vault is unlocked â€” no passphrase registered (auto-lock disabled)';
            }
            text.style.color = 'var(--warning)';
            lockBtn.textContent = 'ğŸ”’ Lock';
            lockBtn.onclick = () => showVaultLockModal();
            lockBtn.style.display = '';
        }

        if (status.rate_limited) {
            text.textContent = `âš ï¸ Rate limited â€” try again in ${status.retry_after}s`;
            text.style.color = 'var(--error)';
            lockBtn.style.display = 'none';
        }
    }

    function renderGhStatusAlert(ghStatus, ghData) {
        const container = document.getElementById('gh-status-alert');
        if (!container) return;

        if (!ghStatus.installed) {
            container.innerHTML = `
                <div class="alert-bar warning">
                    <span>âš ï¸ <strong>gh CLI not installed</strong> â€” GitHub secret sync unavailable</span>
                    <button class="btn btn-sm" onclick="refreshSecrets()" title="Refresh">ğŸ”„</button>
                </div>`;
        } else if (!ghStatus.authenticated) {
            container.innerHTML = `
                <div class="alert-bar warning">
                    <span>âš ï¸ <strong>gh CLI not authenticated</strong> â€” Run <code>gh auth login</code></span>
                    <button class="btn btn-sm" onclick="refreshSecrets()" title="Refresh">ğŸ”„</button>
                </div>`;
        } else {
            container.innerHTML = `
                <div class="alert-bar success">
                    <span>âœ… <strong>gh CLI ready</strong> â€” ${ghSecrets.length} secret(s), ${ghVariables.length} variable(s) on GitHub</span>
                    <button class="btn btn-sm" onclick="refreshSecrets()" title="Refresh">ğŸ”„</button>
                </div>`;
        }
    }

    function renderSecretFiles(files) {
        const container = document.getElementById('secrets-form');
        if (!files.length) return;

        const filesHtml = `
        <div class="secret-files-header">
            <span class="secret-files-title">Detected Secret Files</span>
        </div>
        <div class="secret-files-list">
            ${files.map(f => {
            const statusCls = f.locked ? 'ok' : 'degraded';
            const statusLabel = f.locked ? 'encrypted' : 'plaintext';
            const icon = f.locked ? 'ğŸ”’' : 'ğŸ“„';
            const sizeStr = f.locked
                ? (f.vault_size ? `${(f.vault_size / 1024).toFixed(1)}KB vault` : '')
                : (f.size ? `${(f.size / 1024).toFixed(1)}KB` : '');
            return `<div class="secret-file-row">
                    <span class="secret-file-icon">${icon}</span>
                    <span class="secret-file-name">${esc(f.name)}</span>
                    <span class="secret-file-size">${sizeStr}</span>
                    <span class="status-badge ${statusCls}" style="font-size:0.7rem;padding:2px 8px;">
                        <span class="status-dot"></span>${statusLabel}
                    </span>
                </div>`;
        }).join('')}
        </div>`;

        container.insertAdjacentHTML('afterbegin', filesHtml);
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Main form rendering â€” section-based, orchestrator-style
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderSecretsForm(data, status) {
        const container = document.getElementById('secrets-form');

        // â”€â”€ STATE: empty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (data.state === 'empty') {
            container.innerHTML = `
            <div class="env-empty-state" style="margin-top:var(--space-lg)">
                <div class="empty-create-box">
                    <span style="font-size:2.5rem;display:block;margin-bottom:var(--space-md)">ğŸ“</span>
                    <h3 style="margin-bottom:var(--space-sm)">No .env file found</h3>
                    <p style="color:var(--text-secondary);margin-bottom:var(--space-lg);font-size:0.88rem;line-height:1.6;max-width:400px;margin-left:auto;margin-right:auto">
                        Create a <code>.env</code> to store environment variables, API keys,
                        and other secrets. You can encrypt it with the vault afterwards.
                    </p>
                    <div style="display:flex;gap:var(--space-sm);justify-content:center;flex-wrap:wrap">
                        <button class="btn btn-primary" onclick="showAddKeysModal('create')">
                            âœ¨ Create .env
                        </button>
                        <button class="btn btn-secondary" onclick="createEnvFromTemplate()">
                            ğŸ“‹ Use Template
                        </button>
                    </div>
                </div>
            </div>`;
            return;
        }

        // â”€â”€ STATE: locked â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (data.state === 'locked') {
            container.innerHTML = `
            <div class="env-keys-section" style="margin-top:var(--space-lg)">
                <div class="env-keys-locked">
                    <span style="font-size:1.5rem">ğŸ”’</span>
                    <span>Environment keys are encrypted. Unlock the vault to view them.</span>
                </div>
            </div>`;
            return;
        }

        // â”€â”€ STATE: unlocked â€” no keys â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (!data.keys || !data.keys.length) {
            container.innerHTML = `
            <div class="env-keys-section" style="margin-top:var(--space-lg)">
                <div class="empty-create-box" style="padding:var(--space-xl)">
                    <span style="font-size:2rem;display:block;margin-bottom:var(--space-sm)">ğŸ“­</span>
                    <h3 style="margin-bottom:var(--space-sm);font-size:0.95rem">.env is empty</h3>
                    <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:var(--space-md);line-height:1.5">
                        Your <code>.env</code> file exists but has no key-value entries yet.
                    </p>
                    <button class="btn btn-primary" onclick="showAddKeysModal('add')">
                        âœ¨ Add Keys
                    </button>
                </div>
            </div>`;
            return;
        }

        // â”€â”€ Build section-based form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const sections = data.sections && data.sections.length > 0
            ? data.sections
            : [{ name: 'Environment Variables', keys: data.keys }];

        const defaultCollapsed = sections.length > 3
            ? sections.slice(2).map(s => s.name)
            : [];

        let html = '';

        // GitHub status alert placeholder
        html += '<div id="gh-status-alert"></div>';

        for (const section of sections) {
            const catId = section.name.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
            const storageKey = `secrets-collapse-${catId}`;
            const storedState = sessionStorage.getItem(storageKey);
            const isCollapsed = storedState !== null
                ? storedState === 'true'
                : defaultCollapsed.includes(section.name);

            const configuredCount = section.keys.filter(k => k.has_value).length;
            const totalCount = section.keys.length;
            const badgeBg = configuredCount === totalCount
                ? 'var(--success)' : configuredCount > 0 ? 'var(--warning)' : 'var(--bg-inset)';
            const badgeColor = configuredCount === totalCount
                ? '#fff' : configuredCount > 0 ? '#000' : 'var(--text-muted)';
            const badge = `<span style="font-size:0.7rem;padding:0.1rem 0.4rem;border-radius:4px;background:${badgeBg};color:${badgeColor};margin-left:0.5rem">${configuredCount}/${totalCount}</span>`;

            const isGeneral = section.name === 'General';
            const renameBtn = !isGeneral
                ? `<span class="btn-icon" style="font-size:0.65rem;margin-left:0.25rem;cursor:pointer;opacity:0.5;" title="Rename section" onclick="event.stopPropagation(); renameSectionPrompt('${esc(section.name)}')">âœï¸</span>`
                : '';

            html += `
                <div class="section-title" style="cursor:pointer;user-select:none;display:flex;align-items:center;gap:0.35rem;"
                     onclick="toggleSecretSection('${catId}')">
                    <span id="secrets-chevron-${catId}" style="transition:transform 0.2s;display:inline-block;transform:rotate(${isCollapsed ? '0deg' : '90deg'});font-size:0.7rem;">â–¶</span>
                    <span>${esc(section.name)}</span>
                    ${badge}
                    ${renameBtn}
                </div>
                <div id="secrets-section-${catId}" style="display:${isCollapsed ? 'none' : 'block'};">`;

            for (const k of section.keys) {
                const kindIcon = k.kind === 'secret' ? 'ğŸ”‘' : 'âš™ï¸';
                const kindTitle = k.kind === 'secret' ? 'Secret' : 'Config';
                const isSecret = k.kind === 'secret';
                const inputType = isSecret ? 'password' : 'text';
                const currentValue = !isSecret && k.has_value ? (k.value || '') : '';
                const placeholder = k.has_value
                    ? (isSecret ? 'â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢' : (k.masked || 'Enter valueâ€¦'))
                    : 'Enter valueâ€¦';

                const tier = getSecretTier(k.key, k);
                const ghSet = ghSecrets.includes(k.key.toUpperCase());
                const varSet = ghVariables.includes(k.key.toUpperCase());

                // Local status column
                const localStatusHtml = `
                    <div title="Local (.env)">${k.has_value ? 'âœ…' : 'âŒ'} Local</div>
                    ${k.has_value ? `<button class="btn-icon" onclick="markForDeletion('${esc(k.key)}')" style="font-size:0.7rem;" title="Mark ${esc(k.key)} for deletion">ğŸ—‘ï¸</button>` : ''}
                `;

                // GitHub status column â€” derived from tier
                let ghColumn;
                const isOnGh = ghSet || varSet;
                const canDeleteGh = (tier === 'secret' && ghSet) || (tier === 'var' && varSet);
                const deleteKind = tier === 'var' ? 'variable' : 'secret';

                switch (tier) {
                    case 'auto':
                        ghColumn = `<div title="Auto-provided by GitHub Actions â€” cannot be overridden" style="color:var(--text-muted)">ğŸ”„ Auto</div>`;
                        break;
                    case 'local':
                        ghColumn = `
                            <div title="Local only â€” not pushed to GitHub" style="color:var(--text-muted)">ğŸ“ Local</div>
                            <button class="btn-icon" onclick="toggleLocalOnly('${esc(k.key)}', false)" style="font-size:0.65rem;" title="Enable GitHub sync for ${esc(k.key)}">â†—ï¸</button>
                        `;
                        break;
                    case 'secret':
                        ghColumn = `
                            <div title="GitHub Secret (gh secret set)">${ghSet ? 'âœ…' : 'âŒ'} Secret</div>
                            <button class="btn-icon" onclick="toggleLocalOnly('${esc(k.key)}', true)" style="font-size:0.65rem;" title="Make ${esc(k.key)} local-only">ğŸ“Œ</button>
                        `;
                        break;
                    case 'var':
                        ghColumn = `
                            <div title="GitHub Variable (gh variable set)">${varSet ? 'âœ…' : 'âŒ'} Variable</div>
                            <button class="btn-icon" onclick="toggleLocalOnly('${esc(k.key)}', true)" style="font-size:0.65rem;" title="Make ${esc(k.key)} local-only">ğŸ“Œ</button>
                        `;
                        break;
                }

                html += `
                    <div class="secret-config-row" data-key-name="${esc(k.key)}">
                        <div class="secret-config-name" translate="no">
                            <span class="env-key-kind" title="${kindTitle} â€” click to move section" style="cursor:pointer" onclick="showMoveKeyMenu(event, '${esc(k.key)}')">${kindIcon}</span>
                            ${esc(k.key)}
                        </div>
                        <div class="secret-config-value">
                            <input type="${inputType}"
                                   id="secret-${esc(k.key)}"
                                   data-secret-name="${esc(k.key)}"
                                   data-is-secret="${isSecret}"
                                   data-tier="${tier}"
                                   data-kind="${k.kind}"
                                   placeholder="${placeholder}"
                                   value="${esc(currentValue)}"
                                   autocomplete="off">
                        </div>
                        <div class="secret-config-status" style="text-align:center;font-size:0.8rem;display:flex;align-items:center;gap:0.25rem;justify-content:center;">
                            ${localStatusHtml}
                        </div>
                        <div class="secret-config-status" style="text-align:center;font-size:0.8rem;display:flex;align-items:center;gap:0.25rem;justify-content:center;">
                            ${ghColumn}
                            ${canDeleteGh ? `<button class="btn-icon" onclick="removeSecret('${esc(k.key)}','github','${deleteKind}')" style="font-size:0.7rem;" title="Remove ${esc(k.key)} from GitHub">ğŸ—‘ï¸</button>` : ''}
                        </div>
                    </div>`;
            }

            html += `</div>`;  // close collapsible section
        }

        // â”€â”€ Add Keys button â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `
            <div style="margin-top:var(--space-lg);display:flex;justify-content:center;">
                <button class="btn btn-primary btn-sm" onclick="showAddKeysModal('add')">
                    + Add Keys
                </button>
            </div>`;

        // â”€â”€ Pending sync badge counts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Count pushable keys that are not yet on GitHub
        let pendingSecrets = 0, pendingVars = 0;
        for (const k of envKeys) {
            if (!k.has_value) continue;
            const t = getSecretTier(k.key, k);
            if (t === 'auto' || t === 'local') continue;
            if (t === 'secret' && !ghSecrets.includes(k.key.toUpperCase())) pendingSecrets++;
            if (t === 'var' && !ghVariables.includes(k.key.toUpperCase())) pendingVars++;
        }
        const totalPending = pendingSecrets + pendingVars;

        // â”€â”€ Save Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `
            <div style="margin-top:1.5rem;padding-top:1rem;border-top:1px solid var(--border-subtle);">
                <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;">
                    <label style="color:var(--text-muted);">Save to:</label>
                    <div style="display:flex;border:1px solid var(--border);border-radius:8px;overflow:hidden;">
                        <button type="button" class="target-btn active" data-target="both" onclick="selectTarget('both')">Both</button>
                        <button type="button" class="target-btn" data-target="local" onclick="selectTarget('local')">Local Only</button>
                        <button type="button" class="target-btn" data-target="github" onclick="selectTarget('github')">GitHub Only</button>
                    </div>
                    <button class="btn btn-primary" id="save-secrets-btn" onclick="pushSecrets(currentTarget)" disabled>ğŸ’¾ Save & Push</button>
                    <span id="sync-pending-badge" style="font-size:0.8rem;color:var(--warning);${totalPending > 0 ? '' : 'display:none;'}"></span>
                </div>
            </div>`;

        // â”€â”€ Manage Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `
            <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border-subtle);">
                <div style="font-size:0.85rem;font-weight:600;color:var(--text-muted);margin-bottom:0.75rem;">ğŸ› ï¸ Manage</div>
                <div style="display:flex;gap:0.75rem;flex-wrap:wrap;">
                    <button class="btn btn-secondary btn-sm" onclick="syncEnvToGithub()" title="Force re-push all .env values to GitHub (secrets + variables)">â˜ï¸ Sync .env â†’ GitHub</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearSecretsPrompt('local')" title="Clear all local .env secret values" style="color:var(--warning);">ğŸ—‘ï¸ Clear Local</button>
                    <button class="btn btn-secondary btn-sm" onclick="clearSecretsPrompt('github')" title="Remove all GitHub secrets" style="color:var(--error);">ğŸ—‘ï¸ Clear GitHub</button>
                </div>
            </div>`;

        container.innerHTML = html;

        // Re-render gh status alert now that the placeholder exists
        api('/gh/status').then(s => api('/gh/secrets').then(d => renderGhStatusAlert(s, d))).catch(() => { });

        // Snapshot initial values for dirty tracking
        secretsInitialValues = {};
        document.querySelectorAll('#secrets-form [data-secret-name]').forEach(el => {
            secretsInitialValues[el.dataset.secretName] = el.value;
        });
        secretsDirty = false;
        secretsLoaded = true;

        // Listen for changes
        document.getElementById('secrets-form').addEventListener('input', (e) => {
            if (e.target.dataset && e.target.dataset.secretName && e.target.dataset.markedDelete) {
                unmarkDeletion(e.target.dataset.secretName);
            }
            checkSecretsDirty();
        });
        document.getElementById('secrets-form').addEventListener('change', (e) => {
            if (e.target.dataset && e.target.dataset.secretName && e.target.dataset.markedDelete) {
                unmarkDeletion(e.target.dataset.secretName);
            }
            checkSecretsDirty();
        });

        checkSecretsDirty();
    }
