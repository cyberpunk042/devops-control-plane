<!-- Integrations â€” Docker Setup Wizard
     Depends on: _integrations_setup_shared.html

     Split into raw JS includes:
       docker_wizard/_raw_step1_detect.html      â€” step 1: detect
       docker_wizard/_raw_step2_configure.html    â€” step 2: configure
       docker_wizard/_raw_step3_preview.html      â€” step 3: preview
-->
<script>

    // â”€â”€ Docker Setup Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function openDockerSetupWizard() {

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        /** Determine if a module is a container candidate based on domain + stack. */
        function _dockerModClass(mod) {
            const dom = (mod.domain || '').toLowerCase();
            const st  = (mod.stack  || '').toLowerCase();
            if (dom === 'library')  return 'library';
            if (dom === 'docs' || st === 'markdown') return 'docs';
            if (['kubernetes', 'helm', 'terraform', 'docker-compose'].includes(st)) return 'ops-tool';
            return 'deployable';
        }

        /** Resolve the Dockerfile template family a stack maps to. */
        function _dockerStackFamily(stack) {
            const families = ['python','node','typescript','go','rust','java-maven','java-gradle','dotnet','elixir','ruby'];
            if (families.includes(stack)) return stack;
            for (const f of families) {
                if (stack.startsWith(f + '-')) return f;
            }
            return null;
        }

        /** Default port for a stack family. */
        function _dockerPort(family) {
            return (_dockerStackDefaults[family] || {}).expose || 8080;
        }

        // â”€â”€ Docker stack defaults â€” loaded from DataRegistry â”€â”€
        const _dockerStackDefaults = window._dcp.dockerDefaults;
        const _restartPolicies = window._dcp.dockerOptions.restart_policies;
        const _platformOptions = window._dcp.dockerOptions.platform_options;


        wizardModalOpen({
            title: 'ðŸ³ Docker Setup',
            assistantContext: 'setup/docker',
            size: 'wide',
            steps: [
                // â”€â”€ Step 1: Detect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {% include 'scripts/docker_wizard/_raw_step1_detect.html' %}

                // â”€â”€ Step 2: Configure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {% include 'scripts/docker_wizard/_raw_step2_configure.html' %}

                // â”€â”€ Step 3: Preview & Edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {% include 'scripts/docker_wizard/_raw_step3_preview.html' %}
            ],

            onComplete: async (data) => {
                const files = data._generatedFiles || [];
                if (files.length === 0) return;

                const results = [];
                for (const file of files) {
                    try {
                        const res = await api('/docker/generate/write', {
                            method: 'POST',
                            body: JSON.stringify({ file: { ...file, overwrite: true } }),
                        });
                        results.push({ path: file.path, ok: !res.error, error: res.error });
                    } catch (e) {
                        results.push({ path: file.path, ok: false, error: e.message });
                    }
                }

                const ok = results.filter(r => r.ok).length;
                const fail = results.filter(r => !r.ok);
                if (fail.length > 0) {
                    console.warn('Docker write failures:', fail);
                }

                _projectStatusTS = 0;
                cardInvalidate('docker');
            },
            successMessage: 'Docker setup complete!',
        });
    }


</script>
