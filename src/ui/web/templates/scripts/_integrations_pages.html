<!-- Integrations Tab JS ‚Äî Pages Card
     loadPagesCard(), pagesInit(), segment management (add, remove),
     install builder, builder re-init, segment wizard.
     Depends on: _integrations_init.html (card registry)
-->
    // ‚îÄ‚îÄ Pages Card ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    async function loadPagesCard() {
        const badge = document.getElementById('int-pages-badge');
        const detail = document.getElementById('int-pages-detail');

        try {
            const cached = cardCached('pages');
            let segData, bdData;
            if (cached) {
                segData = cached.segData;
                bdData = cached.bdData;
            } else {
                [segData, bdData] = await Promise.all([
                    api('/pages/segments'),
                    api('/pages/builders').catch(() => ({ builders: [] })),
                ]);
                cardStore('pages', { segData, bdData });
            }

            const segments = segData.segments || [];
            const builders = bdData.builders || [];

            if (segments.length === 0) {
                badge.className = 'status-badge degraded';
                badge.innerHTML = '<span class="status-dot"></span>No segments';
                detail.innerHTML = `
                <div style="text-align:center;padding:var(--space-lg)">
                    <p style="color:var(--text-muted);margin-bottom:var(--space-md)">No page segments configured yet.</p>
                    <div style="display:flex;gap:var(--space-sm);justify-content:center">
                        <button class="btn btn-sm btn-primary" onclick="pagesInit()" title="Auto-detect from content_folders">üîç Auto-Init</button>
                        <button class="btn btn-sm btn-secondary" onclick="addSegmentModal()">+ Add Segment</button>
                    </div>
                </div>`;
                return;
            }

            // Count stages
            const built = segments.filter(s => s.build).length;
            const total = segments.length;
            badge.className = built === total ? 'status-badge ok' : 'status-badge degraded';
            badge.innerHTML = `<span class="status-dot"></span>${built}/${total} built`;

            // ‚îÄ‚îÄ Segment rows with pipeline stages ‚îÄ‚îÄ
            const listHtml = segments.map(seg => {
                const buildInfo = seg.build;
                const serveUrl = buildInfo && buildInfo.serve_url ? buildInfo.serve_url : '';
                const buildOk = !!buildInfo;

                // Pipeline dots: source ‚Üí build ‚Üí serve
                const stageDotsHtml = `
                    <span title="Source" style="color:var(--success)">‚óè</span>
                    <span style="color:var(--text-muted);font-size:0.5rem">‚Üí</span>
                    <span title="Built" style="color:${buildOk ? 'var(--success)' : 'var(--text-muted)'}">‚óè</span>
                    <span style="color:var(--text-muted);font-size:0.5rem">‚Üí</span>
                    <span title="Served" style="color:${serveUrl ? '#6366f1' : 'var(--text-muted)'}">‚óè</span>`;

                const buildAgo = buildInfo ? _timeAgo(buildInfo.built_at) : '';
                const duration = buildInfo ? `${buildInfo.duration_ms}ms` : '';
                const timeInfo = buildAgo ? `${buildAgo}${duration ? ' ¬∑ ' + duration : ''}` : '';

                // Primary action: View Site (only when built)
                const viewSiteBtn = serveUrl
                    ? `<a href="${serveUrl}" target="_blank" class="btn btn-sm btn-primary" style="padding:0.15rem 0.5rem;font-size:0.68rem;text-decoration:none;display:inline-flex;align-items:center;gap:0.2rem" title="View built site">üåê View</a>`
                    : `<span style="font-size:0.68rem;color:var(--text-muted);font-style:italic">not built</span>`;

                // Browse build workspace in Content Vault (.pages/<segment>)
                const buildSourceBtn = buildOk
                    ? `<button class="btn btn-sm btn-ghost" onclick="switchTab('content/docs/.pages/${esc(seg.name)}')" title="Browse build workspace (.pages/${esc(seg.name)}/)" style="padding:0.15rem 0.5rem;font-size:0.68rem;display:inline-flex;align-items:center;gap:0.2rem">üìÇ Build Source</button>`
                    : '';

                return `
                <div style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0;border-bottom:1px solid var(--border-subtle);font-size:0.82rem" data-segment-row="${esc(seg.name)}">
                    <span style="display:flex;gap:0.15rem;align-items:center;flex-shrink:0;font-size:0.6rem">${stageDotsHtml}</span>
                    <span style="font-weight:600;min-width:60px">${esc(seg.name)}</span>
                    <code style="font-family:var(--font-mono);font-size:0.72rem;color:var(--text-muted);cursor:pointer;text-decoration:underline dotted;text-underline-offset:2px" onclick="switchTab('content/docs/${esc(seg.source)}')" title="Browse content source in Content Vault">${esc(seg.source)}</code>
                    <span style="background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:4px;padding:0 0.4rem;font-size:0.68rem;color:var(--accent);cursor:pointer" onclick="configureSegment('${esc(seg.name)}','${esc(seg.builder)}','${esc(seg.source)}','${esc(seg.path)}')" title="Click to change builder">${esc(seg.builder)} ‚ñæ</span>
                    ${viewSiteBtn}
                    ${buildSourceBtn}
                    <span class="segment-build-status" style="display:none"></span>
                    <span style="color:var(--text-muted);font-size:0.68rem;margin-left:auto">${timeInfo}</span>
                    <button class="btn btn-sm btn-ghost" onclick="buildSegmentStream('${esc(seg.name)}')" title="Build with pipeline" style="padding:0.1rem 0.3rem;font-size:0.72rem">üî®</button>
                    <button class="btn btn-sm btn-ghost" onclick="buildSegmentStream('${esc(seg.name)}', {clean:true})" title="Clean build (wipe caches)" style="padding:0.1rem 0.3rem;font-size:0.72rem">üßπ</button>
                    <button class="btn btn-sm btn-ghost" onclick="buildSegmentStream('${esc(seg.name)}', {wipe:true})" title="Full rebuild (wipe workspace)" style="padding:0.1rem 0.3rem;font-size:0.72rem">üîÑ</button>
                    <button class="btn btn-sm btn-ghost" onclick="removeSegment('${esc(seg.name)}')" title="Remove" style="padding:0.1rem 0.3rem;font-size:0.72rem;color:var(--error)">‚úï</button>
                </div>`;
            }).join('');

            // ‚îÄ‚îÄ Pipeline actions (sequential flow) ‚îÄ‚îÄ
            const pipelineHtml = `
            <div style="margin-top:var(--space-md)">
                <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:var(--space-sm)">
                    <span style="font-size:0.72rem;font-weight:600;color:var(--text-muted)">Pipeline:</span>
                    <span style="font-size:0.72rem;color:var(--text-muted)">Segments</span>
                    <span style="font-size:0.6rem;color:var(--text-muted)">‚Üí</span>
                    <span style="font-size:0.72rem;color:${built === total ? 'var(--success)' : 'var(--text-muted)'}">Build</span>
                    <span style="font-size:0.6rem;color:var(--text-muted)">‚Üí</span>
                    <span style="font-size:0.72rem;color:var(--text-muted)">Merge</span>
                    <span style="font-size:0.6rem;color:var(--text-muted)">‚Üí</span>
                    <span style="font-size:0.72rem;color:var(--text-muted)">Deploy</span>
                </div>
                <div style="display:flex;gap:var(--space-sm);flex-wrap:wrap">
                    <button class="btn btn-sm btn-secondary" onclick="addSegmentModal()">+ Segment</button>
                    <button class="btn btn-sm btn-secondary" onclick="buildAllSegments()">üî® Build All</button>
                    <button class="btn btn-sm btn-secondary" onclick="mergeSegments()" ${built < total ? 'disabled title="Build all segments first"' : ''}>üì¶ Merge</button>
                    <button class="btn btn-sm btn-primary" onclick="deployPages()" ${built < total ? 'disabled' : ''}>üöÄ Deploy</button>
                    <button class="btn btn-sm btn-secondary" onclick="generateCI()" title="Generate deploy workflow">‚öôÔ∏è CI</button>
                    <button class="btn btn-sm btn-ghost" onclick="pagesInit()" title="Re-detect from content_folders">üîç Re-Init</button>
                </div>
            </div>`;

            // ‚îÄ‚îÄ Builders panel with install buttons ‚îÄ‚îÄ
            let buildersHtml = '';
            if (builders.length > 0) {
                const chips = builders.map(b => {
                    if (b.available) {
                        return `<span style="font-size:0.68rem;padding:0.1rem 0.4rem;border:1px solid var(--success);border-radius:4px;color:var(--success)" title="${esc(b.description)}">‚úì ${esc(b.label)}</span>`;
                    }
                    const installBtn = b.installable
                        ? `<button class="btn btn-sm btn-ghost" onclick="installBuilder('${esc(b.name)}')" style="padding:0 0.3rem;font-size:0.62rem;color:var(--accent);border:1px solid var(--accent);border-radius:3px;margin-left:0.2rem" title="${esc(b.install_hint)}">Install</button>`
                        : `<span style="font-size:0.6rem;color:var(--text-muted);margin-left:0.2rem" title="${esc(b.install_hint)}">‚ìò</span>`;
                    return `<span style="display:inline-flex;align-items:center;gap:0.15rem;font-size:0.68rem;padding:0.1rem 0.4rem;border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-muted)" title="${esc(b.description)}">${esc(b.label)}${installBtn}</span>`;
                }).join(' ');
                buildersHtml = `<div style="margin-top:var(--space-sm);display:flex;gap:0.3rem;align-items:center;flex-wrap:wrap"><span style="font-size:0.68rem;color:var(--text-muted)">Builders:</span> ${chips}</div>`;
            }

            detail.innerHTML = `
            <div style="font-size:0.85rem;color:var(--text-secondary)">
                ${listHtml}
                ${pipelineHtml}
                ${buildersHtml}
            </div>`;

        } catch (e) {
            badge.className = 'status-badge failed';
            badge.innerHTML = '<span class="status-dot"></span>Error';
            detail.innerHTML = `<p class="empty-state-sm" style="color:var(--error)">${esc(e.message)}</p>`;
        }
    }

    async function pagesInit() {
        toast('Detecting content folders‚Ä¶', 'info');
        try {
            const data = await api('/pages/init', { method: 'POST', body: '{}' });
            const details = data.details || [];

            if (data.added && data.added.length > 0) {
                // Check if any segments have suggestions (i.e. fell back to a suboptimal builder)
                const withSuggestions = details.filter(d => d.suggestion);

                if (withSuggestions.length > 0) {
                    // Show a modal explaining what happened and offering to install better builders
                    _showInitResultsModal(details);
                } else {
                    for (const d of details) {
                        toast(`Added '${d.name}' ‚Üí ${d.builder}`, 'success');
                    }
                }
            } else {
                toast('No new segments to add ‚Äî segments already configured', 'info');
            }
            await loadPagesCard();
        } catch (e) {
            toast('Init failed: ' + e.message, 'error');
        }
    }

    function _showInitResultsModal(details) {
        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'init-results-modal';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

        let rowsHtml = '';
        for (const d of details) {
            const hasSuggestion = !!d.suggestion;
            const suggestHtml = hasSuggestion
                ? `<div style="margin-top:0.3rem;font-size:0.72rem;color:var(--warning)">
                    üí° ${esc(d.suggestion)}
                    ${d.suggestion.includes('Node.js') ? `<button class="btn btn-sm btn-primary" style="margin-left:0.4rem;padding:0.1rem 0.5rem;font-size:0.68rem" onclick="document.getElementById('init-results-modal').remove();installBuilderThenReinit('docusaurus')">üì¶ Install Docusaurus</button>` : ''}
                    ${d.suggestion.includes('mkdocs') ? `<button class="btn btn-sm btn-secondary" style="margin-left:0.4rem;padding:0.1rem 0.5rem;font-size:0.68rem" onclick="document.getElementById('init-results-modal').remove();installBuilderThenReinit('mkdocs')">üì¶ Install MkDocs</button>` : ''}
                  </div>`
                : '';
            rowsHtml += `
                <div style="padding:0.6rem;background:var(--bg-inset);border:1px solid ${hasSuggestion ? 'var(--warning)' : 'var(--border-subtle)'};border-radius:6px">
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <span style="font-weight:600">${esc(d.name)}</span>
                        <span style="font-size:0.72rem;color:var(--accent);background:var(--bg-base);padding:0 0.4rem;border-radius:3px;border:1px solid var(--border-subtle)">${esc(d.builder)}</span>
                    </div>
                    <div style="font-size:0.72rem;color:var(--text-muted);margin-top:0.2rem">${esc(d.reason)}</div>
                    ${suggestHtml}
                </div>`;
        }

        modal.innerHTML = `
        <div class="vault-modal" style="max-width:560px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                <h3 style="margin:0">üîç Detection Results</h3>
                <button class="btn btn-sm btn-ghost" onclick="document.getElementById('init-results-modal').remove()" style="font-size:1rem;padding:0.1rem 0.4rem">‚úï</button>
            </div>
            <div style="display:flex;flex-direction:column;gap:0.4rem;margin-bottom:var(--space-md)">
                ${rowsHtml}
            </div>
            <div style="text-align:right">
                <button class="btn btn-sm btn-secondary" onclick="document.getElementById('init-results-modal').remove()">OK</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }

    async function installBuilderThenReinit(builderName) {
        // Install the builder, then re-run init to pick it up
        await _installBuilderAsync(builderName);
    }

    function _installBuilderAsync(name) {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'vault-modal-overlay';
            modal.id = 'install-modal';
            modal.onclick = (e) => { if (e.target === modal) return; };
            modal.innerHTML = `
            <div class="vault-modal" style="max-width:600px">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                    <h3 style="margin:0">üì¶ Installing: ${esc(name)}</h3>
                    <button class="btn btn-sm btn-ghost" id="install-close-x" onclick="document.getElementById('install-modal').remove();loadPagesCard()" style="font-size:1rem;padding:0.1rem 0.4rem">‚úï</button>
                </div>
                <div id="install-log" style="background:#0d0f17;border:1px solid var(--border-subtle);border-radius:6px;padding:0.75rem;font-family:var(--font-mono);font-size:0.68rem;max-height:300px;overflow-y:auto;line-height:1.6;color:#a0aec0;white-space:pre-wrap"></div>
                <div id="install-status" style="margin-top:var(--space-sm);font-size:0.82rem">
                    <span class="spinner" style="width:0.8rem;height:0.8rem;display:inline-block;vertical-align:middle;margin-right:0.3rem"></span> Installing‚Ä¶
                </div>
                <div style="margin-top:var(--space-md);display:flex;gap:var(--space-sm);justify-content:flex-end">
                    <button class="btn btn-sm btn-secondary" id="install-reinit-btn" style="display:none" onclick="document.getElementById('install-modal').remove();pagesReInit()">üîÑ Re-Init with ${esc(name)}</button>
                    <button class="btn btn-sm btn-secondary" onclick="document.getElementById('install-modal').remove();loadPagesCard()">Close</button>
                </div>
            </div>`;
            document.body.appendChild(modal);

            const logEl = document.getElementById('install-log');
            const statusEl = document.getElementById('install-status');
            const reinitBtn = document.getElementById('install-reinit-btn');

            fetch('/api/pages/builders/' + encodeURIComponent(name) + '/install', { method: 'POST' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (ct.includes('application/json')) {
                    return response.json().then(data => {
                        if (data.already_installed) {
                            statusEl.innerHTML = '<span style="color:var(--success)">‚úÖ Already installed</span>';
                        } else if (data.error) {
                            statusEl.innerHTML = `<span style="color:var(--error)">‚ùå ${esc(data.error)}</span>`;
                        }
                        reinitBtn.style.display = '';
                        loadPagesCard();
                        resolve();
                    });
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            if (statusEl.textContent.includes('Installing')) {
                                statusEl.innerHTML = '<span style="color:var(--warning)">‚ö†Ô∏è Stream ended</span>';
                            }
                            reinitBtn.style.display = '';
                            loadPagesCard();
                            resolve();
                            return;
                        }
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (!line.startsWith('data: ')) continue;
                            try {
                                const evt = JSON.parse(line.slice(6));
                                if (evt.type === 'log') {
                                    logEl.textContent += evt.line + '\n';
                                    logEl.scrollTop = logEl.scrollHeight;
                                } else if (evt.type === 'done') {
                                    if (evt.ok) {
                                        statusEl.innerHTML = `<span style="color:var(--success)">‚úÖ ${esc(evt.message)}</span>`;
                                        reinitBtn.style.display = '';
                                    } else {
                                        statusEl.innerHTML = `<span style="color:var(--error)">‚ùå ${esc(evt.error)}</span>`;
                                    }
                                    loadPagesCard();
                                    resolve();
                                }
                            } catch (_) {}
                        }
                        read();
                    }).catch(err => {
                        statusEl.innerHTML = `<span style="color:var(--error)">‚ö†Ô∏è ${esc(err.message)}</span>`;
                        resolve();
                    });
                }
                read();
            })
            .catch(err => {
                statusEl.innerHTML = `<span style="color:var(--error)">‚ùå ${esc(err.message)}</span>`;
                resolve();
            });
        });
    }

    async function pagesReInit() {
        // Delete existing segments and re-init with better builders
        try {
            const segData = await api('/pages/segments');
            for (const seg of (segData.segments || [])) {
                if (seg.auto) {
                    await api('/pages/segments/' + encodeURIComponent(seg.name), { method: 'DELETE' });
                }
            }
            await pagesInit();
        } catch (e) {
            toast('Re-init failed: ' + e.message, 'error');
        }
    }

    function installBuilder(name) {
        _installBuilderAsync(name);
    }

    function addSegmentModal() {
        // Fetch builders and features in parallel
        let _wizBuilders = [];
        let _wizCategories = [];
        Promise.all([
            api('/pages/builders').catch(() => ({ builders: [] })),
            api('/pages/features').catch(() => ({ categories: [] })),
        ]).then(([bd, fd]) => {
            _wizBuilders = bd.builders || [];
            _wizCategories = fd.categories || [];
            renderWizStep();
        });

        let _wizStep = 1;
        let _wizData = { name: '', source: '', builder: 'docusaurus', path: '', features: {} };

        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'vault-modal';
        modal.innerHTML = `
        <div class="vault-modal" style="max-width:520px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                <h3 style="margin:0">‚ú® New Segment</h3>
                <button class="btn btn-sm btn-ghost" onclick="closeVaultModal()" style="font-size:1.1rem;padding:0.1rem 0.4rem" title="Close">‚úï</button>
            </div>
            <div id="wiz-progress" style="display:flex;gap:0.5rem;align-items:center;justify-content:center;margin-bottom:var(--space-md)"></div>
            <div id="wiz-body" style="min-height:180px"></div>
            <div id="wiz-error" style="display:none;color:var(--error);font-size:0.78rem;margin-top:var(--space-sm)"></div>
            <div id="wiz-actions" style="display:flex;gap:var(--space-sm);justify-content:flex-end;padding-top:var(--space-md);border-top:1px solid var(--border-subtle);margin-top:var(--space-sm)"></div>
        </div>`;
        document.body.appendChild(modal);

        function renderProgress() {
            const labels = ['Name & Source', 'Builder', 'Configure'];
            document.getElementById('wiz-progress').innerHTML = labels.map((l, i) => {
                const step = i + 1;
                const active = step === _wizStep;
                const done = step < _wizStep;
                const color = active ? '#818cf8' : done ? 'var(--success)' : 'var(--text-muted)';
                return `<div style="display:flex;align-items:center;gap:0.25rem">
                    <span style="width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:700;background:${active ? 'rgba(99,102,241,0.15)' : 'transparent'};border:1.5px solid ${color};color:${color}">${done ? '‚úì' : step}</span>
                    <span style="font-size:0.68rem;color:${color};font-weight:${active ? '600' : '400'}">${l}</span>
                    ${i < 2 ? '<span style="color:var(--text-muted);font-size:0.5rem;margin:0 0.15rem">‚Üí</span>' : ''}
                </div>`;
            }).join('');
        }

        function renderWizStep() {
            renderProgress();
            const body = document.getElementById('wiz-body');
            const actions = document.getElementById('wiz-actions');
            const errEl = document.getElementById('wiz-error');
            errEl.style.display = 'none';

            if (_wizStep === 1) {
                body.innerHTML = `
                    <div class="form-group" style="margin-bottom:var(--space-sm)">
                        <label style="font-size:0.78rem;font-weight:600">Segment Name</label>
                        <input type="text" id="wiz-name" value="${esc(_wizData.name)}" placeholder="e.g. docs, blog, api-reference" style="width:100%;margin-top:0.2rem" autocomplete="off">
                        <div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.15rem">Short identifier ‚Äî used in URLs and file paths</div>
                    </div>
                    <div class="form-group" style="margin-bottom:var(--space-sm)">
                        <label style="font-size:0.78rem;font-weight:600">Source Folder</label>
                        <input type="text" id="wiz-source" value="${esc(_wizData.source)}" placeholder="e.g. docs, content/guides" style="width:100%;margin-top:0.2rem" autocomplete="off">
                        <div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.15rem">Path to your markdown/content files (relative to project root)</div>
                    </div>`;
                actions.innerHTML = `
                    <button class="btn btn-sm btn-ghost" onclick="closeVaultModal()">Cancel</button>
                    <button class="btn btn-sm btn-primary" id="wiz-next" onclick="">Next ‚Üí</button>`;
                document.getElementById('wiz-next').onclick = () => {
                    _wizData.name = document.getElementById('wiz-name').value.trim();
                    _wizData.source = document.getElementById('wiz-source').value.trim();
                    if (!_wizData.name || !_wizData.source) {
                        errEl.textContent = 'Name and source folder are required';
                        errEl.style.display = 'block';
                        return;
                    }
                    if (!_wizData.path) _wizData.path = '/' + _wizData.name;
                    _wizStep = 2;
                    renderWizStep();
                };
                setTimeout(() => document.getElementById('wiz-name').focus(), 100);

            } else if (_wizStep === 2) {
                const buildersHtml = _wizBuilders.map(b => {
                    const sel = b.name === _wizData.builder;
                    const avail = b.available;
                    const borderOn = '#818cf8';
                    const borderOff = 'var(--border-subtle)';
                    const borderColor = sel ? borderOn : borderOff;
                    const bg = sel ? 'rgba(99,102,241,0.06)' : 'transparent';
                    return `
                    <label style="display:flex;align-items:flex-start;gap:0.6rem;padding:0.5rem 0.6rem;cursor:pointer;border:1.5px solid ${borderColor};border-radius:6px;background:${bg};transition:all 0.15s;margin-bottom:0.35rem" onmouseover="this.style.borderColor='${borderOn}'" onmouseout="this.style.borderColor='${borderColor}'">
                        <input type="radio" name="wiz-builder" value="${esc(b.name)}" ${sel ? 'checked' : ''} style="margin-top:0.15rem;accent-color:${borderOn}">
                        <div>
                            <div style="font-size:0.78rem;font-weight:600;color:${avail ? 'var(--text-primary)' : 'var(--text-muted)'}">${esc(b.label)} ${!avail ? '<span style="color:var(--warning);font-size:0.62rem">‚ö† not installed</span>' : ''}</div>
                            <div style="font-size:0.66rem;color:var(--text-muted);line-height:1.3;margin-top:0.1rem">${esc(b.description || '')}</div>
                        </div>
                    </label>`;
                }).join('');
                body.innerHTML = `
                    <div style="font-size:0.78rem;font-weight:600;margin-bottom:0.4rem">Choose Builder</div>
                    <div id="wiz-builders">${buildersHtml}</div>`;
                // Wire radio buttons to update visual selection
                body.querySelectorAll('input[name="wiz-builder"]').forEach(r => {
                    r.addEventListener('change', () => {
                        _wizData.builder = r.value;
                        renderWizStep();
                    });
                });
                actions.innerHTML = `
                    <button class="btn btn-sm btn-ghost" onclick="closeVaultModal()">Cancel</button>
                    <button class="btn btn-sm btn-ghost" id="wiz-back">‚Üê Back</button>
                    <button class="btn btn-sm btn-primary" id="wiz-next">Next ‚Üí</button>`;
                document.getElementById('wiz-back').onclick = () => { _wizStep = 1; renderWizStep(); };
                document.getElementById('wiz-next').onclick = () => { _wizStep = 3; renderWizStep(); };

            } else if (_wizStep === 3) {
                let featHtml = '';
                if (_wizData.builder === 'docusaurus' && _wizCategories.length) {
                    for (const cat of _wizCategories) {
                        featHtml += `<div style="margin-bottom:0.3rem"><div style="font-size:0.62rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;padding:0.25rem 0.5rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:4px 4px 0 0;border-bottom:none">${esc(cat.label)}</div><div style="border:1px solid var(--border-subtle);border-radius:0 0 4px 4px;padding:0.15rem 0;background:rgba(15,17,26,0.4)">`;
                        for (const f of cat.features) {
                            if (f.options) continue; // skip select-based for wizard simplicity
                            const on = _wizData.features[f.key] !== undefined ? _wizData.features[f.key] : f.default;
                            featHtml += `<label style="display:flex;align-items:center;gap:0.5rem;padding:0.25rem 0.5rem;cursor:pointer;font-size:0.72rem"><input type="checkbox" class="wiz-feat" data-key="${f.key}" ${on ? 'checked' : ''} style="accent-color:#818cf8"><span>${f.label}</span></label>`;
                        }
                        featHtml += '</div></div>';
                    }
                }
                body.innerHTML = `
                    <div class="form-group" style="margin-bottom:var(--space-sm)">
                        <label style="font-size:0.78rem;font-weight:600">URL Path</label>
                        <input type="text" id="wiz-path" value="${esc(_wizData.path)}" placeholder="/${esc(_wizData.name)}" style="width:100%;margin-top:0.2rem" autocomplete="off">
                        <div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.15rem">Where this segment will be served (e.g. /docs, /api)</div>
                    </div>
                    ${featHtml ? '<div style="font-size:0.78rem;font-weight:600;margin-bottom:0.3rem">Features</div>' + featHtml : ''}`;
                actions.innerHTML = `
                    <button class="btn btn-sm btn-ghost" onclick="closeVaultModal()">Cancel</button>
                    <button class="btn btn-sm btn-ghost" id="wiz-back">‚Üê Back</button>
                    <button class="btn btn-sm btn-primary" id="wiz-create">‚ú® Create Segment</button>`;
                document.getElementById('wiz-back').onclick = () => { _wizStep = 2; renderWizStep(); };
                document.getElementById('wiz-create').onclick = async () => {
                    _wizData.path = document.getElementById('wiz-path').value.trim() || '/' + _wizData.name;
                    // Gather features from checkboxes
                    const features = {};
                    document.querySelectorAll('.wiz-feat').forEach(cb => {
                        features[cb.dataset.key] = cb.checked;
                    });
                    _wizData.features = features;

                    const btn = document.getElementById('wiz-create');
                    btn.disabled = true;
                    btn.textContent = 'Creating‚Ä¶';
                    try {
                        const config = {};
                        if (_wizData.builder === 'docusaurus') {
                            config.features = features;
                            config.title = _wizData.name.charAt(0).toUpperCase() + _wizData.name.slice(1);
                        }
                        await api('/pages/segments', {
                            method: 'POST',
                            body: JSON.stringify({
                                name: _wizData.name,
                                source: _wizData.source,
                                builder: _wizData.builder,
                                path: _wizData.path,
                                config: config,
                            }),
                        });
                        closeVaultModal();
                        toast(`Segment '${_wizData.name}' created`, 'success');
                        await loadPagesCard();
                    } catch (e) {
                        errEl.textContent = e.message;
                        errEl.style.display = 'block';
                        btn.disabled = false;
                        btn.textContent = '‚ú® Create Segment';
                    }
                };
            }
        }
        renderWizStep();
    }

    async function removeSegment(name) {
        if (!confirm(`Remove segment '${name}'? This will delete its build workspace.`)) return;
        try {
            await api('/pages/segments/' + encodeURIComponent(name), { method: 'DELETE' });
            toast(`Segment '${name}' removed`, 'success');
            await loadPagesCard();
        } catch (e) {
            toast('Remove failed: ' + e.message, 'error');
        }
    }

    async function configureSegment(name, currentBuilder, source, path) {
