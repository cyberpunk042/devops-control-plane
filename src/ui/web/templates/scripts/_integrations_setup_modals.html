<!-- Integrations â€” Setup Wizard Modals
     Standalone multi-step setup modals for each integration.
     Callable from: Integration cards, Wizard step 5, Dashboard progress.
     Depends on: _globals_wizard_modal.html, _globals.html (api, esc, toast)
-->
<script>

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // â”€â”€ Integration Setup Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•



    // â”€â”€ Wizard detect cache banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Global flag: when true, detect steps add ?bust=1 to force server recompute
    window._wizForceRescan = false;

    function _wizDetectBanner(key) {
        const ageSec = wizAge(key);
        if (ageSec == null) return '';
        const stale = ageSec > 300; // > 5 min = red
        const ageColor = stale ? 'var(--danger)' : 'var(--text-muted)';
        return `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem">
            <span style="font-size:0.78rem;color:${ageColor}">Last scan: ${_formatAge(ageSec)}</span>
            <button type="button" class="btn btn-secondary" style="font-size:0.76rem;padding:0.2rem 0.6rem"
                onclick="wizInvalidate('${key}'); wizInvalidate('detect'); window._wizForceRescan = true; _wizModalRender();">ğŸ”„ Re-scan</button>
        </div>`;
    }

    // â”€â”€ Git Setup Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function openGitSetupWizard() {
        wizardModalOpen({
            title: 'ğŸ”€ Git Setup',
            size: 'wide',
            steps: [
                // â”€â”€ Step 1: DETECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // â”€â”€ Serve from cache if available (instant, zero API calls) â”€â”€
                        const _CK = 'git:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // â”€â”€ Fresh scan â”€â”€
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Analyzing your projectâ€¦</p>';
                        try {
                            // ONE call: wizDetect is the one-stop-shop (cached server-side)
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;

                            const probes = wizDetect.status_probes || {};
                            const git = probes.git || {};
                            data._git = git;
                            data._tools = wizDetect.tools || {};
                            data._gitignoreAnalysis = wizDetect.gitignore_analysis || { exists: false, coverage: 0, missing_patterns: [] };
                            data._ghStatus = wizDetect.gh_cli_status || { available: false };
                            data._gitRemotes = (wizDetect.git_remotes || {}).remotes || [];
                            data._projectStatus = { integrations: probes };
                            const gitignoreAnalysis = data._gitignoreAnalysis;
                            const ghStatus = data._ghStatus;
                            const gitRemotes = data._gitRemotes;

                            // Detect lint tools for hook suggestion
                            const lintTools = [];
                            if (data._tools.ruff) lintTools.push('ruff');
                            if (data._tools.mypy) lintTools.push('mypy');
                            if (data._tools.eslint || data._tools.npm) lintTools.push('eslint');
                            data._lintTools = lintTools;

                            // Version display
                            const gitVer = git.git_version ? `v${git.git_version}` : '';

                            // Build status rows
                            let html = `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;margin-bottom:var(--space-sm);font-size:0.82rem;background:color-mix(in srgb, var(--accent) 10%, var(--bg-inset));border:1px solid color-mix(in srgb, var(--accent) 30%, transparent);border-radius:8px">
                                <span style="font-size:1.1rem">ğŸ”</span>
                                <span style="flex:1;color:var(--text-secondary)">This is a <strong>read-only scan</strong>. To manage remotes, branch, and settings, proceed to Configure.</span>
                                <button type="button" class="btn btn-xs" style="background:var(--accent);color:white;border:none;padding:4px 12px;border-radius:6px;font-size:0.78rem;white-space:nowrap;cursor:pointer"
                                    onclick="document.getElementById('wiz-btn-next')?.click()">Configure â†’</button>
                            </div>`;
                            html += wizSection('Git Repository', 'Current Git configuration detected in this project.');
                            html += '<div class="wiz-status-grid">';
                            html += wizStatusRow('âš™ï¸', 'Git CLI',
                                data._tools.git ? `Installed ${gitVer ? '(' + gitVer + ')' : ''}` : 'Not found',
                                data._tools.git ? 'ok' : 'error');
                            html += wizStatusRow('ğŸ“', 'Repository',
                                git.initialized ? `Initialized (branch: ${git.branch || 'n/a'})` : 'Not initialized',
                                git.initialized ? 'ok' : 'error');
                            // Remotes â€” show each one
                            if (gitRemotes.length > 0) {
                                for (const r of gitRemotes) {
                                    const shortUrl = (r.fetch || r.push || '').replace(/^https?:\/\//, '').replace(/\.git$/, '');
                                    html += wizStatusRow('ğŸŒ', `Remote: ${r.name}`, shortUrl, 'ok');
                                }
                            } else {
                                html += wizStatusRow('ğŸŒ', 'Remote', 'Not configured', 'warn');
                            }
                            html += wizStatusRow('ğŸ“„', '.gitignore',
                                git.has_gitignore
                                  ? `Present (${Math.round((gitignoreAnalysis.coverage || 0) * 100)}% coverage)`
                                  : 'Missing',
                                git.has_gitignore ? (gitignoreAnalysis.coverage >= 0.9 ? 'ok' : 'warn') : 'error');
                            html += wizStatusRow('ğŸª', 'Hooks',
                                git.hook_count > 0 ? `${git.hook_count} active (${git.hooks.join(', ')})` : 'None configured',
                                git.hook_count > 0 ? 'ok' : 'muted');
                            html += wizStatusRow('ğŸ™', 'gh CLI',
                                ghStatus.available !== false
                                  ? (ghStatus.authenticated ? `Authenticated${ghStatus.repo ? ' â€” ' + ghStatus.repo : ''}` : 'Installed but not authenticated')
                                  : 'Not installed',
                                ghStatus.authenticated ? 'ok' : 'muted');
                            html += '</div>';



                            // Context hints
                            const hints = [];
                            // Get module/stack info from project status
                            const proj = (data._projectStatus?.integrations || {}).project;
                            if (proj && proj.modules > 0) {
                                // Try to get stack names from wizard detect
                                const stacks = wizDetect.detected_stacks || [];
                                if (stacks.length > 0) {
                                    hints.push(`ğŸ“¦ Detected stacks: <strong>${esc(stacks.join(', '))}</strong>`);
                                }
                            }
                            if (!git.has_gitignore) {
                                hints.push('ğŸ’¡ We\'ll generate a stack-aware .gitignore for your project.');
                            } else if (gitignoreAnalysis.missing_count > 0) {
                                hints.push(`âš ï¸ Your .gitignore is missing <strong>${gitignoreAnalysis.missing_count}</strong> recommended pattern(s).`);
                            }
                            if (!git.initialized) {
                                hints.push('ğŸ’¡ We\'ll initialize a Git repository for you.');
                            }
                            if (lintTools.length > 0) {
                                hints.push(`ğŸ”§ Lint tools detected: <strong>${lintTools.join(', ')}</strong>. We can set up a pre-commit hook.`);
                            }

                            if (hints.length > 0) {
                                html += `<div class="wiz-hint-box" style="margin-top:var(--space-md);padding:var(--space-sm) var(--space-md);background:var(--bg-card);border-radius:var(--radius-sm);border:1px solid var(--border-subtle)">`
                                    + hints.map(h => `<div style="padding:2px 0;font-size:0.82rem;color:var(--text-secondary)">${h}</div>`).join('')
                                    + '</div>';
                            }

                            // Store complete detect result in cache
                            wizStore(_CK, { h: html, d: { _git: data._git, _tools: data._tools, _gitignoreAnalysis: data._gitignoreAnalysis, _ghStatus: data._ghStatus, _gitRemotes: data._gitRemotes, _projectStatus: data._projectStatus, _lintTools: data._lintTools } }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>âš ï¸</span><span>Failed to detect Git status: ${esc(e.message)}</span></div>`;
                        }
                    }
                },
                // â”€â”€ Step 2: CONFIGURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'config', title: 'Configure',
                    render: async (data, el) => {
                        const git = data._git || {};
                        const ghStatus = data._ghStatus || {};
                        const giAnalysis = data._gitignoreAnalysis || {};
                        const lintTools = data._lintTools || [];

                        // Always live-fetch remotes so mutations (add/remove/change URL) reflect instantly
                        let gitRemotes = data._gitRemotes || [];
                        try {
                            const freshRemotes = await api('/git/remotes');
                            if (Array.isArray(freshRemotes.remotes)) {
                                gitRemotes = freshRemotes.remotes;
                                data._gitRemotes = gitRemotes;  // update shared data
                            }
                        } catch(e) { /* fall back to cached */ }

                        let html = '';

                        // â”€â”€ Section A: Remotes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        html += wizSection('Remotes', 'Manage remote connections for push/pull operations.');

                        // Current remotes table
                        if (gitRemotes.length > 0) {
                            html += `<div style="background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;overflow:hidden;margin-bottom:var(--space-sm)">`;
                            // Header
                            html += `<div style="display:flex;align-items:center;padding:0.3rem 0.65rem;font-size:0.65rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border-subtle);background:color-mix(in srgb, var(--bg-tertiary) 40%, transparent)">
                                <span style="width:80px">Name</span>
                                <span style="flex:1">URL</span>
                                <span style="width:120px;text-align:right">Actions</span>
                            </div>`;
                            for (const r of gitRemotes) {
                                const url = r.fetch || r.push || '';
                                const shortUrl = url.replace(/^https?:\/\//, '').replace(/\.git$/, '');
                                const rId = r.name.replace(/[^a-zA-Z0-9]/g, '_');
                                html += `<div style="display:flex;align-items:center;padding:0.4rem 0.65rem;font-size:0.82rem;border-bottom:1px solid var(--border-subtle)" id="remote-row-${rId}">
                                    <span style="width:80px;font-weight:600"><code style="font-size:0.8rem">${esc(r.name)}</code></span>
                                    <span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                                        <code style="font-size:0.75rem;color:var(--text-secondary)">${esc(shortUrl)}</code>
                                    </span>
                                    <span style="width:120px;display:flex;gap:4px;justify-content:flex-end">
                                        <button type="button" class="btn btn-xs btn-secondary" style="font-size:0.65rem;padding:1px 6px"
                                            onclick="(async()=>{
                                                try{
                                                    const newUrl=prompt('New URL for remote \\'${esc(r.name)}\\':', '${esc(url).replace(/'/g,"\\'")}');
                                                    if(!newUrl||newUrl==='${esc(url).replace(/'/g,"\\'")}')return;
                                                    await apiPost('/git/remote/set-url',{name:'${esc(r.name)}',url:newUrl});
                                                    toast('âœ… Remote URL updated','success');wizInvalidate('git:detect');wizInvalidate('detect');_wizModalRender();
                                                }catch(e){toast('âŒ '+e.message,'error')}
                                            })()">âœï¸ URL</button>
                                        <button type="button" class="btn btn-xs btn-secondary" style="font-size:0.65rem;padding:1px 6px;color:var(--error)"
                                            onclick="if(!this.dataset.c){this.textContent='Sure?';this.dataset.c='1';setTimeout(()=>{this.textContent='ğŸ—‘';delete this.dataset.c},2500);return}
                                            (async()=>{
                                                try{
                                                    await apiPost('/git/remote/remove',{name:'${esc(r.name)}'});
                                                    toast('âœ… Remote removed','success');wizInvalidate('git:detect');wizInvalidate('detect');_wizModalRender();
                                                }catch(e){toast('âŒ '+e.message,'error')}
                                            })()">ğŸ—‘</button>
                                    </span>
                                </div>`;
                            }
                            html += `</div>`;
                        } else {
                            html += `<div style="padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.82rem;color:var(--text-muted);margin-bottom:var(--space-sm)">
                                No remotes configured. Add one below.
                            </div>`;
                        }

                        // Add remote form
                        html += `<div style="background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;padding:0.5rem 0.65rem;margin-bottom:var(--space-sm)">
                            <div style="font-size:0.72rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:0.4rem">Add Remote</div>
                            <div style="display:flex;gap:0.4rem;align-items:center">
                                <input type="text" id="mf-add-remote-name" class="modal-form-input" style="width:90px;font-size:0.82rem;padding:4px 8px"
                                    placeholder="${gitRemotes.length === 0 ? 'origin' : 'upstream'}" value="">
                                <input type="text" id="mf-add-remote-url" class="modal-form-input" style="flex:1;font-size:0.82rem;padding:4px 8px"
                                    placeholder="https://github.com/user/repo.git"
                                    ${ghStatus.authenticated && ghStatus.repo && gitRemotes.length === 0 ? `value="https://github.com/${ghStatus.repo}.git"` : ''}>
                                <button type="button" class="btn btn-xs" id="git-add-remote-btn"
                                    style="font-size:0.75rem;padding:3px 10px;background:var(--accent);color:white;border:none;border-radius:6px;white-space:nowrap"
                                    onclick="(async()=>{
                                        const btn=document.getElementById('git-add-remote-btn');
                                        const name=document.getElementById('mf-add-remote-name').value.trim()||'${gitRemotes.length === 0 ? 'origin' : 'upstream'}';
                                        const url=document.getElementById('mf-add-remote-url').value.trim();
                                        if(!url){toast('Enter a remote URL','warn');return}
                                        btn.disabled=true;btn.textContent='Addingâ€¦';
                                        try{
                                            await apiPost('/git/remote/add',{name,url});
                                            toast('âœ… Remote \\'' +name+ '\\' added','success');wizInvalidate('git:detect');wizInvalidate('detect');_wizModalRender();
                                        }catch(e){toast('âŒ '+e.message,'error');btn.disabled=false;btn.textContent='ï¼‹ Add'}
                                    })()">ï¼‹ Add</button>
                            </div>
                            ${ghStatus.authenticated && ghStatus.repo && gitRemotes.length === 0
                                ? `<div style="font-size:0.7rem;color:var(--text-muted);margin-top:4px">ğŸ™ Pre-filled from GitHub CLI: ${esc(ghStatus.repo)}</div>`
                                : ''}
                        </div>`;

                        // â”€â”€ Section B: Default Branch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        html += wizSection('Default Branch', '');
                        html += wizFormGrid([
                            { name: 'git-branch', label: 'Branch name',
                              value: git.branch || 'main', placeholder: 'main',
                              hint: git.branch ? `Current: ${git.branch}` : 'Will be set on init.' },
                        ]);

                        // â”€â”€ Section C: .gitignore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        html += wizSection('.gitignore', 'Stack-aware patterns to protect your repository.');

                        if (git.has_gitignore && giAnalysis.missing_count === 0) {
                            // Already complete
                            html += `<div class="wiz-info-row" style="padding:var(--space-sm);background:var(--bg-card);border-radius:var(--radius-sm);border:1px solid var(--border-subtle);font-size:0.82rem;color:var(--text-secondary);margin-bottom:var(--space-md)">
                                âœ… Your .gitignore is complete â€” ${giAnalysis.current_patterns} patterns, ${Math.round((giAnalysis.coverage || 0) * 100)}% coverage.
                            </div>`;
                            data._skipGitignore = true;
                        } else {
                            // Either missing or incomplete â€” generate a preview
                            el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Generating .gitignore previewâ€¦</p>';

                            let gitignoreContent = '';
                            try {
                                const genResult = await apiPost('/security/generate/gitignore', {});
                                if (genResult.ok && genResult.file) {
                                    gitignoreContent = genResult.file.content || '';
                                }
                            } catch (e) {
                                gitignoreContent = '# Failed to generate â€” add patterns manually\n';
                            }
                            data._generatedGitignore = gitignoreContent;

                            if (git.has_gitignore) {
                                // Existing but incomplete
                                const missingList = (giAnalysis.missing_patterns || [])
                                    .map(p => `<span style="color:var(--error);font-size:0.78rem">âŒ ${esc(p.pattern)}</span> <span style="color:var(--text-muted);font-size:0.72rem">(${esc(p.reason)})</span>`)
                                    .join('<br>');
                                html += `<div style="padding:var(--space-sm);background:var(--bg-card);border-radius:var(--radius-sm);border:1px solid var(--border-subtle);margin-bottom:var(--space-sm)">
                                    <div style="font-size:0.82rem;color:var(--warning);margin-bottom:var(--space-xs)">
                                        âš ï¸ Your .gitignore is missing ${giAnalysis.missing_count} pattern(s):
                                    </div>
                                    <div style="padding-left:var(--space-sm)">${missingList}</div>
                                </div>`;
                                html += `<label class="modal-form-check full-width" style="margin-bottom:var(--space-sm)">
                                    <input type="checkbox" id="mf-gitignore-replace" checked>
                                    Replace with generated .gitignore (recommended)
                                </label>`;
                            } else {
                                html += `<label class="modal-form-check full-width" style="margin-bottom:var(--space-sm)">
                                    <input type="checkbox" id="mf-gitignore-create" checked>
                                    Create .gitignore
                                </label>`;
                            }

                            // Count patterns for display
                            const patCount = gitignoreContent ? gitignoreContent.split('\n').filter(l => l.trim() && !l.trim().startsWith('#')).length : 0;

                            html += `<div style="margin-bottom:var(--space-sm)">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-xs)">
                                    <span style="font-size:0.78rem;color:var(--text-muted)">ğŸ“‹ Preview (${patCount} patterns)</span>
                                    <button class="btn btn-xs btn-ghost" type="button" onclick="document.getElementById('gi-edit-wrap').style.display=document.getElementById('gi-edit-wrap').style.display==='none'?'block':'none'"
                                        style="font-size:0.7rem">âœï¸ Edit</button>
                                </div>
                                <div class="modal-preview" style="max-height:200px;overflow-y:auto">
                                    <div class="modal-preview-body" style="white-space:pre;font-family:var(--font-mono);font-size:0.72rem;line-height:1.5">${esc(gitignoreContent)}</div>
                                </div>
                                <div id="gi-edit-wrap" style="display:none;margin-top:var(--space-xs)">
                                    <textarea id="mf-gitignore-content"
                                        class="modal-form-textarea" style="font-family:var(--font-mono);font-size:0.72rem;min-height:200px;width:100%"
                                    >${esc(gitignoreContent)}</textarea>
                                    <span class="modal-form-hint">Edit the content above. Changes will be used when applying.</span>
                                </div>
                            </div>`;
                        }

                        // â”€â”€ Section D: Pre-commit hooks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        if (lintTools.length > 0 && git.hook_count === 0) {
                            html += wizSection('Pre-commit Hook', 'Run checks automatically before each commit.');
                            html += `<label class="modal-form-check full-width" style="margin-bottom:var(--space-xs)">
                                <input type="checkbox" id="mf-setup-hooks">
                                Set up pre-commit hook
                            </label>`;
                            html += `<div style="font-size:0.75rem;color:var(--text-muted);padding-left:1.5rem;margin-bottom:var(--space-sm)">
                                Will run: ${lintTools.map(t => `<code style="background:var(--bg-tertiary);padding:1px 4px;border-radius:3px">${esc(t)}</code>`).join(', ')} before each commit.
                            </div>`;
                        }

                        // â”€â”€ Section E: Initial commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        if (git.commit_count === 0 || !git.initialized) {
                            html += wizSection('Initial Commit', '');
                            html += `<label class="modal-form-check full-width" style="margin-bottom:var(--space-xs)">
                                <input type="checkbox" id="mf-initial-commit">
                                Create initial commit after setup
                            </label>`;
                            html += wizFormGrid([
                                { name: 'commit-msg', label: 'Commit message',
                                  value: 'Initial commit', placeholder: 'Initial commit',
                                  hint: 'Only used if the checkbox above is checked.' },
                            ]);
                        }

                        el.innerHTML = html;
                    },
                    collect: (data) => {
                        // Remotes are managed live (instant API calls), no deferred collection needed
                        data.remote = '';
                        data.branch = mfVal('git-branch');
                        data.setupHooks = mfVal('setup-hooks');
                        data.createInitialCommit = mfVal('initial-commit');
                        data.commitMessage = mfVal('commit-msg') || 'Initial commit';

                        // .gitignore decision
                        if (data._skipGitignore) {
                            data.writeGitignore = false;
                        } else {
                            const createEl = document.getElementById('mf-gitignore-create');
                            const replaceEl = document.getElementById('mf-gitignore-replace');
                            data.writeGitignore = (createEl && createEl.checked) || (replaceEl && replaceEl.checked);

                            // Use edited content if available, otherwise generated
                            const editedEl = document.getElementById('mf-gitignore-content');
                            data.gitignoreContent = editedEl ? editedEl.value : (data._generatedGitignore || '');
                        }
                    },
                },
                // â”€â”€ Step 3: REVIEW & APPLY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'review', title: 'Review',
                    render: (data, el) => {
                        const git = data._git || {};
                        const actions = [];

                        if (!git.initialized) {
                            actions.push({ icon: 'ğŸ“', label: 'Initialize Git repository', value: 'git init', status: 'new' });
                        }

                        const branchVal = data.branch || 'main';
                        if (git.branch && git.branch !== branchVal) {
                            actions.push({ icon: 'ğŸŒ¿', label: 'Rename branch', value: `${git.branch} â†’ ${branchVal}`, status: 'change' });
                        }

                        if (data.writeGitignore && data.gitignoreContent) {
                            const patCount = data.gitignoreContent.split('\n').filter(l => l.trim() && !l.trim().startsWith('#')).length;
                            const verb = git.has_gitignore ? 'Replace' : 'Create';
                            actions.push({ icon: 'ğŸ“„', label: `${verb} .gitignore`, value: `${patCount} patterns`, status: 'new' });
                        }

                        // Remotes â€” already applied live, just show summary
                        const gitRemotes = data._gitRemotes || [];
                        if (gitRemotes.length > 0) {
                            actions.push({ icon: 'ğŸŒ', label: 'Remotes configured', value: gitRemotes.map(r => r.name).join(', '), status: 'ok' });
                        } else {
                            actions.push({ icon: 'ğŸŒ', label: 'No remotes', value: 'Add via Configure step', status: 'ok' });
                        }

                        if (data.setupHooks) {
                            const tools = (data._lintTools || []).join(', ');
                            actions.push({ icon: 'ğŸª', label: 'Install pre-commit hook', value: tools, status: 'new' });
                        }

                        if (data.createInitialCommit) {
                            actions.push({ icon: 'ğŸ’¾', label: 'Create initial commit', value: data.commitMessage, status: 'new' });
                        }

                        if (actions.length === 0) {
                            actions.push({ icon: 'âœ…', label: 'Everything looks good', value: 'No changes needed', status: 'ok' });
                        }

                        const statusColors = { new: 'var(--success)', change: 'var(--warning)', ok: 'var(--text-muted)' };

                        let html = wizSection('Review Changes', 'The following actions will be performed when you click Finish.');
                        html += actions.map(a => `<div class="wiz-review-item" style="display:flex;gap:var(--space-sm);align-items:flex-start;padding:var(--space-sm) 0;border-bottom:1px solid var(--border-subtle)">
                            <span style="font-size:1.1rem;flex-shrink:0">${a.icon}</span>
                            <div style="flex:1;min-width:0">
                                <div style="font-size:0.85rem;font-weight:500;color:var(--text-primary)">${esc(a.label)}</div>
                                <div style="font-size:0.78rem;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(a.value)}</div>
                            </div>
                            <span style="font-size:0.7rem;padding:1px 6px;border-radius:8px;background:${statusColors[a.status] || 'var(--bg-tertiary)'};color:var(--bg-primary);flex-shrink:0">${a.status === 'new' ? 'NEW' : a.status === 'change' ? 'UPDATE' : 'âœ“'}</span>
                        </div>`).join('');
                        // Next integration hint
                        html += `<div style="margin-top:var(--space-md);padding:var(--space-xs) var(--space-sm);border-left:3px solid var(--accent);background:color-mix(in srgb, var(--accent) 5%, transparent);border-radius:0 6px 6px 0">
                            <div style="font-size:0.78rem;color:var(--text-secondary)">
                                ğŸ’¡ <strong>Next:</strong> Set up GitHub to manage environments, secrets, and CI/CD.
                                <button class="btn btn-sm btn-ghost" style="font-size:0.72rem;padding:0.1rem 0.4rem;margin-left:4px;color:var(--accent)"
                                    onclick="wizardModalClose();setTimeout(openGitHubSetupWizard,300)">Set up GitHub â†’</button>
                            </div>
                        </div>`;

                        el.innerHTML = html;
                    },
                },
            ],
            onComplete: async (data) => {
                const git = data._git || {};
                const payload = {
                    action: 'setup_git',
                };

                // Conditional fields â€” only send what the user chose
                if (!git.initialized) {
                    payload._init = true; // covered by setup_git logic
                }

                const branchVal = data.branch || '';
                if (branchVal && git.branch !== branchVal) {
                    payload.default_branch = branchVal;
                }

                if (data.writeGitignore && data.gitignoreContent) {
                    payload.gitignore_content = data.gitignoreContent;
                }

                if (data.remote) {
                    payload.remote = data.remote;
                }

                // Remotes are managed live â€” no deferred actions needed

                if (data.setupHooks && data._lintTools && data._lintTools.length > 0) {
                    payload.setup_hooks = true;
                    // Build hook commands from detected lint tools
                    const hookCmds = [];
                    if (data._lintTools.includes('ruff')) hookCmds.push('ruff check .');
                    if (data._lintTools.includes('mypy')) hookCmds.push('mypy src/');
                    if (data._lintTools.includes('eslint')) hookCmds.push('npx eslint .');
                    payload.hook_commands = hookCmds;
                }

                if (data.createInitialCommit) {
                    payload.create_initial_commit = true;
                    payload.commit_message = data.commitMessage || 'Initial commit';
                }

                const result = await apiPost('/wizard/setup', payload);

                if (!result.ok) {
                    throw new Error(result.error || 'Setup failed');
                }

                // Show detailed results
                if (result.results && result.results.length > 0) {
                    const details = result.results.map(r => `âœ“ ${r}`).join('\n');
                    toast(details, 'success', 5000);
                }

                // Invalidate caches
                _projectStatusTS = 0;
                wizInvalidate('git:detect');
                wizInvalidate('detect');
                cardInvalidate('git');
                // Reload git card if on Integrations tab
                if (typeof loadGitCard === 'function') {
                    setTimeout(() => loadGitCard(), 300);
                }
            },
            successMessage: 'Git repository configured!',
            finishLabel: 'âœ… Apply Changes',
        });
    }

    // â”€â”€ Docker Setup Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function openDockerSetupWizard() {

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        /** Determine if a module is a container candidate based on domain + stack. */
        function _dockerModClass(mod) {
            const dom = (mod.domain || '').toLowerCase();
            const st  = (mod.stack  || '').toLowerCase();
            if (dom === 'library')  return 'library';
            if (dom === 'docs' || st === 'markdown') return 'docs';
            if (['kubernetes', 'helm', 'terraform', 'docker-compose'].includes(st)) return 'ops-tool';
            return 'deployable';
        }

        /** Resolve the Dockerfile template family a stack maps to. */
        function _dockerStackFamily(stack) {
            const families = ['python','node','typescript','go','rust','java-maven','java-gradle','dotnet','elixir','ruby'];
            if (families.includes(stack)) return stack;
            for (const f of families) {
                if (stack.startsWith(f + '-')) return f;
            }
            return null;
        }

        /** Default port for a stack family. */
        function _dockerPort(family) {
            return (_dockerStackDefaults[family] || {}).expose || 8080;
        }

        // â”€â”€ Per-stack Dockerfile defaults â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const _dockerStackDefaults = {
            python: {
                images: ['python:3.12-slim','python:3.11-slim','python:3.12-alpine','python:3.11-alpine','python:3.12-bookworm'],
                workdir: '/app',
                install: 'pip install --no-cache-dir -r requirements.txt',
                build: '',
                entrypoint: '',
                cmd: 'python -m src.main',
                expose: 8000,
            },
            node: {
                images: ['node:20-alpine','node:22-alpine','node:18-alpine','node:20-slim','node:18-slim'],
                workdir: '/app',
                install: 'npm ci --production',
                build: '',
                entrypoint: '',
                cmd: 'node index.js',
                expose: 3000,
            },
            typescript: {
                images: ['node:20-alpine','node:22-alpine','node:18-alpine','node:20-slim'],
                workdir: '/app',
                install: 'npm ci',
                build: 'npm run build',
                entrypoint: '',
                cmd: 'node dist/index.js',
                expose: 3000,
            },
            go: {
                images: ['golang:1.22-alpine','golang:1.21-alpine','golang:1.22-bookworm'],
                workdir: '/app',
                install: 'go mod download',
                build: 'CGO_ENABLED=0 GOOS=linux go build -o /app/server ./...',
                entrypoint: '',
                cmd: '/app/server',
                expose: 8080,
            },
            rust: {
                images: ['rust:1.77-slim','rust:1.77-alpine','rust:1.76-slim'],
                workdir: '/app',
                install: '',
                build: 'cargo build --release',
                entrypoint: '',
                cmd: '/app/app',
                expose: 8080,
            },
            'java-maven': {
                images: ['maven:3.9-eclipse-temurin-21','maven:3.9-eclipse-temurin-17'],
                workdir: '/app',
                install: 'mvn dependency:resolve -q',
                build: 'mvn package -DskipTests -q',
                entrypoint: '',
                cmd: 'java -jar /app/app.jar',
                expose: 8080,
            },
            'java-gradle': {
                images: ['gradle:8-jdk21','gradle:8-jdk17'],
                workdir: '/app',
                install: 'gradle dependencies --no-daemon -q',
                build: 'gradle build -x test --no-daemon -q',
                entrypoint: '',
                cmd: 'java -jar /app/app.jar',
                expose: 8080,
            },
            dotnet: {
                images: ['mcr.microsoft.com/dotnet/sdk:8.0','mcr.microsoft.com/dotnet/sdk:7.0'],
                workdir: '/app',
                install: 'dotnet restore',
                build: 'dotnet publish -c Release -o /app/publish',
                entrypoint: '',
                cmd: 'dotnet App.dll',
                expose: 8080,
            },
            elixir: {
                images: ['elixir:1.16-alpine','elixir:1.16-slim','elixir:1.15-alpine'],
                workdir: '/app',
                install: 'mix deps.get --only prod && mix deps.compile',
                build: 'mix release',
                entrypoint: '',
                cmd: 'bin/app start',
                expose: 4000,
            },
            ruby: {
                images: ['ruby:3.3-slim','ruby:3.2-slim','ruby:3.3-alpine','ruby:3.2-alpine'],
                workdir: '/app',
                install: 'bundle install --deployment --without development test',
                build: '',
                entrypoint: '',
                cmd: 'bundle exec ruby app.rb',
                expose: 3000,
            },
        };

        const _restartPolicies = ['unless-stopped','always','on-failure','no'];
        const _platformOptions = ['','linux/amd64','linux/arm64','linux/amd64,linux/arm64'];

        // â”€â”€ Common infra services (categorised, configurable) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //
        // Schema per service:
        //   key:       unique slug (used for element IDs, compose service name)
        //   label:     display name
        //   cat:       category key (matches _infraCategories)
        //   images:    string[]  â€” image tag options (first = default)
        //   ports:     {port,label}[] â€” exposed ports (first = primary)
        //   envFields: {key,label,default,required?,type?}[] â€” configurable env vars
        //              type defaults to 'text'; 'password' masks input
        //   volumes:   {name,mount}[] â€” named volumes (data persistence)
        //   command:   optional default command override
        //   note:      optional info string shown in config panel
        //
        const _infraOptions = [
            // â”€â”€ Databases: Relational â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { key:'postgres', label:'PostgreSQL', cat:'db-rel',
              images:['postgres:16-alpine','postgres:16','postgres:15-alpine','postgres:15','postgres:14-alpine'],
              ports:[{port:5432,label:'PostgreSQL'}],
              envFields:[
                  {key:'POSTGRES_DB',       label:'Database',  default:'app'},
                  {key:'POSTGRES_USER',     label:'Username',  default:'app'},
                  {key:'POSTGRES_PASSWORD', label:'Password',  default:'changeme', required:true, type:'password'},
              ],
              volumes:[{name:'pgdata',mount:'/var/lib/postgresql/data'}],
            },
            { key:'mysql', label:'MySQL', cat:'db-rel',
              images:['mysql:8','mysql:8.4','mysql:8.0'],
              ports:[{port:3306,label:'MySQL'}],
              envFields:[
                  {key:'MYSQL_ROOT_PASSWORD', label:'Root password', default:'changeme', required:true, type:'password'},
                  {key:'MYSQL_DATABASE',      label:'Database',      default:'app'},
                  {key:'MYSQL_USER',          label:'Username',      default:'app'},
                  {key:'MYSQL_PASSWORD',      label:'User password', default:'changeme', type:'password'},
              ],
              volumes:[{name:'mysqldata',mount:'/var/lib/mysql'}],
            },
            { key:'mariadb', label:'MariaDB', cat:'db-rel',
              images:['mariadb:11','mariadb:10.11','mariadb:10.6'],
              ports:[{port:3306,label:'MariaDB'}],
              envFields:[
                  {key:'MARIADB_ROOT_PASSWORD', label:'Root password', default:'changeme', required:true, type:'password'},
                  {key:'MARIADB_DATABASE',      label:'Database',      default:'app'},
                  {key:'MARIADB_USER',          label:'Username',      default:'app'},
                  {key:'MARIADB_PASSWORD',      label:'User password', default:'changeme', type:'password'},
              ],
              volumes:[{name:'mariadbdata',mount:'/var/lib/mysql'}],
            },
            { key:'mssql', label:'SQL Server', cat:'db-rel',
              images:['mcr.microsoft.com/mssql/server:2022-latest','mcr.microsoft.com/mssql/server:2019-latest'],
              ports:[{port:1433,label:'SQL Server'}],
              envFields:[
                  {key:'ACCEPT_EULA',       label:'Accept EULA',  default:'Y', required:true},
                  {key:'MSSQL_SA_PASSWORD', label:'SA password',  default:'YourStrong!Passw0rd', required:true, type:'password'},
              ],
              volumes:[{name:'mssqldata',mount:'/var/opt/mssql'}],
            },
            { key:'cockroachdb', label:'CockroachDB', cat:'db-rel',
              images:['cockroachdb/cockroach:latest','cockroachdb/cockroach:v23.2.0'],
              ports:[{port:26257,label:'SQL'},{port:8080,label:'Admin UI'}],
              envFields:[],
              volumes:[{name:'crdbdata',mount:'/cockroach/cockroach-data'}],
              command:'start-single-node --insecure',
            },

            // â”€â”€ Databases: NoSQL / Document / Graph â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { key:'mongo', label:'MongoDB', cat:'db-nosql',
              images:['mongo:7','mongo:6','mongo:5'],
              ports:[{port:27017,label:'MongoDB'}],
              envFields:[
                  {key:'MONGO_INITDB_ROOT_USERNAME', label:'Root user',     default:'root'},
                  {key:'MONGO_INITDB_ROOT_PASSWORD', label:'Root password', default:'changeme', type:'password'},
                  {key:'MONGO_INITDB_DATABASE',      label:'Init database', default:'app'},
              ],
              volumes:[{name:'mongodata',mount:'/data/db'}],
            },
            { key:'cassandra', label:'Cassandra', cat:'db-nosql',
              images:['cassandra:4','cassandra:3.11'],
              ports:[{port:9042,label:'CQL'}],
              envFields:[
                  {key:'CASSANDRA_CLUSTER_NAME', label:'Cluster name', default:'MyCluster'},
              ],
              volumes:[{name:'cassandradata',mount:'/var/lib/cassandra'}],
            },
            { key:'couchdb', label:'CouchDB', cat:'db-nosql',
              images:['couchdb:3','couchdb:3.3'],
              ports:[{port:5984,label:'HTTP API'}],
              envFields:[
                  {key:'COUCHDB_USER',     label:'Admin user',     default:'admin'},
                  {key:'COUCHDB_PASSWORD', label:'Admin password', default:'changeme', required:true, type:'password'},
              ],
              volumes:[{name:'couchdbdata',mount:'/opt/couchdb/data'}],
            },
            { key:'neo4j', label:'Neo4j', cat:'db-nosql',
              images:['neo4j:5','neo4j:5-community','neo4j:4.4'],
              ports:[{port:7474,label:'Browser'},{port:7687,label:'Bolt'}],
              envFields:[
                  {key:'NEO4J_AUTH', label:'Auth (user/pass)', default:'neo4j/changeme', required:true},
              ],
              volumes:[{name:'neo4jdata',mount:'/data'}],
            },
            { key:'arangodb', label:'ArangoDB', cat:'db-nosql',
              images:['arangodb:3.11','arangodb:3.10'],
              ports:[{port:8529,label:'HTTP API'}],
              envFields:[
                  {key:'ARANGO_ROOT_PASSWORD', label:'Root password', default:'changeme', required:true, type:'password'},
              ],
              volumes:[{name:'arangodata',mount:'/var/lib/arangodb3'}],
            },
            { key:'dynamodb', label:'DynamoDB Local', cat:'db-nosql',
              images:['amazon/dynamodb-local:latest'],
              ports:[{port:8000,label:'DynamoDB'}],
              envFields:[],
              volumes:[],
              note:'Local dev emulator â€” no auth needed',
            },
            { key:'influxdb', label:'InfluxDB', cat:'db-nosql',
              images:['influxdb:2','influxdb:2.7-alpine'],
              ports:[{port:8086,label:'HTTP API'}],
              envFields:[
                  {key:'DOCKER_INFLUXDB_INIT_MODE',     label:'Init mode',     default:'setup'},
                  {key:'DOCKER_INFLUXDB_INIT_USERNAME',  label:'Admin user',    default:'admin'},
                  {key:'DOCKER_INFLUXDB_INIT_PASSWORD',  label:'Admin password',default:'changeme', required:true, type:'password'},
                  {key:'DOCKER_INFLUXDB_INIT_ORG',       label:'Organization',  default:'myorg'},
                  {key:'DOCKER_INFLUXDB_INIT_BUCKET',    label:'Bucket',        default:'mybucket'},
              ],
              volumes:[{name:'influxdata',mount:'/var/lib/influxdb2'}],
            },
            { key:'clickhouse', label:'ClickHouse', cat:'db-nosql',
              images:['clickhouse/clickhouse-server:latest','clickhouse/clickhouse-server:23.12'],
              ports:[{port:8123,label:'HTTP'},{port:9000,label:'Native'}],
              envFields:[
                  {key:'CLICKHOUSE_DB',       label:'Database', default:'default'},
                  {key:'CLICKHOUSE_USER',     label:'Username', default:'default'},
                  {key:'CLICKHOUSE_PASSWORD', label:'Password', default:'', type:'password'},
              ],
              volumes:[{name:'clickhousedata',mount:'/var/lib/clickhouse'}],
            },
            { key:'timescaledb', label:'TimescaleDB', cat:'db-nosql',
              images:['timescale/timescaledb:latest-pg16','timescale/timescaledb:latest-pg15'],
              ports:[{port:5432,label:'PostgreSQL'}],
              envFields:[
                  {key:'POSTGRES_DB',       label:'Database', default:'app'},
                  {key:'POSTGRES_USER',     label:'Username', default:'postgres'},
                  {key:'POSTGRES_PASSWORD', label:'Password', default:'changeme', required:true, type:'password'},
              ],
              volumes:[{name:'timescaledata',mount:'/var/lib/postgresql/data'}],
            },
            { key:'surrealdb', label:'SurrealDB', cat:'db-nosql',
              images:['surrealdb/surrealdb:latest','surrealdb/surrealdb:v1'],
              ports:[{port:8000,label:'HTTP'}],
              envFields:[
                  {key:'SURREAL_USER', label:'Root user',     default:'root'},
                  {key:'SURREAL_PASS', label:'Root password', default:'changeme', type:'password'},
              ],
              volumes:[{name:'surrealdata',mount:'/data'}],
              command:'start --user root --pass changeme file:/data/srdb.db',
            },

            // â”€â”€ Caches & Key-Value â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { key:'redis', label:'Redis', cat:'cache',
              images:['redis:7-alpine','redis:7','redis:6-alpine'],
              ports:[{port:6379,label:'Redis'}],
              envFields:[],
              volumes:[{name:'redisdata',mount:'/data'}],
              note:'Add --requirepass &lt;pw&gt; to command for auth',
            },
            { key:'valkey', label:'Valkey', cat:'cache',
              images:['valkey/valkey:8-alpine','valkey/valkey:8','valkey/valkey:7-alpine'],
              ports:[{port:6379,label:'Valkey'}],
              envFields:[],
              volumes:[{name:'valkeydata',mount:'/data'}],
              note:'Redis-compatible fork by Linux Foundation',
            },
            { key:'keydb', label:'KeyDB', cat:'cache',
              images:['eqalpha/keydb:latest','eqalpha/keydb:alpine'],
              ports:[{port:6379,label:'KeyDB'}],
              envFields:[],
              volumes:[],
            },
            { key:'memcached', label:'Memcached', cat:'cache',
              images:['memcached:1-alpine','memcached:1'],
              ports:[{port:11211,label:'Memcached'}],
              envFields:[
                  {key:'MEMCACHED_MAX_MEMORY', label:'Max memory (MB)', default:'64'},
              ],
              volumes:[],
              note:'In-memory only â€” no persistence',
            },
            { key:'dragonfly', label:'Dragonfly', cat:'cache',
              images:['docker.dragonflydb.io/dragonflydb/dragonfly:latest'],
              ports:[{port:6379,label:'Dragonfly'}],
              envFields:[],
              volumes:[{name:'dragonflydata',mount:'/data'}],
              note:'Redis-compatible, multi-threaded',
            },
            { key:'etcd', label:'etcd', cat:'cache',
              images:['quay.io/coreos/etcd:v3.5.12','quay.io/coreos/etcd:latest'],
              ports:[{port:2379,label:'Client'},{port:2380,label:'Peer'}],
              envFields:[
                  {key:'ETCD_ADVERTISE_CLIENT_URLS', label:'Advertise URL', default:'http://0.0.0.0:2379'},
                  {key:'ETCD_LISTEN_CLIENT_URLS',    label:'Listen URL',    default:'http://0.0.0.0:2379'},
              ],
              volumes:[{name:'etcddata',mount:'/etcd-data'}],
            },

            // â”€â”€ Message Brokers & Queues â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { key:'rabbitmq', label:'RabbitMQ', cat:'mq',
              images:['rabbitmq:3-management-alpine','rabbitmq:3-management','rabbitmq:3-alpine'],
              ports:[{port:5672,label:'AMQP'},{port:15672,label:'Management UI'}],
              envFields:[
                  {key:'RABBITMQ_DEFAULT_USER',  label:'Admin user',     default:'guest'},
                  {key:'RABBITMQ_DEFAULT_PASS',  label:'Admin password', default:'guest', type:'password'},
                  {key:'RABBITMQ_DEFAULT_VHOST', label:'Default vhost',  default:'/'},
              ],
              volumes:[{name:'rabbitmqdata',mount:'/var/lib/rabbitmq'}],
            },
            { key:'kafka', label:'Kafka (KRaft)', cat:'mq',
              images:['apache/kafka:latest','apache/kafka:3.7.0','confluentinc/cp-kafka:7.6.0'],
              ports:[{port:9092,label:'Broker'}],
              envFields:[
                  {key:'KAFKA_NODE_ID',                      label:'Node ID',            default:'1'},
                  {key:'KAFKA_PROCESS_ROLES',                label:'Process roles',      default:'broker,controller'},
                  {key:'KAFKA_LISTENERS',                    label:'Listeners',          default:'PLAINTEXT://:9092,CONTROLLER://:9093'},
                  {key:'KAFKA_CONTROLLER_QUORUM_VOTERS',     label:'Quorum voters',      default:'1@localhost:9093'},
                  {key:'KAFKA_CONTROLLER_LISTENER_NAMES',    label:'Controller listener',default:'CONTROLLER'},
                  {key:'CLUSTER_ID',                         label:'Cluster ID',         default:'MkU3OEVBNTcwNTJENDM2Qk'},
              ],
              volumes:[{name:'kafkadata',mount:'/var/lib/kafka/data'}],
              note:'KRaft mode â€” no ZooKeeper needed',
            },
            { key:'nats', label:'NATS', cat:'mq',
              images:['nats:2-alpine','nats:2','nats:latest'],
              ports:[{port:4222,label:'Client'},{port:8222,label:'Monitoring'}],
              envFields:[],
              volumes:[{name:'natsdata',mount:'/data'}],
            },
            { key:'mosquitto', label:'Mosquitto (MQTT)', cat:'mq',
              images:['eclipse-mosquitto:2','eclipse-mosquitto:latest'],
              ports:[{port:1883,label:'MQTT'},{port:9001,label:'WebSocket'}],
              envFields:[],
              volumes:[{name:'mosquittodata',mount:'/mosquitto/data'}],
              note:'Needs mosquitto.conf for listener config',
            },
            { key:'redpanda', label:'Redpanda', cat:'mq',
              images:['docker.redpanda.com/redpandadata/redpanda:latest','docker.redpanda.com/redpandadata/redpanda:v23.3.5'],
              ports:[{port:9092,label:'Kafka API'},{port:8081,label:'Schema Registry'},{port:8082,label:'Pandaproxy'}],
              envFields:[],
              volumes:[{name:'redpandadata',mount:'/var/lib/redpanda/data'}],
              command:'redpanda start --smp 1 --memory 512M --overprovisioned --kafka-addr 0.0.0.0:9092',
            },
            { key:'activemq', label:'ActiveMQ Artemis', cat:'mq',
              images:['apache/activemq-artemis:latest','apache/activemq-artemis:2.31.2'],
              ports:[{port:61616,label:'OpenWire'},{port:8161,label:'Web Console'}],
              envFields:[
                  {key:'ARTEMIS_USER',     label:'Admin user',     default:'admin'},
                  {key:'ARTEMIS_PASSWORD', label:'Admin password', default:'admin', type:'password'},
              ],
              volumes:[{name:'activemqdata',mount:'/var/lib/artemis-instance'}],
            },
            { key:'celery', label:'Celery Worker', cat:'mq',
              images:['python:3.12-slim','python:3.11-slim'],
              ports:[],
              envFields:[
                  {key:'CELERY_BROKER_URL',     label:'Broker URL',     default:'redis://redis:6379/0'},
                  {key:'CELERY_RESULT_BACKEND', label:'Result backend', default:'redis://redis:6379/1'},
              ],
              volumes:[],
              command:'celery -A tasks worker --loglevel=info',
              note:'Requires a broker service (Redis/RabbitMQ)',
            },

            // â”€â”€ Search & Analytics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { key:'elasticsearch', label:'Elasticsearch', cat:'search',
              images:['docker.elastic.co/elasticsearch/elasticsearch:8.13.0','docker.elastic.co/elasticsearch/elasticsearch:7.17.18'],
              ports:[{port:9200,label:'HTTP'},{port:9300,label:'Transport'}],
              envFields:[
                  {key:'discovery.type',         label:'Discovery',        default:'single-node'},
                  {key:'xpack.security.enabled', label:'Security',         default:'false'},
                  {key:'ES_JAVA_OPTS',           label:'JVM heap',         default:'-Xms512m -Xmx512m'},
                  {key:'ELASTIC_PASSWORD',       label:'elastic password', default:'changeme', type:'password'},
              ],
              volumes:[{name:'esdata',mount:'/usr/share/elasticsearch/data'}],
            },
            { key:'opensearch', label:'OpenSearch', cat:'search',
              images:['opensearchproject/opensearch:2','opensearchproject/opensearch:2.12.0'],
              ports:[{port:9200,label:'HTTP'},{port:9600,label:'Performance'}],
              envFields:[
                  {key:'discovery.type',          label:'Discovery',        default:'single-node'},
                  {key:'DISABLE_SECURITY_PLUGIN', label:'Disable security', default:'true'},
                  {key:'OPENSEARCH_JAVA_OPTS',    label:'JVM heap',         default:'-Xms512m -Xmx512m'},
              ],
              volumes:[{name:'osdata',mount:'/usr/share/opensearch/data'}],
            },
            { key:'meilisearch', label:'Meilisearch', cat:'search',
              images:['getmeili/meilisearch:latest','getmeili/meilisearch:v1.6'],
              ports:[{port:7700,label:'HTTP'}],
              envFields:[
                  {key:'MEILI_ENV',        label:'Environment', default:'development'},
                  {key:'MEILI_MASTER_KEY', label:'Master key',  default:'changeme', type:'password'},
              ],
              volumes:[{name:'meilidata',mount:'/meili_data'}],
            },
            { key:'typesense', label:'Typesense', cat:'search',
              images:['typesense/typesense:27.1','typesense/typesense:26.0'],
              ports:[{port:8108,label:'HTTP'}],
              envFields:[
                  {key:'TYPESENSE_API_KEY',  label:'API key',       default:'changeme', required:true, type:'password'},
                  {key:'TYPESENSE_DATA_DIR', label:'Data directory', default:'/data'},
              ],
              volumes:[{name:'typesensedata',mount:'/data'}],
            },
            { key:'solr', label:'Apache Solr', cat:'search',
              images:['solr:9','solr:8'],
              ports:[{port:8983,label:'HTTP'}],
              envFields:[
                  {key:'SOLR_JAVA_MEM', label:'JVM memory', default:'-Xms512m -Xmx512m'},
              ],
              volumes:[{name:'solrdata',mount:'/var/solr'}],
            },

            // â”€â”€ Reverse Proxies & Load Balancers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { key:'nginx', label:'Nginx', cat:'proxy',
              images:['nginx:alpine','nginx:1-alpine','nginx:latest'],
              ports:[{port:80,label:'HTTP'},{port:443,label:'HTTPS'}],
              envFields:[],
              volumes:[],
              note:'Mount your nginx.conf via volumes',
            },
            { key:'traefik', label:'Traefik', cat:'proxy',
              images:['traefik:v3','traefik:v2','traefik:latest'],
              ports:[{port:80,label:'HTTP'},{port:443,label:'HTTPS'},{port:8080,label:'Dashboard'}],
              envFields:[],
              volumes:[{name:'/var/run/docker.sock',mount:'/var/run/docker.sock:ro'}],
              command:'--api.insecure=true --providers.docker=true',
              note:'Auto-discovers Docker containers',
            },
            { key:'caddy', label:'Caddy', cat:'proxy',
              images:['caddy:2-alpine','caddy:2','caddy:latest'],
              ports:[{port:80,label:'HTTP'},{port:443,label:'HTTPS'}],
              envFields:[],
              volumes:[{name:'caddydata',mount:'/data'},{name:'caddyconfig',mount:'/config'}],
              note:'Automatic HTTPS via Let\'s Encrypt',
            },
            { key:'haproxy', label:'HAProxy', cat:'proxy',
              images:['haproxy:2-alpine','haproxy:2','haproxy:lts-alpine'],
              ports:[{port:80,label:'HTTP'},{port:443,label:'HTTPS'},{port:8404,label:'Stats'}],
              envFields:[],
              volumes:[],
              note:'Mount your haproxy.cfg via volumes',
            },
            { key:'envoy', label:'Envoy', cat:'proxy',
              images:['envoyproxy/envoy:v1.30-latest','envoyproxy/envoy:v1.29-latest'],
              ports:[{port:10000,label:'Listener'},{port:9901,label:'Admin'}],
              envFields:[],
              volumes:[],
              note:'Mount envoy.yaml config via volumes',
            },

            // â”€â”€ Monitoring & Observability â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { key:'prometheus', label:'Prometheus', cat:'monitor',
              images:['prom/prometheus:latest','prom/prometheus:v2.50.0'],
              ports:[{port:9090,label:'HTTP'}],
              envFields:[],
              volumes:[{name:'promdata',mount:'/prometheus'}],
              note:'Mount prometheus.yml config via volumes',
            },
            { key:'grafana', label:'Grafana', cat:'monitor',
              images:['grafana/grafana:latest','grafana/grafana:10-alpine','grafana/grafana-oss:latest'],
              ports:[{port:3000,label:'HTTP'}],
              envFields:[
                  {key:'GF_SECURITY_ADMIN_USER',     label:'Admin user',     default:'admin'},
                  {key:'GF_SECURITY_ADMIN_PASSWORD', label:'Admin password', default:'admin', required:true, type:'password'},
                  {key:'GF_INSTALL_PLUGINS',         label:'Plugins',        default:''},
              ],
              volumes:[{name:'grafanadata',mount:'/var/lib/grafana'}],
            },
            { key:'jaeger', label:'Jaeger', cat:'monitor',
              images:['jaegertracing/all-in-one:latest','jaegertracing/all-in-one:1.54'],
              ports:[{port:16686,label:'UI'},{port:4317,label:'OTLP gRPC'},{port:4318,label:'OTLP HTTP'}],
              envFields:[
                  {key:'COLLECTOR_OTLP_ENABLED', label:'OTLP enabled', default:'true'},
              ],
              volumes:[],
              note:'All-in-one dev image â€” uses memory storage',
            },
            { key:'zipkin', label:'Zipkin', cat:'monitor',
              images:['openzipkin/zipkin:latest','openzipkin/zipkin:3'],
              ports:[{port:9411,label:'HTTP'}],
              envFields:[],
              volumes:[],
              note:'In-memory storage by default',
            },
            { key:'otel', label:'OpenTelemetry Collector', cat:'monitor',
              images:['otel/opentelemetry-collector:latest','otel/opentelemetry-collector-contrib:latest'],
              ports:[{port:4317,label:'OTLP gRPC'},{port:4318,label:'OTLP HTTP'},{port:8888,label:'Metrics'}],
              envFields:[],
              volumes:[],
              note:'Mount otel-config.yaml via volumes',
            },
            { key:'uptimekuma', label:'Uptime Kuma', cat:'monitor',
              images:['louislam/uptime-kuma:1','louislam/uptime-kuma:latest'],
              ports:[{port:3001,label:'HTTP'}],
              envFields:[],
              volumes:[{name:'uptimekuma',mount:'/app/data'}],
            },

            // â”€â”€ Logging â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { key:'loki', label:'Loki', cat:'log',
              images:['grafana/loki:latest','grafana/loki:2.9.4'],
              ports:[{port:3100,label:'HTTP'}],
              envFields:[],
              volumes:[{name:'lokidata',mount:'/loki'}],
              note:'Use with Grafana for log visualization',
            },
            { key:'fluentd', label:'Fluentd', cat:'log',
              images:['fluentd:v1-debian','fluentd:v1-alpine','fluent/fluentd:latest'],
              ports:[{port:24224,label:'Forward'}],
              envFields:[],
              volumes:[],
              note:'Mount fluent.conf via volumes',
            },
            { key:'kibana', label:'Kibana', cat:'log',
              images:['docker.elastic.co/kibana/kibana:8.13.0','docker.elastic.co/kibana/kibana:7.17.18'],
              ports:[{port:5601,label:'HTTP'}],
              envFields:[
                  {key:'ELASTICSEARCH_HOSTS', label:'Elasticsearch URL', default:'http://elasticsearch:9200', required:true},
              ],
              volumes:[],
              note:'Requires Elasticsearch service',
            },
            { key:'vector', label:'Vector', cat:'log',
              images:['timberio/vector:latest-alpine','timberio/vector:latest-debian'],
              ports:[{port:8383,label:'API'},{port:8686,label:'GraphQL'}],
              envFields:[],
              volumes:[],
              note:'Mount vector.toml config via volumes',
            },
            { key:'seq', label:'Seq', cat:'log',
              images:['datalust/seq:latest'],
              ports:[{port:5341,label:'Ingestion'},{port:80,label:'UI'}],
              envFields:[
                  {key:'ACCEPT_EULA', label:'Accept EULA', default:'Y', required:true},
              ],
              volumes:[{name:'seqdata',mount:'/data'}],
            },

            // â”€â”€ Storage & Object Store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { key:'minio', label:'MinIO', cat:'storage',
              images:['minio/minio:latest','quay.io/minio/minio:latest'],
              ports:[{port:9000,label:'API'},{port:9001,label:'Console'}],
              envFields:[
                  {key:'MINIO_ROOT_USER',     label:'Root user',     default:'minioadmin', required:true},
                  {key:'MINIO_ROOT_PASSWORD', label:'Root password', default:'minioadmin', required:true, type:'password'},
              ],
              volumes:[{name:'miniodata',mount:'/data'}],
              command:'server /data --console-address ":9001"',
            },
            { key:'seaweedfs', label:'SeaweedFS', cat:'storage',
              images:['chrislusf/seaweedfs:latest'],
              ports:[{port:9333,label:'Master'},{port:8080,label:'Volume'}],
              envFields:[],
              volumes:[{name:'seaweeddata',mount:'/data'}],
              command:'server -master.port=9333 -volume.port=8080 -dir=/data',
            },

            // â”€â”€ DevOps & Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { key:'portainer', label:'Portainer', cat:'devops',
              images:['portainer/portainer-ce:latest','portainer/portainer-ce:2.19.4'],
              ports:[{port:9443,label:'HTTPS'},{port:9000,label:'HTTP'}],
              envFields:[],
              volumes:[{name:'portainerdata',mount:'/data'},{name:'/var/run/docker.sock',mount:'/var/run/docker.sock:ro'}],
            },
            { key:'vault', label:'Vault', cat:'devops',
              images:['hashicorp/vault:latest','hashicorp/vault:1.15'],
              ports:[{port:8200,label:'HTTP'}],
              envFields:[
                  {key:'VAULT_DEV_ROOT_TOKEN_ID',  label:'Dev root token', default:'devtoken'},
                  {key:'VAULT_DEV_LISTEN_ADDRESS', label:'Listen address', default:'0.0.0.0:8200'},
              ],
              volumes:[{name:'vaultdata',mount:'/vault/file'}],
              note:'Dev mode â€” single-server, in-memory',
            },
            { key:'consul', label:'Consul', cat:'devops',
              images:['hashicorp/consul:latest','hashicorp/consul:1.18'],
              ports:[{port:8500,label:'HTTP'},{port:8600,label:'DNS'}],
              envFields:[],
              volumes:[{name:'consuldata',mount:'/consul/data'}],
              command:'agent -dev -client=0.0.0.0',
            },
            { key:'gitea', label:'Gitea', cat:'devops',
              images:['gitea/gitea:latest','gitea/gitea:1.21'],
              ports:[{port:3000,label:'HTTP'},{port:2222,label:'SSH'}],
              envFields:[
                  {key:'GITEA__database__DB_TYPE', label:'DB type', default:'sqlite3'},
              ],
              volumes:[{name:'giteadata',mount:'/data'}],
            },
            { key:'mailpit', label:'Mailpit', cat:'devops',
              images:['axllent/mailpit:latest'],
              ports:[{port:8025,label:'Web UI'},{port:1025,label:'SMTP'}],
              envFields:[],
              volumes:[],
              note:'Catches all outgoing email â€” dev/test only',
            },
            { key:'adminer', label:'Adminer', cat:'devops',
              images:['adminer:latest','adminer:4'],
              ports:[{port:8080,label:'HTTP'}],
              envFields:[
                  {key:'ADMINER_DEFAULT_SERVER', label:'Default DB server', default:'postgres'},
              ],
              volumes:[],
              note:'Universal database management UI',
            },
            { key:'pgadmin', label:'pgAdmin 4', cat:'devops',
              images:['dpage/pgadmin4:latest','dpage/pgadmin4:8'],
              ports:[{port:5050,label:'HTTP'}],
              envFields:[
                  {key:'PGADMIN_DEFAULT_EMAIL',    label:'Admin email',    default:'admin@admin.com', required:true},
                  {key:'PGADMIN_DEFAULT_PASSWORD', label:'Admin password', default:'admin', required:true, type:'password'},
              ],
              volumes:[{name:'pgadmindata',mount:'/var/lib/pgadmin'}],
            },
            { key:'redisinsight', label:'Redis Insight', cat:'devops',
              images:['redis/redisinsight:latest','redis/redisinsight:2'],
              ports:[{port:5540,label:'HTTP'}],
              envFields:[],
              volumes:[],
              note:'Connect to any Redis-compatible service',
            },
        ];

        // Category labels for UI grouping
        const _infraCategories = {
            'db-rel':  'ğŸ—„ï¸ Relational Databases',
            'db-nosql':'ğŸƒ NoSQL & Time-Series',
            'cache':   'âš¡ Caches & Key-Value',
            'mq':      'ğŸ“¨ Message Brokers & Queues',
            'search':  'ğŸ” Search & Analytics',
            'proxy':   'ğŸŒ Reverse Proxies & Load Balancers',
            'monitor': 'ğŸ“Š Monitoring & Observability',
            'log':     'ğŸ“ Logging',
            'storage': 'ğŸ’¾ Storage & Object Store',
            'devops':  'ğŸ”§ DevOps & Utilities',
        };

        wizardModalOpen({
            title: 'ğŸ³ Docker Setup',
            size: 'wide',
            steps: [
                // â”€â”€ Step 1: Detect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // â”€â”€ Serve from cache if available (instant, zero API calls) â”€â”€
                        const _CK = 'docker:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // â”€â”€ Fresh scan â”€â”€
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Detecting Docker environmentâ€¦</p>';
                        try {
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;
                            const probes = wizDetect.status_probes || {};
                            const docker = probes.docker || {};
                            data._docker = docker;
                            data._dockerStatus = wizDetect.docker_status || {};
                            const dockerStatus = data._dockerStatus;
                            const modules = (wizDetect.config_data || {}).modules || [];
                            data._modules = modules;

                            // Classify modules
                            const classified = modules.map(m => {
                                const cls = _dockerModClass(m);
                                const family = _dockerStackFamily(m.stack || '');
                                return { ...m, _class: cls, _family: family,
                                         _port: family ? _dockerPort(family) : null };
                            });
                            data._classified = classified;

                            const deployable = classified.filter(m => m._class === 'deployable' && m._family);

                            // Docker status
                            let html = wizSection('Docker Environment', 'Current Docker configuration detected in this project.');
                            html += `<div class="wiz-status-grid">
                                ${wizStatusRow('ğŸ³', 'Docker Engine',
                                    dockerStatus.available ? (dockerStatus.version || '').replace('Docker version ','').split(',')[0] || 'Available' : 'Not found',
                                    dockerStatus.available ? 'ok' : 'error')}
                                ${dockerStatus.compose_available ? wizStatusRow('âš™ï¸', 'Docker Compose', (dockerStatus.compose_version || 'âœ“'), 'ok') : ''}
                                ${wizStatusRow('ğŸ“„', 'Dockerfile', docker.has_dockerfile ? 'Present' : 'Missing', docker.has_dockerfile ? 'ok' : 'warn')}
                                ${wizStatusRow('ğŸ“‹', 'Compose file', docker.has_compose ? 'Present' : 'Missing', docker.has_compose ? 'ok' : 'warn')}
                                ${wizStatusRow('ğŸš«', '.dockerignore', docker.has_dockerignore ? 'Present' : 'Missing', docker.has_dockerignore ? 'ok' : 'warn')}
                            </div>`;

                            if (!dockerStatus.available) {
                                html += `<div class="wiz-step-warn-panel" style="margin-top:1rem">
                                    <span>âš ï¸</span>
                                    <span>Docker is not installed. You can still generate config files, but won't be able to build/run until Docker is available.</span>
                                </div>`;
                            }

                            // Module table
                            html += wizSection('Project Modules', `${modules.length} module${modules.length !== 1 ? 's' : ''} detected â€” ${deployable.length} deployable.`);
                            if (modules.length > 0) {
                                html += `<div style="display:flex;flex-direction:column;gap:0.25rem">`;
                                for (const m of classified) {
                                    const isDep = m._class === 'deployable' && m._family;
                                    const badge = isDep ? 'deployable' : m._class;
                                    const badgeColor = isDep ? 'var(--success)' : 'var(--text-muted)';
                                    const badgeIcon = isDep ? 'ğŸŸ¢' : m._class === 'library' ? 'ğŸ“š' : m._class === 'docs' ? 'ğŸ“' : 'âš™ï¸';
                                    html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.3rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                        <span style="width:18px;text-align:center">${badgeIcon}</span>
                                        <strong style="min-width:80px">${esc(m.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(m.stack || '?')}</code>
                                        <span style="flex:1;color:var(--text-muted);font-size:0.72rem">${esc(m.path || '')}</span>
                                        <span style="font-size:0.68rem;color:${badgeColor}">${badge}</span>
                                    </div>`;
                                }
                                html += `</div>`;

                                if (deployable.length > 0) {
                                    html += `<div style="margin-top:0.75rem;font-size:0.8rem;color:var(--text-secondary)">
                                        ğŸ’¡ <strong>${deployable.length}</strong> deployable module${deployable.length !== 1 ? 's' : ''} detected.
                                        The next step lets you choose which ones become containers.
                                    </div>`;
                                } else {
                                    html += `<div class="wiz-step-warn-panel" style="margin-top:0.75rem">
                                        <span>â„¹ï¸</span>
                                        <span>No deployable modules detected â€” you'll be able to pick a stack template manually in the next step.</span>
                                    </div>`;
                                }
                            } else {
                                html += `<div style="font-size:0.82rem;color:var(--text-muted);padding:0.5rem">
                                    No modules configured. You can still pick a stack template manually.
                                </div>`;
                            }

                            // Store complete detect result in cache
                            wizStore(_CK, { h: html, d: { _docker: data._docker, _dockerStatus: data._dockerStatus, _modules: data._modules, _classified: data._classified } }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>âš ï¸</span><span>${esc(e.message)}</span></div>`;
                        }
                    },
                },

                // â”€â”€ Step 2: Configure â€” Container selection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'config', title: 'Configure',
                    render: (data, el) => {
                        const docker   = data._docker || {};
                        const modules  = data._classified || [];
                        const deployable = modules.filter(m => m._class === 'deployable' && m._family);
                        const stackOpts = Object.keys(_dockerStackDefaults);

                        // Helper to render a base-image select with custom option
                        function _imgSelect(id, family) {
                            const d = _dockerStackDefaults[family] || {};
                            const imgs = d.images || ['ubuntu:22.04'];
                            return `<select id="${id}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem"
                                onchange="var ci=document.getElementById('${id}-custom');if(ci)ci.style.display=this.value==='__custom'?'block':'none'">
                                ${imgs.map((img, j) => `<option value="${img}"${j === 0 ? ' selected' : ''}>${img}</option>`).join('')}
                                <option value="__custom">Customâ€¦</option>
                            </select>
                            <input type="text" id="${id}-custom" class="modal-form-input" placeholder="e.g. python:3.10-bullseye"
                                style="font-size:0.74rem;padding:0.2rem 0.3rem;margin-top:3px;display:none">`;
                        }

                        // Helper: mini label
                        const _lbl = (txt, sub) => `<label style="display:block;font-size:0.7rem;color:var(--text-muted);margin-bottom:2px">${txt}${sub ? ` <span style="font-size:0.62rem;opacity:0.7">(${sub})</span>` : ''}</label>`;
                        const _inp = (id, val, ph) => `<input type="text" id="${id}" class="modal-form-input" value="${esc(val || '')}" placeholder="${ph || ''}" style="font-size:0.76rem;padding:0.2rem 0.3rem">`;
                        const _num = (id, val) => `<input type="number" id="${id}" class="modal-form-input" value="${val}" style="font-size:0.76rem;padding:0.2rem 0.3rem">`;
                        const _ta = (id, val, ph, rows) => `<textarea id="${id}" class="modal-form-input" rows="${rows || 2}" placeholder="${ph || ''}" style="font-size:0.72rem;padding:0.2rem 0.3rem;font-family:var(--font-mono,monospace);resize:vertical;min-height:38px">${esc(val || '')}</textarea>`;

                        let html = '';

                        // â”€â”€ Global compose settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        html += wizSection('Compose Project', 'Global settings for docker-compose.yml.');
                        html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;max-width:500px">
                            <div>${_lbl('Project name', 'optional')}${_inp('mf-dk-project-name', '', 'my-project')}</div>
                            <div>${_lbl('Platform', 'optional')}
                                <select id="mf-dk-platform" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem">
                                    ${_platformOptions.map(p => `<option value="${p}">${p || 'auto (default)'}</option>`).join('')}
                                </select>
                            </div>
                        </div>`;

                        // â”€â”€ Section A: Module containers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        html += wizSection('Containers',
                            deployable.length > 0
                                ? 'Select which modules should become Docker containers and configure each one.'
                                : 'No deployable modules found â€” configure a container manually.'
                        );

                        if (deployable.length > 0) {
                            const allSvcNames = deployable.map(m => m.name);
                            const allInfraNames = _infraOptions.map(o => o.key);

                            html += `<div style="display:flex;flex-direction:column;gap:0.5rem" id="dk-mod-list">`;
                            for (let i = 0; i < deployable.length; i++) {
                                const m = deployable[i];
                                const d = _dockerStackDefaults[m._family] || {};
                                const nextPort = (d.expose || 8080) + i;
                                const otherSvcs = allSvcNames.filter(n => n !== m.name).concat(allInfraNames);

                                html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);overflow:hidden" id="dk-mod-card-${i}">
                                    <label style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.6rem;cursor:pointer;font-size:0.82rem"
                                        onmouseover="this.parentElement.style.borderColor='var(--accent)'" onmouseout="this.parentElement.style.borderColor='var(--border-subtle)'">
                                        <input type="checkbox" id="mf-dk-mod-${i}" checked style="accent-color:var(--accent)"
                                            onchange="document.getElementById('dk-mod-cfg-${i}').style.display=this.checked?'block':'none'">
                                        <strong>${esc(m.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(m.stack || '?')}</code>
                                        <span style="flex:1;color:var(--text-muted);font-size:0.72rem">${esc(m.path || '')}</span>
                                    </label>
                                    <div id="dk-mod-cfg-${i}" style="padding:0 0.6rem 0.5rem;display:block">
                                        <!-- Primary: base image, port, path, restart -->
                                        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:0.4rem;align-items:start">
                                            <div>${_lbl('Base image')}${_imgSelect(`mf-dk-img-${i}`, m._family)}</div>
                                            <div>${_lbl('Port')}${_num(`mf-dk-port-${i}`, nextPort)}</div>
                                            <div>${_lbl('Dockerfile path')}${_inp(`mf-dk-dkpath-${i}`, deployable.length > 1 ? m.path + '/Dockerfile' : 'Dockerfile', '')}</div>
                                            <div>${_lbl('Restart policy')}
                                                <select id="mf-dk-restart-${i}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem">
                                                    ${_restartPolicies.map(r => `<option value="${r}"${r === 'unless-stopped' ? ' selected' : ''}>${r}</option>`).join('')}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Dockerfile settings -->
                                        <details style="margin-top:0.4rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0">â–¸ Dockerfile Settings</summary>
                                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem;margin-top:0.3rem">
                                                <div>${_lbl('Working directory')}${_inp(`mf-dk-workdir-${i}`, d.workdir, '/app')}</div>
                                                <div>${_lbl('Install command')}${_inp(`mf-dk-install-${i}`, d.install, 'pip install -r requirements.txt')}</div>
                                                <div>${_lbl('Build command', 'optional')}${_inp(`mf-dk-build-${i}`, d.build, 'npm run build')}</div>
                                                <div>${_lbl('Entrypoint', 'optional')}${_inp(`mf-dk-entrypoint-${i}`, d.entrypoint, 'gunicorn')}</div>
                                                <div>${_lbl('CMD')}${_inp(`mf-dk-cmd-${i}`, d.cmd, 'python app.py')}</div>
                                                <div>${_lbl('EXPOSE port')}${_num(`mf-dk-expose-${i}`, d.expose)}</div>
                                            </div>
                                        </details>

                                        <!-- Compose settings -->
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0">â–¸ Compose Settings</summary>
                                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-top:0.3rem">
                                                <div>${_lbl('Container name', 'optional')}${_inp(`mf-dk-cname-${i}`, '', m.name)}</div>
                                                <div>${_lbl('Health check', 'optional')}${_inp(`mf-dk-health-${i}`, '', 'curl -f http://localhost:' + nextPort + '/health')}</div>
                                                <div>${_lbl('Build args', 'KEY=VAL per line')}${_ta(`mf-dk-buildargs-${i}`, '', 'ENV=production', 2)}</div>
                                                <div>${_lbl('Networks', 'one per line')}${_ta(`mf-dk-networks-${i}`, '', 'backend\nfrontend', 2)}</div>
                                                <div>${_lbl('Environment', 'KEY=VAL per line')}${_ta(`mf-dk-env-${i}`, '', 'DB_HOST=postgres\nDEBUG=false', 2)}</div>
                                                <div>${_lbl('Volumes', 'host:container per line')}${_ta(`mf-dk-vol-${i}`, '', './data:/app/data', 2)}</div>
                                                <div style="grid-column:1/-1">
                                                    ${_lbl('Depends on')}
                                                    <div style="display:flex;flex-wrap:wrap;gap:0.25rem">
                                                        ${otherSvcs.map(sn => `<label style="display:inline-flex;align-items:center;gap:0.2rem;font-size:0.7rem;cursor:pointer">
                                                            <input type="checkbox" class="dk-dep-${i}" value="${sn}" style="accent-color:var(--accent)"> ${sn}
                                                        </label>`).join('')}
                                                        ${otherSvcs.length === 0 ? '<span style="font-size:0.7rem;color:var(--text-muted)">â€”</span>' : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </details>
                                    </div>
                                </div>`;
                            }
                            html += `</div>`;
                        } else {
                            // Manual container config
                            const defFamily = 'python';
                            const d = _dockerStackDefaults[defFamily];
                            html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);padding:0.6rem">
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.4rem;align-items:start">
                                    <div>${_lbl('Stack template')}
                                        <select id="mf-dk-manual-stack" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem"
                                            onchange="var f=this.value;var sd=window._dkStackDefaults||{};var dd=sd[f]||{};
                                                var imgEl=document.getElementById('mf-dk-manual-img');if(imgEl){imgEl.innerHTML=(dd.images||[]).map(function(im,j){return '<option value=\"'+im+'\"'+(j===0?' selected':'')+'>'+im+'</option>'}).join('')+'<option value=\"__custom\">Customâ€¦</option>';}
                                                var flds={'mf-dk-manual-workdir':'workdir','mf-dk-manual-install':'install','mf-dk-manual-build':'build','mf-dk-manual-cmd':'cmd','mf-dk-manual-entrypoint':'entrypoint'};
                                                for(var k in flds){var el=document.getElementById(k);if(el)el.value=dd[flds[k]]||'';}
                                                var pe=document.getElementById('mf-dk-manual-port');if(pe)pe.value=dd.expose||8080;
                                                var ee=document.getElementById('mf-dk-manual-expose');if(ee)ee.value=dd.expose||8080;">
                                            ${stackOpts.map(s => `<option value="${s}">${s}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>${_lbl('Base image')}${_imgSelect('mf-dk-manual-img', defFamily)}</div>
                                    <div>${_lbl('Port')}${_num('mf-dk-manual-port', d.expose)}</div>
                                    <div>${_lbl('Restart policy')}
                                        <select id="mf-dk-manual-restart" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem">
                                            ${_restartPolicies.map(r => `<option value="${r}"${r === 'unless-stopped' ? ' selected' : ''}>${r}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <details style="margin-top:0.4rem">
                                    <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0">â–¸ Dockerfile Settings</summary>
                                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem;margin-top:0.3rem">
                                        <div>${_lbl('Working directory')}${_inp('mf-dk-manual-workdir', d.workdir, '/app')}</div>
                                        <div>${_lbl('Install command')}${_inp('mf-dk-manual-install', d.install, '')}</div>
                                        <div>${_lbl('Build command', 'optional')}${_inp('mf-dk-manual-build', d.build, '')}</div>
                                        <div>${_lbl('Entrypoint', 'optional')}${_inp('mf-dk-manual-entrypoint', d.entrypoint, '')}</div>
                                        <div>${_lbl('CMD')}${_inp('mf-dk-manual-cmd', d.cmd, '')}</div>
                                        <div>${_lbl('EXPOSE port')}${_num('mf-dk-manual-expose', d.expose)}</div>
                                    </div>
                                </details>
                                <details style="margin-top:0.3rem">
                                    <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0">â–¸ Compose Settings</summary>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-top:0.3rem">
                                        <div>${_lbl('Container name', 'optional')}${_inp('mf-dk-manual-cname', '', 'app')}</div>
                                        <div>${_lbl('Health check', 'optional')}${_inp('mf-dk-manual-health', '', '')}</div>
                                        <div>${_lbl('Environment', 'KEY=VAL per line')}${_ta('mf-dk-manual-env', '', '', 2)}</div>
                                        <div>${_lbl('Volumes', 'host:container per line')}${_ta('mf-dk-manual-vol', '', '', 2)}</div>
                                    </div>
                                </details>
                            </div>`;
                            // Expose stack defaults to window for manual mode onchange
                            // Expose stack defaults for manual mode onchange handler
                            window._dkStackDefaults = _dockerStackDefaults;
                        }

                        // Overwrite warning
                        if (docker.has_dockerfile) {
                            html += `<div style="margin-top:0.5rem">
                                ${modalFormField({ name: 'dk-overwrite', label: 'Overwrite existing Dockerfile(s)', type: 'checkbox', value: false })}
                            </div>`;
                        }

                        // â”€â”€ Section B: Infra services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        html += wizSection('Infrastructure Services', 'Optionally add common services to your compose file.');
                        html += `<div id="dk-infra-list" style="display:flex;flex-direction:column;gap:0.35rem">`;

                        // Helper: render the inline config panel for a service
                        const _infraCfgPanel = (inf) => {
                            const k = inf.key;
                            let p = `<div id="dk-infra-cfg-${k}" style="display:none;padding:0.55rem 0.6rem 0.6rem;border-top:1px solid var(--border-subtle);background:color-mix(in srgb,var(--bg-inset) 60%,transparent);font-size:0.82rem;color:var(--text-primary)">`;

                            // â”€â”€ Image selector
                            p += `<div style="display:flex;flex-wrap:wrap;gap:0.3rem 0.6rem;align-items:center;margin-bottom:0.35rem">`;
                            p += `<label style="font-weight:600;min-width:4rem;color:var(--text-secondary)">Image</label>`;
                            p += `<select id="mf-dk-infra-img-${k}" style="flex:1;min-width:10rem;padding:0.3rem 0.4rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);color-scheme:dark;font-size:0.8rem;font-family:monospace">`;
                            for (const img of inf.images) {
                                p += `<option value="${esc(img)}">${esc(img)}</option>`;
                            }
                            p += `<option value="__custom">âŒ¨ Customâ€¦</option></select>`;
                            p += `<input id="mf-dk-infra-imgcustom-${k}" type="text" placeholder="e.g. myregistry/image:tag" style="display:none;flex:1;min-width:10rem;padding:0.3rem 0.4rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);font-size:0.8rem;font-family:monospace">`;
                            p += `</div>`;

                            // â”€â”€ Ports
                            if (inf.ports.length > 0) {
                                p += `<div style="display:flex;flex-wrap:wrap;gap:0.2rem 0.5rem;align-items:center;margin-bottom:0.35rem">`;
                                p += `<span style="font-weight:600;min-width:4rem;color:var(--text-secondary)">Ports</span>`;
                                for (const pt of inf.ports) {
                                    p += `<label style="display:inline-flex;align-items:center;gap:0.2rem">`;
                                    p += `<input type="number" id="mf-dk-infra-port-${k}-${pt.port}" value="${pt.port}" min="1" max="65535" style="width:5rem;padding:0.25rem 0.3rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);font-size:0.8rem;font-family:monospace;text-align:center">`;
                                    p += `<span style="color:var(--text-secondary);font-size:0.78rem">${esc(pt.label)}</span>`;
                                    p += `</label>`;
                                }
                                p += `</div>`;
                            }

                            // â”€â”€ Environment fields
                            if (inf.envFields.length > 0) {
                                p += `<div style="margin-bottom:0.35rem">`;
                                p += `<div style="font-weight:600;margin-bottom:0.2rem;color:var(--text-secondary)">Environment</div>`;
                                p += `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(14rem,1fr));gap:0.2rem 0.5rem">`;
                                for (const ef of inf.envFields) {
                                    const inputType = ef.type === 'password' ? 'password' : 'text';
                                    p += `<label style="display:flex;align-items:center;gap:0.25rem">`;
                                    p += `<span style="min-width:7.5rem;font-size:0.78rem;color:var(--text-secondary)">${esc(ef.label)}${ef.required ? ' <span style="color:var(--danger)">*</span>' : ''}</span>`;
                                    p += `<input type="${inputType}" id="mf-dk-infra-env-${k}-${ef.key}" value="${esc(ef.default || '')}" placeholder="${esc(ef.key)}" style="flex:1;min-width:6rem;padding:0.25rem 0.3rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);font-size:0.8rem;font-family:monospace">`;
                                    p += `</label>`;
                                }
                                p += `</div></div>`;
                            }

                            // â”€â”€ Volumes
                            if (inf.volumes.length > 0) {
                                p += `<div style="display:flex;flex-wrap:wrap;gap:0.2rem 0.5rem;align-items:center;margin-bottom:0.35rem">`;
                                p += `<span style="font-weight:600;min-width:4rem;color:var(--text-secondary)">Volumes</span>`;
                                for (const v of inf.volumes) {
                                    // host-bind (starts with /) vs named volume
                                    const isHostBind = v.name.startsWith('/');
                                    const volStr = isHostBind ? `${v.name}:${v.mount}` : `${v.name}:${v.mount}`;
                                    p += `<label style="display:inline-flex;align-items:center;gap:0.2rem">`;
                                    p += `<input type="checkbox" id="mf-dk-infra-vol-${k}-${v.name.replace(/[^a-zA-Z0-9]/g,'_')}" checked style="accent-color:var(--accent);width:14px;height:14px">`;
                                    p += `<code style="font-size:0.76rem;color:var(--text-secondary);background:var(--bg-base);padding:0.1rem 0.3rem;border-radius:3px">${esc(volStr)}</code>`;
                                    p += `</label>`;
                                }
                                p += `</div>`;
                            }

                            // â”€â”€ Command override
                            if (inf.command) {
                                p += `<div style="display:flex;gap:0.3rem;align-items:center;margin-bottom:0.35rem">`;
                                p += `<span style="font-weight:600;min-width:4rem;color:var(--text-secondary)">Command</span>`;
                                p += `<input type="text" id="mf-dk-infra-cmd-${k}" value="${esc(inf.command)}" style="flex:1;padding:0.25rem 0.3rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);font-size:0.8rem;font-family:monospace">`;
                                p += `</div>`;
                            }

                            // â”€â”€ Restart policy
                            p += `<div style="display:flex;gap:0.3rem;align-items:center;margin-bottom:0.2rem">`;
                            p += `<span style="font-weight:600;min-width:4rem;color:var(--text-secondary)">Restart</span>`;
                            p += `<select id="mf-dk-infra-restart-${k}" style="padding:0.25rem 0.3rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);color-scheme:dark;font-size:0.8rem">`;
                            for (const rp of _restartPolicies) {
                                p += `<option value="${rp}"${rp === 'unless-stopped' ? ' selected' : ''}>${rp}</option>`;
                            }
                            p += `</select>`;
                            p += `</div>`;

                            // â”€â”€ Note
                            if (inf.note) {
                                p += `<div style="font-size:0.76rem;color:var(--text-secondary);font-style:italic;margin-top:0.25rem">â„¹ï¸ ${inf.note}</div>`;
                            }

                            p += `</div>`;
                            return p;
                        };

                        // Group by category
                        const catOrder = Object.keys(_infraCategories);
                        for (const cat of catOrder) {
                            const items = _infraOptions.filter(o => o.cat === cat);
                            if (items.length === 0) continue;
                            const isPopular = ['db-rel','cache','mq'].includes(cat);
                            html += `<details${isPopular ? ' open' : ''} style="border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-inset);overflow:hidden">
                                <summary style="cursor:pointer;padding:0.4rem 0.55rem;font-size:0.84rem;font-weight:600;color:var(--text-primary);user-select:none;display:flex;align-items:center;gap:0.3rem">
                                    ${_infraCategories[cat]}
                                    <span style="font-size:0.74rem;opacity:0.6;margin-left:auto">${items.length}</span>
                                </summary>
                                <div style="padding:0.3rem 0.5rem 0.4rem">`;
                            for (const inf of items) {
                                const primaryPort = inf.ports.length > 0 ? inf.ports[0].port : '';
                                html += `<div style="border:1px solid var(--border-subtle);border-radius:5px;margin-bottom:0.25rem;overflow:hidden;transition:border-color 0.15s"
                                    onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
                                    <label style="display:flex;align-items:center;gap:0.3rem;padding:0.3rem 0.5rem;cursor:pointer;font-size:0.82rem;color:var(--text-primary)">
                                        <input type="checkbox" id="mf-dk-infra-${inf.key}" data-infra-key="${inf.key}" class="dk-infra-toggle" style="accent-color:var(--accent);width:15px;height:15px">
                                        <strong>${esc(inf.label)}</strong>
                                        ${primaryPort ? `<span style="color:var(--text-secondary);font-size:0.76rem;margin-left:auto">:${primaryPort}</span>` : ''}
                                        <span style="font-size:0.72rem;color:var(--text-secondary);margin-left:${primaryPort ? '0.3rem' : 'auto'}">${inf.images[0].split(':')[0].split('/').pop()}</span>
                                    </label>
                                    ${_infraCfgPanel(inf)}
                                </div>`;
                            }
                            html += `</div></details>`;
                        }
                        html += `</div>`;

                        // â”€â”€ Section C: Options â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        html += wizSection('Generation Options', 'What files to create.');
                        html += `<div class="modal-form-grid">`;
                        html += modalFormField({ name: 'dk-compose', label: 'Generate docker-compose.yml', type: 'checkbox', value: !docker.has_compose || deployable.length > 1, fullWidth: true });
                        html += modalFormField({ name: 'dk-ignore',  label: 'Generate .dockerignore',      type: 'checkbox', value: !docker.has_dockerignore, fullWidth: true });
                        html += `</div>`;

                        el.innerHTML = html;

                        // â”€â”€ Wire up infra checkbox toggle + custom image selector
                        el.addEventListener('change', (e) => {
                            const cb = e.target;
                            // Toggle config panel
                            if (cb.classList.contains('dk-infra-toggle')) {
                                const key = cb.dataset.infraKey;
                                const cfg = document.getElementById(`dk-infra-cfg-${key}`);
                                if (cfg) cfg.style.display = cb.checked ? 'block' : 'none';
                            }
                            // Custom image select
                            if (cb.tagName === 'SELECT' && cb.id && cb.id.startsWith('mf-dk-infra-img-')) {
                                const key = cb.id.replace('mf-dk-infra-img-', '');
                                const custom = document.getElementById(`mf-dk-infra-imgcustom-${key}`);
                                if (custom) custom.style.display = cb.value === '__custom' ? 'inline-block' : 'none';
                            }
                        });
                    },
                    collect: (data) => {
                        const deployable = (data._classified || []).filter(m => m._class === 'deployable' && m._family);

                        // Helper: parse KEY=VALUE textarea into dict
                        function _parseEnv(id) {
                            const el = document.getElementById(id);
                            if (!el || !el.value.trim()) return null;
                            const env = {};
                            for (const line of el.value.trim().split('\n')) {
                                const eq = line.indexOf('=');
                                if (eq > 0) env[line.slice(0, eq).trim()] = line.slice(eq + 1).trim();
                            }
                            return Object.keys(env).length > 0 ? env : null;
                        }

                        // Helper: parse line-separated textarea into array
                        function _parseLines(id) {
                            const el = document.getElementById(id);
                            if (!el || !el.value.trim()) return null;
                            const lines = el.value.trim().split('\n').map(l => l.trim()).filter(Boolean);
                            return lines.length > 0 ? lines : null;
                        }

                        // Helper: collect checked checkboxes by class
                        function _parseDeps(className) {
                            const cbs = document.querySelectorAll(`.${className}:checked`);
                            const deps = Array.from(cbs).map(cb => cb.value);
                            return deps.length > 0 ? deps : null;
                        }

                        // Helper: read a text/number input value
                        function _val(id) {
                            const el = document.getElementById(id);
                            return el ? el.value.trim() : '';
                        }

                        // Helper: read select value
                        function _sel(id) {
                            const el = document.getElementById(id);
                            return el ? el.value : '';
                        }

                        // Helper: resolve base image (handles custom option)
                        function _resolveImg(id) {
                            const sel = _sel(id);
                            if (sel === '__custom') return _val(id + '-custom') || '';
                            return sel || '';
                        }

                        // Global compose settings
                        data.projectName = _val('mf-dk-project-name');
                        data.platform    = _sel('mf-dk-platform');

                        // Collect selected module containers with all settings
                        data._selectedContainers = [];
                        if (deployable.length > 0) {
                            for (let i = 0; i < deployable.length; i++) {
                                if (mfVal(`dk-mod-${i}`)) {
                                    const m = deployable[i];
                                    const container = {
                                        name: m.name,
                                        path: m.path,
                                        stack: m.stack,
                                        family: m._family,
                                        // Primary
                                        baseImage: _resolveImg(`mf-dk-img-${i}`),
                                        port: parseInt(_val(`mf-dk-port-${i}`)) || m._port,
                                        dockerfilePath: _val(`mf-dk-dkpath-${i}`) || 'Dockerfile',
                                        restart: _sel(`mf-dk-restart-${i}`) || 'unless-stopped',
                                        // Dockerfile settings
                                        workdir: _val(`mf-dk-workdir-${i}`) || '/app',
                                        install: _val(`mf-dk-install-${i}`),
                                        buildCmd: _val(`mf-dk-build-${i}`),
                                        entrypoint: _val(`mf-dk-entrypoint-${i}`),
                                        cmd: _val(`mf-dk-cmd-${i}`),
                                        expose: parseInt(_val(`mf-dk-expose-${i}`)) || null,
                                        // Compose settings
                                        containerName: _val(`mf-dk-cname-${i}`),
                                        healthcheck: _val(`mf-dk-health-${i}`),
                                    };
                                    const env = _parseEnv(`mf-dk-env-${i}`);
                                    if (env) container.environment = env;
                                    const vols = _parseLines(`mf-dk-vol-${i}`);
                                    if (vols) container.volumes = vols;
                                    const deps = _parseDeps(`dk-dep-${i}`);
                                    if (deps) container.depends_on = deps;
                                    const buildArgs = _parseEnv(`mf-dk-buildargs-${i}`);
                                    if (buildArgs) container.build_args = buildArgs;
                                    const nets = _parseLines(`mf-dk-networks-${i}`);
                                    if (nets) container.networks = nets;
                                    data._selectedContainers.push(container);
                                }
                            }
                        } else {
                            // Manual mode
                            const family = _sel('mf-dk-manual-stack') || 'python';
                            const d = _dockerStackDefaults[family] || {};
                            const container = {
                                name: 'app',
                                path: '.',
                                stack: family,
                                family: family,
                                baseImage: _resolveImg('mf-dk-manual-img'),
                                port: parseInt(_val('mf-dk-manual-port')) || d.expose || 8080,
                                dockerfilePath: 'Dockerfile',
                                restart: _sel('mf-dk-manual-restart') || 'unless-stopped',
                                workdir: _val('mf-dk-manual-workdir') || d.workdir || '/app',
                                install: _val('mf-dk-manual-install') || d.install || '',
                                buildCmd: _val('mf-dk-manual-build'),
                                entrypoint: _val('mf-dk-manual-entrypoint'),
                                cmd: _val('mf-dk-manual-cmd') || d.cmd || '',
                                expose: parseInt(_val('mf-dk-manual-expose')) || d.expose || null,
                                containerName: _val('mf-dk-manual-cname'),
                                healthcheck: _val('mf-dk-manual-health'),
                            };
                            const env = _parseEnv('mf-dk-manual-env');
                            if (env) container.environment = env;
                            const vols = _parseLines('mf-dk-manual-vol');
                            if (vols) container.volumes = vols;
                            data._selectedContainers.push(container);
                        }

                        // Infra services â€” collect configured values
                        data._selectedInfra = [];
                        for (const inf of _infraOptions) {
                            if (!mfVal(`dk-infra-${inf.key}`)) continue;
                            const k = inf.key;

                            // Image
                            let image = _sel(`mf-dk-infra-img-${k}`) || inf.images[0];
                            if (image === '__custom') {
                                image = _val(`mf-dk-infra-imgcustom-${k}`) || inf.images[0];
                            }

                            // Ports â€” read edited port values
                            const ports = [];
                            for (const pt of inf.ports) {
                                const edited = parseInt(_val(`mf-dk-infra-port-${k}-${pt.port}`)) || pt.port;
                                ports.push(`${edited}:${edited}`);
                            }

                            // Environment â€” read each field
                            const environment = {};
                            for (const ef of inf.envFields) {
                                const val = _val(`mf-dk-infra-env-${k}-${ef.key}`);
                                if (val !== '') environment[ef.key] = val;
                            }

                            // Volumes â€” only include checked ones
                            const volumes = [];
                            for (const v of inf.volumes) {
                                const volId = `mf-dk-infra-vol-${k}-${v.name.replace(/[^a-zA-Z0-9]/g,'_')}`;
                                if (mfVal(volId)) {
                                    const isHostBind = v.name.startsWith('/');
                                    volumes.push(isHostBind ? `${v.name}:${v.mount}` : `${v.name}:${v.mount}`);
                                }
                            }

                            // Command override
                            const command = _val(`mf-dk-infra-cmd-${k}`) || inf.command || '';

                            // Restart policy
                            const restart = _sel(`mf-dk-infra-restart-${k}`) || 'unless-stopped';

                            data._selectedInfra.push({
                                key: k,
                                label: inf.label,
                                image,
                                ports,
                                environment: Object.keys(environment).length > 0 ? environment : null,
                                volumes: volumes.length > 0 ? volumes : null,
                                command: command || null,
                                restart,
                            });
                        }

                        data.overwrite   = mfVal('dk-overwrite');
                        data.genCompose  = mfVal('dk-compose');
                        data.genIgnore   = mfVal('dk-ignore');
                    },
                    validate: (data) => {
                        if (data._selectedContainers.length === 0 && !data.genCompose && !data.genIgnore) {
                            return 'Select at least one module to containerize, or enable compose/.dockerignore generation.';
                        }
                        // Port conflict check using user-entered ports
                        const portMap = new Map();
                        for (const c of data._selectedContainers) {
                            if (portMap.has(c.port)) {
                                return `Port conflict: "${c.name}" and "${portMap.get(c.port)}" both use port ${c.port}.`;
                            }
                            portMap.set(c.port, c.name);
                        }
                        for (const inf of data._selectedInfra) {
                            for (const portMapping of (inf.ports || [])) {
                                const p = parseInt(portMapping.split(':')[0]);
                                if (!p) continue;
                                if (portMap.has(p)) {
                                    return `Port conflict: "${inf.label}" port ${p} conflicts with "${portMap.get(p)}".`;
                                }
                                portMap.set(p, inf.label);
                            }
                        }
                        return null;
                    },
                },

                // â”€â”€ Step 3: Preview & Edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'preview', title: 'Preview',
                    render: async (data, el) => {
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Generating filesâ€¦</p>';
                        const docker = data._docker || {};
                        data._generatedFiles = [];
                        let fileIdx = 0;

                        let html = wizSection('File Preview', 'Review and edit the generated files before writing to disk.');

                        try {
                            // â”€â”€ Generate Dockerfiles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            for (const c of data._selectedContainers) {
                                if (docker.has_dockerfile && !data.overwrite && c.dockerfilePath === 'Dockerfile') {
                                    html += `<div style="margin-bottom:0.75rem">
                                        <div style="display:flex;align-items:center;gap:0.4rem">
                                            <span>ğŸ“„</span>
                                            <strong style="font-size:0.82rem">${esc(c.dockerfilePath)}</strong>
                                            <span style="font-size:0.68rem;color:var(--text-muted);margin-left:auto">exists â€” skipped</span>
                                        </div>
                                    </div>`;
                                    continue;
                                }

                                // Build Dockerfile content from user settings
                                let dfContent = '';
                                const img = c.baseImage || 'ubuntu:22.04';
                                const wd = c.workdir || '/app';

                                // Build stage
                                dfContent += `# â”€â”€ Build stage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                                dfContent += `FROM ${img} AS builder\n\nWORKDIR ${wd}\n\n`;
                                if (c.install) {
                                    dfContent += `# Install dependencies\nRUN ${c.install}\n\n`;
                                }
                                dfContent += `COPY . .\n`;
                                if (c.buildCmd) {
                                    dfContent += `RUN ${c.buildCmd}\n`;
                                }

                                // Runtime stage
                                dfContent += `\n# â”€â”€ Runtime stage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n`;
                                dfContent += `FROM ${img}\n\nWORKDIR ${wd}\n\n`;
                                dfContent += `# Create non-root user\n`;
                                if (img.includes('alpine')) {
                                    dfContent += `RUN addgroup -g 1000 app && adduser -u 1000 -G app -s /bin/sh -D app\n\n`;
                                } else {
                                    dfContent += `RUN groupadd --gid 1000 app \\\n    && useradd --uid 1000 --gid app --shell /bin/bash --create-home app\n\n`;
                                }
                                dfContent += `COPY --from=builder ${wd} ${wd}\n\n`;
                                dfContent += `USER app\n\n`;

                                if (c.expose) {
                                    dfContent += `EXPOSE ${c.expose}\n\n`;
                                }
                                if (c.entrypoint) {
                                    dfContent += `ENTRYPOINT ["${c.entrypoint}"]\n`;
                                }
                                if (c.cmd) {
                                    // Convert space-separated command to JSON array format
                                    const parts = c.cmd.split(/\s+/);
                                    dfContent += `CMD [${parts.map(p => `"${p}"`).join(', ')}]\n`;
                                }

                                const idx = fileIdx++;
                                const file = { path: c.dockerfilePath, content: dfContent, overwrite: !!data.overwrite };
                                data._generatedFiles.push(file);

                                html += `<div style="margin-bottom:0.75rem">
                                    <details open>
                                        <summary style="cursor:pointer;display:flex;align-items:center;gap:0.4rem;font-size:0.82rem;padding:0.3rem 0;user-select:none">
                                            <span>ğŸ“„</span>
                                            <strong>${esc(c.dockerfilePath)}</strong>
                                            <code style="font-size:0.68rem;background:var(--bg-inset);padding:1px 5px;border-radius:3px;color:var(--text-muted)">${esc(img)}</code>
                                            <span style="font-size:0.68rem;color:var(--success);margin-left:auto">create</span>
                                        </summary>
                                        <textarea id="dk-preview-${idx}"
                                            style="width:100%;min-height:200px;max-height:350px;resize:vertical;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.5rem;font-size:0.72rem;font-family:var(--font-mono,monospace);color:var(--text-secondary);margin-top:0.25rem;line-height:1.4"
                                        >${esc(file.content)}</textarea>
                                    </details>
                                </div>`;
                            }

                            // â”€â”€ Generate compose â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            if (data.genCompose) {
                                const services = [];

                                // Module services (use all user-configured settings)
                                for (const c of data._selectedContainers) {
                                    const svc = {
                                        name: c.name,
                                        ports: [`${c.port}:${c.port}`],
                                        restart: c.restart || 'unless-stopped',
                                    };
                                    if (c.dockerfilePath === 'Dockerfile') {
                                        svc.build_context = '.';
                                    } else {
                                        svc.build_context = `./${c.path}`;
                                        svc.dockerfile = c.dockerfilePath.split('/').pop() || 'Dockerfile';
                                    }
                                    if (c.cmd) svc.command = c.cmd;
                                    if (c.environment) svc.environment = c.environment;
                                    if (c.volumes) svc.volumes = c.volumes;
                                    if (c.depends_on) svc.depends_on = c.depends_on;
                                    if (c.containerName) svc.container_name = c.containerName;
                                    if (c.networks) svc.networks = c.networks;
                                    if (c.build_args) svc.build_args = c.build_args;
                                    if (data.platform) svc.platform = data.platform;
                                    if (c.healthcheck) {
                                        svc.healthcheck = {
                                            test: ['CMD-SHELL', c.healthcheck],
                                            interval: '30s',
                                            timeout: '10s',
                                            retries: 3,
                                        };
                                    }
                                    services.push(svc);
                                }

                                // Infra services â€” use user-configured values
                                for (const inf of data._selectedInfra) {
                                    const svc = {
                                        name: inf.key,
                                        image: inf.image,
                                        restart: inf.restart || 'unless-stopped',
                                    };
                                    if (inf.ports && inf.ports.length > 0) svc.ports = inf.ports;
                                    if (inf.environment) svc.environment = inf.environment;
                                    if (inf.volumes) svc.volumes = inf.volumes;
                                    if (inf.command) svc.command = inf.command;
                                    if (data.platform) svc.platform = data.platform;
                                    services.push(svc);
                                }

                                if (services.length > 0) {
                                    const composeResult = await apiPost('/docker/generate/compose-wizard', {
                                        services,
                                        project_name: data.projectName || '',
                                    });

                                    if (composeResult.ok && composeResult.file) {
                                        const idx = fileIdx++;
                                        const file = { ...composeResult.file, overwrite: true };
                                        data._generatedFiles.push(file);

                                        html += `<div style="margin-bottom:0.75rem">
                                            <details open>
                                                <summary style="cursor:pointer;display:flex;align-items:center;gap:0.4rem;font-size:0.82rem;padding:0.3rem 0;user-select:none">
                                                    <span>ğŸ“‹</span>
                                                    <strong>docker-compose.yml</strong>
                                                    <span style="font-size:0.68rem;color:var(--text-muted)">${services.length} service${services.length !== 1 ? 's' : ''}</span>
                                                    <span style="font-size:0.68rem;color:var(--success);margin-left:auto">create</span>
                                                </summary>
                                                <textarea id="dk-preview-${idx}"
                                                    style="width:100%;min-height:200px;max-height:350px;resize:vertical;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.5rem;font-size:0.72rem;font-family:var(--font-mono,monospace);color:var(--text-secondary);margin-top:0.25rem;line-height:1.4"
                                                >${esc(composeResult.file.content)}</textarea>
                                            </details>
                                        </div>`;
                                    }
                                }
                            }

                            // â”€â”€ Generate .dockerignore â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            if (data.genIgnore) {
                                const allStacks = [...new Set(data._selectedContainers.map(c => c.family))];
                                const ignoreResult = await apiPost('/docker/generate/dockerignore', {
                                    stacks: allStacks.length > 0 ? allStacks : ['python'],
                                });

                                if (ignoreResult.ok && ignoreResult.file) {
                                    const idx = fileIdx++;
                                    const file = { ...ignoreResult.file, overwrite: true };
                                    data._generatedFiles.push(file);

                                    html += `<div style="margin-bottom:0.75rem">
                                        <details>
                                            <summary style="cursor:pointer;display:flex;align-items:center;gap:0.4rem;font-size:0.82rem;padding:0.3rem 0;user-select:none">
                                                <span>ğŸš«</span>
                                                <strong>.dockerignore</strong>
                                                <span style="font-size:0.68rem;color:var(--text-muted)">${allStacks.join(', ')} patterns</span>
                                                <span style="font-size:0.68rem;color:var(--success);margin-left:auto">create</span>
                                            </summary>
                                            <textarea id="dk-preview-${idx}"
                                                style="width:100%;min-height:120px;max-height:250px;resize:vertical;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.5rem;font-size:0.72rem;font-family:var(--font-mono,monospace);color:var(--text-secondary);margin-top:0.25rem;line-height:1.4"
                                            >${esc(ignoreResult.file.content)}</textarea>
                                        </details>
                                    </div>`;
                                }
                            }

                            if (data._generatedFiles.length === 0) {
                                html += `<div style="text-align:center;padding:var(--space-sm);color:var(--text-muted);font-size:0.85rem">
                                    No files to generate. Existing files are kept as-is.
                                </div>`;
                            } else {
                                html += `<div style="margin-top:0.5rem;font-size:0.78rem;color:var(--text-secondary)">
                                    âœï¸ ${data._generatedFiles.length} file${data._generatedFiles.length !== 1 ? 's' : ''} generated â€” edit content above if needed, then click Apply.
                                </div>`;
                            }

                            // Next integration CTA
                            html += `<div style="margin-top:var(--space-md);padding:var(--space-xs) var(--space-sm);border-left:3px solid var(--accent);background:color-mix(in srgb, var(--accent) 5%, transparent);border-radius:0 6px 6px 0">
                                <div style="font-size:0.78rem;color:var(--text-secondary)">
                                    ğŸ’¡ <strong>Next:</strong> Set up CI/CD to automate builds and deployments.
                                    <button class="btn btn-sm btn-ghost" style="font-size:0.72rem;padding:0.1rem 0.4rem;margin-left:4px;color:var(--accent)"
                                        onclick="wizardModalClose();setTimeout(openCICDSetupWizard,300)">Set up CI/CD â†’</button>
                                </div>
                            </div>`;

                            el.innerHTML = html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>âš ï¸</span><span>Generation failed: ${esc(e.message)}</span></div>`;
                        }
                    },
                    // Collect any user edits from the textareas before writing
                    collect: (data) => {
                        for (let i = 0; i < data._generatedFiles.length; i++) {
                            const ta = document.getElementById(`dk-preview-${i}`);
                            if (ta) {
                                data._generatedFiles[i].content = ta.value;
                            }
                        }
                    },
                },
            ],

            onComplete: async (data) => {
                const files = data._generatedFiles || [];
                if (files.length === 0) return;

                const results = [];
                for (const file of files) {
                    try {
                        const res = await api('/docker/generate/write', {
                            method: 'POST',
                            body: JSON.stringify({ file }),
                        });
                        results.push({ path: file.path, ok: !res.error, error: res.error });
                    } catch (e) {
                        results.push({ path: file.path, ok: false, error: e.message });
                    }
                }

                const ok = results.filter(r => r.ok).length;
                const fail = results.filter(r => !r.ok);
                if (fail.length > 0) {
                    console.warn('Docker write failures:', fail);
                }

                _projectStatusTS = 0;
                cardInvalidate('docker');
            },
            successMessage: 'Docker setup complete!',
        });
    }

    // â”€â”€ CI/CD Setup Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function openCICDSetupWizard() {
        wizardModalOpen({
            title: 'âš¡ CI/CD Pipeline Setup',
            size: 'wide',
            steps: [
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // â”€â”€ Serve from cache if available (instant, zero API calls) â”€â”€
                        const _CK = 'cicd:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // â”€â”€ Fresh scan â”€â”€
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Detecting CI/CD configurationâ€¦</p>';
                        try {
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;
                            const probes = wizDetect.status_probes || {};
                            const cicd = probes.cicd || {};
                            const docker = probes.docker || {};
                            data._cicd = cicd;
                            data._docker = docker;
                            data._ciStatus = wizDetect.ci_status || {};

                            const html = `
                                ${wizSection('CI/CD Configuration', 'Current continuous integration / deployment setup.')}
                                <div class="wiz-status-grid">
                                    ${wizStatusRow('âš¡', 'Provider', cicd.provider || 'Not configured', cicd.provider ? 'ok' : 'warn')}
                                    ${wizStatusRow('ğŸ“„', 'Workflow files', String(cicd.workflow_count || 0), cicd.workflow_count > 0 ? 'ok' : 'warn')}
                                    ${wizStatusRow('ğŸ³', 'Docker available', docker.has_dockerfile ? 'Yes' : 'No', docker.has_dockerfile ? 'ok' : 'muted')}
                                </div>
                                ${!docker.has_dockerfile ? `
                                    <div class="wiz-action-row" style="margin-top:1rem">
                                        <span class="wiz-action-label">ğŸ’¡ Set up Docker first for container-based CI/CD workflows.</span>
                                        <button class="btn btn-sm btn-secondary" onclick="wizardModalClose(); openDockerSetupWizard();">Setup Docker â†’</button>
                                    </div>
                                ` : ''}
                            `;

                            // Store complete detect result in cache
                            wizStore(_CK, { h: html, d: { _cicd: data._cicd, _docker: data._docker, _ciStatus: data._ciStatus } }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>âš ï¸</span><span>${esc(e.message)}</span></div>`;
                        }
                    },
                },
                {
                    id: 'config', title: 'Configure',
                    render: (data, el) => {
                        const docker = data._docker || {};
                        el.innerHTML = `
                            ${wizSection('Workflow Configuration', 'What should the CI pipeline do?')}
                            ${wizFormGrid([
                                { name: 'ci-test', label: 'Run tests', type: 'checkbox', value: true },
                                { name: 'ci-lint', label: 'Run linting', type: 'checkbox', value: true },
                                { name: 'ci-typecheck', label: 'Type checking', type: 'checkbox', value: true },
                                { name: 'ci-coverage', label: 'Upload coverage', type: 'checkbox', value: false },
                                { name: 'ci-docker', label: 'Build Docker image', type: 'checkbox', value: docker.has_dockerfile },
                                { name: 'ci-docker-push', label: 'Push to registry', type: 'checkbox', value: false },
                            ])}

                            ${wizSection('Trigger', 'When should the pipeline run?')}
                            ${wizFormGrid([
                                { name: 'ci-trigger', label: 'Trigger', type: 'select', value: 'push-pr', options: [
                                    { value: 'push-pr', label: 'Push + Pull Request' },
                                    { value: 'push', label: 'Push only' },
                                    { value: 'pr', label: 'Pull Request only' },
                                    { value: 'manual', label: 'Manual only' },
                                ]},
                                { name: 'ci-branch', label: 'Branch filter', value: 'main', placeholder: 'main, develop' },
                            ])}
                        `;
                    },
                    collect: (data) => {
                        data.runTests = mfVal('ci-test');
                        data.runLint = mfVal('ci-lint');
                        data.typeCheck = mfVal('ci-typecheck');
                        data.coverage = mfVal('ci-coverage');
                        data.dockerBuild = mfVal('ci-docker');
                        data.dockerPush = mfVal('ci-docker-push');
                        data.trigger = mfVal('ci-trigger');
                        data.branch = mfVal('ci-branch');
                    },
                },
                {
                    id: 'review', title: 'Review & Apply',
                    render: (data, el) => {
                        const steps = [];
                        if (data.runLint) steps.push('Lint');
                        if (data.typeCheck) steps.push('Type check');
                        if (data.runTests) steps.push('Test');
                        if (data.coverage) steps.push('Coverage');
                        if (data.dockerBuild) steps.push('Docker build');
                        if (data.dockerPush) steps.push('Docker push');

                        el.innerHTML = `
                            ${wizSection('Review', 'A GitHub Actions workflow will be generated.')}
                            <div class="wiz-review-item">
                                <span class="wiz-review-icon">ğŸ“„</span>
                                <div class="wiz-review-content">
                                    <div class="wiz-review-label">.github/workflows/ci.yml</div>
                                    <div class="wiz-review-value">Steps: ${steps.join(' â†’ ')}</div>
                                </div>
                                <span class="wiz-review-badge ready">create</span>
                            </div>
                            <div class="wiz-review-item">
                                <span class="wiz-review-icon">ğŸ”€</span>
                                <div class="wiz-review-content">
                                    <div class="wiz-review-label">Trigger</div>
                                    <div class="wiz-review-value">${esc(data.trigger || 'push-pr')} on ${esc(data.branch || 'main')}</div>
                                </div>
                            </div>
                        `;
                    },
                },
            ],
            onComplete: async (data) => {
                await apiPost('/wizard/setup', {
                    action: 'setup_ci',
                    test: data.runTests,
                    lint: data.runLint,
                    typecheck: data.typeCheck,
                    coverage: data.coverage,
                    docker_build: data.dockerBuild,
                    docker_push: data.dockerPush,
                    trigger: data.trigger,
                    branch: data.branch,
                });
                _projectStatusTS = 0;
            },
            successMessage: 'CI/CD pipeline created!',
        });
    }

    // â”€â”€ Kubernetes Setup Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function openK8sSetupWizard() {

        // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

        /** Classify a module for K8s (same logic as Docker wizard). */
        function _k8sModClass(mod) {
            const dom = (mod.domain || '').toLowerCase();
            const st  = (mod.stack  || '').toLowerCase();
            if (dom === 'library')  return 'library';
            if (dom === 'docs' || st === 'markdown') return 'docs';
            if (['kubernetes', 'helm', 'terraform', 'docker-compose'].includes(st)) return 'ops-tool';
            return 'deployable';
        }

        /**
         * Classify a compose service as 'application' or 'infrastructure'.
         * Infrastructure = well-known DB/cache/broker images with no build context.
         * Application = has build context, or image matches project/module name.
         */
        function _k8sSvcClass(svc, moduleNames) {
            // Has build config â†’ definitely an application
            if (svc.build) return 'application';
            // Image matches a project module name â†’ application
            if (svc.image && moduleNames.some(n => svc.image.includes(n))) return 'application';
            // Well-known infrastructure image prefixes
            const infraImages = [
                'postgres', 'mysql', 'mariadb', 'mongo', 'redis', 'valkey', 'memcached',
                'rabbitmq', 'kafka', 'nats', 'mosquitto', 'elasticsearch', 'opensearch',
                'nginx', 'traefik', 'haproxy', 'envoy', 'caddy',
                'grafana', 'prometheus', 'jaeger', 'zipkin', 'loki',
                'minio', 'vault', 'consul', 'etcd', 'zookeeper',
                'mailpit', 'adminer', 'pgadmin', 'neo4j', 'cassandra',
                'cockroachdb', 'couchdb', 'influxdb', 'clickhouse', 'timescale',
                'redpanda', 'activemq', 'pulsar', 'celery',
                'gitea', 'portainer', 'seq', 'vector', 'fluentd', 'logstash',
                'keycloak', 'dex', 'hydra',
                'localstack', 'dynamodb-local', 'azurite',
                'dragonfly', 'keydb', 'arangodb', 'surrealdb',
            ];
            const imgLower = (svc.image || '').toLowerCase();
            if (infraImages.some(prefix => imgLower.includes(prefix))) return 'infrastructure';
            // No build + no known infra image â†’ treat as application (external image)
            return 'application';
        }

        /** Resolve best image name for a service in K8s context. */
        function _k8sImageName(svc, ghRepo) {
            // 1. If compose has explicit image â†’ use it
            if (svc.image) return svc.image;
            // 2. If we have a GitHub repo â†’ construct from registry
            if (ghRepo && ghRepo.owner && ghRepo.name) {
                return `ghcr.io/${ghRepo.owner}/${ghRepo.name}-${svc.name}:latest`;
            }
            // 3. Fallback
            return `${svc.name}:latest`;
        }

        /** Get the primary container port from a compose service. */
        function _k8sPrimaryPort(svc) {
            if (svc.ports && svc.ports.length > 0) return svc.ports[0].container;
            return 8080;
        }

        wizardModalOpen({
            title: 'â˜¸ï¸ Kubernetes Setup',
            size: 'wide',
            steps: [
                // â”€â”€ Step 1: Detect â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // â”€â”€ Serve from cache if available â”€â”€
                        const _CK = 'k8s:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // â”€â”€ Fresh scan â”€â”€
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Analyzing project for Kubernetes deploymentâ€¦</p>';
                        try {
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;

                            // â”€â”€ Extract all data sources â”€â”€
                            const probes = wizDetect.status_probes || {};
                            const k8s = probes.k8s || {};
                            const docker = probes.docker || {};
                            const dockerStatus = wizDetect.docker_status || {};
                            const configData = wizDetect.config_data || {};
                            const modules = configData.modules || [];
                            const envs = configData.environments || [];
                            const ghRepo = wizDetect.gh_repo_info || {};
                            const composeDetails = dockerStatus.compose_service_details || [];

                            // â”€â”€ Classify modules â”€â”€
                            const classifiedModules = modules.map(m => ({
                                ...m,
                                _class: _k8sModClass(m),
                            }));
                            const deployableModules = classifiedModules.filter(m => m._class === 'deployable');
                            const moduleNames = modules.map(m => m.name);

                            // â”€â”€ Classify compose services â”€â”€
                            const classifiedServices = composeDetails.map(svc => ({
                                ...svc,
                                _class: _k8sSvcClass(svc, moduleNames),
                                _image: _k8sImageName(svc, ghRepo),
                                _port: _k8sPrimaryPort(svc),
                            }));
                            const appServices = classifiedServices.filter(s => s._class === 'application');
                            const infraServices = classifiedServices.filter(s => s._class === 'infrastructure');

                            // â”€â”€ Store all data for subsequent steps â”€â”€
                            data._k8s = k8s;
                            data._docker = docker;
                            data._dockerStatus = dockerStatus;
                            data._modules = modules;
                            data._classifiedModules = classifiedModules;
                            data._composeServices = classifiedServices;
                            data._appServices = appServices;
                            data._infraServices = infraServices;
                            data._ghRepo = ghRepo;
                            data._envs = envs;

                            // Fetch vault keys (secrets + config vars)
                            try {
                                const vaultData = await api('/vault/keys');
                                data._vaultKeys = (vaultData && vaultData.keys) || [];
                            } catch(e) { data._vaultKeys = []; }


                            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                            // â”€â”€ BUILD DETECT HTML â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                            // â”€â”€ Read-only scan banner â”€â”€
                            let html = `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;margin-bottom:var(--space-sm);font-size:0.82rem;background:color-mix(in srgb, var(--accent) 10%, var(--bg-inset));border:1px solid color-mix(in srgb, var(--accent) 30%, transparent);border-radius:8px">
                                <span style="font-size:1.1rem">ğŸ”</span>
                                <span style="flex:1;color:var(--text-secondary)">This is a <strong>read-only scan</strong>. To configure K8s resources, proceed to Configure.</span>
                                <button type="button" class="btn btn-xs" style="background:var(--accent);color:white;border:none;padding:4px 12px;border-radius:6px;font-size:0.78rem;white-space:nowrap;cursor:pointer"
                                    onclick="document.getElementById('wiz-btn-next')?.click()">Configure â†’</button>
                            </div>`;

                            // â”€â”€ Section 1: Kubernetes Environment â”€â”€
                            html += wizSection('Kubernetes Environment', 'Current K8s tooling and cluster status.');
                            html += `<div class="wiz-status-grid">
                                ${wizStatusRow('â˜¸ï¸', 'kubectl', k8s.has_kubectl ? 'Available' : 'Not found', k8s.has_kubectl ? 'ok' : 'error')}
                                ${wizStatusRow('âˆ', 'Helm', k8s.has_helm ? 'Available' : 'Not found', k8s.has_helm ? 'ok' : 'muted')}
                                ${wizStatusRow('ğŸ”—', 'Cluster', k8s.cluster_connected ? 'Connected' : 'Not connected', k8s.cluster_connected ? 'ok' : 'warn')}
                                ${wizStatusRow('ğŸ“„', 'Manifests', k8s.manifest_count > 0 ? `${k8s.manifest_count} found` : 'None', k8s.manifest_count > 0 ? 'ok' : 'muted')}
                                ${wizStatusRow('ğŸ“¦', 'Helm Chart', k8s.has_chart ? 'Present' : 'None', k8s.has_chart ? 'ok' : 'muted')}
                            </div>`;

                            // â”€â”€ Section 2: Docker Context â”€â”€
                            html += wizSection('Docker Context', 'Container infrastructure feeding K8s deployments.');
                            html += `<div class="wiz-status-grid">
                                ${wizStatusRow('ğŸ³', 'Docker', dockerStatus.available ? 'Available' : 'Not installed', dockerStatus.available ? 'ok' : 'error')}
                                ${wizStatusRow('ğŸ“‹', 'Compose file', docker.has_compose ? (dockerStatus.compose_file || 'Present') : 'Missing', docker.has_compose ? 'ok' : 'warn')}
                                ${wizStatusRow('ğŸ“„', 'Dockerfiles', docker.has_dockerfile ? `${(dockerStatus.dockerfiles || []).length} found` : 'Missing', docker.has_dockerfile ? 'ok' : 'warn')}
                            </div>`;

                            if (!docker.has_dockerfile && !docker.has_compose) {
                                html += `<div class="wiz-step-warn-panel" style="margin-top:0.5rem">
                                    <span>ğŸ’¡</span>
                                    <span style="flex:1">Set up Docker first â€” K8s deployments need container images.</span>
                                    <button class="btn btn-sm btn-secondary" style="flex-shrink:0" onclick="wizardModalClose(); setTimeout(openDockerSetupWizard, 200)">Setup Docker â†’</button>
                                </div>`;
                            }

                            // â”€â”€ Section 3: Compose Services (the key intelligence) â”€â”€
                            if (composeDetails.length > 0) {
                                html += wizSection(
                                    'Compose Services',
                                    `${composeDetails.length} service${composeDetails.length !== 1 ? 's' : ''} detected â€” ${appServices.length} application, ${infraServices.length} infrastructure.`
                                );
                                html += `<div style="display:flex;flex-direction:column;gap:0.25rem">`;
                                for (const svc of classifiedServices) {
                                    const isApp = svc._class === 'application';
                                    const badgeColor = isApp ? 'var(--success)' : 'var(--text-muted)';
                                    const badgeIcon = isApp ? 'ğŸš€' : 'ğŸ—„ï¸';
                                    const badgeLabel = isApp ? 'application' : 'infrastructure';
                                    const portStr = svc.ports.length > 0
                                        ? svc.ports.map(p => `:${p.container}`).join(' ')
                                        : '';
                                    const imgStr = svc.image
                                        ? svc.image.split('/').pop().split(':')[0]
                                        : (svc.build ? 'builds locally' : 'â€”');

                                    html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.3rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                        <span style="width:18px;text-align:center">${badgeIcon}</span>
                                        <strong style="min-width:80px">${esc(svc.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(imgStr)}</code>
                                        ${portStr ? `<code style="font-size:0.68rem;color:var(--text-muted)">${esc(portStr)}</code>` : ''}
                                        <span style="flex:1"></span>
                                        ${Object.keys(svc.environment || {}).length > 0 ? `<span style="font-size:0.66rem;color:var(--text-muted)" title="${Object.keys(svc.environment).length} env vars">ğŸ”§${Object.keys(svc.environment).length}</span>` : ''}
                                        ${svc.volumes.length > 0 ? `<span style="font-size:0.66rem;color:var(--text-muted)" title="${svc.volumes.length} volumes">ğŸ’¾${svc.volumes.length}</span>` : ''}
                                        ${svc.healthcheck ? '<span style="font-size:0.66rem;color:var(--text-muted)" title="Has healthcheck">â¤ï¸</span>' : ''}
                                        <span style="font-size:0.68rem;color:${badgeColor}">${badgeLabel}</span>
                                    </div>`;
                                }
                                html += `</div>`;

                                if (appServices.length > 0) {
                                    html += `<div style="margin-top:0.5rem;font-size:0.78rem;color:var(--text-secondary)">
                                        ğŸ’¡ <strong>${appServices.length}</strong> application service${appServices.length !== 1 ? 's' : ''} will become K8s Deployments.
                                        ${infraServices.length > 0 ? `<strong>${infraServices.length}</strong> infrastructure service${infraServices.length !== 1 ? 's' : ''} â€” choose StatefulSet, managed, or skip.` : ''}
                                    </div>`;
                                }
                            } else if (deployableModules.length > 0) {
                                // No compose but we have modules
                                html += wizSection('Project Modules', `${deployableModules.length} deployable module${deployableModules.length !== 1 ? 's' : ''} detected.`);
                                html += `<div style="display:flex;flex-direction:column;gap:0.25rem">`;
                                for (const m of classifiedModules) {
                                    const isDep = m._class === 'deployable';
                                    const badgeColor = isDep ? 'var(--success)' : 'var(--text-muted)';
                                    const badgeIcon = isDep ? 'ğŸŸ¢' : m._class === 'library' ? 'ğŸ“š' : m._class === 'docs' ? 'ğŸ“' : 'âš™ï¸';
                                    html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.3rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                        <span style="width:18px;text-align:center">${badgeIcon}</span>
                                        <strong style="min-width:80px">${esc(m.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(m.stack || '?')}</code>
                                        <span style="flex:1;color:var(--text-muted);font-size:0.72rem">${esc(m.path || '')}</span>
                                        <span style="font-size:0.68rem;color:${badgeColor}">${m._class}</span>
                                    </div>`;
                                }
                                html += `</div>`;
                            }

                            // â”€â”€ Section 4: Image Registry Context â”€â”€
                            if (ghRepo.owner) {
                                html += wizSection('Registry Context', 'Container image naming from GitHub.');
                                html += `<div class="wiz-status-grid">
                                    ${wizStatusRow('ğŸ™', 'Repository', `${ghRepo.owner}/${ghRepo.name}`, 'ok')}
                                    ${wizStatusRow('ğŸ“¦', 'Registry', `ghcr.io/${ghRepo.owner}/${ghRepo.name}`, 'ok')}
                                </div>`;
                            }

                            // â”€â”€ Section 5: Environments â”€â”€
                            if (envs.length > 0) {
                                html += wizSection('Environments', `${envs.length} deployment environment${envs.length !== 1 ? 's' : ''} configured.`);
                                html += `<div style="display:flex;flex-wrap:wrap;gap:0.3rem">`;
                                for (const env of envs) {
                                    html += `<span style="display:inline-flex;align-items:center;gap:0.25rem;font-size:0.78rem;padding:0.2rem 0.5rem;border-radius:4px;background:var(--bg-inset);border:1px solid var(--border-subtle)">
                                        ${env.default ? 'â­' : 'ğŸ·ï¸'} ${esc(env.name)}
                                    </span>`;
                                }
                                html += `</div>`;
                            }

                            // â”€â”€ Cache and set HTML â”€â”€
                            const cacheData = {
                                _k8s: data._k8s,
                                _docker: data._docker,
                                _dockerStatus: data._dockerStatus,
                                _modules: data._modules,
                                _classifiedModules: data._classifiedModules,
                                _composeServices: data._composeServices,
                                _appServices: data._appServices,
                                _infraServices: data._infraServices,
                                _ghRepo: data._ghRepo,
                                _envs: data._envs,
                            };
                            wizStore(_CK, { h: html, d: cacheData }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>âš ï¸</span><span>${esc(e.message)}</span></div>`;
                        }
                    },
                },

                // â”€â”€ Step 2: Configure â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'config', title: 'Configure',
                    render: (data, el) => {
                        const projectName = (_wizardConfig && _wizardConfig.name) || 'app';
                        const appName = projectName.replace(/[^a-z0-9-]/gi, '-').toLowerCase();
                        const ghRepo = data._ghRepo || {};
                        const appSvcs = data._appServices || [];
                        const infraSvcs = data._infraServices || [];
                        const envs = data._envs || [];
                        const deployableModules = (data._classifiedModules || []).filter(m => m._class === 'deployable');
                        const hasCompose = appSvcs.length > 0 || infraSvcs.length > 0;

                        // Smart namespace default
                        const defaultNamespace = envs.find(e => e.default)
                            ? `${appName}-${envs.find(e => e.default).name}`
                            : 'default';

                        // â”€â”€ Mini label/input helpers (same pattern as Docker wizard) â”€â”€
                        const _lbl = (txt, sub) => `<label style="display:block;font-size:0.7rem;color:var(--text-muted);margin-bottom:2px">${txt}${sub ? ` <span style="font-size:0.62rem;opacity:0.7">(${sub})</span>` : ''}</label>`;
                        const _inp = (id, val, ph) => `<input type="text" id="${id}" class="modal-form-input" value="${esc(val || '')}" placeholder="${ph || ''}" style="font-size:0.76rem;padding:0.2rem 0.3rem">`;
                        const _num = (id, val) => `<input type="number" id="${id}" class="modal-form-input" value="${val}" style="font-size:0.76rem;padding:0.2rem 0.3rem;width:80px">`;
                        const _sel = (id, opts, selected) => `<select id="${id}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem">${opts.map(o => `<option value="${o.v}"${o.v === selected ? ' selected' : ''}>${o.l}</option>`).join('')}</select>`;
                        const _ta = (id, val, ph, rows) => `<textarea id="${id}" class="modal-form-input" rows="${rows || 2}" placeholder="${ph || ''}" style="font-size:0.72rem;padding:0.2rem 0.3rem;font-family:var(--font-mono,monospace);resize:vertical;min-height:38px">${esc(val || '')}</textarea>`;

                        // â”€â”€ Resource quantity validation helper â”€â”€
                        // K8s CPU: 100m, 0.5, 1, 1500m    Memory: 128Mi, 1Gi, 256M
                        const _isValidResQty = (v) => !v || /^\d+(\.\d+)?(m|Mi|Gi|Ki|Ti|M|G|K|T)?$/.test(v.trim());

                        // â”€â”€ QoS class helper â€” what K8s assigns based on resource config â”€â”€
                        // Guaranteed: every container has limits==requests for both CPU and memory
                        // Burstable:  at least one container has a request or limit set
                        // BestEffort: no limits or requests at all
                        const _qosHint = (cpuReq, cpuLim, memReq, memLim) => {
                            const hasAny = cpuReq || cpuLim || memReq || memLim;
                            if (!hasAny) return `<span style="color:var(--warning);font-size:0.64rem" title="No resource constraints â€” pod may be evicted first under pressure">âš ï¸ BestEffort</span>`;
                            const allSet = cpuReq && cpuLim && memReq && memLim;
                            const reqEqLim = allSet && cpuReq.trim() === cpuLim.trim() && memReq.trim() === memLim.trim();
                            if (reqEqLim) return `<span style="color:var(--success);font-size:0.64rem" title="Requests equal limits â€” highest priority, never throttled">âœ… Guaranteed</span>`;
                            return `<span style="color:var(--accent);font-size:0.64rem" title="Some constraints set â€” can burst above requests up to limits">âš¡ Burstable</span>`;
                        };

                        // â”€â”€ Compose duration parser: "30s" â†’ 30, "1m" â†’ 60 â”€â”€
                        const _parseDur = (s) => {
                            if (!s) return null;
                            const m = String(s).match(/^(\d+)(s|m|h)?$/);
                            if (!m) return null;
                            const v = parseInt(m[1]);
                            return m[2] === 'm' ? v * 60 : m[2] === 'h' ? v * 3600 : v;
                        };

                        // â”€â”€ Compose healthcheck â†’ K8s probe type/fields parser â”€â”€
                        // Detects: curl/wget â†’ HTTP, nc -z â†’ TCP, pg_isready/redis-cli/mysqladmin â†’ Exec
                        const _parseComposeProbe = (hc, svcPort) => {
                            if (!hc || !hc.test) return { type: 'http', path: '/health', port: svcPort, command: '' };
                            const test = typeof hc.test === 'string' ? hc.test
                                : Array.isArray(hc.test) ? hc.test.slice(1).join(' ') : String(hc.test);
                            // curl -f http://localhost:8080/health
                            const curlM = test.match(/curl\s+[^]*?https?:\/\/[^:/]+(:(\d+))?(\/\S*)?/i);
                            if (curlM) return { type: 'http', path: curlM[3] || '/health', port: parseInt(curlM[2]) || svcPort, command: '' };
                            // wget --spider http://localhost:3000/healthz
                            const wgetM = test.match(/wget\s+[^]*?https?:\/\/[^:/]+(:(\d+))?(\/\S*)?/i);
                            if (wgetM) return { type: 'http', path: wgetM[3] || '/health', port: parseInt(wgetM[2]) || svcPort, command: '' };
                            // nc -z localhost 5432
                            const ncM = test.match(/nc\s+-z\s+\S+\s+(\d+)/);
                            if (ncM) return { type: 'tcp', path: '', port: parseInt(ncM[1]) || svcPort, command: '' };
                            // DB/cache exec patterns
                            if (/pg_isready|mysqladmin\s+ping|redis-cli\s+ping|mongo.*--eval/.test(test))
                                return { type: 'exec', path: '', port: svcPort, command: test };
                            // Fallback: exec with raw command
                            return { type: 'exec', path: '', port: svcPort, command: test };
                        };

                        // â”€â”€ Probe HTML block generator â”€â”€
                        // Generates complete probe config UI with type-dependent field visibility
                        const _probeBlock = (prefix, label, probeType, path, port, command, delay, period, extra, extraLabel) => {
                            // onchange for type select: toggle path/port/command visibility
                            const typeOnchange = `var t=this.value;`
                                + `var p=document.getElementById('${prefix}-path-w');`
                                + `var pt=document.getElementById('${prefix}-port-w');`
                                + `var c=document.getElementById('${prefix}-cmd-w');`
                                + `if(p)p.style.display=t==='http'?'block':'none';`
                                + `if(pt)pt.style.display=t!=='exec'?'block':'none';`
                                + `if(c)c.style.display=t==='exec'?'block':'none'`;
                            // onchange for enable checkbox: toggle entire probe config
                            const enableOnchange = `var c=document.getElementById('${prefix}-cfg');if(c)c.style.display=this.checked?'block':'none'`;

                            return `<div style="padding:0.3rem 0">
                                <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.25rem">
                                    <label style="display:inline-flex;align-items:center;gap:0.25rem;cursor:pointer">
                                        <input type="checkbox" id="${prefix}-enable" checked style="accent-color:var(--accent);width:13px;height:13px"
                                            onchange="${enableOnchange}">
                                        <span style="font-weight:600;font-size:0.72rem;color:var(--text-primary)">${label}</span>
                                    </label>
                                    <select id="${prefix}-type" class="modal-form-select" style="font-size:0.72rem;padding:0.15rem 0.25rem"
                                        onchange="${typeOnchange}">
                                        <option value="http"${probeType === 'http' ? ' selected' : ''}>HTTP GET</option>
                                        <option value="tcp"${probeType === 'tcp' ? ' selected' : ''}>TCP Socket</option>
                                        <option value="exec"${probeType === 'exec' ? ' selected' : ''}>Exec</option>
                                    </select>
                                </div>
                                <div id="${prefix}-cfg">
                                    <div style="display:flex;gap:0.35rem;margin-bottom:0.2rem;flex-wrap:wrap">
                                        <div id="${prefix}-path-w" style="display:${probeType === 'http' ? 'block' : 'none'};min-width:130px;flex:2">
                                            ${_lbl('Path')}${_inp(`${prefix}-path`, path, '/health')}
                                        </div>
                                        <div id="${prefix}-port-w" style="display:${probeType !== 'exec' ? 'block' : 'none'};min-width:65px;flex:1">
                                            ${_lbl('Port')}${_num(`${prefix}-port`, port)}
                                        </div>
                                        <div id="${prefix}-cmd-w" style="display:${probeType === 'exec' ? 'block' : 'none'};flex:1;min-width:180px">
                                            ${_lbl('Command')}${_inp(`${prefix}-cmd`, command, 'pg_isready -U postgres')}
                                        </div>
                                    </div>
                                    <div style="display:flex;gap:0.35rem;flex-wrap:wrap">
                                        <div style="min-width:55px">
                                            ${_lbl('Delay', 's')}${_num(`${prefix}-delay`, delay)}
                                        </div>
                                        <div style="min-width:55px">
                                            ${_lbl('Period', 's')}${_num(`${prefix}-period`, period)}
                                        </div>
                                        <div style="min-width:55px">
                                            ${_lbl(extraLabel)}${_num(`${prefix}-extra`, extra)}
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        };

                        // â”€â”€ Secret key detection heuristic â”€â”€
                        // Mirrors _SECRET_PATTERNS from vault_env_ops.py / secrets_ops.py:
                        //   {"key", "secret", "token", "password", "passwd", "pass",
                        //    "credential", "auth", "api_key", "apikey", "private",
                        //    "jwt", "cert", "certificate", "signing"}
                        // Same algorithm: substring match on lowercased key name.
                        const _SECRET_PATTERNS = [
                            'key', 'secret', 'token', 'password', 'passwd', 'pass',
                            'credential', 'auth', 'api_key', 'apikey', 'private',
                            'jwt', 'cert', 'certificate', 'signing',
                        ];
                        const _isSecretKey = (key) => {
                            const lower = key.toLowerCase();
                            return _SECRET_PATTERNS.some(p => lower.includes(p));
                        };

                        // â”€â”€ Env var injection â€” multi-env awareness â”€â”€
                        const isMultiEnv = envs.length > 1;
                        const _ENV_DEPENDENT_KEYS = new Set([
                            'node_env', 'app_env', 'environment', 'env',
                            'log_level', 'debug', 'stage', 'deploy_env',
                        ]);
                        const _defaultInjType = (key) => {
                            if (_isSecretKey(key)) return 'secret';
                            if (isMultiEnv && _ENV_DEPENDENT_KEYS.has(key.toLowerCase())) return 'variable';
                            return 'hardcoded';
                        };

                        // â”€â”€ Build available vars/secrets from VAULT â”€â”€
                        const _vaultKeys = data._vaultKeys || [];
                        const _allEnvKeys = new Set();
                        const _availableVars = [];   // vault config keys
                        const _availableSecrets = []; // vault secret keys
                        _vaultKeys.forEach(vk => {
                            const k = vk.key;
                            if (_allEnvKeys.has(k)) return;
                            _allEnvKeys.add(k);
                            if (vk.kind === 'secret') _availableSecrets.push(k);
                            else _availableVars.push(k);
                        });
                        _availableVars.sort();
                        _availableSecrets.sort();

                        // â”€â”€ Collect compose-detected keys as default suggestions â”€â”€
                        const _composeKeys = new Set();
                        [...appSvcs, ...infraSvcs].forEach(svc => {
                            Object.keys(svc.environment || {}).forEach(k => _composeKeys.add(k));
                        });
                        const _suggestedKeys = [..._composeKeys].sort();

                        // â”€â”€ Build <option> HTML for the var/secret select â”€â”€
                        const _varSelectOpts = (injType, currentKey, currentVarName) => {
                            const dlr = '$';
                            const match = currentVarName || (dlr + '{' + currentKey + '}');
                            const shown = new Set();
                            let opts = '';
                            // Default: self-reference (always first)
                            if (currentKey) {
                                const selfVal = dlr + '{' + currentKey + '}';
                                opts += '<option value="' + esc(selfVal) + '"' + (match === selfVal ? ' selected' : '') + '>' + dlr + '{' + esc(currentKey) + '}</option>';
                                shown.add(currentKey);
                            }
                            // Suggested (from compose detection)
                            const suggested = _suggestedKeys.filter(k => !shown.has(k));
                            if (suggested.length > 0) {
                                opts += '<optgroup label="Suggested">';
                                suggested.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            // Vault Secrets
                            const secrets = _availableSecrets.filter(k => !shown.has(k));
                            if (secrets.length > 0) {
                                opts += '<optgroup label="Secrets">';
                                secrets.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            // Vault Variables
                            const vars = _availableVars.filter(k => !shown.has(k));
                            if (vars.length > 0) {
                                opts += '<optgroup label="Variables">';
                                vars.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            // Custom option
                            const stripped = match ? match.replace(/^\$\{|\}$/g, '') : '';
                            const isCustom = stripped && stripped !== currentKey && !_allEnvKeys.has(stripped);
                            opts += '<option value="__custom__"' + (isCustom ? ' selected' : '') + '>Custom...</option>';
                            return opts;
                        };

                        // â”€â”€ Per-variable row HTML builder â”€â”€
                        const _envRowHtml = (i, j, key, value, injType, varName) => {
                            const isSubst = injType !== 'hardcoded';
                            const isSec = injType === 'secret';
                            const dlr = '$';
                            const varN = varName || (isSubst ? dlr + '{' + key + '}' : '');
                            const isCustomVar = varN && key && varN !== (dlr + '{' + key + '}') && !_allEnvKeys.has(varN.replace(/^\$\{|\}$/g, ''));
                            const selKey = isSubst ? (varN.replace(/^\$\{/, '').replace(/\}$/, '') || key) : key;
                            const varMissing = isSubst && selKey && !_allEnvKeys.has(selKey);
                            return '<div class="k8s-env-row" style="margin-bottom:0.15rem">'
                                // â”€â”€ Grid row â”€â”€
                                + '<div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;align-items:center">'
                                + '<input type="text" id="k8s-svc-env-key-' + i + '-' + j + '" class="modal-form-input"'
                                + ' value="' + esc(key) + '" placeholder="KEY_NAME"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)">'
                                + '<input type="' + (isSec ? 'password' : 'text') + '" id="k8s-svc-env-val-' + i + '-' + j + '" class="modal-form-input"'
                                + ' value="' + esc(value) + '" placeholder="' + (isSec ? 'â€¢â€¢â€¢â€¢â€¢â€¢' : 'value') + '"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)"' + (isSubst ? ' hidden' : '') + '>'
                                + '<div id="k8s-svc-env-varbox-' + i + '-' + j + '"' + (isSubst ? '' : ' hidden') + '>'
                                +   '<select id="k8s-svc-env-var-' + i + '-' + j + '" class="modal-form-select" data-i="' + i + '" data-j="' + j + '"'
                                +   ' style="font-size:0.82rem;padding:0.25rem 0.35rem;color:var(--accent)"'
                                +   ' onchange="window._onVarSelect(this)">'
                                +   (isSubst ? _varSelectOpts(injType, key, varN) : '<option>--</option>')
                                +   '</select>'
                                +   '<input type="text" id="k8s-svc-env-varcustom-' + i + '-' + j + '" class="modal-form-input"'
                                +   ' value="' + (isCustomVar ? esc(varN) : '') + '" placeholder="' + dlr + '{MY_VAR}"'
                                +   ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace);color:var(--accent);margin-top:2px;display:' + (isCustomVar ? '' : 'none') + '">'
                                + '</div>'
                                + '<select id="k8s-svc-env-type-' + i + '-' + j + '" class="modal-form-select" data-i="' + i + '" data-j="' + j + '"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem"'
                                + ' onchange="((sel)=>{'
                                +   'var si=sel.dataset.i,sj=sel.dataset.j;'
                                +   'var vb=document.getElementById(\'k8s-svc-env-varbox-\'+si+\'-\'+sj);'
                                +   'var ve=document.getElementById(\'k8s-svc-env-val-\'+si+\'-\'+sj);'
                                +   'var vs=document.getElementById(\'k8s-svc-env-var-\'+si+\'-\'+sj);'
                                +   'var isSub=sel.value!==\'hardcoded\';'
                                +   'if(vb)vb.hidden=!isSub;'
                                +   'if(ve)ve.hidden=isSub;'
                                +   'if(vs&&isSub){vs.innerHTML=window._varSelectOpts(sel.value,document.getElementById(\'k8s-svc-env-key-\'+si+\'-\'+sj).value,\'\');window._onVarSelect(vs);}'
                                +   'if(typeof _updateEnvSummary===\'function\')_updateEnvSummary(si);'
                                + '})(this)">'
                                + '<option value="hardcoded"' + (injType === 'hardcoded' ? ' selected' : '') + '>ğŸ“‹ Hardcoded</option>'
                                + '<option value="variable"' + (injType === 'variable' ? ' selected' : '') + '>ğŸ”„ Variable</option>'
                                + '<option value="secret"' + (injType === 'secret' ? ' selected' : '') + '>ğŸ”’ Secret</option>'
                                + '</select>'
                                + '<button type="button" onclick="this.closest(\'.k8s-env-row\').remove();if(typeof _updateEnvSummary===\'function\')_updateEnvSummary(' + i + ')"'
                                + ' style="background:none;border:none;cursor:pointer;font-size:0.82rem;color:var(--text-muted);padding:0 2px"'
                                + ' title="Remove variable">âœ•</button>'
                                + '</div>'
                                // â”€â”€ Notice (below the grid, outside it) â”€â”€
                                + '<div id="k8s-svc-env-notice-' + i + '-' + j + '"' + (varMissing ? '' : ' hidden')
                                + ' style="font-size:0.78rem;color:var(--warning,#e8a820);margin:2px 0 4px;padding:4px 6px;border-radius:4px;background:rgba(232,168,32,0.06);border:1px solid rgba(232,168,32,0.15)">'
                                +   '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">'
                                +     '<span>\u26a0\ufe0f <strong id="k8s-svc-env-notice-name-' + i + '-' + j + '">' + esc(selKey) + '</strong> does not exist yet</span>'
                                +     '<label style="display:flex;align-items:center;gap:3px;cursor:pointer">'
                                +       '<input type="checkbox" id="k8s-svc-env-create-' + i + '-' + j + '" checked style="margin:0">'
                                +       '<span>Create on execution</span>'
                                +     '</label>'
                                +   '</div>'
                                +   '<div style="display:flex;align-items:center;gap:4px;margin-top:3px">'
                                +     '<input type="text" id="k8s-svc-env-newval-' + i + '-' + j + '" class="modal-form-input"'
                                +     ' placeholder="value (leave empty or generate)" style="flex:1;font-size:0.78rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)">'
                                +     '<button type="button" onclick="window._generateVarValue(this)" data-i="' + i + '" data-j="' + j + '"'
                                +     ' style="font-size:0.78rem;padding:0.25rem 0.5rem;border:1px solid var(--border-subtle);border-radius:3px;background:var(--bg-card);cursor:pointer;white-space:nowrap"'
                                +     ' title="Generate a random value">ğŸ² Generate</button>'
                                +   '</div>'
                                + '</div>'
                                + '</div>';
                        };

                        // Expose for dynamic onchange use
                        window._varSelectOpts = _varSelectOpts;
                        window._allEnvKeysSet = _allEnvKeys;

                        // â”€â”€ Var select onchange: check existence, show notice â”€â”€
                        window._onVarSelect = (sel) => {
                            const ci = sel.dataset.i, cj = sel.dataset.j;
                            const tb = document.getElementById('k8s-svc-env-varcustom-' + ci + '-' + cj);
                            const nt = document.getElementById('k8s-svc-env-notice-' + ci + '-' + cj);
                            if (sel.value === '__custom__') {
                                if (tb) tb.style.display = '';
                                if (nt) nt.hidden = true;
                            } else {
                                if (tb) tb.style.display = 'none';
                                if (nt) {
                                    const varKey = sel.value.replace(/^\$\{/, '').replace(/\}$/, '');
                                    const exists = _allEnvKeys.has(varKey);
                                    nt.hidden = exists;
                                    // Update name in the notice
                                    const nameEl = document.getElementById('k8s-svc-env-notice-name-' + ci + '-' + cj);
                                    if (nameEl) nameEl.textContent = varKey;
                                }
                            }
                        };

                        // â”€â”€ Generate random value for the notice input â”€â”€
                        window._generateVarValue = (btn) => {
                            const ci = btn.dataset.i, cj = btn.dataset.j;
                            const inp = document.getElementById('k8s-svc-env-newval-' + ci + '-' + cj);
                            if (!inp) return;
                            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#%&*';
                            let val = '';
                            for (let n = 0; n < 32; n++) val += chars[Math.floor(Math.random() * chars.length)];
                            inp.value = val;
                        };

                        // â”€â”€ Add variable button handler â”€â”€
                        window._addEnvVar = (i) => {
                            const list = document.getElementById('k8s-svc-env-list-' + i);
                            if (!list) return;
                            const j = list.querySelectorAll('.k8s-env-row').length;
                            const row = document.createElement('div');
                            row.innerHTML = _envRowHtml(i, j, '', '', 'hardcoded', '');
                            list.appendChild(row.firstElementChild);
                            _updateEnvSummary(i);
                        };

                        // â”€â”€ Live summary updater â”€â”€
                        window._updateEnvSummary = (i) => {
                            const sumEl = document.getElementById('k8s-svc-env-summary-' + i);
                            if (!sumEl) return;
                            const list = document.getElementById('k8s-svc-env-list-' + i);
                            if (!list) return;
                            let hc = 0, vr = 0, sc = 0;
                            list.querySelectorAll('.k8s-env-row').forEach((row, j) => {
                                const sel = document.getElementById('k8s-svc-env-type-' + i + '-' + j);
                                const key = document.getElementById('k8s-svc-env-key-' + i + '-' + j);
                                if (!sel || !key || !key.value.trim()) return;
                                if (sel.value === 'secret') sc++;
                                else if (sel.value === 'variable') vr++;
                                else hc++;
                            });
                            const dlr = '$';
                            const parts = [];
                            if (hc + vr > 0) parts.push('ğŸ“‹ ConfigMap: ' + hc + ' hardcoded' + (vr > 0 ? ', ' + vr + ' ' + dlr + '{VAR}' : ''));
                            if (sc > 0) parts.push('ğŸ”’ Secret: ' + sc + ' key' + (sc !== 1 ? 's' : '') + ' (' + dlr + '{VAR} at deploy)');
                            if (parts.length === 0) parts.push('No environment variables configured');
                            sumEl.innerHTML = parts.join(' &nbsp;\u00b7&nbsp; ');
                        };

                        // â”€â”€ Collect env vars from per-variable rows â”€â”€
                        window._collectEnvVars = (i) => {
                            const list = document.getElementById('k8s-svc-env-list-' + i);
                            if (!list) return [];
                            const vars = [];
                            list.querySelectorAll('.k8s-env-row').forEach((row, j) => {
                                const key = (document.getElementById('k8s-svc-env-key-' + i + '-' + j) || {}).value || '';
                                if (!key.trim()) return;
                                const type = (document.getElementById('k8s-svc-env-type-' + i + '-' + j) || {}).value || 'hardcoded';
                                const value = (document.getElementById('k8s-svc-env-val-' + i + '-' + j) || {}).value || '';
                                const varSel = document.getElementById('k8s-svc-env-var-' + i + '-' + j);
                                const varCustom = document.getElementById('k8s-svc-env-varcustom-' + i + '-' + j);
                                let varName = null;
                                if (type !== 'hardcoded') {
                                    if (varSel && varSel.value === '__custom__' && varCustom && varCustom.value.trim()) {
                                        varName = varCustom.value.trim();
                                    } else if (varSel && varSel.value && varSel.value !== '__custom__') {
                                        varName = varSel.value;
                                    } else {
                                        varName = '${' + key.trim() + '}';
                                    }
                                }
                                // Check if "Create on execution" is checked + new value
                                const createChk = document.getElementById('k8s-svc-env-create-' + i + '-' + j);
                                const newValInp = document.getElementById('k8s-svc-env-newval-' + i + '-' + j);
                                const notice = document.getElementById('k8s-svc-env-notice-' + i + '-' + j);
                                const createInVault = notice && !notice.hidden && createChk && createChk.checked;
                                const newValue = createInVault && newValInp ? newValInp.value.trim() : '';
                                vars.push({ key: key.trim(), type, value: value.trim(), varName, createInVault: !!createInVault, newValue });
                            });
                            return vars;
                        };
                        const _collectEnvVars = window._collectEnvVars;

                        let html = '';

                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // â”€â”€ Section A: Application Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                        if (hasCompose && appSvcs.length > 0) {
                            html += wizSection('Application Deployments',
                                `${appSvcs.length} service${appSvcs.length !== 1 ? 's' : ''} from Docker Compose. Select which to deploy and configure each.`);

                            html += `<div style="display:flex;flex-direction:column;gap:0.5rem" id="k8s-app-svc-list">`;
                            for (let i = 0; i < appSvcs.length; i++) {
                                const svc = appSvcs[i];
                                const imgStr = svc._image || `${svc.name}:latest`;
                                const portVal = svc._port || 8080;
                                const envKeys = Object.keys(svc.environment || {});
                                const envVals = svc.environment || {};
                                const volCount = (svc.volumes || []).length;
                                const hc = svc.healthcheck;
                                const dp = svc.deploy;  // {replicas, cpu_limit, memory_limit, cpu_request, memory_request} | null
                                const hasDeps = (svc.depends_on || []).length > 0;

                                // Detect named volumes (not bind mounts) â€” suggests Recreate strategy
                                // Named volumes: "vol-name:/path" (no slash/dot in source)
                                // Bind mounts: "./src:/app" or "/host/path:/container" (has path separator in source)
                                const hasNamedVols = (svc.volumes || []).some(v => {
                                    const src = v.split(':')[0];
                                    return src && !src.includes('/') && !src.startsWith('.');
                                });
                                const defaultStrategy = hasNamedVols ? 'Recreate' : 'RollingUpdate';

                                // Pre-compute compose-sourced resource defaults
                                const compCpuReq = (dp && dp.cpu_request) || '';
                                const compCpuLim = (dp && dp.cpu_limit) || '';
                                const compMemReq = (dp && dp.memory_request) || '';
                                const compMemLim = (dp && dp.memory_limit) || '';
                                const hasComposeRes = compCpuReq || compCpuLim || compMemReq || compMemLim;

                                html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);overflow:hidden" id="k8s-svc-card-${i}">
                                    <label style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.6rem;cursor:pointer;font-size:0.82rem"
                                        onmouseover="this.parentElement.style.borderColor='var(--accent)'" onmouseout="this.parentElement.style.borderColor='var(--border-subtle)'">
                                        <input type="checkbox" id="k8s-svc-chk-${i}" checked style="accent-color:var(--accent)"
                                            onchange="document.getElementById('k8s-svc-cfg-${i}').style.display=this.checked?'block':'none'">
                                        <span style="font-size:1rem">ğŸš€</span>
                                        <strong>${esc(svc.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(svc.image ? svc.image.split('/').pop().split(':')[0] : 'local build')}</code>
                                        <span style="flex:1"></span>
                                        ${portVal ? `<code style="font-size:0.68rem;color:var(--text-muted)">:${portVal}</code>` : ''}
                                        <span style="font-size:0.68rem;color:var(--success)">Deployment</span>
                                    </label>
                                    <div id="k8s-svc-cfg-${i}" style="padding:0 0.6rem 0.5rem;display:block">
                                        <!-- â”€â”€â”€ Primary settings row â”€â”€â”€ -->
                                        <div style="display:grid;grid-template-columns:3fr 1fr 1fr 1fr;gap:0.4rem;align-items:start">
                                            <div>${_lbl('Container Image')}${_inp(`k8s-svc-img-${i}`, imgStr, 'ghcr.io/user/app:latest')}</div>
                                            <div>${_lbl('Port')}${_num(`k8s-svc-port-${i}`, portVal)}</div>
                                            <div>${_lbl('Replicas')}${_num(`k8s-svc-replicas-${i}`, dp && dp.replicas ? dp.replicas : 2)}</div>
                                            <div>${_lbl('Service Type')}${_sel(`k8s-svc-type-${i}`, [
                                                {v:'ClusterIP', l:'ClusterIP'},
                                                {v:'NodePort', l:'NodePort'},
                                                {v:'LoadBalancer', l:'LoadBalancer'}
                                            ], 'ClusterIP')}</div>
                                        </div>

                                        <!-- â”€â”€â”€ Update Strategy â”€â”€â”€ -->
                                        <div style="display:flex;align-items:end;gap:0.4rem;margin-top:0.35rem;flex-wrap:wrap">
                                            <div style="min-width:140px">
                                                ${_lbl('Update Strategy')}
                                                <select id="k8s-svc-strategy-${i}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem;width:100%"
                                                    onchange="var r=document.getElementById('k8s-svc-rolling-${i}');var h=document.getElementById('k8s-svc-strat-hint-${i}');if(r)r.style.display=this.value==='RollingUpdate'?'flex':'none';if(h)h.style.display=this.value==='Recreate'?'block':'none'">
                                                    <option value="RollingUpdate"${defaultStrategy === 'RollingUpdate' ? ' selected' : ''}>RollingUpdate</option>
                                                    <option value="Recreate"${defaultStrategy === 'Recreate' ? ' selected' : ''}>Recreate</option>
                                                </select>
                                            </div>
                                            <div id="k8s-svc-rolling-${i}" style="display:${defaultStrategy === 'RollingUpdate' ? 'flex' : 'none'};align-items:end;gap:0.4rem">
                                                <div style="min-width:80px">
                                                    ${_lbl('Max Surge')}
                                                    ${_inp(`k8s-svc-maxsurge-${i}`, '1', '1')}
                                                </div>
                                                <div style="min-width:80px">
                                                    ${_lbl('Max Unavailable')}
                                                    ${_inp(`k8s-svc-maxunavail-${i}`, '1', '1')}
                                                </div>
                                            </div>
                                            <div id="k8s-svc-strat-hint-${i}" style="display:${defaultStrategy === 'Recreate' ? 'block' : 'none'};font-size:0.62rem;color:var(--text-muted);font-style:italic;padding-bottom:0.1rem">
                                                ${hasNamedVols
                                                    ? 'ğŸ’¡ Recreate recommended â€” named volumes with ReadWriteOnce PVCs prevent two pods mounting simultaneously during rollout'
                                                    : 'ğŸ’¡ Kills all pods before creating new ones â€” causes brief downtime but avoids version conflicts'
                                                }
                                            </div>
                                        </div>

                                        <!-- â”€â”€â”€ 1. Resource Limits â”€â”€â”€ -->
                                        <details style="margin-top:0.4rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                â–¸ Resource Limits
                                                ${hasComposeRes ? '<span style="font-size:0.6rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">from Compose</span>' : ''}
                                                <span id="k8s-svc-qos-${i}" style="margin-left:auto">${_qosHint(compCpuReq, compCpuLim, compMemReq, compMemLim)}</span>
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="display:grid;grid-template-columns:auto 1fr 1fr;gap:0.3rem 0.5rem;align-items:center;font-size:0.74rem">
                                                    <!-- Header row -->
                                                    <div></div>
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.66rem;text-transform:uppercase;letter-spacing:0.04em">Request <span style="font-size:0.58rem;opacity:0.7">(guaranteed minimum)</span></div>
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.66rem;text-transform:uppercase;letter-spacing:0.04em">Limit <span style="font-size:0.58rem;opacity:0.7">(hard ceiling)</span></div>
                                                    <!-- CPU row -->
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.72rem">CPU</div>
                                                    <div>${_inp(`k8s-svc-cpu-req-${i}`, compCpuReq, '100m')}</div>
                                                    <div>${_inp(`k8s-svc-cpu-lim-${i}`, compCpuLim, '500m')}</div>
                                                    <!-- Memory row -->
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.72rem">Memory</div>
                                                    <div>${_inp(`k8s-svc-mem-req-${i}`, compMemReq, '128Mi')}</div>
                                                    <div>${_inp(`k8s-svc-mem-lim-${i}`, compMemLim, '256Mi')}</div>
                                                </div>
                                                <!-- Live QoS class + guidance -->
                                                <div style="display:flex;align-items:center;gap:0.5rem;margin-top:0.35rem;padding-top:0.3rem;border-top:1px solid var(--border-subtle)">
                                                    <span style="font-size:0.66rem;color:var(--text-muted)">QoS class â†’</span>
                                                    <span id="k8s-svc-qos-live-${i}">${_qosHint(compCpuReq, compCpuLim, compMemReq, compMemLim)}</span>
                                                    <span style="flex:1"></span>
                                                    <span style="font-size:0.6rem;color:var(--text-muted);font-style:italic">Empty = omit from manifest (K8s node defaults apply)</span>
                                                </div>
                                            </div>
                                        </details>

                                        <!-- â”€â”€â”€ 2. Health Checks â”€â”€â”€ -->
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                â–¸ Health Checks
                                                ${hc ? '<span style="font-size:0.6rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">from Compose</span>' : ''}
                                                <span style="margin-left:auto;font-size:0.6rem;color:var(--text-muted)">recommended</span>
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                ${(() => {
                                                    const parsed = _parseComposeProbe(hc, portVal);
                                                    const prd = _parseDur(hc && hc.interval);
                                                    const pto = _parseDur(hc && hc.timeout);
                                                    const pret = hc && hc.retries ? parseInt(hc.retries) : null;
                                                    // Readiness defaults: fast startup, frequent checks
                                                    const rdy = _probeBlock(
                                                        `k8s-svc-rdy-${i}`, 'Readiness Probe',
                                                        parsed.type, parsed.path, parsed.port, parsed.command,
                                                        5, prd || 5, pto || 3, 'Timeout (s)'
                                                    );
                                                    // Liveness defaults: slower startup tolerance, less frequent
                                                    const liv = _probeBlock(
                                                        `k8s-svc-liv-${i}`, 'Liveness Probe',
                                                        parsed.type, parsed.path, parsed.port, parsed.command,
                                                        10, prd || 15, pret || 3, 'Failures'
                                                    );
                                                    return rdy + `<div style="border-top:1px solid var(--border-subtle);margin:0.15rem 0"></div>` + liv;
                                                })()}
                                                ${hc ? `<div style="font-size:0.62rem;color:var(--text-muted);border-top:1px solid var(--border-subtle);padding-top:0.25rem;margin-top:0.2rem">
                                                    ğŸ’¡ Parsed from: <code style="font-size:0.6rem;background:var(--bg-inset);padding:1px 4px;border-radius:3px">${esc(typeof hc.test === 'string' ? hc.test : Array.isArray(hc.test) ? hc.test.join(' ') : String(hc.test))}</code>
                                                </div>` : `<div style="font-size:0.62rem;color:var(--text-muted);font-style:italic;margin-top:0.15rem">
                                                    ğŸ’¡ No compose healthcheck â€” defaults pre-filled. Uncheck to omit probes.
                                                </div>`}
                                            </div>
                                        </details>

                                        <!-- â”€â”€â”€ 3. Environment Variables â”€â”€â”€ -->
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                â–¸ Environment Variables
                                                ${envKeys.length > 0 ? `<span style="font-size:0.72rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">${envKeys.length} from Compose</span>` : ''}
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                ${isMultiEnv ? `<div style="font-size:0.78rem;color:var(--warning);background:color-mix(in srgb, var(--warning) 8%, transparent);padding:0.3rem 0.4rem;border-radius:4px;margin-bottom:0.35rem;display:flex;align-items:center;gap:0.3rem">
                                                    <span>ğŸ“Œ</span>
                                                    <span>Multi-env project: values shown are defaults. Use <strong>Variable | Secret</strong> for values that differ across environments.</span>
                                                </div>` : ''}
                                                ${envKeys.length > 0 ? `<div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;margin-bottom:0.2rem;padding:0 0.25rem">
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Key</span>
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Value</span>
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Var / Secret</span>
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Injection</span>
                                                    <span></span>
                                                </div>` : ''}
                                                <div id="k8s-svc-env-list-${i}" style="display:flex;flex-direction:column;gap:0.2rem">
                                                    ${Object.entries(envVals).map(([k, v], j) => {
                                                        const injType = _defaultInjType(k);
                                                        return _envRowHtml(i, j, k, v || '', injType, injType !== 'hardcoded' ? '${' + k + '}' : '');
                                                    }).join('')}
                                                </div>
                                                <button type="button" onclick="_addEnvVar(${i})"
                                                    style="margin-top:0.3rem;font-size:0.66rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.2rem 0.5rem;cursor:pointer;width:100%">
                                                    + Add variable
                                                </button>
                                                <div id="k8s-svc-env-summary-${i}" style="font-size:0.6rem;color:var(--text-muted);margin-top:0.25rem;padding-top:0.2rem;border-top:1px solid var(--border-subtle)">
                                                    ${(() => {
                                                        let hc = 0, vr = 0, sc = 0;
                                                        for (const k of envKeys) {
                                                            const t = _defaultInjType(k);
                                                            if (t === 'secret') sc++;
                                                            else if (t === 'variable') vr++;
                                                            else hc++;
                                                        }
                                                        const dlr = '$';
                                                        const parts = [];
                                                        if (hc + vr > 0) parts.push('ğŸ“‹ ConfigMap: ' + hc + ' hardcoded' + (vr > 0 ? ', ' + vr + ' ' + dlr + '{VAR}' : ''));
                                                        if (sc > 0) parts.push('ğŸ”’ Secret: ' + sc + ' key' + (sc !== 1 ? 's' : '') + ' (' + dlr + '{VAR} at deploy)');
                                                        if (parts.length === 0) parts.push('No environment variables configured');
                                                        return parts.join(' &middot; ');
                                                    })()}
                                                </div>
                                            </div>
                                        </details>

                                        <!-- â”€â”€â”€ 4. Volumes (coming soon â€” read-only for now) â”€â”€â”€ -->
                                        ${volCount > 0 ? `<details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                â–¸ Volume Mounts
                                                <span style="font-size:0.6rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">${volCount} from Compose</span>
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.35rem 0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="display:flex;flex-direction:column;gap:0.15rem">
                                                    ${svc.volumes.map(v => `<code style="font-size:0.66rem;color:var(--text-muted);font-family:var(--font-mono,monospace)">${esc(v)}</code>`).join('')}
                                                </div>
                                                <div style="font-size:0.62rem;color:var(--text-muted);font-style:italic;margin-top:0.25rem">ğŸ’¡ Editable volume mount config with PVC type selection coming in next update</div>
                                            </div>
                                        </details>` : ''}

                                        <!-- â”€â”€â”€ 5. Dependencies (informational) â”€â”€â”€ -->
                                        ${hasDeps ? `<div style="margin-top:0.3rem;padding:0.2rem 0;font-size:0.68rem;color:var(--text-muted)">
                                            Depends on: ${svc.depends_on.map(d => `<code style="font-size:0.64rem;padding:1px 4px;background:var(--bg-primary);border-radius:3px">${esc(d)}</code>`).join(' ')}
                                        </div>` : ''}
                                    </div>
                                </div>`;
                            }
                            html += `</div>`;

                        } else if (deployableModules.length > 0) {
                            // No Compose â€” show module-based cards
                            html += wizSection('Application Deployments',
                                `${deployableModules.length} module${deployableModules.length !== 1 ? 's' : ''} detected. Select which to deploy.`);

                            html += `<div style="display:flex;flex-direction:column;gap:0.5rem" id="k8s-app-svc-list">`;
                            for (let i = 0; i < deployableModules.length; i++) {
                                const m = deployableModules[i];
                                const imgStr = ghRepo.owner
                                    ? `ghcr.io/${ghRepo.owner}/${ghRepo.name}-${m.name}:latest`
                                    : `${m.name}:latest`;
                                html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);overflow:hidden" id="k8s-svc-card-${i}">
                                    <label style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.6rem;cursor:pointer;font-size:0.82rem"
                                        onmouseover="this.parentElement.style.borderColor='var(--accent)'" onmouseout="this.parentElement.style.borderColor='var(--border-subtle)'">
                                        <input type="checkbox" id="k8s-svc-chk-${i}" ${i === 0 ? 'checked' : ''} style="accent-color:var(--accent)"
                                            onchange="document.getElementById('k8s-svc-cfg-${i}').style.display=this.checked?'block':'none'">
                                        <span style="font-size:1rem">ğŸŸ¢</span>
                                        <strong>${esc(m.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(m.stack || '?')}</code>
                                        <span style="flex:1;color:var(--text-muted);font-size:0.72rem">${esc(m.path || '')}</span>
                                        <span style="font-size:0.68rem;color:var(--success)">Deployment</span>
                                    </label>
                                    <div id="k8s-svc-cfg-${i}" style="padding:0 0.6rem 0.5rem;display:${i === 0 ? 'block' : 'none'}">
                                        <div style="display:grid;grid-template-columns:3fr 1fr 1fr 1fr;gap:0.4rem;align-items:start">
                                            <div>${_lbl('Container Image')}${_inp(`k8s-svc-img-${i}`, imgStr, 'ghcr.io/user/app:latest')}</div>
                                            <div>${_lbl('Port')}${_num(`k8s-svc-port-${i}`, 8080)}</div>
                                            <div>${_lbl('Replicas')}${_num(`k8s-svc-replicas-${i}`, 2)}</div>
                                            <div>${_lbl('Service Type')}${_sel(`k8s-svc-type-${i}`, [
                                                {v:'ClusterIP', l:'ClusterIP'},
                                                {v:'NodePort', l:'NodePort'},
                                                {v:'LoadBalancer', l:'LoadBalancer'}
                                            ], 'ClusterIP')}</div>
                                        </div>
                                    </div>
                                </div>`;
                            }
                            html += `</div>`;

                        } else {
                            // No compose, no modules â€” single manual app config
                            html += wizSection('Deployment Configuration', 'Configure your application for Kubernetes.');
                            html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);padding:0.6rem">
                                <div style="display:grid;grid-template-columns:1fr 3fr;gap:0.4rem;align-items:start">
                                    <div>${_lbl('App Name')}${_inp('k8s-svc-name-manual', appName, 'my-app')}</div>
                                    <div>${_lbl('Container Image')}${_inp('k8s-svc-img-manual', `${appName}:latest`, 'ghcr.io/user/app:latest')}</div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr 2fr;gap:0.4rem;margin-top:0.3rem;align-items:start">
                                    <div>${_lbl('Port')}${_num('k8s-svc-port-manual', 8080)}</div>
                                    <div>${_lbl('Replicas')}${_num('k8s-svc-replicas-manual', 2)}</div>
                                    <div>${_lbl('Service Type')}${_sel('k8s-svc-type-manual', [
                                        {v:'ClusterIP', l:'ClusterIP (internal)'},
                                        {v:'NodePort', l:'NodePort (node access)'},
                                        {v:'LoadBalancer', l:'LoadBalancer (external)'}
                                    ], 'ClusterIP')}</div>
                                </div>
                            </div>`;
                        }

                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // â”€â”€ Section B: Infrastructure Services â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                        if (infraSvcs.length > 0) {
                            html += wizSection('Infrastructure Services',
                                `${infraSvcs.length} infrastructure service${infraSvcs.length !== 1 ? 's' : ''} detected. Choose how to handle each in K8s.`);

                            html += `<div style="display:flex;flex-direction:column;gap:0.4rem" id="k8s-infra-list">`;
                            for (let i = 0; i < infraSvcs.length; i++) {
                                const svc = infraSvcs[i];
                                const imgShort = (svc.image || '').split('/').pop().split(':')[0] || svc.name;
                                const portStr = (svc.ports || []).map(p => `:${p.container}`).join(' ');
                                const volCount = (svc.volumes || []).length;

                                html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);padding:0.5rem 0.6rem">
                                    <div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;margin-bottom:0.3rem">
                                        <span style="font-size:1rem">ğŸ—„ï¸</span>
                                        <strong>${esc(svc.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(imgShort)}</code>
                                        ${portStr ? `<code style="font-size:0.68rem;color:var(--text-muted)">${esc(portStr)}</code>` : ''}
                                        ${volCount > 0 ? `<span style="font-size:0.66rem;color:var(--text-muted)" title="${volCount} volumes">ğŸ’¾${volCount}</span>` : ''}
                                        <span style="flex:1"></span>
                                    </div>
                                    <div style="display:flex;gap:0.6rem;font-size:0.74rem" id="k8s-infra-radios-${i}">
                                        <label style="display:inline-flex;align-items:center;gap:0.2rem;cursor:pointer">
                                            <input type="radio" name="k8s-infra-${i}" value="statefulset" style="accent-color:var(--accent)"> StatefulSet
                                        </label>
                                        <label style="display:inline-flex;align-items:center;gap:0.2rem;cursor:pointer">
                                            <input type="radio" name="k8s-infra-${i}" value="managed" style="accent-color:var(--accent)"> Managed (external)
                                        </label>
                                        <label style="display:inline-flex;align-items:center;gap:0.2rem;cursor:pointer">
                                            <input type="radio" name="k8s-infra-${i}" value="skip" checked style="accent-color:var(--accent)"> Skip
                                        </label>
                                    </div>
                                </div>`;
                            }
                            html += `</div>`;
                        }

                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                        // â”€â”€ Section C: Cluster Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

                        html += wizSection('Cluster Settings', 'Common settings for all K8s resources.');
                        html += wizFormGrid([
                            { name: 'k8s-namespace', label: 'Namespace', value: data.namespace || defaultNamespace, hint: 'Target K8s namespace for all resources' },
                            { name: 'k8s-output-dir', label: 'Output Directory', value: 'k8s/', hint: 'Where manifest files will be written' },
                        ]);
                        html += wizFormGrid([
                            { name: 'k8s-ingress', label: 'Generate Ingress manifest', type: 'checkbox', value: false, fullWidth: true },
                            // ConfigMap checkbox removed â€” ConfigMaps/Secrets auto-generated per service from envVars
                        ]);

                        // Store source list sizes for collect()
                        data._appSvcCount = hasCompose ? appSvcs.length : deployableModules.length;
                        data._infraSvcCount = infraSvcs.length;
                        data._configMode = hasCompose ? 'compose' : (deployableModules.length > 0 ? 'modules' : 'manual');

                        el.innerHTML = html;

                        // â”€â”€ Post-render: attach live QoS class updaters â”€â”€
                        // For each app service card, listen for input changes on resource fields
                        // and recalculate the QoS class indicator in real-time
                        const svcCount = hasCompose ? appSvcs.length : deployableModules.length;
                        for (let idx = 0; idx < svcCount; idx++) {
                            const ids = ['cpu-req', 'cpu-lim', 'mem-req', 'mem-lim'].map(f => `k8s-svc-${f}-${idx}`);
                            const els = ids.map(id => document.getElementById(id));
                            if (!els.some(Boolean)) continue;

                            const updateQoS = () => {
                                const cr = (els[0] && els[0].value.trim()) || '';
                                const cl = (els[1] && els[1].value.trim()) || '';
                                const mr = (els[2] && els[2].value.trim()) || '';
                                const ml = (els[3] && els[3].value.trim()) || '';
                                const hint = _qosHint(cr, cl, mr, ml);
                                // Update both the summary-bar QoS and the live QoS inside the panel
                                const qosSummary = document.getElementById(`k8s-svc-qos-${idx}`);
                                const qosLive = document.getElementById(`k8s-svc-qos-live-${idx}`);
                                if (qosSummary) qosSummary.innerHTML = hint;
                                if (qosLive) qosLive.innerHTML = hint;
                            };

                            els.forEach(el => { if (el) el.addEventListener('input', updateQoS); });
                        }
                    },
                    collect: (data) => {
                        const mode = data._configMode || 'manual';
                        const appCount = data._appSvcCount || 0;
                        const infraCount = data._infraSvcCount || 0;
                        const appSvcs = data._appServices || [];
                        const infraSvcs = data._infraServices || [];
                        const deployableModules = (data._classifiedModules || []).filter(m => m._class === 'deployable');

                        // â”€â”€ Collect application services â”€â”€
                        const services = [];
                        // â”€â”€ Helper: read element value safely â”€â”€
                        const _v = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };

                        if (mode === 'compose') {
                            for (let i = 0; i < appCount; i++) {
                                const chk = document.getElementById(`k8s-svc-chk-${i}`);
                                if (!chk || !chk.checked) continue;

                                // Resource limits â€” only include non-empty values
                                const cpuReq = _v(`k8s-svc-cpu-req-${i}`);
                                const cpuLim = _v(`k8s-svc-cpu-lim-${i}`);
                                const memReq = _v(`k8s-svc-mem-req-${i}`);
                                const memLim = _v(`k8s-svc-mem-lim-${i}`);
                                const hasResources = cpuReq || cpuLim || memReq || memLim;

                                // Strategy
                                const strategy = _v(`k8s-svc-strategy-${i}`) || 'RollingUpdate';

                                // Probe collection helper
                                const _collectProbe = (prefix) => {
                                    const enableEl = document.getElementById(`${prefix}-enable`);
                                    if (!enableEl || !enableEl.checked) return null;
                                    const probeType = _v(`${prefix}-type`) || 'http';
                                    const probe = {
                                        type: probeType,
                                        initialDelaySeconds: parseInt(_v(`${prefix}-delay`)) || 0,
                                        periodSeconds: parseInt(_v(`${prefix}-period`)) || 10,
                                    };
                                    if (probeType === 'http') {
                                        probe.path = _v(`${prefix}-path`) || '/health';
                                        probe.port = parseInt(_v(`${prefix}-port`)) || 8080;
                                    } else if (probeType === 'tcp') {
                                        probe.port = parseInt(_v(`${prefix}-port`)) || 8080;
                                    } else {
                                        probe.command = _v(`${prefix}-cmd`) || '';
                                    }
                                    probe.extra = parseInt(_v(`${prefix}-extra`)) || 3;
                                    return probe;
                                };

                                services.push({
                                    name: appSvcs[i].name,
                                    kind: 'Deployment',
                                    image: _v(`k8s-svc-img-${i}`) || `${appSvcs[i].name}:latest`,
                                    port: _v(`k8s-svc-port-${i}`) || '8080',
                                    replicas: _v(`k8s-svc-replicas-${i}`) || '2',
                                    serviceType: _v(`k8s-svc-type-${i}`) || 'ClusterIP',
                                    strategy: strategy,
                                    maxSurge: strategy === 'RollingUpdate' ? (_v(`k8s-svc-maxsurge-${i}`) || '1') : null,
                                    maxUnavailable: strategy === 'RollingUpdate' ? (_v(`k8s-svc-maxunavail-${i}`) || '1') : null,
                                    resources: hasResources ? {
                                        cpu_request: cpuReq || null,
                                        cpu_limit: cpuLim || null,
                                        memory_request: memReq || null,
                                        memory_limit: memLim || null,
                                    } : null,
                                    readinessProbe: _collectProbe(`k8s-svc-rdy-${i}`),
                                    livenessProbe: _collectProbe(`k8s-svc-liv-${i}`),
                                    envVars: window._collectEnvVars(i),
                                    _compose: appSvcs[i],
                                });
                            }
                        } else if (mode === 'modules') {
                            for (let i = 0; i < appCount; i++) {
                                const chk = document.getElementById(`k8s-svc-chk-${i}`);
                                if (!chk || !chk.checked) continue;
                                services.push({
                                    name: deployableModules[i].name,
                                    kind: 'Deployment',
                                    image: _v(`k8s-svc-img-${i}`) || `${deployableModules[i].name}:latest`,
                                    port: _v(`k8s-svc-port-${i}`) || '8080',
                                    replicas: _v(`k8s-svc-replicas-${i}`) || '2',
                                    serviceType: _v(`k8s-svc-type-${i}`) || 'ClusterIP',
                                });
                            }
                        } else {
                            // Manual
                            services.push({
                                name: _v('k8s-svc-name-manual') || 'app',
                                kind: 'Deployment',
                                image: _v('k8s-svc-img-manual') || 'app:latest',
                                port: _v('k8s-svc-port-manual') || '8080',
                                replicas: _v('k8s-svc-replicas-manual') || '2',
                                serviceType: _v('k8s-svc-type-manual') || 'ClusterIP',
                            });
                        }

                        // â”€â”€ Collect infrastructure services â”€â”€
                        const infraDecisions = [];
                        for (let i = 0; i < infraCount; i++) {
                            const checked = document.querySelector(`input[name="k8s-infra-${i}"]:checked`);
                            const decision = checked ? checked.value : 'skip';
                            if (decision !== 'skip') {
                                infraDecisions.push({
                                    name: infraSvcs[i].name,
                                    kind: decision === 'statefulset' ? 'StatefulSet' : 'Managed',
                                    image: infraSvcs[i].image || infraSvcs[i].name,
                                    port: infraSvcs[i].ports && infraSvcs[i].ports.length > 0 ? String(infraSvcs[i].ports[0].container) : '',
                                    _compose: infraSvcs[i],
                                });
                            }
                        }

                        // â”€â”€ Store full multi-service config â”€â”€
                        data._services = services;
                        data._infraDecisions = infraDecisions;

                        // â”€â”€ Cluster settings â”€â”€
                        data.namespace = mfVal('k8s-namespace') || 'default';
                        data.output_dir = mfVal('k8s-output-dir') || 'k8s/';
                        data.ingress = mfVal('k8s-ingress');
                        // data.configmap removed â€” ConfigMaps auto-generated per service from envVars

                        // â”€â”€ Backward compat: flat fields from primary service â”€â”€
                        if (services.length > 0) {
                            data.app_name = services[0].name;
                            data.image = services[0].image;
                            data.port = services[0].port;
                            data.replicas = services[0].replicas;
                            data.service_type = services[0].serviceType;
                        }
                    },
                    validate: (data) => {
                        if (!data._services || data._services.length === 0) return 'At least one service must be selected';
                        for (const svc of data._services) {
                            if (!svc.image) return `Container image is required for ${svc.name}`;
                            // Validate resource quantity formats
                            if (svc.resources) {
                                const r = svc.resources;
                                const qtyRx = /^\d+(\.\d+)?(m|Mi|Gi|Ki|Ti|M|G|K|T)?$/;
                                if (r.cpu_request && !qtyRx.test(r.cpu_request)) return `Invalid CPU request format for ${svc.name} â€” use e.g. 100m, 0.5, 1`;
                                if (r.cpu_limit && !qtyRx.test(r.cpu_limit)) return `Invalid CPU limit format for ${svc.name} â€” use e.g. 500m, 1, 2`;
                                if (r.memory_request && !qtyRx.test(r.memory_request)) return `Invalid memory request format for ${svc.name} â€” use e.g. 128Mi, 1Gi`;
                                if (r.memory_limit && !qtyRx.test(r.memory_limit)) return `Invalid memory limit format for ${svc.name} â€” use e.g. 256Mi, 1Gi`;
                            }
                        }
                        return null;
                    },
                },

                // â”€â”€ Step 3: Review & Apply â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'review', title: 'Review & Apply',
                    render: (data, el) => {
                        const services = data._services || [];
                        const infraDecisions = data._infraDecisions || [];

                        // Build review items from all services
                        const items = [];

                        for (const svc of services) {
                            const stratStr = svc.strategy === 'Recreate' ? ' Â· Recreate'
                                : svc.maxSurge || svc.maxUnavailable ? ` Â· Rolling(â†‘${svc.maxSurge || 1}/â†“${svc.maxUnavailable || 1})`
                                : '';
                            items.push({
                                icon: 'ğŸš€',
                                label: `${svc.kind}: ${svc.name}`,
                                value: `${svc.replicas || '?'} replica${svc.replicas !== '1' ? 's' : ''} of ${svc.image}${stratStr}`,
                                badge: 'create',
                                badgeCls: 'ready',
                            });
                            items.push({
                                icon: 'ğŸŒ',
                                label: `Service: ${svc.name}`,
                                value: `${svc.serviceType} â†’ port ${svc.port}`,
                                badge: 'create',
                                badgeCls: 'ready',
                            });
                            // Resource limits (if configured)
                            if (svc.resources) {
                                const r = svc.resources;
                                const cpuStr = (r.cpu_request || r.cpu_limit) ? `CPU ${r.cpu_request || 'â€”'}â†’${r.cpu_limit || 'â€”'}` : '';
                                const memStr = (r.memory_request || r.memory_limit) ? `Mem ${r.memory_request || 'â€”'}â†’${r.memory_limit || 'â€”'}` : '';
                                const resStr = [cpuStr, memStr].filter(Boolean).join(' / ');
                                if (resStr) {
                                    items.push({
                                        icon: 'ğŸ”§',
                                        label: `Resources: ${svc.name}`,
                                        value: resStr,
                                        badge: '',
                                        badgeCls: '',
                                    });
                                }
                            }
                            // Health probes (if configured)
                            const probeDesc = (p) => {
                                if (!p) return null;
                                if (p.type === 'http') return `HTTP ${p.path}:${p.port}`;
                                if (p.type === 'tcp') return `TCP :${p.port}`;
                                return `exec: ${(p.command || '').substring(0, 30)}${(p.command || '').length > 30 ? 'â€¦' : ''}`;
                            };
                            const rdyStr = probeDesc(svc.readinessProbe);
                            const livStr = probeDesc(svc.livenessProbe);
                            if (rdyStr || livStr) {
                                const parts = [];
                                if (rdyStr) parts.push(`Ready: ${rdyStr}`);
                                if (livStr) parts.push(`Live: ${livStr}`);
                                items.push({
                                    icon: 'ğŸ’“',
                                    label: `Probes: ${svc.name}`,
                                    value: parts.join(' / '),
                                    badge: '',
                                    badgeCls: '',
                                });
                            }
                            // Environment variables â€” ConfigMap + Secret summary
                            const ev = svc.envVars || [];
                            const evHc = ev.filter(e => e.type === 'hardcoded').length;
                            const evVr = ev.filter(e => e.type === 'variable').length;
                            const evSc = ev.filter(e => e.type === 'secret').length;
                            if (evHc + evVr > 0) {
                                items.push({
                                    icon: 'ğŸ“‹',
                                    label: `ConfigMap: ${svc.name}-config`,
                                    value: `${evHc} hardcoded${evVr > 0 ? `, ${evVr} \${VAR}` : ''}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                            }
                            if (evSc > 0) {
                                items.push({
                                    icon: 'ğŸ”’',
                                    label: `Secret: ${svc.name}-secrets`,
                                    value: `${evSc} key${evSc !== 1 ? 's' : ''} (\${VAR} at deploy)`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                            }
                            // Vault vars/secrets to be created on execution
                            const toCreate = ev.filter(e => e.createInVault);
                            toCreate.forEach(e => {
                                const vaultKey = (e.varName || '').replace(/^\$\{/, '').replace(/\}$/, '') || e.key;
                                items.push({
                                    icon: 'ğŸ—ï¸',
                                    label: `Vault: Create ${vaultKey}`,
                                    value: e.newValue ? 'with generated value' : 'empty (set later)',
                                    badge: 'vault create',
                                    badgeCls: 'ready',
                                });
                            });
                        }

                        for (const infra of infraDecisions) {
                            items.push({
                                icon: 'ğŸ—„ï¸',
                                label: `${infra.kind}: ${infra.name}`,
                                value: infra.image,
                                badge: infra.kind === 'StatefulSet' ? 'create' : 'ref',
                                badgeCls: infra.kind === 'StatefulSet' ? 'ready' : 'muted',
                            });
                        }

                        if (data.ingress) {
                            items.push({ icon: 'ğŸ”€', label: 'Ingress', value: 'HTTP routing rules', badge: 'create', badgeCls: 'ready' });
                        }
                        // ConfigMap checkbox removed â€” ConfigMaps/Secrets auto-generated per service from envVars
                        items.push({ icon: 'ğŸ“', label: 'Output directory', value: data.output_dir || 'k8s/', badge: '', badgeCls: '' });
                        items.push({ icon: 'ğŸ·ï¸', label: 'Namespace', value: data.namespace || 'default', badge: '', badgeCls: '' });

                        el.innerHTML = `
                            ${wizSection('Review', `${services.length + infraDecisions.length} resource${(services.length + infraDecisions.length) !== 1 ? 's' : ''} will be generated.`)}
                            ${items.map(item => `<div class="wiz-review-item">
                                <span class="wiz-review-icon">${item.icon}</span>
                                <div class="wiz-review-content">
                                    <div class="wiz-review-label">${esc(item.label)}</div>
                                    <div class="wiz-review-value">${esc(item.value)}</div>
                                </div>
                                ${item.badge ? `<span class="wiz-review-badge ${item.badgeCls}">${item.badge}</span>` : ''}
                            </div>`).join('')}

                            ${services.length > 1 ? `<div style="margin-top:0.5rem;font-size:0.74rem;color:var(--text-muted);padding:0.3rem 0.5rem;background:var(--bg-inset);border-radius:6px">
                                âš ï¸ <strong>Note:</strong> Multi-service manifest generation is in progress. The primary service (<strong>${esc(services[0].name)}</strong>) will be fully generated; additional services will be scaffolded.
                            </div>` : ''}

                            <div style="margin-top:var(--space-md);padding:var(--space-xs) var(--space-sm);border-left:3px solid var(--accent);background:color-mix(in srgb, var(--accent) 5%, transparent);border-radius:0 6px 6px 0">
                                <div style="font-size:0.78rem;color:var(--text-secondary)">
                                    ğŸ’¡ <strong>Next:</strong> Set up CI/CD to automate builds and deployments.
                                    <button class="btn btn-sm btn-ghost" style="font-size:0.72rem;padding:0.1rem 0.4rem;margin-left:4px;color:var(--accent)"
                                        onclick="wizardModalClose();setTimeout(openCICDSetupWizard,300)">Set up CI/CD â†’</button>
                                </div>
                            </div>
                        `;
                    },
                },
            ],
            onComplete: async (data) => {
                const payload = {
                    action: 'setup_k8s',
                    app_name: data.app_name,
                    image: data.image,
                    port: data.port,
                    replicas: data.replicas,
                    namespace: data.namespace,
                    service_type: data.service_type,
                    ingress: data.ingress,
                    // configmap removed â€” auto-generated per service from envVars
                };
                // Forward resource limits from primary service if configured
                const primary = (data._services || [])[0];
                if (primary && primary.resources) {
                    payload.cpu_limit = primary.resources.cpu_limit;
                    payload.cpu_request = primary.resources.cpu_request;
                    payload.memory_limit = primary.resources.memory_limit;
                    payload.memory_request = primary.resources.memory_request;
                }
                // Attach full multi-service config for future backend enhancement
                payload._services = data._services;
                payload._infraDecisions = data._infraDecisions;
                await apiPost('/wizard/setup', payload);
                _projectStatusTS = 0;
                cardInvalidate('k8s');
            },
            successMessage: 'Kubernetes manifests generated!',
        });
    }

    // â”€â”€ Terraform Setup Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function openTerraformSetupWizard() {
        wizardModalOpen({
            title: 'ğŸ—ï¸ Terraform Setup',
            size: 'wide',
            steps: [
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // â”€â”€ Serve from cache if available (instant, zero API calls) â”€â”€
                        const _CK = 'tf:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // â”€â”€ Fresh scan â”€â”€
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Detecting Terraform environmentâ€¦</p>';
                        try {
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;
                            const probes = wizDetect.status_probes || {};
                            const tf = probes.terraform || {};
                            data._tf = tf;

                            const html = `
                                ${wizSection('Terraform Environment', 'Current Infrastructure as Code configuration.')}
                                <div class="wiz-status-grid">
                                    ${wizStatusRow('ğŸ—ï¸', 'Terraform CLI', tf.has_cli ? 'Available' : 'Not found', tf.has_cli ? 'ok' : 'error')}
                                    ${wizStatusRow('ğŸ“„', 'TF files', String(tf.tf_file_count || 0), tf.tf_file_count > 0 ? 'ok' : 'warn')}
                                    ${wizStatusRow('ğŸ“', 'Initialized', tf.initialized ? 'Yes' : 'No', tf.initialized ? 'ok' : 'muted')}
                                    ${wizStatusRow('ğŸ’¾', 'State file', tf.has_state ? 'Present' : 'None', tf.has_state ? 'ok' : 'muted')}
                                </div>
                            `;

                            // Store complete detect result in cache
                            wizStore(_CK, { h: html, d: { _tf: data._tf } }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>âš ï¸</span><span>${esc(e.message)}</span></div>`;
                        }
                    },
                },
                {
                    id: 'config', title: 'Configure',
                    render: (data, el) => {
                        el.innerHTML = `
                            ${wizSection('Provider', 'Which cloud provider are you targeting?')}
                            ${wizFormGrid([
                                { name: 'tf-provider', label: 'Cloud Provider', type: 'select', value: data.provider || 'aws', options: [
                                    { value: 'aws', label: 'AWS' },
                                    { value: 'gcp', label: 'Google Cloud' },
                                    { value: 'azure', label: 'Microsoft Azure' },
                                    { value: 'digitalocean', label: 'DigitalOcean' },
                                    { value: 'custom', label: 'Custom / Other' },
                                ], required: true },
                                { name: 'tf-region', label: 'Region', value: data.region || 'us-east-1', hint: 'Primary deployment region' },
                            ])}

                            ${wizSection('Resources', 'What infrastructure do you want to provision?')}
                            ${wizFormGrid([
                                { name: 'tf-k8s', label: 'Kubernetes cluster (EKS/GKE/AKS)', type: 'checkbox', value: false, fullWidth: true },
                                { name: 'tf-rds', label: 'Database (RDS/Cloud SQL)', type: 'checkbox', value: false, fullWidth: true },
                                { name: 'tf-s3', label: 'Object storage (S3/GCS)', type: 'checkbox', value: false, fullWidth: true },
                                { name: 'tf-networking', label: 'VPC / Networking', type: 'checkbox', value: true, fullWidth: true },
                            ])}

                            ${wizSection('Backend', 'Where should Terraform store its state?')}
                            ${wizFormGrid([
                                { name: 'tf-backend', label: 'State Backend', type: 'select', value: data.backend || 'local', options: [
                                    { value: 'local', label: 'Local (terraform.tfstate)' },
                                    { value: 's3', label: 'AWS S3' },
                                    { value: 'gcs', label: 'Google Cloud Storage' },
                                    { value: 'azurerm', label: 'Azure Blob Storage' },
                                ], fullWidth: true },
                            ])}
                        `;
                    },
                    collect: (data) => {
                        data.provider = mfVal('tf-provider');
                        data.region = mfVal('tf-region');
                        data.k8sCluster = mfVal('tf-k8s');
                        data.database = mfVal('tf-rds');
                        data.storage = mfVal('tf-s3');
                        data.networking = mfVal('tf-networking');
                        data.backend = mfVal('tf-backend');
                    },
                },
                {
                    id: 'review', title: 'Review & Apply',
                    render: (data, el) => {
                        const resources = [];
                        if (data.networking) resources.push('VPC, Subnets, Security Groups');
                        if (data.k8sCluster) resources.push('Kubernetes Cluster');
                        if (data.database) resources.push('Database Instance');
                        if (data.storage) resources.push('Object Storage Bucket');

                        const files = [
                            { icon: 'ğŸ“„', label: 'main.tf', value: `Provider: ${data.provider}, Region: ${data.region}` },
                            { icon: 'ğŸ“‹', label: 'variables.tf', value: 'Input variable definitions' },
                            { icon: 'ğŸ“¤', label: 'outputs.tf', value: 'Output value definitions' },
                        ];
                        if (data.backend !== 'local') {
                            files.push({ icon: 'ğŸ’¾', label: 'backend.tf', value: `State backend: ${data.backend}` });
                        }

                        el.innerHTML = `
                            ${wizSection('Review', 'The following Terraform configuration will be generated.')}
                            ${files.map(item => `<div class="wiz-review-item">
                                <span class="wiz-review-icon">${item.icon}</span>
                                <div class="wiz-review-content">
                                    <div class="wiz-review-label">${esc(item.label)}</div>
                                    <div class="wiz-review-value">${esc(item.value)}</div>
                                </div>
                                <span class="wiz-review-badge ready">create</span>
                            </div>`).join('')}

                            ${resources.length > 0 ? `
                                ${wizSection('Resources to provision')}
                                <div style="padding:0 0.5rem;font-size:0.82rem;color:var(--text-secondary)">
                                    ${resources.map(r => `<div style="padding:4px 0">â€¢ ${esc(r)}</div>`).join('')}
                                </div>
                            ` : ''}
                        `;
                    },
                },
            ],
            onComplete: async (data) => {
                await apiPost('/wizard/setup', {
                    action: 'setup_terraform',
                    provider: data.provider,
                    region: data.region,
                    k8s_cluster: data.k8sCluster,
                    database: data.database,
                    storage: data.storage,
                    networking: data.networking,
                    backend: data.backend,
                });
                _projectStatusTS = 0;
            },
            successMessage: 'Terraform configuration generated!',
        });
    }
    // â”€â”€ GitHub Setup Wizard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Integration #2 â€” reads environments from project.yml, aligns
    // them with GitHub deployment environments, offers secret sync.

    async function openGitHubSetupWizard() {
        wizardModalOpen({
            title: 'ğŸ™ GitHub Setup',
            size: 'wide',
            steps: [
                // â”€â”€ Step 1: DETECT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // â”€â”€ Serve from cache if available (instant, zero API calls) â”€â”€
                        const _CK = 'gh:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // â”€â”€ Fresh scan â”€â”€
                        el.innerHTML = '<span class="spinner"></span> Detecting GitHub statusâ€¦';

                        // ONE call: wizDetect is the one-stop-shop
                        const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                        const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                        const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;

                        const probes = wizDetect.status_probes || {};
                        const gh = probes.github || {};
                        const ghStatus = wizDetect.gh_cli_status || { available: false };
                        const ghUser = wizDetect.gh_user || { available: false };
                        const ghRepoInfo = wizDetect.gh_repo_info || { available: false };
                        const ghEnvData = wizDetect.gh_environments || { available: false, environments: [] };
                        data._ghStatus = ghStatus;
                        data._ghUser = ghUser;
                        data._ghRepoInfo = ghRepoInfo;
                        data._projectStatus = { integrations: probes };
                        data._config = wizDetect.config_data || {};
                        data._ghEnvData = ghEnvData;
                        data._localEnvs = (wizDetect.config_data?.environments || []);
                        data._codeownersContent = wizDetect.codeowners_content || '';

                        // Remote env names (lowercase for comparison)
                        const remoteEnvNames = (ghEnvData.environments || []).map(e =>
                            (typeof e === 'string' ? e : e.name || String(e)).toLowerCase());
                        data._remoteEnvNames = remoteEnvNames;

                        // Secrets: multi-env â†’ per-environment, single â†’ repo-scoped
                        const localEnvs = data._localEnvs;
                        const multiEnv = localEnvs.length > 1;
                        let totalSecrets = 0, totalVars = 0;
                        const perEnvSecrets = {};

                        if (multiEnv) {
                            const envQueries = localEnvs.map(e =>
                                api(`/gh/secrets?env=${encodeURIComponent(e.name)}`)
                                    .catch(() => ({ available: false, secrets: [], variables: [] }))
                            );
                            const envResults = await Promise.all(envQueries);
                            for (let i = 0; i < localEnvs.length; i++) {
                                const r = envResults[i];
                                const envName = localEnvs[i].name;
                                perEnvSecrets[envName] = r;
                                totalSecrets += (r.secrets || []).length;
                                totalVars += (r.variables || []).length;
                            }
                            data._secretsAvailable = true;
                        } else {
                            const ghSecrets = await api('/gh/secrets').catch(() => ({ available: false, secrets: [], variables: [] }));
                            totalSecrets = (ghSecrets.secrets || []).length;
                            totalVars = (ghSecrets.variables || []).length;
                            data._secretsAvailable = ghSecrets.available !== false;
                            perEnvSecrets['_repo'] = ghSecrets;
                        }
                        data._perEnvSecrets = perEnvSecrets;
                        data._totalSecrets = totalSecrets;
                        data._totalVars = totalVars;
                        data._multiEnv = multiEnv;

                        // â”€â”€ Build detection display â”€â”€
                        let html = `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;margin-bottom:var(--space-sm);font-size:0.82rem;background:color-mix(in srgb, var(--accent) 10%, var(--bg-inset));border:1px solid color-mix(in srgb, var(--accent) 30%, transparent);border-radius:8px">
                            <span style="font-size:1.1rem">ğŸ”</span>
                            <span style="flex:1;color:var(--text-secondary)">This is a <strong>read-only scan</strong>. To manage visibility, environments, CODEOWNERS, and secrets, proceed to Configure.</span>
                            <button type="button" class="btn btn-xs" style="background:var(--accent);color:white;border:none;padding:4px 12px;border-radius:6px;font-size:0.78rem;white-space:nowrap;cursor:pointer"
                                onclick="document.getElementById('wiz-btn-next')?.click()">Configure â†’</button>
                        </div>`;

                        // â”€â”€ gh CLI â”€â”€
                        html += wizSection('GitHub CLI', 'Tool, authentication, and account.');
                        html += '<div class="wiz-status-grid">';

                        if (!ghStatus.available) {
                            html += wizStatusRow('âŒ', 'gh CLI', 'Not installed', 'error');
                            html += '</div>';
                            html += `<div style="padding:0.5rem 0.75rem;background:var(--bg-inset);border:1px solid var(--error);border-radius:8px;font-size:0.82rem;margin-top:var(--space-sm)">
                                <strong style="color:var(--error)">GitHub CLI required.</strong> Install it first:
                                <div style="margin-top:0.3rem;display:flex;gap:0.5rem;flex-wrap:wrap">
                                    <code style="background:var(--bg-tertiary);padding:2px 8px;border-radius:4px">sudo apt install gh</code>
                                    <code style="background:var(--bg-tertiary);padding:2px 8px;border-radius:4px">brew install gh</code>
                                </div>
                            </div>`;
                            el.innerHTML = html;
                            return;
                        }

                        html += wizStatusRow('âœ…', 'gh CLI', `Installed (${esc(ghStatus.version || 'unknown')})`, 'ok');

                        // â”€â”€ Auth + User â”€â”€
                        if (!ghStatus.authenticated) {
                            html += wizStatusRow('âŒ', 'Authentication', 'Not logged in', 'error');
                            html += '</div>';
                            html += `<div style="padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--warning);border-radius:8px;font-size:0.82rem;margin-top:var(--space-sm)">
                                <strong>Login required.</strong> Run this in your terminal:
                                <div style="display:flex;align-items:center;gap:0.5rem;margin-top:0.4rem">
                                    <code id="gh-auth-cmd" style="flex:1;background:var(--bg-tertiary);padding:4px 10px;border-radius:4px;font-size:0.8rem">gh auth login</code>
                                    <button type="button" class="btn btn-xs btn-secondary" style="font-size:0.7rem;padding:2px 8px"
                                        onclick="navigator.clipboard.writeText('gh auth login').then(()=>this.textContent='âœ“ Copied').catch(()=>{});setTimeout(()=>this.textContent='ğŸ“‹ Copy',2000)">ğŸ“‹ Copy</button>
                                </div>
                                <div style="font-size:0.72rem;color:var(--text-muted);margin-top:0.3rem">
                                    After logging in, click <strong>Re-scan</strong> above to refresh.
                                </div>
                            </div>`;
                            el.innerHTML = html;
                            return;
                        }

                        // Authenticated â€” show user info
                        const userLogin = ghUser.login || 'unknown';
                        const userName = ghUser.name || '';
                        const userAvatar = ghUser.avatar_url || '';
                        html += wizStatusRow('âœ…', 'Authentication', 'Logged in', 'ok');
                        html += '</div>';

                        // â”€â”€ User card â”€â”€
                        html += `<div style="display:flex;align-items:center;gap:0.7rem;padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;margin:var(--space-sm) 0">
                            ${userAvatar ? `<img src="${esc(userAvatar)}" style="width:32px;height:32px;border-radius:50%;border:2px solid var(--accent)" alt="">` : '<span style="font-size:1.3rem">ğŸ‘¤</span>'}
                            <div style="flex:1">
                                <div style="font-size:0.85rem;font-weight:600;color:var(--text-primary)">@${esc(userLogin)}</div>
                                ${userName ? `<div style="font-size:0.72rem;color:var(--text-muted)">${esc(userName)}</div>` : ''}
                            </div>
                            <button type="button" class="btn btn-xs btn-secondary" style="font-size:0.68rem;padding:2px 8px;color:var(--error)"
                                onclick="(async()=>{if(!confirm('Log out from GitHub CLI?'))return;const r=await apiPost('/gh/auth/logout',{});toast(r.ok?'Logged out â€” Re-scan to refresh':'Logout failed: '+(r.error||''),'info');})()">ğŸ”“ Logout</button>
                        </div>`;

                        // â”€â”€ Repository â”€â”€
                        html += wizSection('Repository', 'GitHub repository linked via git remote.');
                        html += '<div class="wiz-status-grid">';

                        if (ghStatus.repo) {
                            const vis = ghRepoInfo.visibility || '?';
                            const visColor = vis === 'PUBLIC' ? 'var(--success)' : vis === 'PRIVATE' ? 'var(--warning)' : 'var(--text-muted)';
                            const visIcon = vis === 'PUBLIC' ? 'ğŸŒ' : vis === 'PRIVATE' ? 'ğŸ”’' : 'â“';
                            html += wizStatusRow('âœ…', 'Repository', esc(ghStatus.repo), 'ok');
                            html += wizStatusRow(visIcon, 'Visibility',
                                `<span style="color:${visColor};font-weight:600">${esc(vis)}</span>`, 'ok', true);
                            if (ghRepoInfo.description) {
                                html += wizStatusRow('ğŸ“', 'Description', esc(ghRepoInfo.description), 'muted');
                            }
                            html += wizStatusRow('ğŸŒ¿', 'Default branch', esc(ghRepoInfo.default_branch || '?'), 'muted');
                        } else {
                            html += wizStatusRow('âš ï¸', 'Repository', 'No GitHub repository linked', 'warn');
                        }

                        // .github dir + workflows
                        if (gh.has_github_dir) {
                            const wfNote = gh.workflow_count > 0
                                ? `${gh.workflow_count} workflow${gh.workflow_count !== 1 ? 's' : ''}`
                                : 'no workflows';
                            html += wizStatusRow('âœ…', '.github/ dir', `Exists (${wfNote})`, 'ok');
                        } else {
                            html += wizStatusRow('âŒ', '.github/ dir', 'Not found', 'error');
                        }

                        // CODEOWNERS
                        html += wizStatusRow(gh.has_codeowners ? 'âœ…' : 'âŒ', 'CODEOWNERS',
                            gh.has_codeowners ? 'Found' : 'Not configured',
                            gh.has_codeowners ? 'ok' : 'muted');

                        html += '</div>';

                        // â”€â”€ Environments â”€â”€
                        const localCount = data._localEnvs.length;
                        const matchCount = data._localEnvs.filter(e =>
                            remoteEnvNames.includes(e.name.toLowerCase())).length;

                        html += wizSection('Integration Status', '');
                        html += '<div class="wiz-status-grid">';
                        if (localCount > 0) {
                            html += wizStatusRow(matchCount === localCount ? 'âœ…' : 'âš ï¸',
                                'Environments', `${matchCount} of ${localCount} aligned`,
                                matchCount === localCount ? 'ok' : 'warn');
                        } else {
                            html += wizStatusRow('â–', 'Environments', 'None defined in project config', 'muted');
                        }

                        // Secrets summary
                        if (data._secretsAvailable) {
                            const scopeLabel = multiEnv ? `across ${localEnvs.length} envs` : 'repo-scoped';
                            html += wizStatusRow('ğŸ“Š', 'GitHub Secrets',
                                `${totalSecrets} secret${totalSecrets !== 1 ? 's' : ''}, ${totalVars} variable${totalVars !== 1 ? 's' : ''} (${scopeLabel})`);
                        }
                        html += '</div>';



                        // â”€â”€ Hints â”€â”€
                        const hints = [];
                        if (matchCount < localCount) {
                            hints.push(`Your project defines ${localCount} environments. We can create the ${localCount - matchCount} missing ones on GitHub.`);
                        }
                        if (!ghStatus.repo) {
                            hints.push('No GitHub repository linked. You can <strong>create a new one</strong> or <strong>connect an existing one</strong> in the Configure step.');
                        }

                        if (hints.length > 0) {
                            html += `<div style="margin-top:var(--space-sm);padding:var(--space-xs) var(--space-sm);border-left:3px solid var(--accent);background:color-mix(in srgb, var(--accent) 5%, transparent);border-radius:0 6px 6px 0">`;
                            hints.forEach(h => { html += `<div style="font-size:0.78rem;color:var(--text-secondary);padding:2px 0">ğŸ’¡ ${h}</div>`; });
                            html += `</div>`;
                        }

                        // Store complete detect result in cache
                        wizStore(_CK, { h: html, d: {
                            _ghStatus: data._ghStatus, _ghUser: data._ghUser,
                            _ghRepoInfo: data._ghRepoInfo,
                            _projectStatus: data._projectStatus,
                            _config: data._config, _ghEnvData: data._ghEnvData,
                            _localEnvs: data._localEnvs, _remoteEnvNames: data._remoteEnvNames,
                            _perEnvSecrets: data._perEnvSecrets, _totalSecrets: data._totalSecrets,
                            _totalVars: data._totalVars, _multiEnv: data._multiEnv,
                            _secretsAvailable: data._secretsAvailable,
                            _codeownersContent: data._codeownersContent,
                        }}, _serverTs);
                        el.innerHTML = _wizDetectBanner(_CK) + html;
                    },
                },

                // â”€â”€ Step 2: CONFIGURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'config', title: 'Configure',
                    render: async (data, el) => {
                        const ghStatus = data._ghStatus;
                        const ghRepoInfo = data._ghRepoInfo || {};
                        const localEnvs = data._localEnvs;
                        const remoteEnvNames = data._remoteEnvNames;

                        let html = '';

                        // â”€â”€ Section A: Repository â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        html += wizSection('Repository', 'GitHub repository and settings.');

                        if (ghStatus.repo) {
                            // â”€â”€ Linked repo: show info + visibility toggle â”€â”€
                            const vis = ghRepoInfo.visibility || '?';
                            const isPrivate = vis === 'PRIVATE';
                            const visColor = isPrivate ? 'var(--warning)' : 'var(--success)';
                            const visIcon = isPrivate ? 'ğŸ”’' : 'ğŸŒ';
                            const toggleTo = isPrivate ? 'public' : 'private';
                            const toggleIcon = isPrivate ? 'ğŸŒ' : 'ğŸ”’';

                            html += `<div style="background:var(--bg-inset);border:1px solid var(--success);border-radius:8px;padding:0.6rem 0.75rem;margin-bottom:var(--space-sm)">
                                <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:0.4rem">
                                    <span style="font-size:1.1rem">ğŸ”—</span>
                                    <code style="font-size:0.85rem;font-weight:600">${esc(ghStatus.repo)}</code>
                                    <span style="flex:1"></span>
                                    <a href="https://github.com/${esc(ghStatus.repo)}" target="_blank"
                                       style="font-size:0.72rem;color:var(--accent);text-decoration:none">Open on GitHub â†—</a>
                                </div>
                                <div style="display:flex;align-items:center;gap:0.7rem;padding-top:0.4rem;border-top:1px solid var(--border-subtle)">
                                    <div style="display:flex;align-items:center;gap:0.4rem">
                                        <span>${visIcon}</span>
                                        <span style="font-size:0.82rem;font-weight:600;color:${visColor}">${esc(vis)}</span>
                                    </div>
                                    ${ghRepoInfo.description ? `<span style="font-size:0.72rem;color:var(--text-muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(ghRepoInfo.description)}</span>` : '<span style="flex:1"></span>'}
                                    <button type="button" class="btn btn-xs btn-secondary" id="gh-vis-toggle"
                                        style="font-size:0.68rem;padding:2px 10px;border:1px solid ${visColor}"
                                        onclick="(async()=>{
                                            const btn=document.getElementById('gh-vis-toggle');
                                            const target='${toggleTo}';
                                            const slug='${esc(ghStatus.repo)}';
                                            if(!confirm('Change ' + slug + ' to ' + target.toUpperCase() + '?\\n\\n' +
                                                (target==='public' ? 'âš ï¸ This will make your code visible to everyone on the internet.' : 'ğŸ”’ This will restrict access to collaborators only.') +
                                                '\\n\\nAre you sure?')) return;
                                            btn.disabled=true; btn.textContent='Changingâ€¦';
                                            try {
                                                await apiPost('/gh/repo/visibility', {visibility:target});
                                                toast('âœ… Visibility changed to ' + target, 'success');
                                                wizInvalidate('gh:detect'); wizInvalidate('detect');
                                                _wizModalRender();
                                            } catch(e) { toast('âŒ ' + e.message, 'error'); btn.disabled=false; btn.textContent='${toggleIcon} Make ${toggleTo}'; }
                                        })()">${toggleIcon} Make ${toggleTo}</button>
                                </div>
                            </div>`;
                        } else {
                            // â”€â”€ No repo linked: create or connect â”€â”€
                            html += `<div style="background:var(--bg-inset);border:1px solid var(--warning);border-radius:8px;padding:0.6rem 0.75rem;margin-bottom:var(--space-sm)">
                                <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem">
                                    <span>âš ï¸</span>
                                    <span style="font-size:0.85rem;font-weight:500">No GitHub repository linked</span>
                                </div>
                                <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.6rem">
                                    Create a new GitHub repository from this project, or set a git remote pointing to an existing one via the <strong>Git Setup</strong> wizard.
                                </div>
                                <div style="border-top:1px solid var(--border-subtle);padding-top:0.5rem">
                                    <div style="font-size:0.72rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:0.4rem">Create New Repository</div>
                                    <div style="display:flex;flex-direction:column;gap:0.4rem">
                                        <div style="display:flex;gap:0.5rem;align-items:center">
                                            <input type="text" id="mf-gh-repo-name" class="modal-form-input" style="flex:1;font-size:0.82rem;padding:4px 8px"
                                                placeholder="${esc((data._config?.modules?.[0]?.name || '').replace(/[^a-zA-Z0-9._-]/g,'') || 'my-project')}" value="">
                                            <select id="mf-gh-repo-vis" class="modal-form-input" style="width:110px;font-size:0.82rem;padding:4px 8px">
                                                <option value="private" selected>ğŸ”’ Private</option>
                                                <option value="public">ğŸŒ Public</option>
                                            </select>
                                        </div>
                                        <input type="text" id="mf-gh-repo-desc" class="modal-form-input" style="font-size:0.82rem;padding:4px 8px"
                                            placeholder="Optional description">
                                        <button type="button" class="btn btn-sm" id="gh-create-repo-btn"
                                            style="align-self:flex-start;font-size:0.78rem;padding:4px 14px;background:var(--accent);color:white;border:none;border-radius:6px"
                                            onclick="(async()=>{
                                                const btn=document.getElementById('gh-create-repo-btn');
                                                const name=document.getElementById('mf-gh-repo-name').value.trim();
                                                if(!name){toast('Enter a repository name','warn');return}
                                                const vis=document.getElementById('mf-gh-repo-vis').value;
                                                const desc=document.getElementById('mf-gh-repo-desc').value.trim();
                                                btn.disabled=true; btn.textContent='Creatingâ€¦';
                                                try {
                                                    const r = await apiPost('/gh/repo/create', {name, private:vis==='private', description:desc, add_remote:true});
                                                    if(r.ok){
                                                        toast('âœ… '+r.message,'success');
                                                        wizInvalidate('gh:detect'); wizInvalidate('detect');
                                                        cardInvalidate('git'); cardInvalidate('github');
                                                        _wizModalRender();
                                                    } else {
                                                        toast('âŒ '+(r.error||'Failed'),'error');
                                                        btn.disabled=false; btn.textContent='ğŸš€ Create Repository';
                                                    }
                                                } catch(e) { toast('âŒ '+e.message,'error'); btn.disabled=false; btn.textContent='ğŸš€ Create Repository'; }
                                            })()">ğŸš€ Create Repository</button>
                                    </div>
                                </div>
                            </div>`;
                        }

                        // â”€â”€ Section A2: Default Branch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        if (ghStatus.repo && ghRepoInfo.available) {
                            html += wizSection('Default Branch', 'The branch GitHub treats as the base for pull requests and the repository landing page.');

                            const currentBranch = ghRepoInfo.default_branch || 'main';
                            html += `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.65rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:var(--space-sm)">
                                <span style="font-size:0.95rem">ğŸŒ¿</span>
                                <code style="font-size:0.85rem;font-weight:600">${esc(currentBranch)}</code>
                                <span style="flex:1"></span>
                                <button type="button" class="btn btn-xs btn-secondary" style="font-size:0.68rem;padding:2px 8px"
                                    onclick="(async()=>{
                                        const newBranch=prompt('Set default branch to:', '${esc(currentBranch)}');
                                        if(!newBranch||newBranch==='${esc(currentBranch)}')return;
                                        const res=await apiPost('/gh/repo/default-branch',{branch:newBranch});
                                        if(res.ok){toast('âœ… '+res.message,'success');wizInvalidate('gh:detect');wizInvalidate('detect');_wizModalRender()}
                                        else{toast('âŒ '+(res.error||'Failed'),'error')}
                                    })()">âœï¸ Change</button>
                            </div>`;
                        }

                        // â”€â”€ Section A3: CODEOWNERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        if (ghStatus.repo) {
                            html += wizSection('CODEOWNERS', 'Define reviewers who are automatically requested for PRs affecting their files.');

                            // Use pre-loaded CODEOWNERS content from detect response
                            const existingContent = data._codeownersContent || '';

                            const hasExisting = existingContent.trim().length > 0;
                            const owner = ghRepoInfo.owner || ghStatus.repo?.split('/')[0] || '';
                            const defaultContent = hasExisting ? existingContent : `# CODEOWNERS â€” auto-assign reviewers for pull requests\n# Docs: https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners\n\n# Default owner for everything\n* @${esc(owner)}\n`;

                            if (hasExisting) {
                                html += `<div style="padding:0.4rem 0.65rem;background:var(--bg-inset);border:1px solid var(--success);border-radius:8px;margin-bottom:var(--space-sm)">
                                    <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.3rem">
                                        <span>âœ…</span>
                                        <span style="font-size:0.82rem;font-weight:500">CODEOWNERS exists</span>
                                        <span style="flex:1"></span>
                                        <button type="button" class="btn btn-xs btn-ghost" style="font-size:0.68rem"
                                            onclick="document.getElementById('co-editor-wrap').style.display=document.getElementById('co-editor-wrap').style.display==='none'?'block':'none'">âœï¸ Edit</button>
                                    </div>
                                    <div class="modal-preview" style="max-height:120px;overflow-y:auto;font-size:0.72rem">
                                        <pre style="margin:0;white-space:pre-wrap;font-family:var(--font-mono);font-size:0.72rem;line-height:1.4">${esc(existingContent)}</pre>
                                    </div>
                                </div>`;
                            } else {
                                html += `<div style="padding:0.4rem 0.65rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:var(--space-sm)">
                                    <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.3rem">
                                        <span>ğŸ“</span>
                                        <span style="font-size:0.82rem;color:var(--text-muted)">No CODEOWNERS file found</span>
                                    </div>
                                </div>`;
                            }

                            html += `<div id="co-editor-wrap" style="${hasExisting ? 'display:none;' : ''}margin-bottom:var(--space-sm)">
                                <label class="modal-form-check" style="margin-bottom:var(--space-xs)">
                                    <input type="checkbox" id="mf-write-codeowners" ${hasExisting ? '' : 'checked'}>
                                    <span style="font-size:0.82rem">${hasExisting ? 'Update' : 'Create'} CODEOWNERS file</span>
                                </label>
                                <textarea id="mf-codeowners-content"
                                    class="modal-form-textarea" style="font-family:var(--font-mono);font-size:0.72rem;min-height:120px;width:100%;line-height:1.5"
                                >${esc(defaultContent)}</textarea>
                                <span class="modal-form-hint">File will be saved as <code>.github/CODEOWNERS</code>.</span>
                            </div>`;
                        }

                        // â”€â”€ Section B: Environment Alignment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        if (localEnvs.length > 0) {
                            html += wizSection('Environment Alignment',
                                'Align local environments (from Project Configuration) with GitHub deployment environments.');

                            html += `<div style="background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;overflow:hidden;margin-bottom:var(--space-sm)">`;

                            // Header row
                            html += `<div style="display:flex;align-items:center;padding:0.35rem 0.65rem;font-size:0.68rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border-subtle);background:color-mix(in srgb, var(--bg-tertiary) 40%, transparent)">
                                <span style="width:28px"></span>
                                <span style="flex:1">Local</span>
                                <span style="width:100px;text-align:center">GitHub</span>
                                <span style="width:90px;text-align:right">Action</span>
                            </div>`;

                            for (const env of localEnvs) {
                                const aligned = remoteEnvNames.includes(env.name.toLowerCase());
                                const icon = aligned ? 'âœ…' : 'â¬œ';
                                const ghLabel = aligned
                                    ? `<span style="color:var(--success)">âœ… exists</span>`
                                    : `<span style="color:var(--text-muted)">âŒ missing</span>`;
                                const action = aligned
                                    ? `<span style="font-size:0.72rem;color:var(--success)">aligned</span>`
                                    : `<label style="font-size:0.72rem;cursor:pointer;display:flex;align-items:center;gap:4px;justify-content:flex-end">
                                        <input type="checkbox" class="gh-env-create" data-env="${esc(env.name)}" checked
                                            style="width:13px;height:13px;accent-color:var(--accent)">
                                        Create
                                    </label>`;

                                html += `<div style="display:flex;align-items:center;padding:0.4rem 0.65rem;font-size:0.82rem;border-bottom:1px solid var(--border-subtle)">
                                    <span style="width:28px;text-align:center">${icon}</span>
                                    <span style="flex:1">
                                        <code style="font-size:0.8rem;font-weight:500">${esc(env.name)}</code>
                                        ${env.default ? '<span style="font-size:0.65rem;color:var(--warning);margin-left:4px">â­ default</span>' : ''}
                                    </span>
                                    <span style="width:100px;text-align:center;font-size:0.75rem">${ghLabel}</span>
                                    <span style="width:90px;text-align:right">${action}</span>
                                </div>`;
                            }

                            // Show extra remote envs not defined locally
                            const localNames = localEnvs.map(e => e.name.toLowerCase());
                            const extraRemote = (data._ghEnvData.environments || [])
                                .map(e => typeof e === 'string' ? e : e.name || String(e))
                                .filter(name => !localNames.includes(name.toLowerCase()));

                            for (const name of extraRemote) {
                                html += `<div style="display:flex;align-items:center;padding:0.4rem 0.65rem;font-size:0.82rem;border-bottom:1px solid var(--border-subtle);opacity:0.6">
                                    <span style="width:28px;text-align:center">â–</span>
                                    <span style="flex:1;color:var(--text-muted)">
                                        <code style="font-size:0.8rem">${esc(name)}</code>
                                        <span style="font-size:0.65rem;margin-left:4px">(GitHub only)</span>
                                    </span>
                                    <span style="width:100px;text-align:center;font-size:0.75rem"><span style="color:var(--success)">âœ… exists</span></span>
                                    <span style="width:90px;text-align:right;font-size:0.72rem;color:var(--text-muted)">â€”</span>
                                </div>`;
                            }

                            html += `</div>`;

                            html += `<div style="font-size:0.72rem;color:var(--text-muted);padding:0 0.25rem;margin-bottom:var(--space-sm)">
                                ğŸ’¡ Environments are defined in <strong>Project Configuration</strong>. Use the Wizard to add/remove them.
                            </div>`;
                        } else {
                            html += wizSection('Environments',
                                'No environments defined in your project configuration.');
                            html += `<div style="font-size:0.78rem;color:var(--text-muted);padding:0.5rem 0">
                                ğŸ’¡ Go to the Wizard â†’ Step 1 (Project Configuration) to define environments like dev, staging, production.
                            </div>`;
                        }

                        // â”€â”€ Section C: Secrets Sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                        if (data._secretsAvailable) {
                            html += wizSection('Secrets Sync',
                                'Push local vault secrets to GitHub for CI/CD and deployments.');

                            const totalSecrets = data._totalSecrets;
                            const totalVars = data._totalVars;
                            const perEnvSecrets = data._perEnvSecrets;
                            const multiEnv = data._multiEnv;

                            html += `<div style="display:flex;gap:var(--space-sm);margin-bottom:var(--space-sm)">
                                <div style="flex:1;padding:0.5rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;text-align:center">
                                    <div style="font-size:1.2rem;font-weight:700">${totalSecrets}</div>
                                    <div style="font-size:0.68rem;color:var(--text-muted)">Secrets on GitHub</div>
                                </div>
                                <div style="flex:1;padding:0.5rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;text-align:center">
                                    <div style="font-size:1.2rem;font-weight:700">${totalVars}</div>
                                    <div style="font-size:0.68rem;color:var(--text-muted)">Variables on GitHub</div>
                                </div>
                            </div>`;

                            // Per-environment breakdown (multi-env) or repo-level list
                            for (const [envKey, envData] of Object.entries(perEnvSecrets)) {
                                const envLabel = envKey === '_repo' ? 'Repository' : envKey;
                                const secrets = envData.secrets || [];
                                const vars = envData.variables || [];
                                if (secrets.length === 0 && vars.length === 0) continue;

                                if (multiEnv) {
                                    html += `<div style="font-size:0.72rem;font-weight:600;color:var(--text-secondary);margin:var(--space-xs) 0 2px;text-transform:uppercase;letter-spacing:0.04em">
                                        ${esc(envLabel)} (${secrets.length}s / ${vars.length}v)</div>`;
                                }

                                html += `<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:var(--space-xs)">`;
                                for (const s of secrets) {
                                    const name = typeof s === 'string' ? s : s.name || String(s);
                                    html += `<span style="font-size:0.65rem;padding:0.1rem 0.35rem;border-radius:4px;background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)">ğŸ”’ ${esc(name)}</span>`;
                                }
                                for (const v of vars) {
                                    const name = typeof v === 'string' ? v : v.name || String(v);
                                    html += `<span style="font-size:0.65rem;padding:0.1rem 0.35rem;border-radius:4px;background:color-mix(in srgb, var(--accent) 10%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 25%, transparent)">ğŸ“‹ ${esc(name)}</span>`;
                                }
                                html += `</div>`;
                            }

                            html += `<div style="margin-top:var(--space-sm);padding:0.5rem 0.65rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px">
                                <label class="modal-form-check" style="margin:0">
                                    <input type="checkbox" id="mf-push-secrets">
                                    <span style="font-weight:500">Push local vault secrets to GitHub now</span>
                                </label>
                                <div style="font-size:0.72rem;color:var(--text-muted);margin-top:4px;padding-left:24px">
                                    Syncs all vault keys. Use the <strong>ğŸ” Secrets</strong> tab for granular per-key management.
                                </div>
                            </div>`;
                        }

                        el.innerHTML = html;
                    },
                    collect: (data) => {
                        // Collect which environments to create
                        const toCreate = [];
                        document.querySelectorAll('.gh-env-create:checked').forEach(cb => {
                            toCreate.push(cb.dataset.env);
                        });
                        data.envsToCreate = toCreate;
                        data.pushSecrets = document.getElementById('mf-push-secrets')?.checked || false;

                        // CODEOWNERS
                        const writeCodeowners = document.getElementById('mf-write-codeowners')?.checked || false;
                        if (writeCodeowners) {
                            const coContent = document.getElementById('mf-codeowners-content')?.value || '';
                            data.codeownersContent = coContent.trim();
                        } else {
                            data.codeownersContent = '';
                        }
                    },
                },

                // â”€â”€ Step 3: REVIEW & APPLY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                {
                    id: 'review', title: 'Review',
                    render: (data, el) => {
                        let html = wizSection('Review', 'Confirm the actions to perform.');
                        html += `<div style="display:flex;flex-direction:column;gap:0.4rem;margin-bottom:var(--space-md)">`;

                        // Repository
                        const ghRepo = data._ghStatus?.repo;
                        html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.35rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                            <span style="width:22px;text-align:center">${ghRepo ? 'âœ…' : 'âš ï¸'}</span>
                            <span style="flex:1">Repository: <strong>${ghRepo ? esc(ghRepo) : 'not linked'}</strong></span>
                            <span style="font-size:0.68rem;color:var(--text-muted)">${ghRepo ? 'âœ“' : ''}</span>
                        </div>`;

                        // Environments to create
                        if ((data.envsToCreate || []).length > 0) {
                            for (const env of data.envsToCreate) {
                                html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.35rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                    <span style="width:22px;text-align:center">ğŸ†•</span>
                                    <span style="flex:1">Create environment: <strong>${esc(env)}</strong></span>
                                    <span style="font-size:0.68rem;color:var(--accent)">NEW</span>
                                </div>`;
                            }
                        } else {
                            html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.35rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                <span style="width:22px;text-align:center">âœ…</span>
                                <span style="flex:1;color:var(--text-muted)">All environments aligned</span>
                                <span style="font-size:0.68rem;color:var(--success)">âœ“</span>
                            </div>`;
                        }

                        // Secrets push
                        html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.35rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                            <span style="width:22px;text-align:center">${data.pushSecrets ? 'â¬†' : 'âŠ˜'}</span>
                            <span style="flex:1">Secrets push: <strong>${data.pushSecrets ? 'vault â†’ GitHub' : 'skipped'}</strong></span>
                            <span style="font-size:0.68rem;color:${data.pushSecrets ? 'var(--accent)' : 'var(--text-muted)'}">${data.pushSecrets ? 'PUSH' : 'â€”'}</span>
                        </div>`;

                        // CODEOWNERS
                        if (data.codeownersContent) {
                            html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.35rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                <span style="width:22px;text-align:center">ğŸ“‹</span>
                                <span style="flex:1">Write CODEOWNERS: <strong>.github/CODEOWNERS</strong></span>
                                <span style="font-size:0.68rem;color:var(--accent)">WRITE</span>
                            </div>`;
                        }

                        html += `</div>`;

                        // Nothing to do?
                        const hasWork = (data.envsToCreate || []).length > 0 || data.pushSecrets || data.codeownersContent;
                        if (!hasWork) {
                            html += `<div style="text-align:center;padding:var(--space-sm);color:var(--success);font-size:0.85rem">
                                âœ… Everything is already aligned! Nothing to apply.
                            </div>`;
                        }
                        // Next integration hint
                        html += `<div style="margin-top:var(--space-md);padding:var(--space-xs) var(--space-sm);border-left:3px solid var(--accent);background:color-mix(in srgb, var(--accent) 5%, transparent);border-radius:0 6px 6px 0">
                            <div style="font-size:0.78rem;color:var(--text-secondary)">
                                ğŸ’¡ <strong>Next:</strong> Set up Docker to containerize your application.
                                <button class="btn btn-sm btn-ghost" style="font-size:0.72rem;padding:0.1rem 0.4rem;margin-left:4px;color:var(--accent)"
                                    onclick="wizardModalClose();setTimeout(openDockerSetupWizard,300)">Set up Docker â†’</button>
                            </div>
                        </div>`;

                        el.innerHTML = html;
                    },
                },
            ],

            onComplete: async (data) => {
                const envsToCreate = data.envsToCreate || [];
                const doPush = data.pushSecrets;
                const coContent = data.codeownersContent || '';
                const hasWork = envsToCreate.length > 0 || doPush || coContent;
                if (!hasWork) return;

                const parts = [];

                // 1. Create environments + write CODEOWNERS via setup_github
                if (envsToCreate.length > 0 || coContent) {
                    const payload = { action: 'setup_github' };
                    if (envsToCreate.length > 0) payload.create_environments = envsToCreate;
                    if (coContent) payload.codeowners_content = coContent;

                    const result = await apiPost('/wizard/setup', payload);
                    const r = result.results || {};
                    if ((r.environments_created || []).length > 0)
                        parts.push(`âœ… Created ${r.environments_created.length} env${r.environments_created.length !== 1 ? 's' : ''}: ${r.environments_created.join(', ')}`);
                    if ((r.environments_failed || []).length > 0)
                        parts.push(`âŒ Failed: ${r.environments_failed.map(f => f.name + ' (' + f.error + ')').join(', ')}`);
                    if (r.codeowners_written)
                        parts.push('âœ… CODEOWNERS written');
                }

                // 2. Push secrets â€” fetch vault keys and push like syncEnvToGithub
                if (doPush) {
                    try {
                        const localEnvs = data._localEnvs || [];
                        const multiEnv = localEnvs.length > 1;
                        const envNames = multiEnv ? localEnvs.map(e => e.name) : [''];

                        let totalPushed = 0;
                        for (const envName of envNames) {
                            const qs = envName ? `?env=${encodeURIComponent(envName)}` : '';
                            const keysData = await api(`/vault/keys${qs}`);
                            const keys = keysData.keys || [];

                            // Classify keys â€” secrets use sync_keys (backend reads .env),
                            // variables send values directly
                            const variables = {};
                            const syncKeys = [];
                            const AUTO = ['GITHUB_TOKEN', 'GITHUB_REPOSITORY'];
                            for (const k of keys) {
                                if (!k.has_value) continue;
                                if (AUTO.includes(k.key)) continue;
                                if (k.local_only) continue;
                                if (k.kind === 'secret') {
                                    syncKeys.push(k.key);
                                } else if (k.value) {
                                    variables[k.key] = k.value;
                                }
                            }

                            const count = syncKeys.length + Object.keys(variables).length;
                            if (count === 0) continue;

                            const pushResult = await api(`/secrets/push${qs}`, {
                                method: 'POST',
                                body: JSON.stringify({
                                    variables,
                                    sync_keys: syncKeys,
                                    push_to_github: true,
                                    save_to_env: false,
                                }),
                            });

                            if (pushResult.error) {
                                parts.push(`âŒ Secrets push${envName ? ` (${envName})` : ''}: ${pushResult.error}`);
                            } else {
                                const ok = (pushResult.results || []).filter(r => r.success).length;
                                totalPushed += ok;
                            }
                        }
                        if (totalPushed > 0) {
                            parts.push(`âœ… Pushed ${totalPushed} secret${totalPushed !== 1 ? 's' : ''} to GitHub`);
                        }
                    } catch (e) {
                        parts.push(`âŒ Secrets push failed: ${e.message}`);
                    }
                }

                if (parts.length > 0) toast(parts.join('\n'), 'success');

                // Invalidate caches
                _projectStatusTS = 0;
                wizInvalidate('gh:detect');
                wizInvalidate('detect');
                cardInvalidate('github');
                if (typeof loadGitHubCard === 'function') loadGitHubCard();
            },
            successMessage: 'GitHub configuration applied!',
            finishLabel: 'âœ… Apply Changes',
        });
    }

    // â”€â”€ Setup Modal Dispatcher â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Single function to open the right setup wizard by integration key.

    function openSetupWizard(key) {
        const wizards = {
            git: openGitSetupWizard,
            docker: openDockerSetupWizard,
            cicd: openCICDSetupWizard,
            k8s: openK8sSetupWizard,
            terraform: openTerraformSetupWizard,
            github: openGitHubSetupWizard,
            pages: () => {
                toast('Pages setup is available via the Pages card â€” check the Integrations tab.', 'info');
                switchTab('integrations');
            },
            dns: () => {
                toast('DNS configuration wizard coming soon.', 'info');
            },
        };
        const fn = wizards[key];
        if (fn) fn();
        else toast(`No setup wizard for "${key}" yet`, 'warn');
    }
</script>
