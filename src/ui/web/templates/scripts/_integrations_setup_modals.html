<!-- Integrations ‚Äî Setup Wizard Modals
     Standalone multi-step setup modals for each integration.
     Callable from: Integration cards, Wizard step 5, Dashboard progress.
     Depends on: _globals_wizard_modal.html, _globals.html (api, esc, toast)
-->
<script>

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // ‚îÄ‚îÄ Integration Setup Modals ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê



    // ‚îÄ‚îÄ Wizard detect cache banner ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Global flag: when true, detect steps add ?bust=1 to force server recompute
    window._wizForceRescan = false;

    function _wizDetectBanner(key) {
        const ageSec = wizAge(key);
        if (ageSec == null) return '';
        const stale = ageSec > 300; // > 5 min = red
        const ageColor = stale ? 'var(--danger)' : 'var(--text-muted)';
        return `<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:0.5rem">
            <span style="font-size:0.78rem;color:${ageColor}">Last scan: ${_formatAge(ageSec)}</span>
            <button type="button" class="btn btn-secondary" style="font-size:0.76rem;padding:0.2rem 0.6rem"
                onclick="wizInvalidate('${key}'); wizInvalidate('detect'); window._wizForceRescan = true; _wizModalRender();">üîÑ Re-scan</button>
        </div>`;
    }

    // ‚îÄ‚îÄ Shared Wizard Validation System ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Registry-based: validators are registered with a scope
    //   '*'  ‚Üí runs for any wizard prefix
    //   'k8s' ‚Üí runs only for K8s wizard
    //   'dk'  ‚Üí runs only for Docker wizard
    // Each validator fn(prefix) receives the active wizard prefix.
    window._wizValidation = {
        _validators: { '*': [], 'k8s': [], 'dk': [] },

        register: (scope, name, fn) => {
            if (!window._wizValidation._validators[scope])
                window._wizValidation._validators[scope] = [];
            window._wizValidation._validators[scope].push({ name, fn });
        },

        recheck: (prefix) => {
            const shared = window._wizValidation._validators['*'] || [];
            const specific = window._wizValidation._validators[prefix] || [];
            [...shared, ...specific].forEach(v => v.fn(prefix));
        }
    };

    // ‚îÄ‚îÄ Validator: Env Key Collision ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Scans ALL env rows in the active wizard, builds key‚Üíowners map,
    // marks duplicates. Direction-independent ‚Äî pure data scan.
    window._wizValidation.register('*', 'envCollision', (prefix) => {

        const svcNames = prefix === 'dk'
            ? (window._dkSvcNames || {})
            : (window._k8sSvcNames || {});

        // Collect key inputs from ACTIVE env list containers only.
        // Each wizard has env lists with id: {prefix}-svc-env-list-{svcId}
        // Docker infra lists are only active when their checkbox is checked.
        // K8s hidden cards (companion source) are skipped via card display check.
        const keyInputs = [];
        const svcKeyPfx = prefix + '-svc-env-key-';
        const listPfx = prefix + '-svc-env-list-';

        document.querySelectorAll('[id^="' + listPfx + '"]').forEach(list => {
            const svcPart = list.id.substring(listPfx.length);

            // Docker: skip unchecked infra services
            if (prefix === 'dk' && svcPart.startsWith('infra-')) {
                const infraKey = svcPart.substring(6);
                const chk = document.getElementById('mf-dk-infra-' + infraKey);
                if (!chk || !chk.checked) return;
            }

            // K8s: skip env lists inside hidden service cards (moved-into companions)
            if (prefix === 'k8s') {
                const card = list.closest('[id^="k8s-mod-card-"]');
                if (card && card.style.display === 'none') return;
            }

            list.querySelectorAll('[id^="' + svcKeyPfx + '"]').forEach(el => keyInputs.push(el));
        });

        // K8s: also collect from companion-specific env lists (from _k8sAddCompEnv)
        if (prefix === 'k8s') {
            document.querySelectorAll('[id^="k8s-comp-env-list-"]').forEach(list => {
                list.querySelectorAll('[id^="k8s-comp-env-key-"]').forEach(el => keyInputs.push(el));
            });
        }

        // Stamp any inputs that have values but no timestamp yet.
        // This captures pre-populated keys (infra, saved state) on their first recheck.
        keyInputs.forEach(el => {
            if (el.value.trim() && !el.dataset.envTs) el.dataset.envTs = Date.now();
        });

        // Phase 1: Build key ‚Üí owners map
        const keyMap = {};
        const svcKeyPrefix = prefix + '-svc-env-key-';
        const compKeyPrefix = prefix + '-comp-env-key-';

        keyInputs.forEach(el => {
            const key = el.value.trim().toUpperCase();
            if (!key) return;
            let svcId, j;
            if (el.id.startsWith(compKeyPrefix)) {
                const suffix = el.id.substring(compKeyPrefix.length);
                const lastDash = suffix.lastIndexOf('-');
                j = suffix.substring(lastDash + 1);
                svcId = 'comp-' + suffix.substring(0, lastDash);
            } else {
                const suffix = el.id.substring(svcKeyPrefix.length);
                const lastDash = suffix.lastIndexOf('-');
                svcId = suffix.substring(0, lastDash);
                j = suffix.substring(lastDash + 1);
            }
            if (!keyMap[key]) keyMap[key] = [];
            keyMap[key].push({ svcId, j, el });
        });

        // Phase 2: For each input, show/hide dupe warning + manage elsewhere
        keyInputs.forEach(el => {
            const key = el.value.trim().toUpperCase();
            let svcId, j, dupeElId;
            if (el.id.startsWith(compKeyPrefix)) {
                const suffix = el.id.substring(compKeyPrefix.length);
                const lastDash = suffix.lastIndexOf('-');
                j = suffix.substring(lastDash + 1);
                svcId = 'comp-' + suffix.substring(0, lastDash);
                dupeElId = prefix + '-comp-env-dupe-' + suffix;
            } else {
                const suffix = el.id.substring(svcKeyPrefix.length);
                const lastDash = suffix.lastIndexOf('-');
                svcId = suffix.substring(0, lastDash);
                j = suffix.substring(lastDash + 1);
                dupeElId = prefix + '-svc-env-dupe-' + svcId + '-' + j;
            }
            const dupeEl = document.getElementById(dupeElId);
            if (!dupeEl) return;
            const matches = keyMap[key] || [];
            // Helper: hide/restore vault notice when collision is present
            const _setElsewhere = (show, ownerSvcId) => {
                const ntc = document.getElementById(prefix + '-svc-env-notice-' + svcId + '-' + j);
                if (!ntc) return;
                if (show) {
                    if (!ntc.hidden) {
                        ntc.dataset.hiddenByCollision = '1';
                        ntc.hidden = true;
                    }
                } else {
                    if (ntc.dataset.hiddenByCollision) {
                        delete ntc.dataset.hiddenByCollision;
                        ntc.hidden = false;
                        // Restore creation form
                        const vb = document.getElementById(prefix + '-svc-env-valbox-' + svcId + '-' + j);
                        const ew = document.getElementById(prefix + '-svc-env-elsewhere-' + svcId + '-' + j);
                        const cr = document.getElementById(prefix + '-svc-env-create-' + svcId + '-' + j);
                        if (vb) vb.style.display = 'flex';
                        if (cr) { cr.checked = true; cr.disabled = false; }
                        if (ew) ew.hidden = true;
                    }
                }
            };
            if (matches.length <= 1 || !key) {
                dupeEl.hidden = true;
                el.style.borderColor = '';
                _setElsewhere(false);
                return;
            }
            const others = matches.filter(m => !(m.svcId === svcId && m.j === j));
            const sameService = others.filter(m => m.svcId === svcId);
            const crossService = others.filter(m => m.svcId !== svcId);
            if (sameService.length > 0) {
                // Same-service duplicate: always show on BOTH sides (real error)
                dupeEl.innerHTML = '‚ö†Ô∏è <strong>Duplicate key</strong> on same service';
                dupeEl.style.cssText = 'font-size:0.76rem;margin:1px 0 3px;padding:3px 6px;border-radius:4px;color:var(--error,#e05252);background:rgba(224,82,82,0.06);border:1px solid rgba(224,82,82,0.15)';
                el.style.borderColor = 'var(--error, #e05252)';
                dupeEl.hidden = false;
            } else if (crossService.length > 0) {
                // Cross-service: only the NEWER input gets the warning (temporal order)
                const myTs = parseInt(el.dataset.envTs || '0');
                const earliest = crossService.reduce((best, m) => {
                    const mTs = parseInt(m.el.dataset.envTs || '0');
                    const bTs = parseInt(best.el.dataset.envTs || '0');
                    if (mTs < bTs) return m;
                    if (mTs === bTs) return keyInputs.indexOf(m.el) < keyInputs.indexOf(best.el) ? m : best;
                    return best;
                });
                const eTs = parseInt(earliest.el.dataset.envTs || '0');
                if (myTs > eTs || (myTs === eTs && keyInputs.indexOf(el) > keyInputs.indexOf(earliest.el))) {
                    // I'm newer ‚Äî show collision + vault creation handled by owner
                    const names = [...new Set(crossService.map(m => svcNames[m.svcId] || m.svcId))];
                    dupeEl.innerHTML = '‚ÑπÔ∏è Also defined on: <strong>' + names.join('</strong>, <strong>') + '</strong>';
                    dupeEl.style.cssText = 'font-size:0.76rem;margin:1px 0 3px;padding:3px 6px;border-radius:4px;color:var(--warning,#e8a820);background:rgba(232,168,32,0.06);border:1px solid rgba(232,168,32,0.15)';
                    el.style.borderColor = 'var(--warning, #e8a820)';
                    dupeEl.hidden = false;
                    _setElsewhere(true, earliest.svcId);
                } else {
                    // I'm the owner ‚Äî no collision warning, keep my creation form
                    dupeEl.hidden = true;
                    el.style.borderColor = '';
                    _setElsewhere(false);
                }
            } else {
                dupeEl.hidden = true;
                el.style.borderColor = '';
                _setElsewhere(false);
            }
        });
    });

    // ‚îÄ‚îÄ Git Setup Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function openGitSetupWizard() {
        wizardModalOpen({
            title: 'üîÄ Git Setup',
            size: 'wide',
            steps: [
                // ‚îÄ‚îÄ Step 1: DETECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // ‚îÄ‚îÄ Serve from cache if available (instant, zero API calls) ‚îÄ‚îÄ
                        const _CK = 'git:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // ‚îÄ‚îÄ Fresh scan ‚îÄ‚îÄ
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Analyzing your project‚Ä¶</p>';
                        try {
                            // ONE call: wizDetect is the one-stop-shop (cached server-side)
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;

                            const probes = wizDetect.status_probes || {};
                            const git = probes.git || {};
                            data._git = git;
                            data._tools = wizDetect.tools || {};
                            data._gitignoreAnalysis = wizDetect.gitignore_analysis || { exists: false, coverage: 0, missing_patterns: [] };
                            data._ghStatus = wizDetect.gh_cli_status || { available: false };
                            data._gitRemotes = (wizDetect.git_remotes || {}).remotes || [];
                            data._projectStatus = { integrations: probes };
                            const gitignoreAnalysis = data._gitignoreAnalysis;
                            const ghStatus = data._ghStatus;
                            const gitRemotes = data._gitRemotes;

                            // Detect lint tools for hook suggestion
                            const lintTools = [];
                            if (data._tools.ruff) lintTools.push('ruff');
                            if (data._tools.mypy) lintTools.push('mypy');
                            if (data._tools.eslint || data._tools.npm) lintTools.push('eslint');
                            data._lintTools = lintTools;

                            // Version display
                            const gitVer = git.git_version ? `v${git.git_version}` : '';

                            // Build status rows
                            let html = `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;margin-bottom:var(--space-sm);font-size:0.82rem;background:color-mix(in srgb, var(--accent) 10%, var(--bg-inset));border:1px solid color-mix(in srgb, var(--accent) 30%, transparent);border-radius:8px">
                                <span style="font-size:1.1rem">üîç</span>
                                <span style="flex:1;color:var(--text-secondary)">This is a <strong>read-only scan</strong>. To manage remotes, branch, and settings, proceed to Configure.</span>
                                <button type="button" class="btn btn-xs" style="background:var(--accent);color:white;border:none;padding:4px 12px;border-radius:6px;font-size:0.78rem;white-space:nowrap;cursor:pointer"
                                    onclick="document.getElementById('wiz-btn-next')?.click()">Configure ‚Üí</button>
                            </div>`;
                            html += wizSection('Git Repository', 'Current Git configuration detected in this project.');
                            html += '<div class="wiz-status-grid">';
                            html += wizStatusRow('‚öôÔ∏è', 'Git CLI',
                                data._tools.git ? `Installed ${gitVer ? '(' + gitVer + ')' : ''}` : 'Not found',
                                data._tools.git ? 'ok' : 'error');
                            html += wizStatusRow('üìÅ', 'Repository',
                                git.initialized ? `Initialized (branch: ${git.branch || 'n/a'})` : 'Not initialized',
                                git.initialized ? 'ok' : 'error');
                            // Remotes ‚Äî show each one
                            if (gitRemotes.length > 0) {
                                for (const r of gitRemotes) {
                                    const shortUrl = (r.fetch || r.push || '').replace(/^https?:\/\//, '').replace(/\.git$/, '');
                                    html += wizStatusRow('üåê', `Remote: ${r.name}`, shortUrl, 'ok');
                                }
                            } else {
                                html += wizStatusRow('üåê', 'Remote', 'Not configured', 'warn');
                            }
                            html += wizStatusRow('üìÑ', '.gitignore',
                                git.has_gitignore
                                  ? `Present (${Math.round((gitignoreAnalysis.coverage || 0) * 100)}% coverage)`
                                  : 'Missing',
                                git.has_gitignore ? (gitignoreAnalysis.coverage >= 0.9 ? 'ok' : 'warn') : 'error');
                            html += wizStatusRow('ü™ù', 'Hooks',
                                git.hook_count > 0 ? `${git.hook_count} active (${git.hooks.join(', ')})` : 'None configured',
                                git.hook_count > 0 ? 'ok' : 'muted');
                            html += wizStatusRow('üêô', 'gh CLI',
                                ghStatus.available !== false
                                  ? (ghStatus.authenticated ? `Authenticated${ghStatus.repo ? ' ‚Äî ' + ghStatus.repo : ''}` : 'Installed but not authenticated')
                                  : 'Not installed',
                                ghStatus.authenticated ? 'ok' : 'muted');
                            html += '</div>';



                            // Context hints
                            const hints = [];
                            // Get module/stack info from project status
                            const proj = (data._projectStatus?.integrations || {}).project;
                            if (proj && proj.modules > 0) {
                                // Try to get stack names from wizard detect
                                const stacks = wizDetect.detected_stacks || [];
                                if (stacks.length > 0) {
                                    hints.push(`üì¶ Detected stacks: <strong>${esc(stacks.join(', '))}</strong>`);
                                }
                            }
                            if (!git.has_gitignore) {
                                hints.push('üí° We\'ll generate a stack-aware .gitignore for your project.');
                            } else if (gitignoreAnalysis.missing_count > 0) {
                                hints.push(`‚ö†Ô∏è Your .gitignore is missing <strong>${gitignoreAnalysis.missing_count}</strong> recommended pattern(s).`);
                            }
                            if (!git.initialized) {
                                hints.push('üí° We\'ll initialize a Git repository for you.');
                            }
                            if (lintTools.length > 0) {
                                hints.push(`üîß Lint tools detected: <strong>${lintTools.join(', ')}</strong>. We can set up a pre-commit hook.`);
                            }

                            if (hints.length > 0) {
                                html += `<div class="wiz-hint-box" style="margin-top:var(--space-md);padding:var(--space-sm) var(--space-md);background:var(--bg-card);border-radius:var(--radius-sm);border:1px solid var(--border-subtle)">`
                                    + hints.map(h => `<div style="padding:2px 0;font-size:0.82rem;color:var(--text-secondary)">${h}</div>`).join('')
                                    + '</div>';
                            }

                            // Store complete detect result in cache
                            wizStore(_CK, { h: html, d: { _git: data._git, _tools: data._tools, _gitignoreAnalysis: data._gitignoreAnalysis, _ghStatus: data._ghStatus, _gitRemotes: data._gitRemotes, _projectStatus: data._projectStatus, _lintTools: data._lintTools } }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>‚ö†Ô∏è</span><span>Failed to detect Git status: ${esc(e.message)}</span></div>`;
                        }
                    }
                },
                // ‚îÄ‚îÄ Step 2: CONFIGURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'config', title: 'Configure',
                    render: async (data, el) => {
                        const git = data._git || {};
                        const ghStatus = data._ghStatus || {};
                        const giAnalysis = data._gitignoreAnalysis || {};
                        const lintTools = data._lintTools || [];

                        // Always live-fetch remotes so mutations (add/remove/change URL) reflect instantly
                        let gitRemotes = data._gitRemotes || [];
                        try {
                            const freshRemotes = await api('/git/remotes');
                            if (Array.isArray(freshRemotes.remotes)) {
                                gitRemotes = freshRemotes.remotes;
                                data._gitRemotes = gitRemotes;  // update shared data
                            }
                        } catch(e) { /* fall back to cached */ }

                        let html = '';

                        // ‚îÄ‚îÄ Section A: Remotes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        html += wizSection('Remotes', 'Manage remote connections for push/pull operations.');

                        // Current remotes table
                        if (gitRemotes.length > 0) {
                            html += `<div style="background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;overflow:hidden;margin-bottom:var(--space-sm)">`;
                            // Header
                            html += `<div style="display:flex;align-items:center;padding:0.3rem 0.65rem;font-size:0.65rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border-subtle);background:color-mix(in srgb, var(--bg-tertiary) 40%, transparent)">
                                <span style="width:80px">Name</span>
                                <span style="flex:1">URL</span>
                                <span style="width:120px;text-align:right">Actions</span>
                            </div>`;
                            for (const r of gitRemotes) {
                                const url = r.fetch || r.push || '';
                                const shortUrl = url.replace(/^https?:\/\//, '').replace(/\.git$/, '');
                                const rId = r.name.replace(/[^a-zA-Z0-9]/g, '_');
                                html += `<div style="display:flex;align-items:center;padding:0.4rem 0.65rem;font-size:0.82rem;border-bottom:1px solid var(--border-subtle)" id="remote-row-${rId}">
                                    <span style="width:80px;font-weight:600"><code style="font-size:0.8rem">${esc(r.name)}</code></span>
                                    <span style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">
                                        <code style="font-size:0.75rem;color:var(--text-secondary)">${esc(shortUrl)}</code>
                                    </span>
                                    <span style="width:120px;display:flex;gap:4px;justify-content:flex-end">
                                        <button type="button" class="btn btn-xs btn-secondary" style="font-size:0.65rem;padding:1px 6px"
                                            onclick="(async()=>{
                                                try{
                                                    const newUrl=prompt('New URL for remote \\'${esc(r.name)}\\':', '${esc(url).replace(/'/g,"\\'")}');
                                                    if(!newUrl||newUrl==='${esc(url).replace(/'/g,"\\'")}')return;
                                                    await apiPost('/git/remote/set-url',{name:'${esc(r.name)}',url:newUrl});
                                                    toast('‚úÖ Remote URL updated','success');wizInvalidate('git:detect');wizInvalidate('detect');_wizModalRender();
                                                }catch(e){toast('‚ùå '+e.message,'error')}
                                            })()">‚úèÔ∏è URL</button>
                                        <button type="button" class="btn btn-xs btn-secondary" style="font-size:0.65rem;padding:1px 6px;color:var(--error)"
                                            onclick="if(!this.dataset.c){this.textContent='Sure?';this.dataset.c='1';setTimeout(()=>{this.textContent='üóë';delete this.dataset.c},2500);return}
                                            (async()=>{
                                                try{
                                                    await apiPost('/git/remote/remove',{name:'${esc(r.name)}'});
                                                    toast('‚úÖ Remote removed','success');wizInvalidate('git:detect');wizInvalidate('detect');_wizModalRender();
                                                }catch(e){toast('‚ùå '+e.message,'error')}
                                            })()">üóë</button>
                                    </span>
                                </div>`;
                            }
                            html += `</div>`;
                        } else {
                            html += `<div style="padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.82rem;color:var(--text-muted);margin-bottom:var(--space-sm)">
                                No remotes configured. Add one below.
                            </div>`;
                        }

                        // Add remote form
                        html += `<div style="background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;padding:0.5rem 0.65rem;margin-bottom:var(--space-sm)">
                            <div style="font-size:0.72rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:0.4rem">Add Remote</div>
                            <div style="display:flex;gap:0.4rem;align-items:center">
                                <input type="text" id="mf-add-remote-name" class="modal-form-input" style="width:90px;font-size:0.82rem;padding:4px 8px"
                                    placeholder="${gitRemotes.length === 0 ? 'origin' : 'upstream'}" value="">
                                <input type="text" id="mf-add-remote-url" class="modal-form-input" style="flex:1;font-size:0.82rem;padding:4px 8px"
                                    placeholder="https://github.com/user/repo.git"
                                    ${ghStatus.authenticated && ghStatus.repo && gitRemotes.length === 0 ? `value="https://github.com/${ghStatus.repo}.git"` : ''}>
                                <button type="button" class="btn btn-xs" id="git-add-remote-btn"
                                    style="font-size:0.75rem;padding:3px 10px;background:var(--accent);color:white;border:none;border-radius:6px;white-space:nowrap"
                                    onclick="(async()=>{
                                        const btn=document.getElementById('git-add-remote-btn');
                                        const name=document.getElementById('mf-add-remote-name').value.trim()||'${gitRemotes.length === 0 ? 'origin' : 'upstream'}';
                                        const url=document.getElementById('mf-add-remote-url').value.trim();
                                        if(!url){toast('Enter a remote URL','warn');return}
                                        btn.disabled=true;btn.textContent='Adding‚Ä¶';
                                        try{
                                            await apiPost('/git/remote/add',{name,url});
                                            toast('‚úÖ Remote \\'' +name+ '\\' added','success');wizInvalidate('git:detect');wizInvalidate('detect');_wizModalRender();
                                        }catch(e){toast('‚ùå '+e.message,'error');btn.disabled=false;btn.textContent='Ôºã Add'}
                                    })()">Ôºã Add</button>
                            </div>
                            ${ghStatus.authenticated && ghStatus.repo && gitRemotes.length === 0
                                ? `<div style="font-size:0.7rem;color:var(--text-muted);margin-top:4px">üêô Pre-filled from GitHub CLI: ${esc(ghStatus.repo)}</div>`
                                : ''}
                        </div>`;

                        // ‚îÄ‚îÄ Section B: Default Branch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        html += wizSection('Default Branch', '');
                        html += wizFormGrid([
                            { name: 'git-branch', label: 'Branch name',
                              value: git.branch || 'main', placeholder: 'main',
                              hint: git.branch ? `Current: ${git.branch}` : 'Will be set on init.' },
                        ]);

                        // ‚îÄ‚îÄ Section C: .gitignore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        html += wizSection('.gitignore', 'Stack-aware patterns to protect your repository.');

                        if (git.has_gitignore && giAnalysis.missing_count === 0) {
                            // Already complete
                            html += `<div class="wiz-info-row" style="padding:var(--space-sm);background:var(--bg-card);border-radius:var(--radius-sm);border:1px solid var(--border-subtle);font-size:0.82rem;color:var(--text-secondary);margin-bottom:var(--space-md)">
                                ‚úÖ Your .gitignore is complete ‚Äî ${giAnalysis.current_patterns} patterns, ${Math.round((giAnalysis.coverage || 0) * 100)}% coverage.
                            </div>`;
                            data._skipGitignore = true;
                        } else {
                            // Either missing or incomplete ‚Äî generate a preview
                            el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Generating .gitignore preview‚Ä¶</p>';

                            let gitignoreContent = '';
                            try {
                                const genResult = await apiPost('/security/generate/gitignore', {});
                                if (genResult.ok && genResult.file) {
                                    gitignoreContent = genResult.file.content || '';
                                }
                            } catch (e) {
                                gitignoreContent = '# Failed to generate ‚Äî add patterns manually\n';
                            }
                            data._generatedGitignore = gitignoreContent;

                            if (git.has_gitignore) {
                                // Existing but incomplete
                                const missingList = (giAnalysis.missing_patterns || [])
                                    .map(p => `<span style="color:var(--error);font-size:0.78rem">‚ùå ${esc(p.pattern)}</span> <span style="color:var(--text-muted);font-size:0.72rem">(${esc(p.reason)})</span>`)
                                    .join('<br>');
                                html += `<div style="padding:var(--space-sm);background:var(--bg-card);border-radius:var(--radius-sm);border:1px solid var(--border-subtle);margin-bottom:var(--space-sm)">
                                    <div style="font-size:0.82rem;color:var(--warning);margin-bottom:var(--space-xs)">
                                        ‚ö†Ô∏è Your .gitignore is missing ${giAnalysis.missing_count} pattern(s):
                                    </div>
                                    <div style="padding-left:var(--space-sm)">${missingList}</div>
                                </div>`;
                                html += `<label class="modal-form-check full-width" style="margin-bottom:var(--space-sm)">
                                    <input type="checkbox" id="mf-gitignore-replace" checked>
                                    Replace with generated .gitignore (recommended)
                                </label>`;
                            } else {
                                html += `<label class="modal-form-check full-width" style="margin-bottom:var(--space-sm)">
                                    <input type="checkbox" id="mf-gitignore-create" checked>
                                    Create .gitignore
                                </label>`;
                            }

                            // Count patterns for display
                            const patCount = gitignoreContent ? gitignoreContent.split('\n').filter(l => l.trim() && !l.trim().startsWith('#')).length : 0;

                            html += `<div style="margin-bottom:var(--space-sm)">
                                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-xs)">
                                    <span style="font-size:0.78rem;color:var(--text-muted)">üìã Preview (${patCount} patterns)</span>
                                    <button class="btn btn-xs btn-ghost" type="button" onclick="document.getElementById('gi-edit-wrap').style.display=document.getElementById('gi-edit-wrap').style.display==='none'?'block':'none'"
                                        style="font-size:0.7rem">‚úèÔ∏è Edit</button>
                                </div>
                                <div class="modal-preview" style="max-height:200px;overflow-y:auto">
                                    <div class="modal-preview-body" style="white-space:pre;font-family:var(--font-mono);font-size:0.72rem;line-height:1.5">${esc(gitignoreContent)}</div>
                                </div>
                                <div id="gi-edit-wrap" style="display:none;margin-top:var(--space-xs)">
                                    <textarea id="mf-gitignore-content"
                                        class="modal-form-textarea" style="font-family:var(--font-mono);font-size:0.72rem;min-height:200px;width:100%"
                                    >${esc(gitignoreContent)}</textarea>
                                    <span class="modal-form-hint">Edit the content above. Changes will be used when applying.</span>
                                </div>
                            </div>`;
                        }

                        // ‚îÄ‚îÄ Section D: Pre-commit hooks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        if (lintTools.length > 0 && git.hook_count === 0) {
                            html += wizSection('Pre-commit Hook', 'Run checks automatically before each commit.');
                            html += `<label class="modal-form-check full-width" style="margin-bottom:var(--space-xs)">
                                <input type="checkbox" id="mf-setup-hooks">
                                Set up pre-commit hook
                            </label>`;
                            html += `<div style="font-size:0.75rem;color:var(--text-muted);padding-left:1.5rem;margin-bottom:var(--space-sm)">
                                Will run: ${lintTools.map(t => `<code style="background:var(--bg-tertiary);padding:1px 4px;border-radius:3px">${esc(t)}</code>`).join(', ')} before each commit.
                            </div>`;
                        }

                        // ‚îÄ‚îÄ Section E: Initial commit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        if (git.commit_count === 0 || !git.initialized) {
                            html += wizSection('Initial Commit', '');
                            html += `<label class="modal-form-check full-width" style="margin-bottom:var(--space-xs)">
                                <input type="checkbox" id="mf-initial-commit">
                                Create initial commit after setup
                            </label>`;
                            html += wizFormGrid([
                                { name: 'commit-msg', label: 'Commit message',
                                  value: 'Initial commit', placeholder: 'Initial commit',
                                  hint: 'Only used if the checkbox above is checked.' },
                            ]);
                        }

                        el.innerHTML = html;
                    },
                    collect: (data) => {
                        // Remotes are managed live (instant API calls), no deferred collection needed
                        data.remote = '';
                        data.branch = mfVal('git-branch');
                        data.setupHooks = mfVal('setup-hooks');
                        data.createInitialCommit = mfVal('initial-commit');
                        data.commitMessage = mfVal('commit-msg') || 'Initial commit';

                        // .gitignore decision
                        if (data._skipGitignore) {
                            data.writeGitignore = false;
                        } else {
                            const createEl = document.getElementById('mf-gitignore-create');
                            const replaceEl = document.getElementById('mf-gitignore-replace');
                            data.writeGitignore = (createEl && createEl.checked) || (replaceEl && replaceEl.checked);

                            // Use edited content if available, otherwise generated
                            const editedEl = document.getElementById('mf-gitignore-content');
                            data.gitignoreContent = editedEl ? editedEl.value : (data._generatedGitignore || '');
                        }
                    },
                },
                // ‚îÄ‚îÄ Step 3: REVIEW & APPLY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'review', title: 'Review',
                    render: (data, el) => {
                        const git = data._git || {};
                        const actions = [];

                        if (!git.initialized) {
                            actions.push({ icon: 'üìÅ', label: 'Initialize Git repository', value: 'git init', status: 'new' });
                        }

                        const branchVal = data.branch || 'main';
                        if (git.branch && git.branch !== branchVal) {
                            actions.push({ icon: 'üåø', label: 'Rename branch', value: `${git.branch} ‚Üí ${branchVal}`, status: 'change' });
                        }

                        if (data.writeGitignore && data.gitignoreContent) {
                            const patCount = data.gitignoreContent.split('\n').filter(l => l.trim() && !l.trim().startsWith('#')).length;
                            const verb = git.has_gitignore ? 'Replace' : 'Create';
                            actions.push({ icon: 'üìÑ', label: `${verb} .gitignore`, value: `${patCount} patterns`, status: 'new' });
                        }

                        // Remotes ‚Äî already applied live, just show summary
                        const gitRemotes = data._gitRemotes || [];
                        if (gitRemotes.length > 0) {
                            actions.push({ icon: 'üåê', label: 'Remotes configured', value: gitRemotes.map(r => r.name).join(', '), status: 'ok' });
                        } else {
                            actions.push({ icon: 'üåê', label: 'No remotes', value: 'Add via Configure step', status: 'ok' });
                        }

                        if (data.setupHooks) {
                            const tools = (data._lintTools || []).join(', ');
                            actions.push({ icon: 'ü™ù', label: 'Install pre-commit hook', value: tools, status: 'new' });
                        }

                        if (data.createInitialCommit) {
                            actions.push({ icon: 'üíæ', label: 'Create initial commit', value: data.commitMessage, status: 'new' });
                        }

                        if (actions.length === 0) {
                            actions.push({ icon: '‚úÖ', label: 'Everything looks good', value: 'No changes needed', status: 'ok' });
                        }

                        const statusColors = { new: 'var(--success)', change: 'var(--warning)', ok: 'var(--text-muted)' };

                        let html = wizSection('Review Changes', 'The following actions will be performed when you click Finish.');
                        html += actions.map(a => `<div class="wiz-review-item" style="display:flex;gap:var(--space-sm);align-items:flex-start;padding:var(--space-sm) 0;border-bottom:1px solid var(--border-subtle)">
                            <span style="font-size:1.1rem;flex-shrink:0">${a.icon}</span>
                            <div style="flex:1;min-width:0">
                                <div style="font-size:0.85rem;font-weight:500;color:var(--text-primary)">${esc(a.label)}</div>
                                <div style="font-size:0.78rem;color:var(--text-muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(a.value)}</div>
                            </div>
                            <span style="font-size:0.7rem;padding:1px 6px;border-radius:8px;background:${statusColors[a.status] || 'var(--bg-tertiary)'};color:var(--bg-primary);flex-shrink:0">${a.status === 'new' ? 'NEW' : a.status === 'change' ? 'UPDATE' : '‚úì'}</span>
                        </div>`).join('');
                        // Next integration hint
                        html += `<div style="margin-top:var(--space-md);padding:var(--space-xs) var(--space-sm);border-left:3px solid var(--accent);background:color-mix(in srgb, var(--accent) 5%, transparent);border-radius:0 6px 6px 0">
                            <div style="font-size:0.78rem;color:var(--text-secondary)">
                                üí° <strong>Next:</strong> Set up GitHub to manage environments, secrets, and CI/CD.
                                <button class="btn btn-sm btn-ghost" style="font-size:0.72rem;padding:0.1rem 0.4rem;margin-left:4px;color:var(--accent)"
                                    onclick="wizardModalClose();setTimeout(openGitHubSetupWizard,300)">Set up GitHub ‚Üí</button>
                            </div>
                        </div>`;

                        el.innerHTML = html;
                    },
                },
            ],
            onComplete: async (data) => {
                const git = data._git || {};
                const payload = {
                    action: 'setup_git',
                };

                // Conditional fields ‚Äî only send what the user chose
                if (!git.initialized) {
                    payload._init = true; // covered by setup_git logic
                }

                const branchVal = data.branch || '';
                if (branchVal && git.branch !== branchVal) {
                    payload.default_branch = branchVal;
                }

                if (data.writeGitignore && data.gitignoreContent) {
                    payload.gitignore_content = data.gitignoreContent;
                }

                if (data.remote) {
                    payload.remote = data.remote;
                }

                // Remotes are managed live ‚Äî no deferred actions needed

                if (data.setupHooks && data._lintTools && data._lintTools.length > 0) {
                    payload.setup_hooks = true;
                    // Build hook commands from detected lint tools
                    const hookCmds = [];
                    if (data._lintTools.includes('ruff')) hookCmds.push('ruff check .');
                    if (data._lintTools.includes('mypy')) hookCmds.push('mypy src/');
                    if (data._lintTools.includes('eslint')) hookCmds.push('npx eslint .');
                    payload.hook_commands = hookCmds;
                }

                if (data.createInitialCommit) {
                    payload.create_initial_commit = true;
                    payload.commit_message = data.commitMessage || 'Initial commit';
                }

                const result = await apiPost('/wizard/setup', payload);

                if (!result.ok) {
                    throw new Error(result.error || 'Setup failed');
                }

                // Show detailed results
                if (result.results && result.results.length > 0) {
                    const details = result.results.map(r => `‚úì ${r}`).join('\n');
                    toast(details, 'success', 5000);
                }

                // Invalidate caches
                _projectStatusTS = 0;
                wizInvalidate('git:detect');
                wizInvalidate('detect');
                cardInvalidate('git');
                // Reload git card if on Integrations tab
                if (typeof loadGitCard === 'function') {
                    setTimeout(() => loadGitCard(), 300);
                }
            },
            successMessage: 'Git repository configured!',
            finishLabel: '‚úÖ Apply Changes',
        });
    }

    // ‚îÄ‚îÄ Common infra services (categorised, configurable) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    //
    // Schema per service:
    //   key:       unique slug (used for element IDs, compose service name)
    //   label:     display name
    //   cat:       category key (matches _infraCategories)
    //   images:    string[]  ‚Äî image tag options (first = default)
    //   ports:     {port,label}[] ‚Äî exposed ports (first = primary)
    //   envFields: {key,label,default,required?,type?}[] ‚Äî configurable env vars
    //              type defaults to 'text'; 'password' masks input
    //   volumes:   {name,mount}[] ‚Äî named volumes (data persistence)
    //   command:   optional default command override
    //   note:      optional info string shown in config panel
    //
    const _infraOptions = [
        // ‚îÄ‚îÄ Databases: Relational ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        { key:'postgres', label:'PostgreSQL', cat:'db-rel',
          images:['postgres:16-alpine','postgres:16','postgres:15-alpine','postgres:15','postgres:14-alpine'],
          ports:[{port:5432,label:'PostgreSQL'}],
          envFields:[
              {key:'POSTGRES_DB',       label:'Database',  default:'app'},
              {key:'POSTGRES_USER',     label:'Username',  default:'app'},
              {key:'POSTGRES_PASSWORD', label:'Password',  default:'changeme', required:true, type:'password'},
          ],
          volumes:[{name:'pgdata',mount:'/var/lib/postgresql/data'}],
        },
        { key:'mysql', label:'MySQL', cat:'db-rel',
          images:['mysql:8','mysql:8.4','mysql:8.0'],
          ports:[{port:3306,label:'MySQL'}],
          envFields:[
              {key:'MYSQL_ROOT_PASSWORD', label:'Root password', default:'changeme', required:true, type:'password'},
              {key:'MYSQL_DATABASE',      label:'Database',      default:'app'},
              {key:'MYSQL_USER',          label:'Username',      default:'app'},
              {key:'MYSQL_PASSWORD',      label:'User password', default:'changeme', type:'password'},
          ],
          volumes:[{name:'mysqldata',mount:'/var/lib/mysql'}],
        },
        { key:'mariadb', label:'MariaDB', cat:'db-rel',
          images:['mariadb:11','mariadb:10.11','mariadb:10.6'],
          ports:[{port:3306,label:'MariaDB'}],
          envFields:[
              {key:'MARIADB_ROOT_PASSWORD', label:'Root password', default:'changeme', required:true, type:'password'},
              {key:'MARIADB_DATABASE',      label:'Database',      default:'app'},
              {key:'MARIADB_USER',          label:'Username',      default:'app'},
              {key:'MARIADB_PASSWORD',      label:'User password', default:'changeme', type:'password'},
          ],
          volumes:[{name:'mariadbdata',mount:'/var/lib/mysql'}],
        },
        { key:'mssql', label:'SQL Server', cat:'db-rel',
          images:['mcr.microsoft.com/mssql/server:2022-latest','mcr.microsoft.com/mssql/server:2019-latest'],
          ports:[{port:1433,label:'SQL Server'}],
          envFields:[
              {key:'ACCEPT_EULA',       label:'Accept EULA',  default:'Y', required:true},
              {key:'MSSQL_SA_PASSWORD', label:'SA password',  default:'YourStrong!Passw0rd', required:true, type:'password'},
          ],
          volumes:[{name:'mssqldata',mount:'/var/opt/mssql'}],
        },
        { key:'cockroachdb', label:'CockroachDB', cat:'db-rel',
          images:['cockroachdb/cockroach:latest','cockroachdb/cockroach:v23.2.0'],
          ports:[{port:26257,label:'SQL'},{port:8080,label:'Admin UI'}],
          envFields:[],
          volumes:[{name:'crdbdata',mount:'/cockroach/cockroach-data'}],
          command:'start-single-node --insecure',
        },

        // ‚îÄ‚îÄ Databases: NoSQL / Document / Graph ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        { key:'mongo', label:'MongoDB', cat:'db-nosql',
          images:['mongo:7','mongo:6','mongo:5'],
          ports:[{port:27017,label:'MongoDB'}],
          envFields:[
              {key:'MONGO_INITDB_ROOT_USERNAME', label:'Root user',     default:'root'},
              {key:'MONGO_INITDB_ROOT_PASSWORD', label:'Root password', default:'changeme', type:'password'},
              {key:'MONGO_INITDB_DATABASE',      label:'Init database', default:'app'},
          ],
          volumes:[{name:'mongodata',mount:'/data/db'}],
        },
        { key:'cassandra', label:'Cassandra', cat:'db-nosql',
          images:['cassandra:4','cassandra:3.11'],
          ports:[{port:9042,label:'CQL'}],
          envFields:[
              {key:'CASSANDRA_CLUSTER_NAME', label:'Cluster name', default:'MyCluster'},
          ],
          volumes:[{name:'cassandradata',mount:'/var/lib/cassandra'}],
        },
        { key:'couchdb', label:'CouchDB', cat:'db-nosql',
          images:['couchdb:3','couchdb:3.3'],
          ports:[{port:5984,label:'HTTP API'}],
          envFields:[
              {key:'COUCHDB_USER',     label:'Admin user',     default:'admin'},
              {key:'COUCHDB_PASSWORD', label:'Admin password', default:'changeme', required:true, type:'password'},
          ],
          volumes:[{name:'couchdbdata',mount:'/opt/couchdb/data'}],
        },
        { key:'neo4j', label:'Neo4j', cat:'db-nosql',
          images:['neo4j:5','neo4j:5-community','neo4j:4.4'],
          ports:[{port:7474,label:'Browser'},{port:7687,label:'Bolt'}],
          envFields:[
              {key:'NEO4J_AUTH', label:'Auth (user/pass)', default:'neo4j/changeme', required:true},
          ],
          volumes:[{name:'neo4jdata',mount:'/data'}],
        },
        { key:'arangodb', label:'ArangoDB', cat:'db-nosql',
          images:['arangodb:3.11','arangodb:3.10'],
          ports:[{port:8529,label:'HTTP API'}],
          envFields:[
              {key:'ARANGO_ROOT_PASSWORD', label:'Root password', default:'changeme', required:true, type:'password'},
          ],
          volumes:[{name:'arangodata',mount:'/var/lib/arangodb3'}],
        },
        { key:'dynamodb', label:'DynamoDB Local', cat:'db-nosql',
          images:['amazon/dynamodb-local:latest'],
          ports:[{port:8000,label:'DynamoDB'}],
          envFields:[],
          volumes:[],
          note:'Local dev emulator ‚Äî no auth needed',
        },
        { key:'influxdb', label:'InfluxDB', cat:'db-nosql',
          images:['influxdb:2','influxdb:2.7-alpine'],
          ports:[{port:8086,label:'HTTP API'}],
          envFields:[
              {key:'DOCKER_INFLUXDB_INIT_MODE',     label:'Init mode',     default:'setup'},
              {key:'DOCKER_INFLUXDB_INIT_USERNAME',  label:'Admin user',    default:'admin'},
              {key:'DOCKER_INFLUXDB_INIT_PASSWORD',  label:'Admin password',default:'changeme', required:true, type:'password'},
              {key:'DOCKER_INFLUXDB_INIT_ORG',       label:'Organization',  default:'myorg'},
              {key:'DOCKER_INFLUXDB_INIT_BUCKET',    label:'Bucket',        default:'mybucket'},
          ],
          volumes:[{name:'influxdata',mount:'/var/lib/influxdb2'}],
        },
        { key:'clickhouse', label:'ClickHouse', cat:'db-nosql',
          images:['clickhouse/clickhouse-server:latest','clickhouse/clickhouse-server:23.12'],
          ports:[{port:8123,label:'HTTP'},{port:9000,label:'Native'}],
          envFields:[
              {key:'CLICKHOUSE_DB',       label:'Database', default:'default'},
              {key:'CLICKHOUSE_USER',     label:'Username', default:'default'},
              {key:'CLICKHOUSE_PASSWORD', label:'Password', default:'', type:'password'},
          ],
          volumes:[{name:'clickhousedata',mount:'/var/lib/clickhouse'}],
        },
        { key:'timescaledb', label:'TimescaleDB', cat:'db-nosql',
          images:['timescale/timescaledb:latest-pg16','timescale/timescaledb:latest-pg15'],
          ports:[{port:5432,label:'PostgreSQL'}],
          envFields:[
              {key:'POSTGRES_DB',       label:'Database', default:'app'},
              {key:'POSTGRES_USER',     label:'Username', default:'postgres'},
              {key:'POSTGRES_PASSWORD', label:'Password', default:'changeme', required:true, type:'password'},
          ],
          volumes:[{name:'timescaledata',mount:'/var/lib/postgresql/data'}],
        },
        { key:'surrealdb', label:'SurrealDB', cat:'db-nosql',
          images:['surrealdb/surrealdb:latest','surrealdb/surrealdb:v1'],
          ports:[{port:8000,label:'HTTP'}],
          envFields:[
              {key:'SURREAL_USER', label:'Root user',     default:'root'},
              {key:'SURREAL_PASS', label:'Root password', default:'changeme', type:'password'},
          ],
          volumes:[{name:'surrealdata',mount:'/data'}],
          command:'start --user root --pass changeme file:/data/srdb.db',
        },

        // ‚îÄ‚îÄ Caches & Key-Value ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        { key:'redis', label:'Redis', cat:'cache',
          images:['redis:7-alpine','redis:7','redis:6-alpine'],
          ports:[{port:6379,label:'Redis'}],
          envFields:[],
          volumes:[{name:'redisdata',mount:'/data'}],
          note:'Add --requirepass &lt;pw&gt; to command for auth',
        },
        { key:'valkey', label:'Valkey', cat:'cache',
          images:['valkey/valkey:8-alpine','valkey/valkey:8','valkey/valkey:7-alpine'],
          ports:[{port:6379,label:'Valkey'}],
          envFields:[],
          volumes:[{name:'valkeydata',mount:'/data'}],
          note:'Redis-compatible fork by Linux Foundation',
        },
        { key:'keydb', label:'KeyDB', cat:'cache',
          images:['eqalpha/keydb:latest','eqalpha/keydb:alpine'],
          ports:[{port:6379,label:'KeyDB'}],
          envFields:[],
          volumes:[],
        },
        { key:'memcached', label:'Memcached', cat:'cache',
          images:['memcached:1-alpine','memcached:1'],
          ports:[{port:11211,label:'Memcached'}],
          envFields:[
              {key:'MEMCACHED_MAX_MEMORY', label:'Max memory (MB)', default:'64'},
          ],
          volumes:[],
          note:'In-memory only ‚Äî no persistence',
        },
        { key:'dragonfly', label:'Dragonfly', cat:'cache',
          images:['docker.dragonflydb.io/dragonflydb/dragonfly:latest'],
          ports:[{port:6379,label:'Dragonfly'}],
          envFields:[],
          volumes:[{name:'dragonflydata',mount:'/data'}],
          note:'Redis-compatible, multi-threaded',
        },
        { key:'etcd', label:'etcd', cat:'cache',
          images:['quay.io/coreos/etcd:v3.5.12','quay.io/coreos/etcd:latest'],
          ports:[{port:2379,label:'Client'},{port:2380,label:'Peer'}],
          envFields:[
              {key:'ETCD_ADVERTISE_CLIENT_URLS', label:'Advertise URL', default:'http://0.0.0.0:2379'},
              {key:'ETCD_LISTEN_CLIENT_URLS',    label:'Listen URL',    default:'http://0.0.0.0:2379'},
          ],
          volumes:[{name:'etcddata',mount:'/etcd-data'}],
        },

        // ‚îÄ‚îÄ Message Brokers & Queues ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        { key:'rabbitmq', label:'RabbitMQ', cat:'mq',
          images:['rabbitmq:3-management-alpine','rabbitmq:3-management','rabbitmq:3-alpine'],
          ports:[{port:5672,label:'AMQP'},{port:15672,label:'Management UI'}],
          envFields:[
              {key:'RABBITMQ_DEFAULT_USER',  label:'Admin user',     default:'guest'},
              {key:'RABBITMQ_DEFAULT_PASS',  label:'Admin password', default:'guest', type:'password'},
              {key:'RABBITMQ_DEFAULT_VHOST', label:'Default vhost',  default:'/'},
          ],
          volumes:[{name:'rabbitmqdata',mount:'/var/lib/rabbitmq'}],
        },
        { key:'kafka', label:'Kafka (KRaft)', cat:'mq',
          images:['apache/kafka:latest','apache/kafka:3.7.0','confluentinc/cp-kafka:7.6.0'],
          ports:[{port:9092,label:'Broker'}],
          envFields:[
              {key:'KAFKA_NODE_ID',                      label:'Node ID',            default:'1'},
              {key:'KAFKA_PROCESS_ROLES',                label:'Process roles',      default:'broker,controller'},
              {key:'KAFKA_LISTENERS',                    label:'Listeners',          default:'PLAINTEXT://:9092,CONTROLLER://:9093'},
              {key:'KAFKA_CONTROLLER_QUORUM_VOTERS',     label:'Quorum voters',      default:'1@localhost:9093'},
              {key:'KAFKA_CONTROLLER_LISTENER_NAMES',    label:'Controller listener',default:'CONTROLLER'},
              {key:'CLUSTER_ID',                         label:'Cluster ID',         default:'MkU3OEVBNTcwNTJENDM2Qk'},
          ],
          volumes:[{name:'kafkadata',mount:'/var/lib/kafka/data'}],
          note:'KRaft mode ‚Äî no ZooKeeper needed',
        },
        { key:'nats', label:'NATS', cat:'mq',
          images:['nats:2-alpine','nats:2','nats:latest'],
          ports:[{port:4222,label:'Client'},{port:8222,label:'Monitoring'}],
          envFields:[],
          volumes:[{name:'natsdata',mount:'/data'}],
        },
        { key:'mosquitto', label:'Mosquitto (MQTT)', cat:'mq',
          images:['eclipse-mosquitto:2','eclipse-mosquitto:latest'],
          ports:[{port:1883,label:'MQTT'},{port:9001,label:'WebSocket'}],
          envFields:[],
          volumes:[{name:'mosquittodata',mount:'/mosquitto/data'}],
          note:'Needs mosquitto.conf for listener config',
        },
        { key:'redpanda', label:'Redpanda', cat:'mq',
          images:['docker.redpanda.com/redpandadata/redpanda:latest','docker.redpanda.com/redpandadata/redpanda:v23.3.5'],
          ports:[{port:9092,label:'Kafka API'},{port:8081,label:'Schema Registry'},{port:8082,label:'Pandaproxy'}],
          envFields:[],
          volumes:[{name:'redpandadata',mount:'/var/lib/redpanda/data'}],
          command:'redpanda start --smp 1 --memory 512M --overprovisioned --kafka-addr 0.0.0.0:9092',
        },
        { key:'activemq', label:'ActiveMQ Artemis', cat:'mq',
          images:['apache/activemq-artemis:latest','apache/activemq-artemis:2.31.2'],
          ports:[{port:61616,label:'OpenWire'},{port:8161,label:'Web Console'}],
          envFields:[
              {key:'ARTEMIS_USER',     label:'Admin user',     default:'admin'},
              {key:'ARTEMIS_PASSWORD', label:'Admin password', default:'admin', type:'password'},
          ],
          volumes:[{name:'activemqdata',mount:'/var/lib/artemis-instance'}],
        },
        { key:'celery', label:'Celery Worker', cat:'mq',
          images:['python:3.12-slim','python:3.11-slim'],
          ports:[],
          envFields:[
              {key:'CELERY_BROKER_URL',     label:'Broker URL',     default:'redis://redis:6379/0'},
              {key:'CELERY_RESULT_BACKEND', label:'Result backend', default:'redis://redis:6379/1'},
          ],
          volumes:[],
          command:'celery -A tasks worker --loglevel=info',
          note:'Requires a broker service (Redis/RabbitMQ)',
        },

        // ‚îÄ‚îÄ Search & Analytics ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        { key:'elasticsearch', label:'Elasticsearch', cat:'search',
          images:['docker.elastic.co/elasticsearch/elasticsearch:8.13.0','docker.elastic.co/elasticsearch/elasticsearch:7.17.18'],
          ports:[{port:9200,label:'HTTP'},{port:9300,label:'Transport'}],
          envFields:[
              {key:'discovery.type',         label:'Discovery',        default:'single-node'},
              {key:'xpack.security.enabled', label:'Security',         default:'false'},
              {key:'ES_JAVA_OPTS',           label:'JVM heap',         default:'-Xms512m -Xmx512m'},
              {key:'ELASTIC_PASSWORD',       label:'elastic password', default:'changeme', type:'password'},
          ],
          volumes:[{name:'esdata',mount:'/usr/share/elasticsearch/data'}],
        },
        { key:'opensearch', label:'OpenSearch', cat:'search',
          images:['opensearchproject/opensearch:2','opensearchproject/opensearch:2.12.0'],
          ports:[{port:9200,label:'HTTP'},{port:9600,label:'Performance'}],
          envFields:[
              {key:'discovery.type',          label:'Discovery',        default:'single-node'},
              {key:'DISABLE_SECURITY_PLUGIN', label:'Disable security', default:'true'},
              {key:'OPENSEARCH_JAVA_OPTS',    label:'JVM heap',         default:'-Xms512m -Xmx512m'},
          ],
          volumes:[{name:'osdata',mount:'/usr/share/opensearch/data'}],
        },
        { key:'meilisearch', label:'Meilisearch', cat:'search',
          images:['getmeili/meilisearch:latest','getmeili/meilisearch:v1.6'],
          ports:[{port:7700,label:'HTTP'}],
          envFields:[
              {key:'MEILI_ENV',        label:'Environment', default:'development'},
              {key:'MEILI_MASTER_KEY', label:'Master key',  default:'changeme', type:'password'},
          ],
          volumes:[{name:'meilidata',mount:'/meili_data'}],
        },
        { key:'typesense', label:'Typesense', cat:'search',
          images:['typesense/typesense:27.1','typesense/typesense:26.0'],
          ports:[{port:8108,label:'HTTP'}],
          envFields:[
              {key:'TYPESENSE_API_KEY',  label:'API key',       default:'changeme', required:true, type:'password'},
              {key:'TYPESENSE_DATA_DIR', label:'Data directory', default:'/data'},
          ],
          volumes:[{name:'typesensedata',mount:'/data'}],
        },
        { key:'solr', label:'Apache Solr', cat:'search',
          images:['solr:9','solr:8'],
          ports:[{port:8983,label:'HTTP'}],
          envFields:[
              {key:'SOLR_JAVA_MEM', label:'JVM memory', default:'-Xms512m -Xmx512m'},
          ],
          volumes:[{name:'solrdata',mount:'/var/solr'}],
        },

        // ‚îÄ‚îÄ Reverse Proxies & Load Balancers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        { key:'nginx', label:'Nginx', cat:'proxy',
          images:['nginx:alpine','nginx:1-alpine','nginx:latest'],
          ports:[{port:80,label:'HTTP'},{port:443,label:'HTTPS'}],
          envFields:[],
          volumes:[],
          note:'Mount your nginx.conf via volumes',
        },
        { key:'traefik', label:'Traefik', cat:'proxy',
          images:['traefik:v3','traefik:v2','traefik:latest'],
          ports:[{port:80,label:'HTTP'},{port:443,label:'HTTPS'},{port:8080,label:'Dashboard'}],
          envFields:[],
          volumes:[{name:'/var/run/docker.sock',mount:'/var/run/docker.sock:ro'}],
          command:'--api.insecure=true --providers.docker=true',
          note:'Auto-discovers Docker containers',
        },
        { key:'caddy', label:'Caddy', cat:'proxy',
          images:['caddy:2-alpine','caddy:2','caddy:latest'],
          ports:[{port:80,label:'HTTP'},{port:443,label:'HTTPS'}],
          envFields:[],
          volumes:[{name:'caddydata',mount:'/data'},{name:'caddyconfig',mount:'/config'}],
          note:'Automatic HTTPS via Let\'s Encrypt',
        },
        { key:'haproxy', label:'HAProxy', cat:'proxy',
          images:['haproxy:2-alpine','haproxy:2','haproxy:lts-alpine'],
          ports:[{port:80,label:'HTTP'},{port:443,label:'HTTPS'},{port:8404,label:'Stats'}],
          envFields:[],
          volumes:[],
          note:'Mount your haproxy.cfg via volumes',
        },
        { key:'envoy', label:'Envoy', cat:'proxy',
          images:['envoyproxy/envoy:v1.30-latest','envoyproxy/envoy:v1.29-latest'],
          ports:[{port:10000,label:'Listener'},{port:9901,label:'Admin'}],
          envFields:[],
          volumes:[],
          note:'Mount envoy.yaml config via volumes',
        },

        // ‚îÄ‚îÄ Monitoring & Observability ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        { key:'prometheus', label:'Prometheus', cat:'monitor',
          images:['prom/prometheus:latest','prom/prometheus:v2.50.0'],
          ports:[{port:9090,label:'HTTP'}],
          envFields:[],
          volumes:[{name:'promdata',mount:'/prometheus'}],
          note:'Mount prometheus.yml config via volumes',
        },
        { key:'grafana', label:'Grafana', cat:'monitor',
          images:['grafana/grafana:latest','grafana/grafana:10-alpine','grafana/grafana-oss:latest'],
          ports:[{port:3000,label:'HTTP'}],
          envFields:[
              {key:'GF_SECURITY_ADMIN_USER',     label:'Admin user',     default:'admin'},
              {key:'GF_SECURITY_ADMIN_PASSWORD', label:'Admin password', default:'admin', required:true, type:'password'},
              {key:'GF_INSTALL_PLUGINS',         label:'Plugins',        default:''},
          ],
          volumes:[{name:'grafanadata',mount:'/var/lib/grafana'}],
        },
        { key:'jaeger', label:'Jaeger', cat:'monitor',
          images:['jaegertracing/all-in-one:latest','jaegertracing/all-in-one:1.54'],
          ports:[{port:16686,label:'UI'},{port:4317,label:'OTLP gRPC'},{port:4318,label:'OTLP HTTP'}],
          envFields:[
              {key:'COLLECTOR_OTLP_ENABLED', label:'OTLP enabled', default:'true'},
          ],
          volumes:[],
          note:'All-in-one dev image ‚Äî uses memory storage',
        },
        { key:'zipkin', label:'Zipkin', cat:'monitor',
          images:['openzipkin/zipkin:latest','openzipkin/zipkin:3'],
          ports:[{port:9411,label:'HTTP'}],
          envFields:[],
          volumes:[],
          note:'In-memory storage by default',
        },
        { key:'otel', label:'OpenTelemetry Collector', cat:'monitor',
          images:['otel/opentelemetry-collector:latest','otel/opentelemetry-collector-contrib:latest'],
          ports:[{port:4317,label:'OTLP gRPC'},{port:4318,label:'OTLP HTTP'},{port:8888,label:'Metrics'}],
          envFields:[],
          volumes:[],
          note:'Mount otel-config.yaml via volumes',
        },
        { key:'uptimekuma', label:'Uptime Kuma', cat:'monitor',
          images:['louislam/uptime-kuma:1','louislam/uptime-kuma:latest'],
          ports:[{port:3001,label:'HTTP'}],
          envFields:[],
          volumes:[{name:'uptimekuma',mount:'/app/data'}],
        },

        // ‚îÄ‚îÄ Logging ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        { key:'loki', label:'Loki', cat:'log',
          images:['grafana/loki:latest','grafana/loki:2.9.4'],
          ports:[{port:3100,label:'HTTP'}],
          envFields:[],
          volumes:[{name:'lokidata',mount:'/loki'}],
          note:'Use with Grafana for log visualization',
        },
        { key:'fluentd', label:'Fluentd', cat:'log',
          images:['fluentd:v1-debian','fluentd:v1-alpine','fluent/fluentd:latest'],
          ports:[{port:24224,label:'Forward'}],
          envFields:[],
          volumes:[],
          note:'Mount fluent.conf via volumes',
        },
        { key:'kibana', label:'Kibana', cat:'log',
          images:['docker.elastic.co/kibana/kibana:8.13.0','docker.elastic.co/kibana/kibana:7.17.18'],
          ports:[{port:5601,label:'HTTP'}],
          envFields:[
              {key:'ELASTICSEARCH_HOSTS', label:'Elasticsearch URL', default:'http://elasticsearch:9200', required:true},
          ],
          volumes:[],
          note:'Requires Elasticsearch service',
        },
        { key:'vector', label:'Vector', cat:'log',
          images:['timberio/vector:latest-alpine','timberio/vector:latest-debian'],
          ports:[{port:8383,label:'API'},{port:8686,label:'GraphQL'}],
          envFields:[],
          volumes:[],
          note:'Mount vector.toml config via volumes',
        },
        { key:'seq', label:'Seq', cat:'log',
          images:['datalust/seq:latest'],
          ports:[{port:5341,label:'Ingestion'},{port:80,label:'UI'}],
          envFields:[
              {key:'ACCEPT_EULA', label:'Accept EULA', default:'Y', required:true},
          ],
          volumes:[{name:'seqdata',mount:'/data'}],
        },

        // ‚îÄ‚îÄ Storage & Object Store ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        { key:'minio', label:'MinIO', cat:'storage',
          images:['minio/minio:latest','quay.io/minio/minio:latest'],
          ports:[{port:9000,label:'API'},{port:9001,label:'Console'}],
          envFields:[
              {key:'MINIO_ROOT_USER',     label:'Root user',     default:'minioadmin', required:true},
              {key:'MINIO_ROOT_PASSWORD', label:'Root password', default:'minioadmin', required:true, type:'password'},
          ],
          volumes:[{name:'miniodata',mount:'/data'}],
          command:'server /data --console-address ":9001"',
        },
        { key:'seaweedfs', label:'SeaweedFS', cat:'storage',
          images:['chrislusf/seaweedfs:latest'],
          ports:[{port:9333,label:'Master'},{port:8080,label:'Volume'}],
          envFields:[],
          volumes:[{name:'seaweeddata',mount:'/data'}],
          command:'server -master.port=9333 -volume.port=8080 -dir=/data',
        },

        // ‚îÄ‚îÄ DevOps & Utilities ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        { key:'portainer', label:'Portainer', cat:'devops',
          images:['portainer/portainer-ce:latest','portainer/portainer-ce:2.19.4'],
          ports:[{port:9443,label:'HTTPS'},{port:9000,label:'HTTP'}],
          envFields:[],
          volumes:[{name:'portainerdata',mount:'/data'},{name:'/var/run/docker.sock',mount:'/var/run/docker.sock:ro'}],
        },
        { key:'vault', label:'Vault', cat:'devops',
          images:['hashicorp/vault:latest','hashicorp/vault:1.15'],
          ports:[{port:8200,label:'HTTP'}],
          envFields:[
              {key:'VAULT_DEV_ROOT_TOKEN_ID',  label:'Dev root token', default:'devtoken'},
              {key:'VAULT_DEV_LISTEN_ADDRESS', label:'Listen address', default:'0.0.0.0:8200'},
          ],
          volumes:[{name:'vaultdata',mount:'/vault/file'}],
          note:'Dev mode ‚Äî single-server, in-memory',
        },
        { key:'consul', label:'Consul', cat:'devops',
          images:['hashicorp/consul:latest','hashicorp/consul:1.18'],
          ports:[{port:8500,label:'HTTP'},{port:8600,label:'DNS'}],
          envFields:[],
          volumes:[{name:'consuldata',mount:'/consul/data'}],
          command:'agent -dev -client=0.0.0.0',
        },
        { key:'gitea', label:'Gitea', cat:'devops',
          images:['gitea/gitea:latest','gitea/gitea:1.21'],
          ports:[{port:3000,label:'HTTP'},{port:2222,label:'SSH'}],
          envFields:[
              {key:'GITEA__database__DB_TYPE', label:'DB type', default:'sqlite3'},
          ],
          volumes:[{name:'giteadata',mount:'/data'}],
        },
        { key:'mailpit', label:'Mailpit', cat:'devops',
          images:['axllent/mailpit:latest'],
          ports:[{port:8025,label:'Web UI'},{port:1025,label:'SMTP'}],
          envFields:[],
          volumes:[],
          note:'Catches all outgoing email ‚Äî dev/test only',
        },
        { key:'adminer', label:'Adminer', cat:'devops',
          images:['adminer:latest','adminer:4'],
          ports:[{port:8080,label:'HTTP'}],
          envFields:[
              {key:'ADMINER_DEFAULT_SERVER', label:'Default DB server', default:'postgres'},
          ],
          volumes:[],
          note:'Universal database management UI',
        },
        { key:'pgadmin', label:'pgAdmin 4', cat:'devops',
          images:['dpage/pgadmin4:latest','dpage/pgadmin4:8'],
          ports:[{port:5050,label:'HTTP'}],
          envFields:[
              {key:'PGADMIN_DEFAULT_EMAIL',    label:'Admin email',    default:'admin@admin.com', required:true},
              {key:'PGADMIN_DEFAULT_PASSWORD', label:'Admin password', default:'admin', required:true, type:'password'},
          ],
          volumes:[{name:'pgadmindata',mount:'/var/lib/pgadmin'}],
        },
        { key:'redisinsight', label:'Redis Insight', cat:'devops',
          images:['redis/redisinsight:latest','redis/redisinsight:2'],
          ports:[{port:5540,label:'HTTP'}],
          envFields:[],
          volumes:[],
          note:'Connect to any Redis-compatible service',
        },
    ];

    // Category labels for UI grouping
    const _infraCategories = {
        'db-rel':  'üóÑÔ∏è Relational Databases',
        'db-nosql':'üçÉ NoSQL & Time-Series',
        'cache':   '‚ö° Caches & Key-Value',
        'mq':      'üì® Message Brokers & Queues',
        'search':  'üîç Search & Analytics',
        'proxy':   'üåê Reverse Proxies & Load Balancers',
        'monitor': 'üìä Monitoring & Observability',
        'log':     'üìù Logging',
        'storage': 'üíæ Storage & Object Store',
        'devops':  'üîß DevOps & Utilities',
    };
    window._infraOptions = _infraOptions;
    window._infraCategories = _infraCategories;

    // ‚îÄ‚îÄ Docker Setup Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function openDockerSetupWizard() {

        // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        /** Determine if a module is a container candidate based on domain + stack. */
        function _dockerModClass(mod) {
            const dom = (mod.domain || '').toLowerCase();
            const st  = (mod.stack  || '').toLowerCase();
            if (dom === 'library')  return 'library';
            if (dom === 'docs' || st === 'markdown') return 'docs';
            if (['kubernetes', 'helm', 'terraform', 'docker-compose'].includes(st)) return 'ops-tool';
            return 'deployable';
        }

        /** Resolve the Dockerfile template family a stack maps to. */
        function _dockerStackFamily(stack) {
            const families = ['python','node','typescript','go','rust','java-maven','java-gradle','dotnet','elixir','ruby'];
            if (families.includes(stack)) return stack;
            for (const f of families) {
                if (stack.startsWith(f + '-')) return f;
            }
            return null;
        }

        /** Default port for a stack family. */
        function _dockerPort(family) {
            return (_dockerStackDefaults[family] || {}).expose || 8080;
        }

        // ‚îÄ‚îÄ Per-stack Dockerfile defaults ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        const _dockerStackDefaults = {
            python: {
                images: ['python:3.12-slim','python:3.11-slim','python:3.12-alpine','python:3.11-alpine','python:3.12-bookworm'],
                workdir: '/app',
                install: 'pip install --no-cache-dir -r requirements.txt',
                build: '',
                entrypoint: '',
                cmd: 'python -m src.main',
                expose: 8000,
            },
            node: {
                images: ['node:20-alpine','node:22-alpine','node:18-alpine','node:20-slim','node:18-slim'],
                workdir: '/app',
                install: 'npm ci --production',
                build: '',
                entrypoint: '',
                cmd: 'node index.js',
                expose: 3000,
            },
            typescript: {
                images: ['node:20-alpine','node:22-alpine','node:18-alpine','node:20-slim'],
                workdir: '/app',
                install: 'npm ci',
                build: 'npm run build',
                entrypoint: '',
                cmd: 'node dist/index.js',
                expose: 3000,
            },
            go: {
                images: ['golang:1.22-alpine','golang:1.21-alpine','golang:1.22-bookworm'],
                workdir: '/app',
                install: 'go mod download',
                build: 'CGO_ENABLED=0 GOOS=linux go build -o /app/server ./...',
                entrypoint: '',
                cmd: '/app/server',
                expose: 8080,
            },
            rust: {
                images: ['rust:1.77-slim','rust:1.77-alpine','rust:1.76-slim'],
                workdir: '/app',
                install: '',
                build: 'cargo build --release',
                entrypoint: '',
                cmd: '/app/app',
                expose: 8080,
            },
            'java-maven': {
                images: ['maven:3.9-eclipse-temurin-21','maven:3.9-eclipse-temurin-17'],
                workdir: '/app',
                install: 'mvn dependency:resolve -q',
                build: 'mvn package -DskipTests -q',
                entrypoint: '',
                cmd: 'java -jar /app/app.jar',
                expose: 8080,
            },
            'java-gradle': {
                images: ['gradle:8-jdk21','gradle:8-jdk17'],
                workdir: '/app',
                install: 'gradle dependencies --no-daemon -q',
                build: 'gradle build -x test --no-daemon -q',
                entrypoint: '',
                cmd: 'java -jar /app/app.jar',
                expose: 8080,
            },
            dotnet: {
                images: ['mcr.microsoft.com/dotnet/sdk:8.0','mcr.microsoft.com/dotnet/sdk:7.0'],
                workdir: '/app',
                install: 'dotnet restore',
                build: 'dotnet publish -c Release -o /app/publish',
                entrypoint: '',
                cmd: 'dotnet App.dll',
                expose: 8080,
            },
            elixir: {
                images: ['elixir:1.16-alpine','elixir:1.16-slim','elixir:1.15-alpine'],
                workdir: '/app',
                install: 'mix deps.get --only prod && mix deps.compile',
                build: 'mix release',
                entrypoint: '',
                cmd: 'bin/app start',
                expose: 4000,
            },
            ruby: {
                images: ['ruby:3.3-slim','ruby:3.2-slim','ruby:3.3-alpine','ruby:3.2-alpine'],
                workdir: '/app',
                install: 'bundle install --deployment --without development test',
                build: '',
                entrypoint: '',
                cmd: 'bundle exec ruby app.rb',
                expose: 3000,
            },
        };

        const _restartPolicies = ['unless-stopped','always','on-failure','no'];
        const _platformOptions = ['','linux/amd64','linux/arm64','linux/amd64,linux/arm64'];


        wizardModalOpen({
            title: 'üê≥ Docker Setup',
            size: 'wide',
            steps: [
                // ‚îÄ‚îÄ Step 1: Detect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // ‚îÄ‚îÄ Serve from cache if available (instant, zero API calls) ‚îÄ‚îÄ
                        const _CK = 'docker:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // ‚îÄ‚îÄ Fresh scan ‚îÄ‚îÄ
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Detecting Docker environment‚Ä¶</p>';
                        try {
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;
                            const probes = wizDetect.status_probes || {};
                            const docker = probes.docker || {};
                            data._docker = docker;
                            data._dockerStatus = wizDetect.docker_status || {};
                            const dockerStatus = data._dockerStatus;
                            const modules = (wizDetect.config_data || {}).modules || [];
                            data._modules = modules;

                            // Classify modules
                            const classified = modules.map(m => {
                                const cls = _dockerModClass(m);
                                const family = _dockerStackFamily(m.stack || '');
                                return { ...m, _class: cls, _family: family,
                                         _port: family ? _dockerPort(family) : null };
                            });
                            data._classified = classified;

                            const deployable = classified.filter(m => m._class === 'deployable' && m._family);

                            // Docker status
                            let html = wizSection('Docker Environment', 'Current Docker configuration detected in this project.');
                            html += `<div class="wiz-status-grid">
                                ${wizStatusRow('üê≥', 'Docker Engine',
                                    dockerStatus.available ? (dockerStatus.version || '').replace('Docker version ','').split(',')[0] || 'Available' : 'Not found',
                                    dockerStatus.available ? 'ok' : 'error')}
                                ${dockerStatus.compose_available ? wizStatusRow('‚öôÔ∏è', 'Docker Compose', (dockerStatus.compose_version || '‚úì'), 'ok') : ''}
                                ${wizStatusRow('üìÑ', 'Dockerfile', docker.has_dockerfile ? 'Present' : 'Missing', docker.has_dockerfile ? 'ok' : 'warn')}
                                ${wizStatusRow('üìã', 'Compose file', docker.has_compose ? 'Present' : 'Missing', docker.has_compose ? 'ok' : 'warn')}
                                ${wizStatusRow('üö´', '.dockerignore', docker.has_dockerignore ? 'Present' : 'Missing', docker.has_dockerignore ? 'ok' : 'warn')}
                            </div>`;

                            if (!dockerStatus.available) {
                                html += `<div class="wiz-step-warn-panel" style="margin-top:1rem">
                                    <span>‚ö†Ô∏è</span>
                                    <span>Docker is not installed. You can still generate config files, but won't be able to build/run until Docker is available.</span>
                                </div>`;
                            }

                            // Module table
                            html += wizSection('Project Modules', `${modules.length} module${modules.length !== 1 ? 's' : ''} detected ‚Äî ${deployable.length} deployable.`);
                            if (modules.length > 0) {
                                html += `<div style="display:flex;flex-direction:column;gap:0.25rem">`;
                                for (const m of classified) {
                                    const isDep = m._class === 'deployable' && m._family;
                                    const badge = isDep ? 'deployable' : m._class;
                                    const badgeColor = isDep ? 'var(--success)' : 'var(--text-muted)';
                                    const badgeIcon = isDep ? 'üü¢' : m._class === 'library' ? 'üìö' : m._class === 'docs' ? 'üìù' : '‚öôÔ∏è';
                                    html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.3rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                        <span style="width:18px;text-align:center">${badgeIcon}</span>
                                        <strong style="min-width:80px">${esc(m.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(m.stack || '?')}</code>
                                        <span style="flex:1;color:var(--text-muted);font-size:0.72rem">${esc(m.path || '')}</span>
                                        <span style="font-size:0.68rem;color:${badgeColor}">${badge}</span>
                                    </div>`;
                                }
                                html += `</div>`;

                                if (deployable.length > 0) {
                                    html += `<div style="margin-top:0.75rem;font-size:0.8rem;color:var(--text-secondary)">
                                        üí° <strong>${deployable.length}</strong> deployable module${deployable.length !== 1 ? 's' : ''} detected.
                                        The next step lets you choose which ones become containers.
                                    </div>`;
                                } else {
                                    html += `<div class="wiz-step-warn-panel" style="margin-top:0.75rem">
                                        <span>‚ÑπÔ∏è</span>
                                        <span>No deployable modules detected ‚Äî you'll be able to pick a stack template manually in the next step.</span>
                                    </div>`;
                                }
                            } else {
                                html += `<div style="font-size:0.82rem;color:var(--text-muted);padding:0.5rem">
                                    No modules configured. You can still pick a stack template manually.
                                </div>`;
                            }

                            // Fetch vault keys (secrets + config vars)
                            try {
                                const vaultData = await api('/vault/keys');
                                data._vaultKeys = (vaultData && vaultData.keys) || [];
                            } catch(e) { data._vaultKeys = []; }

                            // Store complete detect result in cache
                            wizStore(_CK, { h: html, d: { _docker: data._docker, _dockerStatus: data._dockerStatus, _modules: data._modules, _classified: data._classified, _vaultKeys: data._vaultKeys } }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>‚ö†Ô∏è</span><span>${esc(e.message)}</span></div>`;
                        }
                    },
                },

                // ‚îÄ‚îÄ Step 2: Configure ‚Äî Container selection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'config', title: 'Configure',
                    render: (data, el) => {
                        const docker   = data._docker || {};
                        const modules  = data._classified || [];
                        const deployable = modules.filter(m => m._class === 'deployable' && m._family);
                        const stackOpts = Object.keys(_dockerStackDefaults);

                        // Helper to render a base-image select with custom option
                        function _imgSelect(id, family) {
                            const d = _dockerStackDefaults[family] || {};
                            const imgs = d.images || ['ubuntu:22.04'];
                            return `<select id="${id}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem"
                                onchange="var ci=document.getElementById('${id}-custom');if(ci)ci.style.display=this.value==='__custom'?'block':'none'">
                                ${imgs.map((img, j) => `<option value="${img}"${j === 0 ? ' selected' : ''}>${img}</option>`).join('')}
                                <option value="__custom">Custom‚Ä¶</option>
                            </select>
                            <input type="text" id="${id}-custom" class="modal-form-input" placeholder="e.g. python:3.10-bullseye"
                                style="font-size:0.74rem;padding:0.2rem 0.3rem;margin-top:3px;display:none">`;
                        }

                        // Helper: mini label
                        const _lbl = (txt, sub) => `<label style="display:block;font-size:0.7rem;color:var(--text-muted);margin-bottom:2px">${txt}${sub ? ` <span style="font-size:0.62rem;opacity:0.7">(${sub})</span>` : ''}</label>`;
                        const _inp = (id, val, ph) => `<input type="text" id="${id}" class="modal-form-input" value="${esc(val || '')}" placeholder="${ph || ''}" style="font-size:0.76rem;padding:0.2rem 0.3rem">`;
                        const _num = (id, val) => `<input type="number" id="${id}" class="modal-form-input" value="${val}" style="font-size:0.76rem;padding:0.2rem 0.3rem">`;
                        const _ta = (id, val, ph, rows) => `<textarea id="${id}" class="modal-form-input" rows="${rows || 2}" placeholder="${ph || ''}" style="font-size:0.72rem;padding:0.2rem 0.3rem;font-family:var(--font-mono,monospace);resize:vertical;min-height:38px">${esc(val || '')}</textarea>`;

                        // ‚îÄ‚îÄ Vault env var helpers (same pattern as K8s) ‚îÄ‚îÄ
                        const _dkIsSecretKey = (k) => {
                            const l = k.toLowerCase();
                            const secretWords = ['password','secret','token','key','api_key','apikey','auth','credential','private','cert'];
                            return secretWords.some(sw => l.includes(sw));
                        };
                        const _dkDefaultInjType = (k) => {
                            if (_dkIsSecretKey(k)) return 'secret';
                            const l = k.toLowerCase();
                            const varWords = ['host','port','url','uri','endpoint','database','db_name','user','username','redis_url','mysql_host','postgres_host','node_env','app_env','environment','env'];
                            if (varWords.some(vw => l.includes(vw))) return 'variable';
                            return 'hardcoded';
                        };

                        // Build vault sets
                        const _dkVaultKeys = data._vaultKeys || [];
                        const _dkAllEnvKeys = new Set();
                        const _dkAvailableVars = [];
                        const _dkAvailableSecrets = [];
                        _dkVaultKeys.forEach(vk => {
                            const k = vk.key;
                            if (_dkAllEnvKeys.has(k)) return;
                            _dkAllEnvKeys.add(k);
                            if (vk.kind === 'secret') _dkAvailableSecrets.push(k);
                            else _dkAvailableVars.push(k);
                        });
                        _dkAvailableVars.sort();
                        _dkAvailableSecrets.sort();

                        // Build per-infra-key env suggestion map
                        const _dkInfraEnvMap = {};
                        for (const inf of _infraOptions) {
                            _dkInfraEnvMap[inf.key] = inf.envFields.map(ef => ef.key);
                        }

                        // Build <option> HTML ‚Äî svcIdx used to read checked deps
                        const _dkVarSelectOpts = (injType, currentKey, currentVarName, svcIdx) => {
                            // Compute suggestions from checked infra deps
                            const suggestedSet = new Set();
                            if (typeof svcIdx === 'string' && svcIdx.startsWith('infra-')) {
                                // Infra service: suggest own env fields
                                const ik = svcIdx.replace('infra-', '');
                                (_dkInfraEnvMap[ik] || []).forEach(k => suggestedSet.add(k));
                            } else if (svcIdx !== undefined && svcIdx !== null) {
                                // App service: suggest from checked deps
                                const depCbs = document.querySelectorAll('.dk-dep-' + svcIdx + ':checked');
                                if (depCbs.length > 0) {
                                    depCbs.forEach(cb => {
                                        const depKey = cb.value;
                                        (_dkInfraEnvMap[depKey] || []).forEach(k => suggestedSet.add(k));
                                    });
                                } else if (document.querySelectorAll('.dk-dep-' + svcIdx).length === 0) {
                                    // DOM not ready ‚Äî fallback to all
                                    Object.values(_dkInfraEnvMap).forEach(keys => keys.forEach(k => suggestedSet.add(k)));
                                }
                                // If dep checkboxes exist but none checked ‚Äî no suggestions (intentional)
                            } else {
                                // No svcIdx ‚Äî show all infra env fields
                                Object.values(_dkInfraEnvMap).forEach(keys => keys.forEach(k => suggestedSet.add(k)));
                            }
                            const _dkSuggested = [...suggestedSet].sort();
                            const dlr = '$';
                            const match = currentVarName || (dlr + '{' + currentKey + '}');
                            const shown = new Set();
                            let opts = '';
                            if (currentKey) {
                                const selfVal = dlr + '{' + currentKey + '}';
                                opts += '<option value="' + esc(selfVal) + '"' + (match === selfVal ? ' selected' : '') + '>' + dlr + '{' + esc(currentKey) + '}</option>';
                                shown.add(currentKey);
                            }
                            const suggested = _dkSuggested.filter(k => !shown.has(k));
                            if (suggested.length > 0) {
                                opts += '<optgroup label="Suggested">';
                                suggested.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            const secrets = _dkAvailableSecrets.filter(k => !shown.has(k));
                            if (secrets.length > 0) {
                                opts += '<optgroup label="Secrets">';
                                secrets.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            const vars = _dkAvailableVars.filter(k => !shown.has(k));
                            if (vars.length > 0) {
                                opts += '<optgroup label="Variables">';
                                vars.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            const stripped = match ? match.replace(/^\$\{|\}$/g, '') : '';
                            const isCustom = stripped && stripped !== currentKey && !_dkAllEnvKeys.has(stripped);
                            opts += '<option value="__custom__"' + (isCustom ? ' selected' : '') + '>Custom...</option>';
                            return opts;
                        }; // end _dkVarSelectOpts

                        // Per-variable row HTML (dk- prefix)
                        const _dkEnvRowHtml = (i, j, key, value, injType, varName) => {
                            const isSubst = injType !== 'hardcoded';
                            const isSec = injType === 'secret';
                            const dlr = '$';
                            const varN = varName || (isSubst ? dlr + '{' + key + '}' : '');
                            const isCustomVar = varN && key && varN !== (dlr + '{' + key + '}') && !_dkAllEnvKeys.has(varN.replace(/^\$\{|\}$/g, ''));
                            const selKey = isSubst ? (varN.replace(/^\$\{/, '').replace(/\}$/, '') || key) : key;
                            const varMissing = isSubst && selKey && !_dkAllEnvKeys.has(selKey);
                            return '<div class="dk-env-row" style="margin-bottom:0.15rem">'
                                + '<div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;align-items:center">'
                                + '<input type="text" id="dk-svc-env-key-' + i + '-' + j + '" class="modal-form-input"'
                                + ' value="' + esc(key) + '" placeholder="KEY_NAME"'
                                + ' oninput="if(!this.dataset.envTs)this.dataset.envTs=Date.now();window._wizValidation.recheck(\'dk\')"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)">'
                                + '<input type="' + (isSec ? 'password' : 'text') + '" id="dk-svc-env-val-' + i + '-' + j + '" class="modal-form-input"'
                                + ' value="' + esc(value) + '" placeholder="' + (isSec ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'value') + '"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)"' + (isSubst ? ' hidden' : '') + '>'
                                + '<div id="dk-svc-env-varbox-' + i + '-' + j + '"' + (isSubst ? '' : ' hidden') + '>'
                                +   '<select id="dk-svc-env-var-' + i + '-' + j + '" class="modal-form-select" data-i="' + i + '" data-j="' + j + '" data-pfx="dk"'
                                +   ' style="font-size:0.82rem;padding:0.25rem 0.35rem;color:var(--accent)"'
                                +   ' onchange="window._dkOnVarSelect(this)">'
                                +   (isSubst ? _dkVarSelectOpts(injType, key, varN, i) : '<option>--</option>')
                                +   '</select>'
                                +   '<input type="text" id="dk-svc-env-varcustom-' + i + '-' + j + '" class="modal-form-input"'
                                +   ' value="' + (isCustomVar ? esc(varN) : '') + '" placeholder="' + dlr + '{MY_VAR}"'
                                +   ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace);color:var(--accent);margin-top:2px;display:' + (isCustomVar ? '' : 'none') + '">'
                                + '</div>'
                                + '<select id="dk-svc-env-type-' + i + '-' + j + '" class="modal-form-select" data-i="' + i + '" data-j="' + j + '"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem"'
                                + ' onchange="((sel)=>{'
                                +   'var si=sel.dataset.i,sj=sel.dataset.j;'
                                +   'var vb=document.getElementById(\'dk-svc-env-varbox-\'+si+\'-\'+sj);'
                                +   'var ve=document.getElementById(\'dk-svc-env-val-\'+si+\'-\'+sj);'
                                +   'var vs=document.getElementById(\'dk-svc-env-var-\'+si+\'-\'+sj);'
                                +   'var isSub=sel.value!==\'hardcoded\';'
                                +   'if(vb)vb.hidden=!isSub;'
                                +   'if(ve)ve.hidden=isSub;'
                                +   'if(!isSub){var nt=document.getElementById(\'dk-svc-env-notice-\'+si+\'-\'+sj);if(nt)nt.hidden=true;}'
                                +   'if(vs&&isSub){vs.innerHTML=window._dkVarSelectOpts(sel.value,document.getElementById(\'dk-svc-env-key-\'+si+\'-\'+sj).value,\'\',si);window._dkOnVarSelect(vs);}'
                                +   'window._wizValidation.recheck(\'dk\');'
                                + '})(this)">'
                                + '<option value="hardcoded"' + (injType === 'hardcoded' ? ' selected' : '') + '>üìã Hardcoded</option>'
                                + '<option value="variable"' + (injType === 'variable' ? ' selected' : '') + '>üîÑ Variable</option>'
                                + '<option value="secret"' + (injType === 'secret' ? ' selected' : '') + '>üîí Secret</option>'
                                + '</select>'
                                + '<button type="button" onclick="this.closest(\'.dk-env-row\').remove();window._wizValidation.recheck(\'dk\')"'
                                + ' style="background:none;border:none;cursor:pointer;font-size:0.82rem;color:var(--text-muted);padding:0 2px"'
                                + ' title="Remove variable">‚úï</button>'
                                + '</div>'
                                + '<div id="dk-svc-env-notice-' + i + '-' + j + '"' + (varMissing ? '' : ' hidden')
                                + ' style="font-size:0.78rem;color:var(--warning,#e8a820);margin:2px 0 4px;padding:4px 6px;border-radius:4px;background:rgba(232,168,32,0.06);border:1px solid rgba(232,168,32,0.15)">'
                                +   '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">'
                                +     '<span>\u26a0\ufe0f <strong id="dk-svc-env-notice-name-' + i + '-' + j + '">' + esc(selKey) + '</strong> does not exist in vault</span>'
                                +     '<label style="display:flex;align-items:center;gap:3px;cursor:pointer">'
                                +       '<input type="checkbox" id="dk-svc-env-create-' + i + '-' + j + '" checked style="margin:0">'
                                +       '<span>Create on execution</span>'
                                +     '</label>'
                                +   '</div>'
                                +   '<div id="dk-svc-env-valbox-' + i + '-' + j + '" style="display:flex;align-items:center;gap:4px;margin-top:3px">'
                                +     '<input type="text" id="dk-svc-env-newval-' + i + '-' + j + '" class="modal-form-input"'
                                +     ' placeholder="value (leave empty or generate)" style="flex:1;font-size:0.78rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)">'
                                +     '<button type="button" onclick="window._dkGenerateVarValue(this)" data-i="' + i + '" data-j="' + j + '"'
                                +     ' style="font-size:0.78rem;padding:0.25rem 0.5rem;border:1px solid var(--border-subtle);border-radius:3px;background:var(--bg-card);cursor:pointer;white-space:nowrap"'
                                +     ' title="Generate a random value">üé≤ Generate</button>'
                                +   '</div>'
                                +   '<div id="dk-svc-env-elsewhere-' + i + '-' + j + '" hidden style="font-size:0.76rem;color:var(--text-muted);font-style:italic;margin-top:3px">'
                                +     '\u2139\ufe0f Value already being created by <strong id="dk-svc-env-elsewhere-src-' + i + '-' + j + '"></strong>'
                                +   '</div>'
                                + '</div>'
                                + '<div id="dk-svc-env-dupe-' + i + '-' + j + '" hidden'
                                + ' style="font-size:0.76rem;margin:1px 0 3px;padding:3px 6px;border-radius:4px">'
                                + '</div>'
                                + '</div>';
                        };

                        // Expose on window
                        window._dkVarSelectOpts = _dkVarSelectOpts;
                        window._dkOnVarSelect = (sel) => {
                            const ci = sel.dataset.i, cj = sel.dataset.j;
                            const tb = document.getElementById('dk-svc-env-varcustom-' + ci + '-' + cj);
                            const nt = document.getElementById('dk-svc-env-notice-' + ci + '-' + cj);
                            if (sel.value === '__custom__') {
                                if (tb) tb.style.display = '';
                                if (nt) nt.hidden = true;
                            } else {
                                if (tb) tb.style.display = 'none';
                                if (nt) {
                                    const varKey = sel.value.replace(/^\$\{/, '').replace(/\}$/, '');
                                    // Smart key sync: update key if empty or still matches prev var
                                    const keyInput = document.getElementById('dk-svc-env-key-' + ci + '-' + cj);
                                    if (keyInput) {
                                        const curKey = keyInput.value.trim().toUpperCase();
                                        const prevVar = (keyInput.dataset.lastVar || '').toUpperCase();
                                        if (!curKey || curKey === prevVar) {
                                            keyInput.value = varKey;
                                            keyInput.dataset.envTs = Date.now();
                                        }
                                        keyInput.dataset.lastVar = varKey;
                                    }
                                    const exists = _dkAllEnvKeys.has(varKey);
                                    nt.hidden = exists;
                                    const nameEl = document.getElementById('dk-svc-env-notice-name-' + ci + '-' + cj);
                                    if (nameEl) nameEl.textContent = varKey;
                                    const valbox = document.getElementById('dk-svc-env-valbox-' + ci + '-' + cj);
                                    const elsewhere = document.getElementById('dk-svc-env-elsewhere-' + ci + '-' + cj);
                                    if (!exists && varKey) {
                                        if (valbox) valbox.style.display = 'flex';
                                        if (elsewhere) elsewhere.hidden = true;
                                    } else {
                                        if (valbox) valbox.style.display = 'flex';
                                        if (elsewhere) elsewhere.hidden = true;
                                    }
                                }
                            }
                            // Shared symmetric collision check
                            window._wizValidation.recheck('dk');
                        };
                        // Refresh all env var selects for a service when deps change
                        window._dkRefreshEnvSelects = (svcIdx) => {
                            const list = document.getElementById('dk-svc-env-list-' + svcIdx);
                            if (!list) return;
                            list.querySelectorAll('.dk-env-row').forEach((row, j) => {
                                const typeSel = document.getElementById('dk-svc-env-type-' + svcIdx + '-' + j);
                                const varSel = document.getElementById('dk-svc-env-var-' + svcIdx + '-' + j);
                                if (!typeSel || !varSel || typeSel.value === 'hardcoded') return;
                                const keySel = document.getElementById('dk-svc-env-key-' + svcIdx + '-' + j);
                                const currentKey = keySel ? keySel.value : '';
                                const currentVar = varSel.value;
                                varSel.innerHTML = window._dkVarSelectOpts(typeSel.value, currentKey, currentVar, svcIdx);
                                window._dkOnVarSelect(varSel);
                            });
                        };
                        window._dkGenerateVarValue = (btn) => {
                            const ci = btn.dataset.i, cj = btn.dataset.j;
                            const inp = document.getElementById('dk-svc-env-newval-' + ci + '-' + cj);
                            if (!inp) return;
                            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#%&*';
                            let val = '';
                            for (let n = 0; n < 32; n++) val += chars[Math.floor(Math.random() * chars.length)];
                            inp.value = val;
                        };
                        window._dkCollectEnvVars = (i) => {
                            const list = document.getElementById('dk-svc-env-list-' + i);
                            if (!list) return [];
                            const vars = [];
                            list.querySelectorAll('.dk-env-row').forEach((row, j) => {
                                const key = (document.getElementById('dk-svc-env-key-' + i + '-' + j) || {}).value || '';
                                if (!key.trim()) return;
                                const type = (document.getElementById('dk-svc-env-type-' + i + '-' + j) || {}).value || 'hardcoded';
                                const value = (document.getElementById('dk-svc-env-val-' + i + '-' + j) || {}).value || '';
                                const varSel = document.getElementById('dk-svc-env-var-' + i + '-' + j);
                                const varCustom = document.getElementById('dk-svc-env-varcustom-' + i + '-' + j);
                                let varName = null;
                                if (type !== 'hardcoded') {
                                    if (varSel && varSel.value === '__custom__' && varCustom && varCustom.value.trim()) {
                                        varName = varCustom.value.trim();
                                    } else if (varSel && varSel.value && varSel.value !== '__custom__') {
                                        varName = varSel.value;
                                    } else {
                                        varName = '${' + key.trim() + '}';
                                    }
                                }
                                const createChk = document.getElementById('dk-svc-env-create-' + i + '-' + j);
                                const newValInp = document.getElementById('dk-svc-env-newval-' + i + '-' + j);
                                const notice = document.getElementById('dk-svc-env-notice-' + i + '-' + j);
                                const createInVault = notice && !notice.hidden && createChk && createChk.checked;
                                const newValue = createInVault && newValInp ? newValInp.value.trim() : '';
                                vars.push({ key: key.trim(), type, value: value.trim(), varName, createInVault: !!createInVault, newValue });
                            });
                            return vars;
                        };
                        window._dkAddEnvVar = (i) => {
                            const list = document.getElementById('dk-svc-env-list-' + i);
                            if (!list) return;
                            const j = list.querySelectorAll('.dk-env-row').length;
                            const row = document.createElement('div');
                            row.innerHTML = _dkEnvRowHtml(i, j, '', '', 'hardcoded', '');
                            list.appendChild(row.firstChild);
                            window._wizValidation.recheck('dk');
                        };

                        let html = '';

                        // ‚îÄ‚îÄ Global compose settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        html += wizSection('Compose Project', 'Global settings for docker-compose.yml.');
                        html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;max-width:500px">
                            <div>${_lbl('Project name', 'optional')}${_inp('mf-dk-project-name', '', 'my-project')}</div>
                            <div>${_lbl('Platform', 'optional')}
                                <select id="mf-dk-platform" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem">
                                    ${_platformOptions.map(p => `<option value="${p}">${p || 'auto (default)'}</option>`).join('')}
                                </select>
                            </div>
                        </div>`;

                        // ‚îÄ‚îÄ Section A: Module containers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        html += wizSection('Containers',
                            deployable.length > 0
                                ? 'Select which modules should become Docker containers and configure each one.'
                                : 'No deployable modules found ‚Äî configure a container manually.'
                        );

                        if (deployable.length > 0) {
                            const allSvcNames = deployable.map(m => m.name);
                            const allInfraNames = _infraOptions.map(o => o.key);
                            // Map svcIdx -> human name for cross-row awareness
                            window._dkSvcNames = {};
                            deployable.forEach((m, idx) => { window._dkSvcNames[String(idx)] = m.name; });
                            _infraOptions.forEach(inf => { window._dkSvcNames['infra-' + inf.key] = inf.label || inf.key; });

                            html += `<div style="display:flex;flex-direction:column;gap:0.5rem" id="dk-mod-list">`;
                            for (let i = 0; i < deployable.length; i++) {
                                const m = deployable[i];
                                const d = _dockerStackDefaults[m._family] || {};
                                const nextPort = (d.expose || 8080) + i;
                                const otherSvcs = allSvcNames.filter(n => n !== m.name).concat(allInfraNames);

                                html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);overflow:hidden" id="dk-mod-card-${i}">
                                    <label style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.6rem;cursor:pointer;font-size:0.82rem"
                                        onmouseover="this.parentElement.style.borderColor='var(--accent)'" onmouseout="this.parentElement.style.borderColor='var(--border-subtle)'">
                                        <input type="checkbox" id="mf-dk-mod-${i}" checked style="accent-color:var(--accent)"
                                            onchange="document.getElementById('dk-mod-cfg-${i}').style.display=this.checked?'block':'none'">
                                        <strong>${esc(m.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(m.stack || '?')}</code>
                                        <span style="flex:1;color:var(--text-muted);font-size:0.72rem">${esc(m.path || '')}</span>
                                    </label>
                                    <div id="dk-mod-cfg-${i}" style="padding:0 0.6rem 0.5rem;display:block">
                                        <!-- Primary: base image, port, path, restart -->
                                        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:0.4rem;align-items:start">
                                            <div>${_lbl('Base image')}${_imgSelect(`mf-dk-img-${i}`, m._family)}</div>
                                            <div>${_lbl('Port')}${_num(`mf-dk-port-${i}`, nextPort)}</div>
                                            <div>${_lbl('Dockerfile path')}${_inp(`mf-dk-dkpath-${i}`, deployable.length > 1 ? m.path + '/Dockerfile' : 'Dockerfile', '')}</div>
                                            <div>${_lbl('Restart policy')}
                                                <select id="mf-dk-restart-${i}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem">
                                                    ${_restartPolicies.map(r => `<option value="${r}"${r === 'unless-stopped' ? ' selected' : ''}>${r}</option>`).join('')}
                                                </select>
                                            </div>
                                        </div>

                                        <!-- Dockerfile settings -->
                                        <details style="margin-top:0.4rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0">‚ñ∏ Dockerfile Settings</summary>
                                            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem;margin-top:0.3rem">
                                                <div>${_lbl('Working directory')}${_inp(`mf-dk-workdir-${i}`, d.workdir, '/app')}</div>
                                                <div>${_lbl('Install command')}${_inp(`mf-dk-install-${i}`, d.install, 'pip install -r requirements.txt')}</div>
                                                <div>${_lbl('Build command', 'optional')}${_inp(`mf-dk-build-${i}`, d.build, 'npm run build')}</div>
                                                <div>${_lbl('Entrypoint', 'optional')}${_inp(`mf-dk-entrypoint-${i}`, d.entrypoint, 'gunicorn')}</div>
                                                <div>${_lbl('CMD')}${_inp(`mf-dk-cmd-${i}`, d.cmd, 'python app.py')}</div>
                                                <div>${_lbl('EXPOSE port')}${_num(`mf-dk-expose-${i}`, d.expose)}</div>
                                            </div>
                                        </details>

                                        <!-- Compose settings -->
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0">‚ñ∏ Compose Settings</summary>
                                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-top:0.3rem">
                                                <div>${_lbl('Container name', 'optional')}${_inp(`mf-dk-cname-${i}`, '', m.name)}</div>
                                                <div>${_lbl('Health check', 'optional')}${_inp(`mf-dk-health-${i}`, '', 'curl -f http://localhost:' + nextPort + '/health')}</div>
                                                <div>${_lbl('Build args', 'KEY=VAL per line')}${_ta(`mf-dk-buildargs-${i}`, '', 'ENV=production', 2)}</div>
                                                <div>${_lbl('Networks', 'one per line')}${_ta(`mf-dk-networks-${i}`, '', 'backend\nfrontend', 2)}</div>
                                                <div style="grid-column:1/-1">
                                                    <details open style="margin-top:0.2rem">
                                                        <summary style="cursor:pointer;font-size:0.78rem;color:var(--accent);user-select:none;padding:0.15rem 0">‚ñ∏ Environment Variables</summary>
                                                        <div style="margin-top:0.25rem">
                                                            <div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;margin-bottom:0.15rem;padding:0 0.25rem">
                                                                <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Key</span>
                                                                <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Value</span>
                                                                <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Var / Secret</span>
                                                                <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Injection</span>
                                                                <span></span>
                                                            </div>
                                                            <div id="dk-svc-env-list-${i}" style="display:flex;flex-direction:column;gap:0.15rem"></div>
                                                            <button type="button" onclick="window._dkAddEnvVar(${i})"
                                                                style="margin-top:0.25rem;font-size:0.78rem;padding:0.2rem 0.7rem;border:1px dashed var(--border-subtle);border-radius:4px;background:none;color:var(--accent);cursor:pointer">
                                                                + Add variable
                                                            </button>
                                                        </div>
                                                    </details>
                                                </div>
                                                <div>${_lbl('Volumes', 'host:container per line')}${_ta(`mf-dk-vol-${i}`, '', './data:/app/data', 2)}</div>
                                                <div style="grid-column:1/-1">
                                                    ${_lbl('Depends on')}
                                                    <div style="display:flex;flex-wrap:wrap;gap:0.25rem">
                                                        ${otherSvcs.map(sn => `<label style="display:inline-flex;align-items:center;gap:0.2rem;font-size:0.7rem;cursor:pointer">
                                                            <input type="checkbox" class="dk-dep-${i}" value="${sn}" style="accent-color:var(--accent)" onchange="window._dkRefreshEnvSelects(${i})"> ${sn}
                                                        </label>`).join('')}
                                                        ${otherSvcs.length === 0 ? '<span style="font-size:0.7rem;color:var(--text-muted)">‚Äî</span>' : ''}
                                                    </div>
                                                </div>
                                            </div>
                                        </details>
                                    </div>
                                </div>`;
                            }
                            html += `</div>`;
                        } else {
                            // Manual container config
                            const defFamily = 'python';
                            const d = _dockerStackDefaults[defFamily];
                            html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);padding:0.6rem">
                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.4rem;align-items:start">
                                    <div>${_lbl('Stack template')}
                                        <select id="mf-dk-manual-stack" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem"
                                            onchange="var f=this.value;var sd=window._dkStackDefaults||{};var dd=sd[f]||{};
                                                var imgEl=document.getElementById('mf-dk-manual-img');if(imgEl){imgEl.innerHTML=(dd.images||[]).map(function(im,j){return '<option value=\"'+im+'\"'+(j===0?' selected':'')+'>'+im+'</option>'}).join('')+'<option value=\"__custom\">Custom‚Ä¶</option>';}
                                                var flds={'mf-dk-manual-workdir':'workdir','mf-dk-manual-install':'install','mf-dk-manual-build':'build','mf-dk-manual-cmd':'cmd','mf-dk-manual-entrypoint':'entrypoint'};
                                                for(var k in flds){var el=document.getElementById(k);if(el)el.value=dd[flds[k]]||'';}
                                                var pe=document.getElementById('mf-dk-manual-port');if(pe)pe.value=dd.expose||8080;
                                                var ee=document.getElementById('mf-dk-manual-expose');if(ee)ee.value=dd.expose||8080;">
                                            ${stackOpts.map(s => `<option value="${s}">${s}</option>`).join('')}
                                        </select>
                                    </div>
                                    <div>${_lbl('Base image')}${_imgSelect('mf-dk-manual-img', defFamily)}</div>
                                    <div>${_lbl('Port')}${_num('mf-dk-manual-port', d.expose)}</div>
                                    <div>${_lbl('Restart policy')}
                                        <select id="mf-dk-manual-restart" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem">
                                            ${_restartPolicies.map(r => `<option value="${r}"${r === 'unless-stopped' ? ' selected' : ''}>${r}</option>`).join('')}
                                        </select>
                                    </div>
                                </div>
                                <details style="margin-top:0.4rem">
                                    <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0">‚ñ∏ Dockerfile Settings</summary>
                                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem;margin-top:0.3rem">
                                        <div>${_lbl('Working directory')}${_inp('mf-dk-manual-workdir', d.workdir, '/app')}</div>
                                        <div>${_lbl('Install command')}${_inp('mf-dk-manual-install', d.install, '')}</div>
                                        <div>${_lbl('Build command', 'optional')}${_inp('mf-dk-manual-build', d.build, '')}</div>
                                        <div>${_lbl('Entrypoint', 'optional')}${_inp('mf-dk-manual-entrypoint', d.entrypoint, '')}</div>
                                        <div>${_lbl('CMD')}${_inp('mf-dk-manual-cmd', d.cmd, '')}</div>
                                        <div>${_lbl('EXPOSE port')}${_num('mf-dk-manual-expose', d.expose)}</div>
                                    </div>
                                </details>
                                <details style="margin-top:0.3rem">
                                    <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0">‚ñ∏ Compose Settings</summary>
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-top:0.3rem">
                                        <div>${_lbl('Container name', 'optional')}${_inp('mf-dk-manual-cname', '', 'app')}</div>
                                        <div>${_lbl('Health check', 'optional')}${_inp('mf-dk-manual-health', '', '')}</div>
                                        <div style="grid-column:1/-1">
                                            <details open style="margin-top:0.2rem">
                                                <summary style="cursor:pointer;font-size:0.78rem;color:var(--accent);user-select:none;padding:0.15rem 0">‚ñ∏ Environment Variables</summary>
                                                <div style="margin-top:0.25rem">
                                                    <div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;margin-bottom:0.15rem;padding:0 0.25rem">
                                                        <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Key</span>
                                                        <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Value</span>
                                                        <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Var / Secret</span>
                                                        <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Injection</span>
                                                        <span></span>
                                                    </div>
                                                    <div id="dk-svc-env-list-manual" style="display:flex;flex-direction:column;gap:0.15rem"></div>
                                                    <button type="button" onclick="window._dkAddEnvVar('manual')"
                                                        style="margin-top:0.25rem;font-size:0.78rem;padding:0.2rem 0.7rem;border:1px dashed var(--border-subtle);border-radius:4px;background:none;color:var(--accent);cursor:pointer">
                                                        + Add variable
                                                    </button>
                                                </div>
                                            </details>
                                        </div>
                                        <div>${_lbl('Volumes', 'host:container per line')}${_ta('mf-dk-manual-vol', '', '', 2)}</div>
                                    </div>
                                </details>
                            </div>`;
                            // Expose stack defaults to window for manual mode onchange
                            // Expose stack defaults for manual mode onchange handler
                            window._dkStackDefaults = _dockerStackDefaults;
                        }

                        // Overwrite warning
                        if (docker.has_dockerfile) {
                            html += `<div style="margin-top:0.5rem">
                                ${modalFormField({ name: 'dk-overwrite', label: 'Overwrite existing Dockerfile(s)', type: 'checkbox', value: false })}
                            </div>`;
                        }

                        // ‚îÄ‚îÄ Section B: Infra services ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        html += wizSection('Infrastructure Services', 'Optionally add common services to your compose file.');
                        html += `<div id="dk-infra-list" style="display:flex;flex-direction:column;gap:0.35rem">`;

                        // Helper: render the inline config panel for a service
                        const _infraCfgPanel = (inf) => {
                            const k = inf.key;
                            let p = `<div id="dk-infra-cfg-${k}" style="display:none;padding:0.55rem 0.6rem 0.6rem;border-top:1px solid var(--border-subtle);background:color-mix(in srgb,var(--bg-inset) 60%,transparent);font-size:0.82rem;color:var(--text-primary)">`;

                            // ‚îÄ‚îÄ Image selector
                            p += `<div style="display:flex;flex-wrap:wrap;gap:0.3rem 0.6rem;align-items:center;margin-bottom:0.35rem">`;
                            p += `<label style="font-weight:600;min-width:4rem;color:var(--text-secondary)">Image</label>`;
                            p += `<select id="mf-dk-infra-img-${k}" style="flex:1;min-width:10rem;padding:0.3rem 0.4rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);color-scheme:dark;font-size:0.8rem;font-family:monospace">`;
                            for (const img of inf.images) {
                                p += `<option value="${esc(img)}">${esc(img)}</option>`;
                            }
                            p += `<option value="__custom">‚å® Custom‚Ä¶</option></select>`;
                            p += `<input id="mf-dk-infra-imgcustom-${k}" type="text" placeholder="e.g. myregistry/image:tag" style="display:none;flex:1;min-width:10rem;padding:0.3rem 0.4rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);font-size:0.8rem;font-family:monospace">`;
                            p += `</div>`;

                            // ‚îÄ‚îÄ Ports
                            if (inf.ports.length > 0) {
                                p += `<div style="display:flex;flex-wrap:wrap;gap:0.2rem 0.5rem;align-items:center;margin-bottom:0.35rem">`;
                                p += `<span style="font-weight:600;min-width:4rem;color:var(--text-secondary)">Ports</span>`;
                                for (const pt of inf.ports) {
                                    p += `<label style="display:inline-flex;align-items:center;gap:0.2rem">`;
                                    p += `<input type="number" id="mf-dk-infra-port-${k}-${pt.port}" value="${pt.port}" min="1" max="65535" style="width:5rem;padding:0.25rem 0.3rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);font-size:0.8rem;font-family:monospace;text-align:center">`;
                                    p += `<span style="color:var(--text-secondary);font-size:0.78rem">${esc(pt.label)}</span>`;
                                    p += `</label>`;
                                }
                                p += `</div>`;
                            }

                            // ‚îÄ‚îÄ Environment fields (per-row with vault)
                            if (inf.envFields.length > 0) {
                                p += `<div style="margin-bottom:0.35rem">`;
                                p += `<details open style="margin-top:0.2rem">`;
                                p += `<summary style="cursor:pointer;font-size:0.78rem;color:var(--accent);user-select:none;padding:0.15rem 0">‚ñ∏ Environment Variables</summary>`;
                                p += `<div style="margin-top:0.25rem">`;
                                p += `<div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;margin-bottom:0.15rem;padding:0 0.25rem">`;
                                p += `<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Key</span>`;
                                p += `<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Value</span>`;
                                p += `<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Var / Secret</span>`;
                                p += `<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Injection</span>`;
                                p += `<span></span>`;
                                p += `</div>`;
                                p += `<div id="dk-svc-env-list-infra-${k}" style="display:flex;flex-direction:column;gap:0.15rem">`;
                                inf.envFields.forEach((ef, j) => {
                                    const injType = _dkDefaultInjType(ef.key);
                                    p += _dkEnvRowHtml('infra-' + k, j, ef.key, ef.default || '', injType, '');
                                });
                                p += `</div>`;
                                p += `<button type="button" onclick="window._dkAddEnvVar('infra-${k}')"
                                    style="margin-top:0.25rem;font-size:0.78rem;padding:0.2rem 0.7rem;border:1px dashed var(--border-subtle);border-radius:4px;background:none;color:var(--accent);cursor:pointer">
                                    + Add variable
                                </button>`;
                                p += `</div></details></div>`;
                            }

                            // ‚îÄ‚îÄ Volumes
                            if (inf.volumes.length > 0) {
                                p += `<div style="display:flex;flex-wrap:wrap;gap:0.2rem 0.5rem;align-items:center;margin-bottom:0.35rem">`;
                                p += `<span style="font-weight:600;min-width:4rem;color:var(--text-secondary)">Volumes</span>`;
                                for (const v of inf.volumes) {
                                    // host-bind (starts with /) vs named volume
                                    const isHostBind = v.name.startsWith('/');
                                    const volStr = isHostBind ? `${v.name}:${v.mount}` : `${v.name}:${v.mount}`;
                                    p += `<label style="display:inline-flex;align-items:center;gap:0.2rem">`;
                                    p += `<input type="checkbox" id="mf-dk-infra-vol-${k}-${v.name.replace(/[^a-zA-Z0-9]/g,'_')}" checked style="accent-color:var(--accent);width:14px;height:14px">`;
                                    p += `<code style="font-size:0.76rem;color:var(--text-secondary);background:var(--bg-base);padding:0.1rem 0.3rem;border-radius:3px">${esc(volStr)}</code>`;
                                    p += `</label>`;
                                }
                                p += `</div>`;
                            }

                            // ‚îÄ‚îÄ Command override
                            if (inf.command) {
                                p += `<div style="display:flex;gap:0.3rem;align-items:center;margin-bottom:0.35rem">`;
                                p += `<span style="font-weight:600;min-width:4rem;color:var(--text-secondary)">Command</span>`;
                                p += `<input type="text" id="mf-dk-infra-cmd-${k}" value="${esc(inf.command)}" style="flex:1;padding:0.25rem 0.3rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);font-size:0.8rem;font-family:monospace">`;
                                p += `</div>`;
                            }

                            // ‚îÄ‚îÄ Restart policy
                            p += `<div style="display:flex;gap:0.3rem;align-items:center;margin-bottom:0.2rem">`;
                            p += `<span style="font-weight:600;min-width:4rem;color:var(--text-secondary)">Restart</span>`;
                            p += `<select id="mf-dk-infra-restart-${k}" style="padding:0.25rem 0.3rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-base);color:var(--text-primary);color-scheme:dark;font-size:0.8rem">`;
                            for (const rp of _restartPolicies) {
                                p += `<option value="${rp}"${rp === 'unless-stopped' ? ' selected' : ''}>${rp}</option>`;
                            }
                            p += `</select>`;
                            p += `</div>`;

                            // ‚îÄ‚îÄ Note
                            if (inf.note) {
                                p += `<div style="font-size:0.76rem;color:var(--text-secondary);font-style:italic;margin-top:0.25rem">‚ÑπÔ∏è ${inf.note}</div>`;
                            }

                            p += `</div>`;
                            return p;
                        };

                        // Group by category
                        const catOrder = Object.keys(_infraCategories);
                        for (const cat of catOrder) {
                            const items = _infraOptions.filter(o => o.cat === cat);
                            if (items.length === 0) continue;
                            const isPopular = ['db-rel','cache','mq'].includes(cat);
                            html += `<details${isPopular ? ' open' : ''} style="border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-inset);overflow:hidden">
                                <summary style="cursor:pointer;padding:0.4rem 0.55rem;font-size:0.84rem;font-weight:600;color:var(--text-primary);user-select:none;display:flex;align-items:center;gap:0.3rem">
                                    ${_infraCategories[cat]}
                                    <span style="font-size:0.74rem;opacity:0.6;margin-left:auto">${items.length}</span>
                                </summary>
                                <div style="padding:0.3rem 0.5rem 0.4rem">`;
                            for (const inf of items) {
                                const primaryPort = inf.ports.length > 0 ? inf.ports[0].port : '';
                                html += `<div style="border:1px solid var(--border-subtle);border-radius:5px;margin-bottom:0.25rem;overflow:hidden;transition:border-color 0.15s"
                                    onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='var(--border-subtle)'">
                                    <label style="display:flex;align-items:center;gap:0.3rem;padding:0.3rem 0.5rem;cursor:pointer;font-size:0.82rem;color:var(--text-primary)">
                                        <input type="checkbox" id="mf-dk-infra-${inf.key}" data-infra-key="${inf.key}" class="dk-infra-toggle" style="accent-color:var(--accent);width:15px;height:15px">
                                        <strong>${esc(inf.label)}</strong>
                                        ${primaryPort ? `<span style="color:var(--text-secondary);font-size:0.76rem;margin-left:auto">:${primaryPort}</span>` : ''}
                                        <span style="font-size:0.72rem;color:var(--text-secondary);margin-left:${primaryPort ? '0.3rem' : 'auto'}">${inf.images[0].split(':')[0].split('/').pop()}</span>
                                    </label>
                                    ${_infraCfgPanel(inf)}
                                </div>`;
                            }
                            html += `</div></details>`;
                        }
                        html += `</div>`;

                        // ‚îÄ‚îÄ Section C: Options ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        html += wizSection('Generation Options', 'What files to create.');
                        html += `<div class="modal-form-grid">`;
                        html += modalFormField({ name: 'dk-compose', label: 'Generate docker-compose.yml', type: 'checkbox', value: !docker.has_compose || deployable.length > 1, fullWidth: true });
                        html += modalFormField({ name: 'dk-ignore',  label: 'Generate .dockerignore',      type: 'checkbox', value: !docker.has_dockerignore, fullWidth: true });
                        html += `</div>`;

                        el.innerHTML = html;

                        // Initial env collision check after render
                        window._wizValidation.recheck('dk');

                        // ‚îÄ‚îÄ Wire up infra checkbox toggle + custom image selector
                        el.addEventListener('change', (e) => {
                            const cb = e.target;
                            // Toggle config panel
                            if (cb.classList.contains('dk-infra-toggle')) {
                                const key = cb.dataset.infraKey;
                                const cfg = document.getElementById(`dk-infra-cfg-${key}`);
                                if (cfg) cfg.style.display = cb.checked ? 'block' : 'none';
                                // Trigger cross-row awareness for infra env rows
                                if (cb.checked) {
                                    const list = document.getElementById('dk-svc-env-list-infra-' + key);
                                    if (list) {
                                        list.querySelectorAll('.dk-env-row').forEach((row, j) => {
                                            const varSel = document.getElementById('dk-svc-env-var-infra-' + key + '-' + j);
                                            if (varSel) window._dkOnVarSelect(varSel);
                                        });
                                    }
                                }
                                window._wizValidation.recheck('dk');
                            }
                            // Custom image select
                            if (cb.tagName === 'SELECT' && cb.id && cb.id.startsWith('mf-dk-infra-img-')) {
                                const key = cb.id.replace('mf-dk-infra-img-', '');
                                const custom = document.getElementById(`mf-dk-infra-imgcustom-${key}`);
                                if (custom) custom.style.display = cb.value === '__custom' ? 'inline-block' : 'none';
                            }
                        });
                    },
                    collect: (data) => {
                        const deployable = (data._classified || []).filter(m => m._class === 'deployable' && m._family);

                        // Helper: parse KEY=VALUE textarea into dict
                        function _parseEnv(id) {
                            const el = document.getElementById(id);
                            if (!el || !el.value.trim()) return null;
                            const env = {};
                            for (const line of el.value.trim().split('\n')) {
                                const eq = line.indexOf('=');
                                if (eq > 0) env[line.slice(0, eq).trim()] = line.slice(eq + 1).trim();
                            }
                            return Object.keys(env).length > 0 ? env : null;
                        }

                        // Helper: parse line-separated textarea into array
                        function _parseLines(id) {
                            const el = document.getElementById(id);
                            if (!el || !el.value.trim()) return null;
                            const lines = el.value.trim().split('\n').map(l => l.trim()).filter(Boolean);
                            return lines.length > 0 ? lines : null;
                        }

                        // Helper: collect checked checkboxes by class
                        function _parseDeps(className) {
                            const cbs = document.querySelectorAll(`.${className}:checked`);
                            const deps = Array.from(cbs).map(cb => cb.value);
                            return deps.length > 0 ? deps : null;
                        }

                        // Helper: read a text/number input value
                        function _val(id) {
                            const el = document.getElementById(id);
                            return el ? el.value.trim() : '';
                        }

                        // Helper: read select value
                        function _sel(id) {
                            const el = document.getElementById(id);
                            return el ? el.value : '';
                        }

                        // Helper: resolve base image (handles custom option)
                        function _resolveImg(id) {
                            const sel = _sel(id);
                            if (sel === '__custom') return _val(id + '-custom') || '';
                            return sel || '';
                        }

                        // Global compose settings
                        data.projectName = _val('mf-dk-project-name');
                        data.platform    = _sel('mf-dk-platform');

                        // Collect selected module containers with all settings
                        data._selectedContainers = [];
                        if (deployable.length > 0) {
                            for (let i = 0; i < deployable.length; i++) {
                                if (mfVal(`dk-mod-${i}`)) {
                                    const m = deployable[i];
                                    const container = {
                                        name: m.name,
                                        path: m.path,
                                        stack: m.stack,
                                        family: m._family,
                                        // Primary
                                        baseImage: _resolveImg(`mf-dk-img-${i}`),
                                        port: parseInt(_val(`mf-dk-port-${i}`)) || m._port,
                                        dockerfilePath: _val(`mf-dk-dkpath-${i}`) || 'Dockerfile',
                                        restart: _sel(`mf-dk-restart-${i}`) || 'unless-stopped',
                                        // Dockerfile settings
                                        workdir: _val(`mf-dk-workdir-${i}`) || '/app',
                                        install: _val(`mf-dk-install-${i}`),
                                        buildCmd: _val(`mf-dk-build-${i}`),
                                        entrypoint: _val(`mf-dk-entrypoint-${i}`),
                                        cmd: _val(`mf-dk-cmd-${i}`),
                                        expose: parseInt(_val(`mf-dk-expose-${i}`)) || null,
                                        // Compose settings
                                        containerName: _val(`mf-dk-cname-${i}`),
                                        healthcheck: _val(`mf-dk-health-${i}`),
                                    };
                                    container.envVars = window._dkCollectEnvVars(i);
                                    const vols = _parseLines(`mf-dk-vol-${i}`);
                                    if (vols) container.volumes = vols;
                                    const deps = _parseDeps(`dk-dep-${i}`);
                                    if (deps) container.depends_on = deps;
                                    const buildArgs = _parseEnv(`mf-dk-buildargs-${i}`);
                                    if (buildArgs) container.build_args = buildArgs;
                                    const nets = _parseLines(`mf-dk-networks-${i}`);
                                    if (nets) container.networks = nets;
                                    data._selectedContainers.push(container);
                                }
                            }
                        } else {
                            // Manual mode
                            const family = _sel('mf-dk-manual-stack') || 'python';
                            const d = _dockerStackDefaults[family] || {};
                            const container = {
                                name: 'app',
                                path: '.',
                                stack: family,
                                family: family,
                                baseImage: _resolveImg('mf-dk-manual-img'),
                                port: parseInt(_val('mf-dk-manual-port')) || d.expose || 8080,
                                dockerfilePath: 'Dockerfile',
                                restart: _sel('mf-dk-manual-restart') || 'unless-stopped',
                                workdir: _val('mf-dk-manual-workdir') || d.workdir || '/app',
                                install: _val('mf-dk-manual-install') || d.install || '',
                                buildCmd: _val('mf-dk-manual-build'),
                                entrypoint: _val('mf-dk-manual-entrypoint'),
                                cmd: _val('mf-dk-manual-cmd') || d.cmd || '',
                                expose: parseInt(_val('mf-dk-manual-expose')) || d.expose || null,
                                containerName: _val('mf-dk-manual-cname'),
                                healthcheck: _val('mf-dk-manual-health'),
                            };
                            container.envVars = window._dkCollectEnvVars('manual');
                            const vols = _parseLines('mf-dk-manual-vol');
                            if (vols) container.volumes = vols;
                            data._selectedContainers.push(container);
                        }

                        // Infra services ‚Äî collect configured values
                        data._selectedInfra = [];
                        for (const inf of _infraOptions) {
                            if (!mfVal(`dk-infra-${inf.key}`)) continue;
                            const k = inf.key;

                            // Image
                            let image = _sel(`mf-dk-infra-img-${k}`) || inf.images[0];
                            if (image === '__custom') {
                                image = _val(`mf-dk-infra-imgcustom-${k}`) || inf.images[0];
                            }

                            // Ports ‚Äî read edited port values
                            const ports = [];
                            for (const pt of inf.ports) {
                                const edited = parseInt(_val(`mf-dk-infra-port-${k}-${pt.port}`)) || pt.port;
                                ports.push(`${edited}:${edited}`);
                            }

                            // Environment ‚Äî collect from per-row env vars
                            const envVars = window._dkCollectEnvVars('infra-' + k);

                            // Volumes ‚Äî only include checked ones
                            const volumes = [];
                            for (const v of inf.volumes) {
                                const volId = `mf-dk-infra-vol-${k}-${v.name.replace(/[^a-zA-Z0-9]/g,'_')}`;
                                if (mfVal(volId)) {
                                    const isHostBind = v.name.startsWith('/');
                                    volumes.push(isHostBind ? `${v.name}:${v.mount}` : `${v.name}:${v.mount}`);
                                }
                            }

                            // Command override
                            const command = _val(`mf-dk-infra-cmd-${k}`) || inf.command || '';

                            // Restart policy
                            const restart = _sel(`mf-dk-infra-restart-${k}`) || 'unless-stopped';

                            data._selectedInfra.push({
                                key: k,
                                label: inf.label,
                                image,
                                ports,
                                envVars,
                                volumes: volumes.length > 0 ? volumes : null,
                                command: command || null,
                                restart,
                            });
                        }

                        data.overwrite   = mfVal('dk-overwrite');
                        data.genCompose  = mfVal('dk-compose');
                        data.genIgnore   = mfVal('dk-ignore');
                    },
                    validate: (data) => {
                        if (data._selectedContainers.length === 0 && !data.genCompose && !data.genIgnore) {
                            return 'Select at least one module to containerize, or enable compose/.dockerignore generation.';
                        }
                        // Port conflict check using user-entered ports
                        const portMap = new Map();
                        for (const c of data._selectedContainers) {
                            if (portMap.has(c.port)) {
                                return `Port conflict: "${c.name}" and "${portMap.get(c.port)}" both use port ${c.port}.`;
                            }
                            portMap.set(c.port, c.name);
                        }
                        for (const inf of data._selectedInfra) {
                            for (const portMapping of (inf.ports || [])) {
                                const p = parseInt(portMapping.split(':')[0]);
                                if (!p) continue;
                                if (portMap.has(p)) {
                                    return `Port conflict: "${inf.label}" port ${p} conflicts with "${portMap.get(p)}".`;
                                }
                                portMap.set(p, inf.label);
                            }
                        }
                        return null;
                    },
                },

                // ‚îÄ‚îÄ Step 3: Preview & Edit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'preview', title: 'Preview',
                    render: async (data, el) => {
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Generating files‚Ä¶</p>';
                        const docker = data._docker || {};
                        data._generatedFiles = [];
                        let fileIdx = 0;

                        let html = wizSection('File Preview', 'Review and edit the generated files before writing to disk.');

                        try {
                            // ‚îÄ‚îÄ Generate Dockerfiles ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                            for (const c of data._selectedContainers) {
                                if (docker.has_dockerfile && !data.overwrite && c.dockerfilePath === 'Dockerfile') {
                                    html += `<div style="margin-bottom:0.75rem">
                                        <div style="display:flex;align-items:center;gap:0.4rem">
                                            <span>üìÑ</span>
                                            <strong style="font-size:0.82rem">${esc(c.dockerfilePath)}</strong>
                                            <span style="font-size:0.68rem;color:var(--text-muted);margin-left:auto">exists ‚Äî skipped</span>
                                        </div>
                                    </div>`;
                                    continue;
                                }

                                // Build Dockerfile content from user settings
                                let dfContent = '';
                                const img = c.baseImage || 'ubuntu:22.04';
                                const wd = c.workdir || '/app';

                                // Build stage
                                dfContent += `# ‚îÄ‚îÄ Build stage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                                dfContent += `FROM ${img} AS builder\n\nWORKDIR ${wd}\n\n`;
                                if (c.install) {
                                    dfContent += `# Install dependencies\nRUN ${c.install}\n\n`;
                                }
                                dfContent += `COPY . .\n`;
                                if (c.buildCmd) {
                                    dfContent += `RUN ${c.buildCmd}\n`;
                                }

                                // Runtime stage
                                dfContent += `\n# ‚îÄ‚îÄ Runtime stage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                                dfContent += `FROM ${img}\n\nWORKDIR ${wd}\n\n`;
                                dfContent += `# Create non-root user\n`;
                                if (img.includes('alpine')) {
                                    dfContent += `RUN addgroup -g 1000 app && adduser -u 1000 -G app -s /bin/sh -D app\n\n`;
                                } else {
                                    dfContent += `RUN groupadd --gid 1000 app \\\n    && useradd --uid 1000 --gid app --shell /bin/bash --create-home app\n\n`;
                                }
                                dfContent += `COPY --from=builder ${wd} ${wd}\n\n`;
                                dfContent += `USER app\n\n`;

                                if (c.expose) {
                                    dfContent += `EXPOSE ${c.expose}\n\n`;
                                }
                                if (c.entrypoint) {
                                    dfContent += `ENTRYPOINT ["${c.entrypoint}"]\n`;
                                }
                                if (c.cmd) {
                                    // Convert space-separated command to JSON array format
                                    const parts = c.cmd.split(/\s+/);
                                    dfContent += `CMD [${parts.map(p => `"${p}"`).join(', ')}]\n`;
                                }

                                const idx = fileIdx++;
                                const file = { path: c.dockerfilePath, content: dfContent, overwrite: !!data.overwrite };
                                data._generatedFiles.push(file);

                                html += `<div style="margin-bottom:0.75rem">
                                    <details open>
                                        <summary style="cursor:pointer;display:flex;align-items:center;gap:0.4rem;font-size:0.82rem;padding:0.3rem 0;user-select:none">
                                            <span>üìÑ</span>
                                            <strong>${esc(c.dockerfilePath)}</strong>
                                            <code style="font-size:0.68rem;background:var(--bg-inset);padding:1px 5px;border-radius:3px;color:var(--text-muted)">${esc(img)}</code>
                                            <span style="font-size:0.68rem;color:var(--success);margin-left:auto">create</span>
                                        </summary>
                                        <textarea id="dk-preview-${idx}"
                                            style="width:100%;min-height:200px;max-height:350px;resize:vertical;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.5rem;font-size:0.72rem;font-family:var(--font-mono,monospace);color:var(--text-secondary);margin-top:0.25rem;line-height:1.4"
                                        >${esc(file.content)}</textarea>
                                    </details>
                                </div>`;
                            }

                            // ‚îÄ‚îÄ Generate compose ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                            if (data.genCompose) {
                                const services = [];

                                // Module services (use all user-configured settings)
                                for (const c of data._selectedContainers) {
                                    const svc = {
                                        name: c.name,
                                        ports: [`${c.port}:${c.port}`],
                                        restart: c.restart || 'unless-stopped',
                                    };
                                    if (c.dockerfilePath === 'Dockerfile') {
                                        svc.build_context = '.';
                                    } else {
                                        svc.build_context = `./${c.path}`;
                                        svc.dockerfile = c.dockerfilePath.split('/').pop() || 'Dockerfile';
                                    }
                                    if (c.cmd) svc.command = c.cmd;
                                    // Convert envVars to compose environment format
                                    if (c.envVars && c.envVars.length > 0) {
                                        svc.environment = {};
                                        for (const ev of c.envVars) {
                                            if (ev.type === 'hardcoded') svc.environment[ev.key] = ev.value;
                                            else svc.environment[ev.key] = ev.varName || '${' + ev.key + '}';
                                        }
                                    }
                                    if (c.volumes) svc.volumes = c.volumes;
                                    if (c.depends_on) svc.depends_on = c.depends_on;
                                    if (c.containerName) svc.container_name = c.containerName;
                                    if (c.networks) svc.networks = c.networks;
                                    if (c.build_args) svc.build_args = c.build_args;
                                    if (data.platform) svc.platform = data.platform;
                                    if (c.healthcheck) {
                                        svc.healthcheck = {
                                            test: ['CMD-SHELL', c.healthcheck],
                                            interval: '30s',
                                            timeout: '10s',
                                            retries: 3,
                                        };
                                    }
                                    services.push(svc);
                                }

                                // Infra services ‚Äî use user-configured values
                                for (const inf of data._selectedInfra) {
                                    const svc = {
                                        name: inf.key,
                                        image: inf.image,
                                        restart: inf.restart || 'unless-stopped',
                                    };
                                    if (inf.ports && inf.ports.length > 0) svc.ports = inf.ports;
                                    // Convert envVars to compose environment format
                                    if (inf.envVars && inf.envVars.length > 0) {
                                        svc.environment = {};
                                        for (const ev of inf.envVars) {
                                            if (ev.type === 'hardcoded') svc.environment[ev.key] = ev.value;
                                            else svc.environment[ev.key] = ev.varName || '${' + ev.key + '}';
                                        }
                                    }
                                    if (inf.volumes) svc.volumes = inf.volumes;
                                    if (inf.command) svc.command = inf.command;
                                    if (data.platform) svc.platform = data.platform;
                                    services.push(svc);
                                }

                                if (services.length > 0) {
                                    const composeResult = await apiPost('/docker/generate/compose-wizard', {
                                        services,
                                        project_name: data.projectName || '',
                                    });

                                    if (composeResult.ok && composeResult.file) {
                                        const idx = fileIdx++;
                                        const file = { ...composeResult.file, overwrite: true };
                                        data._generatedFiles.push(file);

                                        html += `<div style="margin-bottom:0.75rem">
                                            <details open>
                                                <summary style="cursor:pointer;display:flex;align-items:center;gap:0.4rem;font-size:0.82rem;padding:0.3rem 0;user-select:none">
                                                    <span>üìã</span>
                                                    <strong>docker-compose.yml</strong>
                                                    <span style="font-size:0.68rem;color:var(--text-muted)">${services.length} service${services.length !== 1 ? 's' : ''}</span>
                                                    <span style="font-size:0.68rem;color:var(--success);margin-left:auto">create</span>
                                                </summary>
                                                <textarea id="dk-preview-${idx}"
                                                    style="width:100%;min-height:200px;max-height:350px;resize:vertical;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.5rem;font-size:0.72rem;font-family:var(--font-mono,monospace);color:var(--text-secondary);margin-top:0.25rem;line-height:1.4"
                                                >${esc(composeResult.file.content)}</textarea>
                                            </details>
                                        </div>`;
                                    }
                                }
                            }

                            // ‚îÄ‚îÄ Generate .dockerignore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                            if (data.genIgnore) {
                                const allStacks = [...new Set(data._selectedContainers.map(c => c.family))];
                                const ignoreResult = await apiPost('/docker/generate/dockerignore', {
                                    stacks: allStacks.length > 0 ? allStacks : ['python'],
                                });

                                if (ignoreResult.ok && ignoreResult.file) {
                                    const idx = fileIdx++;
                                    const file = { ...ignoreResult.file, overwrite: true };
                                    data._generatedFiles.push(file);

                                    html += `<div style="margin-bottom:0.75rem">
                                        <details>
                                            <summary style="cursor:pointer;display:flex;align-items:center;gap:0.4rem;font-size:0.82rem;padding:0.3rem 0;user-select:none">
                                                <span>üö´</span>
                                                <strong>.dockerignore</strong>
                                                <span style="font-size:0.68rem;color:var(--text-muted)">${allStacks.join(', ')} patterns</span>
                                                <span style="font-size:0.68rem;color:var(--success);margin-left:auto">create</span>
                                            </summary>
                                            <textarea id="dk-preview-${idx}"
                                                style="width:100%;min-height:120px;max-height:250px;resize:vertical;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.5rem;font-size:0.72rem;font-family:var(--font-mono,monospace);color:var(--text-secondary);margin-top:0.25rem;line-height:1.4"
                                            >${esc(ignoreResult.file.content)}</textarea>
                                        </details>
                                    </div>`;
                                }
                            }

                            if (data._generatedFiles.length === 0) {
                                html += `<div style="text-align:center;padding:var(--space-sm);color:var(--text-muted);font-size:0.85rem">
                                    No files to generate. Existing files are kept as-is.
                                </div>`;
                            } else {
                                html += `<div style="margin-top:0.5rem;font-size:0.78rem;color:var(--text-secondary)">
                                    ‚úèÔ∏è ${data._generatedFiles.length} file${data._generatedFiles.length !== 1 ? 's' : ''} generated ‚Äî edit content above if needed, then click Apply.
                                </div>`;
                            }

                            // Next integration CTA
                            html += `<div style="margin-top:var(--space-md);padding:var(--space-xs) var(--space-sm);border-left:3px solid var(--accent);background:color-mix(in srgb, var(--accent) 5%, transparent);border-radius:0 6px 6px 0">
                                <div style="font-size:0.78rem;color:var(--text-secondary)">
                                    üí° <strong>Next:</strong> Set up CI/CD to automate builds and deployments.
                                    <button class="btn btn-sm btn-ghost" style="font-size:0.72rem;padding:0.1rem 0.4rem;margin-left:4px;color:var(--accent)"
                                        onclick="wizardModalClose();setTimeout(openCICDSetupWizard,300)">Set up CI/CD ‚Üí</button>
                                </div>
                            </div>`;

                            el.innerHTML = html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>‚ö†Ô∏è</span><span>Generation failed: ${esc(e.message)}</span></div>`;
                        }
                    },
                    // Collect any user edits from the textareas before writing
                    collect: (data) => {
                        for (let i = 0; i < data._generatedFiles.length; i++) {
                            const ta = document.getElementById(`dk-preview-${i}`);
                            if (ta) {
                                data._generatedFiles[i].content = ta.value;
                            }
                        }
                    },
                },
            ],

            onComplete: async (data) => {
                const files = data._generatedFiles || [];
                if (files.length === 0) return;

                const results = [];
                for (const file of files) {
                    try {
                        const res = await api('/docker/generate/write', {
                            method: 'POST',
                            body: JSON.stringify({ file }),
                        });
                        results.push({ path: file.path, ok: !res.error, error: res.error });
                    } catch (e) {
                        results.push({ path: file.path, ok: false, error: e.message });
                    }
                }

                const ok = results.filter(r => r.ok).length;
                const fail = results.filter(r => !r.ok);
                if (fail.length > 0) {
                    console.warn('Docker write failures:', fail);
                }

                _projectStatusTS = 0;
                cardInvalidate('docker');
            },
            successMessage: 'Docker setup complete!',
        });
    }

    // ‚îÄ‚îÄ CI/CD Setup Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function openCICDSetupWizard() {
        wizardModalOpen({
            title: '‚ö° CI/CD Pipeline Setup',
            size: 'wide',
            steps: [
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // ‚îÄ‚îÄ Serve from cache if available (instant, zero API calls) ‚îÄ‚îÄ
                        const _CK = 'cicd:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // ‚îÄ‚îÄ Fresh scan ‚îÄ‚îÄ
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Detecting CI/CD configuration‚Ä¶</p>';
                        try {
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;
                            const probes = wizDetect.status_probes || {};
                            const cicd = probes.cicd || {};
                            const docker = probes.docker || {};
                            data._cicd = cicd;
                            data._docker = docker;
                            data._ciStatus = wizDetect.ci_status || {};

                            const html = `
                                ${wizSection('CI/CD Configuration', 'Current continuous integration / deployment setup.')}
                                <div class="wiz-status-grid">
                                    ${wizStatusRow('‚ö°', 'Provider', cicd.provider || 'Not configured', cicd.provider ? 'ok' : 'warn')}
                                    ${wizStatusRow('üìÑ', 'Workflow files', String(cicd.workflow_count || 0), cicd.workflow_count > 0 ? 'ok' : 'warn')}
                                    ${wizStatusRow('üê≥', 'Docker available', docker.has_dockerfile ? 'Yes' : 'No', docker.has_dockerfile ? 'ok' : 'muted')}
                                </div>
                                ${!docker.has_dockerfile ? `
                                    <div class="wiz-action-row" style="margin-top:1rem">
                                        <span class="wiz-action-label">üí° Set up Docker first for container-based CI/CD workflows.</span>
                                        <button class="btn btn-sm btn-secondary" onclick="wizardModalClose(); openDockerSetupWizard();">Setup Docker ‚Üí</button>
                                    </div>
                                ` : ''}
                            `;

                            // Store complete detect result in cache
                            wizStore(_CK, { h: html, d: { _cicd: data._cicd, _docker: data._docker, _ciStatus: data._ciStatus } }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>‚ö†Ô∏è</span><span>${esc(e.message)}</span></div>`;
                        }
                    },
                },
                {
                    id: 'config', title: 'Configure',
                    render: (data, el) => {
                        const docker = data._docker || {};
                        el.innerHTML = `
                            ${wizSection('Workflow Configuration', 'What should the CI pipeline do?')}
                            ${wizFormGrid([
                                { name: 'ci-test', label: 'Run tests', type: 'checkbox', value: true },
                                { name: 'ci-lint', label: 'Run linting', type: 'checkbox', value: true },
                                { name: 'ci-typecheck', label: 'Type checking', type: 'checkbox', value: true },
                                { name: 'ci-coverage', label: 'Upload coverage', type: 'checkbox', value: false },
                                { name: 'ci-docker', label: 'Build Docker image', type: 'checkbox', value: docker.has_dockerfile },
                                { name: 'ci-docker-push', label: 'Push to registry', type: 'checkbox', value: false },
                            ])}

                            ${wizSection('Trigger', 'When should the pipeline run?')}
                            ${wizFormGrid([
                                { name: 'ci-trigger', label: 'Trigger', type: 'select', value: 'push-pr', options: [
                                    { value: 'push-pr', label: 'Push + Pull Request' },
                                    { value: 'push', label: 'Push only' },
                                    { value: 'pr', label: 'Pull Request only' },
                                    { value: 'manual', label: 'Manual only' },
                                ]},
                                { name: 'ci-branch', label: 'Branch filter', value: 'main', placeholder: 'main, develop' },
                            ])}
                        `;
                    },
                    collect: (data) => {
                        data.runTests = mfVal('ci-test');
                        data.runLint = mfVal('ci-lint');
                        data.typeCheck = mfVal('ci-typecheck');
                        data.coverage = mfVal('ci-coverage');
                        data.dockerBuild = mfVal('ci-docker');
                        data.dockerPush = mfVal('ci-docker-push');
                        data.trigger = mfVal('ci-trigger');
                        data.branch = mfVal('ci-branch');
                    },
                },
                {
                    id: 'review', title: 'Review & Apply',
                    render: (data, el) => {
                        const steps = [];
                        if (data.runLint) steps.push('Lint');
                        if (data.typeCheck) steps.push('Type check');
                        if (data.runTests) steps.push('Test');
                        if (data.coverage) steps.push('Coverage');
                        if (data.dockerBuild) steps.push('Docker build');
                        if (data.dockerPush) steps.push('Docker push');

                        el.innerHTML = `
                            ${wizSection('Review', 'A GitHub Actions workflow will be generated.')}
                            <div class="wiz-review-item">
                                <span class="wiz-review-icon">üìÑ</span>
                                <div class="wiz-review-content">
                                    <div class="wiz-review-label">.github/workflows/ci.yml</div>
                                    <div class="wiz-review-value">Steps: ${steps.join(' ‚Üí ')}</div>
                                </div>
                                <span class="wiz-review-badge ready">create</span>
                            </div>
                            <div class="wiz-review-item">
                                <span class="wiz-review-icon">üîÄ</span>
                                <div class="wiz-review-content">
                                    <div class="wiz-review-label">Trigger</div>
                                    <div class="wiz-review-value">${esc(data.trigger || 'push-pr')} on ${esc(data.branch || 'main')}</div>
                                </div>
                            </div>
                        `;
                    },
                },
            ],
            onComplete: async (data) => {
                await apiPost('/wizard/setup', {
                    action: 'setup_ci',
                    test: data.runTests,
                    lint: data.runLint,
                    typecheck: data.typeCheck,
                    coverage: data.coverage,
                    docker_build: data.dockerBuild,
                    docker_push: data.dockerPush,
                    trigger: data.trigger,
                    branch: data.branch,
                });
                _projectStatusTS = 0;
            },
            successMessage: 'CI/CD pipeline created!',
        });
    }

    // ‚îÄ‚îÄ Kubernetes Setup Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function openK8sSetupWizard() {

        // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        /** Classify a module for K8s (same logic as Docker wizard). */
        function _k8sModClass(mod) {
            const dom = (mod.domain || '').toLowerCase();
            const st  = (mod.stack  || '').toLowerCase();
            if (dom === 'library')  return 'library';
            if (dom === 'docs' || st === 'markdown') return 'docs';
            if (['kubernetes', 'helm', 'terraform', 'docker-compose'].includes(st)) return 'ops-tool';
            return 'deployable';
        }

        /**
         * Classify a compose service as 'application' or 'infrastructure'.
         * Infrastructure = well-known DB/cache/broker images with no build context.
         * Application = has build context, or image matches project/module name.
         */
        function _k8sSvcClass(svc, moduleNames) {
            // Has build config ‚Üí definitely an application
            if (svc.build) return 'application';
            // Image matches a project module name ‚Üí application
            if (svc.image && moduleNames.some(n => svc.image.includes(n))) return 'application';
            // Well-known infrastructure image prefixes
            const infraImages = [
                'postgres', 'mysql', 'mariadb', 'mongo', 'redis', 'valkey', 'memcached',
                'rabbitmq', 'kafka', 'nats', 'mosquitto', 'elasticsearch', 'opensearch',
                'nginx', 'traefik', 'haproxy', 'envoy', 'caddy',
                'grafana', 'prometheus', 'jaeger', 'zipkin', 'loki',
                'minio', 'vault', 'consul', 'etcd', 'zookeeper',
                'mailpit', 'adminer', 'pgadmin', 'neo4j', 'cassandra',
                'cockroachdb', 'couchdb', 'influxdb', 'clickhouse', 'timescale',
                'redpanda', 'activemq', 'pulsar', 'celery',
                'gitea', 'portainer', 'seq', 'vector', 'fluentd', 'logstash',
                'keycloak', 'dex', 'hydra',
                'localstack', 'dynamodb-local', 'azurite',
                'dragonfly', 'keydb', 'arangodb', 'surrealdb',
            ];
            const imgLower = (svc.image || '').toLowerCase();
            if (infraImages.some(prefix => imgLower.includes(prefix))) return 'infrastructure';
            // No build + no known infra image ‚Üí treat as application (external image)
            return 'application';
        }

        /**
         * Classify what K8s workload kind a compose service should default to.
         * Returns: 'Deployment' | 'StatefulSet' | 'DaemonSet' | 'Job' | 'CronJob'
         */
        function _classifyWorkloadKind(svc) {
            const img = (svc.image || '').split(':')[0].split('/').pop().toLowerCase();
            const name = (svc.name || '').toLowerCase();

            // 1. Well-known stateful databases / brokers ‚Üí StatefulSet
            const statefulImages = new Set([
                'postgres', 'mysql', 'mariadb', 'mongo', 'mongodb', 'redis', 'valkey',
                'cassandra', 'cockroachdb', 'couchdb', 'neo4j', 'influxdb', 'clickhouse',
                'timescaledb', 'surrealdb', 'arangodb', 'dragonfly', 'keydb',
                'elasticsearch', 'opensearch', 'kafka', 'rabbitmq', 'nats',
                'redpanda', 'activemq', 'pulsar', 'zookeeper', 'etcd', 'consul',
                'minio', 'vault',
            ]);
            if (statefulImages.has(img)) return 'StatefulSet';

            // 2. Well-known node-level agents ‚Üí DaemonSet
            const daemonImages = new Set([
                'fluentd', 'fluent-bit', 'fluentbit', 'logstash', 'vector',
                'filebeat', 'metricbeat', 'node-exporter', 'promtail',
                'datadog-agent', 'newrelic-infra', 'falco',
            ]);
            if (daemonImages.has(img)) return 'DaemonSet';

            // 3. Compose deploy.mode: global ‚Üí DaemonSet
            if (svc.deploy && svc.deploy.mode === 'global') return 'DaemonSet';

            // 4. No ports + one-shot signals ‚Üí Job
            const noPorts = !svc.ports || svc.ports.length === 0;
            const isOneShot = svc.restart === 'no' || svc.restart === 'on-failure';
            const jobNamePatterns = ['migrate', 'migration', 'seed', 'init-db', 'setup', 'import'];
            const nameIsJob = jobNamePatterns.some(p => name.includes(p));
            if (noPorts && (isOneShot || nameIsJob)) return 'Job';

            // 5. Default ‚Üí Deployment
            return 'Deployment';
        }

        /** Map workload kind ‚Üí icon for display. */
        function _kindIcon(kind) {
            const icons = {
                'Deployment': 'üöÄ', 'StatefulSet': 'üóÑÔ∏è', 'DaemonSet': 'üåê',
                'Job': '‚ö°', 'CronJob': '‚è∞', 'Managed': '‚òÅÔ∏è', 'Skip': '‚è≠Ô∏è',
            };
            return icons[kind] || 'üì¶';
        }

        /** Map workload kind ‚Üí hint text explaining the heuristic. */
        function _kindHint(kind, svc) {
            const img = (svc.image || '').split(':')[0].split('/').pop().toLowerCase();
            switch (kind) {
                case 'StatefulSet': return 'üí° Database/stateful image detected ‚Üí stable identity + per-pod storage';
                case 'DaemonSet':
                    if (svc.deploy && svc.deploy.mode === 'global') return 'üí° Compose deploy.mode: global ‚Üí one pod per node';
                    return 'üí° Node-level agent detected ‚Üí one pod per node';
                case 'Job': return 'üí° No ports + one-shot restart ‚Üí run-to-completion task';
                case 'Deployment': return '';
                default: return '';
            }
        }

        /** Resolve best image name for a service in K8s context. */
        function _k8sImageName(svc, ghRepo) {
            // 1. If compose has explicit image ‚Üí use it
            if (svc.image) return svc.image;
            // 2. If we have a GitHub repo ‚Üí construct from registry
            if (ghRepo && ghRepo.owner && ghRepo.name) {
                return `ghcr.io/${ghRepo.owner}/${ghRepo.name}-${svc.name}:latest`;
            }
            // 3. Fallback
            return `${svc.name}:latest`;
        }

        /** Get the primary container port from a compose service. */
        function _k8sPrimaryPort(svc) {
            if (svc.ports && svc.ports.length > 0) return svc.ports[0].container;
            return 8080;
        }

        wizardModalOpen({
            title: '‚ò∏Ô∏è Kubernetes Setup',
            size: 'wide',
            steps: [
                // ‚îÄ‚îÄ Step 1: Detect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // ‚îÄ‚îÄ Serve from cache if available ‚îÄ‚îÄ
                        const _CK = 'k8s:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // ‚îÄ‚îÄ Fresh scan ‚îÄ‚îÄ
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Analyzing project for Kubernetes deployment‚Ä¶</p>';
                        try {
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;

                            // ‚îÄ‚îÄ Extract all data sources ‚îÄ‚îÄ
                            const probes = wizDetect.status_probes || {};
                            const k8s = probes.k8s || {};
                            const docker = probes.docker || {};
                            const dockerStatus = wizDetect.docker_status || {};
                            const configData = wizDetect.config_data || {};
                            const modules = configData.modules || [];
                            const envs = configData.environments || [];
                            const ghRepo = wizDetect.gh_repo_info || {};
                            const composeDetails = dockerStatus.compose_service_details || [];

                            // ‚îÄ‚îÄ Classify modules ‚îÄ‚îÄ
                            const classifiedModules = modules.map(m => ({
                                ...m,
                                _class: _k8sModClass(m),
                            }));
                            const deployableModules = classifiedModules.filter(m => m._class === 'deployable');
                            const moduleNames = modules.map(m => m.name);

                            // ‚îÄ‚îÄ Classify compose services ‚îÄ‚îÄ
                            const classifiedServices = composeDetails.map(svc => ({
                                ...svc,
                                _class: _k8sSvcClass(svc, moduleNames),
                                _image: _k8sImageName(svc, ghRepo),
                                _port: _k8sPrimaryPort(svc),
                            }));
                            const appServices = classifiedServices.filter(s => s._class === 'application');
                            const infraServices = classifiedServices.filter(s => s._class === 'infrastructure');

                            // ‚îÄ‚îÄ Store all data for subsequent steps ‚îÄ‚îÄ
                            data._k8s = k8s;
                            data._docker = docker;
                            data._dockerStatus = dockerStatus;
                            data._modules = modules;
                            data._classifiedModules = classifiedModules;
                            data._composeServices = classifiedServices;
                            data._appServices = appServices;
                            data._infraServices = infraServices;
                            data._ghRepo = ghRepo;
                            data._envs = envs;

                            // Fetch vault keys (secrets + config vars)
                            try {
                                const vaultData = await api('/vault/keys');
                                data._vaultKeys = (vaultData && vaultData.keys) || [];
                            } catch(e) { data._vaultKeys = []; }


                            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                            // ‚îÄ‚îÄ BUILD DETECT HTML ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                            // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                            // ‚îÄ‚îÄ Read-only scan banner ‚îÄ‚îÄ
                            let html = `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;margin-bottom:var(--space-sm);font-size:0.82rem;background:color-mix(in srgb, var(--accent) 10%, var(--bg-inset));border:1px solid color-mix(in srgb, var(--accent) 30%, transparent);border-radius:8px">
                                <span style="font-size:1.1rem">üîç</span>
                                <span style="flex:1;color:var(--text-secondary)">This is a <strong>read-only scan</strong>. To configure K8s resources, proceed to Configure.</span>
                                <button type="button" class="btn btn-xs" style="background:var(--accent);color:white;border:none;padding:4px 12px;border-radius:6px;font-size:0.78rem;white-space:nowrap;cursor:pointer"
                                    onclick="document.getElementById('wiz-btn-next')?.click()">Configure ‚Üí</button>
                            </div>`;

                            // ‚îÄ‚îÄ Section 1: Kubernetes Environment ‚îÄ‚îÄ
                            html += wizSection('Kubernetes Environment', 'Current K8s tooling and cluster status.');
                            html += `<div class="wiz-status-grid">
                                ${wizStatusRow('‚ò∏Ô∏è', 'kubectl', k8s.has_kubectl ? 'Available' : 'Not found', k8s.has_kubectl ? 'ok' : 'error')}
                                ${wizStatusRow('‚éà', 'Helm', k8s.has_helm ? 'Available' : 'Not found', k8s.has_helm ? 'ok' : 'muted')}
                                ${wizStatusRow('üîó', 'Cluster', k8s.cluster_connected ? 'Connected' : 'Not connected', k8s.cluster_connected ? 'ok' : 'warn')}
                                ${wizStatusRow('üìÑ', 'Manifests', k8s.manifest_count > 0 ? `${k8s.manifest_count} found` : 'None', k8s.manifest_count > 0 ? 'ok' : 'muted')}
                                ${wizStatusRow('üì¶', 'Helm Chart', k8s.has_chart ? 'Present' : 'None', k8s.has_chart ? 'ok' : 'muted')}
                            </div>`;

                            // ‚îÄ‚îÄ Section 2: Docker Context ‚îÄ‚îÄ
                            html += wizSection('Docker Context', 'Container infrastructure feeding K8s deployments.');
                            html += `<div class="wiz-status-grid">
                                ${wizStatusRow('üê≥', 'Docker', dockerStatus.available ? 'Available' : 'Not installed', dockerStatus.available ? 'ok' : 'error')}
                                ${wizStatusRow('üìã', 'Compose file', docker.has_compose ? (dockerStatus.compose_file || 'Present') : 'Missing', docker.has_compose ? 'ok' : 'warn')}
                                ${wizStatusRow('üìÑ', 'Dockerfiles', docker.has_dockerfile ? `${(dockerStatus.dockerfiles || []).length} found` : 'Missing', docker.has_dockerfile ? 'ok' : 'warn')}
                            </div>`;

                            if (!docker.has_dockerfile && !docker.has_compose) {
                                html += `<div class="wiz-step-warn-panel" style="margin-top:0.5rem">
                                    <span>üí°</span>
                                    <span style="flex:1">Set up Docker first ‚Äî K8s deployments need container images.</span>
                                    <button class="btn btn-sm btn-secondary" style="flex-shrink:0" onclick="wizardModalClose(); setTimeout(openDockerSetupWizard, 200)">Setup Docker ‚Üí</button>
                                </div>`;
                            }

                            // ‚îÄ‚îÄ Section 3: Compose Services (the key intelligence) ‚îÄ‚îÄ
                            if (composeDetails.length > 0) {
                                html += wizSection(
                                    'Compose Services',
                                    `${composeDetails.length} service${composeDetails.length !== 1 ? 's' : ''} detected ‚Äî ${appServices.length} application, ${infraServices.length} infrastructure.`
                                );
                                html += `<div style="display:flex;flex-direction:column;gap:0.25rem">`;
                                for (const svc of classifiedServices) {
                                    const isApp = svc._class === 'application';
                                    const badgeColor = isApp ? 'var(--success)' : 'var(--text-muted)';
                                    const badgeIcon = isApp ? 'üöÄ' : 'üóÑÔ∏è';
                                    const badgeLabel = isApp ? 'application' : 'infrastructure';
                                    const portStr = svc.ports.length > 0
                                        ? svc.ports.map(p => `:${p.container}`).join(' ')
                                        : '';
                                    const imgStr = svc.image
                                        ? svc.image.split('/').pop().split(':')[0]
                                        : (svc.build ? 'builds locally' : '‚Äî');

                                    html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.3rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                        <span style="width:18px;text-align:center">${badgeIcon}</span>
                                        <strong style="min-width:80px">${esc(svc.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(imgStr)}</code>
                                        ${portStr ? `<code style="font-size:0.68rem;color:var(--text-muted)">${esc(portStr)}</code>` : ''}
                                        <span style="flex:1"></span>
                                        ${Object.keys(svc.environment || {}).length > 0 ? `<span style="font-size:0.66rem;color:var(--text-muted)" title="${Object.keys(svc.environment).length} env vars">üîß${Object.keys(svc.environment).length}</span>` : ''}
                                        ${svc.volumes.length > 0 ? `<span style="font-size:0.66rem;color:var(--text-muted)" title="${svc.volumes.length} volumes">üíæ${svc.volumes.length}</span>` : ''}
                                        ${svc.healthcheck ? '<span style="font-size:0.66rem;color:var(--text-muted)" title="Has healthcheck">‚ù§Ô∏è</span>' : ''}
                                        <span style="font-size:0.68rem;color:${badgeColor}">${badgeLabel}</span>
                                    </div>`;
                                }
                                html += `</div>`;

                                if (appServices.length > 0) {
                                    html += `<div style="margin-top:0.5rem;font-size:0.78rem;color:var(--text-secondary)">
                                        üí° <strong>${appServices.length}</strong> application service${appServices.length !== 1 ? 's' : ''} will become K8s Deployments.
                                        ${infraServices.length > 0 ? `<strong>${infraServices.length}</strong> infrastructure service${infraServices.length !== 1 ? 's' : ''} ‚Äî choose StatefulSet, managed, or skip.` : ''}
                                    </div>`;
                                }
                            } else if (deployableModules.length > 0) {
                                // No compose but we have modules
                                html += wizSection('Project Modules', `${deployableModules.length} deployable module${deployableModules.length !== 1 ? 's' : ''} detected.`);
                                html += `<div style="display:flex;flex-direction:column;gap:0.25rem">`;
                                for (const m of classifiedModules) {
                                    const isDep = m._class === 'deployable';
                                    const badgeColor = isDep ? 'var(--success)' : 'var(--text-muted)';
                                    const badgeIcon = isDep ? 'üü¢' : m._class === 'library' ? 'üìö' : m._class === 'docs' ? 'üìù' : '‚öôÔ∏è';
                                    html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.3rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                        <span style="width:18px;text-align:center">${badgeIcon}</span>
                                        <strong style="min-width:80px">${esc(m.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(m.stack || '?')}</code>
                                        <span style="flex:1;color:var(--text-muted);font-size:0.72rem">${esc(m.path || '')}</span>
                                        <span style="font-size:0.68rem;color:${badgeColor}">${m._class}</span>
                                    </div>`;
                                }
                                html += `</div>`;
                            }

                            // ‚îÄ‚îÄ Section 4: Image Registry Context ‚îÄ‚îÄ
                            if (ghRepo.owner) {
                                html += wizSection('Registry Context', 'Container image naming from GitHub.');
                                html += `<div class="wiz-status-grid">
                                    ${wizStatusRow('üêô', 'Repository', `${ghRepo.owner}/${ghRepo.name}`, 'ok')}
                                    ${wizStatusRow('üì¶', 'Registry', `ghcr.io/${ghRepo.owner}/${ghRepo.name}`, 'ok')}
                                </div>`;
                            }

                            // ‚îÄ‚îÄ Section 5: Environments ‚îÄ‚îÄ
                            if (envs.length > 0) {
                                html += wizSection('Environments', `${envs.length} deployment environment${envs.length !== 1 ? 's' : ''} configured.`);
                                html += `<div style="display:flex;flex-wrap:wrap;gap:0.3rem">`;
                                for (const env of envs) {
                                    html += `<span style="display:inline-flex;align-items:center;gap:0.25rem;font-size:0.78rem;padding:0.2rem 0.5rem;border-radius:4px;background:var(--bg-inset);border:1px solid var(--border-subtle)">
                                        ${env.default ? '‚≠ê' : 'üè∑Ô∏è'} ${esc(env.name)}
                                    </span>`;
                                }
                                html += `</div>`;
                            }

                            // ‚îÄ‚îÄ Cache and set HTML ‚îÄ‚îÄ
                            const cacheData = {
                                _k8s: data._k8s,
                                _docker: data._docker,
                                _dockerStatus: data._dockerStatus,
                                _modules: data._modules,
                                _classifiedModules: data._classifiedModules,
                                _composeServices: data._composeServices,
                                _appServices: data._appServices,
                                _infraServices: data._infraServices,
                                _ghRepo: data._ghRepo,
                                _envs: data._envs,
                            };
                            wizStore(_CK, { h: html, d: cacheData }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>‚ö†Ô∏è</span><span>${esc(e.message)}</span></div>`;
                        }
                    },
                },

                // ‚îÄ‚îÄ Step 2: Configure ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'config', title: 'Configure',
                    render: async (data, el) => {
                        // ‚îÄ‚îÄ Load saved wizard state (if any) ‚îÄ‚îÄ
                        try {
                            const stRes = await api('/k8s/wizard-state');
                            if (stRes?.ok) {
                                data._wizardState = stRes;
                            }
                        } catch (_) { /* no saved state ‚Äî use detection defaults */ }

                        const projectName = (_wizardConfig && _wizardConfig.name) || 'app';
                        const appName = projectName.replace(/[^a-z0-9-]/gi, '-').toLowerCase();
                        const ghRepo = data._ghRepo || {};
                        const appSvcs = data._appServices || [];
                        const infraSvcs = data._infraServices || [];
                        const envs = data._envs || [];
                        const deployableModules = (data._classifiedModules || []).filter(m => m._class === 'deployable');
                        const hasCompose = appSvcs.length > 0 || infraSvcs.length > 0;

                        // ‚îÄ‚îÄ Saved wizard state (if previously persisted) ‚îÄ‚îÄ
                        const _savedState = data._wizardState || null;
                        const _savedSvc = (name) =>
                            _savedState?._services?.find(s => s.name === name) || null;
                        const _savedInfra = (name) =>
                            _savedState?._infraDecisions?.find(d => d.name === name) || null;

                        // Smart namespace default
                        const defaultNamespace = envs.find(e => e.default)
                            ? `${appName}-${envs.find(e => e.default).name}`
                            : 'default';

                        // ‚îÄ‚îÄ Mini label/input helpers (same pattern as Docker wizard) ‚îÄ‚îÄ
                        const _lbl = (txt, sub) => `<label style="display:block;font-size:0.7rem;color:var(--text-muted);margin-bottom:2px">${txt}${sub ? ` <span style="font-size:0.62rem;opacity:0.7">(${sub})</span>` : ''}</label>`;
                        const _inp = (id, val, ph) => `<input type="text" id="${id}" class="modal-form-input" value="${esc(val || '')}" placeholder="${ph || ''}" style="font-size:0.76rem;padding:0.2rem 0.3rem">`;
                        const _num = (id, val) => `<input type="number" id="${id}" class="modal-form-input" value="${val}" style="font-size:0.76rem;padding:0.2rem 0.3rem;width:80px">`;
                        const _sel = (id, opts, selected) => `<select id="${id}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem">${opts.map(o => `<option value="${o.v}"${o.v === selected ? ' selected' : ''}>${o.l}</option>`).join('')}</select>`;
                        const _ta = (id, val, ph, rows) => `<textarea id="${id}" class="modal-form-input" rows="${rows || 2}" placeholder="${ph || ''}" style="font-size:0.72rem;padding:0.2rem 0.3rem;font-family:var(--font-mono,monospace);resize:vertical;min-height:38px">${esc(val || '')}</textarea>`;

                        // ‚îÄ‚îÄ Resource quantity validation helper ‚îÄ‚îÄ
                        // K8s CPU: 100m, 0.5, 1, 1500m    Memory: 128Mi, 1Gi, 256M
                        const _isValidResQty = (v) => !v || /^\d+(\.\d+)?(m|Mi|Gi|Ki|Ti|M|G|K|T)?$/.test(v.trim());

                        // ‚îÄ‚îÄ QoS class helper ‚Äî what K8s assigns based on resource config ‚îÄ‚îÄ
                        // Guaranteed: every container has limits==requests for both CPU and memory
                        // Burstable:  at least one container has a request or limit set
                        // BestEffort: no limits or requests at all
                        const _qosHint = (cpuReq, cpuLim, memReq, memLim) => {
                            const hasAny = cpuReq || cpuLim || memReq || memLim;
                            if (!hasAny) return `<span style="color:var(--warning);font-size:0.64rem" title="No resource constraints ‚Äî pod may be evicted first under pressure">‚ö†Ô∏è BestEffort</span>`;
                            const allSet = cpuReq && cpuLim && memReq && memLim;
                            const reqEqLim = allSet && cpuReq.trim() === cpuLim.trim() && memReq.trim() === memLim.trim();
                            if (reqEqLim) return `<span style="color:var(--success);font-size:0.64rem" title="Requests equal limits ‚Äî highest priority, never throttled">‚úÖ Guaranteed</span>`;
                            return `<span style="color:var(--accent);font-size:0.64rem" title="Some constraints set ‚Äî can burst above requests up to limits">‚ö° Burstable</span>`;
                        };

                        // ‚îÄ‚îÄ Compose duration parser: "30s" ‚Üí 30, "1m" ‚Üí 60 ‚îÄ‚îÄ
                        const _parseDur = (s) => {
                            if (!s) return null;
                            const m = String(s).match(/^(\d+)(s|m|h)?$/);
                            if (!m) return null;
                            const v = parseInt(m[1]);
                            return m[2] === 'm' ? v * 60 : m[2] === 'h' ? v * 3600 : v;
                        };

                        // ‚îÄ‚îÄ Compose healthcheck ‚Üí K8s probe type/fields parser ‚îÄ‚îÄ
                        // Detects: curl/wget ‚Üí HTTP, nc -z ‚Üí TCP, pg_isready/redis-cli/mysqladmin ‚Üí Exec
                        const _parseComposeProbe = (hc, svcPort) => {
                            if (!hc || !hc.test) return { type: 'http', path: '/health', port: svcPort, command: '' };
                            const test = typeof hc.test === 'string' ? hc.test
                                : Array.isArray(hc.test) ? hc.test.slice(1).join(' ') : String(hc.test);
                            // curl -f http://localhost:8080/health
                            const curlM = test.match(/curl\s+[^]*?https?:\/\/[^:/]+(:(\d+))?(\/\S*)?/i);
                            if (curlM) return { type: 'http', path: curlM[3] || '/health', port: parseInt(curlM[2]) || svcPort, command: '' };
                            // wget --spider http://localhost:3000/healthz
                            const wgetM = test.match(/wget\s+[^]*?https?:\/\/[^:/]+(:(\d+))?(\/\S*)?/i);
                            if (wgetM) return { type: 'http', path: wgetM[3] || '/health', port: parseInt(wgetM[2]) || svcPort, command: '' };
                            // nc -z localhost 5432
                            const ncM = test.match(/nc\s+-z\s+\S+\s+(\d+)/);
                            if (ncM) return { type: 'tcp', path: '', port: parseInt(ncM[1]) || svcPort, command: '' };
                            // DB/cache exec patterns
                            if (/pg_isready|mysqladmin\s+ping|redis-cli\s+ping|mongo.*--eval/.test(test))
                                return { type: 'exec', path: '', port: svcPort, command: test };
                            // Fallback: exec with raw command
                            return { type: 'exec', path: '', port: svcPort, command: test };
                        };

                        // ‚îÄ‚îÄ Probe HTML block generator ‚îÄ‚îÄ
                        // Generates complete probe config UI with type-dependent field visibility
                        const _probeBlock = (prefix, label, probeType, path, port, command, delay, period, extra, extraLabel) => {
                            // onchange for type select: toggle path/port/command visibility
                            const typeOnchange = `var t=this.value;`
                                + `var p=document.getElementById('${prefix}-path-w');`
                                + `var pt=document.getElementById('${prefix}-port-w');`
                                + `var c=document.getElementById('${prefix}-cmd-w');`
                                + `if(p)p.style.display=t==='http'?'block':'none';`
                                + `if(pt)pt.style.display=t!=='exec'?'block':'none';`
                                + `if(c)c.style.display=t==='exec'?'block':'none'`;
                            // onchange for enable checkbox: toggle entire probe config
                            const enableOnchange = `var c=document.getElementById('${prefix}-cfg');if(c)c.style.display=this.checked?'block':'none'`;

                            return `<div style="padding:0.3rem 0">
                                <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.25rem">
                                    <label style="display:inline-flex;align-items:center;gap:0.25rem;cursor:pointer">
                                        <input type="checkbox" id="${prefix}-enable" checked style="accent-color:var(--accent);width:13px;height:13px"
                                            onchange="${enableOnchange}">
                                        <span style="font-weight:600;font-size:0.72rem;color:var(--text-primary)">${label}</span>
                                    </label>
                                    <select id="${prefix}-type" class="modal-form-select" style="font-size:0.72rem;padding:0.15rem 0.25rem"
                                        onchange="${typeOnchange}">
                                        <option value="http"${probeType === 'http' ? ' selected' : ''}>HTTP GET</option>
                                        <option value="tcp"${probeType === 'tcp' ? ' selected' : ''}>TCP Socket</option>
                                        <option value="exec"${probeType === 'exec' ? ' selected' : ''}>Exec</option>
                                    </select>
                                </div>
                                <div id="${prefix}-cfg">
                                    <div style="display:flex;gap:0.35rem;margin-bottom:0.2rem;flex-wrap:wrap">
                                        <div id="${prefix}-path-w" style="display:${probeType === 'http' ? 'block' : 'none'};min-width:130px;flex:2">
                                            ${_lbl('Path')}${_inp(`${prefix}-path`, path, '/health')}
                                        </div>
                                        <div id="${prefix}-port-w" style="display:${probeType !== 'exec' ? 'block' : 'none'};min-width:65px;flex:1">
                                            ${_lbl('Port')}${_num(`${prefix}-port`, port)}
                                        </div>
                                        <div id="${prefix}-cmd-w" style="display:${probeType === 'exec' ? 'block' : 'none'};flex:1;min-width:180px">
                                            ${_lbl('Command')}${_inp(`${prefix}-cmd`, command, 'pg_isready -U postgres')}
                                        </div>
                                    </div>
                                    <div style="display:flex;gap:0.35rem;flex-wrap:wrap">
                                        <div style="min-width:55px">
                                            ${_lbl('Delay', 's')}${_num(`${prefix}-delay`, delay)}
                                        </div>
                                        <div style="min-width:55px">
                                            ${_lbl('Period', 's')}${_num(`${prefix}-period`, period)}
                                        </div>
                                        <div style="min-width:55px">
                                            ${_lbl(extraLabel)}${_num(`${prefix}-extra`, extra)}
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        };

                        // ‚îÄ‚îÄ Secret key detection heuristic ‚îÄ‚îÄ
                        // Mirrors _SECRET_PATTERNS from vault_env_ops.py / secrets_ops.py:
                        //   {"key", "secret", "token", "password", "passwd", "pass",
                        //    "credential", "auth", "api_key", "apikey", "private",
                        //    "jwt", "cert", "certificate", "signing"}
                        // Same algorithm: substring match on lowercased key name.
                        const _SECRET_PATTERNS = [
                            'key', 'secret', 'token', 'password', 'passwd', 'pass',
                            'credential', 'auth', 'api_key', 'apikey', 'private',
                            'jwt', 'cert', 'certificate', 'signing',
                        ];
                        const _isSecretKey = (key) => {
                            const lower = key.toLowerCase();
                            return _SECRET_PATTERNS.some(p => lower.includes(p));
                        };

                        // ‚îÄ‚îÄ Env var injection ‚Äî multi-env awareness ‚îÄ‚îÄ
                        const isMultiEnv = envs.length > 1;
                        const _ENV_DEPENDENT_KEYS = new Set([
                            'node_env', 'app_env', 'environment', 'env',
                            'log_level', 'debug', 'stage', 'deploy_env',
                        ]);
                        const _defaultInjType = (key) => {
                            if (_isSecretKey(key)) return 'secret';
                            if (isMultiEnv && _ENV_DEPENDENT_KEYS.has(key.toLowerCase())) return 'variable';
                            return 'hardcoded';
                        };

                        // ‚îÄ‚îÄ Build available vars/secrets from VAULT ‚îÄ‚îÄ
                        const _vaultKeys = data._vaultKeys || [];
                        const _allEnvKeys = new Set();
                        const _availableVars = [];   // vault config keys
                        const _availableSecrets = []; // vault secret keys
                        _vaultKeys.forEach(vk => {
                            const k = vk.key;
                            if (_allEnvKeys.has(k)) return;
                            _allEnvKeys.add(k);
                            if (vk.kind === 'secret') _availableSecrets.push(k);
                            else _availableVars.push(k);
                        });
                        _availableVars.sort();
                        _availableSecrets.sort();

                        // ‚îÄ‚îÄ Build per-infra env map (infra name ‚Üí env keys) ‚îÄ‚îÄ
                        const _infraEnvMap = {};
                        infraSvcs.forEach(svc => {
                            _infraEnvMap[svc.name] = Object.keys(svc.environment || {});
                        });

                        // ‚îÄ‚îÄ Infrastructure service catalog ‚Äî reuse Docker's complete list ‚îÄ‚îÄ
                        // _infraOptions and _infraCategories are top-level constants (shared by all wizards).
                        // Build a quick lookup map by key for add/re-add operations.
                        const _INFRA_CATALOG = {};
                        _infraOptions.forEach(opt => {
                            _INFRA_CATALOG[opt.key] = opt;
                        });
                        window._INFRA_CATALOG = _INFRA_CATALOG;

                        // ‚îÄ‚îÄ Build <option> HTML for the var/secret select ‚îÄ‚îÄ
                        const _varSelectOpts = (injType, currentKey, currentVarName, svcIdx) => {
                            // Build suggested keys based on checked deps for this service
                            const suggestedSet = new Set();
                            const infraKey = typeof svcIdx === 'string' && svcIdx.startsWith('infra-')
                                ? svcIdx.replace(/^infra-/, '') : null;
                            if (infraKey && _infraEnvMap[infraKey]) {
                                // Infra service: suggest its own env fields
                                _infraEnvMap[infraKey].forEach(k => suggestedSet.add(k));
                            } else if (svcIdx !== undefined && svcIdx !== null) {
                                // App service: suggest from checked deps
                                const depCbs = document.querySelectorAll('.k8s-dep-' + svcIdx + ':checked');
                                if (depCbs.length > 0) {
                                    depCbs.forEach(cb => {
                                        const depName = cb.value;
                                        (_infraEnvMap[depName] || []).forEach(k => suggestedSet.add(k));
                                    });
                                } else if (document.querySelectorAll('.k8s-dep-' + svcIdx).length === 0) {
                                    // DOM not ready ‚Äî fallback to all
                                    Object.values(_infraEnvMap).forEach(keys => keys.forEach(k => suggestedSet.add(k)));
                                }
                            } else {
                                // No svcIdx ‚Äî show all
                                Object.values(_infraEnvMap).forEach(keys => keys.forEach(k => suggestedSet.add(k)));
                            }
                            const _suggestedKeys = [...suggestedSet].sort();
                            const dlr = '$';
                            const match = currentVarName || (dlr + '{' + currentKey + '}');
                            const shown = new Set();
                            let opts = '';
                            // Default: self-reference (always first)
                            if (currentKey) {
                                const selfVal = dlr + '{' + currentKey + '}';
                                opts += '<option value="' + esc(selfVal) + '"' + (match === selfVal ? ' selected' : '') + '>' + dlr + '{' + esc(currentKey) + '}</option>';
                                shown.add(currentKey);
                            }
                            // Suggested (from compose detection)
                            const suggested = _suggestedKeys.filter(k => !shown.has(k));
                            if (suggested.length > 0) {
                                opts += '<optgroup label="Suggested">';
                                suggested.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            // Vault Secrets
                            const secrets = _availableSecrets.filter(k => !shown.has(k));
                            if (secrets.length > 0) {
                                opts += '<optgroup label="Secrets">';
                                secrets.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            // Vault Variables
                            const vars = _availableVars.filter(k => !shown.has(k));
                            if (vars.length > 0) {
                                opts += '<optgroup label="Variables">';
                                vars.forEach(k => {
                                    const val = dlr + '{' + k + '}';
                                    opts += '<option value="' + esc(val) + '"' + (match === val ? ' selected' : '') + '>' + dlr + '{' + esc(k) + '}</option>';
                                    shown.add(k);
                                });
                                opts += '</optgroup>';
                            }
                            // Custom option
                            const stripped = match ? match.replace(/^\$\{|\}$/g, '') : '';
                            const isCustom = stripped && stripped !== currentKey && !_allEnvKeys.has(stripped);
                            opts += '<option value="__custom__"' + (isCustom ? ' selected' : '') + '>Custom...</option>';
                            return opts;
                        };

                        // ‚îÄ‚îÄ Per-variable row HTML builder ‚îÄ‚îÄ
                        const _envRowHtml = (i, j, key, value, injType, varName, svcIdx) => {
                            const isSubst = injType !== 'hardcoded';
                            const isSec = injType === 'secret';
                            const dlr = '$';
                            const varN = varName || (isSubst ? dlr + '{' + key + '}' : '');
                            const isCustomVar = varN && key && varN !== (dlr + '{' + key + '}') && !_allEnvKeys.has(varN.replace(/^\$\{|\}$/g, ''));
                            const selKey = isSubst ? (varN.replace(/^\$\{/, '').replace(/\}$/, '') || key) : key;
                            const varMissing = isSubst && selKey && !_allEnvKeys.has(selKey);
                            return '<div class="k8s-env-row" style="margin-bottom:0.15rem">'
                                // ‚îÄ‚îÄ Grid row ‚îÄ‚îÄ
                                + '<div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;align-items:center">'
                                + '<input type="text" id="k8s-svc-env-key-' + i + '-' + j + '" class="modal-form-input"'
                                + ' value="' + esc(key) + '" placeholder="KEY_NAME"'
                                + ' oninput="if(!this.dataset.envTs)this.dataset.envTs=Date.now();window._wizValidation.recheck(\'k8s\')"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)">'
                                + '<input type="' + (isSec ? 'password' : 'text') + '" id="k8s-svc-env-val-' + i + '-' + j + '" class="modal-form-input"'
                                + ' value="' + esc(value) + '" placeholder="' + (isSec ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' : 'value') + '"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)"' + (isSubst ? ' hidden' : '') + '>'
                                + '<div id="k8s-svc-env-varbox-' + i + '-' + j + '"' + (isSubst ? '' : ' hidden') + '>'
                                +   '<select id="k8s-svc-env-var-' + i + '-' + j + '" class="modal-form-select" data-i="' + i + '" data-j="' + j + '"'
                                +   ' style="font-size:0.82rem;padding:0.25rem 0.35rem;color:var(--accent)"'
                                +   ' onchange="window._onVarSelect(this)">'
                                +   (isSubst ? _varSelectOpts(injType, key, varN, svcIdx !== undefined ? svcIdx : i) : '<option>--</option>')
                                +   '</select>'
                                +   '<input type="text" id="k8s-svc-env-varcustom-' + i + '-' + j + '" class="modal-form-input"'
                                +   ' value="' + (isCustomVar ? esc(varN) : '') + '" placeholder="' + dlr + '{MY_VAR}"'
                                +   ' style="font-size:0.82rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace);color:var(--accent);margin-top:2px;display:' + (isCustomVar ? '' : 'none') + '">'
                                + '</div>'
                                + '<select id="k8s-svc-env-type-' + i + '-' + j + '" class="modal-form-select" data-i="' + i + '" data-j="' + j + '"'
                                + ' style="font-size:0.82rem;padding:0.25rem 0.35rem"'
                                + ' onchange="((sel)=>{'
                                +   'var si=sel.dataset.i,sj=sel.dataset.j;'
                                +   'var vb=document.getElementById(\'k8s-svc-env-varbox-\'+si+\'-\'+sj);'
                                +   'var ve=document.getElementById(\'k8s-svc-env-val-\'+si+\'-\'+sj);'
                                +   'var vs=document.getElementById(\'k8s-svc-env-var-\'+si+\'-\'+sj);'
                                +   'var isSub=sel.value!==\'hardcoded\';'
                                +   'if(vb)vb.hidden=!isSub;'
                                +   'if(ve)ve.hidden=isSub;'
                                +   'if(!isSub){var nt=document.getElementById(\'k8s-svc-env-notice-\'+si+\'-\'+sj);if(nt)nt.hidden=true;}'
                                +   'if(vs&&isSub){vs.innerHTML=window._varSelectOpts(sel.value,document.getElementById(\'k8s-svc-env-key-\'+si+\'-\'+sj).value,\'\',si);window._onVarSelect(vs);}'
                                +   'if(typeof _updateEnvSummary===\'function\')_updateEnvSummary(si);'
                                +   'window._wizValidation.recheck(\'k8s\');'
                                + '})(this)">'
                                + '<option value="hardcoded"' + (injType === 'hardcoded' ? ' selected' : '') + '>üìã Hardcoded</option>'
                                + '<option value="variable"' + (injType === 'variable' ? ' selected' : '') + '>üîÑ Variable</option>'
                                + '<option value="secret"' + (injType === 'secret' ? ' selected' : '') + '>üîí Secret</option>'
                                + '</select>'
                                + '<button type="button" onclick="this.closest(\'.k8s-env-row\').remove();if(typeof _updateEnvSummary===\'function\')_updateEnvSummary(\'' + i + '\');window._wizValidation.recheck(\'k8s\')"'
                                + ' style="background:none;border:none;cursor:pointer;font-size:0.82rem;color:var(--text-muted);padding:0 2px"'
                                + ' title="Remove variable">‚úï</button>'
                                + '</div>'
                                // ‚îÄ‚îÄ Notice (below the grid, outside it) ‚îÄ‚îÄ
                                + '<div id="k8s-svc-env-notice-' + i + '-' + j + '"' + (varMissing ? '' : ' hidden')
                                + ' style="font-size:0.78rem;color:var(--warning,#e8a820);margin:2px 0 4px;padding:4px 6px;border-radius:4px;background:rgba(232,168,32,0.06);border:1px solid rgba(232,168,32,0.15)">'
                                +   '<div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap">'
                                +     '<span>\u26a0\ufe0f <strong id="k8s-svc-env-notice-name-' + i + '-' + j + '">' + esc(selKey) + '</strong> does not exist yet</span>'
                                +     '<label style="display:flex;align-items:center;gap:3px;cursor:pointer">'
                                +       '<input type="checkbox" id="k8s-svc-env-create-' + i + '-' + j + '" checked style="margin:0">'
                                +       '<span>Create on execution</span>'
                                +     '</label>'
                                +   '</div>'
                                +   '<div id="k8s-svc-env-valbox-' + i + '-' + j + '" style="display:flex;align-items:center;gap:4px;margin-top:3px">'
                                +     '<input type="text" id="k8s-svc-env-newval-' + i + '-' + j + '" class="modal-form-input"'
                                +     ' placeholder="value (leave empty or generate)" style="flex:1;font-size:0.78rem;padding:0.25rem 0.35rem;font-family:var(--font-mono,monospace)">'
                                +     '<button type="button" onclick="window._generateVarValue(this)" data-i="' + i + '" data-j="' + j + '"'
                                +     ' style="font-size:0.78rem;padding:0.25rem 0.5rem;border:1px solid var(--border-subtle);border-radius:3px;background:var(--bg-card);cursor:pointer;white-space:nowrap"'
                                +     ' title="Generate a random value">üé≤ Generate</button>'
                                +   '</div>'
                                +   '<div id="k8s-svc-env-elsewhere-' + i + '-' + j + '" hidden style="font-size:0.76rem;color:var(--text-muted);font-style:italic;margin-top:3px">'
                                +     '\u2139\ufe0f Value already being created by <strong id="k8s-svc-env-elsewhere-src-' + i + '-' + j + '"></strong>'
                                +   '</div>'
                                + '</div>'
                                + '<div id="k8s-svc-env-dupe-' + i + '-' + j + '" hidden'
                                + ' style="font-size:0.76rem;margin:1px 0 3px;padding:3px 6px;border-radius:4px">'
                                + '</div>'
                                + '</div>';
                        };

                        // Expose for dynamic onchange use
                        window._varSelectOpts = _varSelectOpts;
                        window._allEnvKeysSet = _allEnvKeys;

                        // ‚îÄ‚îÄ Var select onchange: check existence, show notice ‚îÄ‚îÄ
                        window._onVarSelect = (sel) => {
                            const ci = sel.dataset.i, cj = sel.dataset.j;
                            const tb = document.getElementById('k8s-svc-env-varcustom-' + ci + '-' + cj);
                            const nt = document.getElementById('k8s-svc-env-notice-' + ci + '-' + cj);
                            if (sel.value === '__custom__') {
                                if (tb) tb.style.display = '';
                                if (nt) nt.hidden = true;
                            } else {
                                if (tb) tb.style.display = 'none';
                                if (nt) {
                                    const varKey = sel.value.replace(/^\$\{/, '').replace(/\}$/, '');
                                    // Smart key sync: update key if empty or still matches prev var
                                    const keyInput = document.getElementById('k8s-svc-env-key-' + ci + '-' + cj);
                                    if (keyInput) {
                                        const curKey = keyInput.value.trim().toUpperCase();
                                        const prevVar = (keyInput.dataset.lastVar || '').toUpperCase();
                                        if (!curKey || curKey === prevVar) {
                                            keyInput.value = varKey;
                                            keyInput.dataset.envTs = Date.now();
                                        }
                                        keyInput.dataset.lastVar = varKey;
                                    }
                                    const exists = _allEnvKeys.has(varKey);
                                    nt.hidden = exists;
                                    const nameEl = document.getElementById('k8s-svc-env-notice-name-' + ci + '-' + cj);
                                    if (nameEl) nameEl.textContent = varKey;
                                    const valbox = document.getElementById('k8s-svc-env-valbox-' + ci + '-' + cj);
                                    const elsewhere = document.getElementById('k8s-svc-env-elsewhere-' + ci + '-' + cj);
                                    if (!exists && varKey) {
                                        if (valbox) valbox.style.display = 'flex';
                                        if (elsewhere) elsewhere.hidden = true;
                                    } else {
                                        if (valbox) valbox.style.display = 'flex';
                                        if (elsewhere) elsewhere.hidden = true;
                                    }
                                }
                            }
                            // Shared symmetric collision check
                            window._wizValidation.recheck('k8s');
                        };
                        // ‚îÄ‚îÄ Refresh env selects when deps change ‚îÄ‚îÄ
                        window._refreshEnvSelects = (svcIdx) => {
                            const list = document.getElementById('k8s-svc-env-list-' + svcIdx);
                            if (!list) return;
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (!keyEl) return;
                                const j = keyEl.id.split('-').pop();
                                const typeSel = document.getElementById('k8s-svc-env-type-' + svcIdx + '-' + j);
                                const varSel = document.getElementById('k8s-svc-env-var-' + svcIdx + '-' + j);
                                if (!typeSel || !varSel || typeSel.value === 'hardcoded') return;
                                const keySel = document.getElementById('k8s-svc-env-key-' + svcIdx + '-' + j);
                                const currentKey = keySel ? keySel.value : '';
                                const currentVar = varSel.value;
                                varSel.innerHTML = window._varSelectOpts(typeSel.value, currentKey, currentVar, svcIdx);
                                window._onVarSelect(varSel);
                            });
                        };

                        // ‚îÄ‚îÄ Generate random value for the notice input ‚îÄ‚îÄ
                        window._generateVarValue = (btn) => {
                            const ci = btn.dataset.i, cj = btn.dataset.j;
                            const inp = document.getElementById('k8s-svc-env-newval-' + ci + '-' + cj);
                            if (!inp) return;
                            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#%&*';
                            let val = '';
                            for (let n = 0; n < 32; n++) val += chars[Math.floor(Math.random() * chars.length)];
                            inp.value = val;
                        };

                        // Band-aid _recheckAllEnvCollisions removed ‚Äî replaced by shared
                        // window._wizValidation.recheck('k8s') via the registry system.

                        // ‚îÄ‚îÄ Add variable button handler ‚îÄ‚îÄ
                        window._addEnvVar = (i) => {
                            const list = document.getElementById('k8s-svc-env-list-' + i);
                            if (!list) return;
                            // Find max existing j to avoid ID collisions after row deletions
                            let maxJ = -1;
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                const keyInput = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (keyInput) {
                                    const parts = keyInput.id.split('-');
                                    const jVal = parseInt(parts[parts.length - 1]);
                                    if (!isNaN(jVal) && jVal > maxJ) maxJ = jVal;
                                }
                            });
                            const j = maxJ + 1;
                            const row = document.createElement('div');
                            row.innerHTML = _envRowHtml(i, j, '', '', 'hardcoded', '', i);
                            list.appendChild(row.firstElementChild);
                            _updateEnvSummary(i);
                            window._wizValidation.recheck('k8s');
                        };

                        // ‚îÄ‚îÄ Live summary updater ‚îÄ‚îÄ
                        window._updateEnvSummary = (i) => {
                            const sumEl = document.getElementById('k8s-svc-env-summary-' + i);
                            if (!sumEl) return;
                            const list = document.getElementById('k8s-svc-env-list-' + i);
                            if (!list) return;
                            let hc = 0, vr = 0, sc = 0;
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                // Extract actual j from key input ID (k8s-svc-env-key-{i}-{j})
                                const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (!keyEl) return;
                                const parts = keyEl.id.split('-');
                                const j = parts[parts.length - 1];
                                const sel = document.getElementById('k8s-svc-env-type-' + i + '-' + j);
                                const key = document.getElementById('k8s-svc-env-key-' + i + '-' + j);
                                if (!sel || !key || !key.value.trim()) return;
                                if (sel.value === 'secret') sc++;
                                else if (sel.value === 'variable') vr++;
                                else hc++;
                            });
                            const dlr = '$';
                            const parts = [];
                            if (hc + vr > 0) parts.push('üìã ConfigMap: ' + hc + ' hardcoded' + (vr > 0 ? ', ' + vr + ' ' + dlr + '{VAR}' : ''));
                            if (sc > 0) parts.push('üîí Secret: ' + sc + ' key' + (sc !== 1 ? 's' : '') + ' (' + dlr + '{VAR} at deploy)');
                            if (parts.length === 0) parts.push('No environment variables configured');
                            sumEl.innerHTML = parts.join(' &nbsp;\u00b7&nbsp; ');
                        };

                        // ‚îÄ‚îÄ Collect env vars from per-variable rows ‚îÄ‚îÄ
                        window._collectEnvVars = (i) => {
                            const list = document.getElementById('k8s-svc-env-list-' + i);
                            if (!list) return [];
                            const vars = [];
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                // Extract actual j from key input ID (k8s-svc-env-key-{i}-{j})
                                const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (!keyEl) return;
                                const parts = keyEl.id.split('-');
                                const j = parts[parts.length - 1];
                                const key = (document.getElementById('k8s-svc-env-key-' + i + '-' + j) || {}).value || '';
                                if (!key.trim()) return;
                                const type = (document.getElementById('k8s-svc-env-type-' + i + '-' + j) || {}).value || 'hardcoded';
                                const value = (document.getElementById('k8s-svc-env-val-' + i + '-' + j) || {}).value || '';
                                const varSel = document.getElementById('k8s-svc-env-var-' + i + '-' + j);
                                const varCustom = document.getElementById('k8s-svc-env-varcustom-' + i + '-' + j);
                                let varName = null;
                                if (type !== 'hardcoded') {
                                    if (varSel && varSel.value === '__custom__' && varCustom && varCustom.value.trim()) {
                                        varName = varCustom.value.trim();
                                    } else if (varSel && varSel.value && varSel.value !== '__custom__') {
                                        varName = varSel.value;
                                    } else {
                                        varName = '${' + key.trim() + '}';
                                    }
                                }
                                // Check if "Create on execution" is checked + new value
                                const createChk = document.getElementById('k8s-svc-env-create-' + i + '-' + j);
                                const newValInp = document.getElementById('k8s-svc-env-newval-' + i + '-' + j);
                                const notice = document.getElementById('k8s-svc-env-notice-' + i + '-' + j);
                                const createInVault = notice && !notice.hidden && createChk && createChk.checked;
                                const newValue = createInVault && newValInp ? newValInp.value.trim() : '';
                                vars.push({ key: key.trim(), type, value: value.trim(), varName, createInVault: !!createInVault, newValue });
                            });
                            return vars;
                        };
                        const _collectEnvVars = window._collectEnvVars;

                        // ‚îÄ‚îÄ Well-known StorageClass catalog ‚îÄ‚îÄ
                        // Always available regardless of cluster connectivity.
                        // Cluster detection (async) merges in detected classes + marks them.
                        const _SC_CATALOG = [
                            { group: 'Self-hosted', items: [
                                { name: 'longhorn',         provisioner: 'driver.longhorn.io',               hint: 'Distributed block storage for K8s', hasExtra: true },
                                { name: 'local-path',       provisioner: 'rancher.io/local-path',            hint: 'Local node storage (Rancher/K3s)' },
                                { name: 'nfs-client',       provisioner: 'cluster.local/nfs-subdir-external', hint: 'NFS external provisioner' },
                                { name: 'openebs-hostpath', provisioner: 'openebs.io/local',                 hint: 'OpenEBS local PV' },
                                { name: 'rook-ceph-block',  provisioner: 'rook-ceph.rbd.csi.ceph.com',       hint: 'Ceph block via Rook' },
                            ]},
                            { group: 'AWS', items: [
                                { name: 'gp3',  provisioner: 'ebs.csi.aws.com',     hint: 'General purpose SSD (recommended)' },
                                { name: 'gp2',  provisioner: 'kubernetes.io/aws-ebs', hint: 'General purpose SSD (legacy)' },
                                { name: 'io1',  provisioner: 'ebs.csi.aws.com',     hint: 'Provisioned IOPS SSD' },
                                { name: 'efs-sc', provisioner: 'efs.csi.aws.com',   hint: 'Elastic File System (NFS)' },
                            ]},
                            { group: 'GKE', items: [
                                { name: 'standard-rwo',  provisioner: 'pd.csi.storage.gke.io', hint: 'Standard persistent disk' },
                                { name: 'premium-rwo',   provisioner: 'pd.csi.storage.gke.io', hint: 'SSD persistent disk' },
                            ]},
                            { group: 'Azure', items: [
                                { name: 'managed-csi',         provisioner: 'disk.csi.azure.com', hint: 'Azure managed disk (LRS)' },
                                { name: 'managed-csi-premium', provisioner: 'disk.csi.azure.com', hint: 'Premium SSD managed disk' },
                                { name: 'azurefile-csi',       provisioner: 'file.csi.azure.com', hint: 'Azure File Share (RWX)' },
                            ]},
                            { group: 'DigitalOcean', items: [
                                { name: 'do-block-storage', provisioner: 'dobs.csi.digitalocean.com', hint: 'Block storage volume' },
                            ]},
                        ];
                        // Build a flat lookup for Longhorn-like detection
                        const _SC_FLAT = {};
                        _SC_CATALOG.forEach(g => g.items.forEach(sc => { _SC_FLAT[sc.name] = sc; }));

                        // Build StorageClass <select> options from catalog
                        const _scSelectHtml = () => {
                            let h = '<option value="">(cluster default ‚Äî no StorageClass in PVC)</option>';
                            _SC_CATALOG.forEach(g => {
                                h += '<optgroup label="' + esc(g.group) + '">';
                                g.items.forEach(sc => {
                                    const detected = sc._detected ? ' ‚úì' : '';
                                    h += '<option value="' + esc(sc.name) + '" title="' + esc(sc.provisioner) + '">' + esc(sc.name) + ' ‚Äî ' + esc(sc.hint) + detected + '</option>';
                                });
                                h += '</optgroup>';
                            });
                            h += '<optgroup label="Other">';
                            h += '<option value="_custom">‚úèÔ∏è Custom (type name)‚Ä¶</option>';
                            h += '</optgroup>';
                            return h;
                        };

                        // ‚îÄ‚îÄ Volume classification from compose string ‚îÄ‚îÄ
                        window._classifyVolume = (volStr) => {
                            const parts = (volStr || '').split(':');
                            const source = parts[0] || '';
                            const target = parts[1] || source;
                            const flags = parts[2] || '';
                            const readOnly = flags.includes('ro');

                            // Named volume (no path separator in source)
                            if (!source.includes('/') && !source.startsWith('.')) {
                                return { type: 'pvc-dynamic', name: source, mountPath: target, readOnly, source, defaultSize: '10Gi', classification: 'named' };
                            }
                            // Dev bind mount ‚Äî source code directories (skip by default)
                            if (/^\.\/(src|app|lib|pkg|cmd|internal|components|pages|public|assets|frontend|backend|server|client|api)/.test(source)) {
                                return { type: 'skip', name: source.replace(/^\.\//, '').replace(/\//g, '-'), mountPath: target, readOnly, source, classification: 'dev-bind', skipReason: 'Source code is baked into the container image at build time' };
                            }
                            // Data bind mount ‚Äî persistent data
                            if (/^\.\/(data|db|storage|uploads|logs|backup|config|certs|ssl|tls)/.test(source) || /^\//.test(source)) {
                                return { type: 'pvc-dynamic', name: source.replace(/^\.\//, '').replace(/\//g, '-'), mountPath: target, readOnly, source, defaultSize: '5Gi', classification: 'data-bind' };
                            }
                            // Unknown bind mount ‚Äî skip by default
                            return { type: 'skip', name: source.replace(/^\.\//, '').replace(/\//g, '-'), mountPath: target, readOnly, source, classification: 'unknown-bind', skipReason: 'Bind mount ‚Äî may not be needed in K8s (override if needed)' };
                        };

                        // ‚îÄ‚îÄ Convert saved-state volume to classification shape ‚îÄ‚îÄ
                        // Maps the collector's output fields into the classification
                        // object that _volRowHtml consumes.  Extra type-specific
                        // saved values are carried as _saved* for post-render restore.
                        window._savedVolToClassification = (vol) => ({
                            type:           vol.type || 'pvc-dynamic',
                            name:           vol.name || vol.configMapName || vol.secretName || vol.hostPath || '',
                            mountPath:      vol.mountPath || '',
                            readOnly:       vol.readOnly || false,
                            source:         vol.hostPath || '',
                            defaultSize:    vol.size || '10Gi',
                            classification: 'saved',
                            skipReason:     null,
                            // Carry-through for post-render restore
                            _savedAccessMode:       vol.accessMode,
                            _savedStorageClass:     vol.storageClass,
                            _savedLonghorn:         vol.longhornConfig,
                            _savedPvName:           vol.pvName,
                            _savedMedium:           vol.medium,
                            _savedSizeLimit:        vol.sizeLimit,
                            _savedCmKey:            vol.key,         // configMap key
                            _savedSecKey:           vol.key,         // secret key
                            _savedHostType:         vol.hostType,
                        });

                        // ‚îÄ‚îÄ Post-render: restore type-specific fields on volume rows ‚îÄ‚îÄ
                        // Called after HTML is in the DOM.  Sets select/input values
                        // that _volRowHtml hardcodes (accessMode, storageClass, etc).
                        window._restoreVolFields = (i, j, cl) => {
                            if (cl.classification !== 'saved') return;
                            const _set = (id, val) => { const el = document.getElementById(id); if (el && val) el.value = val; };
                            const t = cl.type || 'pvc-dynamic';
                            if (t === 'pvc-dynamic' || t === 'pvc-static') {
                                _set('k8s-svc-vol-access-' + i + '-' + j, cl._savedAccessMode);
                                _set('k8s-svc-vol-sc-' + i + '-' + j, cl._savedStorageClass);
                                if (t === 'pvc-static') _set('k8s-svc-vol-pvname-' + i + '-' + j, cl._savedPvName);
                                if (cl._savedLonghorn) {
                                    _set('k8s-vol-lh-replicas-' + i + '-' + j, cl._savedLonghorn.replicas);
                                    _set('k8s-vol-lh-locality-' + i + '-' + j, cl._savedLonghorn.dataLocality);
                                    // Show longhorn panel if storageClass matches
                                    const lhPanel = document.getElementById('k8s-vol-lh-' + i + '-' + j);
                                    if (lhPanel) lhPanel.style.display = 'block';
                                }
                            } else if (t === 'emptyDir') {
                                _set('k8s-svc-vol-medium-' + i + '-' + j, cl._savedMedium);
                                _set('k8s-svc-vol-sizelimit-' + i + '-' + j, cl._savedSizeLimit);
                            } else if (t === 'configMap') {
                                _set('k8s-svc-vol-cmkey-' + i + '-' + j, cl._savedCmKey);
                            } else if (t === 'secret') {
                                _set('k8s-svc-vol-seckey-' + i + '-' + j, cl._savedSecKey);
                            } else if (t === 'hostPath') {
                                _set('k8s-svc-vol-hosttype-' + i + '-' + j, cl._savedHostType);
                            }
                        };

                        // ‚îÄ‚îÄ Volume row HTML generator ‚îÄ‚îÄ
                        window._volRowHtml = (i, j, cl) => {
                            const isSkip = cl.type === 'skip';
                            const checked = !isSkip ? ' checked' : '';
                            const defType = isSkip ? 'emptyDir' : (cl.type || 'pvc-dynamic');
                            const typeOpts = [
                                { v: 'pvc-dynamic', l: 'üíæ PVC (dynamic)' },
                                { v: 'pvc-static',  l: 'üíæ PVC (static ‚Äî advanced)' },
                                { v: 'emptyDir',    l: 'üìÇ emptyDir (ephemeral)' },
                                { v: 'configMap',   l: 'üìÑ ConfigMap (file mount)' },
                                { v: 'secret',      l: 'üîê Secret (file mount)' },
                                { v: 'hostPath',    l: '‚ö†Ô∏è hostPath (not recommended)' },
                            ];
                            const typeSelectHtml = '<select id="k8s-svc-vol-type-' + i + '-' + j + '" class="modal-form-select" data-i="' + i + '" data-j="' + j + '" style="font-size:0.72rem;padding:0.15rem 0.2rem;flex:1" onchange="window._k8sVolTypeChange(\'' + i + '\',' + j + ')">'
                                + typeOpts.map(o => '<option value="' + o.v + '"' + (o.v === defType ? ' selected' : '') + '>' + o.l + '</option>').join('')
                                + '</select>';
                            const nameVal = (cl.name || '').replace(/[^a-z0-9-]/gi, '-').toLowerCase();
                            const showPvc = (defType === 'pvc-dynamic' || defType === 'pvc-static') ? '' : 'display:none';
                            const showStatic = defType === 'pvc-static' ? '' : 'display:none';
                            const showEmpty = defType === 'emptyDir' ? '' : 'display:none';
                            const showCm = defType === 'configMap' ? '' : 'display:none';
                            const showSec = defType === 'secret' ? '' : 'display:none';
                            const showHost = defType === 'hostPath' ? '' : 'display:none';

                            // Determine the initial source label + value based on type
                            const _srcLabelMap = { 'pvc-dynamic': 'PVC Name', 'pvc-static': 'PVC Name', 'configMap': 'ConfigMap', 'secret': 'Secret', 'hostPath': 'Host Path' };
                            const srcLabel = _srcLabelMap[defType] || 'Volume Source';
                            const srcVal = defType === 'configMap' ? '' : defType === 'secret' ? '' : defType === 'hostPath' ? esc(cl.source || '') : esc(nameVal);
                            const srcPlaceholder = defType === 'configMap' ? 'my-config' : defType === 'secret' ? 'my-tls-cert' : defType === 'hostPath' ? '/host/path' : 'my-data';
                            const showSrcRow = defType !== 'emptyDir' ? '' : 'display:none';

                            return '<div class="k8s-vol-row" style="border:1px solid var(--border-subtle);border-radius:6px;padding:0.35rem 0.4rem;background:var(--bg-inset)' + (isSkip ? ';opacity:0.5' : '') + '">'
                                // Row 1: checkbox + type select + skip warning + remove button
                                + '<div style="display:flex;align-items:center;gap:0.4rem;flex-wrap:wrap">'
                                +   '<input type="checkbox" id="k8s-svc-vol-chk-' + i + '-' + j + '"' + checked + ' style="accent-color:var(--accent);cursor:pointer" onchange="window._updateVolSummary(\'' + i + '\')">'
                                +   typeSelectHtml
                                +   (isSkip ? '<span style="font-size:0.6rem;color:var(--warning);font-weight:600">‚ö†Ô∏è ' + esc(cl.skipReason || 'dev-only') + '</span>' : '')
                                +   '<button type="button" onclick="this.closest(\'.k8s-vol-row\').remove();window._updateVolSummary(\'' + i + '\')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:0.8rem;padding:0 4px" title="Remove">‚úï</button>'
                                + '</div>'
                                // Row 2: Volume Source ‚Üí Mount Path (the two-way mapping)
                                + '<div id="k8s-vol-mapping-' + i + '-' + j + '" style="display:grid;grid-template-columns:1fr auto 1fr;gap:0.3rem;margin-top:0.25rem;align-items:end;' + showSrcRow + '">'
                                +   '<div>'
                                +     '<label id="k8s-vol-src-label-' + i + '-' + j + '" style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">' + srcLabel + '</label>'
                                +     '<input type="text" id="k8s-svc-vol-name-' + i + '-' + j + '" class="modal-form-input" value="' + srcVal + '" placeholder="' + srcPlaceholder + '" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +   '</div>'
                                +   '<div style="font-size:0.82rem;color:var(--text-muted);padding-bottom:0.15rem;font-weight:600">‚Üí</div>'
                                +   '<div>'
                                +     '<label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Mount Path</label>'
                                +     '<input type="text" id="k8s-svc-vol-mount-' + i + '-' + j + '" class="modal-form-input" value="' + esc(cl.mountPath) + '" placeholder="/var/lib/data" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +   '</div>'
                                + '</div>'
                                // emptyDir-only mount path (no source side)
                                + '<div id="k8s-vol-mount-only-' + i + '-' + j + '" style="' + (defType === 'emptyDir' ? '' : 'display:none') + ';margin-top:0.25rem">'
                                +   '<label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Mount Path</label>'
                                +   '<input type="text" id="k8s-svc-vol-mount-empty-' + i + '-' + j + '" class="modal-form-input" value="' + esc(cl.mountPath) + '" placeholder="/tmp/data" style="font-size:0.72rem;padding:0.15rem 0.25rem"'
                                +   ' oninput="var m=document.getElementById(\'k8s-svc-vol-mount-' + i + '-' + j + '\');if(m)m.value=this.value">'
                                + '</div>'
                                // PVC extra fields (Size, Access Mode, StorageClass)
                                + '<div id="k8s-vol-pvc-fields-' + i + '-' + j + '" style="' + showPvc + ';margin-top:0.2rem">'
                                +   '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.3rem;align-items:start">'
                                +     '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Size</label>'
                                +       '<input type="text" id="k8s-svc-vol-size-' + i + '-' + j + '" class="modal-form-input" value="' + (cl.defaultSize || '10Gi') + '" placeholder="10Gi" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +     '</div>'
                                +     '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Access Mode</label>'
                                +       '<select id="k8s-svc-vol-access-' + i + '-' + j + '" class="modal-form-select" style="font-size:0.72rem;padding:0.15rem 0.2rem">'
                                +         '<option value="ReadWriteOnce" selected>ReadWriteOnce</option>'
                                +         '<option value="ReadWriteMany">ReadWriteMany</option>'
                                +         '<option value="ReadOnlyMany">ReadOnlyMany</option>'
                                +       '</select>'
                                +     '</div>'
                                +   '</div>'
                                +   '<div style="margin-top:0.25rem">'
                                +     '<label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Storage Class</label>'
                                +     '<div style="display:flex;gap:0.3rem;align-items:center">'
                                +       '<select id="k8s-svc-vol-sc-' + i + '-' + j + '" class="modal-form-select k8s-vol-sc-select" style="font-size:0.72rem;padding:0.15rem 0.2rem;flex:1;max-width:320px" onchange="window._k8sVolScChange(\'' + i + '\',' + j + ')">'
                                +         _scSelectHtml()
                                +       '</select>'
                                +       '<input type="text" id="k8s-svc-vol-sc-custom-' + i + '-' + j + '" class="modal-form-input" placeholder="custom-class" style="font-size:0.72rem;padding:0.15rem 0.2rem;flex:1;max-width:180px;display:none">'
                                +     '</div>'
                                +   '</div>'
                                +   '<div id="k8s-vol-lh-' + i + '-' + j + '" style="display:none;margin-top:0.2rem;padding:0.25rem 0.35rem;border-radius:4px;background:rgba(99,102,241,0.04);border:1px solid rgba(99,102,241,0.12)">'
                                +     '<div style="font-size:0.64rem;color:var(--accent);font-weight:600;margin-bottom:0.15rem">üêÇ Longhorn</div>'
                                +     '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.25rem">'
                                +       '<div><label style="display:block;font-size:0.62rem;color:var(--text-muted);margin-bottom:1px">Replicas</label>'
                                +         '<input type="number" id="k8s-vol-lh-replicas-' + i + '-' + j + '" class="modal-form-input" value="3" min="1" max="5" style="font-size:0.72rem;padding:0.15rem 0.2rem;width:60px">'
                                +       '</div>'
                                +       '<div><label style="display:block;font-size:0.62rem;color:var(--text-muted);margin-bottom:1px">Data Locality</label>'
                                +         '<select id="k8s-vol-lh-locality-' + i + '-' + j + '" class="modal-form-select" style="font-size:0.72rem;padding:0.15rem 0.2rem">'
                                +           '<option value="best-effort" selected>Best-effort</option>'
                                +           '<option value="strict">Strict</option>'
                                +           '<option value="disabled">Disabled</option>'
                                +         '</select>'
                                +       '</div>'
                                +     '</div>'
                                +   '</div>'
                                + '</div>'
                                // PVC static extra fields
                                + '<div id="k8s-vol-static-fields-' + i + '-' + j + '" style="' + showStatic + ';margin-top:0.2rem">'
                                +   '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">PV Name (bind to existing)</label>'
                                +     '<input type="text" id="k8s-svc-vol-pvname-' + i + '-' + j + '" class="modal-form-input" placeholder="pre-existing-pv-name" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +   '</div>'
                                +   '<div style="font-size:0.6rem;color:var(--text-muted);margin-top:2px">Requires a pre-existing PersistentVolume in the cluster</div>'
                                + '</div>'
                                // emptyDir fields
                                + '<div id="k8s-vol-empty-fields-' + i + '-' + j + '" style="' + showEmpty + ';margin-top:0.2rem">'
                                +   '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.3rem">'
                                +     '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Medium</label>'
                                +       '<select id="k8s-svc-vol-medium-' + i + '-' + j + '" class="modal-form-select" style="font-size:0.72rem;padding:0.15rem 0.2rem">'
                                +         '<option value="" selected>Disk (default)</option>'
                                +         '<option value="Memory">Memory (tmpfs ‚Äî faster, uses RAM)</option>'
                                +       '</select>'
                                +     '</div>'
                                +     '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Size Limit (optional)</label>'
                                +       '<input type="text" id="k8s-svc-vol-sizelimit-' + i + '-' + j + '" class="modal-form-input" placeholder="e.g. 1Gi" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +     '</div>'
                                +   '</div>'
                                +   '<div style="font-size:0.6rem;color:var(--warning);margin-top:2px">‚ö†Ô∏è Data is lost when pod is restarted or rescheduled</div>'
                                + '</div>'
                                // ConfigMap mount extra fields (key only ‚Äî name is in the source input)
                                + '<div id="k8s-vol-cm-fields-' + i + '-' + j + '" style="' + showCm + ';margin-top:0.2rem">'
                                +   '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Key (optional, single file)</label>'
                                +     '<input type="text" id="k8s-svc-vol-cmkey-' + i + '-' + j + '" class="modal-form-input" placeholder="e.g. nginx.conf" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +   '</div>'
                                +   '<div style="font-size:0.6rem;color:var(--text-muted);margin-top:2px">Mounts ConfigMap data as files in the container</div>'
                                + '</div>'
                                // Secret mount extra fields (key only ‚Äî name is in the source input)
                                + '<div id="k8s-vol-sec-fields-' + i + '-' + j + '" style="' + showSec + ';margin-top:0.2rem">'
                                +   '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Key (optional, single file)</label>'
                                +     '<input type="text" id="k8s-svc-vol-seckey-' + i + '-' + j + '" class="modal-form-input" placeholder="e.g. tls.crt" style="font-size:0.72rem;padding:0.15rem 0.25rem">'
                                +   '</div>'
                                +   '<div style="font-size:0.6rem;color:var(--text-muted);margin-top:2px">Mounts Secret data as files (e.g. TLS certs, SSH keys)</div>'
                                + '</div>'
                                // hostPath extra fields (type only ‚Äî path is in the source input)
                                + '<div id="k8s-vol-host-fields-' + i + '-' + j + '" style="' + showHost + ';margin-top:0.2rem">'
                                +   '<div><label style="display:block;font-size:0.64rem;color:var(--text-muted);margin-bottom:1px">Path Type</label>'
                                +     '<select id="k8s-svc-vol-hosttype-' + i + '-' + j + '" class="modal-form-select" style="font-size:0.72rem;padding:0.15rem 0.2rem">'
                                +       '<option value="DirectoryOrCreate" selected>DirectoryOrCreate</option>'
                                +       '<option value="Directory">Directory</option>'
                                +       '<option value="FileOrCreate">FileOrCreate</option>'
                                +       '<option value="File">File</option>'
                                +     '</select>'
                                +   '</div>'
                                +   '<div style="font-size:0.6rem;color:var(--warning);margin-top:2px">‚ö†Ô∏è Not portable. Ties pod to specific node. Security risk.</div>'
                                + '</div>'
                                + '</div>';
                        };

                        // ‚îÄ‚îÄ Volume type change handler ‚îÄ‚îÄ
                        window._k8sVolTypeChange = (i, j) => {
                            const sel = document.getElementById('k8s-svc-vol-type-' + i + '-' + j);
                            if (!sel) return;
                            const t = sel.value;

                            // Update source label + placeholder based on type
                            const srcLabelEl = document.getElementById('k8s-vol-src-label-' + i + '-' + j);
                            const srcInput = document.getElementById('k8s-svc-vol-name-' + i + '-' + j);
                            const mappingRow = document.getElementById('k8s-vol-mapping-' + i + '-' + j);
                            const mountOnly = document.getElementById('k8s-vol-mount-only-' + i + '-' + j);
                            const _srcLabels = { 'pvc-dynamic': 'PVC Name', 'pvc-static': 'PVC Name', 'configMap': 'ConfigMap', 'secret': 'Secret', 'hostPath': 'Host Path' };
                            const _srcPlaceholders = { 'pvc-dynamic': 'my-data', 'pvc-static': 'my-data', 'configMap': 'my-config', 'secret': 'my-tls-cert', 'hostPath': '/host/path' };
                            if (srcLabelEl) srcLabelEl.textContent = _srcLabels[t] || 'Volume Source';
                            if (srcInput) srcInput.placeholder = _srcPlaceholders[t] || 'volume-name';
                            // Toggle mapping row vs emptyDir mount-only
                            const isEmptyDir = t === 'emptyDir';
                            if (mappingRow) mappingRow.style.display = isEmptyDir ? 'none' : '';
                            if (mountOnly) mountOnly.style.display = isEmptyDir ? '' : 'none';
                            // Sync mount path from emptyDir input when switching back
                            if (!isEmptyDir && mountOnly) {
                                const emptyMount = document.getElementById('k8s-svc-vol-mount-empty-' + i + '-' + j);
                                const mainMount = document.getElementById('k8s-svc-vol-mount-' + i + '-' + j);
                                if (emptyMount && mainMount && emptyMount.value) mainMount.value = emptyMount.value;
                            }

                            const ids = {
                                pvc:    'k8s-vol-pvc-fields-' + i + '-' + j,
                                static: 'k8s-vol-static-fields-' + i + '-' + j,
                                empty:  'k8s-vol-empty-fields-' + i + '-' + j,
                                cm:     'k8s-vol-cm-fields-' + i + '-' + j,
                                sec:    'k8s-vol-sec-fields-' + i + '-' + j,
                                host:   'k8s-vol-host-fields-' + i + '-' + j,
                            };
                            const el = (k) => document.getElementById(ids[k]);
                            if (el('pvc'))    el('pvc').style.display    = (t === 'pvc-dynamic' || t === 'pvc-static') ? '' : 'none';
                            if (el('static')) el('static').style.display = (t === 'pvc-static') ? '' : 'none';
                            if (el('empty'))  el('empty').style.display  = (t === 'emptyDir') ? '' : 'none';
                            if (el('cm'))     el('cm').style.display     = (t === 'configMap') ? '' : 'none';
                            if (el('sec'))    el('sec').style.display    = (t === 'secret') ? '' : 'none';
                            if (el('host'))   el('host').style.display   = (t === 'hostPath') ? '' : 'none';
                            window._updateVolSummary(i);
                        };

                        // ‚îÄ‚îÄ StorageClass change handler (per-volume) ‚îÄ‚îÄ
                        window._k8sVolScChange = (i, j) => {
                            const sel = document.getElementById('k8s-svc-vol-sc-' + i + '-' + j);
                            const custom = document.getElementById('k8s-svc-vol-sc-custom-' + i + '-' + j);
                            const lhPanel = document.getElementById('k8s-vol-lh-' + i + '-' + j);
                            if (!sel) return;
                            // Show/hide custom input
                            if (custom) custom.style.display = (sel.value === '_custom') ? '' : 'none';
                            // Show/hide Longhorn panel ‚Äî check both catalog entry and name pattern
                            const scVal = (sel.value === '_custom' && custom) ? custom.value : sel.value;
                            const scEntry = _SC_FLAT[scVal];
                            const isLonghorn = (scEntry && scEntry.hasExtra) || scVal.toLowerCase().includes('longhorn');
                            if (lhPanel) lhPanel.style.display = isLonghorn ? '' : 'none';
                        };

                        // ‚îÄ‚îÄ Add volume row ‚îÄ‚îÄ
                        window._addVolRow = (i) => {
                            const list = document.getElementById('k8s-svc-vol-list-' + i);
                            if (!list) return;
                            // Remove "no volumes" placeholder if present
                            const placeholder = list.querySelector('div[style*="font-style:italic"]');
                            if (placeholder) placeholder.remove();
                            // Find max existing j
                            let maxJ = -1;
                            list.querySelectorAll('.k8s-vol-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vol-chk-"]');
                                if (chk) {
                                    const parts = chk.id.split('-');
                                    const jVal = parseInt(parts[parts.length - 1]);
                                    if (!isNaN(jVal) && jVal > maxJ) maxJ = jVal;
                                }
                            });
                            const j = maxJ + 1;
                            const cl = { type: 'pvc-dynamic', name: '', mountPath: '', source: '', defaultSize: '5Gi', classification: 'manual' };
                            const wrapper = document.createElement('div');
                            wrapper.innerHTML = window._volRowHtml(i, j, cl);
                            list.appendChild(wrapper.firstElementChild);
                            window._updateVolSummary(i);
                        };

                        // ‚îÄ‚îÄ Volume summary updater ‚îÄ‚îÄ
                        window._updateVolSummary = (i) => {
                            const sumEl = document.getElementById('k8s-svc-vol-summary-' + i);
                            if (!sumEl) return;
                            const list = document.getElementById('k8s-svc-vol-list-' + i);
                            if (!list) { sumEl.textContent = ''; return; }
                            let pvcCount = 0, emptyCount = 0, otherCount = 0;
                            list.querySelectorAll('.k8s-vol-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vol-chk-"]');
                                if (!chk || !chk.checked) return;
                                const parts = chk.id.split('-');
                                const j = parts[parts.length - 1];
                                const typeSel = document.getElementById('k8s-svc-vol-type-' + i + '-' + j);
                                const t = typeSel ? typeSel.value : '';
                                if (t === 'pvc-dynamic' || t === 'pvc-static') pvcCount++;
                                else if (t === 'emptyDir') emptyCount++;
                                else otherCount++;
                            });
                            const parts = [];
                            if (pvcCount > 0) parts.push(pvcCount + ' PVC');
                            if (emptyCount > 0) parts.push(emptyCount + ' emptyDir');
                            if (otherCount > 0) parts.push(otherCount + ' other');
                            sumEl.textContent = parts.length > 0 ? '‚Äî ' + parts.join(', ') : '';
                        };

                        // ‚îÄ‚îÄ Shared volume collector (works for any i: numeric, infraId, compId) ‚îÄ‚îÄ
                        window._collectVolumes = (i) => {
                            const _v = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };
                            const vols = [];
                            const volList = document.getElementById('k8s-svc-vol-list-' + i);
                            if (!volList) return vols;
                            volList.querySelectorAll('.k8s-vol-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vol-chk-"]');
                                if (!chk || !chk.checked) return;
                                const ps = chk.id.split('-');
                                const j = ps[ps.length - 1];
                                const type = _v('k8s-svc-vol-type-' + i + '-' + j) || 'pvc-dynamic';
                                // For emptyDir, mount path may be in the dedicated emptyDir input
                                const mountPath = (type === 'emptyDir'
                                    ? (_v('k8s-svc-vol-mount-empty-' + i + '-' + j) || _v('k8s-svc-vol-mount-' + i + '-' + j))
                                    : _v('k8s-svc-vol-mount-' + i + '-' + j));
                                if (!mountPath) return;
                                const vol = { type, mountPath };
                                // The unified source input (k8s-svc-vol-name) holds the source for all types
                                const srcName = _v('k8s-svc-vol-name-' + i + '-' + j);
                                if (type === 'pvc-dynamic' || type === 'pvc-static') {
                                    vol.name = srcName || 'data-' + j;
                                    vol.size = _v('k8s-svc-vol-size-' + i + '-' + j) || '10Gi';
                                    vol.accessMode = _v('k8s-svc-vol-access-' + i + '-' + j) || 'ReadWriteOnce';
                                    if (type === 'pvc-static') vol.pvName = _v('k8s-svc-vol-pvname-' + i + '-' + j) || '';
                                    const scSel = document.getElementById('k8s-svc-vol-sc-' + i + '-' + j);
                                    if (scSel) {
                                        vol.storageClass = scSel.value === '_custom'
                                            ? (_v('k8s-svc-vol-sc-custom-' + i + '-' + j) || '')
                                            : (scSel.value || '');
                                        if (vol.storageClass.toLowerCase().includes('longhorn')) {
                                            vol.longhornConfig = {
                                                replicas: _v('k8s-vol-lh-replicas-' + i + '-' + j) || '3',
                                                dataLocality: _v('k8s-vol-lh-locality-' + i + '-' + j) || 'best-effort',
                                            };
                                        }
                                    }
                                } else if (type === 'emptyDir') {
                                    vol.medium = _v('k8s-svc-vol-medium-' + i + '-' + j) || '';
                                    vol.sizeLimit = _v('k8s-svc-vol-sizelimit-' + i + '-' + j) || '';
                                } else if (type === 'configMap') {
                                    vol.configMapName = srcName || '';
                                    vol.key = _v('k8s-svc-vol-cmkey-' + i + '-' + j) || '';
                                } else if (type === 'secret') {
                                    vol.secretName = srcName || '';
                                    vol.key = _v('k8s-svc-vol-seckey-' + i + '-' + j) || '';
                                } else if (type === 'hostPath') {
                                    vol.hostPath = srcName || '';
                                    vol.hostType = _v('k8s-svc-vol-hosttype-' + i + '-' + j) || 'DirectoryOrCreate';
                                }
                                vols.push(vol);
                            });
                            return vols;
                        };

                        // ‚îÄ‚îÄ Add VCT row (StatefulSet volumeClaimTemplate) ‚îÄ‚îÄ
                        window._k8sAddVCT = (i) => {
                            const list = document.getElementById('k8s-svc-vct-list-' + i);
                            if (!list) return;
                            // Remove "no volumes" placeholder if present
                            const ph = list.querySelector('div[style*="font-style:italic"]');
                            if (ph && !list.querySelector('.k8s-vct-row')) { list.innerHTML = ''; }
                            let maxJ = -1;
                            list.querySelectorAll('.k8s-vct-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vct-chk-"]');
                                if (chk) {
                                    const parts = chk.id.split('-');
                                    const jVal = parseInt(parts[parts.length - 1]);
                                    if (!isNaN(jVal) && jVal > maxJ) maxJ = jVal;
                                }
                            });
                            const j = maxJ + 1;
                            const rowHtml = `<div class="k8s-vct-row" style="padding:0.3rem;border:1px solid var(--border-subtle);border-radius:4px;background:var(--bg-secondary)">
                                <div style="display:grid;grid-template-columns:auto 1fr 2fr 1fr 1fr 1fr;gap:0.3rem;align-items:center;font-size:0.72rem">
                                    <label><input type="checkbox" id="k8s-svc-vct-chk-${i}-${j}" checked style="accent-color:var(--accent)"></label>
                                    <div>${_lbl('Name')}${_inp(`k8s-svc-vct-name-${i}-${j}`, 'data-' + j, 'data')}</div>
                                    <div>${_lbl('Mount Path')}${_inp(`k8s-svc-vct-mount-${i}-${j}`, '/mnt/data', '/var/lib/data')}</div>
                                    <div>${_lbl('Size')}${_inp(`k8s-svc-vct-size-${i}-${j}`, '10Gi', '10Gi')}</div>
                                    <div>${_lbl('Access Mode')}${_sel(`k8s-svc-vct-access-${i}-${j}`, [
                                        {v:'ReadWriteOnce', l:'RWO'},
                                        {v:'ReadWriteMany', l:'RWX'},
                                        {v:'ReadOnlyMany', l:'ROX'},
                                    ], 'ReadWriteOnce')}</div>
                                    <div>${_lbl('StorageClass')}${_inp(`k8s-svc-vct-sc-${i}-${j}`, '', 'longhorn')}</div>
                                </div>
                            </div>`;
                            const wrapper = document.createElement('div');
                            wrapper.innerHTML = rowHtml;
                            list.appendChild(wrapper.firstElementChild);
                        };

                        // ‚îÄ‚îÄ Init Container helpers ‚îÄ‚îÄ
                        window._k8sInitRowHtml = (i, j, name, image, command) => {
                            return `<div class="k8s-init-row" data-j="${j}" style="padding:0.35rem;border:1px solid var(--border-subtle);border-radius:4px;background:var(--bg-secondary)">
                                <div style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem">
                                    <span style="font-size:0.68rem;color:var(--accent);font-weight:600">‚è≥ ${j + 1}.</span>
                                    <input type="text" id="k8s-svc-init-name-${i}-${j}" class="modal-form-input" value="${name}" placeholder="init-container" style="font-size:0.72rem;padding:0.15rem 0.3rem;flex:1">
                                    <button type="button" onclick="window._k8sRemoveInit(${i},this)" style="background:none;border:none;cursor:pointer;font-size:0.78rem;color:var(--text-muted);padding:0 4px" title="Remove">‚úï</button>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 2fr;gap:0.3rem;font-size:0.72rem">
                                    <div>
                                        ${_lbl('Image')}
                                        <input type="text" id="k8s-svc-init-img-${i}-${j}" class="modal-form-input" value="${image}" placeholder="busybox:1.36" style="font-size:0.72rem;padding:0.15rem 0.3rem">
                                    </div>
                                    <div>
                                        ${_lbl('Command')}
                                        <input type="text" id="k8s-svc-init-cmd-${i}-${j}" class="modal-form-input" value="${command}" placeholder="sh -c &quot;...&quot;" style="font-size:0.72rem;padding:0.15rem 0.3rem">
                                    </div>
                                </div>
                            </div>`;
                        };

                        window._k8sUpdateInitCount = (i) => {
                            const countEl = document.getElementById('k8s-svc-init-count-' + i);
                            if (!countEl) return;
                            const list = document.getElementById('k8s-svc-init-list-' + i);
                            const cnt = list ? list.querySelectorAll('.k8s-init-row').length : 0;
                            countEl.textContent = cnt;
                        };

                        window._k8sRemoveInit = (i, btn) => {
                            const row = btn.closest('.k8s-init-row');
                            if (row) row.remove();
                            window._k8sUpdateInitCount(i);
                        };

                        window._k8sAddInitPreset = (i, preset) => {
                            const list = document.getElementById('k8s-svc-init-list-' + i);
                            if (!list) return;
                            let maxJ = -1;
                            list.querySelectorAll('.k8s-init-row').forEach(row => {
                                const jVal = parseInt(row.dataset.j);
                                if (!isNaN(jVal) && jVal > maxJ) maxJ = jVal;
                            });
                            const j = maxJ + 1;

                            // Get main container image for 'migrations' preset
                            const mainImg = (document.getElementById('k8s-svc-img-' + i) || {}).value || '';

                            const presets = {
                                'wait-tcp': {
                                    name: 'wait-for-tcp',
                                    image: 'busybox:1.36',
                                    command: 'sh -c "until nc -z HOST PORT; do echo Waiting...; sleep 2; done"',
                                },
                                'wait-http': {
                                    name: 'wait-for-http',
                                    image: 'curlimages/curl:latest',
                                    command: 'sh -c "until curl -sf http://HOST:PORT/health; do sleep 2; done"',
                                },
                                'migrations': {
                                    name: 'run-migrations',
                                    image: mainImg || 'app:latest',
                                    command: '',
                                },
                                'fix-perms': {
                                    name: 'fix-permissions',
                                    image: 'busybox:1.36',
                                    command: 'sh -c "chown -R 1000:1000 /data"',
                                },
                                'custom': {
                                    name: 'init-' + j,
                                    image: '',
                                    command: '',
                                },
                            };

                            const p = presets[preset] || presets['custom'];
                            const wrapper = document.createElement('div');
                            wrapper.innerHTML = window._k8sInitRowHtml(i, j, p.name, p.image, p.command);
                            list.appendChild(wrapper.firstElementChild);
                            window._k8sUpdateInitCount(i);
                        };

                        // ‚îÄ‚îÄ Sidecar Container helpers ‚îÄ‚îÄ
                        window._k8sSidecarRowHtml = (i, j, name, image, command, native, sharedVol, sharedMount) => {
                            const nativeChecked = native !== false ? ' checked' : '';
                            const hasShared = sharedVol ? true : false;
                            return `<div class="k8s-sc-row" data-j="${j}" style="padding:0.35rem;border:1px solid var(--border-subtle);border-radius:4px;background:var(--bg-secondary)">
                                <div style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem">
                                    <span style="font-size:0.68rem;color:var(--accent);font-weight:600">üìé ${j + 1}.</span>
                                    <input type="text" id="k8s-svc-sc-name-${i}-${j}" class="modal-form-input" value="${name}" placeholder="sidecar" style="font-size:0.72rem;padding:0.15rem 0.3rem;flex:1">
                                    <button type="button" onclick="window._k8sRemoveSidecar(${i},this)" style="background:none;border:none;cursor:pointer;font-size:0.78rem;color:var(--text-muted);padding:0 4px" title="Remove">‚úï</button>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 2fr;gap:0.3rem;font-size:0.72rem">
                                    <div>
                                        ${_lbl('Image')}
                                        <input type="text" id="k8s-svc-sc-img-${i}-${j}" class="modal-form-input" value="${image}" placeholder="image:tag" style="font-size:0.72rem;padding:0.15rem 0.3rem">
                                    </div>
                                    <div>
                                        ${_lbl('Command (optional)')}
                                        <input type="text" id="k8s-svc-sc-cmd-${i}-${j}" class="modal-form-input" value="${command || ''}" placeholder="" style="font-size:0.72rem;padding:0.15rem 0.3rem">
                                    </div>
                                </div>
                                <div style="display:flex;align-items:center;gap:0.6rem;margin-top:0.25rem;font-size:0.66rem">
                                    <label style="display:inline-flex;align-items:center;gap:0.2rem;cursor:pointer;color:var(--text-secondary)">
                                        <input type="checkbox" id="k8s-svc-sc-native-${i}-${j}"${nativeChecked} style="accent-color:var(--accent)"> Native sidecar
                                        <span style="font-size:0.58rem;color:var(--text-muted)">(K8s ‚â• 1.28)</span>
                                    </label>
                                </div>
                                ${hasShared ? `<div style="display:flex;align-items:center;gap:0.3rem;margin-top:0.2rem;font-size:0.66rem;padding:0.2rem 0.3rem;background:var(--bg-inset);border-radius:3px">
                                    <span style="color:var(--text-muted);font-weight:600">Shared volume:</span>
                                    <input type="text" id="k8s-svc-sc-shvol-${i}-${j}" class="modal-form-input" value="${sharedVol}" style="font-size:0.66rem;padding:0.1rem 0.2rem;width:80px">
                                    <span style="color:var(--text-muted)">mount:</span>
                                    <input type="text" id="k8s-svc-sc-shmount-${i}-${j}" class="modal-form-input" value="${sharedMount || '/shared'}" style="font-size:0.66rem;padding:0.1rem 0.2rem;width:100px">
                                </div>` : ''}
                            </div>`;
                        };

                        window._k8sUpdateScCount = (i) => {
                            const countEl = document.getElementById('k8s-svc-sc-count-' + i);
                            if (!countEl) return;
                            const list = document.getElementById('k8s-svc-sc-list-' + i);
                            const cnt = list ? list.querySelectorAll('.k8s-sc-row').length : 0;
                            countEl.textContent = cnt;
                        };

                        window._k8sRemoveSidecar = (i, btn) => {
                            const row = btn.closest('.k8s-sc-row');
                            if (row) row.remove();
                            window._k8sUpdateScCount(i);
                        };

                        window._k8sAddSidecarPreset = (i, preset) => {
                            const list = document.getElementById('k8s-svc-sc-list-' + i);
                            if (!list) return;
                            let maxJ = -1;
                            list.querySelectorAll('.k8s-sc-row').forEach(row => {
                                const jVal = parseInt(row.dataset.j);
                                if (!isNaN(jVal) && jVal > maxJ) maxJ = jVal;
                            });
                            const j = maxJ + 1;

                            const presets = {
                                'log-fwd': {
                                    name: 'log-forwarder', image: 'fluent/fluent-bit:2.2', command: '',
                                    native: true, sharedVol: 'shared-logs', sharedMount: '/var/log/app',
                                },
                                'cfg-reload': {
                                    name: 'config-reloader', image: 'jimmidyson/configmap-reload:v0.13', command: '',
                                    native: true, sharedVol: '', sharedMount: '',
                                },
                                'metrics': {
                                    name: 'metrics-exporter', image: 'prom/statsd-exporter:v0.26', command: '',
                                    native: true, sharedVol: '', sharedMount: '',
                                },
                                'auth-proxy': {
                                    name: 'auth-proxy', image: 'oauth2-proxy/oauth2-proxy:v7', command: '',
                                    native: true, sharedVol: '', sharedMount: '',
                                },
                                'cloudsql': {
                                    name: 'cloud-sql-proxy', image: 'gcr.io/cloud-sql-connectors/cloud-sql-proxy:2', command: '',
                                    native: true, sharedVol: '', sharedMount: '',
                                },
                                'vault': {
                                    name: 'vault-agent', image: 'hashicorp/vault:1.15', command: '',
                                    native: true, sharedVol: 'vault-secrets', sharedMount: '/vault/secrets',
                                },
                                'custom': {
                                    name: 'sidecar-' + j, image: '', command: '',
                                    native: true, sharedVol: '', sharedMount: '',
                                },
                            };

                            const p = presets[preset] || presets['custom'];
                            const wrapper = document.createElement('div');
                            wrapper.innerHTML = window._k8sSidecarRowHtml(i, j, p.name, p.image, p.command, p.native, p.sharedVol, p.sharedMount);
                            list.appendChild(wrapper.firstElementChild);
                            window._k8sUpdateScCount(i);
                        };

                        // ‚îÄ‚îÄ Companion Container helpers ‚îÄ‚îÄ

                        // Read env vars from source card DOM (before hiding)
                        window._k8sReadSourceEnv = (sourceIdx) => {
                            const list = document.getElementById('k8s-svc-env-list-' + sourceIdx);
                            if (!list) return [];
                            const vars = [];
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (!keyEl) return;
                                const parts = keyEl.id.split('-');
                                const j = parts[parts.length - 1];
                                const key = (document.getElementById('k8s-svc-env-key-' + sourceIdx + '-' + j) || {}).value || '';
                                if (!key.trim()) return;
                                const type = (document.getElementById('k8s-svc-env-type-' + sourceIdx + '-' + j) || {}).value || 'hardcoded';
                                const value = (document.getElementById('k8s-svc-env-val-' + sourceIdx + '-' + j) || {}).value || '';
                                vars.push({ key: key.trim(), type, value: value.trim() });
                            });
                            return vars;
                        };

                        // Read resource limits from source card DOM
                        window._k8sReadSourceResources = (sourceIdx) => {
                            const cpuReq = (document.getElementById('k8s-svc-cpu-req-' + sourceIdx) || {}).value || '';
                            const cpuLim = (document.getElementById('k8s-svc-cpu-lim-' + sourceIdx) || {}).value || '';
                            const memReq = (document.getElementById('k8s-svc-mem-req-' + sourceIdx) || {}).value || '';
                            const memLim = (document.getElementById('k8s-svc-mem-lim-' + sourceIdx) || {}).value || '';
                            if (!cpuReq && !cpuLim && !memReq && !memLim) return null;
                            return { cpuReq, cpuLim, memReq, memLim };
                        };

                        // Read volumes from source card DOM
                        window._k8sReadSourceVolumes = (sourceIdx) => {
                            const volList = document.getElementById('k8s-svc-vol-list-' + sourceIdx);
                            if (!volList) return [];
                            const vols = [];
                            volList.querySelectorAll('.k8s-vol-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vol-chk-"]');
                                if (!chk || !chk.checked) return;
                                const ps = chk.id.split('-');
                                const j = ps[ps.length - 1];
                                const mountPath = (document.getElementById('k8s-svc-vol-mount-' + sourceIdx + '-' + j) || {}).value || '';
                                const type = (document.getElementById('k8s-svc-vol-type-' + sourceIdx + '-' + j) || {}).value || 'pvc-dynamic';
                                const name = (document.getElementById('k8s-svc-vol-name-' + sourceIdx + '-' + j) || {}).value || '';
                                if (mountPath) vols.push({ name, type, mountPath });
                            });
                            return vols;
                        };

                        // ‚îÄ‚îÄ Companion env type change handler ‚îÄ‚îÄ
                        window._k8sCompEnvTypeChange = (sel) => {
                            const row = sel.closest('.k8s-comp-env-row');
                            if (!row) return;
                            const valInp = row.querySelector('input[id*="-env-val-"]');
                            if (!valInp) return;
                            if (sel.value === 'secret') {
                                valInp.type = 'password';
                                valInp.placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                            } else {
                                valInp.type = 'text';
                                valInp.placeholder = sel.value === 'variable' ? '${VAR_NAME}' : 'value';
                            }
                        };

                        // ‚îÄ‚îÄ Read host pod's current volumes live from DOM ‚îÄ‚îÄ
                        window._k8sReadHostVolumes = (targetIdx) => {
                            const volList = document.getElementById('k8s-svc-vol-list-' + targetIdx);
                            if (!volList) return [];
                            const vols = [];
                            volList.querySelectorAll('.k8s-vol-row').forEach(row => {
                                const chk = row.querySelector('[id^="k8s-svc-vol-chk-"]');
                                if (!chk || !chk.checked) return;
                                const ps = chk.id.split('-');
                                const j = ps[ps.length - 1];
                                const mountPath = (document.getElementById('k8s-svc-vol-mount-' + targetIdx + '-' + j) || {}).value || '';
                                const type = (document.getElementById('k8s-svc-vol-type-' + targetIdx + '-' + j) || {}).value || 'pvc-dynamic';
                                const name = (document.getElementById('k8s-svc-vol-name-' + targetIdx + '-' + j) || {}).value || '';
                                // Source label from the code element in row 1
                                const codeEl = row.querySelector('code');
                                const label = codeEl ? codeEl.textContent : (name || mountPath);
                                vols.push({ name, type, mountPath, label });
                            });
                            return vols;
                        };

                        // ‚îÄ‚îÄ Refresh companion's host-volume section (called on details toggle) ‚îÄ‚îÄ
                        window._k8sRefreshCompHostVols = (targetIdx, sourceIdx) => {
                            const container = document.getElementById('k8s-comp-hostvols-' + targetIdx + '-' + sourceIdx);
                            if (!container) return;
                            const hostVols = window._k8sReadHostVolumes(targetIdx);
                            if (hostVols.length === 0) {
                                container.innerHTML = '<div style="font-size:0.72rem;color:var(--text-muted);font-style:italic">No volumes on host pod yet ‚Äî add volumes to the main service first.</div>';
                                return;
                            }
                            let html = '<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:0.15rem">Check to mount in this companion:</div>';
                            hostVols.forEach((vol, j) => {
                                const id = 'k8s-comp-hostvol-' + targetIdx + '-' + sourceIdx + '-' + j;
                                html += '<div class="k8s-comp-hostvol-row" style="display:grid;grid-template-columns:auto 1fr 1fr;gap:0.25rem;align-items:center;margin-bottom:0.15rem">'
                                    + '<input type="checkbox" id="' + id + '-chk" style="accent-color:var(--accent)">'
                                    + '<code style="font-size:0.72rem;color:var(--text-secondary);font-family:var(--font-mono,monospace);overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + esc(vol.label) + '">' + esc(vol.label) + '</code>'
                                    + '<input type="text" id="' + id + '-mount" class="modal-form-input" value="' + esc(vol.mountPath) + '" placeholder="/data" style="font-size:0.74rem;padding:0.12rem 0.2rem">'
                                    + '<input type="hidden" id="' + id + '-name" value="' + esc(vol.name) + '">'
                                    + '<input type="hidden" id="' + id + '-type" value="' + esc(vol.type) + '">'
                                    + '</div>';
                            });
                            container.innerHTML = html;
                        };

                        // ‚îÄ‚îÄ Build infra options list for dependency dropdown ‚îÄ‚îÄ
                        window._k8sCompDepOptions = (targetIdx, sourceIdx) => {
                            let opts = '<option value="">‚è∏ None</option>';
                            (window._k8sActiveInfra || new Set()).forEach(name => {
                                const svcData = (window._k8sInfraData || new Map()).get(name) || {};
                                const port = svcData.ports && svcData.ports.length > 0 ? svcData.ports[0].container : '';
                                const val = port ? (name + ':' + port) : name;
                                opts += '<option value="' + esc(val) + '">üîß ' + esc(name) + (port ? ' :' + port : '') + '</option>';
                            });
                            return opts;
                        };

                        // Render a rich companion card  (DOM IDs: k8s-comp-{tgt}-{src}-*)
                        window._k8sCompanionRowHtml = (targetIdx, comp) => {
                            const t = targetIdx;
                            const s = comp.sourceIndex;
                            const eName = esc(comp.svcName);
                            const eImg = esc(comp.image || '');
                            const imgShort = esc((comp.image || '').split('/').pop().split(':')[0] || comp.svcName);
                            const envVars = comp.envVars || [];
                            const resources = comp.resources;
                            const volumes = comp.volumes || [];

                            let h = '<div id="k8s-companion-row-' + s + '" style="border:1px solid var(--border-subtle);border-radius:6px;padding:0.45rem 0.5rem;background:var(--bg-secondary)">';

                            // ‚îÄ‚îÄ Header row ‚îÄ‚îÄ
                            h += '<div style="display:flex;align-items:center;gap:0.4rem;font-size:0.78rem;margin-bottom:0.2rem">'
                                + '<span style="font-size:0.9rem">üì¶</span>'
                                + '<strong>' + eName + '</strong>'
                                + '<code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">' + imgShort + '</code>'
                                + (comp.port ? '<code style="font-size:0.72rem;color:var(--text-muted)">:' + esc(comp.port) + '</code>' : '')
                                + '<span style="flex:1"></span>'
                                + '<button type="button" onclick="window._k8sSplitBack(' + s + ',' + t + ')"'
                                + ' style="font-size:0.74rem;color:var(--accent);background:none;border:1px solid var(--border-subtle);border-radius:4px;padding:0.15rem 0.4rem;cursor:pointer"'
                                + '>‚§¥ Split back</button>'
                                + '</div>';

                            // ‚îÄ‚îÄ Image & Port (editable) ‚îÄ‚îÄ
                            h += '<div style="display:grid;grid-template-columns:2fr 1fr;gap:0.3rem;margin-bottom:0.3rem">'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">Image</label>'
                                + '<input type="text" id="k8s-comp-img-' + t + '-' + s + '" class="modal-form-input" value="' + eImg + '" style="font-size:0.78rem;padding:0.2rem 0.3rem"></div>'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">Port</label>'
                                + '<input type="text" id="k8s-comp-port-' + t + '-' + s + '" class="modal-form-input" value="' + esc(comp.port || '') + '" placeholder="optional" style="font-size:0.78rem;padding:0.2rem 0.3rem"></div>'
                                + '</div>';

                            // ‚îÄ‚îÄ Startup Dependency ‚îÄ‚îÄ
                            h += '<div style="margin-bottom:0.3rem">'
                                + '<label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">‚è≥ Startup dependency (wait-for init container)</label>'
                                + '<select id="k8s-comp-dep-' + t + '-' + s + '" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem">'
                                + window._k8sCompDepOptions(t, s)
                                + '</select>'
                                + '<div style="font-size:0.68rem;color:var(--text-muted);margin-top:2px">Generates a wait-for init container targeting the infra service via K8s DNS.</div>'
                                + '</div>';

                            // ‚îÄ‚îÄ Environment Variables (collapsible, reuses main _envRowHtml) ‚îÄ‚îÄ
                            const compEnvId = 'comp-' + t + '-' + s;   // composite ID for _envRowHtml
                            h += '<details style="margin-top:0.15rem">'
                                + '<summary style="cursor:pointer;font-size:0.74rem;color:var(--accent);user-select:none;padding:0.1rem 0">'
                                + '‚ñ∏ Environment Variables <span id="k8s-svc-env-summary-' + compEnvId + '" style="font-size:0.68rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">' + envVars.length + '</span>'
                                + '</summary>'
                                + '<div style="margin-top:0.2rem;padding:0.3rem 0.4rem;background:var(--bg-primary);border-radius:4px;border:1px solid var(--border-subtle)">';

                            h += '<div id="k8s-svc-env-list-' + compEnvId + '" style="display:flex;flex-direction:column;gap:0.15rem">';
                            if (envVars.length > 0) {
                                envVars.forEach((ev, j) => {
                                    const injType = ev.type || 'hardcoded';
                                    const varN = ev.varName || (injType !== 'hardcoded' ? '${' + ev.key + '}' : '');
                                    h += _envRowHtml(compEnvId, j, ev.key, ev.value || '', injType, varN, compEnvId);
                                });
                            } else {
                                h += '<div style="font-size:0.72rem;color:var(--text-muted);font-style:italic">No environment variables</div>';
                            }
                            h += '</div>';
                            h += '<button type="button" onclick="window._addEnvVar(\'' + compEnvId + '\')"'
                                + ' style="margin-top:0.2rem;font-size:0.72rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.15rem 0.4rem;cursor:pointer;width:100%">'
                                + '+ Add variable</button>';
                            h += '</div></details>';

                            // ‚îÄ‚îÄ Resource Limits (collapsible) ‚îÄ‚îÄ
                            const res = resources || {};
                            h += '<details style="margin-top:0.15rem">'
                                + '<summary style="cursor:pointer;font-size:0.74rem;color:var(--accent);user-select:none;padding:0.1rem 0">'
                                + '‚ñ∏ Resource Limits'
                                + '</summary>'
                                + '<div style="margin-top:0.2rem;padding:0.3rem 0.4rem;background:var(--bg-primary);border-radius:4px;border:1px solid var(--border-subtle)">'
                                + '<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.3rem;font-size:0.76rem">'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">CPU Req</label>'
                                + '<input type="text" id="k8s-comp-cpureq-' + t + '-' + s + '" class="modal-form-input" value="' + esc(res.cpuReq || '') + '" placeholder="100m" style="font-size:0.76rem;padding:0.15rem 0.25rem"></div>'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">CPU Lim</label>'
                                + '<input type="text" id="k8s-comp-cpulim-' + t + '-' + s + '" class="modal-form-input" value="' + esc(res.cpuLim || '') + '" placeholder="500m" style="font-size:0.76rem;padding:0.15rem 0.25rem"></div>'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">Mem Req</label>'
                                + '<input type="text" id="k8s-comp-memreq-' + t + '-' + s + '" class="modal-form-input" value="' + esc(res.memReq || '') + '" placeholder="128Mi" style="font-size:0.76rem;padding:0.15rem 0.25rem"></div>'
                                + '<div><label style="display:block;font-size:0.72rem;color:var(--text-muted);margin-bottom:1px">Mem Lim</label>'
                                + '<input type="text" id="k8s-comp-memlim-' + t + '-' + s + '" class="modal-form-input" value="' + esc(res.memLim || '') + '" placeholder="256Mi" style="font-size:0.76rem;padding:0.15rem 0.25rem"></div>'
                                + '</div>'
                                + '</div></details>';

                            // ‚îÄ‚îÄ Volume Mounts (collapsible ‚Äî live-reads host pod volumes on toggle) ‚îÄ‚îÄ
                            h += '<details style="margin-top:0.15rem" ontoggle="if(this.open)window._k8sRefreshCompHostVols(' + t + ',' + s + ')">'
                                + '<summary style="cursor:pointer;font-size:0.74rem;color:var(--accent);user-select:none;padding:0.1rem 0">'
                                + '‚ñ∏ Volume Mounts'
                                + '</summary>'
                                + '<div style="margin-top:0.2rem;padding:0.3rem 0.4rem;background:var(--bg-primary);border-radius:4px;border:1px solid var(--border-subtle)">';

                            // Sub-section: Host pod volumes (live-populated)
                            h += '<div style="font-size:0.72rem;font-weight:600;color:var(--text-muted);margin-bottom:0.15rem">üìÅ Host pod volumes</div>'
                                + '<div id="k8s-comp-hostvols-' + t + '-' + s + '" style="margin-bottom:0.3rem">'
                                + '<div style="font-size:0.72rem;color:var(--text-muted);font-style:italic">Open this section to detect host volumes‚Ä¶</div>'
                                + '</div>';

                            // Sub-section: Companion's own volumes (from source + added)
                            h += '<div style="font-size:0.72rem;font-weight:600;color:var(--text-muted);margin-bottom:0.15rem">üì¶ Companion-own volumes</div>'
                                + '<div id="k8s-comp-vol-list-' + t + '-' + s + '" style="display:flex;flex-direction:column;gap:0.2rem">';

                            if (volumes.length > 0) {
                                volumes.forEach((vol, j) => {
                                    h += '<div class="k8s-comp-vol-row" style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:0.2rem;align-items:center">'
                                        + '<input type="text" id="k8s-comp-vol-name-' + t + '-' + s + '-' + j + '" class="modal-form-input" value="' + esc(vol.name || '') + '" placeholder="volume-name" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                        + '<input type="text" id="k8s-comp-vol-mount-' + t + '-' + s + '-' + j + '" class="modal-form-input" value="' + esc(vol.mountPath || '') + '" placeholder="/data" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                        + '<select id="k8s-comp-vol-type-' + t + '-' + s + '-' + j + '" class="modal-form-select" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                        + '<option value="pvc-dynamic"' + (vol.type === 'pvc-dynamic' ? ' selected' : '') + '>üíæ PVC</option>'
                                        + '<option value="emptyDir"' + (vol.type === 'emptyDir' ? ' selected' : '') + '>üìÇ emptyDir</option>'
                                        + '<option value="configMap"' + (vol.type === 'configMap' ? ' selected' : '') + '>üìÑ ConfigMap</option>'
                                        + '<option value="secret"' + (vol.type === 'secret' ? ' selected' : '') + '>üîê Secret</option>'
                                        + '</select>'
                                        + '<button type="button" onclick="this.closest(\'.k8s-comp-vol-row\').remove()" style="background:none;border:none;cursor:pointer;font-size:0.78rem;color:var(--text-muted);padding:0 2px" title="Remove">‚úï</button>'
                                        + '</div>';
                                });
                            }
                            h += '</div>';
                            h += '<button type="button" onclick="window._k8sAddCompVol(' + t + ',' + s + ')"'
                                + ' style="margin-top:0.2rem;font-size:0.72rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.15rem 0.4rem;cursor:pointer;width:100%">'
                                + '+ Add companion volume</button>';
                            h += '</div></details>';

                            h += '</div>';
                            return h;
                        };

                        // Add env row to companion (with type change handler)
                        window._k8sAddCompEnv = (targetIdx, sourceIdx) => {
                            const list = document.getElementById('k8s-comp-env-list-' + targetIdx + '-' + sourceIdx);
                            if (!list) return;
                            // Remove "No environment variables" placeholder
                            const placeholder = list.querySelector('div[style*="font-style:italic"]');
                            if (placeholder) placeholder.remove();
                            const j = list.querySelectorAll('.k8s-comp-env-row').length;
                            const compId = targetIdx + '-' + sourceIdx;
                            const row = document.createElement('div');
                            row.className = 'k8s-comp-env-row';
                            row.style.cssText = 'margin-bottom:0.15rem';
                            row.innerHTML = '<div style="display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:0.2rem;align-items:center">'
                                + '<input type="text" id="k8s-comp-env-key-' + compId + '-' + j + '" class="modal-form-input" placeholder="KEY_NAME"'
                                + ' oninput="if(!this.dataset.envTs)this.dataset.envTs=Date.now();window._wizValidation.recheck(\'k8s\')"'
                                + ' style="font-size:0.76rem;padding:0.15rem 0.25rem;font-family:var(--font-mono,monospace)">'
                                + '<input type="text" id="k8s-comp-env-val-' + compId + '-' + j + '" class="modal-form-input" placeholder="value" style="font-size:0.76rem;padding:0.15rem 0.25rem;font-family:var(--font-mono,monospace)">'
                                + '<select id="k8s-comp-env-type-' + compId + '-' + j + '" class="modal-form-select" style="font-size:0.76rem;padding:0.15rem 0.25rem"'
                                + ' onchange="window._k8sCompEnvTypeChange(this)">'
                                + '<option value="hardcoded" selected>üìã Hardcoded</option>'
                                + '<option value="variable">üîÑ Variable</option>'
                                + '<option value="secret">üîí Secret</option>'
                                + '</select>'
                                + '<button type="button" onclick="this.closest(\'.k8s-comp-env-row\').remove();window._wizValidation.recheck(\'k8s\')" style="background:none;border:none;cursor:pointer;font-size:0.78rem;color:var(--text-muted);padding:0 2px" title="Remove">‚úï</button>'
                                + '</div>'
                                + '<div id="k8s-comp-env-dupe-' + compId + '-' + j + '" hidden'
                                + ' style="font-size:0.76rem;margin:1px 0 3px;padding:3px 6px;border-radius:4px">'
                                + '</div>';
                            list.appendChild(row);
                            window._wizValidation.recheck('k8s');
                        };

                        // Add volume mount to companion
                        window._k8sAddCompVol = (targetIdx, sourceIdx) => {
                            const list = document.getElementById('k8s-comp-vol-list-' + targetIdx + '-' + sourceIdx);
                            if (!list) return;
                            const j = list.querySelectorAll('.k8s-comp-vol-row').length;
                            const row = document.createElement('div');
                            row.className = 'k8s-comp-vol-row';
                            row.style.cssText = 'display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:0.2rem;align-items:center';
                            row.innerHTML = '<input type="text" id="k8s-comp-vol-name-' + targetIdx + '-' + sourceIdx + '-' + j + '" class="modal-form-input" placeholder="volume-name" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                + '<input type="text" id="k8s-comp-vol-mount-' + targetIdx + '-' + sourceIdx + '-' + j + '" class="modal-form-input" placeholder="/data" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                + '<select id="k8s-comp-vol-type-' + targetIdx + '-' + sourceIdx + '-' + j + '" class="modal-form-select" style="font-size:0.76rem;padding:0.15rem 0.25rem">'
                                + '<option value="emptyDir" selected>üìÇ emptyDir</option>'
                                + '<option value="pvc-dynamic">üíæ PVC</option>'
                                + '<option value="configMap">üìÑ ConfigMap</option>'
                                + '<option value="secret">üîê Secret</option>'
                                + '</select>'
                                + '<button type="button" onclick="this.closest(\'.k8s-comp-vol-row\').remove()" style="background:none;border:none;cursor:pointer;font-size:0.78rem;color:var(--text-muted);padding:0 2px" title="Remove">‚úï</button>';
                            list.appendChild(row);
                        };

                        let html = '';

                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        // ‚îÄ‚îÄ Section A: Application Services ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                        if (hasCompose && appSvcs.length > 0) {
                            html += wizSection('Application Deployments',
                                `${appSvcs.length} service${appSvcs.length !== 1 ? 's' : ''} from Docker Compose. Select which to deploy and configure each.`);

                            html += `<div style="display:flex;flex-direction:column;gap:0.5rem" id="k8s-app-svc-list">`;
                            for (let i = 0; i < appSvcs.length; i++) {
                                const svc = appSvcs[i];
                                svc._kindDefault = _classifyWorkloadKind(svc);
                                svc._kindHint = _kindHint(svc._kindDefault, svc);
                                const imgStr = svc._image || `${svc.name}:latest`;
                                const portVal = svc._port || 8080;
                                const envKeys = Object.keys(svc.environment || {});
                                const envVals = svc.environment || {};
                                const volCount = (svc.volumes || []).length;
                                const hc = svc.healthcheck;
                                const dp = svc.deploy;  // {replicas, cpu_limit, memory_limit, cpu_request, memory_request} | null
                                const hasDeps = (svc.depends_on || []).length > 0;

                                // Detect named volumes (not bind mounts) ‚Äî suggests Recreate strategy
                                // Named volumes: "vol-name:/path" (no slash/dot in source)
                                // Bind mounts: "./src:/app" or "/host/path:/container" (has path separator in source)
                                const hasNamedVols = (svc.volumes || []).some(v => {
                                    const src = v.split(':')[0];
                                    return src && !src.includes('/') && !src.startsWith('.');
                                });
                                const defaultStrategy = hasNamedVols ? 'Recreate' : 'RollingUpdate';

                                // Pre-compute compose-sourced resource defaults
                                const compCpuReq = (dp && dp.cpu_request) || '';
                                const compCpuLim = (dp && dp.cpu_limit) || '';
                                const compMemReq = (dp && dp.memory_request) || '';
                                const compMemLim = (dp && dp.memory_limit) || '';
                                const hasComposeRes = compCpuReq || compCpuLim || compMemReq || compMemLim;

                                // ‚îÄ‚îÄ Saved state lookup (per-service) ‚îÄ‚îÄ
                                const saved = _savedSvc(svc.name);
                                // Effective values: saved state takes priority, detection as fallback
                                const effKind     = saved?.kind ?? svc._kindDefault;
                                const effImage    = saved?.image || imgStr;
                                const effPort     = saved?.port ?? portVal;
                                const effReplicas = saved?.replicas ?? (dp && dp.replicas ? dp.replicas : 2);
                                const effSvcType  = saved?.serviceType || 'ClusterIP';
                                const effStrategy = saved?.strategy || defaultStrategy;
                                const effMaxSurge = saved?.maxSurge || '1';
                                const effMaxUnavail = saved?.maxUnavailable || '1';
                                const effCpuReq   = saved?.resources?.cpu_request || compCpuReq;
                                const effCpuLim   = saved?.resources?.cpu_limit || compCpuLim;
                                const effMemReq   = saved?.resources?.memory_request || compMemReq;
                                const effMemLim   = saved?.resources?.memory_limit || compMemLim;

                                html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);overflow:hidden" id="k8s-svc-card-${i}">
                                    <label style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.6rem;cursor:pointer;font-size:0.82rem"
                                        onmouseover="this.parentElement.style.borderColor='var(--accent)'" onmouseout="this.parentElement.style.borderColor='var(--border-subtle)'">
                                        <input type="checkbox" id="k8s-svc-chk-${i}" checked style="accent-color:var(--accent)"
                                            onchange="document.getElementById('k8s-svc-cfg-${i}').style.display=this.checked?'block':'none'">
                                        <span style="font-size:1rem" id="k8s-svc-icon-${i}">${_kindIcon(effKind)}</span>
                                        <strong>${esc(svc.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(svc.image ? svc.image.split('/').pop().split(':')[0] : 'local build')}</code>
                                        <span style="flex:1"></span>
                                        ${portVal ? `<code style="font-size:0.68rem;color:var(--text-muted)">:${portVal}</code>` : ''}
                                        <select id="k8s-svc-kind-${i}" class="modal-form-select"
                                            style="font-size:0.68rem;padding:0.1rem 0.3rem;min-width:110px;color:var(--success);font-weight:600;border-color:transparent;background:transparent"
                                            onclick="event.stopPropagation()" onmousedown="event.stopPropagation()"
                                            onchange="var ic=document.getElementById('k8s-svc-icon-'+${i});var hn=document.getElementById('k8s-svc-kind-hint-'+${i});if(ic)ic.textContent={'Deployment':'üöÄ','StatefulSet':'üóÑÔ∏è','DaemonSet':'üåê','Job':'‚ö°','CronJob':'‚è∞','Skip':'‚è≠Ô∏è'}[this.value]||'üì¶';if(hn)hn.textContent='';window._k8sToggleKindPanels(${i},this.value)">
                                            <option value="Deployment"${effKind === 'Deployment' ? ' selected' : ''}>Deployment</option>
                                            <option value="StatefulSet"${effKind === 'StatefulSet' ? ' selected' : ''}>StatefulSet</option>
                                            <option value="DaemonSet"${effKind === 'DaemonSet' ? ' selected' : ''}>DaemonSet</option>
                                            <option value="Job"${effKind === 'Job' ? ' selected' : ''}>Job</option>
                                            <option value="CronJob"${effKind === 'CronJob' ? ' selected' : ''}>CronJob</option>
                                            <option value="Skip"${effKind === 'Skip' ? ' selected' : ''}>Skip</option>
                                        </select>
                                    </label>
                                    ${(!saved && svc._kindHint) ? `<div id="k8s-svc-kind-hint-${i}" style="font-size:0.62rem;color:var(--text-muted);padding:0 0.6rem 0.2rem;font-style:italic">${svc._kindHint}</div>` : `<div id="k8s-svc-kind-hint-${i}" style="font-size:0.62rem;color:var(--text-muted);padding:0 0.6rem 0.2rem;font-style:italic"></div>`}
                                    <!-- Skip banner (hidden by default) -->
                                    <div id="k8s-svc-skip-banner-${i}" style="display:none;padding:0.6rem;margin:0 0.6rem 0.5rem;background:var(--bg-primary);border-radius:6px;border:1px dashed var(--border-subtle);text-align:center">
                                        <div style="font-size:0.9rem;margin-bottom:0.15rem">‚è≠Ô∏è</div>
                                        <div style="font-size:0.72rem;color:var(--text-muted);font-weight:600">Excluded</div>
                                        <div style="font-size:0.66rem;color:var(--text-muted);font-style:italic">This service will not be deployed to Kubernetes.</div>
                                    </div>
                                    <div id="k8s-svc-cfg-${i}" style="padding:0 0.6rem 0.5rem;display:${effKind === 'Skip' ? 'none' : 'block'}">`;
                                html += `
                                        <!-- ‚îÄ‚îÄ‚îÄ Primary settings row (shared: image always visible) ‚îÄ‚îÄ‚îÄ -->
                                        <div style="display:grid;grid-template-columns:3fr 1fr 1fr 1fr;gap:0.4rem;align-items:start">
                                            <div><span class="k8s-field-img">${_lbl('Container Image')}${_inp(`k8s-svc-img-${i}`, effImage, 'ghcr.io/user/app:latest')}</span></div>
                                            <div id="k8s-svc-port-wrap-${i}">${_lbl('Port')}${_num(`k8s-svc-port-${i}`, effPort)}</div>
                                            <div id="k8s-svc-replicas-wrap-${i}">${_lbl('Replicas')}${_num(`k8s-svc-replicas-${i}`, effReplicas)}</div>
                                            <div id="k8s-svc-svctype-wrap-${i}">${_lbl('Service Type')}${_sel(`k8s-svc-type-${i}`, [
                                                {v:'ClusterIP', l:'ClusterIP'},
                                                {v:'NodePort', l:'NodePort'},
                                                {v:'LoadBalancer', l:'LoadBalancer'}
                                            ], effSvcType)}</div>
                                        </div>

                                        <!-- ‚îÄ‚îÄ Deployment/StatefulSet/DaemonSet-only sections ‚îÄ‚îÄ -->
                                        <div id="k8s-svc-deploy-sections-${i}">
                                        <!-- ‚îÄ‚îÄ‚îÄ Update Strategy ‚îÄ‚îÄ‚îÄ -->
                                        <div style="display:flex;align-items:end;gap:0.4rem;margin-top:0.35rem;flex-wrap:wrap">
                                            <div style="min-width:140px">
                                                ${_lbl('Update Strategy')}
                                                <select id="k8s-svc-strategy-${i}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem;width:100%"
                                                    onchange="var r=document.getElementById('k8s-svc-rolling-${i}');var h=document.getElementById('k8s-svc-strat-hint-${i}');if(r)r.style.display=this.value==='RollingUpdate'?'flex':'none';if(h)h.style.display=this.value==='Recreate'?'block':'none'">
                                                    <option value="RollingUpdate"${effStrategy === 'RollingUpdate' ? ' selected' : ''}>RollingUpdate</option>
                                                    <option value="Recreate"${effStrategy === 'Recreate' ? ' selected' : ''}>Recreate</option>
                                                </select>
                                            </div>
                                            <div id="k8s-svc-rolling-${i}" style="display:${effStrategy === 'RollingUpdate' ? 'flex' : 'none'};align-items:end;gap:0.4rem">
                                                <div style="min-width:80px">
                                                    ${_lbl('Max Surge')}
                                                    ${_inp(`k8s-svc-maxsurge-${i}`, effMaxSurge, '1')}
                                                </div>
                                                <div style="min-width:80px">
                                                    ${_lbl('Max Unavailable')}
                                                    ${_inp(`k8s-svc-maxunavail-${i}`, effMaxUnavail, '1')}
                                                </div>
                                            </div>
                                            <div id="k8s-svc-strat-hint-${i}" style="display:${defaultStrategy === 'Recreate' ? 'block' : 'none'};font-size:0.62rem;color:var(--text-muted);font-style:italic;padding-bottom:0.1rem">
                                                ${hasNamedVols
                                                    ? 'üí° Recreate recommended ‚Äî named volumes with ReadWriteOnce PVCs prevent two pods mounting simultaneously during rollout'
                                                    : 'üí° Kills all pods before creating new ones ‚Äî causes brief downtime but avoids version conflicts'
                                                }
                                            </div>
                                        </div>
                                        </div><!-- end deploy-sections -->

                                        <!-- ‚îÄ‚îÄ Job/CronJob-only sections (hidden by default) ‚îÄ‚îÄ -->
                                        <div id="k8s-svc-job-sections-${i}" style="display:none">
                                            <div style="margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.68rem;color:var(--accent);font-weight:600;margin-bottom:0.3rem">‚ö° Job Configuration</div>
                                                <div style="display:grid;grid-template-columns:3fr 2fr 1fr;gap:0.4rem;align-items:start">
                                                    <div>${_lbl('Command')}${_inp(`k8s-svc-job-cmd-${i}`, '', '/bin/sh -c "‚Ä¶"')}</div>
                                                    <div>${_lbl('Args (optional)')}${_inp(`k8s-svc-job-args-${i}`, '', 'arg1 arg2 ‚Ä¶')}</div>
                                                    <div>${_lbl('Restart Policy')}${_sel(`k8s-svc-job-restart-${i}`, [
                                                        {v:'Never', l:'Never'},
                                                        {v:'OnFailure', l:'OnFailure'},
                                                    ], 'Never')}</div>
                                                </div>
                                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.4rem;margin-top:0.3rem;align-items:start">
                                                    <div>${_lbl('Backoff Limit')}${_num(`k8s-svc-job-backoff-${i}`, 3)}</div>
                                                    <div>${_lbl('Completions')}${_num(`k8s-svc-job-completions-${i}`, 1)}</div>
                                                    <div>${_lbl('Parallelism')}${_num(`k8s-svc-job-parallelism-${i}`, 1)}</div>
                                                    <div>${_lbl('Timeout (s)')}${_num(`k8s-svc-job-timeout-${i}`, 600)}</div>
                                                </div>
                                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-top:0.3rem;align-items:start">
                                                    <div>${_lbl('TTL After Finished (s)')}${_num(`k8s-svc-job-ttl-${i}`, 3600)}</div>
                                                    <div style="font-size:0.6rem;color:var(--text-muted);font-style:italic;padding-top:1.2rem">TTL = auto-cleanup delay after completion</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ‚îÄ‚îÄ CronJob-only sections (hidden by default) ‚îÄ‚îÄ -->
                                        <div id="k8s-svc-cron-sections-${i}" style="display:none">
                                            <div style="margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.68rem;color:var(--accent);font-weight:600;margin-bottom:0.3rem">‚è∞ CronJob Schedule</div>
                                                <div style="display:grid;grid-template-columns:2fr 2fr 1fr;gap:0.4rem;align-items:start">
                                                    <div>
                                                        ${_lbl('Schedule (cron)')}${_inp(`k8s-svc-cron-schedule-${i}`, '*/5 * * * *', '*/5 * * * *')}
                                                        <div id="k8s-svc-cron-preview-${i}" style="font-size:0.58rem;color:var(--text-muted);margin-top:2px">Every 5 minutes</div>
                                                    </div>
                                                    <div>${_lbl('Concurrency Policy')}${_sel(`k8s-svc-cron-concurrency-${i}`, [
                                                        {v:'Allow', l:'Allow (overlap OK)'},
                                                        {v:'Forbid', l:'Forbid (skip if running)'},
                                                        {v:'Replace', l:'Replace (kill + restart)'},
                                                    ], 'Forbid')}</div>
                                                    <div>
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer;margin-top:1rem">
                                                            <input type="checkbox" id="k8s-svc-cron-suspend-${i}" style="accent-color:var(--accent)"> Suspend
                                                        </label>
                                                    </div>
                                                </div>
                                                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.4rem;margin-top:0.3rem;align-items:start">
                                                    <div>${_lbl('Keep Successful')}${_num(`k8s-svc-cron-success-${i}`, 3)}</div>
                                                    <div>${_lbl('Keep Failed')}${_num(`k8s-svc-cron-failed-${i}`, 1)}</div>
                                                    <div>${_lbl('Deadline (s)')}${_num(`k8s-svc-cron-deadline-${i}`, 300)}</div>
                                                </div>
                                                <div style="font-size:0.58rem;color:var(--text-muted);font-style:italic;margin-top:2px">Deadline = skip this run if missed by this many seconds</div>
                                            </div>
                                        </div>

                                        <!-- ‚îÄ‚îÄ DaemonSet-only sections (hidden by default) ‚îÄ‚îÄ -->
                                        <div id="k8s-svc-daemon-sections-${i}" style="display:none">
                                            <div style="margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.68rem;color:var(--accent);font-weight:600;margin-bottom:0.3rem">üåê DaemonSet Configuration</div>

                                                <!-- Update Strategy -->
                                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;align-items:start">
                                                    <div>
                                                        ${_lbl('Update Strategy')}
                                                        <select id="k8s-svc-ds-strategy-${i}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem;width:100%"
                                                            onchange="var w=document.getElementById('k8s-svc-ds-maxunavail-wrap-${i}');if(w)w.style.display=this.value==='RollingUpdate'?'block':'none'">
                                                            <option value="RollingUpdate" selected>RollingUpdate</option>
                                                            <option value="OnDelete">OnDelete</option>
                                                        </select>
                                                    </div>
                                                    <div id="k8s-svc-ds-maxunavail-wrap-${i}">
                                                        ${_lbl('Max Unavailable')}
                                                        ${_inp(`k8s-svc-ds-maxunavail-${i}`, '1', '1')}
                                                    </div>
                                                </div>
                                                <div style="font-size:0.58rem;color:var(--text-muted);font-style:italic;margin-top:2px">OnDelete = manual pod-by-pod control (delete pod to trigger update)</div>

                                                <!-- Node Selection -->
                                                <div style="margin-top:0.4rem">
                                                    <div style="font-size:0.68rem;color:var(--text-muted);font-weight:600;margin-bottom:0.2rem">üéØ Node Selection</div>
                                                    <div>${_lbl('Node Selector')}</div>
                                                    ${_inp(`k8s-svc-ds-nodeselector-${i}`, '', 'key=value, key=value')}
                                                    <div style="font-size:0.56rem;color:var(--text-muted);font-style:italic;margin-top:1px">Leave empty to run on all nodes</div>
                                                </div>

                                                <!-- Tolerations -->
                                                <div style="margin-top:0.35rem">
                                                    <div style="font-size:0.68rem;color:var(--text-muted);font-weight:600;margin-bottom:0.2rem">üîì Tolerations</div>
                                                    <div style="display:flex;flex-direction:column;gap:0.2rem">
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ds-tol-cp-${i}" style="accent-color:var(--accent)"> Run on control-plane nodes
                                                        </label>
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ds-tol-nosched-${i}" style="accent-color:var(--accent)"> Run on nodes with NoSchedule taints
                                                        </label>
                                                    </div>
                                                </div>

                                                <!-- Host Access -->
                                                <div style="margin-top:0.35rem">
                                                    <div style="font-size:0.68rem;color:var(--text-muted);font-weight:600;margin-bottom:0.2rem">üîå Host Access</div>
                                                    <div style="display:flex;flex-wrap:wrap;gap:0.4rem 1rem">
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ds-hostnet-${i}" style="accent-color:var(--accent)"> Host Network
                                                        </label>
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ds-hostpid-${i}" style="accent-color:var(--accent)"> Host PID
                                                        </label>
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ds-hostipc-${i}" style="accent-color:var(--accent)"> Host IPC
                                                        </label>
                                                    </div>
                                                    <div style="font-size:0.56rem;color:var(--text-muted);font-style:italic;margin-top:2px">Host access = pod shares the node's namespace (common for monitoring agents)</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ‚îÄ‚îÄ StatefulSet-only sections (hidden by default) ‚îÄ‚îÄ -->
                                        <div id="k8s-svc-statefulset-sections-${i}" style="display:none">
                                            <div style="margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.68rem;color:var(--accent);font-weight:600;margin-bottom:0.3rem">üóÑÔ∏è StatefulSet Configuration</div>

                                                <!-- Headless Service + ClusterIP -->
                                                <div style="display:grid;grid-template-columns:2fr 1fr 1fr;gap:0.4rem;align-items:start">
                                                    <div>
                                                        ${_lbl('Headless Service Name')}
                                                        ${_inp(`k8s-svc-ss-headless-${i}`, `${svc.name}-headless`, `${svc.name}-headless`)}
                                                    </div>
                                                    <div>
                                                        ${_lbl('Pod Management')}
                                                        ${_sel(`k8s-svc-ss-podmgmt-${i}`, [
                                                            {v:'OrderedReady', l:'OrderedReady'},
                                                            {v:'Parallel', l:'Parallel'},
                                                        ], 'OrderedReady')}
                                                    </div>
                                                    <div style="padding-top:1rem">
                                                        <label style="display:inline-flex;align-items:center;gap:0.3rem;font-size:0.72rem;cursor:pointer">
                                                            <input type="checkbox" id="k8s-svc-ss-clusterip-${i}" style="accent-color:var(--accent)"> Also create ClusterIP
                                                        </label>
                                                    </div>
                                                </div>
                                                <div style="font-size:0.56rem;color:var(--text-muted);font-style:italic;margin-top:1px">Headless Service enables stable DNS: <code>${svc.name}-0.${svc.name}-headless</code></div>

                                                <!-- Update Strategy -->
                                                <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.4rem;margin-top:0.35rem;align-items:start">
                                                    <div>
                                                        ${_lbl('Update Strategy')}
                                                        <select id="k8s-svc-ss-strategy-${i}" class="modal-form-select" style="font-size:0.76rem;padding:0.2rem 0.3rem;width:100%"
                                                            onchange="var w=document.getElementById('k8s-svc-ss-partition-wrap-${i}');if(w)w.style.display=this.value==='RollingUpdate'?'block':'none'">
                                                            <option value="RollingUpdate" selected>RollingUpdate</option>
                                                            <option value="OnDelete">OnDelete</option>
                                                        </select>
                                                    </div>
                                                    <div id="k8s-svc-ss-partition-wrap-${i}">
                                                        ${_lbl('Partition')}
                                                        ${_num(`k8s-svc-ss-partition-${i}`, 0)}
                                                        <div style="font-size:0.54rem;color:var(--text-muted);font-style:italic">Ordinal ‚â• partition gets updated; lower ordinals stay on old version</div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- volumeClaimTemplates section -->
                                            <div style="margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.68rem;color:var(--accent);font-weight:600;margin-bottom:0.3rem;display:flex;align-items:center;gap:0.3rem">
                                                    üíæ Persistent Storage (volumeClaimTemplates)
                                                    ${volCount > 0 ? `<span style="font-size:0.6rem;background:var(--bg-secondary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">${volCount} from Compose</span>` : ''}
                                                </div>
                                                <div style="font-size:0.56rem;color:var(--text-muted);font-style:italic;margin-bottom:0.3rem">Each pod gets its own PVC: <code>data-${svc.name}-0</code>, <code>data-${svc.name}-1</code>, ‚Ä¶</div>

                                                <div id="k8s-svc-vct-list-${i}" style="display:flex;flex-direction:column;gap:0.3rem">
                                                    ${(() => {
                                                        const vols = svc.volumes || [];
                                                        const namedVols = vols.map(v => window._classifyVolume(v)).filter(cl => cl.classification === 'named');
                                                        if (namedVols.length === 0) return '<div style="font-size:0.68rem;color:var(--text-muted);font-style:italic">No named volumes detected ‚Äî click "+ Add volume claim template" below</div>';
                                                        return namedVols.map((cl, j) => {
                                                            return `<div class="k8s-vct-row" style="padding:0.3rem;border:1px solid var(--border-subtle);border-radius:4px;background:var(--bg-secondary)">
                                                                <div style="display:grid;grid-template-columns:auto 1fr 2fr 1fr 1fr 1fr;gap:0.3rem;align-items:center;font-size:0.72rem">
                                                                    <label><input type="checkbox" id="k8s-svc-vct-chk-${i}-${j}" checked style="accent-color:var(--accent)"></label>
                                                                    <div>${_lbl('Name')}${_inp(`k8s-svc-vct-name-${i}-${j}`, cl.name, 'data')}</div>
                                                                    <div>${_lbl('Mount Path')}${_inp(`k8s-svc-vct-mount-${i}-${j}`, cl.mountPath, '/var/lib/data')}</div>
                                                                    <div>${_lbl('Size')}${_inp(`k8s-svc-vct-size-${i}-${j}`, '10Gi', '10Gi')}</div>
                                                                    <div>${_lbl('Access Mode')}${_sel(`k8s-svc-vct-access-${i}-${j}`, [
                                                                        {v:'ReadWriteOnce', l:'RWO'},
                                                                        {v:'ReadWriteMany', l:'RWX'},
                                                                        {v:'ReadOnlyMany', l:'ROX'},
                                                                    ], 'ReadWriteOnce')}</div>
                                                                    <div>${_lbl('StorageClass')}${_inp(`k8s-svc-vct-sc-${i}-${j}`, '', 'longhorn')}</div>
                                                                </div>
                                                            </div>`;
                                                        }).join('');
                                                    })()}
                                                </div>
                                                <button type="button" style="margin-top:0.3rem;font-size:0.68rem;padding:0.15rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--accent)"
                                                    onclick="window._k8sAddVCT(${i})">+ Add volume claim template</button>
                                            </div>
                                        </div>

                                        <!-- ‚îÄ‚îÄ‚îÄ 1. Resource Limits ‚îÄ‚îÄ‚îÄ -->
                                        <details style="margin-top:0.4rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                ‚ñ∏ Resource Limits
                                                ${hasComposeRes ? '<span style="font-size:0.6rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">from Compose</span>' : ''}
                                                <span id="k8s-svc-qos-${i}" style="margin-left:auto">${_qosHint(compCpuReq, compCpuLim, compMemReq, compMemLim)}</span>
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="display:grid;grid-template-columns:auto 1fr 1fr;gap:0.3rem 0.5rem;align-items:center;font-size:0.74rem">
                                                    <!-- Header row -->
                                                    <div></div>
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.66rem;text-transform:uppercase;letter-spacing:0.04em">Request <span style="font-size:0.58rem;opacity:0.7">(guaranteed minimum)</span></div>
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.66rem;text-transform:uppercase;letter-spacing:0.04em">Limit <span style="font-size:0.58rem;opacity:0.7">(hard ceiling)</span></div>
                                                    <!-- CPU row -->
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.72rem">CPU</div>
                                                    <div>${_inp(`k8s-svc-cpu-req-${i}`, effCpuReq, '100m')}</div>
                                                    <div>${_inp(`k8s-svc-cpu-lim-${i}`, effCpuLim, '500m')}</div>
                                                    <!-- Memory row -->
                                                    <div style="font-weight:600;color:var(--text-secondary);font-size:0.72rem">Memory</div>
                                                    <div>${_inp(`k8s-svc-mem-req-${i}`, effMemReq, '128Mi')}</div>
                                                    <div>${_inp(`k8s-svc-mem-lim-${i}`, effMemLim, '256Mi')}</div>
                                                </div>
                                                <!-- Live QoS class + guidance -->
                                                <div style="display:flex;align-items:center;gap:0.5rem;margin-top:0.35rem;padding-top:0.3rem;border-top:1px solid var(--border-subtle)">
                                                    <span style="font-size:0.66rem;color:var(--text-muted)">QoS class ‚Üí</span>
                                                    <span id="k8s-svc-qos-live-${i}">${_qosHint(effCpuReq, effCpuLim, effMemReq, effMemLim)}</span>
                                                    <span style="flex:1"></span>
                                                    <span style="font-size:0.6rem;color:var(--text-muted);font-style:italic">Empty = omit from manifest (K8s node defaults apply)</span>
                                                </div>
                                            </div>
                                        </details>

                                        <!-- ‚îÄ‚îÄ‚îÄ 2. Health Checks (hidden for Job/CronJob) ‚îÄ‚îÄ‚îÄ -->
                                        <div id="k8s-svc-probes-wrap-${i}">
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                ‚ñ∏ Health Checks
                                                ${hc ? '<span style="font-size:0.6rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">from Compose</span>' : ''}
                                                <span style="margin-left:auto;font-size:0.6rem;color:var(--text-muted)">recommended</span>
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                ${(() => {
                                                    const parsed = _parseComposeProbe(hc, portVal);
                                                    const prd = _parseDur(hc && hc.interval);
                                                    const pto = _parseDur(hc && hc.timeout);
                                                    const pret = hc && hc.retries ? parseInt(hc.retries) : null;
                                                    // Readiness defaults: fast startup, frequent checks
                                                    const rdy = _probeBlock(
                                                        `k8s-svc-rdy-${i}`, 'Readiness Probe',
                                                        parsed.type, parsed.path, parsed.port, parsed.command,
                                                        5, prd || 5, pto || 3, 'Timeout (s)'
                                                    );
                                                    // Liveness defaults: slower startup tolerance, less frequent
                                                    const liv = _probeBlock(
                                                        `k8s-svc-liv-${i}`, 'Liveness Probe',
                                                        parsed.type, parsed.path, parsed.port, parsed.command,
                                                        10, prd || 15, pret || 3, 'Failures'
                                                    );
                                                    return rdy + `<div style="border-top:1px solid var(--border-subtle);margin:0.15rem 0"></div>` + liv;
                                                })()}
                                                ${hc ? `<div style="font-size:0.62rem;color:var(--text-muted);border-top:1px solid var(--border-subtle);padding-top:0.25rem;margin-top:0.2rem">
                                                    üí° Parsed from: <code style="font-size:0.6rem;background:var(--bg-inset);padding:1px 4px;border-radius:3px">${esc(typeof hc.test === 'string' ? hc.test : Array.isArray(hc.test) ? hc.test.join(' ') : String(hc.test))}</code>
                                                </div>` : `<div style="font-size:0.62rem;color:var(--text-muted);font-style:italic;margin-top:0.15rem">
                                                    üí° No compose healthcheck ‚Äî defaults pre-filled. Uncheck to omit probes.
                                                </div>`}
                                            </div>
                                        </details>
                                        </div>

                                        <!-- ‚îÄ‚îÄ‚îÄ 3. Environment Variables ‚îÄ‚îÄ‚îÄ -->
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                ‚ñ∏ Environment Variables
                                                ${envKeys.length > 0 ? `<span style="font-size:0.72rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">${envKeys.length} from Compose</span>` : ''}
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                ${isMultiEnv ? `<div style="font-size:0.78rem;color:var(--warning);background:color-mix(in srgb, var(--warning) 8%, transparent);padding:0.3rem 0.4rem;border-radius:4px;margin-bottom:0.35rem;display:flex;align-items:center;gap:0.3rem">
                                                    <span>üìå</span>
                                                    <span>Multi-env project: values shown are defaults. Use <strong>Variable | Secret</strong> for values that differ across environments.</span>
                                                </div>` : ''}
                                                ${envKeys.length > 0 ? `<div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;margin-bottom:0.2rem;padding:0 0.25rem">
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Key</span>
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Value</span>
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Var / Secret</span>
                                                    <span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Injection</span>
                                                    <span></span>
                                                </div>` : ''}
                                                <div id="k8s-svc-env-list-${i}" style="display:flex;flex-direction:column;gap:0.2rem">
                                                    ${(() => {
                                                        // Use saved env vars when available, otherwise compose detection
                                                        if (saved?.envVars) {
                                                            return saved.envVars.map((ev, j) => {
                                                                return _envRowHtml(i, j, ev.key, ev.value || '', ev.type || 'hardcoded', ev.varName || '', i);
                                                            }).join('');
                                                        }
                                                        return Object.entries(envVals).map(([k, v], j) => {
                                                            const injType = _defaultInjType(k);
                                                            return _envRowHtml(i, j, k, v || '', injType, injType !== 'hardcoded' ? '${' + k + '}' : '', i);
                                                        }).join('');
                                                    })()}
                                                </div>
                                                <button type="button" onclick="_addEnvVar(${i})"
                                                    style="margin-top:0.3rem;font-size:0.66rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.2rem 0.5rem;cursor:pointer;width:100%">
                                                    + Add variable
                                                </button>
                                                <div id="k8s-svc-env-summary-${i}" style="font-size:0.6rem;color:var(--text-muted);margin-top:0.25rem;padding-top:0.2rem;border-top:1px solid var(--border-subtle)">
                                                    ${(() => {
                                                        const envList = saved?.envVars || envKeys.map(k => ({key: k, type: _defaultInjType(k)}));
                                                        let hc = 0, vr = 0, sc = 0;
                                                        for (const ev of envList) {
                                                            const t = ev.type || 'hardcoded';
                                                            if (t === 'secret') sc++;
                                                            else if (t === 'variable') vr++;
                                                            else hc++;
                                                        }
                                                        const dlr = '$';
                                                        const parts = [];
                                                        if (hc + vr > 0) parts.push('üìã ConfigMap: ' + hc + ' hardcoded' + (vr > 0 ? ', ' + vr + ' ' + dlr + '{VAR}' : ''));
                                                        if (sc > 0) parts.push('üîí Secret: ' + sc + ' key' + (sc !== 1 ? 's' : '') + ' (' + dlr + '{VAR} at deploy)');
                                                        if (parts.length === 0) parts.push('No environment variables configured');
                                                        return parts.join(' &middot; ');
                                                    })()}
                                                </div>
                                            </div>
                                        </details>

                                        <!-- ‚îÄ‚îÄ‚îÄ 4. Volume Mounts (hidden for Job/CronJob) ‚îÄ‚îÄ‚îÄ -->
                                        <div id="k8s-svc-vols-wrap-${i}">
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                ‚ñ∏ Volume Mounts
                                                ${volCount > 0 ? `<span style="font-size:0.6rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">${volCount} from Compose</span>` : ''}
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.45rem 0.5rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">


                                                <div style="font-size:0.68rem;color:var(--text-muted);font-weight:600;margin-bottom:0.25rem;display:flex;align-items:center;gap:0.3rem">
                                                    Volumes
                                                    <span id="k8s-svc-vol-summary-${i}" style="font-size:0.6rem;font-weight:400;color:var(--text-muted)"></span>
                                                </div>
                                                <!-- Volume rows container -->
                                                <div id="k8s-svc-vol-list-${i}" style="display:flex;flex-direction:column;gap:0.35rem">
                                                    ${(() => {
                                                        // Use saved volumes when available, otherwise compose detection
                                                        if (saved?.volumes) {
                                                            if (saved.volumes.length === 0) return '<div style="font-size:0.68rem;color:var(--text-muted);font-style:italic">No volumes configured ‚Äî click \'+ Add volume\' below</div>';
                                                            return saved.volumes.map((vol, j) => {
                                                                const cl = window._savedVolToClassification(vol);
                                                                return window._volRowHtml(i, j, cl);
                                                            }).join('');
                                                        }
                                                        const vols = svc.volumes || [];
                                                        if (vols.length === 0) return '<div style="font-size:0.68rem;color:var(--text-muted);font-style:italic">No volumes detected ‚Äî click "+ Add volume" below</div>';
                                                        return vols.map((v, j) => {
                                                            const cl = window._classifyVolume(v);
                                                            return window._volRowHtml(i, j, cl);
                                                        }).join('');
                                                    })()}
                                                </div>
                                                <button type="button" onclick="window._addVolRow(${i})"
                                                    style="margin-top:0.35rem;font-size:0.68rem;color:var(--accent);background:none;border:1px dashed var(--border);border-radius:4px;padding:4px 10px;cursor:pointer;width:100%"
                                                    onmouseover="this.style.background='rgba(99,102,241,0.06)'" onmouseout="this.style.background='none'">
                                                    + Add volume
                                                </button>
                                            </div>
                                        </details>
                                        </div>

                                        <!-- ‚îÄ‚îÄ‚îÄ 5. Dependencies (hidden for Job/CronJob) ‚îÄ‚îÄ‚îÄ -->
                                        <div id="k8s-svc-deps-wrap-${i}">
                                        <div style="margin-top:0.3rem;padding:0.2rem 0">
                                            <span style="font-size:0.68rem;color:var(--text-muted);font-weight:600">Depends on</span>
                                            <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-top:0.15rem">
                                                ${infraSvcs.length > 0 ? infraSvcs.map(inf => {
                                                    const savedDeps = saved?.dependencies || svc.depends_on || [];
                                                    const checked = savedDeps.includes(inf.name) ? ' checked' : '';
                                                    return `<label style="display:inline-flex;align-items:center;gap:0.2rem;font-size:0.7rem;cursor:pointer">
                                                        <input type="checkbox" class="k8s-dep-${i}" value="${esc(inf.name)}" style="accent-color:var(--accent)"${checked} onchange="window._refreshEnvSelects(${i})"> ${esc(inf.name)}
                                                    </label>`;
                                                }).join('') : '<span style="font-size:0.7rem;color:var(--text-muted)">‚Äî</span>'}
                                            </div>
                                        </div>
                                        </div>

                                        <!-- ‚îÄ‚îÄ‚îÄ 7. Init Containers (hidden for Job/CronJob) ‚îÄ‚îÄ‚îÄ -->
                                        <div id="k8s-svc-init-wrap-${i}">
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                ‚ñ∏ Init Containers
                                                <span id="k8s-svc-init-count-${i}" style="font-size:0.68rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">0</span>
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.45rem 0.5rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.72rem;color:var(--text-muted);font-style:italic;margin-bottom:0.25rem">Init containers run to completion before the main container starts ‚Äî useful for DB migrations, permission fixes, or waiting for dependencies.</div>

                                                <!-- Presets -->
                                                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.3rem">
                                                    <button type="button" class="k8s-init-preset" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddInitPreset(${i},'wait-tcp')">‚è≥ Wait for TCP</button>
                                                    <button type="button" class="k8s-init-preset" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddInitPreset(${i},'wait-http')">üåê Wait for HTTP</button>
                                                    <button type="button" class="k8s-init-preset" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddInitPreset(${i},'migrations')">üîÑ Run migrations</button>
                                                    <button type="button" class="k8s-init-preset" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddInitPreset(${i},'fix-perms')">üîß Fix permissions</button>
                                                    <button type="button" class="k8s-init-preset" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddInitPreset(${i},'custom')">üìù Custom</button>
                                                </div>

                                                <!-- Init container rows -->
                                                <div id="k8s-svc-init-list-${i}" style="display:flex;flex-direction:column;gap:0.3rem"></div>
                                            </div>
                                        </details>
                                        </div>

                                        <!-- ‚îÄ‚îÄ‚îÄ 8. Sidecar Containers ‚îÄ‚îÄ‚îÄ -->
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                ‚ñ∏ Sidecar Containers
                                                <span id="k8s-svc-sc-count-${i}" style="font-size:0.68rem;background:var(--bg-primary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">0</span>
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.45rem 0.5rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="font-size:0.72rem;color:var(--text-muted);font-style:italic;margin-bottom:0.25rem">Sidecar containers run alongside the main container ‚Äî for log forwarding, auth proxies, metrics exporters, etc.</div>

                                                <!-- Presets -->
                                                <div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:0.3rem">
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'log-fwd')">üìã Log forwarder</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'cfg-reload')">üîÑ Config reloader</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'metrics')">üìä Metrics exporter</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'auth-proxy')">üîê Auth proxy</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'cloudsql')">‚òÅÔ∏è Cloud SQL Proxy</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'vault')">üîí Vault agent</button>
                                                    <button type="button" style="font-size:0.74rem;padding:0.2rem 0.5rem;cursor:pointer;background:var(--bg-secondary);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)"
                                                        onclick="window._k8sAddSidecarPreset(${i},'custom')">üìù Custom</button>
                                                </div>

                                                <!-- Sidecar rows -->
                                                <div id="k8s-svc-sc-list-${i}" style="display:flex;flex-direction:column;gap:0.3rem"></div>
                                            </div>
                                        </details>

                                        <!-- ‚îÄ‚îÄ‚îÄ 9. Service Mesh ‚îÄ‚îÄ‚îÄ -->
                                        <details style="margin-top:0.3rem">
                                            <summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);user-select:none;padding:0.15rem 0;display:flex;align-items:center;gap:0.4rem">
                                                ‚ñ∏ Service Mesh
                                            </summary>
                                            <div style="margin-top:0.3rem;padding:0.45rem 0.5rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">
                                                <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.3rem">
                                                    <label style="display:inline-flex;align-items:center;gap:0.25rem;cursor:pointer;font-size:0.78rem;color:var(--text-secondary)">
                                                        <input type="checkbox" id="k8s-svc-mesh-enable-${i}" style="accent-color:var(--accent)"
                                                            onchange="document.getElementById('k8s-svc-mesh-cfg-'+${i}).style.display=this.checked?'block':'none'"> Enable sidecar injection
                                                    </label>
                                                    <select id="k8s-svc-mesh-provider-${i}" class="modal-form-select"
                                                        style="font-size:0.74rem;padding:0.15rem 0.3rem;min-width:90px;color:var(--success);font-weight:600;border-color:transparent;background:transparent">
                                                        <option value="istio" selected>Istio</option>
                                                        <option value="linkerd">Linkerd</option>
                                                        <option value="consul">Consul</option>
                                                        <option value="kuma">Kuma</option>
                                                    </select>
                                                </div>

                                                <!-- Mesh config (shown when enabled) -->
                                                <div id="k8s-svc-mesh-cfg-${i}" style="display:none">
                                                    <div style="padding:0.3rem 0.5rem;background:var(--bg-inset);border-radius:4px;border-left:3px solid var(--accent);margin-bottom:0.3rem;font-size:0.74rem;color:var(--text-muted)">
                                                        ‚ÑπÔ∏è The mesh proxy is injected by the cluster, not defined in your manifest. Only annotations are added.
                                                    </div>

                                                    <!-- Job/CronJob warning -->
                                                    <div id="k8s-svc-mesh-warn-${i}" style="display:none;padding:0.3rem 0.5rem;background:color-mix(in srgb, var(--warning) 10%, transparent);border-radius:4px;margin-bottom:0.3rem;font-size:0.74rem;color:var(--warning)">
                                                        ‚ö†Ô∏è Job/CronJob + service mesh requires K8s ‚â• 1.28 native sidecars for the proxy to terminate with the job.
                                                    </div>

                                                    <div style="font-size:0.78rem;color:var(--text-muted);font-weight:600;margin-bottom:0.2rem">Proxy Resources</div>
                                                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:0.3rem;font-size:0.72rem">
                                                        <div>${_lbl('CPU Request')}<input type="text" id="k8s-svc-mesh-cpureq-${i}" class="modal-form-input" value="100m" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                        <div>${_lbl('CPU Limit')}<input type="text" id="k8s-svc-mesh-cpulim-${i}" class="modal-form-input" value="500m" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                        <div>${_lbl('Mem Request')}<input type="text" id="k8s-svc-mesh-memreq-${i}" class="modal-form-input" value="128Mi" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                        <div>${_lbl('Mem Limit')}<input type="text" id="k8s-svc-mesh-memlim-${i}" class="modal-form-input" value="256Mi" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                    </div>

                                                    <!-- Advanced -->
                                                    <details style="margin-top:0.25rem">
                                                        <summary style="cursor:pointer;font-size:0.74rem;color:var(--text-muted);user-select:none">‚ñ∏ Advanced</summary>
                                                        <div style="margin-top:0.2rem;display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.3rem;font-size:0.72rem">
                                                            <div>${_lbl('Exclude inbound ports')}<input type="text" id="k8s-svc-mesh-exin-${i}" class="modal-form-input" placeholder="e.g. 8080,9090" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                            <div>${_lbl('Exclude outbound ports')}<input type="text" id="k8s-svc-mesh-exout-${i}" class="modal-form-input" placeholder="e.g. 3306" style="font-size:0.78rem;padding:0.18rem 0.3rem"></div>
                                                            <div>${_lbl('Log level')}<select id="k8s-svc-mesh-log-${i}" class="modal-form-select" style="font-size:0.78rem;padding:0.18rem 0.3rem">
                                                                <option value="warning" selected>warning</option>
                                                                <option value="info">info</option>
                                                                <option value="debug">debug</option>
                                                                <option value="error">error</option>
                                                            </select></div>
                                                        </div>
                                                    </details>
                                                </div>
                                            </div>
                                        </details>

                                        <!-- ‚îÄ‚îÄ‚îÄ 6. Companion Containers (from "Move into pod") ‚îÄ‚îÄ‚îÄ -->
                                        <div id="k8s-svc-companions-${i}" style="display:none;margin-top:0.35rem;padding:0.4rem;background:color-mix(in srgb, var(--accent) 4%, transparent);border-radius:6px;border:1px dashed var(--border-subtle)">
                                            <div style="font-size:0.74rem;color:var(--accent);font-weight:600;margin-bottom:0.2rem">üì¶ Companion Containers (same pod)</div>
                                            <div id="k8s-svc-companion-list-${i}" style="display:flex;flex-direction:column;gap:0.2rem"></div>
                                        </div>

                                        <!-- ‚îÄ‚îÄ‚îÄ Move into pod action ‚îÄ‚îÄ‚îÄ -->
                                        <div style="margin-top:0.25rem;text-align:right">
                                            <select id="k8s-svc-moveto-${i}" class="modal-form-select"
                                                style="font-size:0.76rem;padding:0.2rem 0.4rem;min-width:180px;color:var(--accent);border-color:var(--border-subtle)"
                                                onchange="if(this.value){window._k8sMoveIntoPod(${i},parseInt(this.value));this.value=''}"
                                            >
                                                <option value="">‚§µ Move into another pod‚Ä¶</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>`;
                            }
                            html += `</div>`;

                        } else if (deployableModules.length > 0) {
                            // No Compose ‚Äî show module-based cards
                            html += wizSection('Application Deployments',
                                `${deployableModules.length} module${deployableModules.length !== 1 ? 's' : ''} detected. Select which to deploy.`);

                            html += `<div style="display:flex;flex-direction:column;gap:0.5rem" id="k8s-app-svc-list">`;
                            for (let i = 0; i < deployableModules.length; i++) {
                                const m = deployableModules[i];
                                const imgStr = ghRepo.owner
                                    ? `ghcr.io/${ghRepo.owner}/${ghRepo.name}-${m.name}:latest`
                                    : `${m.name}:latest`;
                                html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);overflow:hidden" id="k8s-svc-card-${i}">
                                    <label style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.6rem;cursor:pointer;font-size:0.82rem"
                                        onmouseover="this.parentElement.style.borderColor='var(--accent)'" onmouseout="this.parentElement.style.borderColor='var(--border-subtle)'">
                                        <input type="checkbox" id="k8s-svc-chk-${i}" ${i === 0 ? 'checked' : ''} style="accent-color:var(--accent)"
                                            onchange="document.getElementById('k8s-svc-cfg-${i}').style.display=this.checked?'block':'none'">
                                        <span style="font-size:1rem" id="k8s-svc-icon-${i}">üöÄ</span>
                                        <strong>${esc(m.name)}</strong>
                                        <code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">${esc(m.stack || '?')}</code>
                                        <span style="flex:1;color:var(--text-muted);font-size:0.72rem">${esc(m.path || '')}</span>
                                        <select id="k8s-svc-kind-${i}" class="modal-form-select"
                                            style="font-size:0.68rem;padding:0.1rem 0.3rem;min-width:110px;color:var(--success);font-weight:600;border-color:transparent;background:transparent"
                                            onclick="event.stopPropagation()" onmousedown="event.stopPropagation()"
                                            onchange="var ic=document.getElementById('k8s-svc-icon-'+${i});if(ic)ic.textContent={'Deployment':'üöÄ','StatefulSet':'üóÑÔ∏è','DaemonSet':'üåê','Job':'‚ö°','CronJob':'‚è∞','Skip':'‚è≠Ô∏è'}[this.value]||'üì¶';window._k8sToggleKindPanels(${i},this.value)">
                                            <option value="Deployment" selected>Deployment</option>
                                            <option value="StatefulSet">StatefulSet</option>
                                            <option value="DaemonSet">DaemonSet</option>
                                            <option value="Job">Job</option>
                                            <option value="CronJob">CronJob</option>
                                            <option value="Skip">Skip</option>
                                        </select>
                                    </label>
                                    <div id="k8s-svc-cfg-${i}" style="padding:0 0.6rem 0.5rem;display:${i === 0 ? 'block' : 'none'}">
                                        <div style="display:grid;grid-template-columns:3fr 1fr 1fr 1fr;gap:0.4rem;align-items:start">
                                            <div>${_lbl('Container Image')}${_inp(`k8s-svc-img-${i}`, imgStr, 'ghcr.io/user/app:latest')}</div>
                                            <div>${_lbl('Port')}${_num(`k8s-svc-port-${i}`, 8080)}</div>
                                            <div>${_lbl('Replicas')}${_num(`k8s-svc-replicas-${i}`, 2)}</div>
                                            <div>${_lbl('Service Type')}${_sel(`k8s-svc-type-${i}`, [
                                                {v:'ClusterIP', l:'ClusterIP'},
                                                {v:'NodePort', l:'NodePort'},
                                                {v:'LoadBalancer', l:'LoadBalancer'}
                                            ], 'ClusterIP')}</div>
                                        </div>

                                        <!-- ‚îÄ‚îÄ‚îÄ Companion Containers ‚îÄ‚îÄ‚îÄ -->
                                        <div id="k8s-svc-companions-${i}" style="display:none;margin-top:0.35rem;padding:0.4rem;background:color-mix(in srgb, var(--accent) 4%, transparent);border-radius:6px;border:1px dashed var(--border-subtle)">
                                            <div style="font-size:0.74rem;color:var(--accent);font-weight:600;margin-bottom:0.2rem">üì¶ Companion Containers (same pod)</div>
                                            <div id="k8s-svc-companion-list-${i}" style="display:flex;flex-direction:column;gap:0.2rem"></div>
                                        </div>

                                        <!-- ‚îÄ‚îÄ‚îÄ Move into pod action ‚îÄ‚îÄ‚îÄ -->
                                        <div style="margin-top:0.25rem;text-align:right">
                                            <select id="k8s-svc-moveto-${i}" class="modal-form-select"
                                                style="font-size:0.76rem;padding:0.2rem 0.4rem;min-width:180px;color:var(--accent);border-color:var(--border-subtle)"
                                                onchange="if(this.value){window._k8sMoveIntoPod(${i},parseInt(this.value));this.value=''}"
                                            >
                                                <option value="">‚§µ Move into another pod‚Ä¶</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>`;
                            }
                            html += `</div>`;

                        } else {
                            // No compose, no modules ‚Äî single manual app config
                            html += wizSection('Deployment Configuration', 'Configure your application for Kubernetes.');
                            html += `<div style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);padding:0.6rem">
                                <div style="display:grid;grid-template-columns:1fr 3fr;gap:0.4rem;align-items:start">
                                    <div>${_lbl('App Name')}${_inp('k8s-svc-name-manual', appName, 'my-app')}</div>
                                    <div>${_lbl('Container Image')}${_inp('k8s-svc-img-manual', `${appName}:latest`, 'ghcr.io/user/app:latest')}</div>
                                </div>
                                <div style="display:grid;grid-template-columns:1fr 1fr 2fr;gap:0.4rem;margin-top:0.3rem;align-items:start">
                                    <div>${_lbl('Port')}${_num('k8s-svc-port-manual', 8080)}</div>
                                    <div>${_lbl('Replicas')}${_num('k8s-svc-replicas-manual', 2)}</div>
                                    <div>${_lbl('Service Type')}${_sel('k8s-svc-type-manual', [
                                        {v:'ClusterIP', l:'ClusterIP (internal)'},
                                        {v:'NodePort', l:'NodePort (node access)'},
                                        {v:'LoadBalancer', l:'LoadBalancer (external)'}
                                    ], 'ClusterIP')}</div>
                                </div>
                            </div>`;
                        }

                        // ‚îÄ‚îÄ Infra card HTML generator ‚îÄ‚îÄ
                        // Generates a complete infra service card from a service data object.
                        // Used by both initial render and dynamic add.
                        // Defined before Section B so it's available during html string construction.
                        window._k8sInfraCardHtml = (svc, savedInfra) => {
                            const svcName = svc.name;
                            const infraId = 'infra-' + svcName;
                            const imgShort = (svc.image || '').split('/').pop().split(':')[0] || svcName;
                            const portStr = (svc.ports || []).map(p => ':' + p.container).join(' ');
                            const volCount = (svc.volumes || []).length;
                            const infraEnvKeys = Object.keys(svc.environment || {});
                            const infraEnvVals = svc.environment || {};
                            const eName = esc(svcName);
                            // Saved kind overrides detection default
                            const infraKindDefault = savedInfra?.kind || _classifyWorkloadKind(svc);
                            const infraKindHintText = _kindHint(infraKindDefault, svc);

                            let h = '<div data-infra-name="' + eName + '" style="border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);padding:0.5rem 0.6rem">'
                                + '<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;margin-bottom:0.3rem">'
                                + '<span style="font-size:1rem" id="k8s-infra-icon-' + eName + '">' + _kindIcon(infraKindDefault) + '</span>'
                                + '<strong>' + eName + '</strong>'
                                + '<code style="font-size:0.72rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px;color:var(--text-secondary)">' + esc(imgShort) + '</code>'
                                + (portStr ? '<code style="font-size:0.68rem;color:var(--text-muted)">' + esc(portStr) + '</code>' : '')
                                + (volCount > 0 ? '<span style="font-size:0.66rem;color:var(--text-muted)" title="' + volCount + ' volumes">üíæ' + volCount + '</span>' : '')
                                + '<span style="flex:1"></span>'
                                + '<button type="button" onclick="window._k8sRemoveInfra(\'' + eName + '\')"'
                                + ' style="background:none;border:none;cursor:pointer;font-size:0.88rem;color:var(--text-muted);padding:0 4px;line-height:1"'
                                + ' title="Remove ' + eName + '">‚úï</button>'
                                + '</div>'
                                + '<div style="display:flex;align-items:center;gap:0.4rem;font-size:0.74rem;margin-bottom:0.15rem">'
                                + '<select id="k8s-infra-kind-' + eName + '" class="modal-form-select"'
                                + ' style="font-size:0.68rem;padding:0.1rem 0.3rem;min-width:130px;color:var(--success);font-weight:600"'
                                + ' onchange="'
                                +   'var ic=document.getElementById(\'k8s-infra-icon-' + eName + '\');'
                                +   'var hn=document.getElementById(\'k8s-infra-kind-hint-' + eName + '\');'
                                +   'var cfg=document.getElementById(\'k8s-infra-cfg-' + eName + '\');'
                                +   'var sb=document.getElementById(\'k8s-infra-skip-banner-' + eName + '\');'
                                +   'var mi=document.getElementById(\'k8s-infra-managed-info-' + eName + '\');'
                                +   'var el=document.getElementById(\'k8s-infra-envlabel-' + eName + '\');'
                                +   'var vs=document.getElementById(\'k8s-infra-vol-section-' + eName + '\');'
                                +   'var kv=this.value;'
                                +   'if(ic)ic.textContent=({"Deployment":"üöÄ","StatefulSet":"üóÑÔ∏è","DaemonSet":"üåê","Managed":"‚òÅÔ∏è","Skip":"‚è≠Ô∏è"})[kv]||"üì¶";'
                                +   'if(hn)hn.textContent=\'\';'
                                +   'if(cfg)cfg.style.display=(kv===\'Skip\'?\'none\':\'block\');'
                                +   'if(sb)sb.style.display=(kv===\'Skip\'?\'block\':\'none\');'
                                +   'if(mi)mi.style.display=(kv===\'Managed\'?\'block\':\'none\');'
                                +   'if(vs)vs.style.display=(kv===\'Managed\'||kv===\'Skip\'?\'none\':\'block\');'
                                +   'if(el)el.textContent=(kv===\'Managed\'?\'Connection Environment Variables\':\'Environment Variables\');'
                                +   'if(kv!==\'Skip\')window._k8sInfraEnvTrigger(\'' + eName + '\');'
                                + '">'
                                + '<option value="StatefulSet"' + (infraKindDefault === 'StatefulSet' ? ' selected' : '') + '>StatefulSet</option>'
                                + '<option value="Deployment"' + (infraKindDefault === 'Deployment' ? ' selected' : '') + '>Deployment</option>'
                                + '<option value="DaemonSet"' + (infraKindDefault === 'DaemonSet' ? ' selected' : '') + '>DaemonSet</option>'
                                + '<option value="Managed"' + (infraKindDefault === 'Managed' ? ' selected' : '') + '>Managed (external)</option>'
                                + '<option value="Skip"' + (infraKindDefault === 'Skip' ? ' selected' : '') + '>Skip (exclude)</option>'
                                + '</select>'
                                + '<span id="k8s-infra-kind-hint-' + eName + '" style="font-size:0.6rem;color:var(--text-muted);font-style:italic">' + (infraKindHintText || '') + '</span>'
                                + '</div>';

                            // Infra config panel (env vars) ‚Äî shown when kind is NOT Skip
                            const infraCfgDisplay = infraKindDefault === 'Skip' ? 'none' : 'block';
                            const isInfraManaged = infraKindDefault === 'Managed';

                            // Skip banner for infra services
                            h += '<div id="k8s-infra-skip-banner-' + eName + '" style="display:' + (infraKindDefault === 'Skip' ? 'block' : 'none') + ';padding:0.6rem;margin-top:0.35rem;background:var(--bg-primary);border-radius:6px;border:1px dashed var(--border-subtle);text-align:center">'
                                + '<div style="font-size:0.9rem;margin-bottom:0.15rem">‚è≠Ô∏è</div>'
                                + '<div style="font-size:0.72rem;color:var(--text-muted);font-weight:600">Excluded</div>'
                                + '<div style="font-size:0.66rem;color:var(--text-muted);font-style:italic">This service will not be deployed to Kubernetes.</div>'
                                + '</div>';

                            h += '<div id="k8s-infra-cfg-' + eName + '" style="display:' + infraCfgDisplay + ';margin-top:0.35rem;padding:0.4rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">';

                            // Managed-specific info banner + provider notes
                            h += '<div id="k8s-infra-managed-info-' + eName + '" style="display:' + (isInfraManaged ? 'block' : 'none') + ';margin-bottom:0.4rem">'
                                + '<div style="padding:0.35rem 0.5rem;background:var(--bg-inset);border-radius:4px;border-left:3px solid var(--accent);margin-bottom:0.3rem">'
                                + '<div style="font-size:0.72rem;color:var(--accent)">‚ÑπÔ∏è This service will be managed <strong>outside</strong> Kubernetes.</div>'
                                + '<div style="font-size:0.64rem;color:var(--text-muted)">No K8s resources will be generated. Connection vars below will be injected into dependent services as Secrets.</div>'
                                + '</div>'
                                + '<div style="display:flex;align-items:center;gap:0.3rem;margin-bottom:0.2rem">'
                                + '<span style="font-size:0.68rem;color:var(--text-muted);font-weight:600">Provider / Notes</span>'
                                + '</div>'
                                + '<input type="text" id="k8s-infra-provider-' + eName + '" class="modal-form-input"'
                                + ' style="font-size:0.72rem;padding:0.2rem 0.4rem;width:100%"'
                                + ' placeholder="e.g. AWS RDS PostgreSQL, GCP Cloud SQL, etc.">'
                                + '</div>';

                            h += '<div style="font-size:0.72rem;color:var(--accent);font-weight:600;margin-bottom:0.25rem">‚ñ∏ '
                                + '<span id="k8s-infra-envlabel-' + eName + '">' + (isInfraManaged ? 'Connection Environment Variables' : 'Environment Variables') + '</span>'
                                + '</div>';
                            if (infraEnvKeys.length > 0) {
                                h += '<div style="display:grid;grid-template-columns:2fr 2fr 1.5fr 1.2fr auto;gap:0.25rem;margin-bottom:0.2rem;padding:0 0.25rem">'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Key</span>'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Value</span>'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Var / Secret</span>'
                                    + '<span style="font-size:0.78rem;color:var(--text-muted);font-weight:600">Injection</span>'
                                    + '<span></span>'
                                    + '</div>';
                            }
                            h += '<div id="k8s-svc-env-list-' + infraId + '" style="display:flex;flex-direction:column;gap:0.2rem">';
                            if (savedInfra?.envVars) {
                                savedInfra.envVars.forEach((ev, j) => {
                                    h += _envRowHtml(infraId, j, ev.key, ev.value || '', ev.type || 'hardcoded', ev.varName || '', infraId);
                                });
                            } else {
                                Object.entries(infraEnvVals).forEach(([k, v], j) => {
                                    const injType = _isSecretKey(k) ? 'secret' : 'variable';
                                    h += _envRowHtml(infraId, j, k, v || '', injType, '${' + k + '}', infraId);
                                });
                            }
                            h += '</div>';
                            h += '<button type="button" onclick="_addEnvVar(\'' + infraId + '\')"'
                                + ' style="margin-top:0.3rem;font-size:0.66rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.2rem 0.5rem;cursor:pointer;width:100%">'
                                + '+ Add variable'
                                + '</button>';

                            // ‚îÄ‚îÄ Persistent Storage section (hidden for Managed) ‚îÄ‚îÄ
                            const infraVols = svc.volumes || [];
                            // Use saved volumes when available for infra
                            const classifiedVols = savedInfra?.volumes
                                ? savedInfra.volumes.map(vol => window._savedVolToClassification(vol))
                                : infraVols.map(v => window._classifyVolume(v)).filter(cl => cl.classification === 'named' || cl.classification === 'data-bind');
                            const showVolSec = infraKindDefault !== 'Managed' ? 'block' : 'none';

                            h += '<div id="k8s-infra-vol-section-' + eName + '" style="display:' + showVolSec + ';margin-top:0.5rem;padding-top:0.4rem;border-top:1px solid var(--border-subtle)">';
                            h += '<details' + (classifiedVols.length > 0 ? ' open' : '') + '>';
                            h += '<summary style="cursor:pointer;font-size:0.72rem;color:var(--accent);font-weight:600;user-select:none;display:flex;align-items:center;gap:0.3rem">'
                                + '‚ñ∏ Persistent Storage'
                                + (classifiedVols.length > 0 ? ' <span style="font-size:0.6rem;background:var(--bg-secondary);color:var(--text-secondary);padding:1px 5px;border-radius:3px">' + classifiedVols.length + ' from Compose</span>' : '')
                                + '<span id="k8s-svc-vol-summary-' + infraId + '" style="margin-left:auto;font-size:0.6rem;color:var(--text-muted);font-weight:400"></span>'
                                + '</summary>';
                            h += '<div style="margin-top:0.25rem;padding:0.3rem;background:var(--bg-primary);border-radius:6px;border:1px solid var(--border-subtle)">';
                            h += '<div id="k8s-svc-vol-list-' + infraId + '" style="display:flex;flex-direction:column;gap:0.3rem">';
                            if (classifiedVols.length > 0) {
                                classifiedVols.forEach((cl, j) => {
                                    h += window._volRowHtml(infraId, j, cl);
                                });
                            } else {
                                h += '<div style="font-size:0.68rem;color:var(--text-muted);font-style:italic">No named volumes detected ‚Äî click "+ Add volume" below</div>';
                            }
                            h += '</div>';
                            h += '<button type="button" onclick="window._addVolRow(\'' + infraId + '\')"'
                                + ' style="margin-top:0.3rem;font-size:0.66rem;color:var(--accent);background:none;border:1px dashed var(--border-subtle);border-radius:4px;padding:0.2rem 0.5rem;cursor:pointer;width:100%">'
                                + '+ Add volume'
                                + '</button>';
                            h += '</div>';
                            h += '</details>';
                            h += '</div>';

                            h += '</div>'; // close cfg panel
                            h += '</div>'; // close outer card
                            return h;
                        };

                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        // ‚îÄ‚îÄ Section B: Infrastructure Services ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                        html += wizSection('Infrastructure Services',
                            infraSvcs.length > 0
                                ? `${infraSvcs.length} infrastructure service${infraSvcs.length !== 1 ? 's' : ''} detected. Choose how to handle each in K8s.`
                                : 'No infrastructure services detected from Docker. Add services below if needed.');

                        html += `<div style="display:flex;flex-direction:column;gap:0.4rem" id="k8s-infra-list">`;
                        for (let i = 0; i < infraSvcs.length; i++) {
                            html += window._k8sInfraCardHtml(infraSvcs[i], _savedInfra(infraSvcs[i].name));
                        }
                        html += `</div>`;
                        html += `<div style="margin-top:0.4rem;display:flex;gap:0.4rem;align-items:center">`;
                        html += `<select id="k8s-infra-add-select" class="modal-form-select"
                            style="font-size:0.74rem;padding:0.3rem 0.5rem;flex:1;max-width:320px"
                            onchange="if(this.value)window._k8sAddInfra(this.value);this.value=''">
                            <option value="">+ Add infrastructure service‚Ä¶</option>
                        </select>`;
                        html += `</div>`;

                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                        // ‚îÄ‚îÄ Section C: Cluster Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                        html += wizSection('Cluster Settings', 'Common settings for all K8s resources.');
                        html += wizFormGrid([
                            { name: 'k8s-namespace', label: 'Namespace', value: _savedState?.namespace || data.namespace || defaultNamespace, hint: 'Target K8s namespace for all resources' },
                            { name: 'k8s-output-dir', label: 'Output Directory', value: _savedState?.output_dir || 'k8s/', hint: 'Where manifest files will be written' },
                        ]);
                        html += wizFormGrid([
                            { name: 'k8s-ingress', label: 'Generate Ingress manifest', type: 'checkbox', value: _savedState?.ingress ?? false, fullWidth: true },
                            // ConfigMap checkbox removed ‚Äî ConfigMaps/Secrets auto-generated per service from envVars
                        ]);

                        // ‚îÄ‚îÄ Skaffold pipeline toggle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        html += `
                        <div id="k8s-skaffold-panel" style="margin-top:0.6rem;padding:0.7rem 0.8rem;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset)">
                            <div style="display:flex;align-items:flex-start;gap:0.5rem">
                                <input type="checkbox" id="k8s-skaffold-toggle"${(_savedState?.skaffold ?? true) ? ' checked' : ''}
                                       style="margin-top:3px;accent-color:var(--accent);cursor:pointer">
                                <div style="flex:1">
                                    <label for="k8s-skaffold-toggle" style="font-weight:600;font-size:0.82rem;cursor:pointer;display:block;margin-bottom:2px">
                                        üõ§ Generate Skaffold pipeline (<code>skaffold.yaml</code>)
                                    </label>
                                    <div style="font-size:0.72rem;color:var(--text-muted);line-height:1.45">
                                        <a href="https://skaffold.dev" target="_blank" rel="noopener" style="color:var(--accent);text-decoration:none">Skaffold</a>
                                        is a command-line tool by Google that automates the <strong>build ‚Üí push ‚Üí deploy</strong> workflow
                                        for Kubernetes applications. It watches your source code, rebuilds container images on change,
                                        and redeploys to your cluster automatically ‚Äî giving you a <strong>live-reload dev loop</strong>
                                        similar to hot-module replacement but for containers.<br>
                                        The generated <code>skaffold.yaml</code> ties your Dockerfiles and K8s manifests together
                                        so you can run <code>skaffold dev</code> for development or <code>skaffold run</code> for one-shot deploys.
                                    </div>
                                </div>
                            </div>
                            <div id="k8s-skaffold-status" style="margin-top:0.5rem;font-size:0.74rem">
                                <span class="spinner" style="width:12px;height:12px;display:inline-block;vertical-align:middle"></span>
                                <span style="color:var(--text-muted);margin-left:4px">Checking Skaffold CLI‚Ä¶</span>
                            </div>
                        </div>`;

                        // Store source list sizes for collect()
                        data._appSvcCount = hasCompose ? appSvcs.length : deployableModules.length;
                        data._infraSvcCount = infraSvcs.length;
                        data._configMode = hasCompose ? 'compose' : (deployableModules.length > 0 ? 'modules' : 'manual');

                        el.innerHTML = html;

                        // ‚îÄ‚îÄ Service name map for cross-row awareness ‚îÄ‚îÄ
                        window._k8sSvcNames = {};
                        if (hasCompose) {
                            appSvcs.forEach((s, idx) => { window._k8sSvcNames[String(idx)] = s.name; });
                        } else {
                            deployableModules.forEach((m, idx) => { window._k8sSvcNames[String(idx)] = m.name; });
                        }
                        infraSvcs.forEach(s => { window._k8sSvcNames['infra-' + s.name] = s.name; });

                        // ‚îÄ‚îÄ Track active/removed infra for add/remove ‚îÄ‚îÄ
                        window._k8sActiveInfra = new Set(infraSvcs.map(s => s.name));
                        // Map removed service name ‚Üí service data (for re-adding)
                        window._k8sRemovedInfra = new Map();
                        // Original compose data for detected services (for re-adding)
                        window._k8sInfraData = new Map();
                        infraSvcs.forEach(s => { window._k8sInfraData.set(s.name, s); });

                        // ‚îÄ‚îÄ Companion container tracking (pod grouping) ‚îÄ‚îÄ
                        // Map: targetIndex ‚Üí [{sourceIndex, svcName, image, port}]
                        window._k8sCompanions = new Map();

                        // Populate "Move into pod" dropdown options for each app card
                        window._k8sRefreshMoveToDropdowns = () => {
                            const svcCount = hasCompose ? appSvcs.length : deployableModules.length;
                            for (let si = 0; si < svcCount; si++) {
                                const sel = document.getElementById('k8s-svc-moveto-' + si);
                                if (!sel) continue;
                                // Is this card hidden (already moved into another pod)?
                                const card = document.getElementById('k8s-svc-card-' + si);
                                if (card && card.style.display === 'none') continue;
                                // Rebuild options
                                sel.innerHTML = '<option value="">‚§µ Move into another pod‚Ä¶</option>';
                                for (let ti = 0; ti < svcCount; ti++) {
                                    if (ti === si) continue;
                                    const tCard = document.getElementById('k8s-svc-card-' + ti);
                                    if (!tCard || tCard.style.display === 'none') continue;
                                    const tName = window._k8sSvcNames[String(ti)] || ('service-' + ti);
                                    sel.innerHTML += '<option value="' + ti + '">‚Üí ' + esc(tName) + '</option>';
                                }
                            }
                        };

                        // Move service sourceIdx INTO targetIdx pod as a companion container
                        window._k8sMoveIntoPod = (sourceIdx, targetIdx) => {
                            const srcCard = document.getElementById('k8s-svc-card-' + sourceIdx);
                            if (!srcCard) return;

                            const svcName = window._k8sSvcNames[String(sourceIdx)] || ('service-' + sourceIdx);
                            const image = (document.getElementById('k8s-svc-img-' + sourceIdx) || {}).value || '';
                            const port = (document.getElementById('k8s-svc-port-' + sourceIdx) || {}).value || '';

                            // Extract full state BEFORE hiding the card
                            const envVars = window._collectEnvVars(sourceIdx);
                            const resources = window._k8sReadSourceResources(sourceIdx);
                            const volumes = window._k8sReadSourceVolumes(sourceIdx);

                            const companion = {
                                sourceIndex: sourceIdx,
                                svcName: svcName,
                                image: image,
                                port: port,
                                envVars: envVars,
                                resources: resources,
                                volumes: volumes,
                            };

                            // Track the companion
                            if (!window._k8sCompanions.has(targetIdx)) {
                                window._k8sCompanions.set(targetIdx, []);
                            }
                            window._k8sCompanions.get(targetIdx).push(companion);

                            // Hide the source card
                            srcCard.style.display = 'none';

                            // Show companion section in target and add rich row
                            const compSec = document.getElementById('k8s-svc-companions-' + targetIdx);
                            if (compSec) compSec.style.display = 'block';

                            const compList = document.getElementById('k8s-svc-companion-list-' + targetIdx);
                            if (compList) {
                                const wrapper = document.createElement('div');
                                wrapper.innerHTML = window._k8sCompanionRowHtml(targetIdx, companion);
                                compList.appendChild(wrapper.firstElementChild);
                            }

                            // Register companion in svcNames for collision detection messages
                            window._k8sSvcNames['comp-' + targetIdx + '-' + sourceIdx] = svcName + ' (companion)';

                            // Refresh all "Move into" dropdowns
                            window._k8sRefreshMoveToDropdowns();

                            // Re-evaluate env collisions (companion's env vars now visible)
                            window._wizValidation.recheck('k8s');
                        };

                        // Split a companion back to its own workload card
                        window._k8sSplitBack = (sourceIdx, targetIdx) => {
                            const compEnvId = 'comp-' + targetIdx + '-' + sourceIdx;

                            // ‚îÄ‚îÄ Capture companion state BEFORE removing its DOM ‚îÄ‚îÄ
                            const compEnvVars = window._collectEnvVars(compEnvId);
                            const compImage = (document.getElementById('k8s-comp-img-' + targetIdx + '-' + sourceIdx) || {}).value || '';
                            const compPort = (document.getElementById('k8s-comp-port-' + targetIdx + '-' + sourceIdx) || {}).value || '';
                            const compCpuReq = (document.getElementById('k8s-comp-cpureq-' + targetIdx + '-' + sourceIdx) || {}).value || '';
                            const compCpuLim = (document.getElementById('k8s-comp-cpulim-' + targetIdx + '-' + sourceIdx) || {}).value || '';
                            const compMemReq = (document.getElementById('k8s-comp-memreq-' + targetIdx + '-' + sourceIdx) || {}).value || '';
                            const compMemLim = (document.getElementById('k8s-comp-memlim-' + targetIdx + '-' + sourceIdx) || {}).value || '';

                            // ‚îÄ‚îÄ Re-show the source card ‚îÄ‚îÄ
                            const srcCard = document.getElementById('k8s-svc-card-' + sourceIdx);
                            if (srcCard) srcCard.style.display = '';

                            // ‚îÄ‚îÄ Write captured state back to source card ‚îÄ‚îÄ
                            // Image & port
                            const imgEl = document.getElementById('k8s-svc-img-' + sourceIdx);
                            if (imgEl && compImage) imgEl.value = compImage;
                            const portEl = document.getElementById('k8s-svc-port-' + sourceIdx);
                            if (portEl && compPort) portEl.value = compPort;

                            // Resources
                            const cpuReqEl = document.getElementById('k8s-svc-cpu-req-' + sourceIdx);
                            if (cpuReqEl) cpuReqEl.value = compCpuReq;
                            const cpuLimEl = document.getElementById('k8s-svc-cpu-lim-' + sourceIdx);
                            if (cpuLimEl) cpuLimEl.value = compCpuLim;
                            const memReqEl = document.getElementById('k8s-svc-mem-req-' + sourceIdx);
                            if (memReqEl) memReqEl.value = compMemReq;
                            const memLimEl = document.getElementById('k8s-svc-mem-lim-' + sourceIdx);
                            if (memLimEl) memLimEl.value = compMemLim;

                            // Env vars: clear source list and re-render with companion's current state
                            const srcEnvList = document.getElementById('k8s-svc-env-list-' + sourceIdx);
                            if (srcEnvList && compEnvVars.length > 0) {
                                srcEnvList.innerHTML = '';
                                compEnvVars.forEach((ev, j) => {
                                    const injType = ev.type || 'hardcoded';
                                    const varN = ev.varName || (injType !== 'hardcoded' ? '${' + ev.key + '}' : '');
                                    const wrapper = document.createElement('div');
                                    wrapper.innerHTML = _envRowHtml(sourceIdx, j, ev.key, ev.value || '', injType, varN, sourceIdx);
                                    srcEnvList.appendChild(wrapper.firstElementChild);
                                });
                                if (typeof _updateEnvSummary === 'function') _updateEnvSummary(sourceIdx);
                            }

                            // ‚îÄ‚îÄ Remove from tracking ‚îÄ‚îÄ
                            const companions = window._k8sCompanions.get(targetIdx) || [];
                            window._k8sCompanions.set(targetIdx,
                                companions.filter(c => c.sourceIndex !== sourceIdx));

                            // Remove the companion row
                            const row = document.getElementById('k8s-companion-row-' + sourceIdx);
                            if (row) row.remove();

                            // Hide companion section if empty
                            const remaining = window._k8sCompanions.get(targetIdx) || [];
                            if (remaining.length === 0) {
                                const compSec = document.getElementById('k8s-svc-companions-' + targetIdx);
                                if (compSec) compSec.style.display = 'none';
                            }

                            // Refresh all "Move into" dropdowns
                            delete (window._k8sSvcNames || {})['comp-' + targetIdx + '-' + sourceIdx];
                            window._k8sRefreshMoveToDropdowns();

                            // Re-evaluate env collisions (companion's env vars now removed/moved back)
                            window._wizValidation.recheck('k8s');
                        };

                        // Initial population of move-to dropdowns + kind panel sync (deferred to after DOM render)
                        setTimeout(() => {
                            window._k8sRefreshMoveToDropdowns();
                            // Sync kind panels for any service that defaults to a non-Deployment kind
                            const svcCount = hasCompose ? appSvcs.length : deployableModules.length;
                            for (let si = 0; si < svcCount; si++) {
                                const kindSel = document.getElementById('k8s-svc-kind-' + si);
                                if (kindSel && kindSel.value !== 'Deployment') {
                                    window._k8sToggleKindPanels(si, kindSel.value);
                                }
                            }

                            // ‚îÄ‚îÄ Saved state post-render restoration ‚îÄ‚îÄ
                            if (_savedState) {
                                const _set = (id, val) => { const el = document.getElementById(id); if (el && val !== undefined && val !== null) el.value = String(val); };
                                const _chk = (id, v) => { const el = document.getElementById(id); if (el) { el.checked = !!v; el.dispatchEvent(new Event('change', {bubbles: true})); } };

                                for (let si = 0; si < svcCount; si++) {
                                    const sName = hasCompose ? appSvcs[si]?.name : deployableModules[si]?.name;
                                    const sv = _savedSvc(sName);
                                    if (!sv) continue;

                                    // 1. Volume sub-fields (accessMode, storageClass, etc.)
                                    if (sv.volumes) {
                                        sv.volumes.forEach((vol, j) => {
                                            const cl = window._savedVolToClassification(vol);
                                            window._restoreVolFields(si, j, cl);
                                        });
                                    }

                                    // 2. Probes (saved as readinessProbe / livenessProbe)
                                    const _restoreProbe = (pfx, probe) => {
                                        if (!probe) {
                                            // Probe was explicitly disabled (null in saved state)
                                            _chk(pfx + '-enable', false);
                                            return;
                                        }
                                        _chk(pfx + '-enable', true);
                                        if (probe.type) _set(pfx + '-type', probe.type);
                                        if (probe.path) _set(pfx + '-path', probe.path);
                                        if (probe.port) _set(pfx + '-port', probe.port);
                                        if (probe.command) _set(pfx + '-cmd', probe.command);
                                        if (probe.initialDelaySeconds != null) _set(pfx + '-delay', probe.initialDelaySeconds);
                                        if (probe.periodSeconds != null) _set(pfx + '-period', probe.periodSeconds);
                                        if (probe.extra != null) _set(pfx + '-extra', probe.extra);
                                    };
                                    if ('readinessProbe' in sv) {
                                        _restoreProbe('k8s-svc-rdy-' + si, sv.readinessProbe);
                                    }
                                    if ('livenessProbe' in sv) {
                                        _restoreProbe('k8s-svc-liv-' + si, sv.livenessProbe);
                                    }

                                    // 3. Mesh
                                    if (sv.mesh) {
                                        const m = sv.mesh;
                                        _chk('k8s-svc-mesh-enable-' + si, true);
                                        _set('k8s-svc-mesh-provider-' + si, m.provider);
                                        _set('k8s-svc-mesh-cpureq-' + si, m.proxyCpuRequest);
                                        _set('k8s-svc-mesh-cpulim-' + si, m.proxyCpuLimit);
                                        _set('k8s-svc-mesh-memreq-' + si, m.proxyMemRequest);
                                        _set('k8s-svc-mesh-memlim-' + si, m.proxyMemLimit);
                                        _set('k8s-svc-mesh-exin-' + si, m.excludeInbound);
                                        _set('k8s-svc-mesh-exout-' + si, m.excludeOutbound);
                                        _set('k8s-svc-mesh-log-' + si, m.logLevel);
                                    }

                                    // 4. CronJob schedule
                                    if (sv.schedule) _set('k8s-svc-schedule-' + si, sv.schedule);

                                     // 5. Update volume summaries
                                    if (window._updateVolSummary) window._updateVolSummary(si);

                                    // 6. Init containers
                                    if (sv.initContainers && sv.initContainers.length > 0) {
                                        const initList = document.getElementById('k8s-svc-init-list-' + si);
                                        if (initList) {
                                            sv.initContainers.forEach((ic, j) => {
                                                const wrapper = document.createElement('div');
                                                wrapper.innerHTML = window._k8sInitRowHtml(si, j, ic.name, ic.image, ic.command);
                                                initList.appendChild(wrapper.firstElementChild);
                                            });
                                            window._k8sUpdateInitCount(si);
                                        }
                                    }

                                    // 7. Sidecars
                                    if (sv.sidecars && sv.sidecars.length > 0) {
                                        const scList = document.getElementById('k8s-svc-sc-list-' + si);
                                        if (scList) {
                                            sv.sidecars.forEach((sc, j) => {
                                                const wrapper = document.createElement('div');
                                                wrapper.innerHTML = window._k8sSidecarRowHtml(
                                                    si, j, sc.name, sc.image, sc.command,
                                                    sc.nativeSidecar, sc.sharedVolume, sc.sharedMount
                                                );
                                                scList.appendChild(wrapper.firstElementChild);
                                            });
                                            window._k8sUpdateScCount(si);
                                        }
                                    }

                                    // 8. Dependency checkboxes
                                    if (sv.dependencies && sv.dependencies.length > 0) {
                                        sv.dependencies.forEach(depName => {
                                            const depChk = document.querySelector(
                                                '.k8s-dep-' + si + '[value="' + depName + '"]'
                                            );
                                            if (depChk) depChk.checked = true;
                                        });
                                        // Refresh env selects to reflect restored dependencies
                                        if (window._refreshEnvSelects) window._refreshEnvSelects(si);
                                    }
                                }

                                // ‚îÄ‚îÄ Infra services post-render restoration ‚îÄ‚îÄ
                                if (_savedState?._infraDecisions) {
                                    for (const inf of _savedState._infraDecisions) {
                                        // Provider notes (for Managed decisions)
                                        if (inf.providerNotes) {
                                            _set('k8s-infra-provider-' + inf.name, inf.providerNotes);
                                        }
                                        // Volume sub-fields
                                        if (inf.volumes) {
                                            const infraId = 'infra-' + inf.name;
                                            inf.volumes.forEach((vol, j) => {
                                                const cl = window._savedVolToClassification(vol);
                                                window._restoreVolFields(infraId, j, cl);
                                            });
                                        }
                                    }
                                }
                            }
                        }, 0);

                        // ‚îÄ‚îÄ Kind-conditional panel toggle ‚îÄ‚îÄ
                        // Shows/hides sections based on the selected workload kind
                        window._k8sToggleKindPanels = (i, kind) => {
                            const isJob = kind === 'Job' || kind === 'CronJob';
                            const isCron = kind === 'CronJob';
                            const isDaemon = kind === 'DaemonSet';
                            const isStateful = kind === 'StatefulSet';
                            const isSkip = kind === 'Skip';

                            const hide = (id) => { const el = document.getElementById(id); if (el) el.style.display = 'none'; };
                            const show = (id, d) => { const el = document.getElementById(id); if (el) el.style.display = d || 'block'; };

                            // Skip: hide entire config panel, show skip banner
                            if (isSkip) {
                                hide('k8s-svc-cfg-' + i);
                                show('k8s-svc-skip-banner-' + i);
                                return;
                            } else {
                                show('k8s-svc-cfg-' + i);
                                hide('k8s-svc-skip-banner-' + i);
                            }

                            // Port ‚Äî hide for Job/CronJob, show for others
                            if (isJob) hide('k8s-svc-port-wrap-' + i);
                            else show('k8s-svc-port-wrap-' + i);

                            // Replicas ‚Äî hide for Job/CronJob and DaemonSet (StatefulSet keeps it)
                            if (isJob || isDaemon) hide('k8s-svc-replicas-wrap-' + i);
                            else show('k8s-svc-replicas-wrap-' + i);

                            // Service Type ‚Äî hide for Job/CronJob, DaemonSet, and StatefulSet (headless is mandatory)
                            if (isJob || isDaemon || isStateful) hide('k8s-svc-svctype-wrap-' + i);
                            else show('k8s-svc-svctype-wrap-' + i);

                            // Deploy sections (Deployment strategy) ‚Äî only for Deployment
                            if (isJob || isDaemon || isStateful) hide('k8s-svc-deploy-sections-' + i);
                            else show('k8s-svc-deploy-sections-' + i);

                            // Job sections ‚Äî show for Job/CronJob
                            if (isJob) show('k8s-svc-job-sections-' + i);
                            else hide('k8s-svc-job-sections-' + i);

                            // CronJob sections ‚Äî show only for CronJob
                            if (isCron) show('k8s-svc-cron-sections-' + i);
                            else hide('k8s-svc-cron-sections-' + i);

                            // DaemonSet sections ‚Äî show only for DaemonSet
                            if (isDaemon) show('k8s-svc-daemon-sections-' + i);
                            else hide('k8s-svc-daemon-sections-' + i);

                            // StatefulSet sections ‚Äî show only for StatefulSet
                            if (isStateful) show('k8s-svc-statefulset-sections-' + i);
                            else hide('k8s-svc-statefulset-sections-' + i);

                            // Health Checks ‚Äî hide for Job/CronJob, show for others
                            if (isJob) hide('k8s-svc-probes-wrap-' + i);
                            else show('k8s-svc-probes-wrap-' + i);

                            // Volumes (regular) ‚Äî hide for Job/CronJob and StatefulSet (VCTs replace them)
                            if (isJob || isStateful) hide('k8s-svc-vols-wrap-' + i);
                            else show('k8s-svc-vols-wrap-' + i);

                            // Dependencies ‚Äî hide for Job/CronJob, DaemonSet, and StatefulSet
                            if (isJob || isDaemon || isStateful) hide('k8s-svc-deps-wrap-' + i);
                            else show('k8s-svc-deps-wrap-' + i);

                            // Service Mesh warning ‚Äî show for Job/CronJob
                            if (isJob) show('k8s-svc-mesh-warn-' + i);
                            else hide('k8s-svc-mesh-warn-' + i);
                        };

                        // ‚îÄ‚îÄ Remove infra card ‚îÄ‚îÄ
                        window._k8sRemoveInfra = (name) => {
                            const list = document.getElementById('k8s-infra-list');
                            const card = list ? list.querySelector('[data-infra-name="' + name + '"]') : null;
                            if (!card) return;
                            // Store data before removing (compose-detected or catalog)
                            const svcData = window._k8sInfraData.get(name);
                            if (svcData) window._k8sRemovedInfra.set(name, svcData);
                            card.remove();
                            window._k8sActiveInfra.delete(name);
                            delete (window._k8sSvcNames || {})['infra-' + name];
                            window._k8sUpdateInfraAddSelect();
                            // Re-evaluate env collisions (infra env vars removed)
                            window._wizValidation.recheck('k8s');
                        };

                        // ‚îÄ‚îÄ Add infra card (from removed, catalog, or custom) ‚îÄ‚îÄ
                        window._k8sAddInfra = (name) => {
                            if (name === '__custom__') {
                                // Prompt for custom name
                                const customName = prompt('Service name (lowercase, no spaces):');
                                if (!customName || !customName.trim()) return;
                                const cName = customName.trim().toLowerCase().replace(/[^a-z0-9-]/g, '-');
                                if (window._k8sActiveInfra.has(cName)) return;
                                const customSvc = {
                                    name: cName,
                                    image: cName + ':latest',
                                    ports: [],
                                    volumes: [],
                                    environment: {},
                                };
                                window._k8sInfraData.set(cName, customSvc);
                                window._k8sDoAddInfra(customSvc);
                                return;
                            }
                            // Re-add removed service or add from catalog
                            let svcData = window._k8sRemovedInfra.get(name);
                            if (svcData) {
                                window._k8sRemovedInfra.delete(name);
                            } else if (_INFRA_CATALOG[name]) {
                                // Build service data from the Docker _infraOptions entry
                                const cat = _INFRA_CATALOG[name];
                                const env = {};
                                (cat.envFields || []).forEach(ef => { env[ef.key] = ef.default || ''; });
                                svcData = {
                                    name: cat.key,
                                    image: cat.images[0],
                                    ports: (cat.ports || []).map(p => ({ host: p.port, container: p.port, protocol: 'tcp' })),
                                    volumes: (cat.volumes || []).map(v => v.name + ':' + v.mount),
                                    environment: env,
                                };
                                window._k8sInfraData.set(name, svcData);
                            }
                            if (!svcData) return;
                            window._k8sDoAddInfra(svcData);
                        };

                        // ‚îÄ‚îÄ Internal: append card + update tracking ‚îÄ‚îÄ
                        window._k8sDoAddInfra = (svc) => {
                            const list = document.getElementById('k8s-infra-list');
                            if (!list) return;
                            const wrapper = document.createElement('div');
                            wrapper.innerHTML = window._k8sInfraCardHtml(svc);
                            const card = wrapper.firstElementChild;
                            list.appendChild(card);
                            window._k8sActiveInfra.add(svc.name);
                            window._k8sSvcNames['infra-' + svc.name] = svc.name;
                            // Update env map for suggestion filtering
                            window._infraEnvMap = window._infraEnvMap || {};
                            window._infraEnvMap[svc.name] = Object.keys(svc.environment || {});
                            window._k8sUpdateInfraAddSelect();
                            // Re-evaluate env collisions (new infra env vars added)
                            window._wizValidation.recheck('k8s');
                        };

                        // ‚îÄ‚îÄ Rebuild the Add select options ‚îÄ‚îÄ
                        window._k8sUpdateInfraAddSelect = () => {
                            const sel = document.getElementById('k8s-infra-add-select');
                            if (!sel) return;
                            let html = '<option value="">+ Add infrastructure service‚Ä¶</option>';
                            // Group 1: Previously removed (re-add)
                            const removedNames = Array.from(window._k8sRemovedInfra.keys());
                            if (removedNames.length > 0) {
                                html += '<optgroup label="‚Ü© Removed (re-add)">';
                                removedNames.forEach(n => {
                                    const label = (_INFRA_CATALOG[n] && _INFRA_CATALOG[n].label) || n;
                                    html += '<option value="' + esc(n) + '">‚Ü© ' + esc(label) + '</option>';
                                });
                                html += '</optgroup>';
                            }
                            // Group 2: Catalog grouped by category ‚Äî same as Docker
                            const catOrder = ['db-rel','db-nosql','cache','mq','search','proxy','monitor','log','storage','devops'];
                            catOrder.forEach(cat => {
                                const items = _infraOptions.filter(o => o.cat === cat && !window._k8sActiveInfra.has(o.key));
                                if (items.length === 0) return;
                                const catLabel = (_infraCategories && _infraCategories[cat]) || cat;
                                html += '<optgroup label="' + esc(catLabel) + '">';
                                items.forEach(o => {
                                    html += '<option value="' + esc(o.key) + '">' + esc(o.label) + ' ‚Äî ' + esc(o.images[0]) + '</option>';
                                });
                                html += '</optgroup>';
                            });
                            // Group 3: Custom
                            html += '<optgroup label="Other">';
                            html += '<option value="__custom__">‚úèÔ∏è Custom service‚Ä¶</option>';
                            html += '</optgroup>';
                            sel.innerHTML = html;
                        };
                        // Make _infraEnvMap available globally for dynamic adds
                        window._infraEnvMap = _infraEnvMap;

                        // Populate add-select on initial render
                        window._k8sUpdateInfraAddSelect();

                        // ‚îÄ‚îÄ Infra env trigger: re-evaluate cross-row when infra toggled on ‚îÄ‚îÄ
                        window._k8sInfraEnvTrigger = (infraName) => {
                            const infraId = 'infra-' + infraName;
                            const list = document.getElementById('k8s-svc-env-list-' + infraId);
                            if (!list) return;
                            // Re-evaluate infra env rows (skip hardcoded ‚Äî their var select is placeholder '--')
                            list.querySelectorAll('.k8s-env-row').forEach(row => {
                                const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                if (!keyEl) return;
                                const j = keyEl.id.split('-').pop();
                                const typeSel = document.getElementById('k8s-svc-env-type-' + infraId + '-' + j);
                                if (typeSel && typeSel.value === 'hardcoded') return;
                                const varSel = document.getElementById('k8s-svc-env-var-' + infraId + '-' + j);
                                if (varSel) window._onVarSelect(varSel);
                            });
                            // Also re-evaluate ALL app service env rows so they detect newly-visible infra rows
                            const svcCount = hasCompose ? appSvcs.length : deployableModules.length;
                            for (let si = 0; si < svcCount; si++) {
                                const appList = document.getElementById('k8s-svc-env-list-' + si);
                                if (!appList) continue;
                                appList.querySelectorAll('.k8s-env-row').forEach(row => {
                                    const keyEl = row.querySelector('[id^="k8s-svc-env-key-"]');
                                    if (!keyEl) return;
                                    const sj = keyEl.id.split('-').pop();
                                    const typeSel = document.getElementById('k8s-svc-env-type-' + si + '-' + sj);
                                    if (typeSel && typeSel.value === 'hardcoded') return;
                                    const varSel = document.getElementById('k8s-svc-env-var-' + si + '-' + sj);
                                    if (varSel) window._onVarSelect(varSel);
                                });
                            }
                            // Run symmetric collision check after re-evaluating all rows
                            window._wizValidation.recheck('k8s');
                        };

                        // ‚îÄ‚îÄ Post-render: attach live QoS class updaters ‚îÄ‚îÄ
                        // For each app service card, listen for input changes on resource fields
                        // and recalculate the QoS class indicator in real-time
                        const svcCount = hasCompose ? appSvcs.length : deployableModules.length;
                        for (let idx = 0; idx < svcCount; idx++) {
                            const ids = ['cpu-req', 'cpu-lim', 'mem-req', 'mem-lim'].map(f => `k8s-svc-${f}-${idx}`);
                            const els = ids.map(id => document.getElementById(id));
                            if (!els.some(Boolean)) continue;

                            const updateQoS = () => {
                                const cr = (els[0] && els[0].value.trim()) || '';
                                const cl = (els[1] && els[1].value.trim()) || '';
                                const mr = (els[2] && els[2].value.trim()) || '';
                                const ml = (els[3] && els[3].value.trim()) || '';
                                const hint = _qosHint(cr, cl, mr, ml);
                                // Update both the summary-bar QoS and the live QoS inside the panel
                                const qosSummary = document.getElementById(`k8s-svc-qos-${idx}`);
                                const qosLive = document.getElementById(`k8s-svc-qos-live-${idx}`);
                                if (qosSummary) qosSummary.innerHTML = hint;
                                if (qosLive) qosLive.innerHTML = hint;
                            };

                            els.forEach(el => { if (el) el.addEventListener('input', updateQoS); });
                        }

                        // ‚îÄ‚îÄ Initial env key collision check (covers compose/saved pre-populated env vars) ‚îÄ‚îÄ
                        window._wizValidation.recheck('k8s');

                        // ‚îÄ‚îÄ Skaffold detection + install flow ‚îÄ‚îÄ
                        (async () => {
                            const statusEl = document.getElementById('k8s-skaffold-status');
                            if (!statusEl) return;
                            try {
                                const res = await api('/k8s/skaffold/status');
                                if (res.available) {
                                    // CLI found ‚Äî show green status
                                    statusEl.innerHTML = '<span style="color:var(--success)">‚úÖ Skaffold CLI detected</span>'
                                        + (res.version ? ' <code style="font-size:0.68rem;background:var(--bg-primary);padding:1px 5px;border-radius:3px">' + esc(res.version) + '</code>' : '');
                                } else {
                                    // Not installed ‚Äî show warning + install button
                                    const btnId = 'k8s-skaffold-install-btn';
                                    const logId = 'k8s-skaffold-install-log';
                                    const pwId  = 'k8s-skaffold-install-pw';
                                    statusEl.innerHTML = `
                                        <div style="padding:0.5rem 0.6rem;border-radius:6px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.25);margin-top:0.3rem">
                                            <div style="font-size:0.76rem;color:var(--warning);font-weight:600;margin-bottom:0.3rem">
                                                ‚ö†Ô∏è Skaffold CLI not found
                                            </div>
                                            <div style="font-size:0.7rem;color:var(--text-muted);margin-bottom:0.5rem">
                                                You can still generate <code>skaffold.yaml</code>, but you'll need to install the CLI
                                                to run <code>skaffold dev</code> or <code>skaffold run</code>.
                                            </div>
                                            <div style="margin-bottom:0.4rem">
                                                <label style="font-size:0.72rem;font-weight:600;display:block;margin-bottom:3px">üîë Sudo password:</label>
                                                <input id="${pwId}" type="password" placeholder="Enter your sudo password"
                                                       style="width:100%;max-width:300px;padding:6px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--bg-primary);color:var(--text-primary);font-size:0.78rem;box-sizing:border-box"
                                                       onkeydown="if(event.key==='Enter'){document.getElementById('${btnId}').click()}" />
                                            </div>
                                            <button id="${btnId}" class="btn btn-sm" onclick="window._k8sInstallSkaffold()"
                                                    style="font-size:0.76rem;background:rgba(99,102,241,0.12);color:var(--accent);border:1px solid rgba(99,102,241,0.3);padding:6px 16px;cursor:pointer">
                                                ‚¨áÔ∏è Install Skaffold
                                            </button>
                                            <div id="${logId}" style="display:none;margin-top:0.4rem">
                                                <div style="font-size:0.68rem;font-weight:600;margin-bottom:3px">üìã Output:</div>
                                                <pre style="font-size:0.66rem;background:var(--bg-primary);padding:8px;border-radius:var(--radius-sm);max-height:150px;overflow:auto;white-space:pre-wrap;word-break:break-all"></pre>
                                            </div>
                                            <details style="margin-top:0.3rem">
                                                <summary style="cursor:pointer;font-size:0.68rem;color:var(--text-muted)">Or install manually:</summary>
                                                <pre style="font-size:0.68rem;background:var(--bg-primary);padding:6px;border-radius:var(--radius-sm);margin-top:3px;white-space:pre-wrap;word-break:break-all;cursor:text;user-select:all">curl -Lo /usr/local/bin/skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64 && sudo chmod +x /usr/local/bin/skaffold</pre>
                                            </details>
                                        </div>`;
                                    // Focus password field
                                    setTimeout(() => { const el = document.getElementById(pwId); if (el) el.focus(); }, 100);
                                }
                            } catch (e) {
                                statusEl.innerHTML = '<span style="color:var(--text-muted)">‚ö†Ô∏è Could not check Skaffold status</span>';
                            }
                        })();

                        // ‚îÄ‚îÄ StorageClass detection (bonus: merges into catalog) ‚îÄ‚îÄ
                        (async () => {
                            try {
                                const res = await api('/k8s/storageclasses');
                                if (!res.ok || !res.storage_classes) {
                                    // No cluster ‚Äî that's fine, catalog is always available
                                    return;
                                }
                                const classes = res.storage_classes;
                                const defClass = res.default_class || '';
                                // Mark detected classes in the catalog
                                classes.forEach(sc => {
                                    if (_SC_FLAT[sc.name]) {
                                        _SC_FLAT[sc.name]._detected = true;
                                    }
                                });
                                // Collect classes NOT in catalog (custom cluster classes)
                                const extras = classes.filter(sc => !_SC_FLAT[sc.name]);
                                // Build the enhanced option HTML once
                                let optHtml = '<option value="">(cluster default' + (defClass ? ' ‚Äî ' + esc(defClass) : '') + ')</option>';
                                _SC_CATALOG.forEach(g => {
                                    optHtml += '<optgroup label="' + esc(g.group) + '">';
                                    g.items.forEach(sc => {
                                        const det = sc._detected ? ' ‚úì detected' : '';
                                        const defTag = classes.find(c => c.name === sc.name && c.is_default) ? ' ‚òÖ default' : '';
                                        optHtml += '<option value="' + esc(sc.name) + '" title="' + esc(sc.provisioner) + '">' + esc(sc.name) + ' ‚Äî ' + esc(sc.hint) + det + defTag + '</option>';
                                    });
                                    optHtml += '</optgroup>';
                                });
                                if (extras.length > 0) {
                                    optHtml += '<optgroup label="Detected on cluster">';
                                    extras.forEach(sc => {
                                        const defTag = sc.is_default ? ' ‚òÖ default' : '';
                                        optHtml += '<option value="' + esc(sc.name) + '">' + esc(sc.name) + ' ‚Äî ' + esc(sc.provisioner) + ' ‚úì' + defTag + '</option>';
                                    });
                                    optHtml += '</optgroup>';
                                }
                                optHtml += '<optgroup label="Other"><option value="_custom">‚úèÔ∏è Custom (type name)‚Ä¶</option></optgroup>';
                                // Rebuild ALL per-volume SC selects
                                document.querySelectorAll('.k8s-vol-sc-select').forEach(sel => {
                                    const prev = sel.value;
                                    sel.innerHTML = optHtml;
                                    if (prev && prev !== '_custom') { sel.value = prev; }
                                    // Extract i,j from id: k8s-svc-vol-sc-{i}-{j}
                                    const parts = sel.id.split('-');
                                    const j = parts.pop();
                                    const si = parts.pop();
                                    window._k8sVolScChange(parseInt(si), parseInt(j));
                                });
                            } catch (e) {
                                // Cluster not connected ‚Äî catalog options are already loaded, nothing to do
                            }
                        })();

                        // ‚îÄ‚îÄ Post-render: initialize volume summaries ‚îÄ‚îÄ
                        for (let idx = 0; idx < svcCount; idx++) {
                            window._updateVolSummary(idx);
                        }
                        // ‚îÄ‚îÄ Skaffold install handler ‚îÄ‚îÄ
                        window._k8sInstallSkaffold = async () => {
                            const btn = document.getElementById('k8s-skaffold-install-btn');
                            const logBox = document.getElementById('k8s-skaffold-install-log');
                            const pwInput = document.getElementById('k8s-skaffold-install-pw');
                            if (!btn || !logBox) return;

                            const sudoPassword = pwInput ? pwInput.value : '';
                            if (!sudoPassword) {
                                if (pwInput) {
                                    pwInput.style.border = '1px solid var(--danger)';
                                    pwInput.focus();
                                    pwInput.placeholder = '‚ö†Ô∏è Password required';
                                }
                                return;
                            }

                            const logPre = logBox.querySelector('pre');
                            btn.disabled = true;
                            btn.innerHTML = '<span class="spinner" style="width:12px;height:12px"></span> Installing‚Ä¶';
                            logBox.style.display = 'block';
                            logPre.textContent = 'Downloading Skaffold binary‚Ä¶\n';
                            logPre.style.color = '';

                            try {
                                const result = await api('/audit/install-tool', {
                                    method: 'POST',
                                    body: JSON.stringify({ tool: 'skaffold', cli: 'skaffold', sudo_password: sudoPassword }),
                                });
                                if (result.ok) {
                                    btn.innerHTML = '‚úÖ Installed';
                                    btn.className = 'btn btn-sm btn-ghost';
                                    logPre.textContent += '\n' + (result.stdout || result.message || 'Done') + '\n\n‚úÖ ' + result.message;
                                    // Refresh detection status
                                    setTimeout(async () => {
                                        const statusEl = document.getElementById('k8s-skaffold-status');
                                        if (statusEl) {
                                            statusEl.innerHTML = '<span style="color:var(--success)">‚úÖ Skaffold CLI installed and ready</span>';
                                        }
                                    }, 500);
                                } else if (result.needs_sudo) {
                                    btn.innerHTML = '‚¨áÔ∏è Install Skaffold';
                                    btn.disabled = false;
                                    if (pwInput) { pwInput.value = ''; pwInput.focus(); pwInput.placeholder = '‚ö†Ô∏è ' + (result.error || 'Enter password'); }
                                    logPre.textContent += '\nüîë ' + (result.error || 'Sudo password required');
                                    logPre.style.color = 'var(--warning)';
                                } else {
                                    btn.innerHTML = '‚¨áÔ∏è Retry Install';
                                    btn.disabled = false;
                                    let logText = '‚ùå ' + (result.error || 'Unknown error') + '\n';
                                    if (result.stderr) logText += '\n' + result.stderr;
                                    if (result.stdout) logText += '\n' + result.stdout;
                                    logPre.textContent += logText;
                                    logPre.style.color = 'var(--danger)';
                                }
                            } catch (e) {
                                btn.innerHTML = '‚¨áÔ∏è Retry Install';
                                btn.disabled = false;
                                logPre.textContent += '\n‚ùå ' + e.message;
                                logPre.style.color = 'var(--danger)';
                            }
                        };
                    },
                    collect: (data) => {
                        const mode = data._configMode || 'manual';
                        const appCount = data._appSvcCount || 0;
                        const infraCount = data._infraSvcCount || 0;
                        const appSvcs = data._appServices || [];
                        const infraSvcs = data._infraServices || [];
                        const deployableModules = (data._classifiedModules || []).filter(m => m._class === 'deployable');

                        // ‚îÄ‚îÄ Collect application services ‚îÄ‚îÄ
                        const services = [];
                        // ‚îÄ‚îÄ Helper: read element value safely ‚îÄ‚îÄ
                        const _v = (id) => { const el = document.getElementById(id); return el ? el.value.trim() : ''; };

                        // ‚îÄ‚îÄ Helper: collect full companion data from rich companion row DOM ‚îÄ‚îÄ
                        const _collectCompanionData = (targetIdx) => {
                            return (window._k8sCompanions.get(targetIdx) || []).map(c => {
                                const t = targetIdx;
                                const s = c.sourceIndex;

                                // Read image/port from companion card (editable)
                                const image = _v('k8s-comp-img-' + t + '-' + s) || c.image || '';
                                const port = _v('k8s-comp-port-' + t + '-' + s) || c.port || '';

                                // Read env vars using shared system (same as main services)
                                const compEnvId = 'comp-' + t + '-' + s;
                                const envVars = window._collectEnvVars(compEnvId);

                                // Read resources from companion card
                                const cpuReq = _v('k8s-comp-cpureq-' + t + '-' + s);
                                const cpuLim = _v('k8s-comp-cpulim-' + t + '-' + s);
                                const memReq = _v('k8s-comp-memreq-' + t + '-' + s);
                                const memLim = _v('k8s-comp-memlim-' + t + '-' + s);
                                const hasRes = cpuReq || cpuLim || memReq || memLim;

                                // Read volumes from companion card
                                const volumes = [];
                                const volList = document.getElementById('k8s-comp-vol-list-' + t + '-' + s);
                                if (volList) {
                                    volList.querySelectorAll('.k8s-comp-vol-row').forEach(row => {
                                        const nameEl = row.querySelector('[id^="k8s-comp-vol-name-"]');
                                        if (!nameEl) return;
                                        const parts = nameEl.id.split('-');
                                        const j = parts[parts.length - 1];
                                        const volName = _v('k8s-comp-vol-name-' + t + '-' + s + '-' + j);
                                        const mountPath = _v('k8s-comp-vol-mount-' + t + '-' + s + '-' + j);
                                        const volType = _v('k8s-comp-vol-type-' + t + '-' + s + '-' + j) || 'emptyDir';
                                        if (mountPath) volumes.push({ name: volName, type: volType, mountPath });
                                    });
                                }
                                // Read checked host volumes (live-refreshed section)
                                const hostVolContainer = document.getElementById('k8s-comp-hostvols-' + t + '-' + s);
                                if (hostVolContainer) {
                                    hostVolContainer.querySelectorAll('.k8s-comp-hostvol-row').forEach(row => {
                                        const chk = row.querySelector('input[type="checkbox"]');
                                        if (!chk || !chk.checked) return;
                                        const mountEl = row.querySelector('input[id$="-mount"]');
                                        const nameEl = row.querySelector('input[id$="-name"]');
                                        const typeEl = row.querySelector('input[id$="-type"]');
                                        const mountPath = mountEl ? mountEl.value.trim() : '';
                                        const volName = nameEl ? nameEl.value.trim() : '';
                                        const volType = typeEl ? typeEl.value.trim() : 'emptyDir';
                                        if (mountPath) volumes.push({ name: volName, type: volType, mountPath });
                                    });
                                }

                                // Read startup dependency (value may be 'name:port' for infra)
                                const depRaw = _v('k8s-comp-dep-' + t + '-' + s) || '';
                                let dependsOn = null;
                                let dependsOnPort = null;
                                if (depRaw) {
                                    if (depRaw === '__main__') {
                                        dependsOn = '__main__';
                                    } else if (depRaw.includes(':')) {
                                        const [dName, dPort] = depRaw.split(':');
                                        dependsOn = dName;
                                        dependsOnPort = dPort;
                                    } else {
                                        dependsOn = depRaw;
                                    }
                                }

                                return {
                                    name: c.svcName,
                                    image,
                                    port,
                                    env: envVars,
                                    resources: hasRes ? {
                                        cpu_request: cpuReq || null,
                                        cpu_limit: cpuLim || null,
                                        memory_request: memReq || null,
                                        memory_limit: memLim || null,
                                    } : null,
                                    volumes,
                                    dependsOn,
                                    dependsOnPort,
                                };
                            });
                        };

                        if (mode === 'compose') {
                            for (let i = 0; i < appCount; i++) {
                                const chk = document.getElementById(`k8s-svc-chk-${i}`);
                                if (!chk || !chk.checked) continue;
                                // Skip services moved into another pod as companions
                                const srcCard = document.getElementById(`k8s-svc-card-${i}`);
                                if (srcCard && srcCard.style.display === 'none') continue;

                                // Resource limits ‚Äî only include non-empty values
                                const cpuReq = _v(`k8s-svc-cpu-req-${i}`);
                                const cpuLim = _v(`k8s-svc-cpu-lim-${i}`);
                                const memReq = _v(`k8s-svc-mem-req-${i}`);
                                const memLim = _v(`k8s-svc-mem-lim-${i}`);
                                const hasResources = cpuReq || cpuLim || memReq || memLim;

                                // Strategy
                                const strategy = _v(`k8s-svc-strategy-${i}`) || 'RollingUpdate';

                                // Probe collection helper
                                const _collectProbe = (prefix) => {
                                    const enableEl = document.getElementById(`${prefix}-enable`);
                                    if (!enableEl || !enableEl.checked) return null;
                                    const probeType = _v(`${prefix}-type`) || 'http';
                                    const probe = {
                                        type: probeType,
                                        initialDelaySeconds: parseInt(_v(`${prefix}-delay`)) || 0,
                                        periodSeconds: parseInt(_v(`${prefix}-period`)) || 10,
                                    };
                                    if (probeType === 'http') {
                                        probe.path = _v(`${prefix}-path`) || '/health';
                                        probe.port = parseInt(_v(`${prefix}-port`)) || 8080;
                                    } else if (probeType === 'tcp') {
                                        probe.port = parseInt(_v(`${prefix}-port`)) || 8080;
                                    } else {
                                        probe.command = _v(`${prefix}-cmd`) || '';
                                    }
                                    probe.extra = parseInt(_v(`${prefix}-extra`)) || 3;
                                    return probe;
                                };

                                const selectedKind = _v(`k8s-svc-kind-${i}`) || 'Deployment';
                                if (selectedKind === 'Skip') continue;
                                const isJobKind = selectedKind === 'Job' || selectedKind === 'CronJob';

                                const svcObj = {
                                    name: appSvcs[i].name,
                                    kind: selectedKind,
                                    image: _v(`k8s-svc-img-${i}`) || `${appSvcs[i].name}:latest`,
                                    envVars: window._collectEnvVars(i),
                                    resources: hasResources ? {
                                        cpu_request: cpuReq || null,
                                        cpu_limit: cpuLim || null,
                                        memory_request: memReq || null,
                                        memory_limit: memLim || null,
                                    } : null,
                                    _compose: appSvcs[i],
                                    companions: _collectCompanionData(i),
                                    dependencies: (() => {
                                        const deps = [];
                                        document.querySelectorAll('.k8s-dep-' + i + ':checked')
                                            .forEach(el => deps.push(el.value));
                                        return deps;
                                    })(),
                                };

                                if (isJobKind) {
                                    // Job-specific fields
                                    svcObj.command = _v(`k8s-svc-job-cmd-${i}`) || '';
                                    svcObj.args = _v(`k8s-svc-job-args-${i}`) || '';
                                    svcObj.restartPolicy = _v(`k8s-svc-job-restart-${i}`) || 'Never';
                                    svcObj.backoffLimit = parseInt(_v(`k8s-svc-job-backoff-${i}`)) || 3;
                                    svcObj.completions = parseInt(_v(`k8s-svc-job-completions-${i}`)) || 1;
                                    svcObj.parallelism = parseInt(_v(`k8s-svc-job-parallelism-${i}`)) || 1;
                                    const timeout = _v(`k8s-svc-job-timeout-${i}`);
                                    if (timeout) svcObj.activeDeadlineSeconds = parseInt(timeout);
                                    svcObj.ttlSecondsAfterFinished = parseInt(_v(`k8s-svc-job-ttl-${i}`)) || 3600;

                                    if (selectedKind === 'CronJob') {
                                        svcObj.schedule = _v(`k8s-svc-cron-schedule-${i}`) || '*/5 * * * *';
                                        svcObj.concurrencyPolicy = _v(`k8s-svc-cron-concurrency-${i}`) || 'Forbid';
                                        const suspendEl = document.getElementById(`k8s-svc-cron-suspend-${i}`);
                                        svcObj.suspend = suspendEl ? suspendEl.checked : false;
                                        svcObj.successfulJobsHistoryLimit = parseInt(_v(`k8s-svc-cron-success-${i}`)) || 3;
                                        svcObj.failedJobsHistoryLimit = parseInt(_v(`k8s-svc-cron-failed-${i}`)) || 1;
                                        const deadline = _v(`k8s-svc-cron-deadline-${i}`);
                                        if (deadline) svcObj.startingDeadlineSeconds = parseInt(deadline);
                                    }
                                } else if (selectedKind === 'DaemonSet') {
                                    // DaemonSet-specific fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '';
                                    const dsStrategy = _v(`k8s-svc-ds-strategy-${i}`) || 'RollingUpdate';
                                    svcObj.strategy = dsStrategy;
                                    svcObj.maxUnavailable = dsStrategy === 'RollingUpdate' ? (_v(`k8s-svc-ds-maxunavail-${i}`) || '1') : null;
                                    svcObj.nodeSelector = _v(`k8s-svc-ds-nodeselector-${i}`) || '';
                                    // Tolerations
                                    const tols = [];
                                    const tolCpEl = document.getElementById(`k8s-svc-ds-tol-cp-${i}`);
                                    if (tolCpEl && tolCpEl.checked) tols.push({ key: 'node-role.kubernetes.io/control-plane', effect: 'NoSchedule', operator: 'Exists' });
                                    const tolNsEl = document.getElementById(`k8s-svc-ds-tol-nosched-${i}`);
                                    if (tolNsEl && tolNsEl.checked) tols.push({ key: '', operator: 'Exists', effect: 'NoSchedule' });
                                    svcObj.tolerations = tols;
                                    // Host access
                                    const hnEl = document.getElementById(`k8s-svc-ds-hostnet-${i}`);
                                    svcObj.hostNetwork = hnEl ? hnEl.checked : false;
                                    const hpEl = document.getElementById(`k8s-svc-ds-hostpid-${i}`);
                                    svcObj.hostPID = hpEl ? hpEl.checked : false;
                                    const hiEl = document.getElementById(`k8s-svc-ds-hostipc-${i}`);
                                    svcObj.hostIPC = hiEl ? hiEl.checked : false;
                                    // Health checks + volumes (shared with Deployment)
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    svcObj.volumes = window._collectVolumes(i);
                                } else if (selectedKind === 'StatefulSet') {
                                    // StatefulSet-specific fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '8080';
                                    svcObj.replicas = _v(`k8s-svc-replicas-${i}`) || '1';
                                    svcObj.headlessServiceName = _v(`k8s-svc-ss-headless-${i}`) || `${appSvcs[i].name}-headless`;
                                    svcObj.podManagementPolicy = _v(`k8s-svc-ss-podmgmt-${i}`) || 'OrderedReady';
                                    const ssClusterIpEl = document.getElementById(`k8s-svc-ss-clusterip-${i}`);
                                    svcObj.alsoCreateClusterIP = ssClusterIpEl ? ssClusterIpEl.checked : false;
                                    const ssStrategy = _v(`k8s-svc-ss-strategy-${i}`) || 'RollingUpdate';
                                    svcObj.strategy = ssStrategy;
                                    svcObj.partition = ssStrategy === 'RollingUpdate' ? (parseInt(_v(`k8s-svc-ss-partition-${i}`)) || 0) : null;
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    // Collect volumeClaimTemplates
                                    svcObj.volumeClaimTemplates = (() => {
                                        const vcts = [];
                                        const vctList = document.getElementById('k8s-svc-vct-list-' + i);
                                        if (!vctList) return vcts;
                                        vctList.querySelectorAll('.k8s-vct-row').forEach(row => {
                                            const chk = row.querySelector('[id^="k8s-svc-vct-chk-"]');
                                            if (!chk || !chk.checked) return;
                                            const ps = chk.id.split('-');
                                            const j = ps[ps.length - 1];
                                            const name = _v('k8s-svc-vct-name-' + i + '-' + j);
                                            const mountPath = _v('k8s-svc-vct-mount-' + i + '-' + j);
                                            if (!mountPath) return;
                                            vcts.push({
                                                name: name || 'data-' + j,
                                                mountPath,
                                                size: _v('k8s-svc-vct-size-' + i + '-' + j) || '10Gi',
                                                accessMode: _v('k8s-svc-vct-access-' + i + '-' + j) || 'ReadWriteOnce',
                                                storageClass: _v('k8s-svc-vct-sc-' + i + '-' + j) || '',
                                            });
                                        });
                                        return vcts;
                                    })();
                                } else {
                                    // Deployment fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '8080';
                                    svcObj.replicas = _v(`k8s-svc-replicas-${i}`) || '2';
                                    svcObj.serviceType = _v(`k8s-svc-type-${i}`) || 'ClusterIP';
                                    svcObj.strategy = strategy;
                                    svcObj.maxSurge = strategy === 'RollingUpdate' ? (_v(`k8s-svc-maxsurge-${i}`) || '1') : null;
                                    svcObj.maxUnavailable = strategy === 'RollingUpdate' ? (_v(`k8s-svc-maxunavail-${i}`) || '1') : null;
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    svcObj.volumes = window._collectVolumes(i);
                                }

                                // Collect init containers (shared across all non-Skip/Managed kinds)
                                svcObj.initContainers = (() => {
                                    const inits = [];
                                    const initList = document.getElementById('k8s-svc-init-list-' + i);
                                    if (!initList) return inits;
                                    initList.querySelectorAll('.k8s-init-row').forEach(row => {
                                        const j = row.dataset.j;
                                        const name = _v('k8s-svc-init-name-' + i + '-' + j);
                                        const image = _v('k8s-svc-init-img-' + i + '-' + j);
                                        const command = _v('k8s-svc-init-cmd-' + i + '-' + j);
                                        if (!name && !image) return;
                                        inits.push({ name: name || 'init-' + j, image: image || 'busybox:1.36', command: command || '' });
                                    });
                                    return inits;
                                })();

                                // Collect sidecar containers
                                svcObj.sidecars = (() => {
                                    const scs = [];
                                    const scList = document.getElementById('k8s-svc-sc-list-' + i);
                                    if (!scList) return scs;
                                    scList.querySelectorAll('.k8s-sc-row').forEach(row => {
                                        const j = row.dataset.j;
                                        const name = _v('k8s-svc-sc-name-' + i + '-' + j);
                                        const image = _v('k8s-svc-sc-img-' + i + '-' + j);
                                        const command = _v('k8s-svc-sc-cmd-' + i + '-' + j);
                                        if (!name && !image) return;
                                        const nativeEl = document.getElementById('k8s-svc-sc-native-' + i + '-' + j);
                                        const sc = {
                                            name: name || 'sidecar-' + j,
                                            image: image || '',
                                            command: command || '',
                                            nativeSidecar: nativeEl ? nativeEl.checked : true,
                                        };
                                        const sharedVol = _v('k8s-svc-sc-shvol-' + i + '-' + j);
                                        if (sharedVol) {
                                            sc.sharedVolume = sharedVol;
                                            sc.sharedMount = _v('k8s-svc-sc-shmount-' + i + '-' + j) || '/shared';
                                        }
                                        scs.push(sc);
                                    });
                                    return scs;
                                })();

                                // Collect service mesh config
                                const meshEl = document.getElementById('k8s-svc-mesh-enable-' + i);
                                if (meshEl && meshEl.checked) {
                                    const provSel = document.getElementById('k8s-svc-mesh-provider-' + i);
                                    svcObj.mesh = {
                                        provider: provSel ? provSel.value : 'istio',
                                        proxyCpuRequest: _v('k8s-svc-mesh-cpureq-' + i) || '100m',
                                        proxyCpuLimit: _v('k8s-svc-mesh-cpulim-' + i) || '500m',
                                        proxyMemRequest: _v('k8s-svc-mesh-memreq-' + i) || '128Mi',
                                        proxyMemLimit: _v('k8s-svc-mesh-memlim-' + i) || '256Mi',
                                        excludeInbound: _v('k8s-svc-mesh-exin-' + i) || '',
                                        excludeOutbound: _v('k8s-svc-mesh-exout-' + i) || '',
                                        logLevel: _v('k8s-svc-mesh-log-' + i) || 'warning',
                                    };
                                }

                                services.push(svcObj);
                            }
                        } else if (mode === 'modules') {
                            for (let i = 0; i < appCount; i++) {
                                const chk = document.getElementById(`k8s-svc-chk-${i}`);
                                if (!chk || !chk.checked) continue;
                                // Skip services moved into another pod as companions
                                const srcCard = document.getElementById(`k8s-svc-card-${i}`);
                                if (srcCard && srcCard.style.display === 'none') continue;

                                // Resource limits ‚Äî only include non-empty values
                                const cpuReq = _v(`k8s-svc-cpu-req-${i}`);
                                const cpuLim = _v(`k8s-svc-cpu-lim-${i}`);
                                const memReq = _v(`k8s-svc-mem-req-${i}`);
                                const memLim = _v(`k8s-svc-mem-lim-${i}`);
                                const hasResources = cpuReq || cpuLim || memReq || memLim;

                                // Strategy
                                const strategy = _v(`k8s-svc-strategy-${i}`) || 'RollingUpdate';

                                // Probe collection helper
                                const _collectProbe = (prefix) => {
                                    const enableEl = document.getElementById(`${prefix}-enable`);
                                    if (!enableEl || !enableEl.checked) return null;
                                    const probeType = _v(`${prefix}-type`) || 'http';
                                    const probe = {
                                        type: probeType,
                                        initialDelaySeconds: parseInt(_v(`${prefix}-delay`)) || 0,
                                        periodSeconds: parseInt(_v(`${prefix}-period`)) || 10,
                                    };
                                    if (probeType === 'http') {
                                        probe.path = _v(`${prefix}-path`) || '/health';
                                        probe.port = parseInt(_v(`${prefix}-port`)) || 8080;
                                    } else if (probeType === 'tcp') {
                                        probe.port = parseInt(_v(`${prefix}-port`)) || 8080;
                                    } else {
                                        probe.command = _v(`${prefix}-cmd`) || '';
                                    }
                                    probe.extra = parseInt(_v(`${prefix}-extra`)) || 3;
                                    return probe;
                                };

                                const selectedKind = _v(`k8s-svc-kind-${i}`) || 'Deployment';
                                if (selectedKind === 'Skip') continue;
                                const isJobKind = selectedKind === 'Job' || selectedKind === 'CronJob';

                                const svcObj = {
                                    name: deployableModules[i].name,
                                    kind: selectedKind,
                                    image: _v(`k8s-svc-img-${i}`) || `${deployableModules[i].name}:latest`,
                                    envVars: window._collectEnvVars(i),
                                    resources: hasResources ? {
                                        cpu_request: cpuReq || null,
                                        cpu_limit: cpuLim || null,
                                        memory_request: memReq || null,
                                        memory_limit: memLim || null,
                                    } : null,
                                    companions: _collectCompanionData(i),
                                    dependencies: (() => {
                                        const deps = [];
                                        document.querySelectorAll('.k8s-dep-' + i + ':checked')
                                            .forEach(el => deps.push(el.value));
                                        return deps;
                                    })(),
                                };

                                if (isJobKind) {
                                    // Job-specific fields
                                    svcObj.command = _v(`k8s-svc-job-cmd-${i}`) || '';
                                    svcObj.args = _v(`k8s-svc-job-args-${i}`) || '';
                                    svcObj.restartPolicy = _v(`k8s-svc-job-restart-${i}`) || 'Never';
                                    svcObj.backoffLimit = parseInt(_v(`k8s-svc-job-backoff-${i}`)) || 3;
                                    svcObj.completions = parseInt(_v(`k8s-svc-job-completions-${i}`)) || 1;
                                    svcObj.parallelism = parseInt(_v(`k8s-svc-job-parallelism-${i}`)) || 1;
                                    const timeout = _v(`k8s-svc-job-timeout-${i}`);
                                    if (timeout) svcObj.activeDeadlineSeconds = parseInt(timeout);
                                    svcObj.ttlSecondsAfterFinished = parseInt(_v(`k8s-svc-job-ttl-${i}`)) || 3600;

                                    if (selectedKind === 'CronJob') {
                                        svcObj.schedule = _v(`k8s-svc-cron-schedule-${i}`) || '*/5 * * * *';
                                        svcObj.concurrencyPolicy = _v(`k8s-svc-cron-concurrency-${i}`) || 'Forbid';
                                        const suspendEl = document.getElementById(`k8s-svc-cron-suspend-${i}`);
                                        svcObj.suspend = suspendEl ? suspendEl.checked : false;
                                        svcObj.successfulJobsHistoryLimit = parseInt(_v(`k8s-svc-cron-success-${i}`)) || 3;
                                        svcObj.failedJobsHistoryLimit = parseInt(_v(`k8s-svc-cron-failed-${i}`)) || 1;
                                        const deadline = _v(`k8s-svc-cron-deadline-${i}`);
                                        if (deadline) svcObj.startingDeadlineSeconds = parseInt(deadline);
                                    }
                                } else if (selectedKind === 'DaemonSet') {
                                    // DaemonSet-specific fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '';
                                    const dsStrategy = _v(`k8s-svc-ds-strategy-${i}`) || 'RollingUpdate';
                                    svcObj.strategy = dsStrategy;
                                    svcObj.maxUnavailable = dsStrategy === 'RollingUpdate' ? (_v(`k8s-svc-ds-maxunavail-${i}`) || '1') : null;
                                    svcObj.nodeSelector = _v(`k8s-svc-ds-nodeselector-${i}`) || '';
                                    // Tolerations
                                    const tols = [];
                                    const tolCpEl = document.getElementById(`k8s-svc-ds-tol-cp-${i}`);
                                    if (tolCpEl && tolCpEl.checked) tols.push({ key: 'node-role.kubernetes.io/control-plane', effect: 'NoSchedule', operator: 'Exists' });
                                    const tolNsEl = document.getElementById(`k8s-svc-ds-tol-nosched-${i}`);
                                    if (tolNsEl && tolNsEl.checked) tols.push({ key: '', operator: 'Exists', effect: 'NoSchedule' });
                                    svcObj.tolerations = tols;
                                    // Host access
                                    const hnEl = document.getElementById(`k8s-svc-ds-hostnet-${i}`);
                                    svcObj.hostNetwork = hnEl ? hnEl.checked : false;
                                    const hpEl = document.getElementById(`k8s-svc-ds-hostpid-${i}`);
                                    svcObj.hostPID = hpEl ? hpEl.checked : false;
                                    const hiEl = document.getElementById(`k8s-svc-ds-hostipc-${i}`);
                                    svcObj.hostIPC = hiEl ? hiEl.checked : false;
                                    // Health checks + volumes (shared with Deployment)
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    svcObj.volumes = window._collectVolumes(i);
                                } else if (selectedKind === 'StatefulSet') {
                                    // StatefulSet-specific fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '8080';
                                    svcObj.replicas = _v(`k8s-svc-replicas-${i}`) || '1';
                                    svcObj.headlessServiceName = _v(`k8s-svc-ss-headless-${i}`) || `${deployableModules[i].name}-headless`;
                                    svcObj.podManagementPolicy = _v(`k8s-svc-ss-podmgmt-${i}`) || 'OrderedReady';
                                    const ssClusterIpEl = document.getElementById(`k8s-svc-ss-clusterip-${i}`);
                                    svcObj.alsoCreateClusterIP = ssClusterIpEl ? ssClusterIpEl.checked : false;
                                    const ssStrategy = _v(`k8s-svc-ss-strategy-${i}`) || 'RollingUpdate';
                                    svcObj.strategy = ssStrategy;
                                    svcObj.partition = ssStrategy === 'RollingUpdate' ? (parseInt(_v(`k8s-svc-ss-partition-${i}`)) || 0) : null;
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    // Collect volumeClaimTemplates
                                    svcObj.volumeClaimTemplates = (() => {
                                        const vcts = [];
                                        const vctList = document.getElementById('k8s-svc-vct-list-' + i);
                                        if (!vctList) return vcts;
                                        vctList.querySelectorAll('.k8s-vct-row').forEach(row => {
                                            const chk = row.querySelector('[id^="k8s-svc-vct-chk-"]');
                                            if (!chk || !chk.checked) return;
                                            const ps = chk.id.split('-');
                                            const j = ps[ps.length - 1];
                                            const name = _v('k8s-svc-vct-name-' + i + '-' + j);
                                            const mountPath = _v('k8s-svc-vct-mount-' + i + '-' + j);
                                            if (!mountPath) return;
                                            vcts.push({
                                                name: name || 'data-' + j,
                                                mountPath,
                                                size: _v('k8s-svc-vct-size-' + i + '-' + j) || '10Gi',
                                                accessMode: _v('k8s-svc-vct-access-' + i + '-' + j) || 'ReadWriteOnce',
                                                storageClass: _v('k8s-svc-vct-sc-' + i + '-' + j) || '',
                                            });
                                        });
                                        return vcts;
                                    })();
                                } else {
                                    // Deployment fields
                                    svcObj.port = _v(`k8s-svc-port-${i}`) || '8080';
                                    svcObj.replicas = _v(`k8s-svc-replicas-${i}`) || '2';
                                    svcObj.serviceType = _v(`k8s-svc-type-${i}`) || 'ClusterIP';
                                    svcObj.strategy = strategy;
                                    svcObj.maxSurge = strategy === 'RollingUpdate' ? (_v(`k8s-svc-maxsurge-${i}`) || '1') : null;
                                    svcObj.maxUnavailable = strategy === 'RollingUpdate' ? (_v(`k8s-svc-maxunavail-${i}`) || '1') : null;
                                    svcObj.readinessProbe = _collectProbe(`k8s-svc-rdy-${i}`);
                                    svcObj.livenessProbe = _collectProbe(`k8s-svc-liv-${i}`);
                                    svcObj.volumes = window._collectVolumes(i);
                                }

                                // Collect init containers (shared across all non-Skip/Managed kinds)
                                svcObj.initContainers = (() => {
                                    const inits = [];
                                    const initList = document.getElementById('k8s-svc-init-list-' + i);
                                    if (!initList) return inits;
                                    initList.querySelectorAll('.k8s-init-row').forEach(row => {
                                        const j = row.dataset.j;
                                        const name = _v('k8s-svc-init-name-' + i + '-' + j);
                                        const image = _v('k8s-svc-init-img-' + i + '-' + j);
                                        const command = _v('k8s-svc-init-cmd-' + i + '-' + j);
                                        if (!name && !image) return;
                                        inits.push({ name: name || 'init-' + j, image: image || 'busybox:1.36', command: command || '' });
                                    });
                                    return inits;
                                })();

                                // Collect sidecar containers
                                svcObj.sidecars = (() => {
                                    const scs = [];
                                    const scList = document.getElementById('k8s-svc-sc-list-' + i);
                                    if (!scList) return scs;
                                    scList.querySelectorAll('.k8s-sc-row').forEach(row => {
                                        const j = row.dataset.j;
                                        const name = _v('k8s-svc-sc-name-' + i + '-' + j);
                                        const image = _v('k8s-svc-sc-img-' + i + '-' + j);
                                        const command = _v('k8s-svc-sc-cmd-' + i + '-' + j);
                                        if (!name && !image) return;
                                        const nativeEl = document.getElementById('k8s-svc-sc-native-' + i + '-' + j);
                                        const sc = {
                                            name: name || 'sidecar-' + j,
                                            image: image || '',
                                            command: command || '',
                                            nativeSidecar: nativeEl ? nativeEl.checked : true,
                                        };
                                        const sharedVol = _v('k8s-svc-sc-shvol-' + i + '-' + j);
                                        if (sharedVol) {
                                            sc.sharedVolume = sharedVol;
                                            sc.sharedMount = _v('k8s-svc-sc-shmount-' + i + '-' + j) || '/shared';
                                        }
                                        scs.push(sc);
                                    });
                                    return scs;
                                })();

                                // Collect service mesh config
                                const meshEl = document.getElementById('k8s-svc-mesh-enable-' + i);
                                if (meshEl && meshEl.checked) {
                                    const provSel = document.getElementById('k8s-svc-mesh-provider-' + i);
                                    svcObj.mesh = {
                                        provider: provSel ? provSel.value : 'istio',
                                        proxyCpuRequest: _v('k8s-svc-mesh-cpureq-' + i) || '100m',
                                        proxyCpuLimit: _v('k8s-svc-mesh-cpulim-' + i) || '500m',
                                        proxyMemRequest: _v('k8s-svc-mesh-memreq-' + i) || '128Mi',
                                        proxyMemLimit: _v('k8s-svc-mesh-memlim-' + i) || '256Mi',
                                        excludeInbound: _v('k8s-svc-mesh-exin-' + i) || '',
                                        excludeOutbound: _v('k8s-svc-mesh-exout-' + i) || '',
                                        logLevel: _v('k8s-svc-mesh-log-' + i) || 'warning',
                                    };
                                }

                                services.push(svcObj);
                            }
                        } else {
                            // Manual
                            services.push({
                                name: _v('k8s-svc-name-manual') || 'app',
                                kind: 'Deployment',
                                image: _v('k8s-svc-img-manual') || 'app:latest',
                                port: _v('k8s-svc-port-manual') || '8080',
                                replicas: _v('k8s-svc-replicas-manual') || '2',
                                serviceType: _v('k8s-svc-type-manual') || 'ClusterIP',
                            });
                        }

                        // ‚îÄ‚îÄ Collect infrastructure services (dynamic ‚Äî iterate DOM cards) ‚îÄ‚îÄ
                        const infraDecisions = [];
                        const infraListEl = document.getElementById('k8s-infra-list');
                        if (infraListEl) {
                            infraListEl.querySelectorAll('[data-infra-name]').forEach(card => {
                                const svcName = card.dataset.infraName;
                                const kindSel = document.getElementById('k8s-infra-kind-' + svcName);
                                const decision = kindSel ? kindSel.value : 'Skip';
                                if (decision === 'Skip') return;
                                const infraId = 'infra-' + svcName;
                                const svcData = (window._k8sInfraData || new Map()).get(svcName) || {};
                                const infraObj = {
                                    name: svcName,
                                    kind: decision,
                                    image: svcData.image || svcName,
                                    port: svcData.ports && svcData.ports.length > 0 ? String(svcData.ports[0].container) : '',
                                    envVars: window._collectEnvVars(infraId),
                                    _compose: svcData,
                                };
                                if (decision !== 'Managed') {
                                    infraObj.volumes = window._collectVolumes(infraId);
                                }
                                if (decision === 'Managed') {
                                    infraObj.providerNotes = _v('k8s-infra-provider-' + svcName) || '';
                                }
                                infraDecisions.push(infraObj);
                            });
                        }

                        // ‚îÄ‚îÄ Store full multi-service config ‚îÄ‚îÄ
                        data._services = services;
                        data._infraDecisions = infraDecisions;

                        // ‚îÄ‚îÄ Cluster settings ‚îÄ‚îÄ
                        data.namespace = mfVal('k8s-namespace') || 'default';
                        data.output_dir = mfVal('k8s-output-dir') || 'k8s/';
                        data.ingress = mfVal('k8s-ingress');
                        const skaffoldChk = document.getElementById('k8s-skaffold-toggle');
                        data.skaffold = skaffoldChk ? skaffoldChk.checked : true;
                        // data.configmap removed ‚Äî ConfigMaps auto-generated per service from envVars

                        // ‚îÄ‚îÄ Backward compat: flat fields from primary service ‚îÄ‚îÄ
                        if (services.length > 0) {
                            data.app_name = services[0].name;
                            data.image = services[0].image;
                            data.port = services[0].port;
                            data.replicas = services[0].replicas;
                            data.service_type = services[0].serviceType;
                        }

                        // ‚îÄ‚îÄ Persist wizard state (fire-and-forget) ‚îÄ‚îÄ
                        try {
                            const stateToSave = {
                                _services: data._services,
                                _infraDecisions: data._infraDecisions,
                                namespace: data.namespace,
                                output_dir: data.output_dir,
                                ingress: data.ingress,
                                skaffold: data.skaffold,
                            };
                            api('/k8s/wizard-state', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(stateToSave),
                            }).catch(() => {}); // silent ‚Äî saving is best-effort
                        } catch (_) {}
                    },
                    validate: (data) => {
                        if (!data._services || data._services.length === 0) return 'At least one service must be selected';
                        for (const svc of data._services) {
                            if (!svc.image) return `Container image is required for ${svc.name}`;
                            // Kind-aware validation
                            if (svc.kind === 'CronJob' && !svc.schedule) {
                                return `Schedule is required for CronJob ${svc.name}`;
                            }
                            // Validate resource quantity formats
                            if (svc.resources) {
                                const r = svc.resources;
                                const qtyRx = /^\d+(\.\d+)?(m|Mi|Gi|Ki|Ti|M|G|K|T)?$/;
                                if (r.cpu_request && !qtyRx.test(r.cpu_request)) return `Invalid CPU request format for ${svc.name} ‚Äî use e.g. 100m, 0.5, 1`;
                                if (r.cpu_limit && !qtyRx.test(r.cpu_limit)) return `Invalid CPU limit format for ${svc.name} ‚Äî use e.g. 500m, 1, 2`;
                                if (r.memory_request && !qtyRx.test(r.memory_request)) return `Invalid memory request format for ${svc.name} ‚Äî use e.g. 128Mi, 1Gi`;
                                if (r.memory_limit && !qtyRx.test(r.memory_limit)) return `Invalid memory limit format for ${svc.name} ‚Äî use e.g. 256Mi, 1Gi`;
                            }
                        }
                        return null;
                    },
                },

                // ‚îÄ‚îÄ Step 3: Review & Apply ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'review', title: 'Review & Apply',
                    render: (data, el) => {
                        const services = data._services || [];
                        const infraDecisions = data._infraDecisions || [];

                        // Build review items from all services
                        const items = [];

                        for (const svc of services) {
                            const isJobKind = svc.kind === 'Job' || svc.kind === 'CronJob';

                            if (isJobKind) {
                                // Job/CronJob review
                                const jobInfo = svc.command ? `cmd: ${svc.command}${svc.args ? ' ' + svc.args : ''}` : svc.image;
                                const cronStr = svc.kind === 'CronJob' ? ` ¬∑ schedule: ${svc.schedule || '?'}` : '';
                                items.push({
                                    icon: _kindIcon(svc.kind),
                                    label: `${svc.kind}: ${svc.name}`,
                                    value: `${jobInfo}${cronStr}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                                // Job details sub-items
                                const jobDetails = [];
                                if (svc.backoffLimit) jobDetails.push(`backoff: ${svc.backoffLimit}`);
                                if (svc.completions > 1) jobDetails.push(`completions: ${svc.completions}`);
                                if (svc.parallelism > 1) jobDetails.push(`parallelism: ${svc.parallelism}`);
                                if (svc.activeDeadlineSeconds) jobDetails.push(`timeout: ${svc.activeDeadlineSeconds}s`);
                                if (svc.ttlSecondsAfterFinished) jobDetails.push(`TTL: ${svc.ttlSecondsAfterFinished}s`);
                                if (jobDetails.length > 0) {
                                    items.push({
                                        icon: '‚öôÔ∏è',
                                        label: `  ‚îî job settings`,
                                        value: jobDetails.join(' ¬∑ '),
                                        badge: '',
                                        badgeCls: 'muted',
                                    });
                                }
                                if (svc.kind === 'CronJob') {
                                    const cronDetails = [];
                                    cronDetails.push(`concurrency: ${svc.concurrencyPolicy || 'Forbid'}`);
                                    if (svc.startingDeadlineSeconds) cronDetails.push(`deadline: ${svc.startingDeadlineSeconds}s`);
                                    if (svc.suspend) cronDetails.push('SUSPENDED');
                                    cronDetails.push(`keep: ${svc.successfulJobsHistoryLimit || 3}‚úì / ${svc.failedJobsHistoryLimit || 1}‚úó`);
                                    items.push({
                                        icon: '‚è∞',
                                        label: `  ‚îî cron settings`,
                                        value: cronDetails.join(' ¬∑ '),
                                        badge: '',
                                        badgeCls: 'muted',
                                    });
                                }
                            } else if (svc.kind === 'DaemonSet') {
                                // DaemonSet review
                                const dsStratStr = svc.strategy === 'OnDelete' ? ' ¬∑ OnDelete' : ` ¬∑ Rolling(‚Üì${svc.maxUnavailable || 1})`;
                                items.push({
                                    icon: _kindIcon(svc.kind),
                                    label: `${svc.kind}: ${svc.name}`,
                                    value: `one per node ¬∑ ${svc.image}${dsStratStr}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                                // DaemonSet details sub-items
                                const dsDetails = [];
                                if (svc.nodeSelector) dsDetails.push(`nodes: ${svc.nodeSelector}`);
                                if (svc.tolerations && svc.tolerations.length > 0) dsDetails.push(`tolerations: ${svc.tolerations.length}`);
                                if (svc.hostNetwork) dsDetails.push('hostNet');
                                if (svc.hostPID) dsDetails.push('hostPID');
                                if (svc.hostIPC) dsDetails.push('hostIPC');
                                if (dsDetails.length > 0) {
                                    items.push({
                                        icon: 'üéØ',
                                        label: `  ‚îî node config`,
                                        value: dsDetails.join(' ¬∑ '),
                                        badge: '',
                                        badgeCls: 'muted',
                                    });
                                }
                                if (svc.port) {
                                    items.push({
                                        icon: 'üåê',
                                        label: `Service: ${svc.name}`,
                                        value: `ClusterIP ‚Üí port ${svc.port}`,
                                        badge: 'create',
                                        badgeCls: 'ready',
                                    });
                                }
                            } else if (svc.kind === 'StatefulSet') {
                                // StatefulSet review
                                const ssStratStr = svc.strategy === 'OnDelete' ? ' ¬∑ OnDelete'
                                    : svc.partition > 0 ? ` ¬∑ Rolling(partition=${svc.partition})`
                                    : ' ¬∑ RollingUpdate';
                                items.push({
                                    icon: _kindIcon(svc.kind),
                                    label: `${svc.kind}: ${svc.name}`,
                                    value: `${svc.replicas || '?'} replica${svc.replicas !== '1' ? 's' : ''} of ${svc.image}${ssStratStr}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                                // Headless service
                                items.push({
                                    icon: 'üåê',
                                    label: `Headless: ${svc.headlessServiceName || svc.name + '-headless'}`,
                                    value: `ClusterIP: None ‚Üí port ${svc.port}${svc.alsoCreateClusterIP ? ' (+ClusterIP)' : ''}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                                // StatefulSet details
                                const ssDetails = [];
                                ssDetails.push(`pods: ${svc.podManagementPolicy || 'OrderedReady'}`);
                                if (svc.volumeClaimTemplates && svc.volumeClaimTemplates.length > 0) {
                                    ssDetails.push(`VCTs: ${svc.volumeClaimTemplates.length}`);
                                    const totalSize = svc.volumeClaimTemplates.map(v => v.size).join('+');
                                    ssDetails.push(`size: ${totalSize}`);
                                }
                                items.push({
                                    icon: 'üóÑÔ∏è',
                                    label: `  ‚îî stateful config`,
                                    value: ssDetails.join(' ¬∑ '),
                                    badge: '',
                                    badgeCls: 'muted',
                                });
                                // Individual VCT details
                                if (svc.volumeClaimTemplates && svc.volumeClaimTemplates.length > 0) {
                                    for (const vct of svc.volumeClaimTemplates) {
                                        const scLabel = vct.storageClass ? ` (${vct.storageClass})` : '';
                                        items.push({
                                            icon: 'üíæ',
                                            label: `  ‚îî VCT: ${vct.name}`,
                                            value: `${vct.size} ${vct.accessMode}${scLabel} ‚Üí ${vct.mountPath}`,
                                            badge: 'create',
                                            badgeCls: 'ready',
                                        });
                                    }
                                }
                            } else {
                                // Deployment review
                                const stratStr = svc.strategy === 'Recreate' ? ' ¬∑ Recreate'
                                    : svc.maxSurge || svc.maxUnavailable ? ` ¬∑ Rolling(‚Üë${svc.maxSurge || 1}/‚Üì${svc.maxUnavailable || 1})`
                                    : '';
                                items.push({
                                    icon: _kindIcon(svc.kind),
                                    label: `${svc.kind}: ${svc.name}`,
                                    value: `${svc.replicas || '?'} replica${svc.replicas !== '1' ? 's' : ''} of ${svc.image}${stratStr}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                                items.push({
                                    icon: 'üåê',
                                    label: `Service: ${svc.name}`,
                                    value: `${svc.serviceType} ‚Üí port ${svc.port}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                            }
                            // Dependencies (wait-for init containers will be generated)
                            if (svc.dependencies && svc.dependencies.length > 0) {
                                items.push({
                                    icon: 'üîó',
                                    label: `  ‚îî dependencies`,
                                    value: svc.dependencies.join(', ') + ' (wait-for init containers)',
                                    badge: '',
                                    badgeCls: 'muted',
                                });
                            }
                            // Companion containers (same pod)
                            if (svc.companions && svc.companions.length > 0) {
                                for (const comp of svc.companions) {
                                    const extras = [];
                                    if (comp.env && comp.env.length > 0) extras.push(`${comp.env.length} env`);
                                    if (comp.resources) extras.push('resources');
                                    if (comp.volumes && comp.volumes.length > 0) extras.push(`${comp.volumes.length} vol`);
                                    if (comp.dependsOn) extras.push(`waits-for: ${comp.dependsOn}`);
                                    const extraStr = extras.length > 0 ? ` (${extras.join(', ')})` : '';
                                    items.push({
                                        icon: 'üì¶',
                                        label: `  ‚îî companion: ${comp.name}`,
                                        value: `${comp.image}${comp.port ? ' :' + comp.port : ''}${extraStr}`,
                                        badge: 'pod',
                                        badgeCls: 'muted',
                                    });
                                }
                            }
                            // Init containers
                            if (svc.initContainers && svc.initContainers.length > 0) {
                                for (const init of svc.initContainers) {
                                    items.push({
                                        icon: '‚è≥',
                                        label: `  ‚îî init: ${init.name}`,
                                        value: `${init.image}${init.command ? ' ‚Üí ' + init.command.substring(0, 50) + (init.command.length > 50 ? '‚Ä¶' : '') : ''}`,
                                        badge: 'init',
                                        badgeCls: 'muted',
                                    });
                                }
                            }
                            // Sidecar containers
                            if (svc.sidecars && svc.sidecars.length > 0) {
                                for (const sc of svc.sidecars) {
                                    items.push({
                                        icon: 'üìé',
                                        label: `  ‚îî sidecar: ${sc.name}`,
                                        value: `${sc.image}${sc.nativeSidecar ? ' (native)' : ''}${sc.sharedVolume ? ' üìÅ ' + sc.sharedVolume : ''}`,
                                        badge: 'sidecar',
                                        badgeCls: 'muted',
                                    });
                                }
                            }
                            // Service mesh
                            if (svc.mesh) {
                                const m = svc.mesh;
                                const provName = { istio: 'Istio', linkerd: 'Linkerd', consul: 'Consul', kuma: 'Kuma' }[m.provider] || m.provider;
                                items.push({
                                    icon: 'üî∑',
                                    label: `  ‚îî ${provName} mesh`,
                                    value: `proxy CPU ${m.proxyCpuRequest}‚Üí${m.proxyCpuLimit} / Mem ${m.proxyMemRequest}‚Üí${m.proxyMemLimit}`,
                                    badge: 'annotations',
                                    badgeCls: 'muted',
                                });
                            }
                            // Resource limits (if configured)
                            if (svc.resources) {
                                const r = svc.resources;
                                const cpuStr = (r.cpu_request || r.cpu_limit) ? `CPU ${r.cpu_request || '‚Äî'}‚Üí${r.cpu_limit || '‚Äî'}` : '';
                                const memStr = (r.memory_request || r.memory_limit) ? `Mem ${r.memory_request || '‚Äî'}‚Üí${r.memory_limit || '‚Äî'}` : '';
                                const resStr = [cpuStr, memStr].filter(Boolean).join(' / ');
                                if (resStr) {
                                    items.push({
                                        icon: 'üîß',
                                        label: `Resources: ${svc.name}`,
                                        value: resStr,
                                        badge: '',
                                        badgeCls: '',
                                    });
                                }
                            }
                            // Health probes (if configured)
                            const probeDesc = (p) => {
                                if (!p) return null;
                                if (p.type === 'http') return `HTTP ${p.path}:${p.port}`;
                                if (p.type === 'tcp') return `TCP :${p.port}`;
                                return `exec: ${(p.command || '').substring(0, 30)}${(p.command || '').length > 30 ? '‚Ä¶' : ''}`;
                            };
                            const rdyStr = probeDesc(svc.readinessProbe);
                            const livStr = probeDesc(svc.livenessProbe);
                            if (rdyStr || livStr) {
                                const parts = [];
                                if (rdyStr) parts.push(`Ready: ${rdyStr}`);
                                if (livStr) parts.push(`Live: ${livStr}`);
                                items.push({
                                    icon: 'üíì',
                                    label: `Probes: ${svc.name}`,
                                    value: parts.join(' / '),
                                    badge: '',
                                    badgeCls: '',
                                });
                            }
                            // Environment variables ‚Äî ConfigMap + Secret summary
                            const ev = svc.envVars || [];
                            const evHc = ev.filter(e => e.type === 'hardcoded').length;
                            const evVr = ev.filter(e => e.type === 'variable').length;
                            const evSc = ev.filter(e => e.type === 'secret').length;
                            if (evHc + evVr > 0) {
                                items.push({
                                    icon: 'üìã',
                                    label: `ConfigMap: ${svc.name}-config`,
                                    value: `${evHc} hardcoded${evVr > 0 ? `, ${evVr} \${VAR}` : ''}`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                            }
                            if (evSc > 0) {
                                items.push({
                                    icon: 'üîí',
                                    label: `Secret: ${svc.name}-secrets`,
                                    value: `${evSc} key${evSc !== 1 ? 's' : ''} (\${VAR} at deploy)`,
                                    badge: 'create',
                                    badgeCls: 'ready',
                                });
                            }
                            // Vault vars/secrets to be created on execution
                            const toCreate = ev.filter(e => e.createInVault);
                            toCreate.forEach(e => {
                                const vaultKey = (e.varName || '').replace(/^\$\{/, '').replace(/\}$/, '') || e.key;
                                items.push({
                                    icon: 'üèóÔ∏è',
                                    label: `Vault: Create ${vaultKey}`,
                                    value: e.newValue ? 'with generated value' : 'empty (set later)',
                                    badge: 'vault create',
                                    badgeCls: 'ready',
                                });
                            });
                            // Volume mounts ‚Äî PVCs and other mounts
                            const vols = svc.volumes || [];
                            vols.forEach(vol => {
                                if (vol.type === 'pvc-dynamic' || vol.type === 'pvc-static') {
                                    const scLabel = vol.storageClass ? ` (${vol.storageClass})` : '';
                                    items.push({
                                        icon: 'üíæ',
                                        label: `PVC: ${vol.name}`,
                                        value: `${vol.size} ${vol.accessMode}${scLabel} ‚Üí ${vol.mountPath}`,
                                        badge: 'create',
                                        badgeCls: 'ready',
                                    });
                                } else if (vol.type === 'emptyDir') {
                                    const medLabel = vol.medium === 'Memory' ? ' (RAM)' : '';
                                    items.push({
                                        icon: 'üìÇ',
                                        label: `emptyDir: ${vol.mountPath}`,
                                        value: `ephemeral${medLabel}${vol.sizeLimit ? ' limit ' + vol.sizeLimit : ''}`,
                                        badge: 'inline',
                                        badgeCls: 'muted',
                                    });
                                } else if (vol.type === 'configMap') {
                                    items.push({
                                        icon: 'üìÑ',
                                        label: `CM mount: ${vol.configMapName}`,
                                        value: `‚Üí ${vol.mountPath}${vol.key ? ' (' + vol.key + ')' : ''}`,
                                        badge: 'ref',
                                        badgeCls: 'muted',
                                    });
                                } else if (vol.type === 'secret') {
                                    items.push({
                                        icon: 'üîê',
                                        label: `Secret mount: ${vol.secretName}`,
                                        value: `‚Üí ${vol.mountPath}${vol.key ? ' (' + vol.key + ')' : ''}`,
                                        badge: 'ref',
                                        badgeCls: 'muted',
                                    });
                                } else if (vol.type === 'hostPath') {
                                    items.push({
                                        icon: '‚ö†Ô∏è',
                                        label: `hostPath: ${vol.hostPath}`,
                                        value: `‚Üí ${vol.mountPath} (${vol.hostType})`,
                                        badge: 'inline',
                                        badgeCls: 'muted',
                                    });
                                }
                            });
                        }

                        for (const infra of infraDecisions) {
                            const isManaged = infra.kind === 'Managed';
                            items.push({
                                icon: _kindIcon(infra.kind),
                                label: `${infra.kind}: ${infra.name}`,
                                value: isManaged ? (infra.providerNotes || 'External provider') : infra.image,
                                badge: isManaged ? 'external' : 'create',
                                badgeCls: isManaged ? 'muted' : 'ready',
                            });
                            // Env var summary for infra services (managed = connection vars; self-hosted = regular)
                            if (infra.envVars && infra.envVars.length > 0) {
                                const iev = infra.envVars;
                                const iHc = iev.filter(e => e.type === 'hardcoded').length;
                                const iVr = iev.filter(e => e.type === 'variable').length;
                                const iSc = iev.filter(e => e.type === 'secret').length;
                                if (isManaged) {
                                    items.push({
                                        icon: 'üîó',
                                        label: `  ‚îî connection vars`,
                                        value: `${iev.length} var${iev.length !== 1 ? 's' : ''} ‚Üí injected into dependent services`,
                                        badge: '',
                                        badgeCls: 'muted',
                                    });
                                } else {
                                    if (iHc + iVr > 0) {
                                        items.push({
                                            icon: 'üìã',
                                            label: `  ‚îî ConfigMap: ${infra.name}-config`,
                                            value: `${iHc} hardcoded${iVr > 0 ? `, ${iVr} \${VAR}` : ''}`,
                                            badge: 'create',
                                            badgeCls: 'ready',
                                        });
                                    }
                                    if (iSc > 0) {
                                        items.push({
                                            icon: 'üîí',
                                            label: `  ‚îî Secret: ${infra.name}-secrets`,
                                            value: `${iSc} key${iSc !== 1 ? 's' : ''}`,
                                            badge: 'create',
                                            badgeCls: 'ready',
                                        });
                                    }
                                }
                            }
                            // Volume review for infra services
                            if (!isManaged && infra.volumes && infra.volumes.length > 0) {
                                infra.volumes.forEach(vol => {
                                    if (vol.type === 'pvc-dynamic' || vol.type === 'pvc-static') {
                                        const scLabel = vol.storageClass ? ` (${vol.storageClass})` : '';
                                        items.push({
                                            icon: 'üíæ',
                                            label: `  ‚îî PVC: ${vol.name}`,
                                            value: `${vol.size} ${vol.accessMode}${scLabel} ‚Üí ${vol.mountPath}`,
                                            badge: 'create',
                                            badgeCls: 'ready',
                                        });
                                    } else if (vol.type === 'emptyDir') {
                                        items.push({
                                            icon: 'üìÇ',
                                            label: `  ‚îî emptyDir: ${vol.mountPath}`,
                                            value: `ephemeral${vol.medium === 'Memory' ? ' (RAM)' : ''}`,
                                            badge: 'inline',
                                            badgeCls: 'muted',
                                        });
                                    }
                                });
                            }
                        }

                        if (data.ingress) {
                            items.push({ icon: 'üîÄ', label: 'Ingress', value: 'HTTP routing rules', badge: 'create', badgeCls: 'ready' });
                        }
                        // ConfigMap checkbox removed ‚Äî ConfigMaps/Secrets auto-generated per service from envVars
                        items.push({ icon: 'üìÅ', label: 'Output directory', value: data.output_dir || 'k8s/', badge: '', badgeCls: '' });
                        items.push({ icon: 'üè∑Ô∏è', label: 'Namespace', value: data.namespace || 'default', badge: '', badgeCls: '' });
                        if (data.skaffold) {
                            items.push({ icon: 'üõ§', label: 'Skaffold pipeline', value: 'skaffold.yaml ‚Äî build ‚Üí push ‚Üí deploy', badge: 'create', badgeCls: 'ready' });
                        }

                        el.innerHTML = `
                            ${wizSection('Review', `${services.length + infraDecisions.length} resource${(services.length + infraDecisions.length) !== 1 ? 's' : ''} will be generated.`)}
                            ${items.map(item => `<div class="wiz-review-item">
                                <span class="wiz-review-icon">${item.icon}</span>
                                <div class="wiz-review-content">
                                    <div class="wiz-review-label">${esc(item.label)}</div>
                                    <div class="wiz-review-value">${esc(item.value)}</div>
                                </div>
                                ${item.badge ? `<span class="wiz-review-badge ${item.badgeCls}">${item.badge}</span>` : ''}
                            </div>`).join('')}



                            <div style="margin-top:var(--space-md);padding:var(--space-xs) var(--space-sm);border-left:3px solid var(--accent);background:color-mix(in srgb, var(--accent) 5%, transparent);border-radius:0 6px 6px 0">
                                <div style="font-size:0.78rem;color:var(--text-secondary)">
                                    üí° <strong>Next:</strong> Set up CI/CD to automate builds and deployments.
                                    <button class="btn btn-sm btn-ghost" style="font-size:0.72rem;padding:0.1rem 0.4rem;margin-left:4px;color:var(--accent)"
                                        onclick="wizardModalClose();setTimeout(openCICDSetupWizard,300)">Set up CI/CD ‚Üí</button>
                                </div>
                            </div>
                        `;
                    },
                },
            ],
            onComplete: async (data) => {
                const payload = {
                    action: 'setup_k8s',
                    // Full wizard state ‚Äî the backend translator handles everything
                    _services: data._services,
                    _infraDecisions: data._infraDecisions,
                    namespace: data.namespace,
                    output_dir: data.output_dir,
                    ingress: data.ingress,
                    skaffold: data.skaffold,
                };
                await apiPost('/wizard/setup', payload);
                _projectStatusTS = 0;
                cardInvalidate('k8s');
            },
            successMessage: 'Kubernetes manifests generated!',
        });
    }

    // ‚îÄ‚îÄ Terraform Setup Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function openTerraformSetupWizard() {
        wizardModalOpen({
            title: 'üèóÔ∏è Terraform Setup',
            size: 'wide',
            steps: [
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // ‚îÄ‚îÄ Serve from cache if available (instant, zero API calls) ‚îÄ‚îÄ
                        const _CK = 'tf:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // ‚îÄ‚îÄ Fresh scan ‚îÄ‚îÄ
                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Detecting Terraform environment‚Ä¶</p>';
                        try {
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;
                            const probes = wizDetect.status_probes || {};
                            const tf = probes.terraform || {};
                            data._tf = tf;

                            const html = `
                                ${wizSection('Terraform Environment', 'Current Infrastructure as Code configuration.')}
                                <div class="wiz-status-grid">
                                    ${wizStatusRow('üèóÔ∏è', 'Terraform CLI', tf.has_cli ? 'Available' : 'Not found', tf.has_cli ? 'ok' : 'error')}
                                    ${wizStatusRow('üìÑ', 'TF files', String(tf.tf_file_count || 0), tf.tf_file_count > 0 ? 'ok' : 'warn')}
                                    ${wizStatusRow('üìÅ', 'Initialized', tf.initialized ? 'Yes' : 'No', tf.initialized ? 'ok' : 'muted')}
                                    ${wizStatusRow('üíæ', 'State file', tf.has_state ? 'Present' : 'None', tf.has_state ? 'ok' : 'muted')}
                                </div>
                            `;

                            // Store complete detect result in cache
                            wizStore(_CK, { h: html, d: { _tf: data._tf } }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;
                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>‚ö†Ô∏è</span><span>${esc(e.message)}</span></div>`;
                        }
                    },
                },
                {
                    id: 'config', title: 'Configure',
                    render: (data, el) => {
                        el.innerHTML = `
                            ${wizSection('Provider', 'Which cloud provider are you targeting?')}
                            ${wizFormGrid([
                                { name: 'tf-provider', label: 'Cloud Provider', type: 'select', value: data.provider || 'aws', options: [
                                    { value: 'aws', label: 'AWS' },
                                    { value: 'gcp', label: 'Google Cloud' },
                                    { value: 'azure', label: 'Microsoft Azure' },
                                    { value: 'digitalocean', label: 'DigitalOcean' },
                                    { value: 'custom', label: 'Custom / Other' },
                                ], required: true },
                                { name: 'tf-region', label: 'Region', value: data.region || 'us-east-1', hint: 'Primary deployment region' },
                            ])}

                            ${wizSection('Resources', 'What infrastructure do you want to provision?')}
                            ${wizFormGrid([
                                { name: 'tf-k8s', label: 'Kubernetes cluster (EKS/GKE/AKS)', type: 'checkbox', value: false, fullWidth: true },
                                { name: 'tf-rds', label: 'Database (RDS/Cloud SQL)', type: 'checkbox', value: false, fullWidth: true },
                                { name: 'tf-s3', label: 'Object storage (S3/GCS)', type: 'checkbox', value: false, fullWidth: true },
                                { name: 'tf-networking', label: 'VPC / Networking', type: 'checkbox', value: true, fullWidth: true },
                            ])}

                            ${wizSection('Backend', 'Where should Terraform store its state?')}
                            ${wizFormGrid([
                                { name: 'tf-backend', label: 'State Backend', type: 'select', value: data.backend || 'local', options: [
                                    { value: 'local', label: 'Local (terraform.tfstate)' },
                                    { value: 's3', label: 'AWS S3' },
                                    { value: 'gcs', label: 'Google Cloud Storage' },
                                    { value: 'azurerm', label: 'Azure Blob Storage' },
                                ], fullWidth: true },
                            ])}
                        `;
                    },
                    collect: (data) => {
                        data.provider = mfVal('tf-provider');
                        data.region = mfVal('tf-region');
                        data.k8sCluster = mfVal('tf-k8s');
                        data.database = mfVal('tf-rds');
                        data.storage = mfVal('tf-s3');
                        data.networking = mfVal('tf-networking');
                        data.backend = mfVal('tf-backend');
                    },
                },
                {
                    id: 'review', title: 'Review & Apply',
                    render: (data, el) => {
                        const resources = [];
                        if (data.networking) resources.push('VPC, Subnets, Security Groups');
                        if (data.k8sCluster) resources.push('Kubernetes Cluster');
                        if (data.database) resources.push('Database Instance');
                        if (data.storage) resources.push('Object Storage Bucket');

                        const files = [
                            { icon: 'üìÑ', label: 'main.tf', value: `Provider: ${data.provider}, Region: ${data.region}` },
                            { icon: 'üìã', label: 'variables.tf', value: 'Input variable definitions' },
                            { icon: 'üì§', label: 'outputs.tf', value: 'Output value definitions' },
                        ];
                        if (data.backend !== 'local') {
                            files.push({ icon: 'üíæ', label: 'backend.tf', value: `State backend: ${data.backend}` });
                        }

                        el.innerHTML = `
                            ${wizSection('Review', 'The following Terraform configuration will be generated.')}
                            ${files.map(item => `<div class="wiz-review-item">
                                <span class="wiz-review-icon">${item.icon}</span>
                                <div class="wiz-review-content">
                                    <div class="wiz-review-label">${esc(item.label)}</div>
                                    <div class="wiz-review-value">${esc(item.value)}</div>
                                </div>
                                <span class="wiz-review-badge ready">create</span>
                            </div>`).join('')}

                            ${resources.length > 0 ? `
                                ${wizSection('Resources to provision')}
                                <div style="padding:0 0.5rem;font-size:0.82rem;color:var(--text-secondary)">
                                    ${resources.map(r => `<div style="padding:4px 0">‚Ä¢ ${esc(r)}</div>`).join('')}
                                </div>
                            ` : ''}
                        `;
                    },
                },
            ],
            onComplete: async (data) => {
                await apiPost('/wizard/setup', {
                    action: 'setup_terraform',
                    provider: data.provider,
                    region: data.region,
                    k8s_cluster: data.k8sCluster,
                    database: data.database,
                    storage: data.storage,
                    networking: data.networking,
                    backend: data.backend,
                });
                _projectStatusTS = 0;
            },
            successMessage: 'Terraform configuration generated!',
        });
    }
    // ‚îÄ‚îÄ GitHub Setup Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Integration #2 ‚Äî reads environments from project.yml, aligns
    // them with GitHub deployment environments, offers secret sync.

    async function openGitHubSetupWizard() {
        wizardModalOpen({
            title: 'üêô GitHub Setup',
            size: 'wide',
            steps: [
                // ‚îÄ‚îÄ Step 1: DETECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        // ‚îÄ‚îÄ Serve from cache if available (instant, zero API calls) ‚îÄ‚îÄ
                        const _CK = 'gh:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        // ‚îÄ‚îÄ Fresh scan ‚îÄ‚îÄ
                        el.innerHTML = '<span class="spinner"></span> Detecting GitHub status‚Ä¶';

                        // ONE call: wizDetect is the one-stop-shop
                        const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;
                        const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                        const _serverTs = (wizDetect._cache?.computed_at || 0) * 1000;

                        const probes = wizDetect.status_probes || {};
                        const gh = probes.github || {};
                        const ghStatus = wizDetect.gh_cli_status || { available: false };
                        const ghUser = wizDetect.gh_user || { available: false };
                        const ghRepoInfo = wizDetect.gh_repo_info || { available: false };
                        const ghEnvData = wizDetect.gh_environments || { available: false, environments: [] };
                        data._ghStatus = ghStatus;
                        data._ghUser = ghUser;
                        data._ghRepoInfo = ghRepoInfo;
                        data._projectStatus = { integrations: probes };
                        data._config = wizDetect.config_data || {};
                        data._ghEnvData = ghEnvData;
                        data._localEnvs = (wizDetect.config_data?.environments || []);
                        data._codeownersContent = wizDetect.codeowners_content || '';

                        // Remote env names (lowercase for comparison)
                        const remoteEnvNames = (ghEnvData.environments || []).map(e =>
                            (typeof e === 'string' ? e : e.name || String(e)).toLowerCase());
                        data._remoteEnvNames = remoteEnvNames;

                        // Secrets: multi-env ‚Üí per-environment, single ‚Üí repo-scoped
                        const localEnvs = data._localEnvs;
                        const multiEnv = localEnvs.length > 1;
                        let totalSecrets = 0, totalVars = 0;
                        const perEnvSecrets = {};

                        if (multiEnv) {
                            const envQueries = localEnvs.map(e =>
                                api(`/gh/secrets?env=${encodeURIComponent(e.name)}`)
                                    .catch(() => ({ available: false, secrets: [], variables: [] }))
                            );
                            const envResults = await Promise.all(envQueries);
                            for (let i = 0; i < localEnvs.length; i++) {
                                const r = envResults[i];
                                const envName = localEnvs[i].name;
                                perEnvSecrets[envName] = r;
                                totalSecrets += (r.secrets || []).length;
                                totalVars += (r.variables || []).length;
                            }
                            data._secretsAvailable = true;
                        } else {
                            const ghSecrets = await api('/gh/secrets').catch(() => ({ available: false, secrets: [], variables: [] }));
                            totalSecrets = (ghSecrets.secrets || []).length;
                            totalVars = (ghSecrets.variables || []).length;
                            data._secretsAvailable = ghSecrets.available !== false;
                            perEnvSecrets['_repo'] = ghSecrets;
                        }
                        data._perEnvSecrets = perEnvSecrets;
                        data._totalSecrets = totalSecrets;
                        data._totalVars = totalVars;
                        data._multiEnv = multiEnv;

                        // ‚îÄ‚îÄ Build detection display ‚îÄ‚îÄ
                        let html = `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;margin-bottom:var(--space-sm);font-size:0.82rem;background:color-mix(in srgb, var(--accent) 10%, var(--bg-inset));border:1px solid color-mix(in srgb, var(--accent) 30%, transparent);border-radius:8px">
                            <span style="font-size:1.1rem">üîç</span>
                            <span style="flex:1;color:var(--text-secondary)">This is a <strong>read-only scan</strong>. To manage visibility, environments, CODEOWNERS, and secrets, proceed to Configure.</span>
                            <button type="button" class="btn btn-xs" style="background:var(--accent);color:white;border:none;padding:4px 12px;border-radius:6px;font-size:0.78rem;white-space:nowrap;cursor:pointer"
                                onclick="document.getElementById('wiz-btn-next')?.click()">Configure ‚Üí</button>
                        </div>`;

                        // ‚îÄ‚îÄ gh CLI ‚îÄ‚îÄ
                        html += wizSection('GitHub CLI', 'Tool, authentication, and account.');
                        html += '<div class="wiz-status-grid">';

                        if (!ghStatus.available) {
                            html += wizStatusRow('‚ùå', 'gh CLI', 'Not installed', 'error');
                            html += '</div>';
                            html += `<div style="padding:0.5rem 0.75rem;background:var(--bg-inset);border:1px solid var(--error);border-radius:8px;font-size:0.82rem;margin-top:var(--space-sm)">
                                <strong style="color:var(--error)">GitHub CLI required.</strong> Install it first:
                                <div style="margin-top:0.3rem;display:flex;gap:0.5rem;flex-wrap:wrap">
                                    <code style="background:var(--bg-tertiary);padding:2px 8px;border-radius:4px">sudo apt install gh</code>
                                    <code style="background:var(--bg-tertiary);padding:2px 8px;border-radius:4px">brew install gh</code>
                                </div>
                            </div>`;
                            el.innerHTML = html;
                            return;
                        }

                        html += wizStatusRow('‚úÖ', 'gh CLI', `Installed (${esc(ghStatus.version || 'unknown')})`, 'ok');

                        // ‚îÄ‚îÄ Auth + User ‚îÄ‚îÄ
                        if (!ghStatus.authenticated) {
                            html += wizStatusRow('‚ùå', 'Authentication', 'Not logged in', 'error');
                            html += '</div>';
                            html += `<div style="padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--warning);border-radius:8px;font-size:0.82rem;margin-top:var(--space-sm)">
                                <strong>Login required.</strong> Run this in your terminal:
                                <div style="display:flex;align-items:center;gap:0.5rem;margin-top:0.4rem">
                                    <code id="gh-auth-cmd" style="flex:1;background:var(--bg-tertiary);padding:4px 10px;border-radius:4px;font-size:0.8rem">gh auth login</code>
                                    <button type="button" class="btn btn-xs btn-secondary" style="font-size:0.7rem;padding:2px 8px"
                                        onclick="navigator.clipboard.writeText('gh auth login').then(()=>this.textContent='‚úì Copied').catch(()=>{});setTimeout(()=>this.textContent='üìã Copy',2000)">üìã Copy</button>
                                </div>
                                <div style="font-size:0.72rem;color:var(--text-muted);margin-top:0.3rem">
                                    After logging in, click <strong>Re-scan</strong> above to refresh.
                                </div>
                            </div>`;
                            el.innerHTML = html;
                            return;
                        }

                        // Authenticated ‚Äî show user info
                        const userLogin = ghUser.login || 'unknown';
                        const userName = ghUser.name || '';
                        const userAvatar = ghUser.avatar_url || '';
                        html += wizStatusRow('‚úÖ', 'Authentication', 'Logged in', 'ok');
                        html += '</div>';

                        // ‚îÄ‚îÄ User card ‚îÄ‚îÄ
                        html += `<div style="display:flex;align-items:center;gap:0.7rem;padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;margin:var(--space-sm) 0">
                            ${userAvatar ? `<img src="${esc(userAvatar)}" style="width:32px;height:32px;border-radius:50%;border:2px solid var(--accent)" alt="">` : '<span style="font-size:1.3rem">üë§</span>'}
                            <div style="flex:1">
                                <div style="font-size:0.85rem;font-weight:600;color:var(--text-primary)">@${esc(userLogin)}</div>
                                ${userName ? `<div style="font-size:0.72rem;color:var(--text-muted)">${esc(userName)}</div>` : ''}
                            </div>
                            <button type="button" class="btn btn-xs btn-secondary" style="font-size:0.68rem;padding:2px 8px;color:var(--error)"
                                onclick="(async()=>{if(!confirm('Log out from GitHub CLI?'))return;const r=await apiPost('/gh/auth/logout',{});toast(r.ok?'Logged out ‚Äî Re-scan to refresh':'Logout failed: '+(r.error||''),'info');})()">üîì Logout</button>
                        </div>`;

                        // ‚îÄ‚îÄ Repository ‚îÄ‚îÄ
                        html += wizSection('Repository', 'GitHub repository linked via git remote.');
                        html += '<div class="wiz-status-grid">';

                        if (ghStatus.repo) {
                            const vis = ghRepoInfo.visibility || '?';
                            const visColor = vis === 'PUBLIC' ? 'var(--success)' : vis === 'PRIVATE' ? 'var(--warning)' : 'var(--text-muted)';
                            const visIcon = vis === 'PUBLIC' ? 'üåê' : vis === 'PRIVATE' ? 'üîí' : '‚ùì';
                            html += wizStatusRow('‚úÖ', 'Repository', esc(ghStatus.repo), 'ok');
                            html += wizStatusRow(visIcon, 'Visibility',
                                `<span style="color:${visColor};font-weight:600">${esc(vis)}</span>`, 'ok', true);
                            if (ghRepoInfo.description) {
                                html += wizStatusRow('üìù', 'Description', esc(ghRepoInfo.description), 'muted');
                            }
                            html += wizStatusRow('üåø', 'Default branch', esc(ghRepoInfo.default_branch || '?'), 'muted');
                        } else {
                            html += wizStatusRow('‚ö†Ô∏è', 'Repository', 'No GitHub repository linked', 'warn');
                        }

                        // .github dir + workflows
                        if (gh.has_github_dir) {
                            const wfNote = gh.workflow_count > 0
                                ? `${gh.workflow_count} workflow${gh.workflow_count !== 1 ? 's' : ''}`
                                : 'no workflows';
                            html += wizStatusRow('‚úÖ', '.github/ dir', `Exists (${wfNote})`, 'ok');
                        } else {
                            html += wizStatusRow('‚ùå', '.github/ dir', 'Not found', 'error');
                        }

                        // CODEOWNERS
                        html += wizStatusRow(gh.has_codeowners ? '‚úÖ' : '‚ùå', 'CODEOWNERS',
                            gh.has_codeowners ? 'Found' : 'Not configured',
                            gh.has_codeowners ? 'ok' : 'muted');

                        html += '</div>';

                        // ‚îÄ‚îÄ Environments ‚îÄ‚îÄ
                        const localCount = data._localEnvs.length;
                        const matchCount = data._localEnvs.filter(e =>
                            remoteEnvNames.includes(e.name.toLowerCase())).length;

                        html += wizSection('Integration Status', '');
                        html += '<div class="wiz-status-grid">';
                        if (localCount > 0) {
                            html += wizStatusRow(matchCount === localCount ? '‚úÖ' : '‚ö†Ô∏è',
                                'Environments', `${matchCount} of ${localCount} aligned`,
                                matchCount === localCount ? 'ok' : 'warn');
                        } else {
                            html += wizStatusRow('‚ûñ', 'Environments', 'None defined in project config', 'muted');
                        }

                        // Secrets summary
                        if (data._secretsAvailable) {
                            const scopeLabel = multiEnv ? `across ${localEnvs.length} envs` : 'repo-scoped';
                            html += wizStatusRow('üìä', 'GitHub Secrets',
                                `${totalSecrets} secret${totalSecrets !== 1 ? 's' : ''}, ${totalVars} variable${totalVars !== 1 ? 's' : ''} (${scopeLabel})`);
                        }
                        html += '</div>';



                        // ‚îÄ‚îÄ Hints ‚îÄ‚îÄ
                        const hints = [];
                        if (matchCount < localCount) {
                            hints.push(`Your project defines ${localCount} environments. We can create the ${localCount - matchCount} missing ones on GitHub.`);
                        }
                        if (!ghStatus.repo) {
                            hints.push('No GitHub repository linked. You can <strong>create a new one</strong> or <strong>connect an existing one</strong> in the Configure step.');
                        }

                        if (hints.length > 0) {
                            html += `<div style="margin-top:var(--space-sm);padding:var(--space-xs) var(--space-sm);border-left:3px solid var(--accent);background:color-mix(in srgb, var(--accent) 5%, transparent);border-radius:0 6px 6px 0">`;
                            hints.forEach(h => { html += `<div style="font-size:0.78rem;color:var(--text-secondary);padding:2px 0">üí° ${h}</div>`; });
                            html += `</div>`;
                        }

                        // Store complete detect result in cache
                        wizStore(_CK, { h: html, d: {
                            _ghStatus: data._ghStatus, _ghUser: data._ghUser,
                            _ghRepoInfo: data._ghRepoInfo,
                            _projectStatus: data._projectStatus,
                            _config: data._config, _ghEnvData: data._ghEnvData,
                            _localEnvs: data._localEnvs, _remoteEnvNames: data._remoteEnvNames,
                            _perEnvSecrets: data._perEnvSecrets, _totalSecrets: data._totalSecrets,
                            _totalVars: data._totalVars, _multiEnv: data._multiEnv,
                            _secretsAvailable: data._secretsAvailable,
                            _codeownersContent: data._codeownersContent,
                        }}, _serverTs);
                        el.innerHTML = _wizDetectBanner(_CK) + html;
                    },
                },

                // ‚îÄ‚îÄ Step 2: CONFIGURE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'config', title: 'Configure',
                    render: async (data, el) => {
                        const ghStatus = data._ghStatus;
                        const ghRepoInfo = data._ghRepoInfo || {};
                        const localEnvs = data._localEnvs;
                        const remoteEnvNames = data._remoteEnvNames;

                        let html = '';

                        // ‚îÄ‚îÄ Section A: Repository ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        html += wizSection('Repository', 'GitHub repository and settings.');

                        if (ghStatus.repo) {
                            // ‚îÄ‚îÄ Linked repo: show info + visibility toggle ‚îÄ‚îÄ
                            const vis = ghRepoInfo.visibility || '?';
                            const isPrivate = vis === 'PRIVATE';
                            const visColor = isPrivate ? 'var(--warning)' : 'var(--success)';
                            const visIcon = isPrivate ? 'üîí' : 'üåê';
                            const toggleTo = isPrivate ? 'public' : 'private';
                            const toggleIcon = isPrivate ? 'üåê' : 'üîí';

                            html += `<div style="background:var(--bg-inset);border:1px solid var(--success);border-radius:8px;padding:0.6rem 0.75rem;margin-bottom:var(--space-sm)">
                                <div style="display:flex;align-items:center;gap:0.6rem;margin-bottom:0.4rem">
                                    <span style="font-size:1.1rem">üîó</span>
                                    <code style="font-size:0.85rem;font-weight:600">${esc(ghStatus.repo)}</code>
                                    <span style="flex:1"></span>
                                    <a href="https://github.com/${esc(ghStatus.repo)}" target="_blank"
                                       style="font-size:0.72rem;color:var(--accent);text-decoration:none">Open on GitHub ‚Üó</a>
                                </div>
                                <div style="display:flex;align-items:center;gap:0.7rem;padding-top:0.4rem;border-top:1px solid var(--border-subtle)">
                                    <div style="display:flex;align-items:center;gap:0.4rem">
                                        <span>${visIcon}</span>
                                        <span style="font-size:0.82rem;font-weight:600;color:${visColor}">${esc(vis)}</span>
                                    </div>
                                    ${ghRepoInfo.description ? `<span style="font-size:0.72rem;color:var(--text-muted);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(ghRepoInfo.description)}</span>` : '<span style="flex:1"></span>'}
                                    <button type="button" class="btn btn-xs btn-secondary" id="gh-vis-toggle"
                                        style="font-size:0.68rem;padding:2px 10px;border:1px solid ${visColor}"
                                        onclick="(async()=>{
                                            const btn=document.getElementById('gh-vis-toggle');
                                            const target='${toggleTo}';
                                            const slug='${esc(ghStatus.repo)}';
                                            if(!confirm('Change ' + slug + ' to ' + target.toUpperCase() + '?\\n\\n' +
                                                (target==='public' ? '‚ö†Ô∏è This will make your code visible to everyone on the internet.' : 'üîí This will restrict access to collaborators only.') +
                                                '\\n\\nAre you sure?')) return;
                                            btn.disabled=true; btn.textContent='Changing‚Ä¶';
                                            try {
                                                await apiPost('/gh/repo/visibility', {visibility:target});
                                                toast('‚úÖ Visibility changed to ' + target, 'success');
                                                wizInvalidate('gh:detect'); wizInvalidate('detect');
                                                _wizModalRender();
                                            } catch(e) { toast('‚ùå ' + e.message, 'error'); btn.disabled=false; btn.textContent='${toggleIcon} Make ${toggleTo}'; }
                                        })()">${toggleIcon} Make ${toggleTo}</button>
                                </div>
                            </div>`;
                        } else {
                            // ‚îÄ‚îÄ No repo linked: create or connect ‚îÄ‚îÄ
                            html += `<div style="background:var(--bg-inset);border:1px solid var(--warning);border-radius:8px;padding:0.6rem 0.75rem;margin-bottom:var(--space-sm)">
                                <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem">
                                    <span>‚ö†Ô∏è</span>
                                    <span style="font-size:0.85rem;font-weight:500">No GitHub repository linked</span>
                                </div>
                                <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.6rem">
                                    Create a new GitHub repository from this project, or set a git remote pointing to an existing one via the <strong>Git Setup</strong> wizard.
                                </div>
                                <div style="border-top:1px solid var(--border-subtle);padding-top:0.5rem">
                                    <div style="font-size:0.72rem;font-weight:600;color:var(--text-secondary);text-transform:uppercase;letter-spacing:0.04em;margin-bottom:0.4rem">Create New Repository</div>
                                    <div style="display:flex;flex-direction:column;gap:0.4rem">
                                        <div style="display:flex;gap:0.5rem;align-items:center">
                                            <input type="text" id="mf-gh-repo-name" class="modal-form-input" style="flex:1;font-size:0.82rem;padding:4px 8px"
                                                placeholder="${esc((data._config?.modules?.[0]?.name || '').replace(/[^a-zA-Z0-9._-]/g,'') || 'my-project')}" value="">
                                            <select id="mf-gh-repo-vis" class="modal-form-input" style="width:110px;font-size:0.82rem;padding:4px 8px">
                                                <option value="private" selected>üîí Private</option>
                                                <option value="public">üåê Public</option>
                                            </select>
                                        </div>
                                        <input type="text" id="mf-gh-repo-desc" class="modal-form-input" style="font-size:0.82rem;padding:4px 8px"
                                            placeholder="Optional description">
                                        <button type="button" class="btn btn-sm" id="gh-create-repo-btn"
                                            style="align-self:flex-start;font-size:0.78rem;padding:4px 14px;background:var(--accent);color:white;border:none;border-radius:6px"
                                            onclick="(async()=>{
                                                const btn=document.getElementById('gh-create-repo-btn');
                                                const name=document.getElementById('mf-gh-repo-name').value.trim();
                                                if(!name){toast('Enter a repository name','warn');return}
                                                const vis=document.getElementById('mf-gh-repo-vis').value;
                                                const desc=document.getElementById('mf-gh-repo-desc').value.trim();
                                                btn.disabled=true; btn.textContent='Creating‚Ä¶';
                                                try {
                                                    const r = await apiPost('/gh/repo/create', {name, private:vis==='private', description:desc, add_remote:true});
                                                    if(r.ok){
                                                        toast('‚úÖ '+r.message,'success');
                                                        wizInvalidate('gh:detect'); wizInvalidate('detect');
                                                        cardInvalidate('git'); cardInvalidate('github');
                                                        _wizModalRender();
                                                    } else {
                                                        toast('‚ùå '+(r.error||'Failed'),'error');
                                                        btn.disabled=false; btn.textContent='üöÄ Create Repository';
                                                    }
                                                } catch(e) { toast('‚ùå '+e.message,'error'); btn.disabled=false; btn.textContent='üöÄ Create Repository'; }
                                            })()">üöÄ Create Repository</button>
                                    </div>
                                </div>
                            </div>`;
                        }

                        // ‚îÄ‚îÄ Section A2: Default Branch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        if (ghStatus.repo && ghRepoInfo.available) {
                            html += wizSection('Default Branch', 'The branch GitHub treats as the base for pull requests and the repository landing page.');

                            const currentBranch = ghRepoInfo.default_branch || 'main';
                            html += `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.65rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:var(--space-sm)">
                                <span style="font-size:0.95rem">üåø</span>
                                <code style="font-size:0.85rem;font-weight:600">${esc(currentBranch)}</code>
                                <span style="flex:1"></span>
                                <button type="button" class="btn btn-xs btn-secondary" style="font-size:0.68rem;padding:2px 8px"
                                    onclick="(async()=>{
                                        const newBranch=prompt('Set default branch to:', '${esc(currentBranch)}');
                                        if(!newBranch||newBranch==='${esc(currentBranch)}')return;
                                        const res=await apiPost('/gh/repo/default-branch',{branch:newBranch});
                                        if(res.ok){toast('‚úÖ '+res.message,'success');wizInvalidate('gh:detect');wizInvalidate('detect');_wizModalRender()}
                                        else{toast('‚ùå '+(res.error||'Failed'),'error')}
                                    })()">‚úèÔ∏è Change</button>
                            </div>`;
                        }

                        // ‚îÄ‚îÄ Section A3: CODEOWNERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        if (ghStatus.repo) {
                            html += wizSection('CODEOWNERS', 'Define reviewers who are automatically requested for PRs affecting their files.');

                            // Use pre-loaded CODEOWNERS content from detect response
                            const existingContent = data._codeownersContent || '';

                            const hasExisting = existingContent.trim().length > 0;
                            const owner = ghRepoInfo.owner || ghStatus.repo?.split('/')[0] || '';
                            const defaultContent = hasExisting ? existingContent : `# CODEOWNERS ‚Äî auto-assign reviewers for pull requests\n# Docs: https://docs.github.com/en/repositories/managing-your-repositorys-settings-and-features/customizing-your-repository/about-code-owners\n\n# Default owner for everything\n* @${esc(owner)}\n`;

                            if (hasExisting) {
                                html += `<div style="padding:0.4rem 0.65rem;background:var(--bg-inset);border:1px solid var(--success);border-radius:8px;margin-bottom:var(--space-sm)">
                                    <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.3rem">
                                        <span>‚úÖ</span>
                                        <span style="font-size:0.82rem;font-weight:500">CODEOWNERS exists</span>
                                        <span style="flex:1"></span>
                                        <button type="button" class="btn btn-xs btn-ghost" style="font-size:0.68rem"
                                            onclick="document.getElementById('co-editor-wrap').style.display=document.getElementById('co-editor-wrap').style.display==='none'?'block':'none'">‚úèÔ∏è Edit</button>
                                    </div>
                                    <div class="modal-preview" style="max-height:120px;overflow-y:auto;font-size:0.72rem">
                                        <pre style="margin:0;white-space:pre-wrap;font-family:var(--font-mono);font-size:0.72rem;line-height:1.4">${esc(existingContent)}</pre>
                                    </div>
                                </div>`;
                            } else {
                                html += `<div style="padding:0.4rem 0.65rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:var(--space-sm)">
                                    <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.3rem">
                                        <span>üìù</span>
                                        <span style="font-size:0.82rem;color:var(--text-muted)">No CODEOWNERS file found</span>
                                    </div>
                                </div>`;
                            }

                            html += `<div id="co-editor-wrap" style="${hasExisting ? 'display:none;' : ''}margin-bottom:var(--space-sm)">
                                <label class="modal-form-check" style="margin-bottom:var(--space-xs)">
                                    <input type="checkbox" id="mf-write-codeowners" ${hasExisting ? '' : 'checked'}>
                                    <span style="font-size:0.82rem">${hasExisting ? 'Update' : 'Create'} CODEOWNERS file</span>
                                </label>
                                <textarea id="mf-codeowners-content"
                                    class="modal-form-textarea" style="font-family:var(--font-mono);font-size:0.72rem;min-height:120px;width:100%;line-height:1.5"
                                >${esc(defaultContent)}</textarea>
                                <span class="modal-form-hint">File will be saved as <code>.github/CODEOWNERS</code>.</span>
                            </div>`;
                        }

                        // ‚îÄ‚îÄ Section B: Environment Alignment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        if (localEnvs.length > 0) {
                            html += wizSection('Environment Alignment',
                                'Align local environments (from Project Configuration) with GitHub deployment environments.');

                            html += `<div style="background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;overflow:hidden;margin-bottom:var(--space-sm)">`;

                            // Header row
                            html += `<div style="display:flex;align-items:center;padding:0.35rem 0.65rem;font-size:0.68rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;border-bottom:1px solid var(--border-subtle);background:color-mix(in srgb, var(--bg-tertiary) 40%, transparent)">
                                <span style="width:28px"></span>
                                <span style="flex:1">Local</span>
                                <span style="width:100px;text-align:center">GitHub</span>
                                <span style="width:90px;text-align:right">Action</span>
                            </div>`;

                            for (const env of localEnvs) {
                                const aligned = remoteEnvNames.includes(env.name.toLowerCase());
                                const icon = aligned ? '‚úÖ' : '‚¨ú';
                                const ghLabel = aligned
                                    ? `<span style="color:var(--success)">‚úÖ exists</span>`
                                    : `<span style="color:var(--text-muted)">‚ùå missing</span>`;
                                const action = aligned
                                    ? `<span style="font-size:0.72rem;color:var(--success)">aligned</span>`
                                    : `<label style="font-size:0.72rem;cursor:pointer;display:flex;align-items:center;gap:4px;justify-content:flex-end">
                                        <input type="checkbox" class="gh-env-create" data-env="${esc(env.name)}" checked
                                            style="width:13px;height:13px;accent-color:var(--accent)">
                                        Create
                                    </label>`;

                                html += `<div style="display:flex;align-items:center;padding:0.4rem 0.65rem;font-size:0.82rem;border-bottom:1px solid var(--border-subtle)">
                                    <span style="width:28px;text-align:center">${icon}</span>
                                    <span style="flex:1">
                                        <code style="font-size:0.8rem;font-weight:500">${esc(env.name)}</code>
                                        ${env.default ? '<span style="font-size:0.65rem;color:var(--warning);margin-left:4px">‚≠ê default</span>' : ''}
                                    </span>
                                    <span style="width:100px;text-align:center;font-size:0.75rem">${ghLabel}</span>
                                    <span style="width:90px;text-align:right">${action}</span>
                                </div>`;
                            }

                            // Show extra remote envs not defined locally
                            const localNames = localEnvs.map(e => e.name.toLowerCase());
                            const extraRemote = (data._ghEnvData.environments || [])
                                .map(e => typeof e === 'string' ? e : e.name || String(e))
                                .filter(name => !localNames.includes(name.toLowerCase()));

                            for (const name of extraRemote) {
                                html += `<div style="display:flex;align-items:center;padding:0.4rem 0.65rem;font-size:0.82rem;border-bottom:1px solid var(--border-subtle);opacity:0.6">
                                    <span style="width:28px;text-align:center">‚ûñ</span>
                                    <span style="flex:1;color:var(--text-muted)">
                                        <code style="font-size:0.8rem">${esc(name)}</code>
                                        <span style="font-size:0.65rem;margin-left:4px">(GitHub only)</span>
                                    </span>
                                    <span style="width:100px;text-align:center;font-size:0.75rem"><span style="color:var(--success)">‚úÖ exists</span></span>
                                    <span style="width:90px;text-align:right;font-size:0.72rem;color:var(--text-muted)">‚Äî</span>
                                </div>`;
                            }

                            html += `</div>`;

                            html += `<div style="font-size:0.72rem;color:var(--text-muted);padding:0 0.25rem;margin-bottom:var(--space-sm)">
                                üí° Environments are defined in <strong>Project Configuration</strong>. Use the Wizard to add/remove them.
                            </div>`;
                        } else {
                            html += wizSection('Environments',
                                'No environments defined in your project configuration.');
                            html += `<div style="font-size:0.78rem;color:var(--text-muted);padding:0.5rem 0">
                                üí° Go to the Wizard ‚Üí Step 1 (Project Configuration) to define environments like dev, staging, production.
                            </div>`;
                        }

                        // ‚îÄ‚îÄ Section C: Secrets Sync ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                        if (data._secretsAvailable) {
                            html += wizSection('Secrets Sync',
                                'Push local vault secrets to GitHub for CI/CD and deployments.');

                            const totalSecrets = data._totalSecrets;
                            const totalVars = data._totalVars;
                            const perEnvSecrets = data._perEnvSecrets;
                            const multiEnv = data._multiEnv;

                            html += `<div style="display:flex;gap:var(--space-sm);margin-bottom:var(--space-sm)">
                                <div style="flex:1;padding:0.5rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;text-align:center">
                                    <div style="font-size:1.2rem;font-weight:700">${totalSecrets}</div>
                                    <div style="font-size:0.68rem;color:var(--text-muted)">Secrets on GitHub</div>
                                </div>
                                <div style="flex:1;padding:0.5rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;text-align:center">
                                    <div style="font-size:1.2rem;font-weight:700">${totalVars}</div>
                                    <div style="font-size:0.68rem;color:var(--text-muted)">Variables on GitHub</div>
                                </div>
                            </div>`;

                            // Per-environment breakdown (multi-env) or repo-level list
                            for (const [envKey, envData] of Object.entries(perEnvSecrets)) {
                                const envLabel = envKey === '_repo' ? 'Repository' : envKey;
                                const secrets = envData.secrets || [];
                                const vars = envData.variables || [];
                                if (secrets.length === 0 && vars.length === 0) continue;

                                if (multiEnv) {
                                    html += `<div style="font-size:0.72rem;font-weight:600;color:var(--text-secondary);margin:var(--space-xs) 0 2px;text-transform:uppercase;letter-spacing:0.04em">
                                        ${esc(envLabel)} (${secrets.length}s / ${vars.length}v)</div>`;
                                }

                                html += `<div style="display:flex;flex-wrap:wrap;gap:0.25rem;margin-bottom:var(--space-xs)">`;
                                for (const s of secrets) {
                                    const name = typeof s === 'string' ? s : s.name || String(s);
                                    html += `<span style="font-size:0.65rem;padding:0.1rem 0.35rem;border-radius:4px;background:color-mix(in srgb, var(--success) 10%, transparent);color:var(--success);border:1px solid color-mix(in srgb, var(--success) 25%, transparent)">üîí ${esc(name)}</span>`;
                                }
                                for (const v of vars) {
                                    const name = typeof v === 'string' ? v : v.name || String(v);
                                    html += `<span style="font-size:0.65rem;padding:0.1rem 0.35rem;border-radius:4px;background:color-mix(in srgb, var(--accent) 10%, transparent);color:var(--accent);border:1px solid color-mix(in srgb, var(--accent) 25%, transparent)">üìã ${esc(name)}</span>`;
                                }
                                html += `</div>`;
                            }

                            html += `<div style="margin-top:var(--space-sm);padding:0.5rem 0.65rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px">
                                <label class="modal-form-check" style="margin:0">
                                    <input type="checkbox" id="mf-push-secrets">
                                    <span style="font-weight:500">Push local vault secrets to GitHub now</span>
                                </label>
                                <div style="font-size:0.72rem;color:var(--text-muted);margin-top:4px;padding-left:24px">
                                    Syncs all vault keys. Use the <strong>üîê Secrets</strong> tab for granular per-key management.
                                </div>
                            </div>`;
                        }

                        el.innerHTML = html;
                    },
                    collect: (data) => {
                        // Collect which environments to create
                        const toCreate = [];
                        document.querySelectorAll('.gh-env-create:checked').forEach(cb => {
                            toCreate.push(cb.dataset.env);
                        });
                        data.envsToCreate = toCreate;
                        data.pushSecrets = document.getElementById('mf-push-secrets')?.checked || false;

                        // CODEOWNERS
                        const writeCodeowners = document.getElementById('mf-write-codeowners')?.checked || false;
                        if (writeCodeowners) {
                            const coContent = document.getElementById('mf-codeowners-content')?.value || '';
                            data.codeownersContent = coContent.trim();
                        } else {
                            data.codeownersContent = '';
                        }
                    },
                },

                // ‚îÄ‚îÄ Step 3: REVIEW & APPLY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
                {
                    id: 'review', title: 'Review',
                    render: (data, el) => {
                        let html = wizSection('Review', 'Confirm the actions to perform.');
                        html += `<div style="display:flex;flex-direction:column;gap:0.4rem;margin-bottom:var(--space-md)">`;

                        // Repository
                        const ghRepo = data._ghStatus?.repo;
                        html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.35rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                            <span style="width:22px;text-align:center">${ghRepo ? '‚úÖ' : '‚ö†Ô∏è'}</span>
                            <span style="flex:1">Repository: <strong>${ghRepo ? esc(ghRepo) : 'not linked'}</strong></span>
                            <span style="font-size:0.68rem;color:var(--text-muted)">${ghRepo ? '‚úì' : ''}</span>
                        </div>`;

                        // Environments to create
                        if ((data.envsToCreate || []).length > 0) {
                            for (const env of data.envsToCreate) {
                                html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.35rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                    <span style="width:22px;text-align:center">üÜï</span>
                                    <span style="flex:1">Create environment: <strong>${esc(env)}</strong></span>
                                    <span style="font-size:0.68rem;color:var(--accent)">NEW</span>
                                </div>`;
                            }
                        } else {
                            html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.35rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                <span style="width:22px;text-align:center">‚úÖ</span>
                                <span style="flex:1;color:var(--text-muted)">All environments aligned</span>
                                <span style="font-size:0.68rem;color:var(--success)">‚úì</span>
                            </div>`;
                        }

                        // Secrets push
                        html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.35rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                            <span style="width:22px;text-align:center">${data.pushSecrets ? '‚¨Ü' : '‚äò'}</span>
                            <span style="flex:1">Secrets push: <strong>${data.pushSecrets ? 'vault ‚Üí GitHub' : 'skipped'}</strong></span>
                            <span style="font-size:0.68rem;color:${data.pushSecrets ? 'var(--accent)' : 'var(--text-muted)'}">${data.pushSecrets ? 'PUSH' : '‚Äî'}</span>
                        </div>`;

                        // CODEOWNERS
                        if (data.codeownersContent) {
                            html += `<div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem;padding:0.35rem 0.5rem;border-radius:6px;background:var(--bg-inset)">
                                <span style="width:22px;text-align:center">üìã</span>
                                <span style="flex:1">Write CODEOWNERS: <strong>.github/CODEOWNERS</strong></span>
                                <span style="font-size:0.68rem;color:var(--accent)">WRITE</span>
                            </div>`;
                        }

                        html += `</div>`;

                        // Nothing to do?
                        const hasWork = (data.envsToCreate || []).length > 0 || data.pushSecrets || data.codeownersContent;
                        if (!hasWork) {
                            html += `<div style="text-align:center;padding:var(--space-sm);color:var(--success);font-size:0.85rem">
                                ‚úÖ Everything is already aligned! Nothing to apply.
                            </div>`;
                        }
                        // Next integration hint
                        html += `<div style="margin-top:var(--space-md);padding:var(--space-xs) var(--space-sm);border-left:3px solid var(--accent);background:color-mix(in srgb, var(--accent) 5%, transparent);border-radius:0 6px 6px 0">
                            <div style="font-size:0.78rem;color:var(--text-secondary)">
                                üí° <strong>Next:</strong> Set up Docker to containerize your application.
                                <button class="btn btn-sm btn-ghost" style="font-size:0.72rem;padding:0.1rem 0.4rem;margin-left:4px;color:var(--accent)"
                                    onclick="wizardModalClose();setTimeout(openDockerSetupWizard,300)">Set up Docker ‚Üí</button>
                            </div>
                        </div>`;

                        el.innerHTML = html;
                    },
                },
            ],

            onComplete: async (data) => {
                const envsToCreate = data.envsToCreate || [];
                const doPush = data.pushSecrets;
                const coContent = data.codeownersContent || '';
                const hasWork = envsToCreate.length > 0 || doPush || coContent;
                if (!hasWork) return;

                const parts = [];

                // 1. Create environments + write CODEOWNERS via setup_github
                if (envsToCreate.length > 0 || coContent) {
                    const payload = { action: 'setup_github' };
                    if (envsToCreate.length > 0) payload.create_environments = envsToCreate;
                    if (coContent) payload.codeowners_content = coContent;

                    const result = await apiPost('/wizard/setup', payload);
                    const r = result.results || {};
                    if ((r.environments_created || []).length > 0)
                        parts.push(`‚úÖ Created ${r.environments_created.length} env${r.environments_created.length !== 1 ? 's' : ''}: ${r.environments_created.join(', ')}`);
                    if ((r.environments_failed || []).length > 0)
                        parts.push(`‚ùå Failed: ${r.environments_failed.map(f => f.name + ' (' + f.error + ')').join(', ')}`);
                    if (r.codeowners_written)
                        parts.push('‚úÖ CODEOWNERS written');
                }

                // 2. Push secrets ‚Äî fetch vault keys and push like syncEnvToGithub
                if (doPush) {
                    try {
                        const localEnvs = data._localEnvs || [];
                        const multiEnv = localEnvs.length > 1;
                        const envNames = multiEnv ? localEnvs.map(e => e.name) : [''];

                        let totalPushed = 0;
                        for (const envName of envNames) {
                            const qs = envName ? `?env=${encodeURIComponent(envName)}` : '';
                            const keysData = await api(`/vault/keys${qs}`);
                            const keys = keysData.keys || [];

                            // Classify keys ‚Äî secrets use sync_keys (backend reads .env),
                            // variables send values directly
                            const variables = {};
                            const syncKeys = [];
                            const AUTO = ['GITHUB_TOKEN', 'GITHUB_REPOSITORY'];
                            for (const k of keys) {
                                if (!k.has_value) continue;
                                if (AUTO.includes(k.key)) continue;
                                if (k.local_only) continue;
                                if (k.kind === 'secret') {
                                    syncKeys.push(k.key);
                                } else if (k.value) {
                                    variables[k.key] = k.value;
                                }
                            }

                            const count = syncKeys.length + Object.keys(variables).length;
                            if (count === 0) continue;

                            const pushResult = await api(`/secrets/push${qs}`, {
                                method: 'POST',
                                body: JSON.stringify({
                                    variables,
                                    sync_keys: syncKeys,
                                    push_to_github: true,
                                    save_to_env: false,
                                }),
                            });

                            if (pushResult.error) {
                                parts.push(`‚ùå Secrets push${envName ? ` (${envName})` : ''}: ${pushResult.error}`);
                            } else {
                                const ok = (pushResult.results || []).filter(r => r.success).length;
                                totalPushed += ok;
                            }
                        }
                        if (totalPushed > 0) {
                            parts.push(`‚úÖ Pushed ${totalPushed} secret${totalPushed !== 1 ? 's' : ''} to GitHub`);
                        }
                    } catch (e) {
                        parts.push(`‚ùå Secrets push failed: ${e.message}`);
                    }
                }

                if (parts.length > 0) toast(parts.join('\n'), 'success');

                // Invalidate caches
                _projectStatusTS = 0;
                wizInvalidate('gh:detect');
                wizInvalidate('detect');
                cardInvalidate('github');
                if (typeof loadGitHubCard === 'function') loadGitHubCard();
            },
            successMessage: 'GitHub configuration applied!',
            finishLabel: '‚úÖ Apply Changes',
        });
    }

    // ‚îÄ‚îÄ Setup Modal Dispatcher ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Single function to open the right setup wizard by integration key.

    function openSetupWizard(key) {
        const wizards = {
            git: openGitSetupWizard,
            docker: openDockerSetupWizard,
            cicd: openCICDSetupWizard,
            k8s: openK8sSetupWizard,
            terraform: openTerraformSetupWizard,
            github: openGitHubSetupWizard,
            pages: () => {
                toast('Pages setup is available via the Pages card ‚Äî check the Integrations tab.', 'info');
                switchTab('integrations');
            },
            dns: () => {
                toast('DNS configuration wizard coming soon.', 'info');
            },
        };
        const fn = wizards[key];
        if (fn) fn();
        else toast(`No setup wizard for "${key}" yet`, 'warn');
    }
</script>
