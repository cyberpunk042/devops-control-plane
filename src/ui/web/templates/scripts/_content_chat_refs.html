/* _content_chat_refs.html ‚Äî @-reference autocomplete + embedding */

let _chatRefPhase = 0;
let _chatRefType = '';
let _chatRefSuggestions = [];
let _chatRefSelectedIdx = -1;
let _chatRefDebounceTimer = null;
let _chatRefPrefix = '';
let _chatRefStartPos = -1;
let _chatRefDismissed = false;
let _chatRefDismissedAt = -1;

const _chatRefCategories = [
  { type: 'commit',  icon: '&#x1F4DD;', label: 'Commit'  },
  { type: 'branch',  icon: '&#x1F500;', label: 'Branch'  },
  { type: 'audit',   icon: '&#x1F4CA;', label: 'Audit'   },
  { type: 'thread',  icon: '&#x1F4AC;', label: 'Thread'  },
  { type: 'trace',   icon: '&#x1F4CB;', label: 'Trace'   },
  { type: 'user',    icon: '&#x1F464;', label: 'User'    },
  { type: 'code',    icon: '&#x1F4BB;', label: 'Code'    },
  { type: 'doc',     icon: '&#x1F4C4;', label: 'Doc'     },
  { type: 'media',   icon: '&#x1F5BC;', label: 'Media'   },
  { type: 'release', icon: '&#x1F4E6;', label: 'Release' },
  { type: 'file',    icon: '&#x1F4C1;', label: 'File'    },
  { type: 'run',     icon: '&#x1F680;', label: 'Run'     }
];

/* ‚îÄ‚îÄ Item renderers ‚îÄ‚îÄ */

function _chatRefRenderCommit(item) {
  const div = document.createElement('div');
  div.className = 'chat-ref-item';
  div.setAttribute('data-ref', item.ref);
  const line1 = document.createElement('div');
  line1.className = 'chat-ref-item-label';
  const hashEl = document.createElement('span');
  hashEl.className = 'chat-ref-hash';
  hashEl.textContent = item.hash || '';
  const msgEl = document.createElement('span');
  msgEl.textContent = ' ' + (item.label || '');
  line1.appendChild(document.createTextNode(item.icon + ' '));
  line1.appendChild(hashEl);
  line1.appendChild(msgEl);
  const line2 = document.createElement('div');
  line2.className = 'chat-ref-item-detail';
  line2.textContent = item.detail || '';
  div.appendChild(line1);
  div.appendChild(line2);
  return div;
}

function _chatRefRenderGeneric(item) {
  if (typeof item === 'string') {
    const div = document.createElement('div');
    div.className = 'chat-ref-item';
    div.setAttribute('data-ref', item);
    const span = document.createElement('code');
    span.textContent = item;
    div.appendChild(span);
    return div;
  }
  const div = document.createElement('div');
  div.className = 'chat-ref-item';
  div.setAttribute('data-ref', item.ref);
  const line1 = document.createElement('div');
  line1.className = 'chat-ref-item-label';
  line1.textContent = (item.icon || '') + ' ' + (item.label || item.ref);
  const line2 = document.createElement('div');
  line2.className = 'chat-ref-item-detail';
  line2.textContent = item.detail || '';
  div.appendChild(line1);
  if (item.detail) {
    div.appendChild(line2);
  }
  return div;
}

const _chatRefRenderers = { 'commit': _chatRefRenderCommit };

function _chatRefRenderItem(item, type) {
  const renderer = _chatRefRenderers[type] || _chatRefRenderGeneric;
  return renderer(item);
}

/* ‚îÄ‚îÄ Trigger detection ‚îÄ‚îÄ */

function chatCheckRefTrigger(text, cursorPos) {
  const beforeCursor = text.substring(0, cursorPos);
  const atIdx = beforeCursor.lastIndexOf('@');
  if (atIdx === -1) {
    _chatRefHidePopup();
    return;
  }
  if (atIdx > 0 && !/[\s\n]/.test(beforeCursor[atIdx - 1])) {
    _chatRefHidePopup();
    return;
  }
  if (_chatRefDismissed && _chatRefDismissedAt === atIdx) {
    return;
  }
  if (_chatRefDismissedAt !== atIdx) {
    _chatRefDismissed = false;
  }
  const prefix = beforeCursor.substring(atIdx, cursorPos);
  _chatRefStartPos = atIdx;
  _chatRefPrefix = prefix;
  if (prefix === '@') {
    _chatRefShowCategories('');
    return;
  }
  const colonIdx = prefix.indexOf(':');
  if (colonIdx === -1) {
    _chatRefShowCategories(prefix.substring(1));
    return;
  }
  const refType = prefix.substring(1, colonIdx);
  const partialId = prefix.substring(colonIdx + 1);
  _chatRefType = refType;
  if (_chatRefDebounceTimer) {
    clearTimeout(_chatRefDebounceTimer);
  }
  _chatRefDebounceTimer = setTimeout(function() {
    _chatRefFetchItems(refType, partialId);
  }, 200);
}

/* ‚îÄ‚îÄ Phase 1: category grid ‚îÄ‚îÄ */

function _chatRefShowCategories(filter) {
  const popup = document.getElementById('chat-ref-popup');
  if (!popup) return;
  _chatRefPhase = 1;
  _chatRefType = '';
  _chatRefSuggestions = [];
  _chatRefSelectedIdx = -1;
  const filtered = [];
  const filterLower = filter ? filter.toLowerCase() : '';
  for (let i = 0; i < _chatRefCategories.length; i++) {
    const cat = _chatRefCategories[i];
    if (!filterLower || cat.type.indexOf(filterLower) === 0) {
      filtered.push(cat);
    }
  }
  if (filtered.length === 0) {
    popup.innerHTML = '<div class="chat-ref-empty">No matching types</div>';
    popup.style.display = 'block';
    return;
  }
  let html = '<div class="chat-ref-categories">';
  for (let j = 0; j < filtered.length; j++) {
    const c = filtered[j];
    _chatRefSuggestions.push(c);
    html += '<div class="chat-ref-category" data-idx="' + j + '" data-type="' + c.type + '">';
    html += '<span class="chat-ref-category-icon">' + c.icon + '</span>';
    html += '<span class="chat-ref-category-label">' + c.label + '</span>';
    html += '</div>';
  }
  html += '</div>';
  popup.innerHTML = html;
  popup.style.display = 'block';
  if (filtered.length === 1) {
    _chatRefSelectedIdx = 0;
    _chatRefUpdateHighlight();
  }
  const tiles = popup.querySelectorAll('.chat-ref-category');
  for (let k = 0; k < tiles.length; k++) {
    (function(el) {
      el.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        _chatRefSelectCategory(el.dataset.type);
      });
    })(tiles[k]);
  }
}

/* ‚îÄ‚îÄ Category selection ‚îÄ‚îÄ */

function _chatRefSelectCategory(type) {
  const input = document.getElementById('chat-compose-input');
  if (!input) return;
  const before = input.value.substring(0, _chatRefStartPos);
  const after = input.value.substring(input.selectionStart);
  input.value = before + '@' + type + ':' + after;
  const newPos = _chatRefStartPos + type.length + 2;
  input.selectionStart = newPos;
  input.selectionEnd = newPos;
  input.focus();
  _chatRefPrefix = '@' + type + ':';
  _chatRefType = type;
  _chatRefFetchItems(type, '');
}

/* ‚îÄ‚îÄ Phase 2: fetch + render items ‚îÄ‚îÄ */

function _chatRefFetchItems(type, partialId) {
  const popup = document.getElementById('chat-ref-popup');
  if (!popup) return;
  _chatRefPhase = 2;
  _chatRefSuggestions = [];
  _chatRefSelectedIdx = -1;
  let typeInfo = null;
  for (let i = 0; i < _chatRefCategories.length; i++) {
    if (_chatRefCategories[i].type === type) {
      typeInfo = _chatRefCategories[i];
      break;
    }
  }
  const typeLabel = typeInfo ? (typeInfo.icon + ' ' + typeInfo.label) : type;
  popup.innerHTML = '<div class="chat-ref-phase2-header">'
    + '<span class="chat-ref-phase2-title">' + typeLabel + '</span>'
    + '<span class="chat-ref-phase2-back" title="Back to categories">&times;</span>'
    + '</div>'
    + '<div class="chat-ref-loading">Loading...</div>';
  popup.style.display = 'block';
  const backBtn = popup.querySelector('.chat-ref-phase2-back');
  if (backBtn) {
    backBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      _chatRefGoBack();
    });
  }
  const prefix = '@' + type + ':' + (partialId || '');
  api('/chat/refs/autocomplete?prefix=' + encodeURIComponent(prefix)).then(function(data) {
    const suggestions = data.suggestions || [];
    if (suggestions.length === 0) {
      const loadEl = popup.querySelector('.chat-ref-loading');
      if (loadEl) {
        loadEl.className = 'chat-ref-empty';
        loadEl.textContent = 'No matches' + (partialId ? ' for "' + partialId + '"' : '');
      }
      return;
    }
    _chatRefSuggestions = suggestions;
    _chatRefSelectedIdx = -1;
    _chatRefRenderItems(popup, suggestions, type, typeLabel);
  }).catch(function() {
    const loadEl = popup.querySelector('.chat-ref-loading');
    if (loadEl) {
      loadEl.className = 'chat-ref-empty';
      loadEl.textContent = 'Error loading suggestions';
    }
  });
}

function _chatRefRenderItems(popup, suggestions, type, typeLabel) {
  popup.innerHTML = '<div class="chat-ref-phase2-header">'
    + '<span class="chat-ref-phase2-title">' + typeLabel + '</span>'
    + '<span class="chat-ref-phase2-back" title="Back to categories">&times;</span>'
    + '</div>'
    + '<div class="chat-ref-items"></div>';
  const backBtn = popup.querySelector('.chat-ref-phase2-back');
  if (backBtn) {
    backBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      _chatRefGoBack();
    });
  }
  const container = popup.querySelector('.chat-ref-items');

  // Audit type: separate by section (saved / log / unsaved)
  if (type === 'audit') {
  const savedItems = [];
  const unsavedItems = [];
  const logItems = [];
  for (let i = 0; i < suggestions.length; i++) {
    const item = suggestions[i];
    item._origIdx = i;
    if (item.section === 'saved') savedItems.push(item);
    else if (item.section === 'log') logItems.push(item);
    else if (item.section === 'unsaved') unsavedItems.push(item);
  }

  // Helper: render a list of items into the container
  function _renderAuditItems(items, sectionLabel) {
    if (sectionLabel) {
      const hdr = document.createElement('div');
      hdr.className = 'chat-ref-section-header';
      hdr.textContent = sectionLabel;
      container.appendChild(hdr);
    }
    for (let j = 0; j < items.length; j++) {
      const item = items[j];
      const idx = item._origIdx;
      const el = _chatRefRenderItem(item, type);
      el.setAttribute('data-idx', String(idx));
      const refVal = (typeof item === 'string') ? item : item.ref;
      el.setAttribute('data-ref', refVal);
      (function(refValue, idxVal, itemObj) {
        el.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          var text = refValue;
          var shouldEmbed = typeof itemObj === 'object'
            && itemObj.section && itemObj.section !== 'saved';
          if (shouldEmbed && itemObj.label) {
            var parts = [];
            if (itemObj.label) parts.push(itemObj.label);
            if (itemObj.detail) parts.push(itemObj.detail);
            if (itemObj.status) parts.push(itemObj.status);
            if (parts.length > 0) text = refValue + '{' + parts.join(' ¬∑ ') + '}';
          }
          chatInsertRef(text);
        });
        el.addEventListener('mouseenter', function() {
          _chatRefSelectedIdx = idxVal;
          _chatRefUpdateHighlight();
        });
      })(refVal, idx, item);
      container.appendChild(el);
    }
  }

  // Render: Saved ‚Üí Audit Log entry ‚Üí Unsaved
  if (savedItems.length > 0) {
    _renderAuditItems(savedItems, 'üìã Saved Audits');
  }

  // Clickable "Browse Audit Log" entry (between saved and unsaved)
  if (logItems.length > 0) {
    // Insert a placeholder into suggestions for keyboard navigation
    const logBrowseIdx = savedItems.length;  // right after saved items
    _chatRefSuggestions.splice(logBrowseIdx, 0, { _logBrowseAction: true, label: 'Browse Audit Log' });
    // Re-index all items after the splice
    for (let si = logBrowseIdx + 1; si < _chatRefSuggestions.length; si++) {
      if (_chatRefSuggestions[si]._origIdx !== undefined) {
        _chatRefSuggestions[si]._origIdx = si;
      }
    }

    const logEntry = document.createElement('div');
    logEntry.className = 'chat-ref-item';
    logEntry.setAttribute('data-log-browse', '1');
    logEntry.setAttribute('data-idx', String(logBrowseIdx));
    logEntry.style.cssText = 'cursor:pointer;display:flex;align-items:center;gap:0.5rem;padding:8px 12px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin:4px 0;';
    logEntry.innerHTML = '<span style="font-size:1rem">üìä</span>'
      + '<span style="font-size:0.82rem;color:var(--text-primary);font-weight:500">Browse Audit Log</span>'
      + '<span style="font-size:0.68rem;color:var(--text-muted);margin-left:auto">' + logItems.length + ' entries ‚Üí</span>';
    logEntry.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      // Replace dropdown content with log items
      container.innerHTML = '';
      // Update suggestions to only log items for keyboard nav
      _chatRefSuggestions = logItems;
      _chatRefSelectedIdx = -1;
      var backLink = document.createElement('div');
      backLink.className = 'chat-ref-section-header';
      backLink.style.cssText = 'cursor:pointer;color:var(--accent);';
      backLink.textContent = '‚Üê Back to all audits';
      backLink.addEventListener('click', function(ev) {
        ev.preventDefault();
        ev.stopPropagation();
        container.innerHTML = '';
        _chatRefRenderItems(popup, suggestions, type, typeLabel);
      });
      container.appendChild(backLink);
      _renderAuditItems(logItems, 'üìä Audit Log');
    });
    logEntry.addEventListener('mouseenter', function() {
      _chatRefSelectedIdx = logBrowseIdx;
      _chatRefUpdateHighlight();
    });
    container.appendChild(logEntry);
  }

  if (unsavedItems.length > 0) {
    _renderAuditItems(unsavedItems, '‚è≥ Unsaved (Pending)');
  }

  // end audit block
  } else {
  // Non-audit types: flat rendering with pre-embedding
    for (let i = 0; i < suggestions.length; i++) {
      const item = suggestions[i];
      const el = _chatRefRenderItem(item, type);
      el.setAttribute('data-idx', String(i));
      const refVal = (typeof item === 'string') ? item : item.ref;
      el.setAttribute('data-ref', refVal);
      (function(refValue, idx, itemObj) {
        el.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          var text = refValue;
          if (typeof itemObj === 'object' && itemObj.label) {
            var parts = [];
            if (itemObj.label) parts.push(itemObj.label);
            if (itemObj.detail) parts.push(itemObj.detail);
            if (itemObj.status) parts.push(itemObj.status);
            if (parts.length > 0) text = refValue + '{' + parts.join(' ¬∑ ') + '}';
          }
          chatInsertRef(text);
        });
        el.addEventListener('mouseenter', function() {
          _chatRefSelectedIdx = idx;
          _chatRefUpdateHighlight();
        });
      })(refVal, i, item);
      container.appendChild(el);
    }
  } // end if/else audit vs flat
}

/* ‚îÄ‚îÄ Go back to phase 1 ‚îÄ‚îÄ */

function _chatRefGoBack() {
  const input = document.getElementById('chat-compose-input');
  if (input && _chatRefStartPos >= 0) {
    const before = input.value.substring(0, _chatRefStartPos);
    const after = input.value.substring(input.selectionStart);
    input.value = before + '@' + after;
    const newPos = _chatRefStartPos + 1;
    input.selectionStart = newPos;
    input.selectionEnd = newPos;
    input.focus();
    _chatRefPrefix = '@';
  }
  _chatRefShowCategories('');
}

/* ‚îÄ‚îÄ Keyboard navigation ‚îÄ‚îÄ */

function chatRefKeydown(event) {
  const popup = document.getElementById('chat-ref-popup');
  if (!popup || popup.style.display === 'none') return;
  if (event.key === 'ArrowDown') {
    event.preventDefault();
    if (_chatRefSuggestions.length > 0) {
      _chatRefSelectedIdx = Math.min(_chatRefSelectedIdx + 1, _chatRefSuggestions.length - 1);
      _chatRefUpdateHighlight();
    }
    return;
  }
  if (event.key === 'ArrowUp') {
    event.preventDefault();
    if (_chatRefSuggestions.length > 0) {
      _chatRefSelectedIdx = Math.max(_chatRefSelectedIdx - 1, 0);
      _chatRefUpdateHighlight();
    }
    return;
  }
  if (event.key === 'Tab') {
    if (_chatRefSuggestions.length > 0) {
      event.preventDefault();
      if (_chatRefSelectedIdx < 0) {
        _chatRefSelectedIdx = 0;
      }
      _chatRefPickSelected();
    }
    return;
  }
  if (event.key === 'Enter' && _chatRefSelectedIdx >= 0) {
    event.preventDefault();
    _chatRefPickSelected();
    return;
  }
  if (event.key === 'Escape') {
    event.preventDefault();
    if (_chatRefPhase === 2) {
      _chatRefGoBack();
    } else {
      _chatRefDismissed = true;
      _chatRefDismissedAt = _chatRefStartPos;
      _chatRefHidePopup();
    }
    return;
  }
}

function _chatRefPickSelected() {
  const selected = _chatRefSuggestions[_chatRefSelectedIdx];
  if (!selected) return;
  if (_chatRefPhase === 1) {
    if (selected.type) {
      _chatRefSelectCategory(selected.type);
    }
  } else {
    /* Special: Browse Audit Log entry */
    if (selected._logBrowseAction) {
      const popup = document.getElementById('chat-ref-popup');
      if (popup) {
        const logBtn = popup.querySelector('[data-log-browse]');
        if (logBtn) logBtn.click();
      }
      return;
    }
    const refVal = (typeof selected === 'string') ? selected : selected.ref;
    if (refVal && refVal.endsWith('/')) {
      const input = document.getElementById('chat-compose-input');
      if (input) {
        const before = input.value.substring(0, _chatRefStartPos);
        const after = input.value.substring(input.selectionStart);
        input.value = before + refVal + after;
        const newPos = _chatRefStartPos + refVal.length;
        input.selectionStart = newPos;
        input.selectionEnd = newPos;
        input.focus();
        _chatRefPrefix = refVal;
        const colonIdx = refVal.indexOf(':');
        const refType = refVal.substring(1, colonIdx);
        const partialId = refVal.substring(colonIdx + 1);
        _chatRefType = refType;
        _chatRefFetchItems(refType, partialId);
      }
    } else {
      /* Pre-embed: all items with label, except saved audits (resolvable from git) */
      var embedText = refVal;
      var shouldEmbed = typeof selected === 'object'
        && selected.label && !(selected.section === 'saved');
      if (shouldEmbed && selected.label) {
        var parts = [];
        if (selected.label) parts.push(selected.label);
        if (selected.detail) parts.push(selected.detail);
        if (selected.status) parts.push(selected.status);
        if (parts.length > 0) {
          embedText = refVal + '{' + parts.join(' ¬∑ ') + '}';
        }
      }
      chatInsertRef(embedText);
    }
  }
}

/* ‚îÄ‚îÄ Highlight management ‚îÄ‚îÄ */

function _chatRefUpdateHighlight() {
  const popup = document.getElementById('chat-ref-popup');
  if (!popup) return;
  let items;
  if (_chatRefPhase === 1) {
    items = popup.querySelectorAll('.chat-ref-category');
  } else {
    items = popup.querySelectorAll('.chat-ref-item');
  }
  for (let i = 0; i < items.length; i++) {
    if (i === _chatRefSelectedIdx) {
      items[i].classList.add('chat-ref-active');
    } else {
      items[i].classList.remove('chat-ref-active');
    }
  }
  if (_chatRefSelectedIdx >= 0 && items[_chatRefSelectedIdx]) {
    items[_chatRefSelectedIdx].scrollIntoView({ block: 'nearest' });
  }
}

/* ‚îÄ‚îÄ Insert ref + hide popup ‚îÄ‚îÄ */

function chatInsertRef(ref) {
  const input = document.getElementById('chat-compose-input');
  if (!input || _chatRefStartPos < 0) return;
  if (ref && ref.endsWith('/')) {
    const before = input.value.substring(0, _chatRefStartPos);
    const after = input.value.substring(input.selectionStart);
    input.value = before + ref + after;
    const np = _chatRefStartPos + ref.length;
    input.selectionStart = np;
    input.selectionEnd = np;
    input.focus();
    _chatRefPrefix = ref;
    const ci = ref.indexOf(':');
    const rt = ref.substring(1, ci);
    const pi = ref.substring(ci + 1);
    _chatRefType = rt;
    _chatRefFetchItems(rt, pi);
    return;
  }
  const before = input.value.substring(0, _chatRefStartPos);
  const after = input.value.substring(input.selectionStart);
  input.value = before + ref + ' ' + after;
  const newPos = _chatRefStartPos + ref.length + 1;
  input.selectionStart = newPos;
  input.selectionEnd = newPos;
  input.focus();
  _chatRefHidePopup();
}

function _chatRefHidePopup() {
  const popup = document.getElementById('chat-ref-popup');
  if (popup) popup.style.display = 'none';
  _chatRefPhase = 0;
  _chatRefType = '';
  _chatRefSuggestions = [];
  _chatRefSelectedIdx = -1;
  _chatRefPrefix = '';
  _chatRefStartPos = -1;
  if (_chatRefDebounceTimer) {
    clearTimeout(_chatRefDebounceTimer);
    _chatRefDebounceTimer = null;
  }
}

/* ‚îÄ‚îÄ Ref Embedding ‚îÄ‚îÄ */

const _REF_CHIP_ICONS = {
  'commit':  '&#x1F4DD;',
  'branch':  '&#x1F500;',
  'run':     '&#x1F680;',
  'thread':  '&#x1F4AC;',
  'trace':   '&#x1F4CB;',
  'audit':   '&#x1F4CA;',
  'user':    '&#x1F464;',
  'code':    '&#x1F4BB;',
  'doc':     '&#x1F4C4;',
  'media':   '&#x1F5BC;',
  'release': '&#x1F4E6;',
  'file':    '&#x1F4C1;'
};

function _chatEmbedRefs(escapedText) {
  /* Match @type:id  OR  @type:id{embedded data} */
  const refPat = /@(run|thread|trace|user|commit|branch|audit|code|doc|media|release|file):([A-Za-z0-9_:\-\/.]+?)(?:\{([^}]*)\})?(?=[\s,;!?)\]"']|&amp;|&lt;|$)/g;
  let mediaEmbeds = '';
  const html = escapedText.replace(refPat, function(match, refType, refId, embedded) {
    const icon = _REF_CHIP_ICONS[refType] || '&#x1F517;';
    const chipClass = 'chat-ref-chip chat-ref-chip-' + refType;
    /* Use embedded data for label if present, otherwise short label */
    var label = embedded ? embedded : _chatRefShortLabel(refType, refId);
    var tooltip = embedded
      ? esc('@' + refType + ':' + refId) + '\n' + embedded
      : esc('@' + refType + ':' + refId);
    if (refType === 'media') {
      const ext = refId.split('.').pop().toLowerCase();
      const isImg = ['jpg','jpeg','png','gif','webp','svg','bmp','ico'].indexOf(ext) >= 0;
      const isVid = ['mp4','webm','mov'].indexOf(ext) >= 0;
      const isAud = ['mp3','wav','ogg','flac','aac','m4a'].indexOf(ext) >= 0;
      const dlUrl = '/api/content/download?path=' + encodeURIComponent(refId);
      if (isImg) {
        mediaEmbeds += '<div class="chat-ref-media-embed">'
          + '<img src="' + dlUrl + '" alt="' + esc(refId) + '" class="chat-ref-media-img"'
          + ' onclick="chatRefClickMedia(\'' + esc(refId) + '\')" title="Click to preview">'
          + '</div>';
      } else if (isVid) {
        mediaEmbeds += '<div class="chat-ref-media-embed">'
          + '<video controls class="chat-ref-media-video" preload="metadata">'
          + '<source src="' + dlUrl + '">'
          + '</video></div>';
      } else if (isAud) {
        mediaEmbeds += '<div class="chat-ref-media-embed">'
          + '<audio controls class="chat-ref-media-audio" preload="metadata">'
          + '<source src="' + dlUrl + '">'
          + '</audio></div>';
      }
    }
    return '<span class="' + chipClass + '"'
      + ' onclick="chatRefClick(\'' + refType + '\', \'' + esc(refId) + '\')"'
      + ' title="' + tooltip + '">'
      + '<span class="chat-ref-chip-icon">' + icon + '</span>'
      + '<span class="chat-ref-chip-label">' + esc(label) + '</span>'
      + '</span>';
  });
  return { html: html, mediaEmbeds: mediaEmbeds };
}

function _chatRefShortLabel(refType, refId) {
  if (refType === 'commit') {
    return refId.length > 8 ? refId.substring(0, 8) : refId;
  }
  if (refType === 'code' || refType === 'doc' || refType === 'file' || refType === 'media') {
    const parts = refId.split('/');
    return parts[parts.length - 1];
  }
  if (refType === 'release' && refId.indexOf('/') >= 0) {
    const rp = refId.split('/');
    return rp[0] + '/' + rp.slice(1).join('/');
  }
  if (refType === 'user') {
    return '@' + refId;
  }
  if (refType === 'thread' && refId.length > 16) {
    return refId.substring(0, 16) + '&hellip;';
  }
  return refId;
}

/* ‚îÄ‚îÄ Per-type click handlers ‚îÄ‚îÄ */

function chatRefClick(refType, refId) {
  const ref = '@' + refType + ':' + refId;
  if (refType === 'thread') {
    if (typeof chatSelectThread === 'function') {
      chatSelectThread(refId);
    }
    return;
  }
  if (refType === 'code' || refType === 'doc' || refType === 'file') {
    if (typeof openFileInModal === 'function') {
      openFileInModal(refId);
    }
    return;
  }
  if (refType === 'release') {
    api('/chat/refs/resolve?ref=' + encodeURIComponent(ref)).then(function(data) {
      if (!data.exists) {
        modalOpen({
          title: 'üì¶ Release Asset Not Found',
          body: '<div class="chat-ref-modal-detail">'
            + '<p>Could not resolve <code>' + esc(ref) + '</code></p>'
            + (data.error ? '<p class="chat-ref-modal-error">' + esc(data.error) + '</p>' : '')
            + '</div>'
        });
        return;
      }
      var b = '<div class="chat-ref-modal-detail">';
      if (data.tag) b += _row('Release', data.tag);
      if (data.asset_name) b += _row('Asset', data.asset_name);
      if (data.size_str) b += _row('Size', data.size_str);
      if (data.content_type) b += _row('Type', data.content_type);
      if (data.download_url) b += '<div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Download</span><span class="chat-ref-modal-val"><a href="' + esc(data.download_url) + '" target="_blank" rel="noopener">GitHub ‚Üí</a></span></div>';
      if (data.local_path) b += '<div class="chat-ref-modal-row"><span class="chat-ref-modal-key">Local</span><span class="chat-ref-modal-val"><a href="#" onclick="openFileInModal(\'' + esc(data.local_path) + '\');return false;">' + esc(data.local_path) + '</a></span></div>';
      b += '</div>';
      modalOpen({ title: 'üì¶ Release: ' + esc(data.asset_name || data.tag || refId), body: b });
    }).catch(function(e) {
      modalOpen({
        title: '&#x274C; Error',
        body: '<p>Failed to resolve <code>' + esc(ref) + '</code>: ' + esc(e.message) + '</p>'
      });
    });
    return;
  }
  if (refType === 'media') {
    chatRefClickMedia(refId);
    return;
  }
  if (refType === 'audit') {
    // Try resolve first (saved snapshots / pending)
    api('/chat/refs/resolve?ref=' + encodeURIComponent(ref)).then(function(data) {
      if (data.error || !data.exists) {
        // Not in ledger/pending ‚Äî show embedded info from the chip tooltip
        var chip = document.querySelector('.chat-ref-chip[title*="' + refId.replace(/'/g, '') + '"]');
        var tooltip = chip ? chip.getAttribute('title') : '';
        var embedded = '';
        if (tooltip && tooltip.indexOf('\n') >= 0) {
          embedded = tooltip.substring(tooltip.indexOf('\n') + 1);
        }
        if (embedded) {
          var parts = embedded.split(' ¬∑ ');
          var b = '<div class="chat-ref-modal-detail">';
          for (var pi = 0; pi < parts.length; pi++) {
            b += _row(pi === 0 ? 'Info' : '', parts[pi]);
          }
          b += '</div>';
          modalOpen({ title: 'üìä Audit Log: ' + esc(refId), body: b });
        } else {
          modalOpen({
            title: 'üìä Audit Log Entry',
            body: '<div class="chat-ref-modal-detail">'
              + _row('Reference', ref)
              + '<p style="color:var(--text-muted);font-size:0.82rem;margin-top:0.5rem">This is an activity log entry. Data is embedded in the message text.</p>'
              + '</div>'
          });
        }
        return;
      }
      _chatRefOpenModal(refType, refId, data);
    }).catch(function(e) {
      modalOpen({
        title: '&#x274C; Error',
        body: '<p>Failed to resolve <code>' + esc(ref) + '</code>: ' + esc(e.message) + '</p>'
      });
    });
    return;
  }
  api('/chat/refs/resolve?ref=' + encodeURIComponent(ref)).then(function(data) {
    if (data.error || !data.exists) {
      var ep = data.error
        ? '<p class="chat-ref-modal-error">' + esc(data.error) + '</p>'
        : '';
      modalOpen({
        title: (_REF_CHIP_ICONS[refType] || '') + ' Reference Not Found',
        body: '<div class="chat-ref-modal-empty">'
          + '<p>Could not resolve <code>' + esc(ref) + '</code></p>'
          + ep + '</div>'
      });
      return;
    }
    _chatRefOpenModal(refType, refId, data);
  }).catch(function(e) {
    modalOpen({
      title: '&#x274C; Error',
      body: '<p>Failed to resolve <code>' + esc(ref) + '</code>: ' + esc(e.message) + '</p>'
    });
  });
}

function chatRefClickMedia(refId) {
  if (typeof openFileInModal === 'function') {
    openFileInModal(refId);
  }
}

/* ‚îÄ‚îÄ Ref modal ‚îÄ‚îÄ */

function _row(k, v, tag) {
  tag = tag || 'span';
  return '<div class="chat-ref-modal-row">'
    + '<span class="chat-ref-modal-key">' + esc(k) + '</span>'
    + '<' + tag + ' class="chat-ref-modal-val">' + esc(v) + '</' + tag + '>'
    + '</div>';
}

/* ‚îÄ‚îÄ Recursive audit data renderer ‚îÄ‚îÄ */
function _renderAuditData(obj, depth) {
  depth = depth || 0;
  if (!obj || typeof obj !== 'object') return '';
  var html = '';
  var keys = Object.keys(obj);
  for (var i = 0; i < keys.length; i++) {
    var k = keys[i];
    if (k === '_cache') continue;  // skip internal cache
    var v = obj[k];
    if (v === null || v === undefined) continue;
    if (Array.isArray(v)) {
      html += '<div style="margin-top:0.75rem;padding-left:' + (depth * 12) + 'px">'
        + '<div style="font-weight:600;font-size:0.82rem;color:var(--text-primary);margin-bottom:0.25rem">'
        + esc(k) + ' <span style="color:var(--text-muted);font-weight:400">(' + v.length + ')</span></div>';
      if (v.length === 0) {
        html += '<span style="color:var(--text-muted);font-size:0.78rem">‚Äî</span>';
      } else if (typeof v[0] === 'object' && v[0] !== null) {
        // Array of objects ‚Äî render each as a mini block
        for (var ai = 0; ai < Math.min(v.length, 50); ai++) {
          html += '<div style="border-left:2px solid var(--border);padding-left:8px;margin:4px 0;font-size:0.78rem">';
          html += _renderAuditData(v[ai], depth + 1);
          html += '</div>';
        }
        if (v.length > 50) {
          html += '<div style="color:var(--text-muted);font-size:0.72rem">... and ' + (v.length - 50) + ' more</div>';
        }
      } else {
        // Array of primitives ‚Äî comma-separated
        var items = [];
        for (var pi = 0; pi < Math.min(v.length, 100); pi++) {
          items.push(esc(String(v[pi])));
        }
        html += '<div style="font-size:0.78rem;color:var(--text-secondary);word-break:break-word">'
          + items.join(', ')
          + (v.length > 100 ? ' ... +' + (v.length - 100) + ' more' : '')
          + '</div>';
      }
      html += '</div>';
    } else if (typeof v === 'object') {
      html += '<div style="margin-top:0.75rem;padding-left:' + (depth * 12) + 'px">'
        + '<div style="font-weight:600;font-size:0.82rem;color:var(--text-primary);margin-bottom:0.25rem;border-bottom:1px solid var(--border);padding-bottom:2px">'
        + esc(k) + '</div>'
        + _renderAuditData(v, depth + 1)
        + '</div>';
    } else {
      // Primitive value
      html += '<div style="display:flex;gap:0.5rem;padding:2px ' + (depth * 12) + 'px;font-size:0.78rem">'
        + '<span style="color:var(--text-muted);min-width:120px;flex-shrink:0">' + esc(k) + '</span>'
        + '<span style="color:var(--text-primary);word-break:break-word">' + esc(String(v)) + '</span>'
        + '</div>';
    }
  }
  return html;
}

function _chatRefOpenModal(rt, ri, d) {
  let t = (_REF_CHIP_ICONS[rt] || '') + ' ';
  let b = '';

  if (rt === 'commit') {
    t += 'Commit ' + (d.short_hash || ri);
    b = '<div class="chat-ref-modal-detail">'
      + _row('Hash', d.hash || ri, 'code')
      + _row('Message', d.message || '')
      + _row('Author', d.author || '')
      + _row('Date', d.date || '')
      + '</div>';
  } else if (rt === 'branch') {
    t += 'Branch: ' + ri;
    b = '<div class="chat-ref-modal-detail">'
      + _row('Branch', ri)
      + _row('HEAD SHA', d.sha || '', 'code')
      + '</div>';
  } else if (rt === 'trace') {
    t += 'Trace: ' + (d.name || ri);
    b = '<div class="chat-ref-modal-detail">'
      + _row('Name', d.name || '')
      + _row('Classification', d.classification || '')
      + _row('Started', d.started_at || '');
    if (d.auto_summary) {
      b += _row('Summary', d.auto_summary);
    }
    b += '</div>';
  } else if (rt === 'run') {
    var runLabel = d.subtype || d.run_type || ri;
    var durStr = d.duration_ms ? (d.duration_ms / 1000).toFixed(1) + 's' : '';
    t += 'Run: ' + runLabel;
    b = '<div class="chat-ref-modal-detail">'
      + _row('Type', d.run_type || '')
      + _row('Subtype', d.subtype || '')
      + _row('Status', d.status || '')
      + _row('Summary', d.summary || '')
      + _row('Started', d.started_at || '')
      + _row('Duration', durStr)
      + (d.code_ref ? _row('Commit', d.code_ref, 'code') : '')
      + '</div>';
  } else if (rt === 'audit') {
    if (d.source === 'ledger' || d.source === 'pending') {
      t += (d.source === 'pending' ? 'Pending Audit: ' : 'Audit Snapshot: ') + (d.card_key || ri);
      b = '<div class="chat-ref-modal-detail">'
        + _row('Card', d.card_key || '')
        + _row('Summary', d.summary || '')
        + _row('Status', d.status || '')
        + _row('Timestamp', d.timestamp || '')
        + _row('Duration', d.duration_s ? d.duration_s + 's' : '')
        + '</div>';
      // Render full data payload
      if (d.data && typeof d.data === 'object') {
        b += _renderAuditData(d.data);
      }
    } else {
      t += 'Audit: ' + (d.operation_type || ri);
      b = '<div class="chat-ref-modal-detail">'
        + _row('Operation', d.operation_type || '')
        + _row('Status', d.status || '')
        + _row('Automation', d.automation || '')
        + _row('Timestamp', d.timestamp || '')
        + '</div>';
    }
  } else if (rt === 'user') {
    t += '@' + ri;
    b = '<div class="chat-ref-modal-detail">'
      + _row('User', d.name || ri)
      + '</div>';
  } else if (rt === 'release') {
    t += 'Release: ' + ri;
    b = '<div class="chat-ref-modal-detail">';
    const ks = Object.keys(d);
    for (let i = 0; i < ks.length; i++) {
      if (ks[i] === 'type') continue;
      if (ks[i] === 'ref') continue;
      const v = d[ks[i]];
      const dv = (typeof v === 'object') ? JSON.stringify(v) : String(v);
      b += _row(ks[i], dv);
    }
    b += '</div>';
  } else {
    t += rt + ': ' + ri;
    b = '<div class="chat-ref-modal-detail">';
    const k2 = Object.keys(d);
    for (let j = 0; j < k2.length; j++) {
      if (k2[j] === 'type') continue;
      if (k2[j] === 'ref') continue;
      const v = d[k2[j]];
      const dv = (typeof v === 'object') ? JSON.stringify(v) : String(v);
      b += _row(k2[j], dv);
    }
    b += '</div>';
  }

  modalOpen({ title: t, body: b });
}