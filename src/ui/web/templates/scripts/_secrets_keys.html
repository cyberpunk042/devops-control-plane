    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //  _secrets_keys.html
    //  Move key between sections, add/create keys modal, env entry management
    //  Template picker for .env creation
    //  Included by: _secrets.html (Jinja2 include)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€



    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Move key between sections
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showMoveKeyMenu(event, keyName) {
        event.stopPropagation();

        // Remove any existing menu
        const existing = document.getElementById('move-key-menu');
        if (existing) existing.remove();

        const menu = document.createElement('div');
        menu.id = 'move-key-menu';
        menu.style.cssText = `position:fixed;z-index:1000;background:var(--bg-card);border:1px solid var(--border);border-radius:6px;box-shadow:0 4px 16px rgba(0,0,0,0.4);padding:var(--space-xs) 0;min-width:180px;max-height:260px;overflow-y:auto;font-size:0.85rem;`;

        const rect = event.target.getBoundingClientRect();
        menu.style.left = rect.left + 'px';
        menu.style.top = (rect.bottom + 4) + 'px';

        let items = '';
        for (const s of envSections) {
            items += `<div class="move-key-item" style="padding:0.35rem 0.75rem;cursor:pointer;white-space:nowrap;" onmouseenter="this.style.background='var(--hover)'" onmouseleave="this.style.background=''" onclick="moveKeyToSection('${esc(keyName)}', '${esc(s)}')">${esc(s)}</div>`;
        }
        items += `<div style="border-top:1px solid var(--border);margin:0.2rem 0"></div>`;
        items += `<div class="move-key-item" style="padding:0.35rem 0.75rem;cursor:pointer;color:var(--primary);white-space:nowrap;" onmouseenter="this.style.background='var(--hover)'" onmouseleave="this.style.background=''" onclick="moveKeyNewSection('${esc(keyName)}')">+ New sectionâ€¦</div>`;

        menu.innerHTML = items;
        document.body.appendChild(menu);

        // Close on click outside
        const closeMenu = (e) => {
            if (!menu.contains(e.target)) {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            }
        };
        setTimeout(() => document.addEventListener('click', closeMenu), 0);
    }

    async function moveKeyToSection(keyName, section) {
        const menu = document.getElementById('move-key-menu');
        if (menu) menu.remove();

        try {
            await api(`/vault/move-key${_envQS()}`, {
                method: 'POST',
                body: JSON.stringify({ key: keyName, section }),
            });
            toast(`${keyName} â†’ ${section}`, 'success');
            secretsLoaded = false;
            await loadSecretsTab();
            selectTarget(currentTarget);
        } catch (e) {
            toast(`Failed to move ${keyName}: ${e.message}`, 'error');
        }
    }

    function moveKeyNewSection(keyName) {
        const menu = document.getElementById('move-key-menu');
        if (menu) menu.remove();

        const name = prompt('New section name:');
        if (name && name.trim()) {
            moveKeyToSection(keyName, name.trim());
        }
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Add / Create keys modal
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let _addKeysMode = 'create';

    function showAddKeysModal(mode) {
        _addKeysMode = mode;
        const isCreate = mode === 'create';
        const envFile = _envFile();
        const title = isCreate ? `âœ¨ Create ${envFile}` : `âœ¨ Add Keys to ${envFile}`;
        const desc = isCreate
            ? 'Add your environment variables below. You can lock it with the vault afterwards.'
            : 'Add new key-value pairs to your existing .env file.';
        const btnLabel = isCreate ? 'Create' : 'Add Keys';

        // Build section options
        let sectionOptions = '<option value="">â€” append to end â€”</option>';
        for (const s of envSections) {
            sectionOptions += `<option value="${esc(s)}">${esc(s)}</option>`;
        }
        sectionOptions += '<option value="__new__">+ Create new sectionâ€¦</option>';

        const sectionSelector = !isCreate ? `
            <div class="form-group" style="margin-bottom:var(--space-md)">
                <label for="env-section-select">Section</label>
                <select id="env-section-select" style="width:100%" onchange="onSectionSelectChange(this)">
                    ${sectionOptions}
                </select>
                <input type="text" id="env-section-new" placeholder="New section nameâ€¦"
                    style="display:none;margin-top:var(--space-xs)" autocomplete="off">
            </div>` : '';

        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'vault-modal';
        modal.innerHTML = `
        <div class="vault-modal" style="max-width:580px">
            <h2 style="margin-bottom:var(--space-md)">${title}</h2>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-md);font-size:0.88rem;line-height:1.5">
                ${desc}
            </p>

            <!-- Generator tab bar -->
            <div id="gen-tabs" style="display:flex;gap:0;border:1px solid var(--border);border-radius:8px;overflow:hidden;margin-bottom:var(--space-lg);font-size:0.82rem">
                <button type="button" class="gen-tab active" onclick="switchGenTab('manual')" style="flex:1;padding:0.4rem;background:var(--accent);color:#fff;border:none;cursor:pointer;font-size:0.78rem;font-weight:600">âœï¸ Manual</button>
                <button type="button" class="gen-tab" onclick="switchGenTab('password')" style="flex:1;padding:0.4rem;background:var(--bg-card);color:var(--text-secondary);border:none;border-left:1px solid var(--border);cursor:pointer;font-size:0.78rem">ğŸ”‘ Password</button>
                <button type="button" class="gen-tab" onclick="switchGenTab('ssh')" style="flex:1;padding:0.4rem;background:var(--bg-card);color:var(--text-secondary);border:none;border-left:1px solid var(--border);cursor:pointer;font-size:0.78rem">ğŸ” SSH Key</button>
                <button type="button" class="gen-tab" onclick="switchGenTab('cert')" style="flex:1;padding:0.4rem;background:var(--bg-card);color:var(--text-secondary);border:none;border-left:1px solid var(--border);cursor:pointer;font-size:0.78rem">ğŸ“œ Cert</button>
                <button type="button" class="gen-tab" onclick="switchGenTab('token')" style="flex:1;padding:0.4rem;background:var(--bg-card);color:var(--text-secondary);border:none;border-left:1px solid var(--border);cursor:pointer;font-size:0.78rem">ğŸ« Token</button>
            </div>

            <!-- Manual tab -->
            <div id="gen-manual">
                ${sectionSelector}
                <div id="env-entries">
                    <div class="env-entry-row">
                        <input type="text" class="env-entry-key" placeholder="KEY" autocomplete="off">
                        <input type="text" class="env-entry-value" placeholder="value" autocomplete="off">
                        <select class="env-entry-type" style="width:auto;min-width:80px;font-size:0.72rem;padding:0.25rem 0.3rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary);flex-shrink:0" title="Key type" onchange="onEntryTypeChange(this)">
                            <option value="text">ğŸ“ text</option>
                            <option value="password">ğŸ”’ password</option>
                            <option value="toggle">ğŸ”˜ toggle</option>
                            <option value="select">ğŸ“‹ enum</option>
                            <option value="base64">ğŸ” base64</option>
                        </select>
                        <input type="text" class="env-entry-options" placeholder="opt1,opt2,opt3" style="display:none;width:100px;font-size:0.72rem;padding:0.25rem 0.3rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)" title="Comma-separated options">
                        <button class="btn-icon" onclick="removeEnvEntry(this)" title="Remove">âœ•</button>
                    </div>
                </div>
                <button class="btn btn-ghost" onclick="addEnvEntry()" style="margin-top:var(--space-sm);font-size:0.82rem">
                    + Add another
                </button>
            </div>

            <!-- Password tab -->
            <div id="gen-password" style="display:none">
                <div class="form-group" style="margin-bottom:var(--space-md)">
                    <label>Key Name</label>
                    <input type="text" id="gen-pwd-key" placeholder="DB_PASSWORD" autocomplete="off" style="width:100%">
                </div>
                <div class="form-group" style="margin-bottom:var(--space-md)">
                    <label>Length: <span id="gen-pwd-len-label">32</span></label>
                    <input type="range" id="gen-pwd-len" min="8" max="128" value="32" style="width:100%" oninput="document.getElementById('gen-pwd-len-label').textContent=this.value">
                </div>
                <button class="btn btn-secondary btn-sm" type="button" onclick="previewGenerate('password')" style="margin-bottom:var(--space-sm)">âš¡ Generate Preview</button>
                <pre id="gen-pwd-preview" style="background:var(--bg-inset);padding:0.75rem;border-radius:6px;font-size:0.78rem;min-height:2rem;border:1px solid var(--border-subtle);word-break:break-all"></pre>
            </div>

            <!-- SSH Key tab -->
            <div id="gen-ssh" style="display:none">
                <div class="form-group" style="margin-bottom:var(--space-md)">
                    <label>Key Name (private key)</label>
                    <input type="text" id="gen-ssh-key" placeholder="SSH_DEPLOY_KEY" autocomplete="off" style="width:100%">
                </div>
                <div class="form-group" style="margin-bottom:var(--space-md)">
                    <label>Algorithm</label>
                    <div style="display:flex;gap:0.5rem">
                        <label style="display:flex;align-items:center;gap:0.25rem;cursor:pointer"><input type="radio" name="gen-ssh-algo" value="ssh-ed25519" checked> Ed25519</label>
                        <label style="display:flex;align-items:center;gap:0.25rem;cursor:pointer"><input type="radio" name="gen-ssh-algo" value="ssh-rsa"> RSA 4096</label>
                    </div>
                </div>
                <div style="padding:0.6rem;background:var(--bg-inset);border-radius:6px;font-size:0.78rem;color:var(--text-muted);border:1px solid var(--border-subtle);margin-bottom:var(--space-sm)">
                    â„¹ï¸ Private key will be base64-encoded in <code>.env</code>. Public key will be shown after generation.
                </div>
            </div>

            <!-- Certificate tab -->
            <div id="gen-cert" style="display:none">
                <div class="form-group" style="margin-bottom:var(--space-md)">
                    <label>Certificate Key Name</label>
                    <input type="text" id="gen-cert-key" placeholder="TLS_CERTIFICATE" autocomplete="off" style="width:100%">
                </div>
                <div class="form-group" style="margin-bottom:var(--space-md)">
                    <label>Private Key Name</label>
                    <input type="text" id="gen-cert-privkey" placeholder="TLS_PRIVATE_KEY" autocomplete="off" style="width:100%">
                </div>
                <div class="form-group" style="margin-bottom:var(--space-md)">
                    <label>Common Name (CN)</label>
                    <input type="text" id="gen-cert-cn" value="localhost" autocomplete="off" style="width:100%">
                </div>
                <div style="padding:0.6rem;background:var(--bg-inset);border-radius:6px;font-size:0.78rem;color:var(--text-muted);border:1px solid var(--border-subtle)">
                    â„¹ï¸ Generates a self-signed EC P-256 cert valid for 365 days. Both values are base64-encoded.
                </div>
            </div>

            <!-- Token tab -->
            <div id="gen-token" style="display:none">
                <div class="form-group" style="margin-bottom:var(--space-md)">
                    <label>Key Name</label>
                    <input type="text" id="gen-tok-key" placeholder="API_TOKEN" autocomplete="off" style="width:100%">
                </div>
                <div class="form-group" style="margin-bottom:var(--space-md)">
                    <label>Length (bytes): <span id="gen-tok-len-label">32</span></label>
                    <input type="range" id="gen-tok-len" min="16" max="128" value="32" style="width:100%" oninput="document.getElementById('gen-tok-len-label').textContent=this.value">
                </div>
                <button class="btn btn-secondary btn-sm" type="button" onclick="previewGenerate('token')" style="margin-bottom:var(--space-sm)">âš¡ Generate Preview</button>
                <pre id="gen-tok-preview" style="background:var(--bg-inset);padding:0.75rem;border-radius:6px;font-size:0.78rem;min-height:2rem;border:1px solid var(--border-subtle);word-break:break-all"></pre>
            </div>

            <div id="vault-modal-error" style="color:var(--error);font-size:0.82rem;margin-top:var(--space-sm);display:none"></div>
            <div style="display:flex;gap:var(--space-sm);justify-content:flex-end;margin-top:var(--space-lg)">
                <button class="btn btn-secondary" onclick="closeVaultModal()">Cancel</button>
                <button class="btn btn-primary" id="vault-modal-btn" onclick="doAddKeys()">${btnLabel}</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
        modal.querySelector('.env-entry-key').focus();
    }

    function onSectionSelectChange(sel) {
        const newInput = document.getElementById('env-section-new');
        if (sel.value === '__new__') {
            newInput.style.display = 'block';
            newInput.focus();
        } else {
            newInput.style.display = 'none';
        }
    }

    function addEnvEntry() {
        const container = document.getElementById('env-entries');
        const row = document.createElement('div');
        row.className = 'env-entry-row';
        row.innerHTML = `
        <input type="text" class="env-entry-key" placeholder="KEY" autocomplete="off">
        <input type="text" class="env-entry-value" placeholder="value" autocomplete="off">
        <select class="env-entry-type" style="width:auto;min-width:80px;font-size:0.72rem;padding:0.25rem 0.3rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary);flex-shrink:0" title="Key type" onchange="onEntryTypeChange(this)">
            <option value="text">ğŸ“ text</option>
            <option value="password">ğŸ”’ password</option>
            <option value="toggle">ğŸ”˜ toggle</option>
            <option value="select">ğŸ“‹ enum</option>
            <option value="base64">ğŸ” base64</option>
        </select>
        <input type="text" class="env-entry-options" placeholder="opt1,opt2,opt3" style="display:none;width:100px;font-size:0.72rem;padding:0.25rem 0.3rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary)" title="Comma-separated options">
        <button class="btn-icon" onclick="removeEnvEntry(this)" title="Remove">âœ•</button>`;
        container.appendChild(row);
        row.querySelector('.env-entry-key').focus();
    }

    function onEntryTypeChange(sel) {
        const row = sel.closest('.env-entry-row');
        const optsInput = row.querySelector('.env-entry-options');
        const valInput = row.querySelector('.env-entry-value');
        if (sel.value === 'select') {
            optsInput.style.display = '';
            valInput.placeholder = 'default value';
        } else {
            optsInput.style.display = 'none';
            if (sel.value === 'toggle') {
                valInput.placeholder = 'true / false';
            } else {
                valInput.placeholder = 'value';
            }
        }
    }

    function removeEnvEntry(btn) {
        const row = btn.closest('.env-entry-row');
        const container = document.getElementById('env-entries');
        if (container.children.length > 1) { row.remove(); }
        else { row.querySelectorAll('input').forEach(i => i.value = ''); }
    }

    async function doAddKeys() {
        const rows = document.querySelectorAll('.env-entry-row');
        const entries = [];
        const metaByKey = {};  // key -> meta tags string
        rows.forEach(row => {
            const key = row.querySelector('.env-entry-key').value.trim();
            let value = row.querySelector('.env-entry-value').value.trim();
            const type = row.querySelector('.env-entry-type')?.value || 'text';
            const options = (row.querySelector('.env-entry-options')?.value || '').trim();
            if (key) {
                // Build meta tags based on type
                const tags = [];
                if (type === 'password') tags.push('@type:password');
                else if (type === 'toggle') tags.push('@type:toggle');
                else if (type === 'select') {
                    tags.push('@type:select');
                    if (options) tags.push('@options:' + options.split(',').map(s => s.trim()).filter(Boolean).join(','));
                }
                else if (type === 'base64') {
                    tags.push('@encoding:base64');
                    if (value) {
                        try { value = btoa(value); } catch(e) { /* skip */ }
                    }
                }
                if (tags.length) metaByKey[key] = '# ' + tags.join(' ');
                entries.push({ key, value });
            }
        });

        const btn = document.getElementById('vault-modal-btn');
        const errEl = document.getElementById('vault-modal-error');

        if (!entries.length) {
            errEl.textContent = 'Add at least one key';
            errEl.style.display = 'block';
            return;
        }

        // Resolve section
        let section = '';
        const sectionSel = document.getElementById('env-section-select');
        if (sectionSel) {
            if (sectionSel.value === '__new__') {
                section = (document.getElementById('env-section-new')?.value || '').trim();
                if (!section) {
                    errEl.textContent = 'Enter a name for the new section';
                    errEl.style.display = 'block';
                    return;
                }
            } else {
                section = sectionSel.value;
            }
        }

        btn.disabled = true;
        btn.textContent = _addKeysMode === 'create' ? 'Creatingâ€¦' : 'Addingâ€¦';

        const endpoint = _addKeysMode === 'create' ? '/vault/create' : '/vault/add-keys';
        const envFile = _envFile();
        const successMsg = _addKeysMode === 'create'
            ? `${envFile} created with ${entries.length} keys`
            : `${entries.length} key(s) added to ${envFile}`;

        const body = { entries };
        if (section) body.section = section;

        try {
            await api(`${endpoint}${_envQS()}`, { method: 'POST', body: JSON.stringify(body) });

            // Set meta tags for any keys that need them
            for (const [mk, mTags] of Object.entries(metaByKey)) {
                await api('/vault/set-meta' + _envQS(), {
                    method: 'POST',
                    body: JSON.stringify({ key: mk, meta_tags: mTags }),
                });
            }

            closeVaultModal();
            toast(successMsg, 'success');
            await loadSecretsTab();
        } catch (e) {
            errEl.textContent = e.message;
            errEl.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = _addKeysMode === 'create' ? 'Create' : 'Add Keys';
        }
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Template picker â€” "Use Template" for .env creation
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function createEnvFromTemplate() {
        const envFile = _envFile();

        // Fetch available templates
        let templateSections;
        try {
            const data = await api('/vault/templates');
            templateSections = data.sections || [];
        } catch (e) {
            toast(`Failed to load templates: ${e.message}`, 'error');
            return;
        }

        if (!templateSections.length) {
            toast('No template sections available', 'warning');
            return;
        }

        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'vault-modal';
        modal.innerHTML = `
        <div class="vault-modal" style="max-width:560px">
            <h2 style="margin-bottom:var(--space-sm)">ğŸ“‹ Create ${esc(envFile)} from Template</h2>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg);font-size:0.85rem;line-height:1.5">
                Select which sections to include. Each section provides a set of
                pre-configured keys. You can always add more later.
            </p>

            <div id="template-sections" style="display:flex;flex-direction:column;gap:0.4rem;margin-bottom:var(--space-lg);max-height:380px;overflow-y:auto;padding-right:0.25rem">
                ${templateSections.map(s => {
                    const isSpecial = s.special;
                    const keysPreview = s.keys.map(k => k.key).join(', ');
                    return `
                    <label style="display:flex;align-items:flex-start;gap:0.6rem;padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid ${isSpecial ? 'var(--accent)' : 'var(--border-subtle)'};border-radius:8px;cursor:pointer;transition:border-color 0.15s"
                           onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor='${isSpecial ? 'var(--accent)' : 'var(--border-subtle)'}'"
                           data-template-label="${esc(s.id)}">
                        <input type="checkbox" value="${esc(s.id)}" class="template-checkbox"
                               ${isSpecial ? 'checked' : ''}
                               style="margin-top:0.15rem;accent-color:var(--accent)">
                        <div style="flex:1;min-width:0">
                            <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.15rem">
                                <span style="font-weight:600;font-size:0.88rem">${esc(s.name)}</span>
                                ${isSpecial ? '<span style="font-size:0.65rem;padding:0.1rem 0.35rem;border-radius:4px;background:var(--accent);color:#fff;font-weight:600">Required</span>' : ''}
                            </div>
                            <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.2rem">${esc(s.description)}</div>
                            <div style="font-size:0.72rem;color:var(--text-muted);font-family:var(--font-mono);opacity:0.7;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(keysPreview)}</div>
                        </div>
                    </label>`;
                }).join('')}
            </div>

            <div id="vault-modal-error" style="color:var(--error);font-size:0.82rem;margin-bottom:var(--space-sm);display:none"></div>
            <div style="display:flex;gap:var(--space-sm);justify-content:space-between;align-items:center">
                <button class="btn btn-ghost btn-sm" onclick="templateSelectAll()" style="font-size:0.78rem">Select All</button>
                <div style="display:flex;gap:var(--space-sm)">
                    <button class="btn btn-secondary" onclick="closeVaultModal()">Cancel</button>
                    <button class="btn btn-primary" id="vault-modal-btn" onclick="doCreateFromTemplate()">ğŸ“‹ Create ${esc(envFile)}</button>
                </div>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }

    function templateSelectAll() {
        document.querySelectorAll('.template-checkbox').forEach(cb => { cb.checked = true; });
    }

    async function doCreateFromTemplate() {
        const checkboxes = document.querySelectorAll('.template-checkbox:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);

        const btn = document.getElementById('vault-modal-btn');
        const errEl = document.getElementById('vault-modal-error');

        if (selected.length === 0) {
            errEl.textContent = 'Select at least one section';
            errEl.style.display = 'block';
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Creatingâ€¦';

        const envFile = _envFile();

        try {
            await api(`/vault/create${_envQS()}`, {
                method: 'POST',
                body: JSON.stringify({ template_sections: selected }),
            });
            closeVaultModal();
            toast(`${envFile} created with ${selected.length} section(s)`, 'success');
            secretsLoaded = false;
            await loadSecretsTab();
        } catch (e) {
            errEl.textContent = e.message;
            errEl.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = `ğŸ“‹ Create ${envFile}`;
        }
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  Generator tab switching + preview + execution
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let _activeGenTab = 'manual';
    let _lastGenResult = null;

    function switchGenTab(tab) {
        _activeGenTab = tab;
        _lastGenResult = null;
        const panels = ['gen-manual', 'gen-password', 'gen-ssh', 'gen-cert', 'gen-token'];
        const tabMap = { manual: 0, password: 1, ssh: 2, cert: 3, token: 4 };

        panels.forEach((id, i) => {
            const el = document.getElementById(id);
            if (el) el.style.display = i === tabMap[tab] ? 'block' : 'none';
        });

        // Update tab bar highlights
        document.querySelectorAll('#gen-tabs .gen-tab').forEach((btn, i) => {
            if (i === tabMap[tab]) {
                btn.style.background = 'var(--accent)';
                btn.style.color = '#fff';
                btn.style.fontWeight = '600';
            } else {
                btn.style.background = 'var(--bg-card)';
                btn.style.color = 'var(--text-secondary)';
                btn.style.fontWeight = 'normal';
            }
        });

        // Update button label
        const btn = document.getElementById('vault-modal-btn');
        if (btn) {
            if (tab === 'manual') {
                btn.textContent = _addKeysMode === 'create' ? 'Create' : 'Add Keys';
            } else if (tab === 'ssh' || tab === 'cert') {
                btn.textContent = 'ğŸ” Generate & Add';
            } else {
                btn.textContent = 'ğŸ”‘ Generate & Add';
            }
        }
    }

    async function previewGenerate(type) {
        try {
            const body = { type };
            if (type === 'password') {
                body.length = parseInt(document.getElementById('gen-pwd-len')?.value || '32');
            } else if (type === 'token') {
                body.length = parseInt(document.getElementById('gen-tok-len')?.value || '32');
            }

            const result = await api('/keys/generate', {
                method: 'POST',
                body: JSON.stringify(body),
            });
            _lastGenResult = result;

            if (type === 'password') {
                document.getElementById('gen-pwd-preview').textContent = result.value;
            } else if (type === 'token') {
                document.getElementById('gen-tok-preview').textContent = result.value;
            }
        } catch (e) {
            toast('Generate failed: ' + e.message, 'error');
        }
    }

    // Override doAddKeys to handle generator tabs
    const _origDoAddKeys = doAddKeys;
    doAddKeys = async function() {
        if (_activeGenTab === 'manual') {
            return _origDoAddKeys();
        }

        const btn = document.getElementById('vault-modal-btn');
        const errEl = document.getElementById('vault-modal-error');
        btn.disabled = true;
        btn.textContent = 'â³ Generatingâ€¦';
        errEl.style.display = 'none';

        try {
            if (_activeGenTab === 'password') {
                const keyName = (document.getElementById('gen-pwd-key')?.value || '').trim().toUpperCase();
                if (!keyName) { errEl.textContent = 'Enter a key name'; errEl.style.display = 'block'; return; }
                const length = parseInt(document.getElementById('gen-pwd-len')?.value || '32');
                const result = _lastGenResult && _lastGenResult.type === 'password'
                    ? _lastGenResult
                    : await api('/keys/generate', { method: 'POST', body: JSON.stringify({ type: 'password', length }) });

                await api('/vault/add-keys' + _envQS(), {
                    method: 'POST',
                    body: JSON.stringify({ entries: [{ key: keyName, value: result.value }] }),
                });
                if (result.meta_tags) {
                    await api('/vault/set-meta' + _envQS(), {
                        method: 'POST',
                        body: JSON.stringify({ key: keyName, meta_tags: result.meta_tags }),
                    });
                }
                closeVaultModal();
                toast('ğŸ”‘ Password generated for ' + keyName, 'success');

            } else if (_activeGenTab === 'token') {
                const keyName = (document.getElementById('gen-tok-key')?.value || '').trim().toUpperCase();
                if (!keyName) { errEl.textContent = 'Enter a key name'; errEl.style.display = 'block'; return; }
                const length = parseInt(document.getElementById('gen-tok-len')?.value || '32');
                const result = _lastGenResult && _lastGenResult.type === 'token'
                    ? _lastGenResult
                    : await api('/keys/generate', { method: 'POST', body: JSON.stringify({ type: 'token', length }) });

                await api('/vault/add-keys' + _envQS(), {
                    method: 'POST',
                    body: JSON.stringify({ entries: [{ key: keyName, value: result.value }] }),
                });
                if (result.meta_tags) {
                    await api('/vault/set-meta' + _envQS(), {
                        method: 'POST',
                        body: JSON.stringify({ key: keyName, meta_tags: result.meta_tags }),
                    });
                }
                closeVaultModal();
                toast('ğŸ« Token generated for ' + keyName, 'success');

            } else if (_activeGenTab === 'ssh') {
                const keyName = (document.getElementById('gen-ssh-key')?.value || '').trim().toUpperCase();
                if (!keyName) { errEl.textContent = 'Enter a key name'; errEl.style.display = 'block'; return; }
                const algo = document.querySelector('input[name=gen-ssh-algo]:checked')?.value || 'ssh-ed25519';

                const result = await api('/keys/generate', {
                    method: 'POST',
                    body: JSON.stringify({ type: algo }),
                });

                await api('/vault/add-keys' + _envQS(), {
                    method: 'POST',
                    body: JSON.stringify({ entries: [{ key: keyName, value: result.value }] }),
                });
                if (result.meta_tags) {
                    await api('/vault/set-meta' + _envQS(), {
                        method: 'POST',
                        body: JSON.stringify({ key: keyName, meta_tags: result.meta_tags }),
                    });
                }
                closeVaultModal();

                // Show public key
                if (result.public_value) {
                    const pubModal = document.createElement('div');
                    pubModal.className = 'vault-modal-overlay';
                    pubModal.id = 'vault-modal';
                    pubModal.innerHTML = `
                        <div class="vault-modal" style="max-width:600px">
                            <h3 style="margin-bottom:0.75rem">ğŸ”‘ ${esc(algo)} Public Key</h3>
                            <p style="color:var(--text-secondary);font-size:0.85rem;margin-bottom:0.75rem">
                                Private key saved to <code>${esc(keyName)}</code> (base64-encoded). Copy the public key:
                            </p>
                            <pre style="background:var(--bg-inset);padding:1rem;border-radius:8px;font-size:0.78rem;overflow:auto;white-space:pre-wrap;word-break:break-all;border:1px solid var(--border-subtle)">${esc(result.public_value)}</pre>
                            <div style="display:flex;gap:0.5rem;justify-content:flex-end;margin-top:1rem">
                                <button class="btn btn-sm btn-secondary" onclick="navigator.clipboard.writeText('${esc(result.public_value)}').then(() => toast('Copied!','success'))" type="button">ğŸ“‹ Copy</button>
                                <button class="btn btn-sm btn-primary" onclick="closeVaultModal()" type="button">Close</button>
                            </div>
                        </div>`;
                    document.body.appendChild(pubModal);
                }
                toast('ğŸ” SSH key generated for ' + keyName, 'success');

            } else if (_activeGenTab === 'cert') {
                const certKeyName = (document.getElementById('gen-cert-key')?.value || '').trim().toUpperCase();
                const privKeyName = (document.getElementById('gen-cert-privkey')?.value || '').trim().toUpperCase();
                const cn = (document.getElementById('gen-cert-cn')?.value || 'localhost').trim();
                if (!certKeyName || !privKeyName) { errEl.textContent = 'Enter both key names'; errEl.style.display = 'block'; return; }

                const result = await api('/keys/generate', {
                    method: 'POST',
                    body: JSON.stringify({ type: 'cert-selfsigned', cn }),
                });

                // Add both keys
                await api('/vault/add-keys' + _envQS(), {
                    method: 'POST',
                    body: JSON.stringify({
                        entries: [
                            { key: certKeyName, value: result.value },
                            { key: privKeyName, value: result.private_key },
                        ]
                    }),
                });
                // Set meta on both
                await api('/vault/set-meta' + _envQS(), {
                    method: 'POST',
                    body: JSON.stringify({ key: certKeyName, meta_tags: '# @encoding:base64 @generated:cert-selfsigned' }),
                });
                await api('/vault/set-meta' + _envQS(), {
                    method: 'POST',
                    body: JSON.stringify({ key: privKeyName, meta_tags: '# @encoding:base64 @generated:cert-selfsigned' }),
                });
                closeVaultModal();
                toast('ğŸ“œ Certificate generated: ' + certKeyName + ' + ' + privKeyName, 'success');
            }

            secretsLoaded = false;
            await loadSecretsTab();
        } catch (e) {
            errEl.textContent = e.message;
            errEl.style.display = 'block';
        } finally {
            btn.disabled = false;
            switchGenTab(_activeGenTab);  // reset btn label
        }
    };

