    // ─────────────────────────────────────────────────────────────────
    //  _secrets_keys.html
    //  Move key between sections, add/create keys modal, env entry management
    //  Included by: _secrets.html (Jinja2 include)
    // ─────────────────────────────────────────────────────────────────



    // ═══════════════════════════════════════════════════════════════════
    //  Move key between sections
    // ═══════════════════════════════════════════════════════════════════

    function showMoveKeyMenu(event, keyName) {
        event.stopPropagation();

        // Remove any existing menu
        const existing = document.getElementById('move-key-menu');
        if (existing) existing.remove();

        const menu = document.createElement('div');
        menu.id = 'move-key-menu';
        menu.style.cssText = `position:fixed;z-index:1000;background:var(--surface);border:1px solid var(--border);border-radius:6px;box-shadow:0 4px 16px rgba(0,0,0,0.4);padding:var(--space-xs) 0;min-width:180px;max-height:260px;overflow-y:auto;font-size:0.85rem;`;

        const rect = event.target.getBoundingClientRect();
        menu.style.left = rect.left + 'px';
        menu.style.top = (rect.bottom + 4) + 'px';

        let items = '';
        for (const s of envSections) {
            items += `<div class="move-key-item" style="padding:0.35rem 0.75rem;cursor:pointer;white-space:nowrap;" onmouseenter="this.style.background='var(--hover)'" onmouseleave="this.style.background=''" onclick="moveKeyToSection('${esc(keyName)}', '${esc(s)}')">${esc(s)}</div>`;
        }
        items += `<div style="border-top:1px solid var(--border);margin:0.2rem 0"></div>`;
        items += `<div class="move-key-item" style="padding:0.35rem 0.75rem;cursor:pointer;color:var(--primary);white-space:nowrap;" onmouseenter="this.style.background='var(--hover)'" onmouseleave="this.style.background=''" onclick="moveKeyNewSection('${esc(keyName)}')">+ New section…</div>`;

        menu.innerHTML = items;
        document.body.appendChild(menu);

        // Close on click outside
        const closeMenu = (e) => {
            if (!menu.contains(e.target)) {
                menu.remove();
                document.removeEventListener('click', closeMenu);
            }
        };
        setTimeout(() => document.addEventListener('click', closeMenu), 0);
    }

    async function moveKeyToSection(keyName, section) {
        const menu = document.getElementById('move-key-menu');
        if (menu) menu.remove();

        try {
            await api('/vault/move-key', {
                method: 'POST',
                body: JSON.stringify({ key: keyName, section }),
            });
            toast(`${keyName} → ${section}`, 'success');
            secretsLoaded = false;
            await loadSecretsTab();
            selectTarget(currentTarget);
        } catch (e) {
            toast(`Failed to move ${keyName}: ${e.message}`, 'error');
        }
    }

    function moveKeyNewSection(keyName) {
        const menu = document.getElementById('move-key-menu');
        if (menu) menu.remove();

        const name = prompt('New section name:');
        if (name && name.trim()) {
            moveKeyToSection(keyName, name.trim());
        }
    }


    // ═══════════════════════════════════════════════════════════════════
    //  Add / Create keys modal
    // ═══════════════════════════════════════════════════════════════════

    let _addKeysMode = 'create';

    function showAddKeysModal(mode) {
        _addKeysMode = mode;
        const isCreate = mode === 'create';
        const title = isCreate ? '✨ Create .env File' : '✨ Add Keys to .env';
        const desc = isCreate
            ? 'Add your environment variables below. You can lock it with the vault afterwards.'
            : 'Add new key-value pairs to your existing .env file.';
        const btnLabel = isCreate ? 'Create' : 'Add Keys';

        // Build section options
        let sectionOptions = '<option value="">— append to end —</option>';
        for (const s of envSections) {
            sectionOptions += `<option value="${esc(s)}">${esc(s)}</option>`;
        }
        sectionOptions += '<option value="__new__">+ Create new section…</option>';

        const sectionSelector = !isCreate ? `
            <div class="form-group" style="margin-bottom:var(--space-md)">
                <label for="env-section-select">Section</label>
                <select id="env-section-select" style="width:100%" onchange="onSectionSelectChange(this)">
                    ${sectionOptions}
                </select>
                <input type="text" id="env-section-new" placeholder="New section name…"
                    style="display:none;margin-top:var(--space-xs)" autocomplete="off">
            </div>` : '';

        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'vault-modal';
        modal.innerHTML = `
        <div class="vault-modal" style="max-width:520px">
            <h2 style="margin-bottom:var(--space-md)">${title}</h2>
            <p style="color:var(--text-secondary);margin-bottom:var(--space-lg);font-size:0.88rem;line-height:1.5">
                ${desc}
            </p>
            ${sectionSelector}
            <div id="env-entries">
                <div class="env-entry-row">
                    <input type="text" class="env-entry-key" placeholder="KEY" autocomplete="off">
                    <input type="text" class="env-entry-value" placeholder="value" autocomplete="off">
                    <button class="btn-icon" onclick="removeEnvEntry(this)" title="Remove">✕</button>
                </div>
            </div>
            <button class="btn btn-ghost" onclick="addEnvEntry()" style="margin-top:var(--space-sm);font-size:0.82rem">
                + Add another
            </button>
            <div id="vault-modal-error" style="color:var(--error);font-size:0.82rem;margin-top:var(--space-sm);display:none"></div>
            <div style="display:flex;gap:var(--space-sm);justify-content:flex-end;margin-top:var(--space-lg)">
                <button class="btn btn-secondary" onclick="closeVaultModal()">Cancel</button>
                <button class="btn btn-primary" id="vault-modal-btn" onclick="doAddKeys()">${btnLabel}</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
        modal.querySelector('.env-entry-key').focus();
    }

    function onSectionSelectChange(sel) {
        const newInput = document.getElementById('env-section-new');
        if (sel.value === '__new__') {
            newInput.style.display = 'block';
            newInput.focus();
        } else {
            newInput.style.display = 'none';
        }
    }

    function addEnvEntry() {
        const container = document.getElementById('env-entries');
        const row = document.createElement('div');
        row.className = 'env-entry-row';
        row.innerHTML = `
        <input type="text" class="env-entry-key" placeholder="KEY" autocomplete="off">
        <input type="text" class="env-entry-value" placeholder="value" autocomplete="off">
        <button class="btn-icon" onclick="removeEnvEntry(this)" title="Remove">✕</button>`;
        container.appendChild(row);
        row.querySelector('.env-entry-key').focus();
    }

    function removeEnvEntry(btn) {
        const row = btn.closest('.env-entry-row');
        const container = document.getElementById('env-entries');
        if (container.children.length > 1) { row.remove(); }
        else { row.querySelectorAll('input').forEach(i => i.value = ''); }
    }

    async function doAddKeys() {
        const rows = document.querySelectorAll('.env-entry-row');
        const entries = [];
        rows.forEach(row => {
            const key = row.querySelector('.env-entry-key').value.trim();
            const value = row.querySelector('.env-entry-value').value.trim();
            if (key) entries.push({ key, value });
        });

        const btn = document.getElementById('vault-modal-btn');
        const errEl = document.getElementById('vault-modal-error');

        if (!entries.length) {
            errEl.textContent = 'Add at least one key';
            errEl.style.display = 'block';
            return;
        }

        // Resolve section
        let section = '';
        const sectionSel = document.getElementById('env-section-select');
        if (sectionSel) {
            if (sectionSel.value === '__new__') {
                section = (document.getElementById('env-section-new')?.value || '').trim();
                if (!section) {
                    errEl.textContent = 'Enter a name for the new section';
                    errEl.style.display = 'block';
                    return;
                }
            } else {
                section = sectionSel.value;
            }
        }

        btn.disabled = true;
        btn.textContent = _addKeysMode === 'create' ? 'Creating…' : 'Adding…';

        const endpoint = _addKeysMode === 'create' ? '/vault/create' : '/vault/add-keys';
        const successMsg = _addKeysMode === 'create'
            ? `.env created with ${entries.length} keys`
            : `${entries.length} key(s) added to .env`;

        const body = { entries };
        if (section) body.section = section;

        try {
            await api(endpoint, { method: 'POST', body: JSON.stringify(body) });
            closeVaultModal();
            toast(successMsg, 'success');
            await loadSecretsTab();
        } catch (e) {
            errEl.textContent = e.message;
            errEl.style.display = 'block';
        } finally {
            btn.disabled = false;
            btn.textContent = _addKeysMode === 'create' ? 'Create' : 'Add Keys';
        }
    }

    async function createEnvFromTemplate() {
        try {
            await api('/vault/create', { method: 'POST', body: JSON.stringify({ entries: [] }) });
            toast('.env created from template', 'success');
            await loadSecretsTab();
        } catch (e) { toast(e.message, 'error'); }
    }
