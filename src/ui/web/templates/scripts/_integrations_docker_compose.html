/* Integrations Tab JS — Docker Generate & Actions
     Dockerfile generation, file writing, and operational actions (up, down, restart, build, logs).
     Depends on: _integrations_docker.html (Docker card context)
*/

    // Generate Dockerfile for a specific stack (called from stack buttons)
    async function _dockerGenDockerfile(stackName) {
        const preview = document.getElementById('dg-preview-wrap');
        const code = document.getElementById('dg-preview-code');
        const writeBtn = document.getElementById('dg-write');
        if (!code) return;

        if (preview) preview.style.display = 'block';
        code.innerHTML = '<span class="spinner"></span> Generating Dockerfile for ' + esc(stackName) + '…';
        if (writeBtn) { writeBtn.style.display = 'inline-flex'; writeBtn.disabled = true; }

        try {
            const data = await api('/docker/generate/dockerfile', {
                method: 'POST',
                body: JSON.stringify({ stack: stackName })
            });
            if (data.file) {
                code.textContent = data.file.content || '(empty)';
                if (writeBtn) {
                    writeBtn.disabled = false;
                    writeBtn.dataset.file = JSON.stringify(data.file);
                }
            } else {
                code.textContent = data.error || 'No template available for this stack.';
            }
        } catch (e) {
            code.textContent = 'Error: ' + e.message;
        }
    }

    // Write generated file to disk
    async function _dockerWriteGen() {
        const writeBtn = document.getElementById('dg-write');
        if (!writeBtn || !writeBtn.dataset.file) return;

        const origText = writeBtn.textContent;
        writeBtn.disabled = true;
        writeBtn.textContent = '⏳ Writing…';

        try {
            const fileData = JSON.parse(writeBtn.dataset.file);
            const result = await api('/docker/generate/write', {
                method: 'POST',
                body: JSON.stringify({ file: { ...fileData, overwrite: true } })
            });

            if (result.error) {
                modalError(result.error);
                writeBtn.textContent = origText;
                writeBtn.disabled = false;
            } else {
                toast(`✅ Written to ${fileData.path || 'disk'}`, 'success');
                writeBtn.textContent = '✅ Written';
                cardInvalidate('docker');
                setTimeout(() => {
                    modalClose();
                    loadDockerCard();
                }, 1000);
            }
        } catch (e) {
            toast('Write failed: ' + e.message, 'error');
            writeBtn.textContent = origText;
            writeBtn.disabled = false;
        }
    }

    // ── Docker: operational actions ────────────────────────────────────

    async function _intDockerAction(action, btnEl) {
        const output = document.getElementById('int-docker-action-output');
        const origText = btnEl.textContent;
        btnEl.disabled = true;
        btnEl.textContent = '⏳…';

        try {
            let resultData;
            if (action === 'up') {
                resultData = await api('/docker/up', { method: 'POST', body: '{}' });
            } else if (action === 'down') {
                resultData = await api('/docker/down', { method: 'POST', body: '{}' });
            } else if (action === 'restart') {
                resultData = await api('/docker/restart', { method: 'POST', body: '{}' });
            } else if (action === 'build') {
                resultData = await api('/docker/build', { method: 'POST', body: '{}' });
            } else if (action === 'build-nc') {
                resultData = await api('/docker/build', { method: 'POST', body: JSON.stringify({no_cache: true}) });
            } else if (action === 'prune') {
                resultData = await api('/docker/prune', { method: 'POST', body: '{}' });
            }

            btnEl.textContent = origText;
            btnEl.disabled = false;

            if (resultData && output) {
                output.style.display = 'block';
                if (resultData.error) {
                    output.textContent = '❌ ' + resultData.error;
                    output.style.color = 'var(--error)';
                    toast(resultData.error, 'error');
                } else {
                    output.style.color = 'var(--text-secondary)';
                    output.textContent = resultData.output || resultData.message || JSON.stringify(resultData, null, 2);
                    toast(`✅ docker ${action} complete`, 'success');
                    // Refresh the card data
                    cardInvalidate('docker');
                    setTimeout(() => loadDockerCard(), 800);
                }
            }
        } catch (e) {
            btnEl.textContent = origText;
            btnEl.disabled = false;
            if (output) {
                output.style.display = 'block';
                output.textContent = '❌ ' + e.message;
                output.style.color = 'var(--error)';
            }
            toast('Docker action failed: ' + e.message, 'error');
        }
    }

