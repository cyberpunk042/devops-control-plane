/* Wizard JS â€” Navigation & Save
     Step navigation (next/prev), save config, activate environment, advanced actions.
     Depends on: _wizard_init.html (state), _wizard_helpers.html (form state collection)
*/
    // â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function wizardNext() {
        // Collect current state before advancing
        if (wizardSteps[currentWizardStep].id === 'welcome') {
            _wizardCollectWelcome();
            if (!_wizardConfig || !_wizardConfig.name) {
                toast('Project name is required.', 'warning');
                const nameInput = document.getElementById('wiz-name');
                if (nameInput) nameInput.focus();
                return;
            }
        }
        if (wizardSteps[currentWizardStep].id === 'integrations') {
            _wizCollectIntegrations();
        }

        if (currentWizardStep < wizardSteps.length - 1) {
            currentWizardStep++;
            renderWizard();
        }
    }

    function wizardPrev() {
        // Collect state before going back
        if (wizardSteps[currentWizardStep].id === 'welcome') {
            _wizardCollectWelcome();
        }
        if (wizardSteps[currentWizardStep].id === 'integrations') {
            _wizCollectIntegrations();
        }
        if (currentWizardStep > 0) {
            currentWizardStep--;
            renderWizard();
        }
    }

    function wizardGoTo(idx) {
        // Collect state from current step
        if (wizardSteps[currentWizardStep].id === 'welcome') {
            _wizardCollectWelcome();
        }
        if (wizardSteps[currentWizardStep].id === 'integrations') {
            _wizCollectIntegrations();
        }
        if (idx >= 0 && idx < wizardSteps.length) {
            currentWizardStep = idx;
            renderWizard();
        }
    }

    async function wizardFinish() {
        // Collect any final state
        _wizardCollectWelcome();
        if (wizardSteps[currentWizardStep].id === 'integrations' && typeof _wizCollectIntegrations === 'function') _wizCollectIntegrations();

        if (!_wizardConfig || !_wizardConfig.name) {
            toast('Project name is required. Go back to step 1.', 'warning');
            return;
        }

        try {
            await api('/config', {
                method: 'POST',
                body: JSON.stringify({ config: _wizardConfig }),
            });
            wizardDirty = false;

            // â”€â”€ Save integration preferences â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (_wizardConfig._integrationPrefs) {
                try {
                    // Merge with existing prefs (don't overwrite core DevOps prefs
                    // that the user hasn't touched in the wizard)
                    const existing = await api('/devops/prefs');
                    const merged = { ...existing, ..._wizardConfig._integrationPrefs };
                    const saved = await api('/devops/prefs', {
                        method: 'PUT',
                        body: JSON.stringify(merged),
                    });
                    toast('ðŸ”Œ Integration preferences saved!', 'info');

                    // Update cached prefs in tabs so modals read correct values
                    if (typeof _devopsPrefs !== 'undefined') _devopsPrefs = saved;
                    if (typeof _intPrefs !== 'undefined') _intPrefs = saved;
                    // Apply card visibility immediately (no reload needed)
                    if (typeof _DEVOPS_CARDS !== 'undefined') {
                        for (const [key, meta] of Object.entries(_DEVOPS_CARDS)) {
                            const card = document.getElementById('devops-' + key + '-card');
                            if (!card) continue;
                            const wasHidden = card.style.display === 'none';
                            const nowHidden = saved[key] === 'hidden';
                            card.style.display = nowHidden ? 'none' : '';
                            if (wasHidden && !nowHidden) meta.loadFn();
                        }
                    }
                    if (typeof _INT_CARDS !== 'undefined') {
                        for (const [key, meta] of Object.entries(_INT_CARDS)) {
                            const card = document.getElementById(meta.cardId);
                            if (!card) continue;
                            const wasHidden = card.style.display === 'none';
                            const nowHidden = saved[key] === 'hidden';
                            card.style.display = nowHidden ? 'none' : '';
                            if (wasHidden && !nowHidden) meta.loadFn();
                        }
                    }
                } catch (prefErr) {
                    console.warn('Integration pref save failed:', prefErr);
                }
            }

            // â”€â”€ Seed environment files if entering multi-env mode â”€â”€â”€â”€
            const envs = _wizardConfig.environments || [];
            if (envs.length > 1) {
                const defaultEnv = envs.find(e => e.default) || envs[0];
                try {
                    const seedResult = await api('/env/seed', {
                        method: 'POST',
                        body: JSON.stringify({
                            environments: envs.map(e => e.name),
                            default: defaultEnv.name,
                        }),
                    });
                    if (seedResult.seeded && seedResult.seeded.length > 0) {
                        toast(`ðŸ“ Seeded: ${seedResult.seeded.map(n => '.env.' + n).join(', ')}`, 'info');
                    }
                } catch (seedErr) {
                    console.warn('Env seed failed:', seedErr);
                }
            }

            // Invalidate cached environment state so other tabs re-fetch
            projectEnvironments = [];
            selectedEnv = '';
            secretsLoaded = false;

            toast('âœ… Configuration saved to project.yml!', 'success');
            // Prefs changed â€” dashboard needs to re-render (uses cached data, no API calls)
            _dashLoaded = false;
            switchTab('dashboard');

            // Trigger post-wizard "Next Steps" modal after a short delay
            // so the dashboard has time to render
            setTimeout(() => _showPostWizardNextSteps(), 600);
        } catch (e) {
            toast(`Save failed: ${e.message}`, 'error');
        }
}
