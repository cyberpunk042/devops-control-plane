// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// _content_actions.html
// Content Vault â€” File management actions
// Create folder, encrypt/decrypt files, delete files,
// upload to / delete from GitHub Releases
// Included by: _content.html (Jinja2 include)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€



// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Actions
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function contentCreateFolder(name) {
try {
await api('/content/create-folder', {
method: 'POST',
body: JSON.stringify({ name }),
});
toast(`Created folder: ${name}/`, 'success');
contentLoaded = false;
await loadContentTab();
} catch (e) {
toast(`Failed: ${e.message}`, 'error');
}
}

let _ctEncryptPath = '';

function contentEncryptFile(path, hasRelease) {
_ctEncryptPath = path || previewCurrentPath;
// Check if enc key is configured
if (!encKeyConfigured) {
contentEncKeySetup();
return;
}

const modal = document.getElementById('ct-encrypt-modal');
const info = document.getElementById('ct-encrypt-modal-info');
const status = document.getElementById('ct-encrypt-modal-status');
const confirmBtn = document.getElementById('ct-encrypt-confirm-btn');
const releaseWarn = document.getElementById('ct-encrypt-modal-release-warn');

info.innerHTML = `File: <code style="font-size:0.82rem">${esc(_ctEncryptPath)}</code>`;
status.style.display = 'none';
if (releaseWarn) releaseWarn.style.display = hasRelease ? 'block' : 'none';
confirmBtn.disabled = false;
confirmBtn.textContent = 'ğŸ”’ Encrypt';
modal.style.display = 'flex';
}

async function contentDoEncryptConfirm() {
const modal = document.getElementById('ct-encrypt-modal');
const status = document.getElementById('ct-encrypt-modal-status');
const confirmBtn = document.getElementById('ct-encrypt-confirm-btn');

confirmBtn.disabled = true;
confirmBtn.textContent = 'â³ Encryptingâ€¦';
status.style.display = 'block';
status.innerHTML = '<span class="spinner"></span> Encryptingâ€¦';

try {
const result = await api('/content/encrypt', {
method: 'POST',
body: JSON.stringify({ path: _ctEncryptPath, delete_original: true }),
});

if (result.error) {
status.innerHTML = `<span style="color:var(--error)">âŒ ${esc(result.error)}</span>`;
confirmBtn.disabled = false;
confirmBtn.textContent = 'ğŸ”’ Encrypt';
return;
}

modal.style.display = 'none';
toast('Encrypted successfully!', 'success');
contentLoaded = false;
const newPath = result.output;
const newName = newPath.split('/').pop();
setTimeout(() => contentPreviewEncrypted(newPath, newName), 300);
} catch (e) {
status.innerHTML = `<span style="color:var(--error)">âŒ ${esc(e.message)}</span>`;
confirmBtn.disabled = false;
confirmBtn.textContent = 'ğŸ”’ Encrypt';
}
}

let _ctDecryptPath = '';

function contentDecryptFile(path, hasRelease) {
_ctDecryptPath = path || previewCurrentPath;

const modal = document.getElementById('ct-decrypt-modal');
const info = document.getElementById('ct-decrypt-modal-info');
const status = document.getElementById('ct-decrypt-modal-status');
const confirmBtn = document.getElementById('ct-decrypt-confirm-btn');
const releaseWarn = document.getElementById('ct-decrypt-modal-release-warn');

info.innerHTML = `File: <code style="font-size:0.82rem">${esc(_ctDecryptPath)}</code>`;
status.style.display = 'none';
if (releaseWarn) releaseWarn.style.display = hasRelease ? 'block' : 'none';
confirmBtn.disabled = false;
confirmBtn.textContent = 'ğŸ”“ Decrypt';
modal.style.display = 'flex';
}

async function contentDoDecryptConfirm() {
const modal = document.getElementById('ct-decrypt-modal');
const status = document.getElementById('ct-decrypt-modal-status');
const confirmBtn = document.getElementById('ct-decrypt-confirm-btn');

confirmBtn.disabled = true;
confirmBtn.textContent = 'â³ Decryptingâ€¦';
status.style.display = 'block';
status.innerHTML = '<span class="spinner"></span> Decryptingâ€¦';

try {
const result = await api('/content/decrypt', {
method: 'POST',
body: JSON.stringify({ path: _ctDecryptPath, delete_encrypted: true }),
});

if (result.error) {
status.innerHTML = `<span style="color:var(--error)">âŒ ${esc(result.error)}</span>`;
confirmBtn.disabled = false;
confirmBtn.textContent = 'ğŸ”“ Decrypt';
return;
}

modal.style.display = 'none';
toast('Decrypted successfully!', 'success');
contentLoaded = false;
const newPath = result.output;
const newName = newPath.split('/').pop();
setTimeout(() => contentPreviewFile(newPath, newName), 300);
} catch (e) {
status.innerHTML = `<span style="color:var(--error)">âŒ ${esc(e.message)}</span>`;
confirmBtn.disabled = false;
confirmBtn.textContent = 'ğŸ”“ Decrypt';
}
}

let _ctDeletePath = '';
let _ctDeleteName = '';
let _ctDeleteFromPreview = false;

function contentDeleteFile(path, name, fromPreview, hasRelease) {
_ctDeletePath = path || previewCurrentPath;
_ctDeleteName = name || previewCurrentName;
_ctDeleteFromPreview = !!fromPreview;

const modal = document.getElementById('ct-delete-modal');
const info = document.getElementById('ct-delete-modal-info');
const status = document.getElementById('ct-delete-modal-status');
const confirmBtn = document.getElementById('ct-delete-confirm-btn');
const releaseWarn = document.getElementById('ct-delete-modal-release-warn');

info.innerHTML = `File: <code style="font-size:0.82rem">${esc(_ctDeleteName)}</code>`;
status.style.display = 'none';
if (releaseWarn) releaseWarn.style.display = hasRelease ? 'block' : 'none';
confirmBtn.disabled = false;
confirmBtn.textContent = 'ğŸ—‘ï¸ Delete';
modal.style.display = 'flex';
}

async function contentDoDeleteConfirm() {
const modal = document.getElementById('ct-delete-modal');
const status = document.getElementById('ct-delete-modal-status');
const confirmBtn = document.getElementById('ct-delete-confirm-btn');
const releaseWarn = document.getElementById('ct-delete-modal-release-warn');
const releaseCheckbox = document.getElementById('ct-delete-also-release');
const alsoDeleteRelease = releaseWarn && releaseWarn.style.display !== 'none'
&& releaseCheckbox && releaseCheckbox.checked;

confirmBtn.disabled = true;
confirmBtn.textContent = 'â³ Deletingâ€¦';
status.style.display = 'block';
status.innerHTML = '<span class="spinner"></span> Deletingâ€¦';

try {
if (alsoDeleteRelease) {
status.innerHTML = '<span class="spinner"></span> Removing release artifactâ€¦';
await api('/backup/delete-release', {
method: 'POST',
body: JSON.stringify({ path: _ctDeletePath }),
});
}

status.innerHTML = '<span class="spinner"></span> Deleting fileâ€¦';
await api('/content/delete', {
method: 'POST',
body: JSON.stringify({ path: _ctDeletePath }),
});
modal.style.display = 'none';
toast(`Deleted: ${_ctDeleteName}`, 'success');

if (_ctDeleteFromPreview) {
contentClosePreview();
} else {
await contentLoadFolder(contentCurrentPath);
}
} catch (e) {
status.innerHTML = `<span style="color:var(--error)">âŒ ${esc(e.message)}</span>`;
confirmBtn.disabled = false;
confirmBtn.textContent = 'ğŸ—‘ï¸ Delete';
}
}

// â”€â”€ Delete release artifact (modal) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _releaseDeletePath = '';
let _releaseDeleteName = '';

async function contentDeleteRelease(path, name) {
_releaseDeletePath = path;
_releaseDeleteName = name;
const modal = document.getElementById('ct-release-delete-modal');
const info = document.getElementById('ct-release-delete-modal-info');
const status = document.getElementById('ct-release-delete-modal-status');
const btn = document.getElementById('ct-release-delete-confirm-btn');
info.innerHTML = `Remove the GitHub Release artifact for <strong>${esc(name)}</strong>?<br><br><code style="font-size:0.82rem;word-break:break-all">${esc(path)}</code>`;
status.style.display = 'none';
btn.disabled = false;
btn.textContent = 'â˜ï¸âœ• Delete artifact';
modal.style.display = 'flex';
}

async function contentDoDeleteReleaseConfirm() {
const modal = document.getElementById('ct-release-delete-modal');
const status = document.getElementById('ct-release-delete-modal-status');
const btn = document.getElementById('ct-release-delete-confirm-btn');
btn.disabled = true;
btn.textContent = 'â³ Deletingâ€¦';
status.style.display = 'block';
status.innerHTML = '<span class="spinner"></span> Removing release artifactâ€¦';
try {
await api('/backup/delete-release', {
method: 'POST',
body: JSON.stringify({ path: _releaseDeletePath }),
});
modal.style.display = 'none';
toast('Release artifact removed', 'success');
if (previewCurrentPath && previewCurrentPath === _releaseDeletePath) {
contentPreviewFile(previewCurrentPath, previewCurrentName, false);
} else {
await contentLoadFolder(contentCurrentPath);
}
} catch (e) {
status.innerHTML = `<span style="color:var(--error)">âŒ ${esc(e.message)}</span>`;
btn.disabled = false;
btn.textContent = 'â˜ï¸âœ• Delete artifact';
}
}

async function contentUploadToRelease(path) {
try {
toast('Uploading to releaseâ€¦', 'success');
const result = await api('/backup/upload-release', {
method: 'POST',
body: JSON.stringify({ path }),
});
toast(result.message || 'Upload started', 'success');
// Clear orphan bar immediately if visible
const orphanBar = document.getElementById('content-preview-orphan-bar');
if (orphanBar) orphanBar.style.display = 'none';
// Poll status until done
if (result.file_id) {
    _pollUploadStatus(result.file_id, path);
} else {
    // fallback: refresh after delay
    setTimeout(() => {
        if (previewCurrentPath && previewCurrentPath === path) {
            contentPreviewFile(previewCurrentPath, previewCurrentName, true);
        } else {
            contentLoadFolder(contentCurrentPath);
        }
    }, 3000);
}
} catch (e) {
toast(`Upload failed: ${e.message}`, 'error');
}
}

async function _pollUploadStatus(fileId, path) {
const poll = async () => {
    try {
        const s = await api(`/content/release-status/${fileId}`);
        if (s.status === 'done') {
            toast(s.message || 'Upload complete âœ…', 'success');
            // Refresh to show updated badge
            if (previewCurrentPath && previewCurrentPath === path) {
                contentPreviewFile(previewCurrentPath, previewCurrentName, true);
            } else {
                contentLoadFolder(contentCurrentPath);
            }
            return;
        }
        if (s.status === 'failed') {
            toast(`Upload failed: ${s.message}`, 'error');
            if (previewCurrentPath && previewCurrentPath === path) {
                contentPreviewFile(previewCurrentPath, previewCurrentName, true);
            }
            return;
        }
        // Still uploading â€” poll again
        setTimeout(poll, 2000);
    } catch {
        // Status endpoint errored â€” stop polling
        setTimeout(() => {
            if (previewCurrentPath && previewCurrentPath === path) {
                contentPreviewFile(previewCurrentPath, previewCurrentName, true);
            }
        }, 3000);
    }
};
setTimeout(poll, 2000);
}

// â”€â”€ Orphaned release fix (modal chooser) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _orphanFixPath = '';
let _orphanFixName = '';

function contentFixOrphanedRelease(path, name) {
_orphanFixPath = path;
_orphanFixName = name;
const modal = document.getElementById('ct-orphan-modal');
const info = document.getElementById('ct-orphan-modal-info');
const status = document.getElementById('ct-orphan-modal-status');
const cleanBtn = document.getElementById('ct-orphan-clean-btn');
const reuploadBtn = document.getElementById('ct-orphan-reupload-btn');
info.innerHTML = `File: <strong>${esc(name)}</strong><br><code style="font-size:0.82rem;word-break:break-all">${esc(path)}</code>`;
status.style.display = 'none';
cleanBtn.disabled = false;
cleanBtn.textContent = 'ğŸ—‘ï¸ Clean sidecar';
reuploadBtn.disabled = false;
reuploadBtn.textContent = 'â¬†ï¸ Re-upload';
modal.style.display = 'flex';
}

async function contentDoReuploadOrphan() {
const modal = document.getElementById('ct-orphan-modal');
const status = document.getElementById('ct-orphan-modal-status');
const btn = document.getElementById('ct-orphan-reupload-btn');
btn.disabled = true;
btn.textContent = 'â³ Uploadingâ€¦';
status.style.display = 'block';
status.innerHTML = '<span class="spinner"></span> Re-uploading to releaseâ€¦';
try {
const result = await api('/backup/upload-release', {
method: 'POST',
body: JSON.stringify({ path: _orphanFixPath }),
});
modal.style.display = 'none';
toast(result.message || 'Re-upload started', 'success');
const orphanBar = document.getElementById('content-preview-orphan-bar');
if (orphanBar) orphanBar.style.display = 'none';
// Poll status until done
if (result.file_id) {
    _pollUploadStatus(result.file_id, _orphanFixPath);
} else {
    setTimeout(() => {
        if (previewCurrentPath && previewCurrentPath === _orphanFixPath) {
            contentPreviewFile(previewCurrentPath, previewCurrentName, true);
        } else {
            contentLoadFolder(contentCurrentPath);
        }
    }, 3000);
}
} catch (e) {
status.innerHTML = `<span style="color:var(--error)">âŒ ${esc(e.message)}</span>`;
btn.disabled = false;
btn.textContent = 'â¬†ï¸ Re-upload';
}
}

async function contentDoCleanOrphan() {
const modal = document.getElementById('ct-orphan-modal');
const status = document.getElementById('ct-orphan-modal-status');
const btn = document.getElementById('ct-orphan-clean-btn');
btn.disabled = true;
btn.textContent = 'â³ Cleaningâ€¦';
status.style.display = 'block';
status.innerHTML = '<span class="spinner"></span> Removing stale sidecarâ€¦';
try {
await api('/content/clean-release-sidecar', {
method: 'POST',
body: JSON.stringify({ path: _orphanFixPath }),
});
modal.style.display = 'none';
toast('Sidecar cleaned', 'success');
const orphanBar = document.getElementById('content-preview-orphan-bar');
if (orphanBar) orphanBar.style.display = 'none';
if (previewCurrentPath && previewCurrentPath === _orphanFixPath) {
contentPreviewFile(previewCurrentPath, previewCurrentName, false);
} else {
await contentLoadFolder(contentCurrentPath);
}
} catch (e) {
status.innerHTML = `<span style="color:var(--error)">âŒ ${esc(e.message)}</span>`;
btn.disabled = false;
btn.textContent = 'ğŸ—‘ï¸ Clean sidecar';
}
}