<script>
    // â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    document.addEventListener('DOMContentLoaded', async () => {
        // Dev mode identity check (non-blocking â€” don't delay critical paint)
        _bootDevMode();

        // Restore tab from URL hash FIRST â€” so the correct tab is visible instantly
        restoreFromHash();

        // â”€â”€ First-launch detection â”€â”€
        // If no explicit hash was set (user landed on root), check if project
        // is configured. If not â†’ redirect to the wizard.
        if (!location.hash || location.hash === '#dashboard') {
            try {
                const cached = cardCached('project-status');
                const ps = cached || await api('/project/status');
                if (!cached) cardStore('project-status', ps);
                const proj = (ps.integrations || {}).project || {};
                if (proj.status === 'missing') {
                    switchTab('wizard');
                    toast('ğŸ‘‹ Welcome! Let\u2019s set up your project.', 'info');
                }
            } catch (_) { /* status endpoint unavailable â€” continue normally */ }
        }

        // â”€â”€ Post-wizard "Next Steps" â”€â”€
        // If the wizard just saved (flag set by wizard save), show next steps.
        if (window._showNextStepsAfterSave) {
            window._showNextStepsAfterSave = false;
            _showPostWizardNextSteps();
        }

        // Critical path â€” visible on landing (both fast)
        await Promise.all([
            loadProjectPulse(),
            loadToolsStatus(),
        ]);

        // Activate dashboard assistant (cards are rendered, panel can listen)
        activateDashboardAssistant();

        // Deferred â€” heavier probes, load after critical paint
        Promise.allSettled([
            loadCapabilities(),
            loadSetupProgress(),
            loadProjectGrade(),
            checkGitAuth(),
        ]).then(() => {
            loadAttentionItems();
            // Re-activate to pick up new dynamic children from deferred loads
            activateDashboardAssistant();
        });
    });

    /** Show a "Next Steps" modal after the wizard saves project.yml. */
    async function _showPostWizardNextSteps() {
        let status;
        try {
            status = await api('/project/status');
        } catch (_) { return; }

        const integrations = status.integrations || {};

        // Fetch user prefs so we don't suggest integrations the user hid
        let prefs = {};
        try { prefs = await api('/devops/prefs'); } catch (_) {}

        const incomplete = Object.entries(integrations)
            .filter(([k, v]) => v.status !== 'ready' && prefs[k] !== 'hidden' && prefs['int:' + k] !== 'hidden')
            .slice(0, 3);

        if (incomplete.length === 0) return; // everything's configured already

        // Use first visible incomplete integration as the suggestion
        // (backend suggested_next ignores user prefs and may be cached/stale)
        let suggested = incomplete[0][0];

        const meta = {
            git: { icon: 'ğŸ”€', label: 'Git Repository' },
            docker: { icon: 'ğŸ³', label: 'Docker' },
            github: { icon: 'ğŸ™', label: 'GitHub' },
            cicd: { icon: 'âš¡', label: 'CI/CD Pipeline' },
            k8s: { icon: 'â˜¸ï¸', label: 'Kubernetes' },
            terraform: { icon: 'ğŸ—ï¸', label: 'Terraform' },
            pages: { icon: 'ğŸ“„', label: 'Pages' },
            dns: { icon: 'ğŸŒ', label: 'DNS / Domain' },
        };

        let rows = '';
        for (const [key, info] of incomplete) {
            const m = meta[key] || { icon: 'â“', label: key };
            const isSuggested = key === suggested;
            rows += `<div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;
                border-radius:var(--radius-sm);border:1px solid ${isSuggested ? 'var(--accent)' : 'var(--border-subtle)'};
                background:${isSuggested ? 'var(--accent-glow)' : 'transparent'};margin-bottom:6px">
                <span style="font-size:1.1rem">${m.icon}</span>
                <span style="flex:1;font-size:0.82rem;font-weight:500">${esc(m.label)}</span>
                <span style="font-size:0.68rem;color:var(--text-muted)">${info.status}</span>
                <button class="btn btn-sm ${isSuggested ? 'btn-primary' : 'btn-secondary'}"
                    onclick="modalClose();openSetupWizard('${key}')"
                    style="font-size:0.68rem;padding:2px 8px">Set up â†’</button>
            </div>`;
        }

        modalOpen({
            title: 'ğŸ‰ Project saved! Here\u2019s what\u2019s next',
            body: `<p style="font-size:0.82rem;color:var(--text-muted);margin-bottom:var(--space-md)">
                Your project.yml is ready. Set up integrations to build your DevOps pipeline:</p>
                ${rows}`,
            size: 'narrow',
            footerButtons: [
                { label: 'Skip for now', cls: 'btn-ghost', onclick: 'modalClose();switchTab("dashboard")' },
                suggested
                    ? { label: `Set up ${(meta[suggested] || {}).label || suggested} â†’`, cls: 'btn-primary', onclick: `modalClose();openSetupWizard('${suggested}')` }
                    : { label: 'Go to Dashboard', cls: 'btn-primary', onclick: 'modalClose();switchTab("dashboard")' },
            ],
        });
    }
</script>