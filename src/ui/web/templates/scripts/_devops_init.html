/* DevOps Tab JS ‚Äî Init & Tab Load
     State vars, prefs, card metadata, loadDevopsTab(), prefs modal.
     Depends on: _globals.html (cardCached, cardStore, cardInvalidate, api, esc, toast)
*/
    // ‚îÄ‚îÄ DevOps tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Uses shared cache from _globals.html (cardCached / cardStore / cardInvalidate)

    let _devopsLoaded = false;

    // Card metadata: key ‚Üí { loadFn, badgeId, detailId, cardId, label }
    const _DEVOPS_CARDS = {
        security:  { loadFn: () => loadSecurityCard(),  label: 'üîê Security' },
        testing:   { loadFn: () => loadTestingCard(),   label: 'üß™ Testing' },
        quality:   { loadFn: () => loadQualityCard(),   label: 'üîß Quality' },
        packages:  { loadFn: () => loadPackagesCard(),  label: 'üì¶ Packages' },
        env:       { loadFn: () => loadEnvCard(),       label: '‚öôÔ∏è Environment' },
        docs:      { loadFn: () => loadDocsCard(),      label: 'üìö Docs' },
        k8s:       { loadFn: () => loadK8sCard(),       label: '‚ò∏Ô∏è Kubernetes' },
        terraform: { loadFn: () => loadTerraformCard(), label: 'üèóÔ∏è Terraform' },
        dns:       { loadFn: () => loadDnsCard(),       label: 'üåê DNS & CDN' },
    };

    // Current prefs (fetched once per session)
    let _devopsPrefs = null;

    async function _fetchDevopsPrefs() {
        if (_devopsPrefs) return _devopsPrefs;
        try {
            _devopsPrefs = await api('/devops/prefs');
        } catch {
            // Default: all auto
            _devopsPrefs = Object.fromEntries(Object.keys(_DEVOPS_CARDS).map(k => [k, 'auto']));
        }
        return _devopsPrefs;
    }

    async function loadDevopsTab(force) {
        if (force) {
            cardInvalidateAll();
            // Bust ALL server-side caches
            api('/devops/cache/bust', { method: 'POST', body: JSON.stringify({ card: 'all' }) }).catch(() => {});
            _devopsLoaded = false;
            _devopsPrefs = null; // Re-fetch prefs too
        }
        if (_devopsLoaded) return;

        const prefs = await _fetchDevopsPrefs();

        // Apply visibility + loading per preference
        for (const [key, meta] of Object.entries(_DEVOPS_CARDS)) {
            const card = document.getElementById('devops-' + key + '-card');
            const detail = document.getElementById('devops-' + key + '-detail');
            const badge = document.getElementById('devops-' + key + '-badge');
            const pref = prefs[key] || 'auto';

            if (!card) continue;

            if (pref === 'hidden') {
                card.style.display = 'none';
                continue;
            }
            card.style.display = '';

            if (pref === 'manual') {
                // Show "click to load" instead of spinner
                if (badge) { badge.className = 'status-badge'; badge.textContent = '‚è∏'; }
                if (detail) {
                    detail.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;gap:0.5rem;padding:1rem 0">
                        <span style="color:var(--text-muted);font-size:0.82rem">Manual load ‚Äî click to fetch</span>
                        <button class="btn btn-sm btn-secondary" onclick="(async()=>{
                            const d=document.getElementById('devops-${key}-detail');
                            const b=document.getElementById('devops-${key}-badge');
                            if(d)d.innerHTML='<span class=\\'spinner\\'></span>';
                            if(b){b.className='status-badge';b.textContent='‚Äî';}
                            await _DEVOPS_CARDS['${key}'].loadFn();
                        })()" style="font-size:0.78rem">‚ñ∂ Load ${esc(meta.label)}</button>
                    </div>`;
                }
                continue;
            }

            // auto: show spinner and load
            if (detail && !cardCached(key)) detail.innerHTML = '<span class="spinner"></span>';
            if (badge && !cardCached(key)) { badge.className = 'status-badge'; badge.textContent = '‚Äî'; }
        }

        // Load auto + visible cards in parallel (server is threaded)
        const autoCards = Object.entries(_DEVOPS_CARDS)
            .filter(([key]) => {
                const pref = prefs[key] || 'auto';
                return pref === 'auto' || pref === 'visible';
            });

        await Promise.allSettled(autoCards.map(async ([key, meta]) => {
            try {
                await meta.loadFn();
            } catch (e) {
                console.error(`[DEVOPS] ${key}:`, e);
                const b = document.getElementById('devops-' + key + '-badge');
                const d = document.getElementById('devops-' + key + '-detail');
                if (b) { b.className = 'status-badge failed'; b.innerHTML = '<span class="status-dot"></span>Error'; }
                if (d) d.innerHTML = `<p class="empty-state-sm" style="color:var(--error)">${esc(e.message || 'Load failed')}</p>`;
            }
        }));

        _devopsLoaded = true;
    }

    /** Open preferences modal for DevOps cards. */
    function openDevopsPrefsModal() {
        const prefs = _devopsPrefs || {};
        let rows = '';
        for (const [key, meta] of Object.entries(_DEVOPS_CARDS)) {
            const cur = prefs[key] || 'auto';
            rows += `<div style="display:flex;align-items:center;justify-content:space-between;padding:0.5rem 0;border-bottom:1px solid var(--border-subtle)">
                <span style="font-size:0.85rem;font-weight:500">${meta.label}</span>
                <select id="pref-${key}" style="font-size:0.8rem;padding:0.25rem 0.5rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-inset);color:var(--text-primary)">
                    <option value="auto" ${cur==='auto'?'selected':''}>Auto</option>
                    <option value="manual" ${cur==='manual'?'selected':''}>Manual</option>
                    <option value="hidden" ${cur==='hidden'?'selected':''}>Hidden</option>
                </select>
            </div>`;
        }

        modalOpen({
            title: '‚öôÔ∏è Card Preferences',
            body: `<p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.75rem">
                    <strong>Auto</strong> ‚Äî loads when tab opens &nbsp;
                    <strong>Manual</strong> ‚Äî click to load &nbsp;
                    <strong>Hidden</strong> ‚Äî not shown
                </p>${rows}`,
            size: 'narrow',
            footerButtons: [
                { label: 'üßô Wizard', cls: 'btn-ghost', onclick: 'modalClose();openFullSetupWizard()' },
                { label: 'Cancel', cls: 'btn-secondary', onclick: 'modalClose()' },
                { label: 'Save', cls: 'btn-primary', onclick: '_saveDevopsPrefs()' },
            ],
        });
    }

    async function _saveDevopsPrefs() {
        const prefs = {};
        for (const key of Object.keys(_DEVOPS_CARDS)) {
            const sel = document.getElementById('pref-' + key);
            prefs[key] = sel ? sel.value : 'auto';
        }
        try {
            _devopsPrefs = await api('/devops/prefs', { method: 'PUT', body: JSON.stringify(prefs) });
            toast('Card preferences saved', 'success');
            modalClose();
            // Reload tab with new prefs
            _devopsLoaded = false;
            cardInvalidateAll();
            loadDevopsTab();
        } catch (e) {
            toast('Failed to save: ' + e.message, 'error');
        }
    }

