<!-- Integrations ‚Äî Terraform Setup Wizard
     5-step wizard: Detect ‚Üí Provider & Backend ‚Üí Resources ‚Üí Environments ‚Üí Review & Generate
     Depends on: _integrations_setup_shared.html, _globals_wizard_modal.html
-->
<script>

    // ‚îÄ‚îÄ Terraform Setup Wizard ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function openTerraformSetupWizard() {

        // Region defaults per provider
        const _tfRegionDefaults = {
            aws: 'us-east-1',
            gcp: 'us-central1',
            azure: 'eastus',
            digitalocean: 'nyc1',
            custom: '',
        };

        // Provider display labels
        const _tfProviderLabels = {
            aws: 'Amazon Web Services',
            gcp: 'Google Cloud Platform',
            azure: 'Microsoft Azure',
            digitalocean: 'DigitalOcean',
            custom: 'Custom',
        };

        // Provider-specific service names
        const _tfServiceNames = {
            aws:          { k8s: 'EKS',  registry: 'ECR',  db: 'RDS',       storage: 'S3',           vpc: 'VPC' },
            gcp:          { k8s: 'GKE',  registry: 'GAR',  db: 'Cloud SQL', storage: 'GCS',          vpc: 'VPC Network' },
            azure:        { k8s: 'AKS',  registry: 'ACR',  db: 'Azure DB',  storage: 'Blob Storage', vpc: 'VNet' },
            digitalocean: { k8s: 'DOKS', registry: 'DOCR', db: 'Managed DB', storage: 'Spaces',      vpc: 'VPC' },
            custom:       { k8s: 'K8s',  registry: 'Registry', db: 'Database', storage: 'Storage',   vpc: 'Networking' },
        };

        // Node size defaults per provider
        const _tfNodeDefaults = {
            aws:          { size: 't3.medium',        version: '1.29' },
            gcp:          { size: 'e2-medium',         version: '1.29' },
            azure:        { size: 'Standard_D2s_v3',   version: '1.29' },
            digitalocean: { size: 's-2vcpu-4gb',       version: '1.29' },
        };

        // Backend descriptions
        const _tfBackendHints = {
            local:   'State stored on disk ‚Äî simple, no sharing or locking.',
            s3:      'AWS S3 bucket with optional DynamoDB locking ‚Äî team-friendly.',
            gcs:     'Google Cloud Storage bucket ‚Äî built-in locking.',
            azurerm: 'Azure Blob container ‚Äî built-in locking via lease.',
        };

        wizardModalOpen({
            title: 'üèóÔ∏è Terraform Setup',
            size: 'wide',
            steps: [
                // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                // Step 1 ‚Äî Detect (Environment Scan)
                // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                {
                    id: 'detect', title: 'Detect', cacheable: true,
                    render: async (data, el) => {
                        const _CK = 'tf:detect';
                        const cached = wizCached(_CK);
                        if (cached) {
                            Object.assign(data, cached.d);
                            el.innerHTML = _wizDetectBanner(_CK) + cached.h;
                            return;
                        }

                        el.innerHTML = '<p style="text-align:center;padding:2rem"><span class="spinner"></span> Scanning Terraform environment‚Ä¶</p>';

                        try {
                            const _bust = window._wizForceRescan ? '?bust=1' : ''; window._wizForceRescan = false;

                            // Full terraform status (providers, resources, modules, backend, files)
                            const tf = await api('/terraform/status' + _bust);
                            data._tf = tf;

                            // Wizard detect for cross-domain context + environments
                            const wizDetect = wizCached('detect') || await api('/wizard/detect' + _bust).then(d => { wizStore('detect', d); return d; });
                            const probes = (typeof wizDetect === 'object' && wizDetect.status_probes) ? wizDetect.status_probes : {};
                            const configData = wizDetect.config_data || {};

                            data._crossDomain = {
                                k8s:    probes.kubernetes || {},
                                docker: probes.docker || {},
                                cicd:   probes.cicd || probes.ci || {},
                            };
                            // Project environments from project.yml ‚Äî the REAL source
                            data._projectEnvs = configData.environments || [];
                            data._projectName = wizDetect._project_name || '';

                            const cli = tf.cli || {};
                            const files = tf.files || [];
                            const providers = tf.providers || [];
                            const resources = tf.resources || [];
                            const modules = tf.modules || [];
                            const backend = tf.backend;

                            // ‚îÄ‚îÄ Build detection HTML ‚îÄ‚îÄ
                            let html = wizSection('Terraform Environment', 'Current Infrastructure as Code configuration.');
                            html += '<div class="wiz-status-grid">';

                            // CLI
                            html += wizStatusRow('üîß', 'Terraform CLI',
                                cli.available ? ('v' + (cli.version || '').split(' ')[0]) : 'Not installed',
                                cli.available ? 'ok' : 'error');

                            // TF Root
                            html += wizStatusRow('üìÅ', 'Configuration Root',
                                tf.root || 'No .tf files found',
                                tf.root ? 'ok' : 'muted');

                            // Files ‚Äî classified breakdown
                            if (files.length > 0) {
                                const typeCounts = {};
                                files.forEach(f => { typeCounts[f.type] = (typeCounts[f.type] || 0) + 1; });
                                const chips = Object.entries(typeCounts).map(([t, c]) =>
                                    '<span style="display:inline-block;padding:1px 6px;border-radius:3px;background:var(--bg-card);border:1px solid var(--border-subtle);font-size:0.72rem;margin:1px">' +
                                    esc(c + '√ó' + t) + '</span>'
                                ).join(' ');
                                html += wizStatusRow('üìÑ', 'Files (' + files.length + ')', chips, 'ok', true);
                            } else {
                                html += wizStatusRow('üìÑ', 'TF Files', 'None found', 'muted');
                            }

                            // Providers
                            if (providers.length > 0) {
                                const chips = providers.map(p => {
                                    const name = typeof p === 'string' ? p : (p.name || p.source || String(p));
                                    return '<span style="display:inline-block;padding:2px 8px;border-radius:4px;background:rgba(100,180,255,0.1);border:1px solid rgba(100,180,255,0.2);font-size:0.75rem;font-weight:600;margin:1px;color:var(--accent)">' +
                                        esc(name) + '</span>';
                                }).join(' ');
                                html += wizStatusRow('‚òÅÔ∏è', 'Providers', chips, 'ok', true);
                            } else {
                                html += wizStatusRow('‚òÅÔ∏è', 'Providers', 'None detected', 'muted');
                            }

                            // Resources
                            if (resources.length > 0) {
                                const typeGroups = {};
                                resources.forEach(r => { typeGroups[r.type] = (typeGroups[r.type] || 0) + 1; });
                                const summary = Object.entries(typeGroups).slice(0, 4)
                                    .map(([t, c]) => c + '√ó' + t).join(', ');
                                const more = Object.keys(typeGroups).length > 4 ? ', ‚Ä¶' : '';
                                html += wizStatusRow('üì¶', 'Resources (' + resources.length + ')',
                                    summary + more, 'ok');
                            } else {
                                html += wizStatusRow('üì¶', 'Resources', 'None', 'muted');
                            }

                            // Modules
                            if (modules.length > 0) {
                                const modNames = modules.map(m => esc(m.name || String(m))).join(', ');
                                html += wizStatusRow('üìö', 'Modules (' + modules.length + ')', modNames, 'ok');
                            }

                            // Backend
                            if (backend) {
                                const bType = typeof backend === 'string' ? backend : (backend.type || 'unknown');
                                html += wizStatusRow('üíæ', 'State Backend',
                                    '<span style="font-weight:600;color:var(--accent)">' + esc(bType) + '</span>', 'ok', true);
                            } else {
                                html += wizStatusRow('üíæ', 'State Backend', 'Not configured', 'muted');
                            }

                            // Initialized
                            html += wizStatusRow('‚öôÔ∏è', 'Initialized',
                                tf.initialized ? 'Yes (.terraform/ exists)' : 'No',
                                tf.initialized ? 'ok' : 'muted');

                            html += '</div>';

                            // ‚îÄ‚îÄ Cross-domain context ‚îÄ‚îÄ
                            const xd = data._crossDomain;
                            const xdHints = [];
                            if (xd.k8s.status === 'ready' || xd.k8s.status === 'partial')
                                xdHints.push({ icon: '‚ò∏Ô∏è', text: 'Kubernetes detected ‚Äî cluster IaC available in Resources step', color: 'var(--success)' });
                            if (xd.docker.status === 'ready' || xd.docker.status === 'partial')
                                xdHints.push({ icon: 'üê≥', text: 'Docker detected ‚Äî container registry can be provisioned', color: 'var(--info, #60a0ff)' });
                            if (xd.cicd.status === 'ready' || xd.cicd.status === 'partial')
                                xdHints.push({ icon: 'üîÑ', text: 'CI/CD detected ‚Äî pipeline can trigger plan/apply', color: 'var(--info, #60a0ff)' });

                            if (xdHints.length > 0) {
                                html += '<div style="margin-top:var(--space-md);padding:0.6rem 0.8rem;border-radius:8px;background:rgba(100,180,255,0.05);border:1px solid rgba(100,180,255,0.12)">';
                                html += '<div style="font-size:0.78rem;font-weight:700;color:var(--text-secondary);margin-bottom:6px;letter-spacing:0.02em">üîó Cross-Domain Integrations</div>';
                                xdHints.forEach(h => {
                                    html += '<div style="display:flex;align-items:center;gap:6px;font-size:0.76rem;padding:3px 0">' +
                                        '<span>' + h.icon + '</span>' +
                                        '<span style="color:var(--text-muted)">' + esc(h.text) + '</span></div>';
                                });
                                html += '</div>';
                            }

                            // Pre-fill for Step 2
                            if (providers.length > 0 && !data.provider) {
                                const firstProv = typeof providers[0] === 'string' ? providers[0] : (providers[0].name || '');
                                if (firstProv.includes('aws') || firstProv === 'aws') data.provider = 'aws';
                                else if (firstProv.includes('google')) data.provider = 'gcp';
                                else if (firstProv.includes('azurerm')) data.provider = 'azure';
                                else if (firstProv.includes('digitalocean')) data.provider = 'digitalocean';
                            }
                            if (backend && !data.backend) {
                                const bType = typeof backend === 'string' ? backend : (backend.type || '');
                                if (['local', 's3', 'gcs', 'azurerm'].includes(bType)) data.backend = bType;
                            }

                            // Cache
                            const _serverTs = (tf._cache?.computed_at || 0) * 1000;
                            wizStore(_CK, {
                                h: html,
                                d: {
                                    _tf: data._tf, _crossDomain: data._crossDomain,
                                    _projectEnvs: data._projectEnvs, _projectName: data._projectName,
                                    provider: data.provider, backend: data.backend,
                                },
                            }, _serverTs);
                            el.innerHTML = _wizDetectBanner(_CK) + html;

                        } catch (e) {
                            el.innerHTML = `<div class="wiz-step-error-panel"><span>‚ö†Ô∏è</span><span>${esc(e.message)}</span></div>`;
                        }
                    },
                },

                // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                // Step 2 ‚Äî Provider & Backend (Cloud Setup)
                // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                {
                    id: 'provider', title: 'Cloud Setup',
                    render: (data, el) => {
                        const detectedProvider = data.provider || 'aws';
                        const detectedBackend = data.backend || 'local';
                        const detectedRegion = data.region || _tfRegionDefaults[detectedProvider] || 'us-east-1';
                        const projectName = data.projectName || data._projectName || '';

                        el.innerHTML =
                            wizSection('Cloud Provider', 'Select your target cloud platform and deployment region.') +
                            wizFormGrid([
                                { name: 'tf-provider', label: 'Cloud Provider', type: 'select', value: detectedProvider, options: [
                                    { value: 'aws', label: '‚òÅÔ∏è AWS (Amazon Web Services)' },
                                    { value: 'gcp', label: '‚òÅÔ∏è Google Cloud Platform' },
                                    { value: 'azure', label: '‚òÅÔ∏è Microsoft Azure' },
                                    { value: 'digitalocean', label: 'üåä DigitalOcean' },
                                    { value: 'custom', label: '‚öôÔ∏è Custom / Other' },
                                ], required: true },
                                { name: 'tf-region', label: 'Region', value: detectedRegion, hint: 'Primary deployment region ‚Äî auto-updates with provider' },
                            ]) +

                            // Provider context hint
                            '<div id="tf-provider-hint" style="margin:-0.2rem 0 var(--space-md);padding:0.35rem 0.6rem;border-radius:4px;font-size:0.74rem;color:var(--text-muted);background:rgba(100,180,255,0.04);border:1px solid rgba(100,180,255,0.08)">' +
                                esc(_tfProviderLabels[detectedProvider] || '') +
                            '</div>' +

                            wizSection('Project Identity', 'Used for resource naming, state bucket, and tags.') +
                            wizFormGrid([
                                { name: 'tf-project-name', label: 'Project Name', value: projectName,
                                  placeholder: 'auto-detected from directory',
                                  hint: 'Used in backend bucket names, resource tags, and naming conventions', fullWidth: true },
                            ]) +

                            wizSection('State Backend', 'Where Terraform stores its state file ‚Äî critical for team collaboration.') +
                            wizFormGrid([
                                { name: 'tf-backend', label: 'State Backend', type: 'select', value: detectedBackend, options: [
                                    { value: 'local', label: 'üíª Local (terraform.tfstate)' },
                                    { value: 's3', label: '‚òÅÔ∏è AWS S3 + DynamoDB locking' },
                                    { value: 'gcs', label: '‚òÅÔ∏è Google Cloud Storage' },
                                    { value: 'azurerm', label: '‚òÅÔ∏è Azure Blob Storage' },
                                ], fullWidth: true },
                            ]) +

                            // Backend hint
                            '<div id="tf-backend-hint" style="margin:-0.2rem 0 var(--space-xs);padding:0.35rem 0.6rem;border-radius:4px;font-size:0.74rem;color:var(--text-muted);background:rgba(100,180,255,0.04);border:1px solid rgba(100,180,255,0.08)">' +
                                esc(_tfBackendHints[detectedBackend] || '') +
                            '</div>' +

                            // Conditional backend config
                            '<div id="tf-backend-extra" style="display:' + (detectedBackend !== 'local' ? 'block' : 'none') + '">' +
                                wizFormGrid([
                                    { name: 'tf-state-bucket', label: 'State Bucket / Container', value: data.stateBucket || '',
                                      placeholder: (projectName || 'project').replace(/[^a-z0-9-]/gi, '-').toLowerCase() + '-tfstate',
                                      hint: 'S3 bucket, GCS bucket, or Azure container for remote state' },
                                ]) +
                            '</div>';

                        // Wire provider ‚Üí region + hint update
                        const provSel = document.getElementById('mf-tf-provider');
                        const regionEl = document.getElementById('mf-tf-region');
                        const provHint = document.getElementById('tf-provider-hint');
                        if (provSel) {
                            provSel.addEventListener('change', () => {
                                if (regionEl) {
                                    const isDefault = Object.values(_tfRegionDefaults).includes(regionEl.value);
                                    if (isDefault || !regionEl.value)
                                        regionEl.value = _tfRegionDefaults[provSel.value] || '';
                                }
                                if (provHint) provHint.textContent = _tfProviderLabels[provSel.value] || '';
                            });
                        }

                        // Wire backend ‚Üí hint + extra fields
                        const backendSel = document.getElementById('mf-tf-backend');
                        const backendHint = document.getElementById('tf-backend-hint');
                        const extraDiv = document.getElementById('tf-backend-extra');
                        if (backendSel) {
                            backendSel.addEventListener('change', () => {
                                const v = backendSel.value;
                                if (backendHint) backendHint.textContent = _tfBackendHints[v] || '';
                                if (extraDiv) extraDiv.style.display = v !== 'local' ? 'block' : 'none';
                            });
                        }
                    },
                    collect: (data) => {
                        data.provider = mfVal('tf-provider');
                        data.region = mfVal('tf-region');
                        data.projectName = mfVal('tf-project-name');
                        data.backend = mfVal('tf-backend');
                        data.stateBucket = mfVal('tf-state-bucket');
                    },
                    validate: (data) => {
                        if (!data.provider) return 'Please select a cloud provider.';
                        if (!data.region && data.provider !== 'custom') return 'Please specify a region.';
                        return null;
                    },
                },

                // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                // Step 3 ‚Äî Resources (Infrastructure)
                // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                {
                    id: 'resources', title: 'Resources',
                    render: (data, el) => {
                        const provider = data.provider || 'aws';
                        const svcNames = _tfServiceNames[provider] || _tfServiceNames.custom;
                        const nodeDefaults = _tfNodeDefaults[provider] || _tfNodeDefaults.aws;
                        const xd = data._crossDomain || {};

                        let html = wizSection('Infrastructure Resources',
                            'Select what cloud infrastructure to provision for ' + esc(_tfProviderLabels[provider] || provider) + '.');

                        // ‚îÄ‚îÄ K8s Cluster ‚îÄ‚îÄ
                        const k8sDetected = xd.k8s && (xd.k8s.status === 'ready' || xd.k8s.status === 'partial');
                        html += `<div class="wiz-resource-block" style="margin-bottom:var(--space-sm);padding:0.6rem 0.75rem;border-radius:8px;border:1px solid var(--border-subtle);background:var(--bg-card)">
                            <label class="modal-form-check" style="margin:0;font-weight:600">
                                <input type="checkbox" id="mf-tf-k8s" name="tf-k8s"${data.k8sCluster ? ' checked' : ''}>
                                ‚ò∏Ô∏è Kubernetes Cluster (${esc(svcNames.k8s)})
                            </label>
                            <div style="font-size:0.74rem;color:var(--text-muted);margin:2px 0 0 1.55rem">
                                Managed cluster with worker nodes ‚Äî full IaC via cross-domain generator.
                                ${k8sDetected ? '<span style="color:var(--success)">‚úì K8s integration active</span>' : ''}
                            </div>
                            <div id="tf-k8s-config" style="display:${data.k8sCluster ? 'block' : 'none'};margin:var(--space-xs) 0 0 1.55rem;padding:var(--space-xs) var(--space-sm);border-radius:6px;background:rgba(100,180,255,0.03);border:1px solid rgba(100,180,255,0.08)">
                                ${wizFormGrid([
                                    { name: 'tf-node-count', label: 'Worker Nodes', type: 'number', value: String(data.nodeCount || 2), hint: '1‚Äì10 nodes' },
                                    { name: 'tf-node-size', label: 'Instance Type', value: data.nodeSize || nodeDefaults.size, hint: 'e.g. ' + nodeDefaults.size },
                                    { name: 'tf-k8s-version', label: 'K8s Version', value: data.k8sVersion || nodeDefaults.version, hint: 'Cluster version' },
                                ])}
                            </div>
                        </div>`;

                        // ‚îÄ‚îÄ Container Registry ‚îÄ‚îÄ
                        const dockerDetected = xd.docker && (xd.docker.status === 'ready' || xd.docker.status === 'partial');
                        html += `<div class="wiz-resource-block" style="margin-bottom:var(--space-sm);padding:0.6rem 0.75rem;border-radius:8px;border:1px solid var(--border-subtle);background:var(--bg-card)">
                            <label class="modal-form-check" style="margin:0;font-weight:600">
                                <input type="checkbox" id="mf-tf-registry" name="tf-registry"${data.registry ? ' checked' : ''}>
                                üì¶ Container Registry (${esc(svcNames.registry)})
                            </label>
                            <div style="font-size:0.74rem;color:var(--text-muted);margin:2px 0 0 1.55rem">
                                Private image registry for CI/CD ‚Äî auto-determined from provider.
                                ${dockerDetected ? '<span style="color:var(--success)">‚úì Docker integration active</span>' : ''}
                            </div>
                        </div>`;

                        // ‚îÄ‚îÄ VPC / Networking ‚îÄ‚îÄ
                        html += `<div class="wiz-resource-block" style="margin-bottom:var(--space-sm);padding:0.6rem 0.75rem;border-radius:8px;border:1px solid var(--border-subtle);background:var(--bg-card)">
                            <label class="modal-form-check" style="margin:0;font-weight:600">
                                <input type="checkbox" id="mf-tf-networking" name="tf-networking"${data.networking !== false ? ' checked' : ''}>
                                üåê ${esc(svcNames.vpc)} / Networking
                            </label>
                            <div style="font-size:0.74rem;color:var(--text-muted);margin:2px 0 0 1.55rem">
                                Virtual network, subnets, security groups. Included automatically with K8s cluster.
                            </div>
                        </div>`;

                        // ‚îÄ‚îÄ Database ‚îÄ‚îÄ
                        html += `<div class="wiz-resource-block" style="margin-bottom:var(--space-sm);padding:0.6rem 0.75rem;border-radius:8px;border:1px solid var(--border-subtle);background:var(--bg-card)">
                            <label class="modal-form-check" style="margin:0;font-weight:600">
                                <input type="checkbox" id="mf-tf-database" name="tf-database"${data.database ? ' checked' : ''}>
                                üóÑÔ∏è Database (${esc(svcNames.db)})
                            </label>
                            <div style="font-size:0.74rem;color:var(--text-muted);margin:2px 0 0 1.55rem">
                                Managed database instance.
                                <span style="font-size:0.68rem;padding:1px 4px;border-radius:3px;background:rgba(232,168,32,0.1);color:var(--warning)">scaffold</span>
                                ‚Äî generates commented resource block, configure in .tf files.
                            </div>
                        </div>`;

                        // ‚îÄ‚îÄ Object Storage ‚îÄ‚îÄ
                        html += `<div class="wiz-resource-block" style="margin-bottom:var(--space-sm);padding:0.6rem 0.75rem;border-radius:8px;border:1px solid var(--border-subtle);background:var(--bg-card)">
                            <label class="modal-form-check" style="margin:0;font-weight:600">
                                <input type="checkbox" id="mf-tf-storage" name="tf-storage"${data.storage ? ' checked' : ''}>
                                üíæ Object Storage (${esc(svcNames.storage)})
                            </label>
                            <div style="font-size:0.74rem;color:var(--text-muted);margin:2px 0 0 1.55rem">
                                Object storage bucket for assets, uploads, backups.
                                <span style="font-size:0.68rem;padding:1px 4px;border-radius:3px;background:rgba(232,168,32,0.1);color:var(--warning)">scaffold</span>
                                ‚Äî generates commented resource block.
                            </div>
                        </div>`;

                        el.innerHTML = html;

                        // Wire K8s checkbox ‚Üí show/hide config
                        const k8sChk = document.getElementById('mf-tf-k8s');
                        const k8sCfg = document.getElementById('tf-k8s-config');
                        if (k8sChk && k8sCfg) {
                            k8sChk.addEventListener('change', () => {
                                k8sCfg.style.display = k8sChk.checked ? 'block' : 'none';
                            });
                        }
                    },
                    collect: (data) => {
                        data.k8sCluster = mfVal('tf-k8s');
                        if (data.k8sCluster) {
                            data.nodeCount = parseInt(mfVal('tf-node-count'), 10) || 2;
                            data.nodeSize = mfVal('tf-node-size');
                            data.k8sVersion = mfVal('tf-k8s-version');
                        }
                        data.registry = mfVal('tf-registry');
                        data.networking = mfVal('tf-networking');
                        data.database = mfVal('tf-database');
                        data.storage = mfVal('tf-storage');
                    },
                },

                // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                // Step 4 ‚Äî Environments (Workspaces & Variables)
                // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                {
                    id: 'environments', title: 'Environments',
                    render: (data, el) => {
                        // ‚îÄ‚îÄ Seed from project.yml on first render ‚îÄ‚îÄ
                        if (!data._tfEnvs) {
                            const projectEnvs = data._projectEnvs || [];
                            if (projectEnvs.length > 0) {
                                // Use real project environments
                                data._tfEnvs = projectEnvs.map(pe => ({
                                    name: pe.name || 'default',
                                    region: '',  // empty = inherit Step 2 default
                                    isDefault: pe.default || false,
                                }));
                            } else {
                                // Fallback ‚Äî same as CI/CD wizard
                                data._tfEnvs = [
                                    { name: 'staging',    region: '', isDefault: false },
                                    { name: 'production', region: '', isDefault: false },
                                ];
                            }
                        }

                        const defaultRegion = data.region || 'us-east-1';

                        let html = wizSection('Terraform Workspaces',
                            'Map project environments to Terraform workspaces. Each gets its own state and variable file.');

                        // Source indicator
                        const projectEnvs = data._projectEnvs || [];
                        if (projectEnvs.length > 0) {
                            html += '<div style="font-size:0.72rem;color:var(--text-muted);margin-bottom:var(--space-sm);padding:0.3rem 0.5rem;border-radius:4px;background:rgba(100,220,100,0.06);border:1px solid rgba(100,220,100,0.12)">' +
                                'üìã Loaded ' + projectEnvs.length + ' environment(s) from <code style="font-size:0.72rem">project.yml</code></div>';
                        }

                        html += '<div id="tf-env-list">';
                        data._tfEnvs.forEach((env, i) => {
                            const isDefault = env.isDefault;
                            html += `<div style="display:grid;grid-template-columns:auto 1fr auto auto;gap:var(--space-sm);align-items:center;padding:0.55rem 0.7rem;margin-bottom:0.35rem;border-radius:8px;background:var(--bg-card);border:1px solid var(--border-subtle)">
                                <div style="text-align:center">
                                    <div style="font-size:0.85rem;font-weight:700;color:var(--accent)">${esc(env.name)}</div>
                                    ${isDefault ? '<span style="font-size:0.62rem;padding:1px 4px;border-radius:3px;background:rgba(100,220,100,0.1);color:var(--success)">default</span>' : ''}
                                </div>
                                <div style="display:flex;flex-direction:column;gap:2px;font-size:0.74rem;color:var(--text-muted)">
                                    <span>üóÇÔ∏è Workspace: <code style="font-size:0.72rem">${esc(env.name)}</code></span>
                                    <span>üìù Vars file: <code style="font-size:0.72rem">terraform/${esc(env.name)}.tfvars</code></span>
                                    <span>üåé Region: <code style="font-size:0.72rem">${esc(env.region || defaultRegion)}</code>${env.region ? '' : ' <span style="font-size:0.65rem;color:var(--text-muted)">(inherited)</span>'}</span>
                                </div>
                                <input type="text" value="${esc(env.region)}"
                                    placeholder="${esc(defaultRegion)}"
                                    data-env-idx="${i}"
                                    class="modal-form-input tf-env-region"
                                    style="font-size:0.74rem;padding:0.25rem 0.4rem;width:120px"
                                    title="Region override (leave empty to inherit)">
                                <button type="button" onclick="window._tfRemoveEnv(${i})"
                                    style="background:none;border:none;cursor:pointer;color:var(--text-muted);font-size:0.8rem;padding:2px 6px;opacity:0.6"
                                    title="Remove environment">‚úï</button>
                            </div>`;
                        });
                        html += '</div>';

                        // Add environment
                        html += `<div style="display:flex;gap:var(--space-xs);margin-top:var(--space-sm);align-items:center">
                            <input type="text" id="tf-env-new-name" class="modal-form-input"
                                placeholder="Add workspace name‚Ä¶" style="flex:1;font-size:0.8rem;padding:0.35rem 0.5rem">
                            <button type="button" onclick="window._tfAddEnv()"
                                class="btn btn-sm btn-secondary" style="font-size:0.78rem;padding:0.3rem 0.8rem">+ Add</button>
                        </div>`;

                        el.innerHTML = html;

                        // Wire region inputs to sync back to data
                        el.querySelectorAll('.tf-env-region').forEach(inp => {
                            inp.addEventListener('input', () => {
                                const idx = parseInt(inp.dataset.envIdx, 10);
                                if (data._tfEnvs[idx]) data._tfEnvs[idx].region = inp.value.trim();
                            });
                        });

                        // Wire handlers
                        window._tfRemoveEnv = (idx) => {
                            data._tfEnvs.splice(idx, 1);
                            const step = _wizModal.steps[_wizModal.stepIdx];
                            step.render(data, el);
                        };
                        window._tfAddEnv = () => {
                            const inp = document.getElementById('tf-env-new-name');
                            if (!inp) return;
                            const name = inp.value.trim().toLowerCase().replace(/[^a-z0-9_-]/g, '-');
                            if (!name) return;
                            if (data._tfEnvs.some(e => e.name === name)) {
                                inp.style.borderColor = 'var(--error)';
                                setTimeout(() => { inp.style.borderColor = ''; }, 1500);
                                return;
                            }
                            data._tfEnvs.push({ name: name, region: '', isDefault: false });
                            inp.value = '';
                            const step = _wizModal.steps[_wizModal.stepIdx];
                            step.render(data, el);
                        };
                    },
                    collect: (data) => {
                        data.environments = (data._tfEnvs || []).map(e => ({
                            name: e.name,
                            region: e.region || '',
                        }));
                    },
                    validate: (data) => {
                        if (!data.environments || data.environments.length === 0) {
                            return { warn: 'No environments defined ‚Äî Terraform will use the default workspace only.' };
                        }
                        return null;
                    },
                },

                // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                // Step 5 ‚Äî Review & Generate
                // ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
                {
                    id: 'review', title: 'Review & Apply',
                    render: (data, el) => {
                        const tf = data._tf || {};
                        const hasExisting = tf.has_terraform;
                        const provider = data.provider || 'aws';
                        const svcNames = _tfServiceNames[provider] || _tfServiceNames.custom;

                        let html = wizSection('Review Configuration', 'Verify everything before generating Terraform files.');

                        // ‚îÄ‚îÄ Configuration summary ‚îÄ‚îÄ
                        html += '<div style="padding:0.6rem 0.75rem;border-radius:8px;background:var(--bg-card);border:1px solid var(--border-subtle);margin-bottom:var(--space-md)">';
                        html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.3rem 1rem;font-size:0.82rem">';
                        html += `<div>‚òÅÔ∏è <span style="color:var(--text-muted)">Provider</span> <strong>${esc(_tfProviderLabels[provider] || provider)}</strong></div>`;
                        html += `<div>üåé <span style="color:var(--text-muted)">Region</span> <strong>${esc(data.region || '‚Äî')}</strong></div>`;
                        html += `<div>üíæ <span style="color:var(--text-muted)">Backend</span> <strong>${esc(data.backend || 'local')}</strong></div>`;
                        if (data.projectName) {
                            html += `<div>üìÅ <span style="color:var(--text-muted)">Project</span> <strong>${esc(data.projectName)}</strong></div>`;
                        }
                        if (data.stateBucket) {
                            html += `<div>ü™£ <span style="color:var(--text-muted)">State bucket</span> <strong>${esc(data.stateBucket)}</strong></div>`;
                        }
                        html += '</div></div>';

                        // ‚îÄ‚îÄ Resources ‚îÄ‚îÄ
                        const resList = [];
                        if (data.k8sCluster) resList.push({ icon: '‚ò∏Ô∏è', text: svcNames.k8s + ' Cluster ‚Äî ' + (data.nodeCount || 2) + ' √ó ' + esc(data.nodeSize || nodeDefaults?.size || 't3.medium'), badge: 'full IaC' });
                        if (data.registry) resList.push({ icon: 'üì¶', text: svcNames.registry + ' Container Registry', badge: 'full IaC' });
                        if (data.networking) resList.push({ icon: 'üåê', text: svcNames.vpc + ' / Networking', badge: data.k8sCluster ? 'included' : 'scaffold' });
                        if (data.database) resList.push({ icon: 'üóÑÔ∏è', text: svcNames.db, badge: 'scaffold' });
                        if (data.storage) resList.push({ icon: 'üíæ', text: svcNames.storage, badge: 'scaffold' });

                        if (resList.length > 0) {
                            html += '<div style="margin-bottom:var(--space-md)">';
                            html += '<div style="font-size:0.78rem;font-weight:700;color:var(--text-secondary);margin-bottom:6px">Infrastructure Resources</div>';
                            resList.forEach(r => {
                                const badgeColor = r.badge === 'full IaC' ? 'var(--success)' : (r.badge === 'included' ? 'var(--info, #60a0ff)' : 'var(--warning)');
                                html += `<div style="display:flex;align-items:center;gap:8px;font-size:0.8rem;padding:3px 0">
                                    <span>${r.icon}</span>
                                    <span style="flex:1">${r.text}</span>
                                    <span style="font-size:0.66rem;padding:1px 6px;border-radius:3px;background:color-mix(in srgb, ${badgeColor} 12%, transparent);color:${badgeColor};font-weight:600">${esc(r.badge)}</span>
                                </div>`;
                            });
                            html += '</div>';
                        }

                        // ‚îÄ‚îÄ Environments ‚îÄ‚îÄ
                        const envs = data.environments || [];
                        if (envs.length > 0) {
                            html += '<div style="margin-bottom:var(--space-md)">';
                            html += '<div style="font-size:0.78rem;font-weight:700;color:var(--text-secondary);margin-bottom:6px">Workspaces (' + envs.length + ')</div>';
                            envs.forEach(e => {
                                html += `<div style="display:flex;align-items:center;gap:8px;font-size:0.8rem;padding:3px 0">
                                    <span>üóÇÔ∏è</span>
                                    <span style="font-weight:600;color:var(--accent)">${esc(e.name)}</span>
                                    <span style="color:var(--text-muted);font-size:0.74rem">‚Üí ${esc(e.name)}.tfvars</span>
                                    ${e.region ? '<span style="color:var(--text-muted);font-size:0.72rem">(' + esc(e.region) + ')</span>' : ''}
                                </div>`;
                            });
                            html += '</div>';
                        }

                        // ‚îÄ‚îÄ Files to generate ‚îÄ‚îÄ
                        html += '<div style="font-size:0.78rem;font-weight:700;color:var(--text-secondary);margin-bottom:6px">Generated Files</div>';

                        const files = [
                            { icon: 'üìÑ', label: 'terraform/main.tf', desc: 'Provider, backend, resources' },
                            { icon: 'üìã', label: 'terraform/variables.tf', desc: 'Input variable definitions' },
                            { icon: 'üì§', label: 'terraform/outputs.tf', desc: 'Output values' },
                            { icon: 'üö´', label: 'terraform/.gitignore', desc: 'Ignore state, plans, lock files' },
                        ];
                        if (data.k8sCluster) {
                            files.push({ icon: '‚ò∏Ô∏è', label: 'terraform/k8s.tf', desc: 'Cluster + namespace + registry' });
                        }
                        envs.forEach(e => {
                            files.push({ icon: 'üìù', label: 'terraform/' + e.name + '.tfvars', desc: 'Variables for ' + e.name });
                        });

                        files.forEach(f => {
                            html += `<div class="wiz-review-item">
                                <span class="wiz-review-icon">${f.icon}</span>
                                <div class="wiz-review-content">
                                    <div class="wiz-review-label">${esc(f.label)}</div>
                                    <div class="wiz-review-value">${esc(f.desc)}</div>
                                </div>
                                <span class="wiz-review-badge ready">create</span>
                            </div>`;
                        });

                        // ‚îÄ‚îÄ Overwrite toggle ‚îÄ‚îÄ
                        if (hasExisting) {
                            html += `<div style="margin-top:var(--space-md);padding:0.6rem 0.8rem;border-radius:8px;background:rgba(232,168,32,0.06);border:1px solid rgba(232,168,32,0.15)">
                                <label class="modal-form-check" style="margin:0">
                                    <input type="checkbox" id="mf-tf-overwrite" name="tf-overwrite"${data.overwrite ? ' checked' : ''}>
                                    <span style="font-size:0.82rem;color:var(--warning);font-weight:600">‚ö†Ô∏è Overwrite existing Terraform files</span>
                                </label>
                                <div style="font-size:0.72rem;color:var(--text-muted);margin:4px 0 0 1.55rem">
                                    Existing .tf files in terraform/ directory will be replaced. This cannot be undone.
                                </div>
                            </div>`;
                        }

                        el.innerHTML = html;
                    },
                    collect: (data) => {
                        data.overwrite = mfVal('tf-overwrite') || false;
                    },
                },
            ],
            onComplete: async (data) => {
                const payload = {
                    action: 'setup_terraform',
                    provider: data.provider || 'aws',
                    region: data.region || 'us-east-1',
                    project_name: data.projectName || '',
                    backend: data.backend || 'local',
                    overwrite: data.overwrite || false,
                    // Resource flags
                    k8s_cluster: data.k8sCluster || false,
                    node_count: data.nodeCount || 2,
                    node_size: data.nodeSize || '',
                    k8s_version: data.k8sVersion || '',
                    registry: data.registry || false,
                    networking: data.networking || false,
                    database: data.database || false,
                    storage: data.storage || false,
                    // Environments
                    environments: data.environments || [],
                    // Remote state
                    state_bucket: data.stateBucket || '',
                };
                await apiPost('/wizard/setup', payload);
                _projectStatusTS = 0;
                cardInvalidate('terraform');
            },
            successMessage: 'Terraform configuration generated!',
        });
    }

</script>
