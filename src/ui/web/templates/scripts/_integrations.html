<script>
    // â”€â”€ Integrations tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Uses shared cache from _globals.html (cardCached / cardStore / cardInvalidate)

    let _intLoaded = false;

    async function loadIntegrationsTab(force) {
        if (force) {
            _intLoaded = false;
            ['git','github','ci','docker','pages'].forEach(key => {
                cardInvalidate(key);
                const detail = document.getElementById('int-' + (key === 'github' ? 'gh' : key) + '-detail');
                const badge = document.getElementById('int-' + (key === 'github' ? 'gh' : key) + '-badge');
                if (detail) detail.innerHTML = '<span class="spinner"></span>';
                if (badge) { badge.className = 'status-badge'; badge.textContent = 'â€”'; }
            });
        }
        if (_intLoaded) return;
        // Load all cards in parallel
        await Promise.allSettled([
            loadGitCard(),
            loadGitHubCard(),
            loadCICard(),
            loadDockerCard(),
            loadPagesCard(),
        ]);
        _intLoaded = true;
    }

    // â”€â”€ Git Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadGitCard() {
        const badge = document.getElementById('int-git-badge');
        const detail = document.getElementById('int-git-detail');

        try {
            const cached = cardCached('git');
            const data = cached || await api('/git/status');
            if (!cached) cardStore('git', data);

            if (!data.available) {
                badge.className = 'status-badge failed';
                badge.innerHTML = '<span class="status-dot"></span>No repo';
                detail.innerHTML = '<p class="empty-state-sm">Not a git repository</p>';
                return;
            }

            // Badge
            if (data.dirty) {
                badge.className = 'status-badge degraded';
                badge.innerHTML = `<span class="status-dot"></span>${data.total_changes} change${data.total_changes !== 1 ? 's' : ''}`;
            } else {
                badge.className = 'status-badge ok';
                badge.innerHTML = '<span class="status-dot"></span>Clean';
            }

            // Branch + tracking info
            let trackingHtml = '';
            if (data.ahead > 0 || data.behind > 0) {
                const parts = [];
                if (data.ahead > 0) parts.push(`<span style="color:var(--success)">â†‘${data.ahead}</span>`);
                if (data.behind > 0) parts.push(`<span style="color:var(--warning)">â†“${data.behind}</span>`);
                trackingHtml = `<span style="margin-left:0.5rem;font-size:0.8rem">${parts.join(' ')}</span>`;
            }

            // Changes summary
            let changesHtml = '';
            if (data.dirty) {
                const items = [];
                if (data.staged_count > 0) items.push(`<span style="color:var(--success)">${data.staged_count} staged</span>`);
                if (data.modified_count > 0) items.push(`<span style="color:var(--warning)">${data.modified_count} modified</span>`);
                if (data.untracked_count > 0) items.push(`<span style="color:var(--text-muted)">${data.untracked_count} untracked</span>`);
                changesHtml = `
                <div style="margin-top:var(--space-sm);font-size:0.8rem;color:var(--text-secondary)">
                    ${items.join(' Â· ')}
                </div>`;
            }

            // Last commit
            let commitHtml = '';
            if (data.last_commit) {
                const c = data.last_commit;
                const ago = _timeAgo(c.date);
                commitHtml = `
                <div style="margin-top:var(--space-sm);font-size:0.78rem;color:var(--text-muted);display:flex;gap:0.5rem;align-items:baseline">
                    <code style="color:var(--accent);font-family:var(--font-mono)">${esc(c.short_hash)}</code>
                    <span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${esc(c.message)}</span>
                    <span style="flex-shrink:0">${ago}</span>
                </div>`;
            }

            // Action buttons
            const actionsHtml = `
            <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-md);flex-wrap:wrap">
                <button class="btn btn-sm btn-secondary" onclick="gitCommitModal()" title="Stage all + commit">
                    ğŸ’¾ Commit
                </button>
                <button class="btn btn-sm btn-secondary" onclick="gitPull()" title="Pull from remote">
                    â¬‡ï¸ Pull
                </button>
                <button class="btn btn-sm btn-secondary" onclick="gitPush()" ${data.ahead === 0 ? 'disabled' : ''} title="${data.ahead > 0 ? data.ahead + ' commit(s) to push' : 'Nothing to push'}">
                    â¬†ï¸ Push${data.ahead > 0 ? ' (' + data.ahead + ')' : ''}
                </button>
                <button class="btn btn-sm btn-ghost" onclick="gitLogModal()" title="View recent commits">
                    ğŸ“œ Log
                </button>
            </div>`;

            detail.innerHTML = `
            <div style="font-size:0.85rem;color:var(--text-secondary);line-height:1.6">
                <div style="display:flex;align-items:center;gap:0.4rem">
                    <span style="font-weight:600">ğŸŒ¿ ${esc(data.branch)}</span>
                    ${trackingHtml}
                    <code style="font-family:var(--font-mono);font-size:0.75rem;color:var(--text-muted);margin-left:auto">${esc(data.commit || '')}</code>
                </div>
                ${changesHtml}
                ${commitHtml}
                ${actionsHtml}
            </div>`;

        } catch (e) {
            badge.className = 'status-badge failed';
            badge.innerHTML = '<span class="status-dot"></span>Error';
            detail.innerHTML = `<p class="empty-state-sm" style="color:var(--error)">${esc(e.message)}</p>`;
        }
    }

    // â”€â”€ Git Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function gitCommitModal() {
        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'vault-modal';
        modal.innerHTML = `
        <div class="vault-modal" style="max-width:480px">
            <h3 style="margin-bottom:var(--space-md)">ğŸ’¾ Commit Changes</h3>
            <div class="form-group" style="margin-bottom:var(--space-md)">
                <label>Commit Message</label>
                <input type="text" id="git-commit-msg" placeholder="feat: describe your change"
                    style="width:100%" autocomplete="off"
                    onkeydown="if(event.key==='Enter'){doGitCommit()}">
            </div>
            <div id="git-commit-error" style="display:none;color:var(--error);font-size:0.82rem;margin-bottom:var(--space-sm)"></div>
            <div style="display:flex;gap:var(--space-sm);justify-content:flex-end">
                <button class="btn btn-sm btn-ghost" onclick="closeVaultModal()" type="button">Cancel</button>
                <button class="btn btn-sm btn-primary" id="git-commit-btn" onclick="doGitCommit()" type="button">Commit All</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
        setTimeout(() => document.getElementById('git-commit-msg').focus(), 100);
    }

    async function doGitCommit() {
        const msgEl = document.getElementById('git-commit-msg');
        const errEl = document.getElementById('git-commit-error');
        const btnEl = document.getElementById('git-commit-btn');
        const message = msgEl.value.trim();

        if (!message) {
            errEl.textContent = 'Message is required';
            errEl.style.display = 'block';
            return;
        }

        btnEl.disabled = true;
        btnEl.textContent = 'Committingâ€¦';

        try {
            const data = await api('/git/commit', {
                method: 'POST',
                body: JSON.stringify({ message }),
            });
            closeVaultModal();
            toast(`Committed ${data.hash}: ${message}`, 'success');
            await loadGitCard();
        } catch (e) {
            errEl.textContent = e.message;
            errEl.style.display = 'block';
            btnEl.disabled = false;
            btnEl.textContent = 'Commit All';
        }
    }

    async function gitPull() {
        toast('Pullingâ€¦', 'info');
        try {
            const data = await api('/git/pull', { method: 'POST', body: '{}' });
            toast('Pull complete: ' + (data.output || 'up to date'), 'success');
            await loadGitCard();
        } catch (e) {
            toast('Pull failed: ' + e.message, 'error');
        }
    }

    async function gitPush() {
        toast('Pushingâ€¦', 'info');
        try {
            const data = await api('/git/push', { method: 'POST', body: '{}' });
            toast('Push complete', 'success');
            await loadGitCard();
        } catch (e) {
            toast('Push failed: ' + e.message, 'error');
        }
    }

    async function gitLogModal() {
        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'vault-modal';
        modal.innerHTML = `
        <div class="vault-modal" style="max-width:600px">
            <h3 style="margin-bottom:var(--space-md)">ğŸ“œ Recent Commits</h3>
            <div id="git-log-body" style="max-height:400px;overflow-y:auto"><span class="spinner"></span></div>
            <div style="display:flex;justify-content:flex-end;margin-top:var(--space-md)">
                <button class="btn btn-sm btn-primary" onclick="closeVaultModal()" type="button">Close</button>
            </div>
        </div>`;
        document.body.appendChild(modal);

        try {
            const data = await api('/git/log?n=15');
            const body = document.getElementById('git-log-body');
            if (!data.commits || data.commits.length === 0) {
                body.innerHTML = '<p class="empty-state-sm">No commits found</p>';
                return;
            }
            body.innerHTML = data.commits.map(c => {
                const ago = _timeAgo(c.date);
                return `
                <div style="display:flex;gap:0.5rem;align-items:baseline;padding:0.4rem 0;border-bottom:1px solid var(--border-subtle);font-size:0.8rem">
                    <code style="color:var(--accent);font-family:var(--font-mono);flex-shrink:0">${esc(c.short_hash)}</code>
                    <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(c.message)}</span>
                    <span style="color:var(--text-muted);flex-shrink:0;font-size:0.72rem">${esc(c.author)}</span>
                    <span style="color:var(--text-muted);flex-shrink:0;font-size:0.72rem">${ago}</span>
                </div>`;
            }).join('');
        } catch (e) {
            document.getElementById('git-log-body').innerHTML =
                `<p class="empty-state-sm" style="color:var(--error)">${esc(e.message)}</p>`;
        }
    }

    // â”€â”€ GitHub Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadGitHubCard() {
        const badge = document.getElementById('int-gh-badge');
        const detail = document.getElementById('int-gh-detail');

        try {
            const cached = cardCached('github');
            const data = cached || await api('/integrations/gh/status');
            if (!cached) cardStore('github', data);

            if (!data.available) {
                badge.className = 'status-badge failed';
                badge.innerHTML = '<span class="status-dot"></span>No gh CLI';
                detail.innerHTML = `
                <p class="empty-state-sm">
                    The <code>gh</code> CLI is not installed.
                    <a href="https://cli.github.com/" target="_blank" rel="noopener" style="color:var(--accent)">Install it â†’</a>
                </p>`;
                return;
            }

            if (!data.authenticated) {
                badge.className = 'status-badge degraded';
                badge.innerHTML = '<span class="status-dot"></span>Not auth';
                detail.innerHTML = `
                <p class="empty-state-sm">
                    gh CLI found (${esc(data.version)}) but not authenticated.
                    Run <code>gh auth login</code> in terminal.
                </p>`;
                return;
            }

            badge.className = 'status-badge ok';
            badge.innerHTML = '<span class="status-dot"></span>Connected';

            let repoHtml = '';
            if (data.repo) {
                repoHtml = `
                <div style="margin-top:var(--space-xs)">
                    <a href="https://github.com/${esc(data.repo)}" target="_blank" rel="noopener"
                       style="color:var(--accent);font-family:var(--font-mono);font-size:0.82rem;text-decoration:none">
                        ${esc(data.repo)} â†—
                    </a>
                </div>`;
            }

            // Load PRs
            let prHtml = '<div id="int-gh-prs" style="margin-top:var(--space-sm)"><span class="spinner" style="width:14px;height:14px"></span></div>';

            detail.innerHTML = `
            <div style="font-size:0.85rem;color:var(--text-secondary);line-height:1.6">
                <div>âœ… Authenticated Â· ${esc(data.version)}</div>
                ${repoHtml}
                ${prHtml}
            </div>`;

            // Async load PRs
            loadPullRequests();
        } catch (e) {
            badge.className = 'status-badge failed';
            badge.innerHTML = '<span class="status-dot"></span>Error';
            detail.innerHTML = `<p class="empty-state-sm" style="color:var(--error)">${esc(e.message)}</p>`;
        }
    }

    async function loadPullRequests() {
        const container = document.getElementById('int-gh-prs');
        if (!container) return;

        try {
            const data = await api('/gh/pulls');
            if (!data.available || !data.pulls || data.pulls.length === 0) {
                container.innerHTML = '<div style="font-size:0.78rem;color:var(--text-muted)">No open pull requests</div>';
                return;
            }

            container.innerHTML = `
            <div style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.3rem;font-weight:600">
                ${data.pulls.length} open PR${data.pulls.length !== 1 ? 's' : ''}
            </div>
            ${data.pulls.slice(0, 5).map(pr => `
                <a href="${esc(pr.url)}" target="_blank" rel="noopener"
                   style="display:flex;gap:0.4rem;padding:0.25rem 0;font-size:0.78rem;text-decoration:none;color:var(--text-secondary);border-bottom:1px solid var(--border-subtle)">
                    <span style="color:var(--success);flex-shrink:0">#${pr.number}</span>
                    <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(pr.title)}</span>
                    <span style="color:var(--text-muted);flex-shrink:0">${esc(pr.headRefName)}</span>
                </a>
            `).join('')}`;
        } catch (e) {
            container.innerHTML = `<div style="font-size:0.78rem;color:var(--text-muted)">Could not load PRs</div>`;
        }
    }

    // â”€â”€ CI/CD Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadCICard() {
        const badge = document.getElementById('int-ci-badge');
        const detail = document.getElementById('int-ci-detail');

        try {
            const cached = cardCached('ci');
            const data = cached || await api('/gh/actions/runs?n=5');
            if (!cached) cardStore('ci', data);

            if (!data.available) {
                badge.className = 'status-badge degraded';
                badge.innerHTML = '<span class="status-dot"></span>N/A';
                detail.innerHTML = `<p class="empty-state-sm">${esc(data.error || 'Not available')}</p>`;
                return;
            }

            if (!data.runs || data.runs.length === 0) {
                badge.className = 'status-badge degraded';
                badge.innerHTML = '<span class="status-dot"></span>No runs';
                detail.innerHTML = '<p class="empty-state-sm">No workflow runs found</p>';
                return;
            }

            // Latest run determines badge
            const latest = data.runs[0];
            const conclusion = latest.conclusion || latest.status;

            if (conclusion === 'success') {
                badge.className = 'status-badge ok';
                badge.innerHTML = '<span class="status-dot"></span>Passing';
            } else if (conclusion === 'failure') {
                badge.className = 'status-badge failed';
                badge.innerHTML = '<span class="status-dot"></span>Failing';
            } else if (latest.status === 'in_progress' || latest.status === 'queued') {
                badge.className = 'status-badge degraded';
                badge.innerHTML = '<span class="status-dot"></span>Running';
            } else {
                badge.className = 'status-badge degraded';
                badge.innerHTML = `<span class="status-dot"></span>${esc(conclusion || 'Unknown')}`;
            }

            const runsHtml = data.runs.slice(0, 5).map(run => {
                const icon = run.conclusion === 'success' ? 'âœ…' :
                             run.conclusion === 'failure' ? 'âŒ' :
                             run.status === 'in_progress' ? 'ğŸ”„' :
                             run.status === 'queued' ? 'â³' : 'âšª';
                const ago = _timeAgo(run.createdAt);
                return `
                <a href="${esc(run.url)}" target="_blank" rel="noopener"
                   style="display:flex;gap:0.4rem;align-items:center;padding:0.3rem 0;font-size:0.78rem;text-decoration:none;color:var(--text-secondary);border-bottom:1px solid var(--border-subtle)">
                    <span style="flex-shrink:0">${icon}</span>
                    <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(run.name)}</span>
                    <span style="color:var(--text-muted);flex-shrink:0;font-size:0.72rem">${esc(run.headBranch || '')}</span>
                    <span style="color:var(--text-muted);flex-shrink:0;font-size:0.72rem">${ago}</span>
                </a>`;
            }).join('');

            // Trigger button
            let triggerHtml = '';
            try {
                const wfData = await api('/gh/actions/workflows');
                if (wfData.available && wfData.workflows && wfData.workflows.length > 0) {
                    const opts = wfData.workflows.map(w =>
                        `<option value="${esc(w.name)}.yml">${esc(w.name)}</option>`
                    ).join('');
                    triggerHtml = `
                    <div style="display:flex;gap:var(--space-sm);margin-top:var(--space-sm);align-items:center">
                        <select id="int-ci-workflow" style="font-size:0.78rem;padding:0.2rem 0.4rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-secondary);flex:1">
                            ${opts}
                        </select>
                        <button class="btn btn-sm btn-secondary" onclick="triggerWorkflow()" title="Trigger workflow run">
                            ğŸš€ Trigger
                        </button>
                    </div>`;
                }
            } catch (_) { /* skip trigger if workflows API fails */ }

            detail.innerHTML = `
            <div style="font-size:0.85rem;color:var(--text-secondary)">
                ${runsHtml}
                ${triggerHtml}
            </div>`;

        } catch (e) {
            badge.className = 'status-badge failed';
            badge.innerHTML = '<span class="status-dot"></span>Error';
            detail.innerHTML = `<p class="empty-state-sm" style="color:var(--error)">${esc(e.message)}</p>`;
        }
    }

    async function triggerWorkflow() {
        const sel = document.getElementById('int-ci-workflow');
        if (!sel) return;
        const workflow = sel.value;
        toast('Triggering ' + workflow + 'â€¦', 'info');
        try {
            await api('/gh/actions/dispatch', {
                method: 'POST',
                body: JSON.stringify({ workflow }),
            });
            toast('Workflow dispatched: ' + workflow, 'success');
            // Reload after a brief delay to pick up the new run
            setTimeout(() => loadCICard(), 3000);
        } catch (e) {
            toast('Failed: ' + e.message, 'error');
        }
    }

    // â”€â”€ Docker Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadDockerCard() {
        const badge = document.getElementById('int-docker-badge');
        const detail = document.getElementById('int-docker-detail');

        try {
            const cached = cardCached('docker');
            const data = cached || await api('/status');
            if (!cached) cardStore('docker', data);
            const dockerModules = (data.modules || []).filter(m =>
                m.stack && m.stack.includes('docker')
            );

            if (dockerModules.length > 0) {
                badge.className = 'status-badge ok';
                badge.innerHTML = '<span class="status-dot"></span>Detected';
                detail.innerHTML = `
                <div style="font-size:0.82rem;color:var(--text-secondary)">
                    ${dockerModules.length} Docker module(s) found:
                    ${dockerModules.map(m => `<code style="font-family:var(--font-mono);color:var(--accent)">${esc(m.name)}</code>`).join(', ')}
                </div>`;
            } else {
                badge.className = 'status-badge degraded';
                badge.innerHTML = '<span class="status-dot"></span>None';
                detail.innerHTML = '<p class="empty-state-sm">No Docker modules detected</p>';
            }
        } catch (e) {
            // Silently fail â€” Docker is optional
        }
    }

    // â”€â”€ Pages Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadPagesCard() {
        const badge = document.getElementById('int-pages-badge');
        const detail = document.getElementById('int-pages-detail');

        try {
            const cached = cardCached('pages');
            let segData, bdData;
            if (cached) {
                segData = cached.segData;
                bdData = cached.bdData;
            } else {
                [segData, bdData] = await Promise.all([
                    api('/pages/segments'),
                    api('/pages/builders').catch(() => ({ builders: [] })),
                ]);
                cardStore('pages', { segData, bdData });
            }

            const segments = segData.segments || [];
            const builders = bdData.builders || [];

            if (segments.length === 0) {
                badge.className = 'status-badge degraded';
                badge.innerHTML = '<span class="status-dot"></span>No segments';
                detail.innerHTML = `
                <div style="text-align:center;padding:var(--space-lg)">
                    <p style="color:var(--text-muted);margin-bottom:var(--space-md)">No page segments configured yet.</p>
                    <div style="display:flex;gap:var(--space-sm);justify-content:center">
                        <button class="btn btn-sm btn-primary" onclick="pagesInit()" title="Auto-detect from content_folders">ğŸ” Auto-Init</button>
                        <button class="btn btn-sm btn-secondary" onclick="addSegmentModal()">+ Add Segment</button>
                    </div>
                </div>`;
                return;
            }

            // Count stages
            const built = segments.filter(s => s.build).length;
            const total = segments.length;
            badge.className = built === total ? 'status-badge ok' : 'status-badge degraded';
            badge.innerHTML = `<span class="status-dot"></span>${built}/${total} built`;

            // â”€â”€ Segment rows with pipeline stages â”€â”€
            const listHtml = segments.map(seg => {
                const buildInfo = seg.build;
                const serveUrl = buildInfo && buildInfo.serve_url ? buildInfo.serve_url : '';
                const buildOk = !!buildInfo;

                // Pipeline dots: source â†’ build â†’ serve
                const stageDotsHtml = `
                    <span title="Source" style="color:var(--success)">â—</span>
                    <span style="color:var(--text-muted);font-size:0.5rem">â†’</span>
                    <span title="Built" style="color:${buildOk ? 'var(--success)' : 'var(--text-muted)'}">â—</span>
                    <span style="color:var(--text-muted);font-size:0.5rem">â†’</span>
                    <span title="Served" style="color:${serveUrl ? '#6366f1' : 'var(--text-muted)'}">â—</span>`;

                const buildAgo = buildInfo ? _timeAgo(buildInfo.built_at) : '';
                const duration = buildInfo ? `${buildInfo.duration_ms}ms` : '';
                const timeInfo = buildAgo ? `${buildAgo}${duration ? ' Â· ' + duration : ''}` : '';

                // Primary action: View Site (only when built)
                const viewSiteBtn = serveUrl
                    ? `<a href="${serveUrl}" target="_blank" class="btn btn-sm btn-primary" style="padding:0.15rem 0.5rem;font-size:0.68rem;text-decoration:none;display:inline-flex;align-items:center;gap:0.2rem" title="View built site">ğŸŒ View</a>`
                    : `<span style="font-size:0.68rem;color:var(--text-muted);font-style:italic">not built</span>`;

                // Browse build workspace in Content Vault (.pages/<segment>)
                const buildSourceBtn = buildOk
                    ? `<button class="btn btn-sm btn-ghost" onclick="switchTab('content/docs/.pages/${esc(seg.name)}')" title="Browse build workspace (.pages/${esc(seg.name)}/)" style="padding:0.15rem 0.5rem;font-size:0.68rem;display:inline-flex;align-items:center;gap:0.2rem">ğŸ“‚ Build Source</button>`
                    : '';

                return `
                <div style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0;border-bottom:1px solid var(--border-subtle);font-size:0.82rem" data-segment-row="${esc(seg.name)}">
                    <span style="display:flex;gap:0.15rem;align-items:center;flex-shrink:0;font-size:0.6rem">${stageDotsHtml}</span>
                    <span style="font-weight:600;min-width:60px">${esc(seg.name)}</span>
                    <code style="font-family:var(--font-mono);font-size:0.72rem;color:var(--text-muted);cursor:pointer;text-decoration:underline dotted;text-underline-offset:2px" onclick="switchTab('content/docs/${esc(seg.source)}')" title="Browse content source in Content Vault">${esc(seg.source)}</code>
                    <span style="background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:4px;padding:0 0.4rem;font-size:0.68rem;color:var(--accent);cursor:pointer" onclick="configureSegment('${esc(seg.name)}','${esc(seg.builder)}','${esc(seg.source)}','${esc(seg.path)}')" title="Click to change builder">${esc(seg.builder)} â–¾</span>
                    ${viewSiteBtn}
                    ${buildSourceBtn}
                    <span class="segment-build-status" style="display:none"></span>
                    <span style="color:var(--text-muted);font-size:0.68rem;margin-left:auto">${timeInfo}</span>
                    <button class="btn btn-sm btn-ghost" onclick="buildSegmentStream('${esc(seg.name)}')" title="Build with pipeline" style="padding:0.1rem 0.3rem;font-size:0.72rem">ğŸ”¨</button>
                    <button class="btn btn-sm btn-ghost" onclick="buildSegmentStream('${esc(seg.name)}', {clean:true})" title="Clean build (wipe caches)" style="padding:0.1rem 0.3rem;font-size:0.72rem">ğŸ§¹</button>
                    <button class="btn btn-sm btn-ghost" onclick="buildSegmentStream('${esc(seg.name)}', {wipe:true})" title="Full rebuild (wipe workspace)" style="padding:0.1rem 0.3rem;font-size:0.72rem">ğŸ”„</button>
                    <button class="btn btn-sm btn-ghost" onclick="removeSegment('${esc(seg.name)}')" title="Remove" style="padding:0.1rem 0.3rem;font-size:0.72rem;color:var(--error)">âœ•</button>
                </div>`;
            }).join('');

            // â”€â”€ Pipeline actions (sequential flow) â”€â”€
            const pipelineHtml = `
            <div style="margin-top:var(--space-md)">
                <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:var(--space-sm)">
                    <span style="font-size:0.72rem;font-weight:600;color:var(--text-muted)">Pipeline:</span>
                    <span style="font-size:0.72rem;color:var(--text-muted)">Segments</span>
                    <span style="font-size:0.6rem;color:var(--text-muted)">â†’</span>
                    <span style="font-size:0.72rem;color:${built === total ? 'var(--success)' : 'var(--text-muted)'}">Build</span>
                    <span style="font-size:0.6rem;color:var(--text-muted)">â†’</span>
                    <span style="font-size:0.72rem;color:var(--text-muted)">Merge</span>
                    <span style="font-size:0.6rem;color:var(--text-muted)">â†’</span>
                    <span style="font-size:0.72rem;color:var(--text-muted)">Deploy</span>
                </div>
                <div style="display:flex;gap:var(--space-sm);flex-wrap:wrap">
                    <button class="btn btn-sm btn-secondary" onclick="addSegmentModal()">+ Segment</button>
                    <button class="btn btn-sm btn-secondary" onclick="buildAllSegments()">ğŸ”¨ Build All</button>
                    <button class="btn btn-sm btn-secondary" onclick="mergeSegments()" ${built < total ? 'disabled title="Build all segments first"' : ''}>ğŸ“¦ Merge</button>
                    <button class="btn btn-sm btn-primary" onclick="deployPages()" ${built < total ? 'disabled' : ''}>ğŸš€ Deploy</button>
                    <button class="btn btn-sm btn-secondary" onclick="generateCI()" title="Generate deploy workflow">âš™ï¸ CI</button>
                    <button class="btn btn-sm btn-ghost" onclick="pagesInit()" title="Re-detect from content_folders">ğŸ” Re-Init</button>
                </div>
            </div>`;

            // â”€â”€ Builders panel with install buttons â”€â”€
            let buildersHtml = '';
            if (builders.length > 0) {
                const chips = builders.map(b => {
                    if (b.available) {
                        return `<span style="font-size:0.68rem;padding:0.1rem 0.4rem;border:1px solid var(--success);border-radius:4px;color:var(--success)" title="${esc(b.description)}">âœ“ ${esc(b.label)}</span>`;
                    }
                    const installBtn = b.installable
                        ? `<button class="btn btn-sm btn-ghost" onclick="installBuilder('${esc(b.name)}')" style="padding:0 0.3rem;font-size:0.62rem;color:var(--accent);border:1px solid var(--accent);border-radius:3px;margin-left:0.2rem" title="${esc(b.install_hint)}">Install</button>`
                        : `<span style="font-size:0.6rem;color:var(--text-muted);margin-left:0.2rem" title="${esc(b.install_hint)}">â“˜</span>`;
                    return `<span style="display:inline-flex;align-items:center;gap:0.15rem;font-size:0.68rem;padding:0.1rem 0.4rem;border:1px solid var(--border-subtle);border-radius:4px;color:var(--text-muted)" title="${esc(b.description)}">${esc(b.label)}${installBtn}</span>`;
                }).join(' ');
                buildersHtml = `<div style="margin-top:var(--space-sm);display:flex;gap:0.3rem;align-items:center;flex-wrap:wrap"><span style="font-size:0.68rem;color:var(--text-muted)">Builders:</span> ${chips}</div>`;
            }

            detail.innerHTML = `
            <div style="font-size:0.85rem;color:var(--text-secondary)">
                ${listHtml}
                ${pipelineHtml}
                ${buildersHtml}
            </div>`;

        } catch (e) {
            badge.className = 'status-badge failed';
            badge.innerHTML = '<span class="status-dot"></span>Error';
            detail.innerHTML = `<p class="empty-state-sm" style="color:var(--error)">${esc(e.message)}</p>`;
        }
    }

    async function pagesInit() {
        toast('Detecting content foldersâ€¦', 'info');
        try {
            const data = await api('/pages/init', { method: 'POST', body: '{}' });
            const details = data.details || [];

            if (data.added && data.added.length > 0) {
                // Check if any segments have suggestions (i.e. fell back to a suboptimal builder)
                const withSuggestions = details.filter(d => d.suggestion);

                if (withSuggestions.length > 0) {
                    // Show a modal explaining what happened and offering to install better builders
                    _showInitResultsModal(details);
                } else {
                    for (const d of details) {
                        toast(`Added '${d.name}' â†’ ${d.builder}`, 'success');
                    }
                }
            } else {
                toast('No new segments to add â€” segments already configured', 'info');
            }
            await loadPagesCard();
        } catch (e) {
            toast('Init failed: ' + e.message, 'error');
        }
    }

    function _showInitResultsModal(details) {
        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'init-results-modal';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

        let rowsHtml = '';
        for (const d of details) {
            const hasSuggestion = !!d.suggestion;
            const suggestHtml = hasSuggestion
                ? `<div style="margin-top:0.3rem;font-size:0.72rem;color:var(--warning)">
                    ğŸ’¡ ${esc(d.suggestion)}
                    ${d.suggestion.includes('Node.js') ? `<button class="btn btn-sm btn-primary" style="margin-left:0.4rem;padding:0.1rem 0.5rem;font-size:0.68rem" onclick="document.getElementById('init-results-modal').remove();installBuilderThenReinit('docusaurus')">ğŸ“¦ Install Docusaurus</button>` : ''}
                    ${d.suggestion.includes('mkdocs') ? `<button class="btn btn-sm btn-secondary" style="margin-left:0.4rem;padding:0.1rem 0.5rem;font-size:0.68rem" onclick="document.getElementById('init-results-modal').remove();installBuilderThenReinit('mkdocs')">ğŸ“¦ Install MkDocs</button>` : ''}
                  </div>`
                : '';
            rowsHtml += `
                <div style="padding:0.6rem;background:var(--bg-inset);border:1px solid ${hasSuggestion ? 'var(--warning)' : 'var(--border-subtle)'};border-radius:6px">
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <span style="font-weight:600">${esc(d.name)}</span>
                        <span style="font-size:0.72rem;color:var(--accent);background:var(--bg-base);padding:0 0.4rem;border-radius:3px;border:1px solid var(--border-subtle)">${esc(d.builder)}</span>
                    </div>
                    <div style="font-size:0.72rem;color:var(--text-muted);margin-top:0.2rem">${esc(d.reason)}</div>
                    ${suggestHtml}
                </div>`;
        }

        modal.innerHTML = `
        <div class="vault-modal" style="max-width:560px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                <h3 style="margin:0">ğŸ” Detection Results</h3>
                <button class="btn btn-sm btn-ghost" onclick="document.getElementById('init-results-modal').remove()" style="font-size:1rem;padding:0.1rem 0.4rem">âœ•</button>
            </div>
            <div style="display:flex;flex-direction:column;gap:0.4rem;margin-bottom:var(--space-md)">
                ${rowsHtml}
            </div>
            <div style="text-align:right">
                <button class="btn btn-sm btn-secondary" onclick="document.getElementById('init-results-modal').remove()">OK</button>
            </div>
        </div>`;
        document.body.appendChild(modal);
    }

    async function installBuilderThenReinit(builderName) {
        // Install the builder, then re-run init to pick it up
        await _installBuilderAsync(builderName);
    }

    function _installBuilderAsync(name) {
        return new Promise((resolve) => {
            const modal = document.createElement('div');
            modal.className = 'vault-modal-overlay';
            modal.id = 'install-modal';
            modal.onclick = (e) => { if (e.target === modal) return; };
            modal.innerHTML = `
            <div class="vault-modal" style="max-width:600px">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                    <h3 style="margin:0">ğŸ“¦ Installing: ${esc(name)}</h3>
                    <button class="btn btn-sm btn-ghost" id="install-close-x" onclick="document.getElementById('install-modal').remove();loadPagesCard()" style="font-size:1rem;padding:0.1rem 0.4rem">âœ•</button>
                </div>
                <div id="install-log" style="background:#0d0f17;border:1px solid var(--border-subtle);border-radius:6px;padding:0.75rem;font-family:var(--font-mono);font-size:0.68rem;max-height:300px;overflow-y:auto;line-height:1.6;color:#a0aec0;white-space:pre-wrap"></div>
                <div id="install-status" style="margin-top:var(--space-sm);font-size:0.82rem">
                    <span class="spinner" style="width:0.8rem;height:0.8rem;display:inline-block;vertical-align:middle;margin-right:0.3rem"></span> Installingâ€¦
                </div>
                <div style="margin-top:var(--space-md);display:flex;gap:var(--space-sm);justify-content:flex-end">
                    <button class="btn btn-sm btn-secondary" id="install-reinit-btn" style="display:none" onclick="document.getElementById('install-modal').remove();pagesReInit()">ğŸ”„ Re-Init with ${esc(name)}</button>
                    <button class="btn btn-sm btn-secondary" onclick="document.getElementById('install-modal').remove();loadPagesCard()">Close</button>
                </div>
            </div>`;
            document.body.appendChild(modal);

            const logEl = document.getElementById('install-log');
            const statusEl = document.getElementById('install-status');
            const reinitBtn = document.getElementById('install-reinit-btn');

            fetch('/api/pages/builders/' + encodeURIComponent(name) + '/install', { method: 'POST' })
            .then(response => {
                const ct = response.headers.get('content-type') || '';
                if (ct.includes('application/json')) {
                    return response.json().then(data => {
                        if (data.already_installed) {
                            statusEl.innerHTML = '<span style="color:var(--success)">âœ… Already installed</span>';
                        } else if (data.error) {
                            statusEl.innerHTML = `<span style="color:var(--error)">âŒ ${esc(data.error)}</span>`;
                        }
                        reinitBtn.style.display = '';
                        loadPagesCard();
                        resolve();
                    });
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                function read() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            if (statusEl.textContent.includes('Installing')) {
                                statusEl.innerHTML = '<span style="color:var(--warning)">âš ï¸ Stream ended</span>';
                            }
                            reinitBtn.style.display = '';
                            loadPagesCard();
                            resolve();
                            return;
                        }
                        buffer += decoder.decode(value, { stream: true });
                        const lines = buffer.split('\n');
                        buffer = lines.pop();

                        for (const line of lines) {
                            if (!line.startsWith('data: ')) continue;
                            try {
                                const evt = JSON.parse(line.slice(6));
                                if (evt.type === 'log') {
                                    logEl.textContent += evt.line + '\n';
                                    logEl.scrollTop = logEl.scrollHeight;
                                } else if (evt.type === 'done') {
                                    if (evt.ok) {
                                        statusEl.innerHTML = `<span style="color:var(--success)">âœ… ${esc(evt.message)}</span>`;
                                        reinitBtn.style.display = '';
                                    } else {
                                        statusEl.innerHTML = `<span style="color:var(--error)">âŒ ${esc(evt.error)}</span>`;
                                    }
                                    loadPagesCard();
                                    resolve();
                                }
                            } catch (_) {}
                        }
                        read();
                    }).catch(err => {
                        statusEl.innerHTML = `<span style="color:var(--error)">âš ï¸ ${esc(err.message)}</span>`;
                        resolve();
                    });
                }
                read();
            })
            .catch(err => {
                statusEl.innerHTML = `<span style="color:var(--error)">âŒ ${esc(err.message)}</span>`;
                resolve();
            });
        });
    }

    async function pagesReInit() {
        // Delete existing segments and re-init with better builders
        try {
            const segData = await api('/pages/segments');
            for (const seg of (segData.segments || [])) {
                if (seg.auto) {
                    await api('/pages/segments/' + encodeURIComponent(seg.name), { method: 'DELETE' });
                }
            }
            await pagesInit();
        } catch (e) {
            toast('Re-init failed: ' + e.message, 'error');
        }
    }

    function installBuilder(name) {
        _installBuilderAsync(name);
    }

    function addSegmentModal() {
        // Fetch builders and features in parallel
        let _wizBuilders = [];
        let _wizCategories = [];
        Promise.all([
            api('/pages/builders').catch(() => ({ builders: [] })),
            api('/pages/features').catch(() => ({ categories: [] })),
        ]).then(([bd, fd]) => {
            _wizBuilders = bd.builders || [];
            _wizCategories = fd.categories || [];
            renderWizStep();
        });

        let _wizStep = 1;
        let _wizData = { name: '', source: '', builder: 'docusaurus', path: '', features: {} };

        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'vault-modal';
        modal.innerHTML = `
        <div class="vault-modal" style="max-width:520px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                <h3 style="margin:0">âœ¨ New Segment</h3>
                <button class="btn btn-sm btn-ghost" onclick="closeVaultModal()" style="font-size:1.1rem;padding:0.1rem 0.4rem" title="Close">âœ•</button>
            </div>
            <div id="wiz-progress" style="display:flex;gap:0.5rem;align-items:center;justify-content:center;margin-bottom:var(--space-md)"></div>
            <div id="wiz-body" style="min-height:180px"></div>
            <div id="wiz-error" style="display:none;color:var(--error);font-size:0.78rem;margin-top:var(--space-sm)"></div>
            <div id="wiz-actions" style="display:flex;gap:var(--space-sm);justify-content:flex-end;padding-top:var(--space-md);border-top:1px solid var(--border-subtle);margin-top:var(--space-sm)"></div>
        </div>`;
        document.body.appendChild(modal);

        function renderProgress() {
            const labels = ['Name & Source', 'Builder', 'Configure'];
            document.getElementById('wiz-progress').innerHTML = labels.map((l, i) => {
                const step = i + 1;
                const active = step === _wizStep;
                const done = step < _wizStep;
                const color = active ? '#818cf8' : done ? 'var(--success)' : 'var(--text-muted)';
                return `<div style="display:flex;align-items:center;gap:0.25rem">
                    <span style="width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.6rem;font-weight:700;background:${active ? 'rgba(99,102,241,0.15)' : 'transparent'};border:1.5px solid ${color};color:${color}">${done ? 'âœ“' : step}</span>
                    <span style="font-size:0.68rem;color:${color};font-weight:${active ? '600' : '400'}">${l}</span>
                    ${i < 2 ? '<span style="color:var(--text-muted);font-size:0.5rem;margin:0 0.15rem">â†’</span>' : ''}
                </div>`;
            }).join('');
        }

        function renderWizStep() {
            renderProgress();
            const body = document.getElementById('wiz-body');
            const actions = document.getElementById('wiz-actions');
            const errEl = document.getElementById('wiz-error');
            errEl.style.display = 'none';

            if (_wizStep === 1) {
                body.innerHTML = `
                    <div class="form-group" style="margin-bottom:var(--space-sm)">
                        <label style="font-size:0.78rem;font-weight:600">Segment Name</label>
                        <input type="text" id="wiz-name" value="${esc(_wizData.name)}" placeholder="e.g. docs, blog, api-reference" style="width:100%;margin-top:0.2rem" autocomplete="off">
                        <div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.15rem">Short identifier â€” used in URLs and file paths</div>
                    </div>
                    <div class="form-group" style="margin-bottom:var(--space-sm)">
                        <label style="font-size:0.78rem;font-weight:600">Source Folder</label>
                        <input type="text" id="wiz-source" value="${esc(_wizData.source)}" placeholder="e.g. docs, content/guides" style="width:100%;margin-top:0.2rem" autocomplete="off">
                        <div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.15rem">Path to your markdown/content files (relative to project root)</div>
                    </div>`;
                actions.innerHTML = `
                    <button class="btn btn-sm btn-ghost" onclick="closeVaultModal()">Cancel</button>
                    <button class="btn btn-sm btn-primary" id="wiz-next" onclick="">Next â†’</button>`;
                document.getElementById('wiz-next').onclick = () => {
                    _wizData.name = document.getElementById('wiz-name').value.trim();
                    _wizData.source = document.getElementById('wiz-source').value.trim();
                    if (!_wizData.name || !_wizData.source) {
                        errEl.textContent = 'Name and source folder are required';
                        errEl.style.display = 'block';
                        return;
                    }
                    if (!_wizData.path) _wizData.path = '/' + _wizData.name;
                    _wizStep = 2;
                    renderWizStep();
                };
                setTimeout(() => document.getElementById('wiz-name').focus(), 100);

            } else if (_wizStep === 2) {
                const buildersHtml = _wizBuilders.map(b => {
                    const sel = b.name === _wizData.builder;
                    const avail = b.available;
                    const borderOn = '#818cf8';
                    const borderOff = 'var(--border-subtle)';
                    const borderColor = sel ? borderOn : borderOff;
                    const bg = sel ? 'rgba(99,102,241,0.06)' : 'transparent';
                    return `
                    <label style="display:flex;align-items:flex-start;gap:0.6rem;padding:0.5rem 0.6rem;cursor:pointer;border:1.5px solid ${borderColor};border-radius:6px;background:${bg};transition:all 0.15s;margin-bottom:0.35rem" onmouseover="this.style.borderColor='${borderOn}'" onmouseout="this.style.borderColor='${borderColor}'">
                        <input type="radio" name="wiz-builder" value="${esc(b.name)}" ${sel ? 'checked' : ''} style="margin-top:0.15rem;accent-color:${borderOn}">
                        <div>
                            <div style="font-size:0.78rem;font-weight:600;color:${avail ? 'var(--text-primary)' : 'var(--text-muted)'}">${esc(b.label)} ${!avail ? '<span style="color:var(--warning);font-size:0.62rem">âš  not installed</span>' : ''}</div>
                            <div style="font-size:0.66rem;color:var(--text-muted);line-height:1.3;margin-top:0.1rem">${esc(b.description || '')}</div>
                        </div>
                    </label>`;
                }).join('');
                body.innerHTML = `
                    <div style="font-size:0.78rem;font-weight:600;margin-bottom:0.4rem">Choose Builder</div>
                    <div id="wiz-builders">${buildersHtml}</div>`;
                // Wire radio buttons to update visual selection
                body.querySelectorAll('input[name="wiz-builder"]').forEach(r => {
                    r.addEventListener('change', () => {
                        _wizData.builder = r.value;
                        renderWizStep();
                    });
                });
                actions.innerHTML = `
                    <button class="btn btn-sm btn-ghost" onclick="closeVaultModal()">Cancel</button>
                    <button class="btn btn-sm btn-ghost" id="wiz-back">â† Back</button>
                    <button class="btn btn-sm btn-primary" id="wiz-next">Next â†’</button>`;
                document.getElementById('wiz-back').onclick = () => { _wizStep = 1; renderWizStep(); };
                document.getElementById('wiz-next').onclick = () => { _wizStep = 3; renderWizStep(); };

            } else if (_wizStep === 3) {
                let featHtml = '';
                if (_wizData.builder === 'docusaurus' && _wizCategories.length) {
                    for (const cat of _wizCategories) {
                        featHtml += `<div style="margin-bottom:0.3rem"><div style="font-size:0.62rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em;padding:0.25rem 0.5rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:4px 4px 0 0;border-bottom:none">${esc(cat.label)}</div><div style="border:1px solid var(--border-subtle);border-radius:0 0 4px 4px;padding:0.15rem 0;background:rgba(15,17,26,0.4)">`;
                        for (const f of cat.features) {
                            if (f.options) continue; // skip select-based for wizard simplicity
                            const on = _wizData.features[f.key] !== undefined ? _wizData.features[f.key] : f.default;
                            featHtml += `<label style="display:flex;align-items:center;gap:0.5rem;padding:0.25rem 0.5rem;cursor:pointer;font-size:0.72rem"><input type="checkbox" class="wiz-feat" data-key="${f.key}" ${on ? 'checked' : ''} style="accent-color:#818cf8"><span>${f.label}</span></label>`;
                        }
                        featHtml += '</div></div>';
                    }
                }
                body.innerHTML = `
                    <div class="form-group" style="margin-bottom:var(--space-sm)">
                        <label style="font-size:0.78rem;font-weight:600">URL Path</label>
                        <input type="text" id="wiz-path" value="${esc(_wizData.path)}" placeholder="/${esc(_wizData.name)}" style="width:100%;margin-top:0.2rem" autocomplete="off">
                        <div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.15rem">Where this segment will be served (e.g. /docs, /api)</div>
                    </div>
                    ${featHtml ? '<div style="font-size:0.78rem;font-weight:600;margin-bottom:0.3rem">Features</div>' + featHtml : ''}`;
                actions.innerHTML = `
                    <button class="btn btn-sm btn-ghost" onclick="closeVaultModal()">Cancel</button>
                    <button class="btn btn-sm btn-ghost" id="wiz-back">â† Back</button>
                    <button class="btn btn-sm btn-primary" id="wiz-create">âœ¨ Create Segment</button>`;
                document.getElementById('wiz-back').onclick = () => { _wizStep = 2; renderWizStep(); };
                document.getElementById('wiz-create').onclick = async () => {
                    _wizData.path = document.getElementById('wiz-path').value.trim() || '/' + _wizData.name;
                    // Gather features from checkboxes
                    const features = {};
                    document.querySelectorAll('.wiz-feat').forEach(cb => {
                        features[cb.dataset.key] = cb.checked;
                    });
                    _wizData.features = features;

                    const btn = document.getElementById('wiz-create');
                    btn.disabled = true;
                    btn.textContent = 'Creatingâ€¦';
                    try {
                        const config = {};
                        if (_wizData.builder === 'docusaurus') {
                            config.features = features;
                            config.title = _wizData.name.charAt(0).toUpperCase() + _wizData.name.slice(1);
                        }
                        await api('/pages/segments', {
                            method: 'POST',
                            body: JSON.stringify({
                                name: _wizData.name,
                                source: _wizData.source,
                                builder: _wizData.builder,
                                path: _wizData.path,
                                config: config,
                            }),
                        });
                        closeVaultModal();
                        toast(`Segment '${_wizData.name}' created`, 'success');
                        await loadPagesCard();
                    } catch (e) {
                        errEl.textContent = e.message;
                        errEl.style.display = 'block';
                        btn.disabled = false;
                        btn.textContent = 'âœ¨ Create Segment';
                    }
                };
            }
        }
        renderWizStep();
    }

    async function removeSegment(name) {
        if (!confirm(`Remove segment '${name}'? This will delete its build workspace.`)) return;
        try {
            await api('/pages/segments/' + encodeURIComponent(name), { method: 'DELETE' });
            toast(`Segment '${name}' removed`, 'success');
            await loadPagesCard();
        } catch (e) {
            toast('Remove failed: ' + e.message, 'error');
        }
    }

    async function configureSegment(name, currentBuilder, source, path) {
        // Fetch builders list, current segment config, and feature registry in parallel
        let builders = [];
        let segConfig = {};
        let featureCategories = [];
        try {
            const [bd, sd, fd] = await Promise.all([
                api('/pages/builders').catch(() => ({ builders: [] })),
                api('/pages/segments').catch(() => ({ segments: [] })),
                api('/pages/features').catch(() => ({ categories: [] })),
            ]);
            builders = bd.builders || [];
            const seg = (sd.segments || []).find(s => s.name === name);
            if (seg) segConfig = seg.config || {};
            featureCategories = fd.categories || [];
        } catch (_) {}

        const optionsHtml = builders.map(b => {
            const sel = b.name === currentBuilder ? 'selected' : '';
            const avail = b.available ? '' : ' (not installed)';
            return `<option value="${esc(b.name)}" ${sel}>${esc(b.label)}${avail}</option>`;
        }).join('');

        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'vault-modal';
        modal.onclick = (e) => { if (e.target === modal) closeVaultModal(); };
        modal.innerHTML = `
        <div class="vault-modal" style="max-width:620px;max-height:88vh;overflow-y:auto">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                <h3 style="margin:0">âš™ï¸ Configure: <code style="color:#818cf8">${esc(name)}</code></h3>
                <button class="btn btn-sm btn-ghost" onclick="closeVaultModal()" style="font-size:1rem;padding:0.1rem 0.4rem" title="Close">âœ•</button>
            </div>

            <!-- Source + path (read-only info) -->
            <div style="display:flex;gap:var(--space-md);margin-bottom:var(--space-md);padding:0.5rem 0.75rem;background:var(--bg-inset);border-radius:6px;border:1px solid var(--border-subtle)">
                <div style="flex:1">
                    <span style="font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em">Source</span>
                    <div style="font-size:0.78rem;color:var(--text-secondary);font-family:var(--font-mono)">${esc(source)}</div>
                </div>
                <div style="flex:1">
                    <span style="font-size:0.68rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.05em">URL Path</span>
                    <div style="font-size:0.78rem;color:var(--text-secondary);font-family:var(--font-mono)">${esc(path)}</div>
                </div>
            </div>

            <!-- Builder selection -->
            <div class="form-group" style="margin-bottom:var(--space-md)">
                <label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.3rem">Builder</label>
                <select id="cfg-builder" style="width:100%">${optionsHtml}</select>
                <div id="cfg-builder-desc" style="font-size:0.72rem;color:var(--text-muted);margin-top:0.3rem"></div>
            </div>

            <!-- Site identity -->
            <div style="display:flex;gap:var(--space-sm);margin-bottom:var(--space-md)">
                <div class="form-group" style="flex:2">
                    <label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.3rem">Site Title</label>
                    <input type="text" id="cfg-title" value="${esc(segConfig.title || name.charAt(0).toUpperCase() + name.slice(1))}" style="width:100%" placeholder="My Documentation" autocomplete="off">
                </div>
                <div class="form-group" style="flex:3">
                    <label style="font-size:0.75rem;color:var(--text-muted);display:block;margin-bottom:0.3rem">Tagline</label>
                    <input type="text" id="cfg-tagline" value="${esc(segConfig.tagline || '')}" style="width:100%" placeholder="A brief description of this site" autocomplete="off">
                </div>
            </div>

            <!-- Feature registry (dynamic, builder-specific) -->
            <div id="cfg-features" style="margin-bottom:var(--space-md)"></div>

            <div id="cfg-error" style="display:none;color:var(--error);font-size:0.82rem;margin-bottom:var(--space-sm)"></div>
            <div style="display:flex;gap:var(--space-sm);justify-content:flex-end;padding-top:var(--space-sm);border-top:1px solid var(--border-subtle)">
                <button class="btn btn-sm btn-ghost" onclick="closeVaultModal()" type="button">Cancel</button>
                <button class="btn btn-sm btn-secondary" id="cfg-save-btn" type="button">Save</button>
                <button class="btn btn-sm btn-primary" id="cfg-save-build-btn" type="button">Save & Build</button>
            </div>
        </div>`;
        document.body.appendChild(modal);

        const sel = document.getElementById('cfg-builder');
        const descEl = document.getElementById('cfg-builder-desc');
        const featuresEl = document.getElementById('cfg-features');

        // â”€â”€ Render feature toggles from API registry â”€â”€
        function renderFeatures() {
            const builder = sel.value;
            if (builder !== 'docusaurus' || featureCategories.length === 0) {
                // Non-Docusaurus: show builder info + pipeline + config fields
                const builderInfo = builders.find(b => b.name === builder);
                if (!builderInfo) { featuresEl.innerHTML = ''; return; }

                let html = `
                <div style="margin-bottom:0.5rem">
                    <div style="font-size:0.68rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;padding:0.4rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px 6px 0 0;border-bottom:none">Pipeline</div>
                    <div style="border:1px solid var(--border-subtle);border-radius:0 0 6px 6px;padding:0.5rem 0.75rem;background:rgba(15,17,26,0.4)">
                        <div style="font-size:0.75rem;color:var(--text-secondary);margin-bottom:0.5rem">${esc(builderInfo.description || '')}</div>`;

                if (builderInfo.stages && builderInfo.stages.length) {
                    html += `<div style="display:flex;gap:0.3rem;align-items:center;flex-wrap:wrap">`;
                    builderInfo.stages.forEach((stage, i) => {
                        if (i > 0) html += `<span style="color:var(--text-muted);font-size:0.55rem">â†’</span>`;
                        html += `<span style="font-size:0.72rem;padding:0.15rem 0.5rem;border-radius:4px;background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);color:#818cf8">${esc(stage.label || stage.name)}</span>`;
                    });
                    html += `</div>`;
                }

                if (builderInfo.install_hint) {
                    html += `<div style="font-size:0.68rem;color:var(--text-muted);margin-top:0.5rem;font-style:italic">Requires: <code style="font-size:0.68rem">${esc(builderInfo.install_hint)}</code></div>`;
                }

                html += `</div></div>`;

                // â”€â”€ Dynamic config fields from builder schema â”€â”€
                const fields = builderInfo.config_fields || [];
                if (fields.length > 0) {
                    // Group by category
                    const cats = {};
                    for (const f of fields) {
                        const cat = f.category || 'Configuration';
                        if (!cats[cat]) cats[cat] = [];
                        cats[cat].push(f);
                    }

                    for (const [catName, catFields] of Object.entries(cats)) {
                        html += `
                        <div style="margin-bottom:0.5rem">
                            <div style="font-size:0.68rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;padding:0.4rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px 6px 0 0;border-bottom:none">${esc(catName)}</div>
                            <div style="border:1px solid var(--border-subtle);border-radius:0 0 6px 6px;padding:0.5rem 0.75rem;background:rgba(15,17,26,0.4)">`;

                        for (const f of catFields) {
                            const curVal = segConfig[f.key] !== undefined ? segConfig[f.key] : (f.default || '');
                            const reqBadge = f.required ? `<span style="color:var(--error);margin-left:0.2rem">*</span>` : '';

                            html += `<div style="margin-bottom:0.6rem">
                                <label style="font-size:0.72rem;color:var(--text-secondary);display:block;margin-bottom:0.2rem;font-weight:500">${esc(f.label)}${reqBadge}</label>`;

                            if (f.type === 'select' && f.options) {
                                const opts = Object.entries(f.options).map(([k, v]) =>
                                    `<option value="${esc(k)}" ${k === String(curVal) ? 'selected' : ''}>${esc(v)}</option>`
                                ).join('');
                                html += `<select class="cfg-builder-field" data-key="${esc(f.key)}" style="width:100%;font-size:0.72rem;padding:0.3rem 0.4rem;background:#0d0f17;color:#a0aec0;border:1px solid var(--border-subtle);border-radius:4px">${opts}</select>`;
                            } else if (f.type === 'textarea') {
                                const displayVal = typeof curVal === 'object' ? JSON.stringify(curVal, null, 2) : String(curVal);
                                html += `<textarea class="cfg-builder-field" data-key="${esc(f.key)}" rows="3" style="width:100%;font-family:var(--font-mono);font-size:0.68rem;background:#0d0f17;color:#a0aec0;border:1px solid var(--border-subtle);border-radius:4px;padding:0.4rem;resize:vertical;line-height:1.5" placeholder="${esc(f.placeholder || '')}">${esc(displayVal)}</textarea>`;
                            } else if (f.type === 'number') {
                                html += `<input type="number" class="cfg-builder-field" data-key="${esc(f.key)}" value="${esc(String(curVal))}" style="width:100%;font-size:0.72rem;padding:0.3rem 0.4rem;background:#0d0f17;color:#a0aec0;border:1px solid var(--border-subtle);border-radius:4px" placeholder="${esc(f.placeholder || '')}">`;
                            } else if (f.type === 'bool') {
                                const checked = curVal === true || curVal === 'true';
                                html += `<label style="display:inline-flex;align-items:center;gap:0.4rem;cursor:pointer">
                                    <span class="toggle-switch" style="position:relative;display:inline-block;width:36px;height:20px;flex-shrink:0">
                                        <input type="checkbox" class="cfg-builder-field" data-key="${esc(f.key)}" ${checked ? 'checked' : ''} style="opacity:0;width:0;height:0;position:absolute">
                                        <span style="position:absolute;cursor:pointer;inset:0;background:${checked ? 'var(--accent)' : '#2a2d3a'};border-radius:20px;transition:0.2s"></span>
                                    </span>
                                </label>`;
                            } else {
                                html += `<input type="text" class="cfg-builder-field" data-key="${esc(f.key)}" value="${esc(String(curVal))}" style="width:100%;font-size:0.72rem;padding:0.3rem 0.4rem;background:#0d0f17;color:#a0aec0;border:1px solid var(--border-subtle);border-radius:4px" placeholder="${esc(f.placeholder || '')}" autocomplete="off">`;
                            }

                            if (f.description) {
                                html += `<div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.15rem;line-height:1.3">${esc(f.description)}</div>`;
                            }
                            html += `</div>`;
                        }

                        html += `</div></div>`;
                    }
                }

                featuresEl.innerHTML = html;

                // Wire toggle switch visual update for bool fields
                featuresEl.querySelectorAll('.cfg-builder-field[type="checkbox"]').forEach(cb => {
                    cb.addEventListener('change', () => {
                        const track = cb.nextElementSibling;
                        track.style.background = cb.checked ? 'var(--accent)' : '#2a2d3a';
                    });
                });
                return;
            }

            const currentFeatures = segConfig.features || {};
            let html = '';

            for (const cat of featureCategories) {
                html += `
                <div style="margin-bottom:0.5rem">
                    <div style="font-size:0.68rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;padding:0.4rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px 6px 0 0;border-bottom:none">${esc(cat.label)}</div>
                    <div style="border:1px solid var(--border-subtle);border-radius:0 0 6px 6px;padding:0.3rem 0;background:rgba(15,17,26,0.4)">`;

                for (const feat of cat.features) {
                    const isEnabled = currentFeatures[feat.key] !== undefined
                        ? currentFeatures[feat.key]
                        : feat.default;
                    const depBadge = feat.has_deps
                        ? `<span style="font-size:0.58rem;padding:0.05rem 0.25rem;background:rgba(99,102,241,0.12);border:1px solid rgba(99,102,241,0.25);border-radius:3px;color:#818cf8;margin-left:0.3rem">+deps</span>`
                        : '';

                    if (feat.options) {
                        // Dropdown select for features with options
                        const currentVal = segConfig[feat.key] || Object.keys(feat.options)[0];
                        const optionsHtml = Object.entries(feat.options).map(([k, v]) =>
                            `<option value="${esc(k)}" ${k === currentVal ? 'selected' : ''}>${esc(v)}</option>`
                        ).join('');
                        html += `
                        <div style="display:flex;align-items:center;gap:0.6rem;padding:0.4rem 0.75rem">
                            <div style="flex:1;min-width:0">
                                <div style="display:flex;align-items:center;gap:0.15rem">
                                    <span style="font-size:0.78rem;font-weight:500;color:var(--text-primary)">${feat.label}</span>
                                    ${depBadge}
                                </div>
                                <div style="font-size:0.66rem;color:var(--text-muted);line-height:1.3;margin-top:0.1rem">${esc(feat.description)}</div>
                            </div>
                            <select class="cfg-feature-select" data-key="${feat.key}" style="font-size:0.72rem;padding:0.2rem 0.4rem;background:#0d0f17;color:#a0aec0;border:1px solid var(--border-subtle);border-radius:4px;cursor:pointer">
                                ${optionsHtml}
                            </select>
                        </div>`;
                    } else {
                        // Standard toggle switch
                        html += `
                        <label style="display:flex;align-items:center;gap:0.6rem;padding:0.4rem 0.75rem;cursor:pointer;transition:background 0.15s" onmouseover="this.style.background='rgba(99,102,241,0.04)'" onmouseout="this.style.background='transparent'">
                            <span class="toggle-switch" style="position:relative;display:inline-block;width:36px;height:20px;flex-shrink:0">
                                <input type="checkbox" class="cfg-feature" data-key="${feat.key}" ${isEnabled ? 'checked' : ''} style="opacity:0;width:0;height:0;position:absolute">
                                <span style="position:absolute;cursor:pointer;inset:0;background:${isEnabled ? 'var(--accent)' : '#2a2d3a'};border-radius:20px;transition:0.2s"></span>
                            </span>
                            <div style="flex:1;min-width:0">
                                <div style="display:flex;align-items:center;gap:0.15rem">
                                    <span style="font-size:0.78rem;font-weight:500;color:var(--text-primary)">${feat.label}</span>
                                    ${depBadge}
                                </div>
                                <div style="font-size:0.66rem;color:var(--text-muted);line-height:1.3;margin-top:0.1rem">${esc(feat.description)}</div>
                            </div>
                        </label>`;
                    }
                }

                html += `</div></div>`;
            }

            // â”€â”€ Custom CSS editor â”€â”€
            const customCss = segConfig.custom_css || '';
            html += `
            <div style="margin-top:0.5rem">
                <div style="font-size:0.68rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;padding:0.4rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px 6px 0 0;border-bottom:none">Custom CSS</div>
                <div style="border:1px solid var(--border-subtle);border-radius:0 0 6px 6px;padding:0.5rem 0.75rem;background:rgba(15,17,26,0.4)">
                    <textarea id="cfg-custom-css" rows="3" style="width:100%;font-family:var(--font-mono);font-size:0.68rem;background:#0d0f17;color:#a0aec0;border:1px solid var(--border-subtle);border-radius:4px;padding:0.4rem;resize:vertical;line-height:1.5" placeholder=":root { --ifm-color-primary: #yourcolor; }">${esc(customCss)}</textarea>
                    <div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.2rem">Appended after the default theme CSS. Use Infima CSS variables for Docusaurus theming.</div>
                </div>
            </div>
            <div style="margin-top:0.5rem">
                <div style="font-size:0.68rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;padding:0.4rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px 6px 0 0;border-bottom:none">Navbar Items</div>
                <div style="border:1px solid var(--border-subtle);border-radius:0 0 6px 6px;padding:0.5rem 0.75rem;background:rgba(15,17,26,0.4)">
                    <textarea id="cfg-navbar-items" rows="3" style="width:100%;font-family:var(--font-mono);font-size:0.68rem;background:#0d0f17;color:#a0aec0;border:1px solid var(--border-subtle);border-radius:4px;padding:0.4rem;resize:vertical;line-height:1.5" placeholder='[{"label":"API","href":"https://api.example.com","position":"right"}]'>${esc(JSON.stringify(segConfig.navbar_items || [], null, 2))}</textarea>
                    <div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.2rem">JSON array of extra navbar items. Each: <code style="font-size:0.6rem">{label, href, position}</code> or <code style="font-size:0.6rem">{label, to, position}</code>.</div>
                </div>
            </div>
            <div style="margin-top:0.5rem">
                <div style="font-size:0.68rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;padding:0.4rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px 6px 0 0;border-bottom:none">Extra Sidebars</div>
                <div style="border:1px solid var(--border-subtle);border-radius:0 0 6px 6px;padding:0.5rem 0.75rem;background:rgba(15,17,26,0.4)">
                    <textarea id="cfg-extra-sidebars" rows="2" style="width:100%;font-family:var(--font-mono);font-size:0.68rem;background:#0d0f17;color:#a0aec0;border:1px solid var(--border-subtle);border-radius:4px;padding:0.4rem;resize:vertical;line-height:1.5" placeholder='{"api":"api","guides":"guides"}'>${esc(JSON.stringify(segConfig.extra_sidebars || {}, null, 2))}</textarea>
                    <div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.2rem">JSON object mapping sidebar IDs to directory names. Default sidebar <code style="font-size:0.6rem">docs</code> always exists.</div>
                </div>
            </div>
            <div style="margin-top:0.5rem">
                <div style="font-size:0.68rem;font-weight:600;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;padding:0.4rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px 6px 0 0;border-bottom:none">Extra npm Packages</div>
                <div style="border:1px solid var(--border-subtle);border-radius:0 0 6px 6px;padding:0.5rem 0.75rem;background:rgba(15,17,26,0.4)">
                    <textarea id="cfg-extra-packages" rows="2" style="width:100%;font-family:var(--font-mono);font-size:0.68rem;background:#0d0f17;color:#a0aec0;border:1px solid var(--border-subtle);border-radius:4px;padding:0.4rem;resize:vertical;line-height:1.5" placeholder='{"lodash":"^4.17.21","dayjs":"^1.11.0"}'>${esc(JSON.stringify(segConfig.extra_packages || {}, null, 2))}</textarea>
                    <div style="font-size:0.62rem;color:var(--text-muted);margin-top:0.2rem">JSON object of additional npm packages. Format: <code style="font-size:0.6rem">{"package": "version"}</code>. Added to dependencies in package.json.</div>
                </div>
            </div>`;

            featuresEl.innerHTML = html;

            // Wire toggle switch visual update
            featuresEl.querySelectorAll('.cfg-feature').forEach(cb => {
                cb.addEventListener('change', () => {
                    const track = cb.nextElementSibling;
                    track.style.background = cb.checked ? 'var(--accent)' : '#2a2d3a';
                });
            });
        }

        function updateDesc() {
            const b = builders.find(x => x.name === sel.value);
            if (b) {
                let info = b.description;
                if (!b.available) info += ' âš ï¸ Not installed.';
                descEl.textContent = info;
            }
            renderFeatures();
        }
        sel.addEventListener('change', updateDesc);
        updateDesc();

        function gatherConfig() {
            const config = { ...segConfig };
            config.title = document.getElementById('cfg-title').value.trim() || name;
            const tagline = document.getElementById('cfg-tagline').value.trim();
            if (tagline) config.tagline = tagline;

            if (sel.value === 'docusaurus') {
                const features = {};
                document.querySelectorAll('.cfg-feature').forEach(cb => {
                    features[cb.dataset.key] = cb.checked;
                });
                config.features = features;
                // Gather select-based feature values (e.g. prism_theme)
                document.querySelectorAll('.cfg-feature-select').forEach(sel => {
                    config[sel.dataset.key] = sel.value;
                });
                const cssEl = document.getElementById('cfg-custom-css');
                if (cssEl) config.custom_css = cssEl.value;
                // Navbar items (JSON array)
                const navEl = document.getElementById('cfg-navbar-items');
                if (navEl) {
                    try { const v = JSON.parse(navEl.value); if (Array.isArray(v)) config.navbar_items = v; }
                    catch(_) { /* keep previous */ }
                }
                // Extra sidebars (JSON object)
                const sbEl = document.getElementById('cfg-extra-sidebars');
                if (sbEl) {
                    try { const v = JSON.parse(sbEl.value); if (v && typeof v === 'object' && !Array.isArray(v)) config.extra_sidebars = v; }
                    catch(_) { /* keep previous */ }
                }
                // Extra npm packages (JSON object)
                const pkgEl = document.getElementById('cfg-extra-packages');
                if (pkgEl) {
                    try { const v = JSON.parse(pkgEl.value); if (v && typeof v === 'object' && !Array.isArray(v)) config.extra_packages = v; }
                    catch(_) { /* keep previous */ }
                }
            } else {
                // Gather builder-specific config fields
                document.querySelectorAll('.cfg-builder-field').forEach(el => {
                    const key = el.dataset.key;
                    if (!key) return;
                    if (el.type === 'checkbox') {
                        config[key] = el.checked;
                    } else if (el.type === 'number') {
                        const n = parseInt(el.value, 10);
                        config[key] = isNaN(n) ? el.value : n;
                    } else {
                        const val = el.value.trim();
                        if (val) {
                            config[key] = val;
                        } else {
                            delete config[key];  // Don't save empty strings
                        }
                    }
                });
            }
            return config;
        }

        document.getElementById('cfg-save-btn').onclick = async () => {
            try {
                await api('/pages/segments/' + encodeURIComponent(name), {
                    method: 'PUT',
                    body: JSON.stringify({ builder: sel.value, config: gatherConfig() }),
                });
                closeVaultModal();
                toast(`Segment '${name}' updated`, 'success');
                await loadPagesCard();
            } catch (e) {
                document.getElementById('cfg-error').textContent = e.message;
                document.getElementById('cfg-error').style.display = 'block';
            }
        };

        document.getElementById('cfg-save-build-btn').onclick = async () => {
            const btn = document.getElementById('cfg-save-build-btn');
            btn.disabled = true;
            btn.textContent = 'Savingâ€¦';
            try {
                await api('/pages/segments/' + encodeURIComponent(name), {
                    method: 'PUT',
                    body: JSON.stringify({ builder: sel.value, config: gatherConfig() }),
                });
                closeVaultModal();
                toast(`Segment '${name}' updated`, 'success');
                buildSegmentStream(name);
            } catch (e) {
                document.getElementById('cfg-error').textContent = e.message;
                document.getElementById('cfg-error').style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Save & Build';
            }
        };
    }

    async function buildSegment(name) {
        toast(`Building '${name}'â€¦`, 'info');
        try {
            const data = await api('/pages/build/' + encodeURIComponent(name), { method: 'POST' });
            if (data.ok) {
                toast(`Built '${name}' in ${data.duration_ms}ms`, 'success');
            } else {
                toast(`Build failed: ${data.error}`, 'error');
            }
            await loadPagesCard();
        } catch (e) {
            toast('Build failed: ' + e.message, 'error');
        }
    }

    async function buildAllSegments() {
        // Fetch current segments
        let segments = [];
        try {
            const data = await api('/pages/segments');
            segments = (data.segments || []).map(s => s.name);
        } catch (e) {
            toast('Failed to load segments: ' + e.message, 'error');
            return;
        }
        if (segments.length === 0) {
            toast('No segments to build', 'info');
            return;
        }

        const results = [];

        for (let i = 0; i < segments.length; i++) {
            const name = segments[i];
            toast(`Building ${i+1}/${segments.length}: ${name}â€¦`, 'info');

            // Build with streaming â€” wait for it to complete
            const ok = await new Promise(resolve => {
                buildSegmentStream(name, {
                    onComplete: (ok) => {
                        results.push({ segment: name, ok });
                        if (ok && i < segments.length - 1) {
                            // Auto-close successful builds to proceed to next
                            setTimeout(() => { closeBuildModal(); resolve(ok); }, 1200);
                        } else {
                            // On failure or last build: keep modal open, wait for user close
                            if (!ok) {
                                // Wait for user to close the modal, then resolve
                                const waitForClose = setInterval(() => {
                                    if (!document.getElementById('build-modal')) {
                                        clearInterval(waitForClose);
                                        resolve(ok);
                                    }
                                }, 200);
                            } else {
                                resolve(ok);
                            }
                        }
                    }
                });
            });
        }

        // Summary
        const failed = results.filter(r => !r.ok).map(r => r.segment);
        if (failed.length === 0) {
            toast(`All ${segments.length} segments built successfully`, 'success');
        } else {
            toast(`${failed.length}/${segments.length} failed: ${failed.join(', ')}`, 'error');
        }
        await loadPagesCard();
    }

    async function mergeSegments() {
        toast('Merging segmentsâ€¦', 'info');
        try {
            const data = await api('/pages/merge', { method: 'POST' });
            if (data.ok) {
                toast(`Merged ${data.segments_merged.length} segment(s)`, 'success');
            } else {
                toast(`Merge had errors: ${data.errors.join('; ')}`, 'error');
            }
        } catch (e) {
            toast('Merge failed: ' + e.message, 'error');
        }
    }

    async function deployPages() {
        if (!confirm('Deploy to gh-pages?\n\nThis will merge all built segments and force-push to the remote gh-pages branch.')) return;

        // Auto-merge before deploying
        toast('Merging segmentsâ€¦', 'info');
        try {
            const mergeData = await api('/pages/merge', { method: 'POST' });
            if (!mergeData.ok) {
                toast(`Merge failed: ${mergeData.errors.join('; ')}`, 'error');
                return;
            }
            toast(`Merged ${mergeData.segments_merged.length} segment(s)`, 'success');
        } catch (e) {
            toast('Merge failed: ' + e.message, 'error');
            return;
        }

        // Now deploy
        toast('Deploying to gh-pagesâ€¦', 'info');
        try {
            const data = await api('/pages/deploy', { method: 'POST' });
            if (data.ok) {
                toast('Deployed to gh-pages!', 'success');
            } else {
                toast('Deploy failed: ' + data.error, 'error');
            }
        } catch (e) {
            toast('Deploy failed: ' + e.message, 'error');
        }
    }

    // â”€â”€ SSE Build Streaming â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    let _buildAbort = null;
    let _buildTimerIds = {};
    let _activeBuild = null;  // { name, stage, startTs } â€” persistent status

    function _updateSegmentRowStatus(name, stage, done) {
        // Update the segment row in the Pages card to show build progress
        const rows = document.querySelectorAll('[data-segment-row]');
        for (const row of rows) {
            if (row.dataset.segmentRow === name) {
                const statusEl = row.querySelector('.segment-build-status');
                if (!statusEl) break;
                if (done) {
                    statusEl.innerHTML = '';
                    statusEl.style.display = 'none';
                } else {
                    statusEl.innerHTML = `<span onclick="showBuildModal()" style="display:inline-flex;align-items:center;gap:0.25rem;font-size:0.65rem;color:#818cf8;cursor:pointer" title="Click to view build log"><span style="animation:pulse 1.2s infinite;font-size:0.5rem">â—</span> ${stage || 'buildingâ€¦'} ğŸ‘</span>`;
                    statusEl.style.display = 'inline';
                }
                break;
            }
        }
    }

    function showBuildModal() {
        const modal = document.getElementById('build-modal');
        if (modal) modal.style.display = '';
    }

    function abortBuild() {
        // Actually kill the build SSE stream and clean up
        if (_buildAbort) { try { _buildAbort.abort(); } catch(_){} _buildAbort = null; }
        for (const id of Object.values(_buildTimerIds)) clearInterval(id);
        _buildTimerIds = {};
        if (_activeBuild) { _updateSegmentRowStatus(_activeBuild.name, null, true); _activeBuild = null; }
        const modal = document.getElementById('build-modal');
        if (modal) modal.remove();
        loadPagesCard();
    }

    function closeBuildModal() {
        const modal = document.getElementById('build-modal');
        if (_activeBuild) {
            // Build still running â€” just hide the modal, keep the SSE stream alive
            if (modal) modal.style.display = 'none';
        } else {
            // Build finished or no build â€” full cleanup
            if (_buildAbort) { try { _buildAbort.abort(); } catch(_){} _buildAbort = null; }
            for (const id of Object.values(_buildTimerIds)) clearInterval(id);
            _buildTimerIds = {};
            if (modal) modal.remove();
            loadPagesCard();
        }
    }

    function buildSegmentStream(name, opts) {
        opts = opts || {};
        const isClean = !!opts.clean;
        const isWipe = !!opts.wipe;
        const noMinify = !!opts.noMinify;
        const onComplete = opts.onComplete || null;
        // Kill any previous build
        if (_buildAbort) { try { _buildAbort.abort(); } catch(_){} }
        if (_activeBuild) { _updateSegmentRowStatus(_activeBuild.name, null, true); }
        for (const id of Object.values(_buildTimerIds)) clearInterval(id);
        _buildTimerIds = {};
        const oldModal = document.getElementById('build-modal');
        if (oldModal) oldModal.remove();
        _buildAbort = new AbortController();
        _activeBuild = { name, stage: null, startTs: performance.now() };
        _updateSegmentRowStatus(name, 'startingâ€¦', false);

        const buildIcon = isWipe ? 'ğŸ”„' : isClean ? 'ğŸ§¹' : noMinify ? 'ğŸš€' : 'ğŸ”¨';
        const buildLabel = isWipe ? 'Full Rebuild' : isClean ? 'Clean Build' : noMinify ? 'Build (no minify)' : 'Building';

        const modal = document.createElement('div');
        modal.className = 'vault-modal-overlay';
        modal.id = 'build-modal';
        modal.onclick = (e) => { if (e.target === modal) closeBuildModal(); };
        modal.innerHTML = `
        <div class="vault-modal" style="max-width:760px;max-height:92vh;overflow-y:auto">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-md)">
                <h3 style="margin:0">${buildIcon} ${buildLabel}: <code style="font-size:0.9em;color:#818cf8">${esc(name)}</code></h3>
                <button class="btn btn-sm btn-ghost" onclick="closeBuildModal()" style="font-size:1.1rem;padding:0.1rem 0.4rem" title="Close">âœ•</button>
            </div>
            <div id="build-pipeline-timer" style="font-size:0.72rem;color:var(--text-muted);margin-bottom:var(--space-sm)">â± Elapsed: 0.0s</div>
            <div id="build-stages" style="display:flex;flex-direction:column;gap:0.5rem;margin-bottom:var(--space-md)">
                <div style="color:var(--text-muted);font-size:0.78rem;padding:0.5rem">Connectingâ€¦</div>
            </div>
            <div id="build-status" style="font-size:0.82rem;padding:0.5rem 0">
                <span style="color:var(--text-muted)">â³ Waiting for pipelineâ€¦</span>
            </div>
            <div id="build-actions" style="display:flex;gap:var(--space-sm);justify-content:flex-end;padding-top:var(--space-sm);border-top:1px solid var(--border-subtle)">
                <button id="build-cancel-btn" class="btn btn-sm" onclick="abortBuild()" style="background:var(--error);color:white;border:none">â›” Abort Build</button>
                <button class="btn btn-sm btn-ghost" onclick="closeBuildModal()" title="Hide modal (build keeps running)">Minimize</button>
            </div>
        </div>`;
        document.body.appendChild(modal);

        const stagesEl = document.getElementById('build-stages');
        const statusEl = document.getElementById('build-status');
        const actionsEl = document.getElementById('build-actions');
        const timerEl = document.getElementById('build-pipeline-timer');

        // Per-stage state: { el, label, logEl, logCount, lineCount, startTs }
        const stages = {};
        let currentStage = '';
        const pipelineStart = performance.now();

        // Live pipeline timer
        const pipelineTimerId = setInterval(() => {
            const elapsed = ((performance.now() - pipelineStart) / 1000).toFixed(1);
            timerEl.textContent = `â± Elapsed: ${elapsed}s`;
        }, 100);
        _buildTimerIds['_pipeline'] = pipelineTimerId;

        function _fmtMs(ms) { return ms < 1000 ? ms + 'ms' : (ms / 1000).toFixed(1) + 's'; }

        function _makeStageCard(stageName, label) {
            const wrapper = document.createElement('div');
            wrapper.id = 'build-stage-' + stageName;
            wrapper.style.cssText = 'border:1px solid var(--border-subtle);border-radius:8px;overflow:hidden;transition:border-color 0.2s';

            // Header row
            const header = document.createElement('div');
            header.className = 'stage-header';
            header.style.cssText = 'display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;background:var(--bg-inset);cursor:pointer;user-select:none';
            header.innerHTML = `
                <span class="stage-icon" style="min-width:1.2rem;text-align:center;font-size:0.85rem">â—‹</span>
                <span class="stage-label" style="font-weight:600;font-size:0.82rem;color:var(--text-muted)">${esc(label)}</span>
                <span class="stage-detail" style="margin-left:auto;font-size:0.68rem;color:var(--text-muted)"></span>
                <span class="stage-lines" style="font-size:0.6rem;color:var(--text-muted);background:var(--bg-elevated);padding:0 0.25rem;border-radius:3px;display:none">0</span>
                <span class="stage-toggle" style="font-size:0.6rem;color:var(--text-muted);transition:transform 0.15s">â–¶</span>`;
            wrapper.appendChild(header);

            // Log area (hidden by default, auto-shown on run)
            const logArea = document.createElement('div');
            logArea.className = 'stage-log';
            logArea.style.cssText = 'display:none;background:#0d0f17;padding:0.5rem 0.75rem;font-family:var(--font-mono);font-size:0.66rem;max-height:200px;overflow-y:auto;line-height:1.5;color:#8892a8;white-space:pre-wrap;border-top:1px solid #1a1f2e';
            wrapper.appendChild(logArea);

            // Toggle log on header click
            header.onclick = () => {
                const showing = logArea.style.display !== 'none';
                logArea.style.display = showing ? 'none' : 'block';
                header.querySelector('.stage-toggle').textContent = showing ? 'â–¶' : 'â–¼';
                if (!showing) logArea.scrollTop = logArea.scrollHeight;
            };

            return wrapper;
        }

        function _setStageStatus(stageName, status, detail) {
            const info = stages[stageName];
            if (!info) return;
            const wrapper = info.el;
            const iconEl = wrapper.querySelector('.stage-icon');
            const labelEl = wrapper.querySelector('.stage-label');
            const detailEl = wrapper.querySelector('.stage-detail');

            const icons = { pending: 'â—‹', running: 'âŸ³', done: 'âœ…', error: 'âŒ', skipped: 'âŠ˜' };
            const colors = { pending: 'var(--text-muted)', running: '#818cf8', done: 'var(--success)', error: 'var(--error)', skipped: 'var(--text-muted)' };
            const borders = { pending: 'var(--border-subtle)', running: '#818cf8', done: '#22c55e40', error: '#ef444460', skipped: 'var(--border-subtle)' };
            const bgs = { running: 'rgba(129,140,248,0.04)', error: 'rgba(239,68,68,0.04)' };

            iconEl.textContent = icons[status] || 'â—‹';
            if (status === 'running') iconEl.style.animation = 'spin 1s linear infinite';
            else iconEl.style.animation = '';
            labelEl.style.color = colors[status] || 'var(--text-muted)';
            detailEl.textContent = detail || '';
            wrapper.style.borderColor = borders[status] || 'var(--border-subtle)';
            wrapper.querySelector('.stage-header').style.background = bgs[status] || 'var(--bg-inset)';
        }

        // â”€â”€ Batched log rendering (prevents UI freeze) â”€â”€
        const _logBuffers = {};  // stageName â†’ { lines: [], rafId: null, timer: null }

        function _addStageLine(stageName, line) {
            const info = stages[stageName];
            if (!info) return;
            info.lineCount++;

            // Buffer the line instead of writing to DOM immediately
            if (!_logBuffers[stageName]) {
                _logBuffers[stageName] = { lines: [], scheduled: false };
            }
            _logBuffers[stageName].lines.push(line);

            // Schedule a flush if not already scheduled
            if (!_logBuffers[stageName].scheduled) {
                _logBuffers[stageName].scheduled = true;
                requestAnimationFrame(() => _flushStageLog(stageName));
            }
        }

        function _flushStageLog(stageName) {
            const buf = _logBuffers[stageName];
            if (!buf || buf.lines.length === 0) {
                if (buf) buf.scheduled = false;
                return;
            }
            const info = stages[stageName];
            if (!info) { buf.lines = []; buf.scheduled = false; return; }

            // Batch write all buffered lines at once
            info.logEl.textContent += buf.lines.join('\n') + '\n';
            buf.lines = [];
            buf.scheduled = false;

            // Single scroll + counter update
            info.logEl.scrollTop = info.logEl.scrollHeight;
            const linesEl = info.el.querySelector('.stage-lines');
            linesEl.style.display = 'inline';
            linesEl.textContent = info.lineCount;
        }

        function _flushAllStageLogs() {
            for (const name of Object.keys(_logBuffers)) {
                _flushStageLog(name);
            }
        }

        function _expandStageLog(stageName) {
            const info = stages[stageName];
            if (!info) return;
            info.logEl.style.display = 'block';
            info.el.querySelector('.stage-toggle').textContent = 'â–¼';
        }

        function _collapseStageLog(stageName) {
            const info = stages[stageName];
            if (!info) return;
            info.logEl.style.display = 'none';
            info.el.querySelector('.stage-toggle').textContent = 'â–¶';
        }

        function _startStageTimer(stageName) {
            const info = stages[stageName];
            if (!info) return;
            info.startTs = performance.now();
            const tid = setInterval(() => {
                const elapsed = ((performance.now() - info.startTs) / 1000).toFixed(1);
                info.el.querySelector('.stage-detail').textContent = elapsed + 'sâ€¦';
            }, 100);
            _buildTimerIds[stageName] = tid;
        }

        function _stopStageTimer(stageName) {
            if (_buildTimerIds[stageName]) {
                clearInterval(_buildTimerIds[stageName]);
                delete _buildTimerIds[stageName];
            }
        }

        // â”€â”€ SSE connection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const params = [];
        if (isClean) params.push('clean=true');
        if (isWipe) params.push('wipe=true');
        if (noMinify) params.push('no_minify=true');
        const qs = params.length ? '?' + params.join('&') : '';
        const buildUrl = '/api/pages/build-stream/' + encodeURIComponent(name) + qs;
        fetch(buildUrl, {
            method: 'POST',
            signal: _buildAbort.signal,
        })
        .then(response => {
            if (!response.ok) throw new Error(`Server ${response.status}: ${response.statusText}`);
            stagesEl.innerHTML = '';
            statusEl.innerHTML = '<span style="color:#818cf8">ğŸ”¨ Pipeline startingâ€¦</span>';

            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';

            function read() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        _flushAllStageLogs();
                        if (!statusEl.querySelector('.build-final')) {
                            statusEl.innerHTML = '<span style="color:var(--warning)" class="build-final">âš ï¸ Stream ended unexpectedly</span>';
                            if (currentStage && stages[currentStage]) _expandStageLog(currentStage);
                        }
                        clearInterval(pipelineTimerId);
                        for (const id of Object.values(_buildTimerIds)) clearInterval(id);
                        loadPagesCard();
                        return;
                    }
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        let evt;
                        try { evt = JSON.parse(line.slice(6)); } catch(e) { continue; }

                        if (evt.type === 'pipeline_start') {
                            stagesEl.innerHTML = '';
                            statusEl.innerHTML = '<span style="color:#818cf8">ğŸ”¨ Buildingâ€¦</span>';
                            for (const s of (evt.stages || [])) {
                                const card = _makeStageCard(s.name, s.label || s.name);
                                stagesEl.appendChild(card);
                                stages[s.name] = {
                                    el: card,
                                    label: s.label || s.name,
                                    logEl: card.querySelector('.stage-log'),
                                    lineCount: 0,
                                    startTs: 0,
                                };
                                _setStageStatus(s.name, 'pending', '');
                            }

                        } else if (evt.type === 'stage_start') {
                            // collapse previous stage log
                            if (currentStage && currentStage !== evt.stage) _collapseStageLog(currentStage);
                            currentStage = evt.stage;
                            _setStageStatus(evt.stage, 'running', 'startingâ€¦');
                            _expandStageLog(evt.stage);
                            _startStageTimer(evt.stage);
                            statusEl.innerHTML = `<span style="color:#818cf8">â–¶ ${esc(evt.label || evt.stage)}</span>`;
                            if (_activeBuild) { _activeBuild.stage = evt.label || evt.stage; }
                            _updateSegmentRowStatus(name, evt.label || evt.stage, false);

                        } else if (evt.type === 'log') {
                            _addStageLine(currentStage, evt.line || '');

                        } else if (evt.type === 'stage_done') {
                            _flushAllStageLogs();
                            _stopStageTimer(evt.stage);
                            _setStageStatus(evt.stage, 'done', _fmtMs(evt.duration_ms || 0));
                            _collapseStageLog(evt.stage);

                        } else if (evt.type === 'stage_error') {
                            _flushAllStageLogs();
                            _stopStageTimer(evt.stage);
                            // Show first line in status badge, rest in log
                            const errLines = (evt.error || 'failed').split('\n');
                            _setStageStatus(evt.stage, 'error', esc(errLines[0]));
                            for (const eLine of errLines) {
                                _addStageLine(evt.stage, `âŒ ${eLine}`);
                            }
                            _expandStageLog(evt.stage);

                        } else if (evt.type === 'pipeline_done') {
                            _flushAllStageLogs();
                            clearInterval(pipelineTimerId);
                            for (const id of Object.values(_buildTimerIds)) clearInterval(id);
                            _buildTimerIds = {};

                            const totalT = _fmtMs(evt.total_ms || 0);
                            timerEl.textContent = `â± Total: ${totalT}`;

                            if (currentStage) _collapseStageLog(currentStage);

                            // Update skipped stages
                            if (evt.stages) {
                                for (const s of evt.stages) {
                                    if (s.status === 'skipped') _setStageStatus(s.name, 'skipped', 'skipped');
                                }
                            }

                            if (evt.ok) {
                                statusEl.innerHTML = `<span style="color:var(--success)" class="build-final">âœ… Pipeline complete â€” ${totalT}</span>`;
                                if (evt.serve_url) {
                                    actionsEl.innerHTML = `
                                        <a href="${esc(evt.serve_url)}" target="_blank" class="btn btn-sm btn-primary" style="text-decoration:none;display:inline-flex;align-items:center;gap:0.25rem">ğŸŒ View Site</a>
                                        <button class="btn btn-sm btn-secondary" onclick="closeBuildModal()">Close</button>`;
                                }
                            } else {
                                const rawErr = evt.error || (evt.stages || []).filter(s => s.status === 'error').map(s => s.error).join(', ') || 'unknown';
                                const errFirst = rawErr.split('\n')[0];
                                statusEl.innerHTML = `<span style="color:var(--error)" class="build-final">âŒ Pipeline failed: ${esc(errFirst)}</span>`;
                                actionsEl.innerHTML = `
                                    <button class="btn btn-sm" onclick="closeBuildModal(); buildSegmentStream('${esc(name)}')" style="background:#818cf8;color:white;border:none">ğŸ”„ Retry</button>
                                    <button class="btn btn-sm" onclick="closeBuildModal(); buildSegmentStream('${esc(name)}', {clean:true})" style="background:var(--warning);color:white;border:none">ğŸ§¹ Clean Retry</button>
                                    <button class="btn btn-sm" onclick="closeBuildModal(); buildSegmentStream('${esc(name)}', {wipe:true})" style="background:var(--error);color:white;border:none">ğŸ”„ Full Rebuild</button>
                                    <button class="btn btn-sm btn-secondary" onclick="closeBuildModal()">Close</button>`;
                                // expand failed stages
                                if (evt.stages) {
                                    for (const s of evt.stages) {
                                        if (s.status === 'error') _expandStageLog(s.name);
                                    }
                                }
                            }
                            loadPagesCard();
                            _activeBuild = null;
                            _updateSegmentRowStatus(name, null, true);
                            if (onComplete) onComplete(evt.ok);

                        } else if (evt.type === 'error') {
                            statusEl.innerHTML = `<span style="color:var(--error)" class="build-final">âŒ ${esc(evt.message || 'error')}</span>`;
                            if (onComplete) onComplete(false);
                        }
                    }
                    read();
                }).catch(err => {
                    if (err.name === 'AbortError') { if (onComplete) onComplete(false); return; }
                    clearInterval(pipelineTimerId);
                    statusEl.innerHTML = `<span style="color:var(--error)" class="build-final">âš ï¸ Stream interrupted: ${esc(err.message)}</span>`;
                    actionsEl.innerHTML = `<button class="btn btn-sm btn-secondary" onclick="closeBuildModal()">Close</button>`;
                    if (currentStage) _expandStageLog(currentStage);
                    loadPagesCard();
                    if (onComplete) onComplete(false);
                });
            }
            read();
        })
        .catch(err => {
            if (err.name === 'AbortError') { if (onComplete) onComplete(false); return; }
            clearInterval(pipelineTimerId);
            statusEl.innerHTML = `<span style="color:var(--error)" class="build-final">âŒ Connection failed: ${esc(err.message)}</span>`;
            if (onComplete) onComplete(false);
        });
    }

    // â”€â”€ Preview Management (removed) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Random-port preview servers have been replaced by integrated hosting.
    // Built sites are served at /pages/site/<segment>/ by Flask directly.
    // The preview API endpoints still exist for dev-server use cases.

    // â”€â”€ CI Workflow Generation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function generateCI() {
        toast('Generating deploy workflowâ€¦', 'info');
        try {
            const data = await api('/pages/generate-ci', { method: 'POST', body: '{}' });
            if (data.ok) {
                toast(`Workflow created: ${data.path}`, 'success');
            } else {
                toast('CI generation failed: ' + data.error, 'error');
            }
        } catch (e) {
            toast('CI generation failed: ' + e.message, 'error');
        }
    }


    // (installBuilder is now defined above via _installBuilderAsync)

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function _timeAgo(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        const now = new Date();
        const sec = Math.floor((now - d) / 1000);
        if (sec < 60) return 'just now';
        const min = Math.floor(sec / 60);
        if (min < 60) return min + 'm ago';
        const hr = Math.floor(min / 60);
        if (hr < 24) return hr + 'h ago';
        const days = Math.floor(hr / 24);
        if (days < 30) return days + 'd ago';
        const months = Math.floor(days / 30);
        return months + 'mo ago';
    }
</script>