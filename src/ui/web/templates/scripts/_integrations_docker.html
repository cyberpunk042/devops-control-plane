/* Integrations Tab JS â€” Docker Card
     loadDockerCard(), live tabs (containers, images, compose, networks, volumes),
     logs, inspect, pull image, exec, remove, generate modals (Dockerfile, Compose).
     Depends on: _integrations_init.html (card registry)
*/
    // â”€â”€ Docker Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadDockerCard() {
        const badge = document.getElementById('int-docker-badge');
        const detail = document.getElementById('int-docker-detail');

        try {
            const cached = cardCached('docker');
            const data = cached || await api('/docker/status');
            if (!cached) cardStore('docker', data);

            // â”€â”€ Not installed â”€â”€
            if (!data.available) {
                badge.className = 'status-badge failed';
                badge.innerHTML = '<span class="status-dot"></span>Not installed';
                let html = cardSetupBanner('ğŸ³', 'Docker not installed',
                    'Install Docker to enable container builds, or generate config files to prepare.',
                    'docker', 'Docker Setup â†’');
                // Missing tools banner
                html += '<div id="docker-missing-tools"></div>';
                html += cardEmpty('ğŸ³', 'Docker CLI not found.',
                    { label: 'ğŸ“¦ Install Docker', onclick: "_showSudoInstallModal('docker','docker',this,true)" });
                // Show detected files even without Docker
                const hasFiles = (data.dockerfiles && data.dockerfiles.length) || data.has_compose;
                if (hasFiles) {
                    html += cardDetectionList([
                        ...(data.dockerfiles||[]).map(f => ({ icon: 'ğŸ“„', label: 'Dockerfile', value: f, click: `openFileInEditor('${esc(f)}','edit')` })),
                        ...(data.has_compose ? [{ icon: 'ğŸ“‹', label: 'Compose', value: data.compose_file || 'docker-compose.yml', click: `openFileInEditor('${esc(data.compose_file||'docker-compose.yml')}','edit')` }] : []),
                    ]);
                }
                html += cardGenerateToolbar([
                    { label: 'Dockerfile', icon: 'ğŸ“„', onclick: "_intDockerGenerate('dockerfile')" },
                    { label: '.dockerignore', icon: 'ğŸš«', onclick: "_intDockerGenerate('dockerignore')" },
                    { label: 'Compose', icon: 'ğŸ“‹', onclick: "_intDockerGenerate('compose')" },
                ]);
                detail.innerHTML = html;
                renderMissingTools(data.missing_tools, 'docker-missing-tools');
                return;
            }

            // â”€â”€ Daemon not running â”€â”€
            if (!data.daemon_running) {
                badge.className = 'status-badge degraded';
                badge.innerHTML = '<span class="status-dot"></span>Daemon off';
                let html = cardStatusGrid([
                    { label: 'CLI', value: data.version || 'installed', cls: 'ok' },
                    { label: 'Daemon', value: 'Stopped', cls: 'warn' },
                ]);
                html += `<div style="margin-top:var(--space-sm);font-size:0.82rem;color:var(--warning)">` +
                    `âš  Start Docker Desktop or <code style="font-family:var(--font-mono);background:var(--bg-inset);padding:1px 6px;border-radius:4px">sudo systemctl start docker</code></div>`;
                const hasFiles = (data.dockerfiles && data.dockerfiles.length) || data.has_compose;
                if (hasFiles) {
                    html += cardDetectionList([
                        ...(data.dockerfiles||[]).map(f => ({ icon: 'ğŸ“„', label: 'Dockerfile', value: f, click: `openFileInEditor('${esc(f)}','edit')` })),
                        ...(data.has_compose ? [{ icon: 'ğŸ“‹', label: 'Compose', value: data.compose_file || 'docker-compose.yml', click: `openFileInEditor('${esc(data.compose_file||'docker-compose.yml')}','edit')` }] : []),
                    ]);
                }
                const genItems = [];
                if (!data.has_dockerfile) genItems.push({ label: 'Dockerfile', icon: 'ğŸ“„', onclick: "_intDockerGenerate('dockerfile')" });
                genItems.push({ label: '.dockerignore', icon: 'ğŸš«', onclick: "_intDockerGenerate('dockerignore')" });
                if (!data.has_compose) genItems.push({ label: 'Compose', icon: 'ğŸ“‹', onclick: "_intDockerGenerate('compose')" });
                html += cardGenerateToolbar(genItems);
                detail.innerHTML = html;
                return;
            }

            // â”€â”€ Daemon running â€” full card â”€â”€
            badge.className = 'status-badge ok';
            if (data.compose_available && data.has_compose) {
                const sc = (data.compose_services || []).length;
                badge.innerHTML = `<span class="status-dot"></span>${sc} service${sc !== 1 ? 's' : ''}`;
            } else if (data.has_dockerfile) {
                badge.innerHTML = '<span class="status-dot"></span>Ready';
            } else {
                badge.className = 'status-badge degraded';
                badge.innerHTML = '<span class="status-dot"></span>No config';
            }

            // Dependency hints
            let html = '';
            html += cardDepHint('git', 'Git', 'Set up Git first to version-control your Docker config.', 'git');
            const stats = [
                { label: 'Docker', value: (data.version || '').replace('Docker version ', '').split(',')[0], cls: 'ok' },
            ];
            if (data.compose_available) stats.push({ label: 'Compose', value: data.compose_version || 'âœ“', cls: 'ok' });
            if (data.compose_services && data.compose_services.length > 0) {
                stats.push({ label: 'Services', value: String(data.compose_services.length) });
            }
            html += cardStatusGrid(stats);

            // Detection list (files + parsed Dockerfile info)
            const detections = [];
            const dfDetails = data.dockerfile_details || [];
            (data.dockerfiles||[]).forEach((f, i) => {
                const detail = dfDetails[i];
                let desc = f;
                if (detail) {
                    const parts = [];
                    if (detail.base_images && detail.base_images.length) {
                        // Show unique base images
                        const unique = [...new Set(detail.base_images)];
                        parts.push(unique.join(', '));
                    }
                    if (detail.stage_count > 1) parts.push(`${detail.stage_count}-stage`);
                    if (detail.ports && detail.ports.length) parts.push(`ports: ${detail.ports.join(', ')}`);
                    if (parts.length) desc = `${f}  Â·  ${parts.join(' Â· ')}`;
                }
                detections.push({ icon: 'ğŸ“„', label: 'Dockerfile', value: desc, click: `openFileInEditor('${esc(f)}','edit')` });
                // Show warnings for malformed Dockerfiles
                if (detail && detail.warnings && detail.warnings.length) {
                    detail.warnings.forEach(w => {
                        detections.push({ icon: 'âš ï¸', label: 'Warning', value: w, cls: 'warning' });
                    });
                }
            });
            if (data.has_compose) detections.push({ icon: 'ğŸ“‹', label: 'Compose', value: data.compose_file || 'docker-compose.yml', click: `openFileInEditor('${esc(data.compose_file||'docker-compose.yml')}','edit')` });
            if (data.compose_warnings && data.compose_warnings.length) {
                data.compose_warnings.forEach(w => {
                    detections.push({ icon: 'âš ï¸', label: 'Compose Warning', value: w, cls: 'warning' });
                });
            }
            if (data.has_dockerignore) {
                const patCount = (data.dockerignore_patterns || []).length;
                detections.push({ icon: 'ğŸš«', label: '.dockerignore', value: `${patCount} pattern${patCount !== 1 ? 's' : ''}`, click: `openFileInEditor('.dockerignore','edit')` });
            }
            if (detections.length) html += cardDetectionList(detections);

            // Live panel
            const liveTabs = [
                { key: 'containers', label: 'ğŸ“¦ Containers' },
                { key: 'images', label: 'ğŸ–¼ Images' },
            ];
            if (data.has_compose) liveTabs.push({ key: 'compose', label: 'ğŸ“‹ Services' });
            liveTabs.push({ key: 'stats', label: 'ğŸ“Š Stats' });
            if (data.compose_services && data.compose_services.length > 0) liveTabs.push({ key: 'logs', label: 'ğŸ“œ Logs' });
            liveTabs.push({ key: 'networks', label: 'ğŸŒ Networks' });
            liveTabs.push({ key: 'volumes', label: 'ğŸ’¾ Volumes' });
            html += cardLivePanel('int-docker-live', liveTabs, '_dockerLiveTab');

            // Actions
            if (data.has_compose) {
                html += cardActionToolbar([
                    { label: 'Start', icon: 'â–¶', onclick: "_intDockerAction('up', this)", cls: 'btn-primary' },
                    { label: 'Stop', icon: 'â¹', onclick: "_intDockerAction('down', this)" },
                    { label: 'Restart', icon: 'ğŸ”„', onclick: "_intDockerAction('restart', this)" },
                    { label: 'Build', icon: 'ğŸ”¨', onclick: "_intDockerAction('build', this)" },
                    { label: 'No-cache', icon: 'ğŸ”¨', onclick: "_intDockerAction('build-nc', this)", cls: 'btn-ghost' },
                    { label: 'Prune', icon: 'ğŸ§¹', onclick: "_intDockerAction('prune', this)", cls: 'btn-ghost' },
                    { label: 'Pull', icon: 'â¬‡ï¸', onclick: '_dockerPullModal()', cls: 'btn-ghost' },
                    { label: 'Exec', icon: 'ğŸ’»', onclick: '_dockerExecModal()', cls: 'btn-ghost' },
                ]);
                html += `<div id="int-docker-action-output" style="display:none;margin-top:var(--space-sm);background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.4rem 0.5rem;font-size:0.72rem;max-height:200px;overflow:auto;font-family:var(--font-mono,monospace);white-space:pre-wrap"></div>`;
            } else if (data.has_dockerfile) {
                html += `<div style="margin-top:var(--space-sm);font-size:0.78rem;color:var(--text-muted)">â„¹ Create a <code>docker-compose.yml</code> to unlock Start/Stop/Build controls.</div>`;
            }

            // Generate â€” always show all options (user may want to regenerate)
            html += cardGenerateToolbar([
                { label: 'Dockerfile', icon: 'ğŸ“„', onclick: "_intDockerGenerate('dockerfile')" },
                { label: '.dockerignore', icon: 'ğŸš«', onclick: "_intDockerGenerate('dockerignore')" },
                { label: 'docker-compose.yml', icon: 'ğŸ“‹', onclick: "openSetupWizard('docker')" },
            ]);

            // Cross-tab link
            html += cardCrossLink('devops', 'View Docker ops in DevOps');

            detail.innerHTML = html;

        } catch (e) {
            badge.className = 'status-badge failed';
            badge.innerHTML = '<span class="status-dot"></span>Error';
            detail.innerHTML = `<p class="empty-state-sm" style="color:var(--error)">${esc(e.message)}</p>`;
        }
    }

    // â”€â”€ Docker: live tab handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function _dockerLiveTab(what, panelId) {
        const panel = document.getElementById(panelId);
        if (!panel) return;
        panel.innerHTML = '<span class="spinner"></span> Loadingâ€¦';

        try {
            if (what === 'containers') {
                const data = await api('/docker/containers?all=true');
                const list = data.containers || [];
                if (list.length === 0) { panel.innerHTML = '<span style="color:var(--text-muted)">No containers found.</span>'; return; }
                panel.innerHTML = cardDataTable(
                    ['', 'Name', 'Status', 'Image'],
                    list.map(c => [
                        { text: 'â—', cls: c.state === 'running' ? 'ok' : 'muted' },
                        { text: c.name || c.names || 'â€”', cls: 'name' },
                        { text: c.status || c.state || 'â€”' },
                        { text: c.image || 'â€”' },
                    ])
                );
            } else if (what === 'images') {
                const data = await api('/docker/images');
                const list = data.images || [];
                if (list.length === 0) { panel.innerHTML = '<span style="color:var(--text-muted)">No images found.</span>'; return; }
                panel.innerHTML = cardDataTable(
                    ['Repository', 'Tag', 'Size'],
                    list.map(img => [
                        { text: img.repository || 'â€”', cls: 'name' },
                        { text: img.tag || 'â€”' },
                        { text: img.size || 'â€”' },
                    ])
                );
            } else if (what === 'compose') {
                const data = await api('/docker/compose/status');
                const services = data.services || [];
                if (data.error) { panel.innerHTML = `<span style="color:var(--error)">${esc(data.error)}</span>`; return; }
                if (services.length === 0) { panel.innerHTML = '<span style="color:var(--text-muted)">No compose services found.</span>'; return; }
                panel.innerHTML = cardDataTable(
                    ['', 'Service', 'State', 'Ports'],
                    services.map(s => [
                        { text: 'â—', cls: s.state === 'running' ? 'ok' : 'muted' },
                        { text: s.name || s.service || 'â€”', cls: 'name' },
                        { text: s.state || s.status || 'â€”' },
                        { text: s.ports || s.publishers || 'â€”' },
                    ])
                );
            } else if (what === 'stats') {
                const data = await api('/docker/stats');
                const stats = data.stats || data.containers || [];
                if (stats.length === 0) { panel.innerHTML = '<span style="color:var(--text-muted)">No running containers for stats.</span>'; return; }
                panel.innerHTML = cardDataTable(
                    ['Name', 'CPU', 'Mem', 'Net I/O'],
                    stats.map(s => [
                        { text: s.name || s.container || 'â€”', cls: 'name' },
                        { text: s.cpu_percent || s.cpu || 'â€”', cls: 'accent' },
                        { text: s.mem_usage || s.memory || 'â€”' },
                        { text: s.net_io || s.network || 'â€”' },
                    ])
                );
            } else if (what === 'logs') {
                const statusData = cardCached('docker') || {};
                const services = statusData.compose_services || [];
                if (services.length === 0) { panel.innerHTML = '<span style="color:var(--text-muted)">No compose services available for logs.</span>'; return; }
                panel.innerHTML = `
                    <div style="display:flex;align-items:center;gap:0.4rem;margin-bottom:0.4rem">
                        <label style="font-size:0.72rem;font-weight:600;color:var(--text-muted)">Service:</label>
                        <select id="int-docker-log-svc" style="font-size:0.72rem;padding:0.15rem 0.3rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-inset);color:var(--text-primary);font-family:var(--font-mono)">
                            ${services.map(s => `<option value="${esc(s)}">${esc(s)}</option>`).join('')}
                        </select>
                        <select id="int-docker-log-tail" style="font-size:0.72rem;padding:0.15rem 0.3rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-inset);color:var(--text-primary)">
                            <option value="50">50 lines</option>
                            <option value="100" selected>100 lines</option>
                            <option value="250">250 lines</option>
                            <option value="500">500 lines</option>
                        </select>
                        <button class="btn btn-sm btn-ghost" onclick="_intDockerFetchLogs()" style="font-size:0.72rem;padding:0.15rem 0.4rem">ğŸ“œ Fetch</button>
                    </div>
                    <div id="int-docker-log-output" style="white-space:pre-wrap;max-height:180px;overflow:auto;color:var(--text-muted);font-size:0.68rem">Select a service and click Fetch.</div>`;
            } else if (what === 'networks') {
                const data = await api('/docker/networks');
                const list = data.networks || [];
                if (list.length === 0) { panel.innerHTML = '<span style="color:var(--text-muted)">No networks found.</span>'; return; }
                panel.innerHTML = cardDataTable(
                    ['Name', 'Driver', 'Scope'],
                    list.map(n => [
                        { text: n.name || 'â€”', cls: 'name' },
                        { text: n.driver || 'â€”' },
                        { text: n.scope || 'â€”' },
                    ])
                );
            } else if (what === 'volumes') {
                const data = await api('/docker/volumes');
                const list = data.volumes || [];
                if (list.length === 0) { panel.innerHTML = '<span style="color:var(--text-muted)">No volumes found.</span>'; return; }
                panel.innerHTML = cardDataTable(
                    ['Name', 'Driver'],
                    list.map(v => [
                        { text: v.name || 'â€”', cls: 'name' },
                        { text: v.driver || 'â€”' },
                    ])
                );
            }
        } catch (e) {
            panel.innerHTML = `<span style="color:var(--error)">${esc(e.message)}</span>`;
        }
    }

    // â”€â”€ Docker: fetch logs for selected service â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function _intDockerFetchLogs() {
        const svcEl = document.getElementById('int-docker-log-svc');
        const tailEl = document.getElementById('int-docker-log-tail');
        const output = document.getElementById('int-docker-log-output');
        if (!svcEl || !output) return;

        const svc = svcEl.value;
        const tail = tailEl ? tailEl.value : '100';
        output.innerHTML = '<span class="spinner"></span> Loading logsâ€¦';

        try {
            const data = await api(`/docker/logs?service=${encodeURIComponent(svc)}&tail=${tail}`);
            if (data.error) {
                output.innerHTML = `<span style="color:var(--error)">${esc(data.error)}</span>`;
            } else {
                const logs = data.logs || data.output || '';
                output.textContent = logs || '(no output)';
                output.scrollTop = output.scrollHeight;
            }
        } catch (e) {
            output.innerHTML = `<span style="color:var(--error)">Error: ${esc(e.message)}</span>`;
        }
    }

    // â”€â”€ Docker: inspect container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function _intDockerInspect(containerId) {
        modalOpen({
            title: 'ğŸ” Container Detail',
            body: '<span class="spinner"></span> Loadingâ€¦',
            footerButtons: [{ label: 'Close', cls: 'btn-secondary', onclick: 'modalClose()' }],
        });

        try {
            const data = await api(`/docker/inspect?id=${encodeURIComponent(containerId)}`);
            const d = data.detail || {};
            const state = d.state || {};
            const body = document.querySelector('.modal-body');
            if (!body) return;
            body.innerHTML = `
            <div style="font-size:0.82rem;line-height:1.7">
                <div><strong>Name:</strong> ${esc(d.name || 'â€”')}</div>
                <div><strong>Image:</strong> <code>${esc(d.image || 'â€”')}</code></div>
                <div><strong>State:</strong> <span style="color:${state.Running ? 'var(--success)' : 'var(--text-muted)'}">${esc(state.Status || 'â€”')}</span></div>
                <div><strong>Created:</strong> ${esc(d.created || 'â€”')}</div>
                <div><strong>Platform:</strong> ${esc(d.platform || 'â€”')}</div>
                <div><strong>Restart Policy:</strong> ${esc((d.restart_policy||{}).Name || 'no')}</div>
                <div style="margin-top:var(--space-sm)"><strong>CMD:</strong> <code>${esc((d.cmd||[]).join(' ') || 'â€”')}</code></div>
                ${(d.mounts||[]).length ? `<div style="margin-top:var(--space-sm)"><strong>Mounts:</strong> ${d.mounts.map(m=>`<div style="font-size:0.72rem;color:var(--text-muted);margin-left:0.5rem">${esc(m.source)} â†’ ${esc(m.destination)} ${m.mode?'('+esc(m.mode)+')':''}</div>`).join('')}</div>` : ''}
                ${Object.keys(d.ports||{}).length ? `<div style="margin-top:var(--space-sm)"><strong>Ports:</strong> <code style="font-size:0.72rem">${esc(JSON.stringify(d.ports))}</code></div>` : ''}
            </div>`;
        } catch (e) {
            const body = document.querySelector('.modal-body');
            if (body) body.innerHTML = `<span style="color:var(--error)">${esc(e.message)}</span>`;
        }
    }

    // â”€â”€ Docker: pull image modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function _dockerPullModal() {
        modalOpen({
            title: 'â¬‡ï¸ Pull Docker Image',
            body: modalFormField({name: 'docker-pull-img', label: 'Image name', type: 'text', value: 'nginx:latest', placeholder: 'e.g. nginx:latest'}) +
                  `<div id="docker-pull-out" style="display:none;margin-top:var(--space-sm);max-height:120px;overflow:auto;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.4rem;font-size:0.72rem;font-family:var(--font-mono);white-space:pre-wrap"></div>`,
            footerButtons: [
                { label: 'Cancel', cls: 'btn-secondary', onclick: 'modalClose()' },
                { label: 'â¬‡ï¸ Pull', cls: 'btn-primary', onclick: '_dockerPullExec()' },
            ],
        });
    }

    async function _dockerPullExec() {
        const imageInput = document.getElementById('mf-docker-pull-img');
        const output = document.getElementById('docker-pull-out');
        if (!imageInput || !output) return;
        const image = imageInput.value.trim();
        if (!image) { toast('Enter an image name', 'warning'); return; }
        output.style.display = 'block';
        output.innerHTML = '<span class="spinner"></span> Pullingâ€¦';
        try {
            const data = await apiPost('/docker/pull', {image});
            if (data.error) { output.innerHTML = `<span style="color:var(--error)">${esc(data.error)}</span>`; }
            else { output.textContent = data.output || 'Pull complete'; toast(`Pulled ${image}`, 'success'); }
        } catch (e) { output.innerHTML = `<span style="color:var(--error)">${esc(e.message)}</span>`; }
    }

    // â”€â”€ Docker: exec modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function _dockerExecModal() {
        // Fetch running containers for dropdown
        let containerOpts = '<option value="">Loadingâ€¦</option>';
        try {
            const cdata = await api('/docker/containers?all=false');
            const running = (cdata.containers || []).filter(c => c.state === 'running');
            if (running.length === 0) { containerOpts = '<option value="">No running containers</option>'; }
            else { containerOpts = running.map(c => `<option value="${esc(c.name||c.id)}">${esc(c.name||c.id)}</option>`).join(''); }
        } catch(e) { containerOpts = `<option value="">Error: ${esc(e.message)}</option>`; }

        modalOpen({
            title: 'ğŸ’» Execute Command',
            body: `<div style="display:flex;gap:0.5rem;align-items:center;margin-bottom:var(--space-sm)">` +
                `<label style="font-size:0.82rem;white-space:nowrap">Container:</label>` +
                `<select id="docker-exec-ctr" style="flex:1;padding:0.3rem;border-radius:4px;border:1px solid var(--border-subtle);background:var(--bg-inset);color:var(--text-primary);font-family:var(--font-mono);font-size:0.78rem">${containerOpts}</select></div>` +
                modalFormField({name: 'docker-exec-cmd', label: 'Command', type: 'text', placeholder: 'ls -la /app'}) +
                `<pre id="docker-exec-out" style="display:none;max-height:200px;overflow:auto;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;padding:0.4rem;font-size:0.72rem;white-space:pre-wrap;font-family:var(--font-mono)"></pre>`,
            footerButtons: [
                { label: 'Close', cls: 'btn-secondary', onclick: 'modalClose()' },
                { label: 'â–¶ Run', cls: 'btn-primary', onclick: '_dockerExecRun()' },
            ],
        });
    }

    async function _dockerExecRun() {
        const container = document.getElementById('docker-exec-ctr')?.value;
        const command = document.getElementById('mf-docker-exec-cmd')?.value?.trim();
        const output = document.getElementById('docker-exec-out');
        if (!container || !command || !output) { toast('Select container and enter command', 'warning'); return; }
        output.style.display = 'block';
        output.innerHTML = '<span class="spinner"></span> Runningâ€¦';
        try {
            const data = await apiPost('/docker/exec', {container, command});
            output.textContent = data.output || data.stderr || '(no output)';
            if (!data.ok) output.style.color = 'var(--error)';
            else output.style.color = 'var(--text-primary)';
        } catch (e) { output.innerHTML = `<span style="color:var(--error)">${esc(e.message)}</span>`; }
    }

    // â”€â”€ Docker: remove container / image actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function _intDockerRm(containerId, force) {
        if (!confirm(`Remove container ${containerId}?`)) return;
        try {
            const data = await apiPost('/docker/rm', {container: containerId, force: !!force});
            if (data.error) toast(data.error, 'error');
            else { toast(`Removed ${containerId}`, 'success'); _dockerLiveTab('containers','int-docker-live'); }
        } catch (e) { toast(e.message, 'error'); }
    }

    async function _intDockerRmi(imageRef, force) {
        if (!confirm(`Remove image ${imageRef}?`)) return;
        try {
            const data = await apiPost('/docker/rmi', {image: imageRef, force: !!force});
            if (data.error) toast(data.error, 'error');
            else { toast(`Removed ${imageRef}`, 'success'); _dockerLiveTab('images','int-docker-live'); }
        } catch (e) { toast(e.message, 'error'); }
    }

    // â”€â”€ Docker: generate modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function _intDockerGenerate(what) {
        if (what === 'dockerfile') {
            modalOpen({
                title: 'ğŸ“„ Generate Dockerfile',
                body: `<p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:var(--space-sm)">Select a stack to generate a Dockerfile for:</p>` +
                      `<div id="dg-stacks" style="margin-bottom:var(--space-md)"><span class="spinner"></span> Loading stacksâ€¦</div>` +
                      `<div id="dg-preview-wrap" style="display:none;margin-bottom:var(--space-md)">` +
                      modalPreview('Preview', '', 'dg-preview-code') + `</div>`,
                footerButtons: [
                    { label: 'Cancel', cls: 'btn-secondary', onclick: 'modalClose()' },
                    { label: 'ğŸ’¾ Write to disk', cls: 'btn-primary', id: 'dg-write', disabled: true, onclick: '_dockerWriteGen()', style: 'display:none' },
                ],
            });

            try {
                const stacks = await api('/stacks');
                const names = Object.keys(stacks);
                const container = document.getElementById('dg-stacks');
                if (!container) return;
                if (names.length === 0) { container.innerHTML = '<span style="color:var(--text-muted)">No stacks detected.</span>'; return; }
                container.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:0.3rem">${names.map(n =>
                    `<button class="btn btn-sm btn-ghost" onclick="_dockerGenDockerfile('${esc(n)}')" style="font-size:0.72rem;padding:0.15rem 0.5rem;font-family:var(--font-mono)">${esc(n)}</button>`
                ).join('')}</div>`;
            } catch (e) {
                const c = document.getElementById('dg-stacks');
                if (c) c.innerHTML = `<span style="color:var(--error)">${esc(e.message)}</span>`;
            }

        } else if (what === 'dockerignore') {
            modalOpen({
                title: 'ğŸš« Generate .dockerignore',
                body: `<p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:var(--space-sm)">Generating .dockerignore from detected stacksâ€¦</p>` +
                      modalPreview('Preview', 'Generatingâ€¦', 'dg-preview-code'),
                footerButtons: [
                    { label: 'Cancel', cls: 'btn-secondary', onclick: 'modalClose()' },
                    { label: 'ğŸ’¾ Write to disk', cls: 'btn-primary', id: 'dg-write', disabled: true, onclick: '_dockerWriteGen()' },
                ],
            });

            try {
                const stacks = await api('/stacks');
                const names = Object.keys(stacks);
                const data = await api('/docker/generate/dockerignore', { method: 'POST', body: JSON.stringify({ stacks: names }) });
                const preview = document.getElementById('dg-preview-code');
                const writeBtn = document.getElementById('dg-write');
                if (data.file) {
                    if (preview) preview.textContent = data.file.content || '(empty)';
                    if (writeBtn) { writeBtn.disabled = false; writeBtn.dataset.file = JSON.stringify(data.file); }
                } else {
                    if (preview) preview.textContent = data.error || 'No content generated.';
                }
            } catch (e) {
                const c = document.getElementById('dg-preview-code');
                if (c) c.textContent = 'Error: ' + e.message;
            }
        }
    }

