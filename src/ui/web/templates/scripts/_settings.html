<script>
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //  _settings.html
    //  User preferences: UI scale, density, theme, preview mode
    //  Persisted in localStorage('dcp_prefs') as JSON
    //  Included by: dashboard.html (Jinja2 include)
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    // â”€â”€ Default preferences â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _PREFS_KEY = 'dcp_prefs';
    const _PREFS_DEFAULTS = {
        theme: 'dark',
        uiScale: 'default',      // compact | default | comfortable | large
        density: 'normal',       // dense | normal | spacious
        previewMode: 'modal',    // modal | forward
        assistantGuide: true,    // assistant side panel
        sshPassphrasePrompt: 'always',  // 'always' | 'on-demand'
    };

    // â”€â”€ Scale profiles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _SCALE_PROFILES = {
        compact:     { label: 'Compact',     rootPx: 12.75, icon: 'ğŸ”' },
        default:     { label: 'Default',     rootPx: 15,    icon: 'ğŸ“' },
        comfortable: { label: 'Comfortable', rootPx: 16.5,  icon: 'ğŸ‘“' },
        large:       { label: 'Large',       rootPx: 18.75, icon: 'ğŸ”' },
    };

    // â”€â”€ Density profiles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _DENSITY_PROFILES = {
        dense:   { label: 'Dense',   xs: '0.15rem', sm: '0.3rem',  md: '0.7rem',  lg: '1rem',   xl: '1.4rem', xxl: '2rem'   },
        normal:  { label: 'Normal',  xs: '0.25rem', sm: '0.5rem',  md: '1rem',    lg: '1.5rem', xl: '2rem',   xxl: '3rem'   },
        spacious:{ label: 'Spacious',xs: '0.35rem', sm: '0.65rem', md: '1.25rem', lg: '1.85rem',xl: '2.5rem', xxl: '3.5rem' },
    };

    // â”€â”€ Preference helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function prefsLoad() {
        try {
            const raw = localStorage.getItem(_PREFS_KEY);
            if (raw) return { ..._PREFS_DEFAULTS, ...JSON.parse(raw) };
        } catch (_) {}
        return { ..._PREFS_DEFAULTS };
    }

    function prefsSave(prefs) {
        localStorage.setItem(_PREFS_KEY, JSON.stringify(prefs));
    }

    function prefsGet(key) {
        return prefsLoad()[key] ?? _PREFS_DEFAULTS[key];
    }

    function prefsSet(key, value) {
        const prefs = prefsLoad();
        prefs[key] = value;
        prefsSave(prefs);
    }

    // â”€â”€ Apply functions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function applyTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        const btn = document.getElementById('theme-toggle');
        if (btn) btn.textContent = theme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™';
    }

    function applyScale(profileKey) {
        const profile = _SCALE_PROFILES[profileKey] || _SCALE_PROFILES.default;
        document.documentElement.style.fontSize = profile.rootPx + 'px';
    }

    function applyDensity(profileKey) {
        const profile = _DENSITY_PROFILES[profileKey] || _DENSITY_PROFILES.normal;
        const root = document.documentElement.style;
        root.setProperty('--space-xs',  profile.xs);
        root.setProperty('--space-sm',  profile.sm);
        root.setProperty('--space-md',  profile.md);
        root.setProperty('--space-lg',  profile.lg);
        root.setProperty('--space-xl',  profile.xl);
        root.setProperty('--space-2xl', profile.xxl);
    }

    function applyAllPrefs() {
        const prefs = prefsLoad();
        applyTheme(prefs.theme);
        applyScale(prefs.uiScale);
        applyDensity(prefs.density);
    }

    // â”€â”€ Settings panel toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function toggleSettingsPanel() {
        const panel = document.getElementById('settings-panel');
        if (!panel) return;
        const isOpen = panel.classList.contains('open');
        if (isOpen) {
            panel.classList.remove('open');
        } else {
            _renderSettingsPanel();
            panel.classList.add('open');
        }
    }

    function _renderSettingsPanel() {
        const body = document.getElementById('settings-panel-body');
        if (!body) return;
        const prefs = prefsLoad();

        let html = '';

        // â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `<div class="settings-group">
            <div class="settings-label">Theme</div>
            <div class="settings-btn-group">
                <button class="settings-btn ${prefs.theme === 'dark' ? 'active' : ''}"
                    onclick="_prefSetTheme('dark')">ğŸŒ™ Dark</button>
                <button class="settings-btn ${prefs.theme === 'light' ? 'active' : ''}"
                    onclick="_prefSetTheme('light')">â˜€ï¸ Light</button>
            </div>
        </div>`;

        // â”€â”€ UI Scale â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `<div class="settings-group">
            <div class="settings-label">UI Scale</div>
            <div class="settings-btn-group">`;
        for (const [key, prof] of Object.entries(_SCALE_PROFILES)) {
            html += `<button class="settings-btn ${prefs.uiScale === key ? 'active' : ''}"
                onclick="_prefSetScale('${key}')" title="${prof.rootPx}px root">${prof.icon} ${prof.label}</button>`;
        }
        html += `</div></div>`;

        // â”€â”€ Density â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `<div class="settings-group">
            <div class="settings-label">Density</div>
            <div class="settings-btn-group">`;
        for (const [key, prof] of Object.entries(_DENSITY_PROFILES)) {
            const icons = { dense: 'â–ªï¸', normal: 'â—¾', spacious: 'â¬›' };
            html += `<button class="settings-btn ${prefs.density === key ? 'active' : ''}"
                onclick="_prefSetDensity('${key}')">${icons[key] || 'â—¾'} ${prof.label}</button>`;
        }
        html += `</div></div>`;

        // â”€â”€ Preview Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `<div class="settings-group">
            <div class="settings-label">File Preview</div>
            <div class="settings-hint">When clicking files from other tabs</div>
            <div class="settings-btn-group">
                <button class="settings-btn ${prefs.previewMode === 'modal' ? 'active' : ''}"
                    onclick="_prefSetPreviewMode('modal')">ğŸ” Modal</button>
                <button class="settings-btn ${prefs.previewMode === 'forward' ? 'active' : ''}"
                    onclick="_prefSetPreviewMode('forward')">â¡ï¸ Navigate</button>
            </div>
        </div>`;

        // â”€â”€ Assistant Guide â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        html += `<div class="settings-group">
            <div class="settings-label">Assistant Guide</div>
            <div class="settings-hint">Context-aware help panel alongside the wizard</div>
            <div class="settings-btn-group">
                <button class="settings-btn ${prefs.assistantGuide ? 'active' : ''}"
                    onclick="_prefSetAssistantGuide(true)">âœ¨ On</button>
                <button class="settings-btn ${!prefs.assistantGuide ? 'active' : ''}"
                    onclick="_prefSetAssistantGuide(false)">Off</button>
            </div>
        </div>`;

        // â”€â”€ SSH Passphrase Prompt (only for SSH secure mode) â”€â”€â”€â”€â”€
        // Show this toggle only when the user is in SSH mode with
        // a passphrase-protected key.  Otherwise it's irrelevant.
        const sshSecure = typeof _gitAuthStatus !== 'undefined'
            && _gitAuthStatus
            && _gitAuthStatus.remote_type === 'ssh'
            && (_gitAuthStatus.needs === 'ssh_passphrase' || _gitAuthStatus.ssh_key);

        if (sshSecure) {
            const p = prefs.sshPassphrasePrompt || 'always';
            html += `<div class="settings-group">
                <div class="settings-label">ğŸ”’ SSH Passphrase Prompt</div>
                <div class="settings-hint">When to ask for your SSH key passphrase</div>
                <div class="settings-btn-group">
                    <button class="settings-btn ${p === 'always' ? 'active' : ''}"
                        onclick="_prefSetSshPrompt('always')">ğŸš€ On Startup</button>
                    <button class="settings-btn ${p === 'on-demand' ? 'active' : ''}"
                        onclick="_prefSetSshPrompt('on-demand')">ğŸ“‹ On Demand</button>
                </div>
            </div>`;
        }

        body.innerHTML = html;
    }

    // â”€â”€ Preference setters (called by settings UI) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function _prefSetTheme(theme) {
        prefsSet('theme', theme);
        applyTheme(theme);
        _renderSettingsPanel();
    }

    function _prefSetScale(scale) {
        prefsSet('uiScale', scale);
        applyScale(scale);
        _renderSettingsPanel();
    }

    function _prefSetDensity(density) {
        prefsSet('density', density);
        applyDensity(density);
        _renderSettingsPanel();
    }

    function _prefSetPreviewMode(mode) {
        prefsSet('previewMode', mode);
        _renderSettingsPanel();
    }

    function _prefSetAssistantGuide(enabled) {
        prefsSet('assistantGuide', enabled);
        if (window._assistant) {
            enabled ? window._assistant.enable() : window._assistant.disable();
        }
        _renderSettingsPanel();
    }

    function _prefSetSshPrompt(mode) {
        prefsSet('sshPassphrasePrompt', mode);
        _renderSettingsPanel();
    }

    // â”€â”€ Migration from legacy localStorage('theme') â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    (function _migrateTheme() {
        const legacy = localStorage.getItem('theme');
        if (legacy && !localStorage.getItem(_PREFS_KEY)) {
            const prefs = { ..._PREFS_DEFAULTS, theme: legacy };
            prefsSave(prefs);
            localStorage.removeItem('theme');
        }
    })();

    // â”€â”€ Apply on load (immediate â€” before DOMContentLoaded) â”€â”€â”€â”€â”€
    applyAllPrefs();

    // â”€â”€ Close panel on outside click â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // NOTE: We cannot use panel.contains(e.target) because
    // _renderSettingsPanel() replaces innerHTML, destroying the clicked
    // button before this handler runs. Instead we stop propagation from
    // inside the panel so the document handler never fires for those clicks.
    document.addEventListener('click', (e) => {
        const panel = document.getElementById('settings-panel');
        const gear = document.getElementById('settings-gear');
        if (!panel || !gear) return;
        // If the click was on the gear icon itself (toggle), let toggleSettingsPanel handle it
        if (gear === e.target || gear.contains(e.target)) {
            // Exclude clicks on the panel itself (it's nested inside gear)
            if (panel.contains(e.target)) return;
            return;
        }
        panel.classList.remove('open');
    });

    // Stop propagation for clicks inside the settings panel so they
    // don't reach the outside-click handler above.
    document.addEventListener('DOMContentLoaded', () => {
        const panel = document.getElementById('settings-panel');
        if (panel) {
            panel.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
    });
</script>
