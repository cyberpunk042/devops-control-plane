/* Wizard JS ‚Äî Step Renderers
     renderStep() with all 6 steps: Welcome, Modules, Secrets, Content, Integrations, Review.
     Depends on: _wizard_init.html (state), _wizard_helpers.html (helper functions)
*/
    // ‚îÄ‚îÄ Step renderers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    const _wizardRenderers = {

        // ‚îÄ‚îÄ Step 1: Welcome ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        welcome: async (body) => {
            const cfg = _wizardConfig || await wizardLoadConfig();
            if (!cfg) {
                body.innerHTML = '<p class="empty-state" style="color:var(--error)">‚ùå Could not load config.</p>';
                return;
            }

            body.innerHTML = `
                <h2 style="margin-bottom:1rem">üëã Project Configuration</h2>
                <p style="color:var(--text-secondary);line-height:1.6;margin-bottom:1.5rem">
                    Configure your project's identity. These settings are stored in <code>project.yml</code>.
                </p>

                <div style="display:flex;flex-direction:column;gap:1rem">
                    <div>
                        <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:0.3rem;color:var(--text-secondary)">
                            Project Name <span style="color:var(--error)">*</span>
                        </label>
                        <input type="text" id="wiz-name" value="${esc(cfg.name)}"
                            placeholder="my-awesome-project"
                            style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);color:var(--text-primary);font-size:0.9rem"
                            oninput="wizardDirty=true">
                    </div>

                    <div>
                        <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:0.3rem;color:var(--text-secondary)">
                            Description
                        </label>
                        <textarea id="wiz-desc" rows="2"
                            placeholder="A brief description of the project"
                            style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);color:var(--text-primary);font-size:0.9rem;resize:vertical"
                            oninput="wizardDirty=true">${esc(cfg.description)}</textarea>
                    </div>

                    <div>
                        <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:0.3rem;color:var(--text-secondary)">
                            Repository
                        </label>
                        <input type="text" id="wiz-repo" value="${esc(cfg.repository)}"
                            placeholder="github.com/user/project"
                            style="width:100%;padding:0.5rem 0.75rem;border:1px solid var(--border-subtle);border-radius:8px;background:var(--bg-inset);color:var(--text-primary);font-size:0.9rem;font-family:var(--font-mono)"
                            oninput="wizardDirty=true">
                    </div>

                    <div>
                        <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:0.3rem;color:var(--text-secondary)">
                            Domains
                        </label>
                        <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.4rem">
                            Logical groupings for your modules (e.g. library, ops, docs).
                        </p>
                        <div id="wiz-domains" style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:0.5rem">
                            ${(cfg.domains || []).map(d => `
                                <span style="display:inline-flex;align-items:center;gap:0.3rem;padding:0.25rem 0.6rem;background:var(--accent-glow);border:1px solid var(--accent);border-radius:16px;font-size:0.8rem;color:var(--accent)">
                                    ${esc(d)}
                                    <span style="cursor:pointer;opacity:0.6;font-size:0.7rem" onclick="wizardRemoveDomain(this,'${esc(d)}')" title="Remove">‚úï</span>
                                </span>
                            `).join('')}
                        </div>
                        <div style="display:flex;gap:0.4rem">
                            <input type="text" id="wiz-new-domain" placeholder="Add domain‚Ä¶"
                                style="flex:1;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-inset);color:var(--text-primary);font-size:0.82rem"
                                onkeydown="if(event.key==='Enter'){event.preventDefault();wizardAddDomain()}">
                            <button class="btn btn-secondary btn-sm" onclick="wizardAddDomain()" style="font-size:0.78rem">+ Add</button>
                        </div>
                    </div>

                    <div>
                        <label style="font-size:0.85rem;font-weight:600;display:block;margin-bottom:0.3rem;color:var(--text-secondary)">
                            Environments
                        </label>
                        <p style="font-size:0.78rem;color:var(--text-muted);margin-bottom:0.4rem">
                            Deployment contexts (dev, staging, production).
                        </p>
                        <div id="wiz-envs" style="display:flex;flex-direction:column;gap:0.4rem;margin-bottom:0.5rem">
                            ${(cfg.environments || []).map((e, i) => `
                                <div style="display:flex;align-items:center;gap:0.5rem;padding:0.3rem 0.5rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.82rem">
                                    <span style="font-weight:600;min-width:80px;cursor:pointer" onclick="wizardEditEnvField(${i},'name',this)" title="Click to edit">${esc(e.name)}</span>
                                    <span style="color:var(--text-muted);flex:1;cursor:pointer" onclick="wizardEditEnvField(${i},'description',this)" title="Click to edit">${esc(e.description || '')}</span>
                                    ${e.default ? '<span style="font-size:0.7rem;background:var(--accent-glow);color:var(--accent);padding:0.1rem 0.4rem;border-radius:8px">default</span>' : ''}
                                    <span style="cursor:pointer;opacity:0.5;font-size:0.7rem" onclick="wizardRemoveEnv(${i})" title="Remove">‚úï</span>
                                </div>
                            `).join('')}
                        </div>
                        <div style="display:flex;gap:0.4rem">
                            <input type="text" id="wiz-new-env-name" placeholder="Name"
                                style="width:100px;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-inset);color:var(--text-primary);font-size:0.82rem"
                                onkeydown="if(event.key==='Enter'){event.preventDefault();wizardAddEnv()}">
                            <input type="text" id="wiz-new-env-desc" placeholder="Description"
                                style="flex:1;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-inset);color:var(--text-primary);font-size:0.82rem"
                                onkeydown="if(event.key==='Enter'){event.preventDefault();wizardAddEnv()}">
                            <button class="btn btn-secondary btn-sm" onclick="wizardAddEnv()" style="font-size:0.78rem">+ Add</button>
                        </div>
                    </div>
                </div>

                <p style="color:var(--text-muted);margin-top:1.5rem;font-size:0.82rem">
                    üí° Click <strong>Next</strong> to continue. Changes are saved when you finish.
                </p>
            `;
        },

        // ‚îÄ‚îÄ Step 2: Modules ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        modules: async (body) => {
            const cfg = _wizardConfig;
            const modules = cfg ? (cfg.modules || []) : [];

            body.innerHTML = `
                <h2 style="margin-bottom:1rem">üîç Modules</h2>
                <p style="color:var(--text-secondary);line-height:1.6;margin-bottom:0.75rem">
                    Modules are the building blocks of your project ‚Äî directories with their own stack and purpose.
                    The control plane uses them to run automations, detect stacks, and organize your codebase.
                </p>

                <div style="padding:0.75rem 1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;margin-bottom:1rem;font-size:0.82rem;color:var(--text-muted);line-height:1.5">
                    üí° <strong>Not sure what this means?</strong> You can safely skip this step ‚Äî
                    the current configuration is already working. You can always come back later
                    or use <strong>Auto-Detect</strong> to scan your project.
                </div>

                <div style="display:flex;gap:0.5rem;margin-bottom:1rem">
                    <button class="btn btn-primary btn-sm" onclick="wizardDetect()">üîç Auto-Detect Modules</button>
                </div>

                <div id="wizard-modules-list" style="display:flex;flex-direction:column;gap:0.4rem">
                    ${modules.length ? modules.map((m, i) => _wizardModuleRow(m, i)).join('') : `
                        <p class="empty-state" style="padding:1.5rem">
                            No modules configured yet.<br>
                            <span style="font-size:0.82rem;color:var(--text-muted)">Click "Auto-Detect" to scan your project, or add modules manually.</span>
                        </p>
                    `}
                </div>

                <div id="wiz-add-module" style="margin-top:1rem;padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                    <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">‚ûï Add Module</div>
                    <div style="display:flex;gap:0.4rem;align-items:center">
                        <input type="text" id="wiz-mod-name" placeholder="Name"
                            style="width:100px;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-card);color:var(--text-primary);font-size:0.82rem">
                        <input type="text" id="wiz-mod-path" placeholder="Path (e.g. src/core)"
                            style="flex:1;min-width:120px;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-card);color:var(--text-primary);font-size:0.82rem;font-family:var(--font-mono)">
                        <select id="wiz-mod-stack"
                            onchange="var c=document.getElementById('wiz-mod-stack-custom');if(this.value==='__custom__'){c.style.display='';c.focus();this.style.display='none';}else{c.style.display='none';c.value='';}"
                            style="width:130px;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-card);color:var(--text-primary);font-size:0.82rem">
                            <option value="" disabled selected>Stack‚Ä¶</option>
                            ${((window._dcp && window._dcp.stacks) || []).map(s =>
                                '<option value="' + esc(s.name) + '">' + esc(s.name) + '</option>'
                            ).join('')}
                            <option value="__custom__">Custom‚Ä¶</option>
                        </select>
                        <input type="text" id="wiz-mod-stack-custom" placeholder="Custom stack"
                            onblur="if(!this.value.trim()){this.style.display='none';var s=document.getElementById('wiz-mod-stack');s.style.display='';s.value='';}"
                            style="display:none;width:130px;padding:0.35rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-card);color:var(--text-primary);font-size:0.82rem">
                        <button class="btn btn-secondary btn-sm" onclick="wizardAddModule()" style="font-size:0.78rem;white-space:nowrap">+ Add</button>
                    </div>
                </div>
            `;
        },

        // ‚îÄ‚îÄ Step 3: Secrets ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        secrets: async (body) => {
            const cfg = _wizardConfig || await wizardLoadConfig();
            if (!cfg) {
                body.innerHTML = '<p class="empty-state" style="color:var(--error)">‚ùå Could not load config.</p>';
                return;
            }
            const envs = cfg.environments || [{ name: 'dev', default: true }];

            body.innerHTML = `
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
                    <h2 style="margin:0">üîê Secrets & Encryption</h2>
                    <button class="btn btn-sm btn-ghost" onclick="renderWizard()" style="font-size:0.72rem;padding:0.2rem 0.5rem" title="Re-scan all vault, GitHub, and encryption status">üîÑ Rescan</button>
                </div>
                <p style="color:var(--text-secondary);line-height:1.6;margin-bottom:1.5rem">
                    Each environment has its own <code>.env</code> file encrypted by the <strong>Vault</strong>.
                    ${envs.length > 1
                        ? 'In multi-environment mode, <code>.env</code> is the live working copy of the active environment ‚Äî switching environments swaps the underlying file automatically.'
                        : 'The <strong>Content Encryption Key</strong> lets you encrypt content files, chat messages, and backup archives on demand.'}
                </p>

                <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">
                    üåç Environment Vault Status
                </div>
                <div id="wiz-env-vault-list" style="display:flex;flex-direction:column;gap:0.35rem;margin-bottom:1.25rem">
                    ${envs.map(e => `
                        <div id="wiz-env-vault-${esc(e.name)}"
                             style="display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.85rem">
                            <span class="spinner" style="width:14px;height:14px"></span>
                            <code style="min-width:120px;font-size:0.8rem">${esc(_wizEnvFile(e.name))}</code>
                            <span style="flex:1;color:var(--text-muted);font-size:0.78rem">${esc(e.description || e.name)}${e.default ? ' ‚≠ê' : ''}</span>
                            <span data-env-status="${esc(e.name)}" style="font-size:0.78rem;color:var(--text-muted)">checking‚Ä¶</span>
                        </div>
                    `).join('')}
                </div>

                <div id="wiz-gh-integration" style="margin-bottom:1.25rem"></div>
                <div id="wiz-enc-key-status" style="margin-bottom:1rem"></div>
                <div id="wiz-secrets-list"></div>
            `;

            // Resolve active environment name (available to all sections below)
            let _activeEnvName = '';
            if (_wizIsMultiEnv()) {
                try {
                    const aed = await api('/vault/active-env');
                    _activeEnvName = aed.active || '';
                } catch (_) {}
            }

            // ‚îÄ‚îÄ GitHub Integration auto-detect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            try {
                const [ghAuto, envKeys] = await Promise.all([
                    api('/gh/auto').catch(() => ({ token: null, repo: null })),
                    api('/vault/keys').catch(() => ({ keys: [] })),
                ]);

                const ghIntEl = document.getElementById('wiz-gh-integration');
                if (!ghIntEl) return;

                const existingRepo = (envKeys.keys || []).find(k => k.key === 'GITHUB_REPOSITORY');
                const repoInEnv = existingRepo && existingRepo.value;
                const detectedRepo = ghAuto.repo;

                let html = `
                    <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">
                        üîó GitHub Integration
                    </div>`;

                if (repoInEnv) {
                    html += `
                        <div style="display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--success);border-radius:8px;font-size:0.85rem">
                            <span>‚úÖ</span>
                            <code style="font-size:0.8rem;font-weight:500">GITHUB_REPOSITORY</code>
                            <span style="flex:1;color:var(--text-muted);font-size:0.78rem">${esc(existingRepo.value)}</span>
                            <span style="font-size:0.78rem;color:var(--success);font-weight:500">configured</span>
                        </div>`;
                } else if (detectedRepo) {
                    html += `
                        <div id="wiz-gh-repo-row" style="display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--warning);border-radius:8px;font-size:0.85rem">
                            <span>‚ö†Ô∏è</span>
                            <code style="font-size:0.8rem;font-weight:500">GITHUB_REPOSITORY</code>
                            <span style="flex:1;font-size:0.78rem;color:var(--text-muted)">detected: <strong>${esc(detectedRepo)}</strong> ‚Äî not in .env yet</span>
                            <button class="btn btn-sm btn-primary" style="font-size:0.72rem;padding:0.15rem 0.5rem"
                                onclick="wizardSaveGhRepo('${esc(detectedRepo)}', this)">üíæ Save to .env</button>
                        </div>`;
                } else {
                    html += `
                        <div style="display:flex;align-items:center;gap:0.6rem;padding:0.6rem 0.75rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.85rem">
                            <span>‚ùì</span>
                            <code style="font-size:0.8rem;font-weight:500">GITHUB_REPOSITORY</code>
                            <span style="flex:1;font-size:0.78rem;color:var(--text-muted)">could not detect ‚Äî set manually in .env as <code>owner/repo</code></span>
                        </div>`;
                }

                html += `
                    <p style="color:var(--text-muted);font-size:0.75rem;margin-top:0.35rem">
                        üí° This is stored locally in .env only ‚Äî never pushed to GitHub secrets.
                    </p>`;

                ghIntEl.innerHTML = html;
            } catch (_) {
                // gh CLI not available, skip
            }

            // ‚îÄ‚îÄ Fetch status for each environment ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            for (const env of envs) {
                const envParam = _wizEnvQS(env.name);
                const envFile = _wizEnvFile(env.name);
                try {
                    const status = await api(`/vault/status${envParam}`);
                    const state = status.empty ? 'missing' : status.locked ? 'locked' : 'unlocked';
                    const stateColor = state === 'unlocked' ? 'var(--success)' :
                                       state === 'locked' ? 'var(--warning)' : 'var(--text-muted)';
                    const stateIcon = state === 'unlocked' ? 'üîì' :
                                      state === 'locked' ? 'üîí' : 'üì≠';

                    // Create button for missing envs
                    const createBtn = state === 'missing'
                        ? `<button class="btn btn-sm" style="font-size:0.72rem;padding:0.15rem 0.5rem;border-radius:6px;margin-left:0.25rem" onclick="wizardCreateEnv('${esc(env.name)}',this)">+ Create</button>`
                        : '';

                    const row = document.getElementById(`wiz-env-vault-${env.name}`);
                    if (row) {
                        const isActive = _wizIsMultiEnv() && env.name === _activeEnvName;
                        const activeBadge = isActive
                            ? `<span style="font-size:0.65rem;padding:0.08rem 0.3rem;border-radius:3px;background:var(--success);color:#000;font-weight:700;margin-left:0.15rem">ACTIVE</span>`
                            : '';
                        const activeMarker = isActive ? '<span data-env-active hidden></span>' : '';
                        row.innerHTML = `
                            ${activeMarker}
                            <span style="font-size:1rem">${stateIcon}</span>
                            <code style="min-width:120px;font-size:0.8rem;font-weight:500">${esc(envFile)}</code>
                            <span style="flex:1;color:var(--text-muted);font-size:0.78rem">${esc(env.description || env.name)}${env.default ? ' ‚≠ê' : ''}${activeBadge}</span>
                            <span style="font-size:0.78rem;color:${stateColor};font-weight:500">${state}</span>
                            ${createBtn}
                        `;
                        row.style.borderColor = state === 'unlocked' ? 'var(--success)' :
                                                state === 'locked' ? 'var(--warning)' : 'var(--border-subtle)';
                    }
                } catch (e) {
                    const row = document.getElementById(`wiz-env-vault-${env.name}`);
                    if (row) {
                        const spinner = row.querySelector('.spinner');
                        if (spinner) spinner.remove();
                        const statusEl = row.querySelector(`[data-env-status="${env.name}"]`);
                        if (statusEl) {
                            statusEl.textContent = 'error';
                            statusEl.style.color = 'var(--error)';
                        }
                    }
                }
            }

            // ‚îÄ‚îÄ GitHub Environment status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Only relevant in multi-env mode (single-env uses repo-level)
            try {
                const ghEnvData = await api('/gh/environments');
                const ghEnvs = (ghEnvData.environments || []).map(e => e.toLowerCase());

                if (_wizIsMultiEnv()) {
                    const ghEnvEl = document.getElementById('wiz-enc-key-status');
                    if (ghEnvEl) {
                        let ghSection = `
                            <div id="wiz-gh-deploy-envs">
                            <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">
                                üåê GitHub Deployment Environments
                            </div>
                            <div id="wiz-gh-deploy-list" style="display:flex;flex-direction:column;gap:0.3rem;margin-bottom:1.25rem">`;

                        for (const env of envs) {
                            const exists = ghEnvs.includes(env.name.toLowerCase());
                            const icon = exists ? '‚úÖ' : '‚ö†Ô∏è';
                            const label = exists ? 'exists' : 'not found';
                            const color = exists ? 'var(--success)' : 'var(--warning)';
                            const createBtn = !exists
                                ? `<button class="btn btn-sm" style="font-size:0.72rem;padding:0.15rem 0.5rem;border-radius:6px;margin-left:0.25rem"
                                    onclick="wizardCreateGhEnv('${esc(env.name)}',this)">üöÄ Create</button>`
                                : '';

                            ghSection += `
                                <div style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;background:var(--bg-inset);border:1px solid ${exists ? 'var(--success)' : 'var(--warning)'};border-radius:8px;font-size:0.82rem">
                                    <span>${icon}</span>
                                    <code style="min-width:120px;font-size:0.8rem;font-weight:500">${esc(env.name)}</code>
                                    <span style="flex:1;color:var(--text-muted);font-size:0.78rem">${esc(env.description || env.name)}</span>
                                    <span style="font-size:0.78rem;color:${color};font-weight:500">${label}</span>
                                    ${createBtn}
                                </div>`;
                        }

                        ghSection += `</div>
                            <p style="color:var(--text-muted);font-size:0.75rem;margin-bottom:1rem">
                                üí° GitHub environments are needed to push environment-scoped secrets. Dev uses repo-level secrets.
                            </p>
                            </div>`;

                        ghEnvEl.insertAdjacentHTML('beforebegin', ghSection);
                    }
                }
            } catch (_) {
                // gh CLI not available or not authenticated ‚Äî skip
            }

            // ‚îÄ‚îÄ Encryption Key status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            try {
                const keyStatus = await api('/content/enc-key-status');
                const el = document.getElementById('wiz-enc-key-status');
                if (!el) return;

                if (keyStatus.configured) {
                    el.innerHTML = `
                        <div style="display:flex;align-items:center;gap:0.75rem;padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                            <span style="font-size:1.5rem">üîë</span>
                            <div style="flex:1">
                                <div style="font-weight:600;font-size:0.9rem">Content Encryption Key: <span style="color:var(--success)">configured</span></div>
                                <div style="font-size:0.78rem;color:var(--text-muted);margin-top:0.15rem">
                                    <code>${esc(keyStatus.key_name)}</code> is set in .env ‚Äî content files can be encrypted
                                </div>
                            </div>
                            <span style="font-size:0.82rem;color:var(--success)">‚úì Ready</span>
                        </div>
                    `;
                } else {
                    el.innerHTML = `
                        <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--warning);border-radius:10px">
                            <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem">
                                <span style="font-size:1.5rem">‚ö†Ô∏è</span>
                                <div style="flex:1">
                                    <div style="font-weight:600;font-size:0.9rem">Content Encryption Key: <span style="color:var(--warning)">not set</span></div>
                                    <div style="font-size:0.78rem;color:var(--text-muted);margin-top:0.15rem">
                                        <code>${esc(keyStatus.key_name)}</code> is required to encrypt/decrypt content files
                                    </div>
                                </div>
                            </div>
                            <div style="display:flex;gap:0.5rem;align-items:flex-end;flex-wrap:wrap">
                                <div style="flex:1;min-width:200px">
                                    <label style="font-size:0.78rem;font-weight:600;color:var(--text-secondary);display:block;margin-bottom:0.25rem">Encryption Key</label>
                                    <input type="text" id="wiz-enc-key-input" placeholder="Enter at least 8 characters or generate‚Ä¶"
                                        style="width:100%;padding:0.4rem 0.6rem;border:1px solid var(--border-subtle);border-radius:6px;background:var(--bg-card);color:var(--text-primary);font-size:0.82rem;font-family:var(--font-mono)">
                                </div>
                                <button class="btn btn-secondary btn-sm" onclick="wizardGenerateEncKey()" style="font-size:0.78rem">üé≤ Generate</button>
                                <button class="btn btn-primary btn-sm" onclick="wizardSaveEncKey()" style="font-size:0.78rem">üíæ Save</button>
                            </div>
                            <p style="color:var(--text-muted);font-size:0.75rem;margin-top:0.5rem">
                                ‚ö†Ô∏è This key is stored in <code>.env</code>. Losing it means losing access to encrypted content.
                            </p>
                        </div>
                    `;
                }
            } catch (e) {
                // enc-key-status might not be available
            }

            // ‚îÄ‚îÄ Detected secret files ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            try {
                const data = await api('/vault/secrets');
                const el = document.getElementById('wiz-secrets-list');
                if (!el) return;

                const files = data.files || [];
                if (files.length === 0) {
                    el.innerHTML = `<p style="color:var(--text-muted);font-size:0.85rem;padding:0.5rem 0">No secret files detected in the project.</p>`;
                } else {
                    el.innerHTML = `
                        <div style="font-size:0.85rem;font-weight:600;margin-bottom:0.5rem;color:var(--text-secondary)">Detected Secret Files</div>
                        <div id="wiz-detected-files" style="display:flex;flex-direction:column;gap:0.3rem">
                            ${files.map(f => {
                                const stIcon = f.locked ? 'üîí' : f.exists ? 'üîì' : '‚ùå';
                                const stLabel = f.locked ? 'Encrypted' : f.exists ? 'Plaintext' : 'Missing';
                                const stColor = f.locked ? 'var(--warning)' : f.exists ? 'var(--success)' : 'var(--error)';
                                // In multi-env mode, .env is the live copy of the active environment
                                const isActiveCopy = _wizIsMultiEnv() && f.name === '.env' && _activeEnvName;
                                const activeBadge = isActiveCopy
                                    ? `<span style="font-size:0.65rem;padding:0.08rem 0.3rem;border-radius:3px;background:var(--success);color:#000;font-weight:700;margin-left:0.25rem">= .env.${esc(_activeEnvName)}</span>`
                                    : '';
                                return `
                                    <div style="display:flex;align-items:center;gap:0.5rem;padding:0.4rem 0.6rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:6px;font-size:0.82rem">
                                        <span>${stIcon}</span>
                                        <code style="font-size:0.8rem">${esc(f.name)}</code>${activeBadge}
                                        <span style="flex:1"></span>
                                        <span style="font-size:0.75rem;color:${stColor}">${stLabel}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <p style="color:var(--text-muted);font-size:0.78rem;margin-top:0.75rem">
                            üí° Use the <strong>üîê Secrets</strong> tab for full vault management (lock, unlock, create, push to GitHub).
                        </p>
                    `;
                }
            } catch (e) {
                // Secrets detection might not be available
            }
        },

        // ‚îÄ‚îÄ Step 4: Content ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        content: async (body) => {
            body.innerHTML = `
                <h2 style="margin-bottom:1rem">üìÅ Content Folders</h2>
                <p style="color:var(--text-secondary);line-height:1.6;margin-bottom:1rem">
                    Select which project folders should be managed as content.
                    These folders will appear in the <strong>üìÅ Content</strong> tab where you can
                    browse, preview, upload, encrypt, and back up files.
                </p>
                <div id="wiz-content-folders">
                    <span class="spinner"></span> Scanning project folders‚Ä¶
                </div>
            `;

            try {
                const data = await api('/config/content-folders');
                const el = document.getElementById('wiz-content-folders');
                if (!el) return;

                const folders = data.folders || [];
                // Check which are currently configured in content folders
                let configuredPaths = [];
                try {
                    const cfData = await api('/content/folders');
                    configuredPaths = (cfData.folders || []).map(f => f.path || f.name);
                } catch (_) {}

                // Initialize wizard content folders from current config
                if (!_wizardConfig._contentFolders) {
                    _wizardConfig._contentFolders = [...configuredPaths];
                }

                if (folders.length === 0) {
                    el.innerHTML = '<p class="empty-state">No project folders detected.</p>';
                    return;
                }

                el.innerHTML = `
                    <div style="display:flex;flex-direction:column;gap:0.35rem">
                        ${folders.map(f => {
                            const isActive = _wizardConfig._contentFolders.includes(f.name);
                            const badge = f.suggested ? '<span style="font-size:0.65rem;background:var(--accent-glow);color:var(--accent);padding:0.1rem 0.35rem;border-radius:6px;margin-left:0.3rem">suggested</span>' : '';
                            return `
                                <label style="display:flex;align-items:center;gap:0.6rem;padding:0.5rem 0.75rem;background:var(--bg-inset);border:1px solid ${isActive ? 'var(--accent)' : 'var(--border-subtle)'};border-radius:8px;font-size:0.85rem;transition:all 0.15s;cursor:pointer"
                                    onmouseenter="this.style.borderColor='var(--accent)'" onmouseleave="this.style.borderColor=${isActive ? "'var(--accent)'" : "'var(--border-subtle)'"}">
                                    <input type="checkbox" ${isActive ? 'checked' : ''}
                                        onchange="wizardToggleContentFolder('${esc(f.name)}', this.checked, this.closest('label'))"
                                        style="width:16px;height:16px;accent-color:var(--accent);cursor:pointer">
                                    <div style="flex:1">
                                        <div style="font-weight:500">${esc(f.name)}${badge}</div>
                                        <div style="font-size:0.75rem;color:var(--text-muted)">${f.file_count} file${f.file_count !== 1 ? 's' : ''}</div>
                                    </div>
                                    <span style="font-size:0.78rem;color:${isActive ? 'var(--accent)' : 'var(--text-muted)'};font-weight:500" data-folder-status="${esc(f.name)}">
                                        ${isActive ? '‚úÖ Active' : '‚Äî'}
                                    </span>
                                </label>
                            `;
                        }).join('')}
                    </div>
                    <p style="color:var(--text-muted);font-size:0.78rem;margin-top:0.75rem">
                        üí° Selected folders appear in the <strong>üìÅ Content</strong> tab.
                        You can also use the <strong>üóÇ Explore All</strong> option there to browse all project folders.
                    </p>
                `;
            } catch (e) {
                const el = document.getElementById('wiz-content-folders');
                if (el) el.innerHTML = `<p style="color:var(--error);font-size:0.85rem">‚ùå ${esc(e.message)}</p>`;
            }
        },

        // ‚îÄ‚îÄ Step 5: Integrations ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        integrations: async (body) => {
            body.innerHTML = `
                <h2 style="margin-bottom:1rem">üîå Integrations</h2>
                <p style="color:var(--text-secondary);line-height:1.6;margin-bottom:1rem">
                    Detect available tools and configure which integrations are active.
                    Enabled integrations appear as cards in the <strong>Integrations</strong>
                    and <strong>DevOps</strong> tabs.
                </p>
                <div id="wiz-int-body" style="min-height:100px;display:flex;align-items:center;justify-content:center">
                    <div style="text-align:center">
                        <span class="spinner"></span>
                        <div style="margin-top:0.5rem;color:var(--text-muted);font-size:0.82rem">Detecting environment‚Ä¶</div>
                    </div>
                </div>
            `;

            try {
                if (!_wizardConfig) await wizardLoadConfig();
                _wizIntDetection = await _wizFetchDetect();
            } catch (e) {
                document.getElementById('wiz-int-body').innerHTML =
                    `<p style="color:var(--error)">‚ùå Detection failed: ${esc(e.message)}</p>`;
                return;
            }

            _wizRenderIntegrations();
        },

        // ‚îÄ‚îÄ Step 6: Review ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        review: async (body) => {
            // Ensure config is loaded even if user jumped steps
            if (!_wizardConfig) await wizardLoadConfig();
            // Collect current state from the form fields
            _wizardCollectWelcome();

            const cfg = _wizardConfig;
            if (!cfg) {
                body.innerHTML = '<p class="empty-state">No configuration loaded.</p>';
                return;
            }

            const modules = cfg.modules || [];
            const envs = cfg.environments || [];
            const domains = cfg.domains || [];

            body.innerHTML = `
                <h2 style="margin-bottom:1rem">‚úÖ Review & Save</h2>
                <p style="color:var(--text-secondary);line-height:1.6;margin-bottom:1.5rem">
                    Review your configuration below. Click <strong>Finish</strong> to save to <code>project.yml</code>.
                </p>

                <div style="display:flex;flex-direction:column;gap:1rem">
                    <!-- Project Identity -->
                    <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                        <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">üìã Project</div>
                        <div style="display:grid;grid-template-columns:auto 1fr;gap:0.3rem 1rem;font-size:0.85rem">
                            <span style="color:var(--text-muted)">Name:</span>
                            <span style="font-weight:500">${esc(cfg.name || '(not set)')}</span>
                            <span style="color:var(--text-muted)">Description:</span>
                            <span>${esc(cfg.description || '‚Äî')}</span>
                            <span style="color:var(--text-muted)">Repository:</span>
                            <span style="font-family:var(--font-mono);font-size:0.82rem">${esc(cfg.repository || '‚Äî')}</span>
                        </div>
                    </div>

                    <!-- Domains -->
                    <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                        <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">üè∑Ô∏è Domains</div>
                        <div style="display:flex;flex-wrap:wrap;gap:0.4rem">
                            ${domains.length ? domains.map(d => `
                                <span style="padding:0.2rem 0.6rem;background:var(--accent-glow);border:1px solid var(--accent);border-radius:12px;font-size:0.78rem;color:var(--accent)">${esc(d)}</span>
                            `).join('') : '<span style="color:var(--text-muted);font-size:0.85rem">None configured</span>'}
                        </div>
                    </div>

                    <!-- Environments -->
                    <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                        <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">üåç Environments (${envs.length})</div>
                        ${envs.length ? `<div style="display:flex;flex-wrap:wrap;gap:0.4rem">${envs.map(e => `
                            <span style="padding:0.2rem 0.6rem;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.78rem">
                                ${esc(e.name)}${e.default ? ' ‚≠ê' : ''}
                            </span>
                        `).join('')}</div>` : '<span style="color:var(--text-muted);font-size:0.85rem">None configured</span>'}
                    </div>

                    <!-- Modules -->
                    <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                        <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">üì¶ Modules (${modules.length})</div>
                        ${modules.length ? `<div style="display:flex;flex-direction:column;gap:0.3rem">${modules.map(m => `
                            <div style="display:flex;align-items:center;gap:0.5rem;font-size:0.82rem">
                                <span style="font-weight:600;min-width:90px">${esc(m.name)}</span>
                                <code style="color:var(--text-muted);font-size:0.78rem">${esc(m.path)}</code>
                                <span style="margin-left:auto;font-size:0.75rem;padding:0.1rem 0.4rem;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:6px">${esc(m.stack || '‚Äî')}</span>
                            </div>
                        `).join('')}</div>` : '<span style="color:var(--text-muted);font-size:0.85rem">No modules configured</span>'}
                    </div>

                    <!-- Content Folders -->
                    <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                        <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">üìÅ Content Folders</div>
                        ${(cfg._contentFolders || []).length ? `<div style="display:flex;flex-wrap:wrap;gap:0.4rem">${(cfg._contentFolders || []).map(f => `
                            <span style="padding:0.2rem 0.6rem;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.78rem">
                                üìÅ ${esc(f)}
                            </span>
                        `).join('')}</div>` : '<span style="color:var(--text-muted);font-size:0.85rem">Using default detection</span>'}
                    </div>

                    <!-- Integrations -->
                    <div style="padding:1rem;background:var(--bg-inset);border:1px solid var(--border-subtle);border-radius:10px">
                        <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">üîå Integrations</div>
                        ${(() => {
                            const ip = cfg._integrationPrefs;
                            if (!ip || Object.keys(ip).length === 0) {
                                return '<span style="color:var(--text-muted);font-size:0.85rem">Using defaults</span>';
                            }
                            const enabled = Object.entries(ip).filter(([,v]) => v === 'auto');
                            const hidden  = Object.entries(ip).filter(([,v]) => v === 'hidden');
                            let html = '';
                            if (enabled.length) {
                                html += '<div style="display:flex;flex-wrap:wrap;gap:0.3rem;margin-bottom:0.3rem">';
                                html += enabled.map(([k]) => `<span style="padding:0.15rem 0.5rem;background:color-mix(in srgb, var(--success) 10%, transparent);border:1px solid color-mix(in srgb, var(--success) 30%, transparent);border-radius:8px;font-size:0.75rem;color:var(--success)">‚úì ${esc(k)}</span>`).join('');
                                html += '</div>';
                            }
                            if (hidden.length) {
                                html += '<div style="display:flex;flex-wrap:wrap;gap:0.3rem">';
                                html += hidden.map(([k]) => `<span style="padding:0.15rem 0.5rem;background:var(--bg-card);border:1px solid var(--border-subtle);border-radius:8px;font-size:0.75rem;color:var(--text-muted)">‚úó ${esc(k)}</span>`).join('');
                                html += '</div>';
                            }
                            return html;
                        })()}
                    </div>
                </div>

                ${wizardDirty ? `
                    <div style="margin-top:1rem;padding:0.75rem;background:var(--warning-bg);border:1px solid var(--warning);border-radius:8px;font-size:0.82rem;color:var(--warning);display:flex;align-items:center;gap:0.5rem">
                        <span>‚ö†Ô∏è</span>
                        <span>You have unsaved changes. Click <strong>‚úÖ Finish</strong> to save to <code>project.yml</code>.</span>
                    </div>
                ` : `
                    <p style="color:var(--text-muted);font-size:0.82rem;margin-top:1rem">
                        ‚ú® Configuration looks good! Click <strong>‚úÖ Finish</strong> to save.
                    </p>
                `}
            `;
        },
    };

