// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  _content_modal_preview.html
//  Modal file preview â€” moves #content-browser into a modal overlay,
//  calls contentPreviewFile() (same code, same container, zero dup),
//  moves it back on close.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

let _modalPreviewActive = false;
let _modalPreviewParent = null;    // original parent of #content-browser
let _modalPreviewSavedHTML = '';   // original innerHTML before we took over
let _modalPreviewSavedPath = '';   // previewCurrentPath before modal
let _modalPreviewSavedName = '';   // previewCurrentName before modal

function openFileInModal(filePath) {
    const browser = document.getElementById('content-browser');
    if (!browser) return;

    // Save state
    _modalPreviewParent = browser.parentNode;
    _modalPreviewSavedHTML = browser.innerHTML;
    _modalPreviewSavedPath = previewCurrentPath;
    _modalPreviewSavedName = previewCurrentName;
    _modalPreviewActive = true;

    // Open modal with empty body â€” we'll move #content-browser into it
    modalOpen({
        title: `ðŸ“„ ${esc(filePath.split('/').pop())}`,
        body: '',
        size: 'preview',
        footerButtons: [
            { label: 'ðŸ“ Open in Content Tab', cls: 'btn-secondary',
              onclick: `_modalPreviewGoToContent()` },
            { label: 'Close', cls: 'btn-ghost', onclick: '_modalPreviewClose()' },
        ],
    });

    // Replace default close behavior â€” we need to rescue #content-browser
    // BEFORE overlay.remove() destroys it. Override the âœ• button and
    // overlay-click and Escape to go through our close path.
    const overlay = document.getElementById('active-modal-overlay');
    if (!overlay) return;

    // Override âœ• button
    const closeBtn = overlay.querySelector('.modal-close');
    if (closeBtn) closeBtn.setAttribute('onclick', '_modalPreviewClose()');

    // Override overlay click (click on backdrop)
    overlay.addEventListener('click', (e) => {
        if (e.target === overlay) { e.stopImmediatePropagation(); _modalPreviewClose(); }
    }, true);  // capture phase to beat modalOpen's listener

    // Override Escape handler â€” modalOpen's default calls modalClose() directly
    if (_activeModal && _activeModal.escHandler) {
        document.removeEventListener('keydown', _activeModal.escHandler);
    }
    const _modalPreviewEsc = (e) => { if (e.key === 'Escape') _modalPreviewClose(); };
    document.addEventListener('keydown', _modalPreviewEsc);
    // Store so modalClose() can still clean it up
    if (_activeModal) _activeModal.escHandler = _modalPreviewEsc;

    // Move #content-browser into the modal body
    const modalBody = overlay.querySelector('.modal-body');
    modalBody.appendChild(browser);

    // Call the existing function â€” it renders into #content-browser as always
    const fileName = filePath.split('/').pop();
    contentPreviewFile(filePath, fileName);
}

/**
 * Close the modal preview safely â€” rescues #content-browser BEFORE
 * the overlay is removed from the DOM.
 */
function _modalPreviewClose() {
    _modalPreviewRestore();
    modalClose();
}

function _modalPreviewRestore() {
    if (!_modalPreviewActive) return;
    _modalPreviewActive = false;

    const browser = document.getElementById('content-browser');
    if (!browser || !_modalPreviewParent) return;

    // Dispose Monaco if active
    if (typeof monacoDispose === 'function') monacoDispose();

    // Move #content-browser back to its original parent
    _modalPreviewParent.appendChild(browser);

    // Restore previous content and state
    browser.innerHTML = _modalPreviewSavedHTML;
    previewCurrentPath = _modalPreviewSavedPath;
    previewCurrentName = _modalPreviewSavedName;
    previewEditMode = false;

    _modalPreviewParent = null;
    _modalPreviewSavedHTML = '';
}

function _modalPreviewGoToContent() {
    const path = previewCurrentPath;
    _modalPreviewRestore();
    modalClose();
    if (path) {
        switchTab(`content/docs/${path}@raw`);
    } else {
        switchTab('content');
    }
}
